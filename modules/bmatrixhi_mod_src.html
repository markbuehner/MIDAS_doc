<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>bmatrixhi_mod source &mdash; MIDAS  documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="MIDAS  documentation" href="../index.html" /> 
  </head>
  <body>
  <div>
    <img src="../_static/MIDAS_header.png" alt="MIDAS" />
  </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li><a href="../index.html">MIDAS  documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/modules/bmatrixhi_mod_src.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <section id="bmatrixhi-mod-source">
<h1>bmatrixhi_mod source<a class="headerlink" href="#bmatrixhi-mod-source" title="Permalink to this headline">Â¶</a></h1>
<blockquote>
<div><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="c">!--------------------------------------- LICENCE BEGIN -----------------------------------</span>
<span class="linenos">   2</span><span class="c">!Environment Canada - Atmospheric Science and Technology License/Disclaimer,</span>
<span class="linenos">   3</span><span class="c">!                     version 3; Last Modified: May 7, 2008.</span>
<span class="linenos">   4</span><span class="c">!This is free but copyrighted software; you can use/redistribute/modify it under the terms</span>
<span class="linenos">   5</span><span class="c">!of the Environment Canada - Atmospheric Science and Technology License/Disclaimer</span>
<span class="linenos">   6</span><span class="c">!version 3 or (at your option) any later version that should be found at:</span>
<span class="linenos">   7</span><span class="c">!http://collaboration.cmc.ec.gc.ca/science/rpn.comm/license.html</span>
<span class="linenos">   8</span><span class="c">!</span>
<span class="linenos">   9</span><span class="c">!This software is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;</span>
<span class="linenos">  10</span><span class="c">!without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="linenos">  11</span><span class="c">!See the above mentioned License/Disclaimer for more details.</span>
<span class="linenos">  12</span><span class="c">!You should have received a copy of the License/Disclaimer along with this software;</span>
<span class="linenos">  13</span><span class="c">!if not, you can write to: EC-RPN COMM Group, 2121 TransCanada, suite 500, Dorval (Quebec),</span>
<span class="linenos">  14</span><span class="c">!CANADA, H9P 1J3; or send e-mail to service.rpn@ec.gc.ca</span>
<span class="linenos">  15</span><span class="c">!-------------------------------------- LICENCE END --------------------------------------</span>
<span class="linenos">  16</span>
<span class="linenos">  17</span><span class="k">MODULE </span><span class="n">BmatrixHI_mod</span><span class="w"></span>
<span class="linenos">  18</span><span class="w">  </span><span class="c">! MODULE BmatrixHI_mod (prefix=&#39;bhi&#39; category=&#39;2. B and R matrices&#39;)</span>
<span class="linenos">  19</span><span class="w">  </span><span class="c">!</span>
<span class="linenos">  20</span><span class="w">  </span><span class="c">!:Purpose: Performs transformation from control vector to analysis increment </span>
<span class="linenos">  21</span><span class="w">  </span><span class="c">!           using the background-error covariance matrix based on homogeneous</span>
<span class="linenos">  22</span><span class="w">  </span><span class="c">!           and isotropic correlations. This is the Global version. A separate </span>
<span class="linenos">  23</span><span class="w">  </span><span class="c">!           module exists for limited-area applications.</span>
<span class="linenos">  24</span><span class="w">  </span><span class="c">!</span>
<span class="linenos">  25</span><span class="w">  </span><span class="k">use </span><span class="n">midasMpi_mod</span><span class="w"></span>
<span class="linenos">  26</span><span class="w">  </span><span class="k">use </span><span class="n">earthConstants_mod</span><span class="w"></span>
<span class="linenos">  27</span><span class="w">  </span><span class="k">use </span><span class="n">gridStateVector_mod</span><span class="w"></span>
<span class="linenos">  28</span><span class="w">  </span><span class="k">use </span><span class="n">globalSpectralTransform_mod</span><span class="w"></span>
<span class="linenos">  29</span><span class="w">  </span><span class="k">use </span><span class="n">horizontalCoord_mod</span><span class="w"></span>
<span class="linenos">  30</span><span class="w">  </span><span class="k">use </span><span class="n">verticalCoord_mod</span><span class="w"></span>
<span class="linenos">  31</span><span class="w">  </span><span class="k">use </span><span class="n">varNameList_mod</span><span class="w"></span>
<span class="linenos">  32</span><span class="w">  </span><span class="k">use </span><span class="n">utilities_mod</span><span class="w"></span>
<span class="linenos">  33</span><span class="w">  </span><span class="k">use </span><span class="n">gridVariableTransforms_mod</span><span class="w"></span>
<span class="linenos">  34</span><span class="w">  </span><span class="k">use </span><span class="n">interpolation_mod</span><span class="w"></span>
<span class="linenos">  35</span><span class="w">  </span><span class="k">use </span><span class="n">calcHeightAndPressure_mod</span><span class="w"></span>
<span class="linenos">  36</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos">  37</span><span class="k">  save</span>
<span class="linenos">  38</span><span class="k">  private</span><span class="w"></span>
<span class="linenos">  39</span>
<span class="linenos">  40</span><span class="w">  </span><span class="c">! public procedures</span>
<span class="linenos">  41</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bhi_Setup</span><span class="p">,</span><span class="n">bhi_BSqrt</span><span class="p">,</span><span class="n">bhi_BSqrtAd</span><span class="p">,</span><span class="n">bhi_Finalize</span><span class="p">,</span><span class="n">bhi_expandToMPIglobal</span><span class="p">,</span><span class="n">bhi_expandToMPIglobal_r4</span><span class="p">,</span><span class="n">bhi_reduceToMPIlocal</span><span class="p">,</span><span class="n">bhi_reduceToMPIlocal_r4</span><span class="w"></span>
<span class="linenos">  42</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bhi_getScaleFactor</span><span class="p">,</span><span class="n">bhi_truncateCV</span><span class="w"></span>
<span class="linenos">  43</span>
<span class="linenos">  44</span>
<span class="linenos">  45</span><span class="w">  </span><span class="kt">logical</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">  46</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nj_l</span><span class="p">,</span><span class="n">ni_l</span><span class="w"></span>
<span class="linenos">  47</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">AnalGridID</span><span class="w"> </span><span class="c">! EZscintID</span>
<span class="linenos">  48</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">nlev_T_even</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">  49</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nla_mpiglobal</span><span class="p">,</span><span class="n">nla_mpilocal</span><span class="w"></span>
<span class="linenos">  50</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">cvDim_mpilocal</span><span class="p">,</span><span class="n">cvDim_mpiglobal</span><span class="w"></span>
<span class="linenos">  51</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">gstID</span><span class="p">,</span><span class="w"> </span><span class="n">gstID2</span><span class="w"></span>
<span class="linenos">  52</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nlev_bdl</span><span class="w"></span>
<span class="linenos">  53</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">struct_vco</span><span class="p">),</span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vco_anl</span><span class="w"></span>
<span class="linenos">  54</span>
<span class="linenos">  55</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tantheta</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">  56</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">PtoT</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">  57</span>
<span class="linenos">  58</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">pointer</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">rgsig</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">  59</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">pointer</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">rgsiguu</span><span class="p">(:,:),</span><span class="n">rgsigvv</span><span class="p">(:,:),</span><span class="n">rgsigtt</span><span class="p">(:,:),</span><span class="n">rgsigtb</span><span class="p">(:,:),</span><span class="n">rgsigq</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">  60</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">pointer</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">rgsigps</span><span class="p">(:),</span><span class="n">rgsigpsb</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">  61</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tgstdbg</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">  62</span>
<span class="linenos">  63</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">corns</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">  64</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rstddev</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">  65</span>
<span class="linenos">  66</span><span class="w">  </span><span class="c">! namelist variables:</span>
<span class="linenos">  67</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">ntrunc</span><span class="w">                          </span><span class="c">! spectral trunction</span>
<span class="linenos">  68</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">vco_maxNumLevels</span><span class="p">)</span><span class="w">   </span><span class="c">! scale factor applied to variances (all variables)</span>
<span class="linenos">  69</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">scaleFactorLQ</span><span class="p">(</span><span class="n">vco_maxNumLevels</span><span class="p">)</span><span class="w"> </span><span class="c">! scale factor applied to humidity</span>
<span class="linenos">  70</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">scaleFactorCC</span><span class="p">(</span><span class="n">vco_maxNumLevels</span><span class="p">)</span><span class="w"> </span><span class="c">! scale factor applied to velocity potential</span>
<span class="linenos">  71</span><span class="w">  </span><span class="kt">logical</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">scaleTG</span><span class="w">                         </span><span class="c">! scale factor applied to skin temperature</span>
<span class="linenos">  72</span><span class="w">  </span><span class="kt">logical</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">TweakTG</span><span class="w">                         </span><span class="c">! adjust skin temp variance based on land-sea mask and sea ice</span>
<span class="linenos">  73</span><span class="w">  </span><span class="kt">logical</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">ReadWrite_sqrt</span><span class="w">                  </span><span class="c">! choose to read or write the sqrt of correlations</span>
<span class="linenos">  74</span><span class="w">  </span><span class="kt">logical</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">squareSqrt</span><span class="w">                      </span><span class="c">! choose to use the &#39;square&#39; formulation of corr matrix (not used)</span>
<span class="linenos">  75</span><span class="w">  </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">    </span><span class="kd">::</span><span class="w"> </span><span class="n">stddevMode</span><span class="w">                      </span><span class="c">! can be &#39;GD2D&#39; or &#39;SP2D&#39;</span>
<span class="linenos">  76</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">numModeZero</span><span class="w">                     </span><span class="c">! number of eigenmodes to set to zero</span>
<span class="linenos">  77</span>
<span class="linenos">  78</span><span class="w">  </span><span class="c">! constants</span>
<span class="linenos">  79</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">rcscltg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mi">10000</span><span class="mf">0.d0</span><span class="w"></span>
<span class="linenos">  80</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">rlimsuptg</span><span class="o">=</span><span class="mf">3.0d0</span><span class="w"></span>
<span class="linenos">  81</span><span class="w">  </span><span class="kt">logical</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">llimtg</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">  82</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nulbgst</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">  83</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nLevPtoT</span><span class="w"></span>
<span class="linenos">  84</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">rvlocbalt</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mf">6.0d0</span><span class="w"></span>
<span class="linenos">  85</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">rvlocpsi</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mf">6.0d0</span><span class="w"></span>
<span class="linenos">  86</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">rvlocchi</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mf">6.0d0</span><span class="w"></span>
<span class="linenos">  87</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">rvlocpsitt</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">6.0d0</span><span class="w"></span>
<span class="linenos">  88</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">rvlocunbalt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4.0d0</span><span class="w"></span>
<span class="linenos">  89</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">rvloclq</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">4.0d0</span><span class="w"></span>
<span class="linenos">  90</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">rlimlv_bdl</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">8500</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">  91</span>
<span class="linenos">  92</span><span class="w">  </span><span class="c">! this should come from state vector object</span>
<span class="linenos">  93</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">numvar3d</span><span class="w"></span>
<span class="linenos">  94</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">numvar2d</span><span class="w"></span>
<span class="linenos">  95</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nspositVO</span><span class="w"> </span>
<span class="linenos">  96</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nspositDI</span><span class="w"> </span>
<span class="linenos">  97</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nspositTT</span><span class="w"> </span>
<span class="linenos">  98</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nspositQ</span><span class="w"></span>
<span class="linenos">  99</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nspositPS</span><span class="w"> </span>
<span class="linenos"> 100</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">nspositTG</span><span class="w"></span>
<span class="linenos"> 101</span>
<span class="linenos"> 102</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w">    </span><span class="kd">::</span><span class="w"> </span><span class="n">pressureProfile_M</span><span class="p">(:),</span><span class="n">pressureProfile_T</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 103</span>
<span class="linenos"> 104</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="n">mymEnd</span><span class="p">,</span><span class="n">mymSkip</span><span class="p">,</span><span class="n">mymCount</span><span class="w"></span>
<span class="linenos"> 105</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">mynBeg</span><span class="p">,</span><span class="n">mynEnd</span><span class="p">,</span><span class="n">mynSkip</span><span class="p">,</span><span class="n">mynCount</span><span class="w"></span>
<span class="linenos"> 106</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">maxMyNla</span><span class="w"></span>
<span class="linenos"> 107</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos"> 108</span><span class="w">  </span><span class="kt">integer</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos"> 109</span><span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">pointer</span><span class="w">    </span><span class="kd">::</span><span class="w"> </span><span class="n">ilaList_mpiglobal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 110</span><span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">pointer</span><span class="w">    </span><span class="kd">::</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 111</span>
<span class="linenos"> 112</span><span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="k">external</span><span class="w">    </span><span class="kd">::</span><span class="w"> </span><span class="n">get_max_rss</span><span class="w"></span>
<span class="linenos"> 113</span>
<span class="linenos"> 114</span>
<span class="linenos"> 115</span><span class="k">CONTAINS</span>
<span class="linenos"> 116</span>
<span class="linenos"> 117</span><span class="k">  SUBROUTINE </span><span class="n">BHI_setup</span><span class="p">(</span><span class="n">hco_in</span><span class="p">,</span><span class="n">vco_in</span><span class="p">,</span><span class="n">CVDIM_OUT</span><span class="p">,</span><span class="w"> </span><span class="n">mode_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 118</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos"> 119</span>
<span class="linenos"> 120</span><span class="k">    type</span><span class="p">(</span><span class="n">struct_hco</span><span class="p">),</span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hco_in</span><span class="w"></span>
<span class="linenos"> 121</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_vco</span><span class="p">),</span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vco_in</span><span class="w"></span>
<span class="linenos"> 122</span><span class="w">    </span><span class="kt">integer</span><span class="w">                  </span><span class="kd">::</span><span class="w"> </span><span class="n">cvDim_out</span><span class="w"></span>
<span class="linenos"> 123</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">mode_opt</span><span class="w"></span>
<span class="linenos"> 124</span>
<span class="linenos"> 125</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bhi_mode</span><span class="w"></span>
<span class="linenos"> 126</span>
<span class="linenos"> 127</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">nulnam</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">,</span><span class="w"> </span><span class="n">fnom</span><span class="p">,</span><span class="w"> </span><span class="n">fclos</span><span class="p">,</span><span class="w"> </span><span class="n">fstouv</span><span class="p">,</span><span class="w"> </span><span class="n">fstfrm</span><span class="w"></span>
<span class="linenos"> 128</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jm</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">latPerPE</span><span class="p">,</span><span class="w"> </span><span class="n">lonPerPE</span><span class="p">,</span><span class="w"> </span><span class="n">latPerPEmax</span><span class="p">,</span><span class="w"> </span><span class="n">lonPerPEmax</span><span class="p">,</span><span class="w"> </span><span class="n">Vcode_anl</span><span class="w"></span>
<span class="linenos"> 129</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">llfound</span><span class="p">,</span><span class="w"> </span><span class="n">lExists</span><span class="w"></span>
<span class="linenos"> 130</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zps</span><span class="w"></span>
<span class="linenos"> 131</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_vco</span><span class="p">),</span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vco_file</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">null</span><span class="p">()</span><span class="w"></span>
<span class="linenos"> 132</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bFileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;./bgcov&#39;</span><span class="w"></span>
<span class="linenos"> 133</span>
<span class="linenos"> 134</span><span class="w">    </span><span class="k">NAMELIST</span><span class="w"> </span><span class="o">/</span><span class="n">NAMBHI</span><span class="o">/</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">scaleFactor</span><span class="p">,</span><span class="n">scaleFactorLQ</span><span class="p">,</span><span class="n">scaleFactorCC</span><span class="p">,</span><span class="n">scaleTG</span><span class="p">,</span><span class="n">numModeZero</span><span class="p">,</span><span class="n">squareSqrt</span><span class="p">,</span><span class="n">TweakTG</span><span class="p">,</span><span class="n">ReadWrite_sqrt</span><span class="p">,</span><span class="n">stddevMode</span><span class="w"></span>
<span class="linenos"> 135</span>
<span class="linenos"> 136</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_setup: starting&#39;</span><span class="w"></span>
<span class="linenos"> 137</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Memory Used: &#39;</span><span class="p">,</span><span class="n">get_max_rss</span><span class="p">()</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="s1">&#39;Mb&#39;</span><span class="w"></span>
<span class="linenos"> 138</span>
<span class="linenos"> 139</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">present</span><span class="p">(</span><span class="n">mode_opt</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 140</span><span class="k">       if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">mode_opt</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Analysis&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">mode_opt</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;BackgroundCheck&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 141</span><span class="k">         </span><span class="n">bhi_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">mode_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 142</span><span class="w">         </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 143</span><span class="w">         </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bmatrixHI: Mode activated = &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">bhi_mode</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 144</span><span class="w">       </span><span class="k">else</span>
<span class="linenos"> 145</span><span class="k">          write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 146</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;mode = &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">mode_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 147</span><span class="w">          </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bmatrixHI: unknown mode&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 148</span><span class="w">       </span><span class="k">end if</span>
<span class="linenos"> 149</span><span class="k">    else</span>
<span class="linenos"> 150</span><span class="k">       </span><span class="n">bhi_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Analysis&#39;</span><span class="w"></span>
<span class="linenos"> 151</span><span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 152</span><span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bmatrixHI: Analysis mode activated (by default)&#39;</span><span class="w"></span>
<span class="linenos"> 153</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos"> 154</span>
<span class="linenos"> 155</span><span class="w">    </span><span class="c">! default values for namelist variables</span>
<span class="linenos"> 156</span><span class="w">    </span><span class="n">ntrunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">108</span><span class="w"></span>
<span class="linenos"> 157</span><span class="w">    </span><span class="n">scaleFactor</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 158</span><span class="w">    </span><span class="n">scaleFactorLQ</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos"> 159</span><span class="w">    </span><span class="n">scaleFactorCC</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos"> 160</span><span class="w">    </span><span class="n">scaleTG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 161</span><span class="w">    </span><span class="n">numModeZero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 162</span><span class="w">    </span><span class="n">squareSqrt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 163</span><span class="w">    </span><span class="n">TweakTG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 164</span><span class="w">    </span><span class="n">ReadWrite_sqrt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 165</span><span class="w">    </span><span class="n">stddevMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;SP2D&#39;</span><span class="w"></span>
<span class="linenos"> 166</span>
<span class="linenos"> 167</span><span class="w">    </span><span class="n">nulnam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 168</span><span class="w">    </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fnom</span><span class="p">(</span><span class="n">nulnam</span><span class="p">,</span><span class="s1">&#39;./flnml&#39;</span><span class="p">,</span><span class="s1">&#39;FTN+SEQ+R/O&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 169</span><span class="w">    </span><span class="k">read</span><span class="p">(</span><span class="n">nulnam</span><span class="p">,</span><span class="n">nml</span><span class="o">=</span><span class="n">nambhi</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 170</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="w"> </span><span class="s1">&#39;bhi_setup: Error reading namelist&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 171</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">nml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nambhi</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 172</span><span class="w">    </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fclos</span><span class="p">(</span><span class="w"> </span><span class="n">nulnam</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 173</span>
<span class="linenos"> 174</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">vco_maxNumLevels</span><span class="w"></span>
<span class="linenos"> 175</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then </span>
<span class="linenos"> 176</span><span class="k">        </span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 177</span><span class="w">      </span><span class="k">else</span>
<span class="linenos"> 178</span><span class="k">        </span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 179</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos"> 180</span><span class="k">    enddo</span>
<span class="linenos"> 181</span>
<span class="linenos"> 182</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">scaleFactor</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">vco_maxNumLevels</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 183</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bmatrixHI: scaleFactor=0, skipping rest of setup&#39;</span><span class="w"></span>
<span class="linenos"> 184</span><span class="w">      </span><span class="n">cvdim_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 185</span><span class="w">      </span><span class="k">return</span>
<span class="linenos"> 186</span><span class="k">    end if</span>
<span class="linenos"> 187</span>
<span class="linenos"> 188</span><span class="k">    </span><span class="n">vco_anl</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">vco_in</span><span class="w"></span>
<span class="linenos"> 189</span><span class="w">    </span><span class="n">nLev_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vco_anl</span><span class="p">%</span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 190</span><span class="w">    </span><span class="n">nLev_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vco_anl</span><span class="p">%</span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 191</span><span class="w">    </span><span class="c">! need an even number of levels for spectral transform (gstID2)</span>
<span class="linenos"> 192</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="n">nLev_T</span><span class="p">,</span><span class="mi">2</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 193</span><span class="k">      </span><span class="n">nLev_T_even</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLev_T</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 194</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 195</span><span class="k">      </span><span class="n">nLev_T_even</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLev_T</span><span class="w"></span>
<span class="linenos"> 196</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos"> 197</span><span class="k">    if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;BHI_setup: nLev_M, nLev_T, nLev_T_even=&#39;</span><span class="p">,</span><span class="n">nLev_M</span><span class="p">,</span><span class="w"> </span><span class="n">nLev_T</span><span class="p">,</span><span class="w"> </span><span class="n">nLev_T_even</span><span class="w"></span>
<span class="linenos"> 198</span>
<span class="linenos"> 199</span><span class="w">    </span><span class="c">! check if analysisgrid and covariance file have the same vertical levels</span>
<span class="linenos"> 200</span><span class="w">    </span><span class="k">call </span><span class="n">vco_SetupFromFile</span><span class="p">(</span><span class="w"> </span><span class="n">vco_file</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! OUT</span>
<span class="linenos"> 201</span><span class="w">                            </span><span class="n">bFileName</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="c">! IN</span>
<span class="linenos"> 202</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">vco_equal</span><span class="p">(</span><span class="n">vco_anl</span><span class="p">,</span><span class="n">vco_file</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 203</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bmatrixHI: vco from analysisgrid and cov file do not match&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 204</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 205</span>
<span class="linenos"> 206</span><span class="k">    </span><span class="n">Vcode_anl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vco_anl</span><span class="p">%</span><span class="n">Vcode</span><span class="w"></span>
<span class="linenos"> 207</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">Vcode_anl</span><span class="w"> </span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="w"> </span><span class="mi">5002</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">Vcode_anl</span><span class="w"> </span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="w"> </span><span class="mi">5005</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 208</span><span class="k">      write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Vcode_anl = &#39;</span><span class="p">,</span><span class="n">Vcode_anl</span><span class="w"></span>
<span class="linenos"> 209</span><span class="w">      </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bmatrixHI: unknown vertical coordinate type!&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 210</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos"> 211</span>
<span class="linenos"> 212</span><span class="k">    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;TT&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 213</span><span class="w">               </span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;UU&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 214</span><span class="w">               </span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;VV&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 215</span><span class="w">               </span><span class="p">(</span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;HU&#39;</span><span class="p">).</span><span class="nb">or</span><span class="p">.</span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;LQ&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 216</span><span class="w">               </span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;P0&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 217</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bmatrixHI: Some or all weather fields are missing. If it is desired to deactivate the weather assimilation, then all entries of the array SCALEFACTOR in the namelist NAMBHI should be set to zero.&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 218</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 219</span><span class="k">    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">varName</span><span class="o">=</span><span class="s1">&#39;TG&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 220</span><span class="k">      write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bmatrixHI: WARNING: The TG field is missing. This must be present when assimilating&#39;</span><span class="w"></span>
<span class="linenos"> 221</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;                    radiance observations&#39;</span><span class="w"></span>
<span class="linenos"> 222</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 223</span>
<span class="linenos"> 224</span><span class="k">    do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">nLev_M</span><span class="p">,</span><span class="n">nLev_T</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 225</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">scaleFactorLQ</span><span class="p">(</span><span class="n">jlev</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then </span>
<span class="linenos"> 226</span><span class="k">        </span><span class="n">scaleFactorLQ</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">scaleFactorLQ</span><span class="p">(</span><span class="n">jlev</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 227</span><span class="w">      </span><span class="k">else</span>
<span class="linenos"> 228</span><span class="k">        </span><span class="n">scaleFactorLQ</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 229</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos"> 230</span><span class="k">    enddo</span>
<span class="linenos"> 231</span>
<span class="linenos"> 232</span><span class="k">    do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">nLev_M</span><span class="p">,</span><span class="n">nLev_T</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 233</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">scaleFactorCC</span><span class="p">(</span><span class="n">jlev</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then </span>
<span class="linenos"> 234</span><span class="k">        </span><span class="n">scaleFactorCC</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">scaleFactorCC</span><span class="p">(</span><span class="n">jlev</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 235</span><span class="w">      </span><span class="k">else</span>
<span class="linenos"> 236</span><span class="k">        </span><span class="n">scaleFactorCC</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 237</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos"> 238</span><span class="k">    enddo</span>
<span class="linenos"> 239</span>
<span class="linenos"> 240</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">bhi_mode</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;BackgroundCheck&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 241</span><span class="k">       </span><span class="n">cvDim_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9999</span><span class="w"> </span><span class="c">! Dummy value &gt; 0 to indicate to the background check (s/r ose_compute_HBHT_ensemble) </span>
<span class="linenos"> 242</span><span class="w">                        </span><span class="c">! that Bhi is used</span>
<span class="linenos"> 243</span><span class="w">       </span><span class="k">return</span>
<span class="linenos"> 244</span><span class="k">    end if</span>
<span class="linenos"> 245</span>
<span class="linenos"> 246</span><span class="k">    </span><span class="n">numvar3d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="linenos"> 247</span><span class="w">    </span><span class="n">numvar2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="linenos"> 248</span>
<span class="linenos"> 249</span><span class="w">    </span><span class="n">nLevPtot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLev_M</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c">! ignore streamfunction at hyb=1, since highly correlated with next level</span>
<span class="linenos"> 250</span><span class="w">    </span><span class="n">nspositVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 251</span><span class="w">    </span><span class="n">nspositDI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="n">nLev_M</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 252</span><span class="w">    </span><span class="n">nspositTT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_M</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 253</span><span class="w">    </span><span class="n">nspositQ</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_M</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="n">nLev_T</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 254</span><span class="w">    </span><span class="n">nspositPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_M</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_T</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 255</span><span class="w">    </span><span class="n">nspositTG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_M</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_T</span><span class="o">+</span><span class="mi">2</span><span class="w"></span>
<span class="linenos"> 256</span><span class="w">    </span><span class="n">nkgdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLev_M</span><span class="o">*</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nLev_T</span><span class="o">*</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">numvar2d</span><span class="w"></span>
<span class="linenos"> 257</span><span class="w">    </span><span class="n">nkgdim2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nLev_T</span><span class="w"></span>
<span class="linenos"> 258</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">squareSqrt</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 259</span><span class="k">      </span><span class="n">nkgdimSqrt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 260</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 261</span><span class="k">      </span><span class="n">nkgdimSqrt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos"> 262</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos"> 263</span><span class="k">    </span><span class="n">nla_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="w"></span>
<span class="linenos"> 264</span><span class="w">    </span>
<span class="linenos"> 265</span><span class="w">    </span><span class="n">ni_l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hco_in</span><span class="p">%</span><span class="n">ni</span><span class="w"></span>
<span class="linenos"> 266</span><span class="w">    </span><span class="n">nj_l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hco_in</span><span class="p">%</span><span class="n">nj</span><span class="w"></span>
<span class="linenos"> 267</span><span class="w">    </span><span class="n">AnalGridID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hco_in</span><span class="p">%</span><span class="n">EZscintID</span><span class="w"></span>
<span class="linenos"> 268</span>
<span class="linenos"> 269</span><span class="w">    </span><span class="n">gstID</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">gst_setup</span><span class="p">(</span><span class="n">ni_l</span><span class="p">,</span><span class="n">nj_l</span><span class="p">,</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 270</span><span class="w">    </span><span class="n">gstID2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_setup</span><span class="p">(</span><span class="n">ni_l</span><span class="p">,</span><span class="n">nj_l</span><span class="p">,</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">nlev_T_even</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 271</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;BHI:returned value of gstID =&#39;</span><span class="p">,</span><span class="n">gstID</span><span class="w"></span>
<span class="linenos"> 272</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;BHI:returned value of gstID2=&#39;</span><span class="p">,</span><span class="n">gstID2</span><span class="w"></span>
<span class="linenos"> 273</span>
<span class="linenos"> 274</span><span class="w">    </span><span class="k">call </span><span class="n">mmpi_setup_latbands</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="w"> </span><span class="n">latPerPE</span><span class="p">,</span><span class="w"> </span><span class="n">latPerPEmax</span><span class="p">,</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 275</span><span class="w">    </span><span class="k">call </span><span class="n">mmpi_setup_lonbands</span><span class="p">(</span><span class="n">ni_l</span><span class="p">,</span><span class="w"> </span><span class="n">lonPerPE</span><span class="p">,</span><span class="w"> </span><span class="n">lonPerPEmax</span><span class="p">,</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 276</span>
<span class="linenos"> 277</span><span class="w">    </span><span class="k">call </span><span class="n">mmpi_setup_m</span><span class="p">(</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">mymBeg</span><span class="p">,</span><span class="n">mymEnd</span><span class="p">,</span><span class="n">mymSkip</span><span class="p">,</span><span class="n">mymCount</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 278</span><span class="w">    </span><span class="k">call </span><span class="n">mmpi_setup_n</span><span class="p">(</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">mynBeg</span><span class="p">,</span><span class="n">mynEnd</span><span class="p">,</span><span class="n">mynSkip</span><span class="p">,</span><span class="n">mynCount</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 279</span>
<span class="linenos"> 280</span><span class="w">    </span><span class="k">call </span><span class="n">gst_ilaList_mpiglobal</span><span class="p">(</span><span class="n">ilaList_mpiglobal</span><span class="p">,</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="n">maxMyNla</span><span class="p">,</span><span class="n">gstID</span><span class="p">,</span><span class="n">mymBeg</span><span class="p">,</span><span class="n">mymEnd</span><span class="p">,</span><span class="n">mymSkip</span><span class="p">,</span><span class="n">mynBeg</span><span class="p">,</span><span class="n">mynEnd</span><span class="p">,</span><span class="n">mynSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 281</span><span class="w">    </span><span class="k">call </span><span class="n">gst_ilaList_mpilocal</span><span class="p">(</span><span class="n">ilaList_mpilocal</span><span class="p">,</span><span class="n">gstID</span><span class="p">,</span><span class="n">mymBeg</span><span class="p">,</span><span class="n">mymEnd</span><span class="p">,</span><span class="n">mymSkip</span><span class="p">,</span><span class="n">mynBeg</span><span class="p">,</span><span class="n">mynEnd</span><span class="p">,</span><span class="n">mynSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 282</span>
<span class="linenos"> 283</span><span class="w">    </span><span class="c">! compute mpilocal control vector size</span>
<span class="linenos"> 284</span><span class="w">    </span><span class="n">cvDim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 285</span><span class="w">    </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mymEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mymSkip</span><span class="w"></span>
<span class="linenos"> 286</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mynBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mynEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mynSkip</span><span class="w"></span>
<span class="linenos"> 287</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 288</span><span class="k">          if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 289</span><span class="w">            </span><span class="c">! only real component for jm=0</span>
<span class="linenos"> 290</span><span class="w">            </span><span class="n">cvDim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvDim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos"> 291</span><span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="linenos"> 292</span><span class="w">            </span><span class="c">! both real and imaginary components for jm&gt;0</span>
<span class="linenos"> 293</span><span class="w">            </span><span class="n">cvDim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvDim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos"> 294</span><span class="w">          </span><span class="k">endif</span>
<span class="linenos"> 295</span><span class="k">        endif</span>
<span class="linenos"> 296</span><span class="k">      enddo</span>
<span class="linenos"> 297</span><span class="k">    enddo</span>
<span class="linenos"> 298</span><span class="k">    </span><span class="n">cvDim_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cvDim_mpilocal</span><span class="w"></span>
<span class="linenos"> 299</span>
<span class="linenos"> 300</span><span class="w">    </span><span class="c">! also compute mpiglobal control vector dimension</span>
<span class="linenos"> 301</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_allreduce</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">,</span><span class="n">cvDim_mpiglobal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="s2">&quot;mpi_sum&quot;</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 302</span>
<span class="linenos"> 303</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">PtoT</span><span class="p">(</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nj_l</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 304</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">tantheta</span><span class="p">(</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nj_l</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 305</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">rgsig</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 306</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">ni_l</span><span class="p">,</span><span class="n">nj_l</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 307</span><span class="w">    </span><span class="n">rgsiguu</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">rgsig</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nspositVO</span><span class="p">:</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">nlev_M</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 308</span><span class="w">    </span><span class="n">rgsigvv</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">rgsig</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nspositDI</span><span class="p">:</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">nlev_M</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 309</span><span class="w">    </span><span class="n">rgsigtt</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">rgsig</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nspositTT</span><span class="p">:</span><span class="n">nspositTT</span><span class="o">+</span><span class="n">nlev_T</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 310</span><span class="w">    </span><span class="n">rgsigq</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">rgsig</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nspositQ</span><span class="w"> </span><span class="p">:</span><span class="n">nspositQ</span><span class="w"> </span><span class="o">+</span><span class="n">nlev_T</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 311</span><span class="w">    </span><span class="n">rgsigps</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">rgsig</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nspositPS</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 312</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 313</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">nj_l</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 314</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">corns</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 315</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">rstddev</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 316</span>
<span class="linenos"> 317</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Memory Used: &#39;</span><span class="p">,</span><span class="n">get_max_rss</span><span class="p">()</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="s1">&#39;Mb&#39;</span><span class="w"></span>
<span class="linenos"> 318</span>
<span class="linenos"> 319</span><span class="w">    </span><span class="n">zps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10100</span><span class="mf">0.D0</span><span class="w"></span>
<span class="linenos"> 320</span><span class="w">    </span><span class="k">call </span><span class="n">czp_fetch1DLevels</span><span class="p">(</span><span class="n">vco_anl</span><span class="p">,</span><span class="w"> </span><span class="n">zps</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 321</span><span class="w">                           </span><span class="n">profM_opt</span><span class="o">=</span><span class="n">pressureProfile_M</span><span class="p">,</span><span class="w"> </span><span class="n">profT_opt</span><span class="o">=</span><span class="n">pressureProfile_T</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 322</span>
<span class="linenos"> 323</span><span class="w">    </span><span class="n">llfound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 324</span><span class="w">    </span><span class="n">nlev_bdl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 325</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 326</span><span class="w">      </span><span class="k">if</span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">llfound</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">pressureProfile_M</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="w"> </span><span class="n">rlimlv_bdl</span><span class="w">  </span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 327</span><span class="k">        </span><span class="n">nlev_bdl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jlev</span><span class="w"></span>
<span class="linenos"> 328</span><span class="w">        </span><span class="n">llfound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 329</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos"> 330</span><span class="k">    enddo</span>
<span class="linenos"> 331</span>
<span class="linenos"> 332</span><span class="k">    inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="n">bFileName</span><span class="p">,</span><span class="n">exist</span><span class="o">=</span><span class="n">lExists</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 333</span><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">lexists</span><span class="w"> </span><span class="p">)</span><span class="k">then</span>
<span class="linenos"> 334</span><span class="k">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fnom</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">bFileName</span><span class="p">,</span><span class="s1">&#39;RND+OLD+R/O&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 335</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 336</span><span class="k">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">fstouv</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="s1">&#39;RND+OLD&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 337</span><span class="w">      </span><span class="k">else</span>
<span class="linenos"> 338</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;BHI_setup:NO BACKGROUND STAT FILE!!&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 339</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos"> 340</span><span class="k">    endif</span>
<span class="linenos"> 341</span>
<span class="linenos"> 342</span><span class="k">    call </span><span class="n">BHI_rdspPtoT</span><span class="w"></span>
<span class="linenos"> 343</span>
<span class="linenos"> 344</span><span class="w">    </span><span class="k">call </span><span class="n">BHI_readcorns2</span><span class="w"></span>
<span class="linenos"> 345</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Memory Used (after readcorns2): &#39;</span><span class="p">,</span><span class="n">get_max_rss</span><span class="p">()</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="s1">&#39;Mb&#39;</span><span class="w"></span>
<span class="linenos"> 346</span>
<span class="linenos"> 347</span><span class="w">    </span><span class="k">call </span><span class="n">BHI_sutg</span><span class="w"></span>
<span class="linenos"> 348</span>
<span class="linenos"> 349</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">stddevmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;GD2D&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 350</span><span class="k">      call </span><span class="n">BHI_rdstd</span><span class="w"></span>
<span class="linenos"> 351</span><span class="w">    </span><span class="n">elseif</span><span class="p">(</span><span class="n">stddevMode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;SP2D&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 352</span><span class="k">      call </span><span class="n">BHI_rdspstd_newfmt</span><span class="w"></span>
<span class="linenos"> 353</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 354</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;BHI_setup: unknown stddevMode&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 355</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos"> 356</span>
<span class="linenos"> 357</span><span class="k">    call </span><span class="n">BHI_scalestd</span><span class="w"></span>
<span class="linenos"> 358</span>
<span class="linenos"> 359</span><span class="w">    </span><span class="k">call </span><span class="n">BHI_sucorns2</span><span class="w"></span>
<span class="linenos"> 360</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Memory Used (after sucorns2): &#39;</span><span class="p">,</span><span class="n">get_max_rss</span><span class="p">()</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="s1">&#39;Mb&#39;</span><span class="w"></span>
<span class="linenos"> 361</span>
<span class="linenos"> 362</span><span class="w">    </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstfrm</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 363</span><span class="w">    </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fclos</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 364</span>
<span class="linenos"> 365</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;END OF BHI_SETUP&#39;</span><span class="w"></span>
<span class="linenos"> 366</span>
<span class="linenos"> 367</span><span class="w">    </span><span class="n">initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 368</span>
<span class="linenos"> 369</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">BHI_setup</span><span class="w"></span>
<span class="linenos"> 370</span>
<span class="linenos"> 371</span>
<span class="linenos"> 372</span><span class="w">  </span><span class="k">subroutine </span><span class="n">bhi_getScaleFactor</span><span class="p">(</span><span class="n">scaleFactor_out</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 373</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos"> 374</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">scaleFactor_out</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 375</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="w"></span>
<span class="linenos"> 376</span>
<span class="linenos"> 377</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">nLev_M</span><span class="p">,</span><span class="n">nLev_T</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 378</span><span class="w">      </span><span class="n">scaleFactor_out</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 379</span><span class="w">    </span><span class="k">enddo</span>
<span class="linenos"> 380</span>
<span class="linenos"> 381</span><span class="k">  end subroutine </span><span class="n">bhi_getScaleFactor</span><span class="w"></span>
<span class="linenos"> 382</span>
<span class="linenos"> 383</span>
<span class="linenos"> 384</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_scalestd</span><span class="w"></span>
<span class="linenos"> 385</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos"> 386</span>
<span class="linenos"> 387</span><span class="k">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jlon</span><span class="p">,</span><span class="w"> </span><span class="n">jlat</span><span class="p">,</span><span class="w"> </span><span class="n">shift_level</span><span class="p">,</span><span class="w"> </span><span class="n">Vcode_anl</span><span class="w"></span>
<span class="linenos"> 388</span>
<span class="linenos"> 389</span><span class="w">    </span><span class="n">Vcode_anl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vco_anl</span><span class="p">%</span><span class="n">Vcode</span><span class="w"></span>
<span class="linenos"> 390</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">Vcode_anl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5002</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 391</span><span class="k">      </span><span class="n">shift_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 392</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 393</span><span class="k">      </span><span class="n">shift_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 394</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos"> 395</span>
<span class="linenos"> 396</span><span class="k">    do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 397</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos"> 398</span><span class="w">        </span><span class="n">rgsiguu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">                                 </span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="o">+</span><span class="n">shift_level</span><span class="p">)</span><span class="o">*</span><span class="n">rgsiguu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 399</span><span class="w">        </span><span class="n">rgsigvv</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scaleFactorCC</span><span class="p">(</span><span class="n">jlev</span><span class="o">+</span><span class="n">shift_level</span><span class="p">)</span><span class="o">*</span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="o">+</span><span class="n">shift_level</span><span class="p">)</span><span class="o">*</span><span class="n">rgsigvv</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 400</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos"> 401</span><span class="k">    enddo</span>
<span class="linenos"> 402</span><span class="k">    do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 403</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos"> 404</span><span class="w">        </span><span class="n">rgsigtt</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">                     </span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">rgsigtt</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 405</span><span class="w">        </span><span class="n">rgsigq</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">scaleFactorLQ</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">rgsigq</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 406</span><span class="w">        </span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">                     </span><span class="n">scaleFactor</span><span class="p">(</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 407</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos"> 408</span><span class="k">    enddo</span>
<span class="linenos"> 409</span><span class="k">    do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos"> 410</span><span class="w">      </span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scaleFactor</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nLev_M</span><span class="p">,</span><span class="n">nLev_T</span><span class="p">))</span><span class="o">*</span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 411</span><span class="w">      </span><span class="n">rgsigps</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">scaleFactor</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nLev_M</span><span class="p">,</span><span class="n">nLev_T</span><span class="p">))</span><span class="o">*</span><span class="n">rgsigps</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 412</span><span class="w">    </span><span class="k">enddo</span><span class="w"></span>
<span class="linenos"> 413</span><span class="w">    </span><span class="c">! User has the option to not scale down the STDDEV of TG (because underestimated in Benkf)</span>
<span class="linenos"> 414</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">scaleTG</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 415</span><span class="k">    do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos"> 416</span><span class="w">      </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ni_l</span><span class="w"></span>
<span class="linenos"> 417</span><span class="w">        </span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scaleFactor</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nLev_M</span><span class="p">,</span><span class="n">nLev_T</span><span class="p">))</span><span class="o">*</span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 418</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos"> 419</span><span class="k">    enddo</span>
<span class="linenos"> 420</span><span class="k">    endif</span>
<span class="linenos"> 421</span>
<span class="linenos"> 422</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_scalestd</span><span class="w"></span>
<span class="linenos"> 423</span>
<span class="linenos"> 424</span>
<span class="linenos"> 425</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_SUCORNS2</span><span class="w"></span>
<span class="linenos"> 426</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos"> 427</span>
<span class="linenos"> 428</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">eigenval</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">),</span><span class="w"> </span><span class="n">eigenvec</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">),</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 429</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">eigenvalsqrt</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">),</span><span class="w"> </span><span class="n">eigenvec2</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">),</span><span class="w"> </span><span class="n">eigenvalsqrt2</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 430</span>
<span class="linenos"> 431</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlat</span><span class="p">,</span><span class="n">jn</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk3</span><span class="w"></span>
<span class="linenos"> 432</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ilwork</span><span class="p">,</span><span class="n">info</span><span class="p">,</span><span class="n">klatPtoT</span><span class="w"></span>
<span class="linenos"> 433</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iulcorvert</span><span class="p">,</span><span class="w"> </span><span class="n">ikey</span><span class="p">,</span><span class="w"> </span><span class="n">nsize</span><span class="w"></span>
<span class="linenos"> 434</span>
<span class="linenos"> 435</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zwork</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">nkgdim2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 436</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ztt</span><span class="p">(</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">,(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span><span class="n">ztpsi</span><span class="p">(</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">,(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 437</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ztlen</span><span class="p">,</span><span class="n">zcorr</span><span class="p">,</span><span class="n">zr</span><span class="p">,</span><span class="n">zpres1</span><span class="p">,</span><span class="n">zpres2</span><span class="w"></span>
<span class="linenos"> 438</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zfact</span><span class="p">,</span><span class="n">zfact2</span><span class="p">,</span><span class="n">zcoriolis</span><span class="p">,</span><span class="n">zpsips</span><span class="p">(</span><span class="n">nLevPtoT</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 439</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zpsi</span><span class="p">(</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">),</span><span class="n">zfacttb</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">),</span><span class="n">zfactpsb</span><span class="p">(</span><span class="n">nj_l</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 440</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">corvert</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 441</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">corns_temp</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos"> 442</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lldebug</span><span class="p">,</span><span class="w"> </span><span class="n">lfound_sqrt</span><span class="w"></span>
<span class="linenos"> 443</span>
<span class="linenos"> 444</span><span class="w">    </span><span class="c">! standard file variables</span>
<span class="linenos"> 445</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="w"> </span><span class="n">inpas</span><span class="p">,</span><span class="w"> </span><span class="n">inbits</span><span class="p">,</span><span class="w"> </span><span class="n">idatyp</span><span class="p">,</span><span class="w"> </span><span class="n">ideet</span><span class="w"> </span>
<span class="linenos"> 446</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">ig1</span><span class="p">,</span><span class="n">ig2</span><span class="p">,</span><span class="n">ig3</span><span class="p">,</span><span class="n">ig4</span><span class="p">,</span><span class="n">iswa</span><span class="p">,</span><span class="n">ilength</span><span class="p">,</span><span class="n">idltf</span><span class="w"></span>
<span class="linenos"> 447</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iubc</span><span class="p">,</span><span class="n">iextr1</span><span class="p">,</span><span class="n">iextr2</span><span class="p">,</span><span class="n">iextr3</span><span class="p">,</span><span class="n">ierr</span><span class="w"></span>
<span class="linenos"> 448</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">idateo</span><span class="w"></span>
<span class="linenos"> 449</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cltypvar</span><span class="w"></span>
<span class="linenos"> 450</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clgrtyp</span><span class="w"></span>
<span class="linenos"> 451</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos"> 452</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cletiket</span><span class="w"></span>
<span class="linenos"> 453</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fstprm</span><span class="p">,</span><span class="n">fstinf</span><span class="w"></span>
<span class="linenos"> 454</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fnom</span><span class="p">,</span><span class="n">fstouv</span><span class="p">,</span><span class="n">fstfrm</span><span class="p">,</span><span class="n">fclos</span><span class="w"></span>
<span class="linenos"> 455</span>
<span class="linenos"> 456</span><span class="w">    </span><span class="n">lldebug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 457</span>
<span class="linenos"> 458</span><span class="w">    </span><span class="n">iulcorvert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 459</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 460</span><span class="k">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fnom</span><span class="p">(</span><span class="n">iulcorvert</span><span class="p">,</span><span class="s1">&#39;corvert_modular.fst&#39;</span><span class="p">,</span><span class="s1">&#39;RND&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 461</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstouv</span><span class="p">(</span><span class="n">iulcorvert</span><span class="p">,</span><span class="s1">&#39;RND&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 462</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos"> 463</span>
<span class="linenos"> 464</span><span class="k">    </span><span class="n">klatPtoT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 465</span><span class="w">    </span><span class="n">zfactpsb</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 466</span><span class="w">    </span><span class="n">zfacttb</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 467</span>
<span class="linenos"> 468</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">lldebug</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 469</span><span class="k">      do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 470</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevPtoT</span><span class="w"></span>
<span class="linenos"> 471</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="mi">622</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">klatPtoT</span><span class="p">,</span><span class="n">PtoT</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">klatPtoT</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 472</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos"> 473</span><span class="k">      enddo</span>
<span class="linenos"> 474</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos"> 475</span>
<span class="linenos"> 476</span><span class="w">    </span><span class="c">! explicitly compute the balanced temperature and temperature-psi correlations</span>
<span class="linenos"> 477</span>
<span class="linenos"> 478</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 479</span>
<span class="linenos"> 480</span><span class="w">      </span><span class="n">ztpsi</span><span class="p">(:,:,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 481</span><span class="w">      </span><span class="n">ztt</span><span class="p">(:,:,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 482</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevPtoT</span><span class="w"></span>
<span class="linenos"> 483</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 484</span><span class="w">          </span><span class="k">do </span><span class="n">jk3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevPtoT</span><span class="w"></span>
<span class="linenos"> 485</span><span class="w">            </span><span class="n">ztpsi</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ztpsi</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">PtoT</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk3</span><span class="p">,</span><span class="n">klatPtoT</span><span class="p">)</span><span class="o">*</span><span class="n">corns</span><span class="p">(</span><span class="n">jk3</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 486</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 487</span><span class="k">        enddo</span>
<span class="linenos"> 488</span><span class="k">      enddo</span>
<span class="linenos"> 489</span><span class="k">      if</span><span class="p">(</span><span class="n">nlevPtoT</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 490</span><span class="k">        do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">nlevPtoT</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 491</span><span class="w">          </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 492</span><span class="w">            </span><span class="n">ztpsi</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ztpsi</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">nlevPtoT</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 493</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 494</span><span class="k">        enddo</span>
<span class="linenos"> 495</span><span class="k">      endif</span>
<span class="linenos"> 496</span><span class="k">      do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 497</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 498</span><span class="w">          </span><span class="k">do </span><span class="n">jk3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevPtoT</span><span class="w"></span>
<span class="linenos"> 499</span><span class="w">            </span><span class="n">ztt</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ztt</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ztpsi</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk3</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">PtoT</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk3</span><span class="p">,</span><span class="n">klatPtoT</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 500</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 501</span><span class="k">        enddo</span>
<span class="linenos"> 502</span><span class="k">      enddo</span>
<span class="linenos"> 503</span><span class="k">    enddo</span>
<span class="linenos"> 504</span>
<span class="linenos"> 505</span><span class="k">    if</span><span class="p">(</span><span class="n">lldebug</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 506</span><span class="k">      write</span><span class="p">(</span><span class="mi">620</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">ztt</span><span class="w"></span>
<span class="linenos"> 507</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="mi">621</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">ztpsi</span><span class="w"></span>
<span class="linenos"> 508</span><span class="w">    </span><span class="k">endif</span><span class="w"></span>
<span class="linenos"> 509</span>
<span class="linenos"> 510</span><span class="w">    </span><span class="c">! fill in blocks for balance temperature</span>
<span class="linenos"> 511</span>
<span class="linenos"> 512</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 513</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 514</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 515</span><span class="w">          </span><span class="n">corns</span><span class="p">(</span><span class="n">nkgdim</span><span class="o">+</span><span class="n">jk2</span><span class="p">,</span><span class="n">nkgdim</span><span class="o">+</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ztt</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 516</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos"> 517</span><span class="k">      enddo</span>
<span class="linenos"> 518</span><span class="k">      do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 519</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 520</span><span class="w">          </span><span class="n">corns</span><span class="p">(</span><span class="w">       </span><span class="n">jk1</span><span class="p">,</span><span class="n">nkgdim</span><span class="o">+</span><span class="n">jk2</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ztpsi</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 521</span><span class="w">          </span><span class="n">corns</span><span class="p">(</span><span class="n">nkgdim</span><span class="o">+</span><span class="n">jk2</span><span class="p">,</span><span class="w">       </span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ztpsi</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 522</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos"> 523</span><span class="k">      enddo</span>
<span class="linenos"> 524</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos"> 525</span>
<span class="linenos"> 526</span><span class="w">    </span><span class="c">! Save un-localized PSI correlations</span>
<span class="linenos"> 527</span><span class="w">    </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 528</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 529</span><span class="w">        </span><span class="n">zpsi</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 530</span><span class="w">        </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 531</span><span class="w">          </span><span class="n">zpsi</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zpsi</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="o">+</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">jn</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 532</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos"> 533</span><span class="k">      enddo</span>
<span class="linenos"> 534</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos"> 535</span>
<span class="linenos"> 536</span><span class="w">    </span><span class="c">! Apply vertical localization to corrns</span>
<span class="linenos"> 537</span>
<span class="linenos"> 538</span><span class="w">    </span><span class="c">! unbalanced temperature</span>
<span class="linenos"> 539</span><span class="w">    </span><span class="n">ztlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rvlocunbalt</span><span class="w"></span>
<span class="linenos"> 540</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ztlen</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 541</span><span class="w">      </span><span class="c">! calculate 5&#39;th order function (from Gaspari and Cohn)</span>
<span class="linenos"> 542</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 543</span><span class="w">        </span><span class="n">zpres1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">(</span><span class="n">jk1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 544</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 545</span><span class="w">          </span><span class="n">zpres2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">(</span><span class="n">jk2</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 546</span><span class="w">          </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">zpres2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zpres1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 547</span><span class="w">          </span><span class="n">zcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gasparicohn</span><span class="p">(</span><span class="n">ztlen</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 548</span><span class="w">          </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 549</span><span class="w">            </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 550</span><span class="w">                 </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">zcorr</span><span class="w"></span>
<span class="linenos"> 551</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 552</span><span class="k">        enddo</span>
<span class="linenos"> 553</span><span class="k">      enddo</span>
<span class="linenos"> 554</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos"> 555</span>
<span class="linenos"> 556</span><span class="w">    </span><span class="c">! balanced temperature</span>
<span class="linenos"> 557</span><span class="w">    </span><span class="n">ztlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rvlocbalt</span><span class="w"></span>
<span class="linenos"> 558</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ztlen</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 559</span><span class="w">      </span><span class="c">! calculate 5&#39;th order function (from Gaspari and Cohn)</span>
<span class="linenos"> 560</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 561</span><span class="w">        </span><span class="n">zpres1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">(</span><span class="n">jk1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 562</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 563</span><span class="w">          </span><span class="n">zpres2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">(</span><span class="n">jk2</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 564</span><span class="w">          </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">zpres2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zpres1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 565</span><span class="w">          </span><span class="n">zcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gasparicohn</span><span class="p">(</span><span class="n">ztlen</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 566</span><span class="w">          </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 567</span><span class="w">            </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 568</span><span class="w">                 </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">zcorr</span><span class="w"></span>
<span class="linenos"> 569</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 570</span><span class="k">        enddo</span>
<span class="linenos"> 571</span><span class="k">      enddo</span>
<span class="linenos"> 572</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos"> 573</span>
<span class="linenos"> 574</span><span class="w">    </span><span class="c">! streamfunction </span>
<span class="linenos"> 575</span><span class="w">    </span><span class="n">ztlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rvlocpsi</span><span class="w">    </span><span class="c">! specify length scale (in units of ln(Pressure))</span>
<span class="linenos"> 576</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ztlen</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 577</span><span class="w">      </span><span class="c">! calculate 5&#39;th order function (from Gaspari and Cohn)</span>
<span class="linenos"> 578</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 579</span><span class="w">        </span><span class="n">zpres1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_M</span><span class="p">(</span><span class="n">jk1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 580</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 581</span><span class="w">          </span><span class="n">zpres2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_M</span><span class="p">(</span><span class="n">jk2</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 582</span><span class="w">          </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">zpres2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zpres1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 583</span><span class="w">          </span><span class="n">zcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gasparicohn</span><span class="p">(</span><span class="n">ztlen</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 584</span><span class="w">          </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 585</span><span class="w">            </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">zcorr</span><span class="w"></span>
<span class="linenos"> 586</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 587</span><span class="k">        enddo</span>
<span class="linenos"> 588</span><span class="k">      enddo</span>
<span class="linenos"> 589</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos"> 590</span>
<span class="linenos"> 591</span><span class="w">    </span><span class="c">! temp-psi cross-correlations</span>
<span class="linenos"> 592</span><span class="w">    </span><span class="n">ztlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rvlocpsitt</span><span class="w">    </span><span class="c">! specify length scale (in units of ln(Pressure))</span>
<span class="linenos"> 593</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ztlen</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 594</span><span class="w">      </span><span class="c">! calculate 5&#39;th order function (from Gaspari and Cohn)</span>
<span class="linenos"> 595</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 596</span><span class="w">        </span><span class="n">zpres1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_M</span><span class="p">(</span><span class="n">jk1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 597</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 598</span><span class="w">          </span><span class="n">zpres2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">(</span><span class="n">jk2</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 599</span><span class="w">          </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">zpres2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zpres1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 600</span><span class="w">          </span><span class="n">zcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gasparicohn</span><span class="p">(</span><span class="n">ztlen</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 601</span><span class="w">          </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 602</span><span class="w">            </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">zcorr</span><span class="w"></span>
<span class="linenos"> 603</span><span class="w">            </span><span class="n">corns</span><span class="p">(</span><span class="n">jk2</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corns</span><span class="p">(</span><span class="n">jk2</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">zcorr</span><span class="w"></span>
<span class="linenos"> 604</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 605</span><span class="k">        enddo</span>
<span class="linenos"> 606</span><span class="k">      enddo</span>
<span class="linenos"> 607</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos"> 608</span>
<span class="linenos"> 609</span><span class="w">    </span><span class="c">! velocity potential (unbalanced)</span>
<span class="linenos"> 610</span><span class="w">    </span><span class="n">ztlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rvlocchi</span><span class="w">    </span><span class="c">! specify length scale (in units of ln(Pressure))</span>
<span class="linenos"> 611</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ztlen</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 612</span><span class="w">      </span><span class="c">! calculate 5&#39;th order function (from Gaspari and Cohn)</span>
<span class="linenos"> 613</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 614</span><span class="w">        </span><span class="n">zpres1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_M</span><span class="p">(</span><span class="n">jk1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 615</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos"> 616</span><span class="w">          </span><span class="n">zpres2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_M</span><span class="p">(</span><span class="n">jk2</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 617</span><span class="w">          </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">zpres2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zpres1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 618</span><span class="w">          </span><span class="n">zcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gasparicohn</span><span class="p">(</span><span class="n">ztlen</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 619</span><span class="w">          </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 620</span><span class="w">            </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="o">+</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="o">+</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">zcorr</span><span class="w"></span>
<span class="linenos"> 621</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 622</span><span class="k">        enddo</span>
<span class="linenos"> 623</span><span class="k">      enddo</span>
<span class="linenos"> 624</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos"> 625</span>
<span class="linenos"> 626</span><span class="w">    </span><span class="c">! cross-correlation t&#39;-ps&#39;</span>
<span class="linenos"> 627</span><span class="w">    </span><span class="k">if</span><span class="p">(.</span><span class="n">true</span><span class="p">.)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 628</span><span class="k">    </span><span class="n">ztlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rvlocunbalt</span><span class="w">    </span><span class="c">! specify length scale (in units of ln(Pressure))</span>
<span class="linenos"> 629</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ztlen</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 630</span><span class="w">      </span><span class="c">! calculate 5&#39;th order function (from Gaspari and Cohn)</span>
<span class="linenos"> 631</span><span class="w">      </span><span class="n">zpres1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">(</span><span class="n">nlev_T</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 632</span><span class="w">      </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 633</span><span class="w">        </span><span class="n">zpres2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">(</span><span class="n">jk2</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 634</span><span class="w">        </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">zpres2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zpres1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 635</span><span class="w">        </span><span class="n">zcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gasparicohn</span><span class="p">(</span><span class="n">ztlen</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 636</span><span class="w">        </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 637</span><span class="w">          </span><span class="n">corns</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 638</span><span class="w">               </span><span class="n">corns</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">zcorr</span><span class="w"></span>
<span class="linenos"> 639</span><span class="w">          </span><span class="n">corns</span><span class="p">(</span><span class="n">jk2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 640</span><span class="w">               </span><span class="n">corns</span><span class="p">(</span><span class="n">jk2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">zcorr</span><span class="w"></span>
<span class="linenos"> 641</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos"> 642</span><span class="k">      enddo</span>
<span class="linenos"> 643</span><span class="k">    endif</span>
<span class="linenos"> 644</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos"> 645</span>
<span class="linenos"> 646</span><span class="w">    </span><span class="c">! humidity</span>
<span class="linenos"> 647</span><span class="w">    </span><span class="n">ztlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rvloclq</span><span class="w">    </span><span class="c">! specify length scale (in units of ln(Pressure))</span>
<span class="linenos"> 648</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ztlen</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 649</span><span class="w">      </span><span class="c">! calculate 5&#39;th order function (from Gaspari and Cohn)</span>
<span class="linenos"> 650</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 651</span><span class="w">        </span><span class="n">zpres1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">(</span><span class="n">jk1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 652</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 653</span><span class="w">          </span><span class="n">zpres2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">(</span><span class="n">jk2</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 654</span><span class="w">          </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">zpres2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zpres1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 655</span><span class="w">          </span><span class="n">zcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gasparicohn</span><span class="p">(</span><span class="n">ztlen</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 656</span><span class="w">          </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 657</span><span class="w">            </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="o">+</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="o">+</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 658</span><span class="w">                 </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="o">+</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">jk2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="o">+</span><span class="n">nlev_T</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">zcorr</span><span class="w"></span>
<span class="linenos"> 659</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 660</span><span class="k">        enddo</span>
<span class="linenos"> 661</span><span class="k">      enddo</span>
<span class="linenos"> 662</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos"> 663</span>
<span class="linenos"> 664</span><span class="w">    </span><span class="c">! compute total vertical correlations (including for balanced temperature)</span>
<span class="linenos"> 665</span><span class="w">    </span><span class="k">if</span><span class="p">(.</span><span class="n">true</span><span class="p">.)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 666</span><span class="k">      do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 667</span><span class="w">        </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 668</span><span class="w">          </span><span class="n">corvert</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 669</span><span class="w">          </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 670</span><span class="w">            </span><span class="n">corvert</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corvert</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="o">+</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">jn</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 671</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 672</span><span class="k">        enddo</span>
<span class="linenos"> 673</span><span class="k">      enddo</span>
<span class="linenos"> 674</span>
<span class="linenos"> 675</span><span class="k">      if</span><span class="p">(</span><span class="n">lldebug</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 676</span><span class="k">        write</span><span class="p">(</span><span class="mi">701</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">corvert</span><span class="w"></span>
<span class="linenos"> 677</span><span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="mi">702</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">zpsi</span><span class="w"></span>
<span class="linenos"> 678</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos"> 679</span>
<span class="linenos"> 680</span><span class="k">      if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 681</span><span class="k">        </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">NULBGST</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;CORRNS&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;ZZ&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 682</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstprm</span><span class="p">(</span><span class="n">ikey</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="n">ideet</span><span class="p">,</span><span class="n">inpas</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="w"> </span><span class="n">inbits</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 683</span><span class="w">             </span><span class="p">,</span><span class="n">idatyp</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">clgrtyp</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 684</span><span class="w">             </span><span class="p">,</span><span class="n">ig1</span><span class="p">,</span><span class="n">ig2</span><span class="p">,</span><span class="n">ig3</span><span class="p">,</span><span class="n">ig4</span><span class="p">,</span><span class="n">iswa</span><span class="p">,</span><span class="n">ilength</span><span class="p">,</span><span class="n">idltf</span><span class="p">,</span><span class="n">iubc</span><span class="p">,</span><span class="n">iextr1</span><span class="p">,</span><span class="n">iextr2</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 685</span><span class="w">             </span><span class="p">,</span><span class="n">iextr3</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 686</span>
<span class="linenos"> 687</span><span class="w">        </span><span class="n">ini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 688</span><span class="w">        </span><span class="n">inj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 689</span><span class="w">        </span><span class="n">ink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 690</span><span class="w">        </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 691</span><span class="w">        </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 692</span><span class="w">        </span><span class="n">ip3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 693</span><span class="w">        </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ZV&#39;</span><span class="w"></span>
<span class="linenos"> 694</span><span class="w">        </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CORVERT&#39;</span><span class="w"></span>
<span class="linenos"> 695</span><span class="w">        </span><span class="n">idatyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="linenos"> 696</span>
<span class="linenos"> 697</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstecr</span><span class="p">(</span><span class="n">corvert</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">inbits</span><span class="p">,</span><span class="w"> </span><span class="n">iulcorvert</span><span class="p">,</span><span class="w"> </span><span class="n">idateo</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 698</span><span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="n">ideet</span><span class="p">,</span><span class="n">inpas</span><span class="p">,</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="w"> </span><span class="n">inj</span><span class="p">,</span><span class="w"> </span><span class="n">ink</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">ip2</span><span class="p">,</span><span class="w"> </span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">cltypvar</span><span class="p">,</span><span class="w">     </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 699</span><span class="w">             </span><span class="n">clnomvar</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">clgrtyp</span><span class="p">,</span><span class="n">ig1</span><span class="p">,</span><span class="w"> </span><span class="n">ig2</span><span class="p">,</span><span class="w"> </span><span class="n">ig3</span><span class="p">,</span><span class="w"> </span><span class="n">ig4</span><span class="p">,</span><span class="w"> </span><span class="n">idatyp</span><span class="p">,</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 700</span><span class="w">             </span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos"> 701</span>
<span class="linenos"> 702</span><span class="w">      </span><span class="k">endif</span><span class="w"></span>
<span class="linenos"> 703</span>
<span class="linenos"> 704</span><span class="w">      </span><span class="c">! Modify RGSIGTB to obtain correct sigma_Tb</span>
<span class="linenos"> 705</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 706</span><span class="w">        </span><span class="n">zfact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corvert</span><span class="p">(</span><span class="n">jk1</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="n">jk1</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 707</span><span class="w">        </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos"> 708</span><span class="w">          </span><span class="n">zcoriolis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="mf">2.d0</span><span class="o">*</span><span class="n">ec_Omega</span><span class="o">*</span><span class="n">gst_getrmu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">gstID</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 709</span><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">zfact</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">zcoriolis</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 710</span><span class="k">            </span><span class="n">zfact2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0d0</span><span class="o">/</span><span class="p">(</span><span class="n">zfact</span><span class="o">*</span><span class="n">zcoriolis</span><span class="o">*</span><span class="n">zcoriolis</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 711</span><span class="w">          </span><span class="k">else </span>
<span class="linenos"> 712</span><span class="k">            </span><span class="n">zfact2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 713</span><span class="w">          </span><span class="k">endif</span>
<span class="linenos"> 714</span><span class="k">          </span><span class="n">zfacttb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zfacttb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="o">+</span><span class="n">zfact2</span><span class="w"></span>
<span class="linenos"> 715</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos"> 716</span><span class="k">      enddo</span><span class="w"></span>
<span class="linenos"> 717</span>
<span class="linenos"> 718</span><span class="w">      </span><span class="c">! Modify RGSIGPSB to obtain correct sigma_PSb</span>
<span class="linenos"> 719</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos"> 720</span><span class="w">        </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevPtoT</span><span class="w"></span>
<span class="linenos"> 721</span><span class="w">          </span><span class="n">zpsips</span><span class="p">(</span><span class="n">jk2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 722</span><span class="w">          </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevPtoT</span><span class="w"></span>
<span class="linenos"> 723</span><span class="w">            </span><span class="n">zpsips</span><span class="p">(</span><span class="n">jk2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zpsips</span><span class="p">(</span><span class="n">jk2</span><span class="p">)</span><span class="o">+</span><span class="n">PtoT</span><span class="p">(</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">klatPtoT</span><span class="p">)</span><span class="o">*</span><span class="n">zpsi</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 724</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 725</span><span class="k">        enddo</span>
<span class="linenos"> 726</span><span class="k">        </span><span class="n">zfact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 727</span><span class="w">        </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevPtoT</span><span class="w"></span>
<span class="linenos"> 728</span><span class="w">          </span><span class="n">zfact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zfact</span><span class="o">+</span><span class="n">PtoT</span><span class="p">(</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">klatPtoT</span><span class="p">)</span><span class="o">*</span><span class="n">zpsips</span><span class="p">(</span><span class="n">jk1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 729</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos"> 730</span><span class="k">        </span><span class="n">zcoriolis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="mf">2.d0</span><span class="o">*</span><span class="n">ec_Omega</span><span class="o">*</span><span class="n">gst_getrmu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">gstID</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 731</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">zfact</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">zcoriolis</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 732</span><span class="k">          </span><span class="n">zfact2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0d0</span><span class="o">/</span><span class="p">(</span><span class="n">zfact</span><span class="o">*</span><span class="n">zcoriolis</span><span class="o">*</span><span class="n">zcoriolis</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 733</span><span class="w">        </span><span class="k">else </span>
<span class="linenos"> 734</span><span class="k">          </span><span class="n">zfact2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 735</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos"> 736</span><span class="k">        </span><span class="n">zfactpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zfactpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="o">+</span><span class="n">zfact2</span><span class="w"></span>
<span class="linenos"> 737</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos"> 738</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos"> 739</span>
<span class="linenos"> 740</span><span class="w">    </span><span class="c">! Modify RGSIGTB and RGSIGPSB to obtain correct sigma_Tb and sigma_Psb</span>
<span class="linenos"> 741</span><span class="w">    </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos"> 742</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">zfactpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 743</span><span class="k">        </span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">zfactpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 744</span><span class="w">      </span><span class="k">else</span>
<span class="linenos"> 745</span><span class="k">        </span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 746</span><span class="w">      </span><span class="k">endif          </span>
<span class="linenos"> 747</span><span class="k">      do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos"> 748</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">zfacttb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 749</span><span class="k">          </span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">zfacttb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 750</span><span class="w">        </span><span class="k">else</span>
<span class="linenos"> 751</span><span class="k">          </span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 752</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos"> 753</span><span class="k">      enddo</span>
<span class="linenos"> 754</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos"> 755</span>
<span class="linenos"> 756</span><span class="w">    </span><span class="c">! compute square-root of corns for each total wavenumber</span>
<span class="linenos"> 757</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">corns_temp</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 758</span><span class="w">    </span><span class="n">corns_temp</span><span class="p">(:,:,:)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 759</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="p">,</span><span class="w"> </span><span class="n">mmpi_nprocs</span><span class="w"></span>
<span class="linenos"> 760</span>
<span class="linenos"> 761</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 762</span><span class="w">         </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 763</span><span class="w">            </span><span class="n">eigenvec</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corns</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 764</span><span class="w">         </span><span class="k">enddo</span>
<span class="linenos"> 765</span><span class="k">      enddo</span><span class="w"></span>
<span class="linenos"> 766</span>
<span class="linenos"> 767</span><span class="w">      </span><span class="c">! CALCULATE EIGENVALUES AND EIGENVECTORS.</span>
<span class="linenos"> 768</span><span class="w">      </span><span class="n">ilwork</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="n">nkgdim2</span><span class="o">*</span><span class="mi">2</span><span class="w"></span>
<span class="linenos"> 769</span><span class="w">      </span><span class="k">call </span><span class="n">dsyev</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">eigenvec</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">eigenval</span><span class="p">,</span><span class="n">zwork</span><span class="p">,</span><span class="n">ilwork</span><span class="p">,</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 770</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 771</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_sucorns2: non-zero value of info =&#39;</span><span class="p">,</span><span class="n">info</span><span class="p">,</span><span class="s1">&#39; returned by dsyev for wavenumber &#39;</span><span class="p">,</span><span class="n">jn</span><span class="w"></span>
<span class="linenos"> 772</span><span class="w">        </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;BHI_SUCORNS&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 773</span><span class="w">      </span><span class="k">endif</span><span class="w"></span>
<span class="linenos"> 774</span>
<span class="linenos"> 775</span><span class="w">      </span><span class="c">! set selected number of eigenmodes to zero</span>
<span class="linenos"> 776</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">numModeZero</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 777</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_sucorns2: setting &#39;</span><span class="p">,</span><span class="n">numModeZero</span><span class="p">,</span><span class="s1">&#39; eigenvalues to zero for wavenumber n=&#39;</span><span class="p">,</span><span class="n">jn</span><span class="w"></span>
<span class="linenos"> 778</span><span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_sucorns2: original eigenvalues=&#39;</span><span class="p">,</span><span class="n">eigenval</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 779</span><span class="w">        </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">numModeZero</span><span class="w"></span>
<span class="linenos"> 780</span><span class="w">          </span><span class="n">eigenval</span><span class="p">(</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 781</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos"> 782</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_sucorns2: modified eigenvalues=&#39;</span><span class="p">,</span><span class="n">eigenval</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 783</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos"> 784</span>
<span class="linenos"> 785</span><span class="k">      do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 786</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">eigenval</span><span class="p">(</span><span class="n">jk1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">1.0d-15</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 787</span><span class="k">          </span><span class="n">eigenvalsqrt</span><span class="p">(</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 788</span><span class="w">        </span><span class="k">else</span>
<span class="linenos"> 789</span><span class="k">          </span><span class="n">eigenvalsqrt</span><span class="p">(</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">eigenval</span><span class="p">(</span><span class="n">jk1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 790</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos"> 791</span><span class="k">      enddo</span><span class="w"></span>
<span class="linenos"> 792</span><span class="w"> </span>
<span class="linenos"> 793</span><span class="w">      </span><span class="c">! Reverse the order of E-Values if old formulation (for compatibility)</span>
<span class="linenos"> 794</span><span class="w">      </span><span class="k">if</span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">squareSqrt</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 795</span><span class="k">        do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 796</span><span class="w">          </span><span class="n">eigenvalsqrt2</span><span class="p">(</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eigenvalsqrt</span><span class="p">(</span><span class="n">nkgdim2</span><span class="o">-</span><span class="n">jk1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 797</span><span class="w">          </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 798</span><span class="w">            </span><span class="n">eigenvec2</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eigenvec</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">nkgdim2</span><span class="o">-</span><span class="n">jk1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 799</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos"> 800</span><span class="k">        enddo</span>
<span class="linenos"> 801</span><span class="k">        </span><span class="n">eigenvalsqrt</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eigenvalsqrt2</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 802</span><span class="w">        </span><span class="n">eigenvec</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eigenvec2</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos"> 803</span><span class="w">      </span><span class="k">endif</span><span class="w"></span>
<span class="linenos"> 804</span>
<span class="linenos"> 805</span><span class="w">      </span><span class="c">! compute E * lambda^1/2</span>
<span class="linenos"> 806</span><span class="w">      </span><span class="k">result</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 807</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos"> 808</span><span class="w">         </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 809</span><span class="w">            </span><span class="k">result</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eigenvec</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="o">*</span><span class="n">eigenvalsqrt</span><span class="p">(</span><span class="n">jk1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 810</span><span class="w">         </span><span class="k">enddo</span>
<span class="linenos"> 811</span><span class="k">      enddo</span><span class="w"></span>
<span class="linenos"> 812</span>
<span class="linenos"> 813</span><span class="w">      </span><span class="c">! compute (E * lambda^1/2) * E^T if new formulation</span>
<span class="linenos"> 814</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">squareSqrt</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 815</span><span class="k">        do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 816</span><span class="w">          </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 817</span><span class="w">            </span><span class="k">do </span><span class="n">jk3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 818</span><span class="w">              </span><span class="n">corns_temp</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">corns_temp</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">jk2</span><span class="p">,</span><span class="n">jk3</span><span class="p">)</span><span class="o">*</span><span class="n">eigenvec</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk3</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 819</span><span class="w">            </span><span class="k">enddo</span>
<span class="linenos"> 820</span><span class="k">          enddo</span>
<span class="linenos"> 821</span><span class="k">        enddo</span>
<span class="linenos"> 822</span><span class="k">      else</span>
<span class="linenos"> 823</span><span class="k">        </span><span class="n">corns_temp</span><span class="p">(:,:,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">result</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos"> 824</span><span class="w">      </span><span class="k">endif</span><span class="w"></span>
<span class="linenos"> 825</span>
<span class="linenos"> 826</span><span class="w">      </span><span class="c">!if(jn == 30) then</span>
<span class="linenos"> 827</span><span class="w">      </span><span class="c">!  write(200,*) corns(:,:,jn)</span>
<span class="linenos"> 828</span><span class="w">      </span><span class="c">!  write(201,*) corns_temp(:,:,jn)</span>
<span class="linenos"> 829</span><span class="w">      </span><span class="c">!  write(202,*) eigenval(:)</span>
<span class="linenos"> 830</span><span class="w">      </span><span class="c">!  write(203,*) eigenvec(:,:)</span>
<span class="linenos"> 831</span><span class="w">      </span><span class="c">!  call flush(200)</span>
<span class="linenos"> 832</span><span class="w">      </span><span class="c">!  call flush(201)</span>
<span class="linenos"> 833</span><span class="w">      </span><span class="c">!  call flush(202)</span>
<span class="linenos"> 834</span><span class="w">      </span><span class="c">!  call flush(203)</span>
<span class="linenos"> 835</span><span class="w">      </span><span class="c">!endif</span>
<span class="linenos"> 836</span>
<span class="linenos"> 837</span><span class="w">    </span><span class="k">enddo</span><span class="w"> </span><span class="c">! jn</span>
<span class="linenos"> 838</span>
<span class="linenos"> 839</span><span class="w">    </span><span class="n">nsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nkgdim2</span><span class="o">*</span><span class="n">nkgdim2</span><span class="o">*</span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 840</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_allreduce</span><span class="p">(</span><span class="n">corns_temp</span><span class="p">,</span><span class="n">corns</span><span class="p">,</span><span class="n">nsize</span><span class="p">,</span><span class="s2">&quot;mpi_double_precision&quot;</span><span class="p">,</span><span class="s2">&quot;mpi_sum&quot;</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 841</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">corns_temp</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 842</span>
<span class="linenos"> 843</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 844</span><span class="k">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstfrm</span><span class="p">(</span><span class="n">iulcorvert</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 845</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fclos</span><span class="p">(</span><span class="n">iulcorvert</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 846</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos"> 847</span>
<span class="linenos"> 848</span><span class="k">    if</span><span class="p">(</span><span class="n">ReadWrite_sqrt</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 849</span><span class="w">      </span><span class="c">! if desired, read precomputed sqrt of corns which overwrites computed matrix</span>
<span class="linenos"> 850</span><span class="w">      </span><span class="k">call </span><span class="n">readcorns_sqrt</span><span class="p">(</span><span class="n">lfound_sqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 851</span><span class="w">      </span><span class="k">if</span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">lfound_sqrt</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 852</span><span class="w">        </span><span class="c">! if precomputed sqrt does not exist in stats, then write it out to a separate file</span>
<span class="linenos"> 853</span><span class="w">        </span><span class="k">call </span><span class="n">writecorns_sqrt</span><span class="w"></span>
<span class="linenos"> 854</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos"> 855</span><span class="k">    endif</span>
<span class="linenos"> 856</span>
<span class="linenos"> 857</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_SUCORNS2</span><span class="w"></span>
<span class="linenos"> 858</span>
<span class="linenos"> 859</span>
<span class="linenos"> 860</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">WRITECORNS_SQRT</span><span class="w"></span>
<span class="linenos"> 861</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos"> 862</span>
<span class="linenos"> 863</span><span class="k">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">nulcorns_sqrt</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="w"></span>
<span class="linenos"> 864</span>
<span class="linenos"> 865</span><span class="w">    </span><span class="c">! standard file variables</span>
<span class="linenos"> 866</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="w"></span>
<span class="linenos"> 867</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">idateo</span><span class="p">,</span><span class="w"> </span><span class="n">ipak</span><span class="p">,</span><span class="w"> </span><span class="n">idatyp</span><span class="w"></span>
<span class="linenos"> 868</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fnom</span><span class="p">,</span><span class="w"> </span><span class="n">fstouv</span><span class="p">,</span><span class="w">  </span><span class="n">fstfrm</span><span class="p">,</span><span class="w"> </span><span class="n">fclos</span><span class="w"></span>
<span class="linenos"> 869</span>
<span class="linenos"> 870</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;WRITECORNS_SQRT: CORNS_SQRT will be written to file corns_sqrt.fst for NTRUNC =&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 871</span>
<span class="linenos"> 872</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 873</span><span class="k">      </span><span class="n">nulcorns_sqrt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 874</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fnom</span><span class="p">(</span><span class="n">nulcorns_sqrt</span><span class="p">,</span><span class="s1">&#39;corns_sqrt.fst&#39;</span><span class="p">,</span><span class="s1">&#39;RND&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 875</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstouv</span><span class="p">(</span><span class="n">nulcorns_sqrt</span><span class="p">,</span><span class="s1">&#39;RND&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 876</span>
<span class="linenos"> 877</span><span class="w">      </span><span class="n">ipak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">32</span><span class="w"></span>
<span class="linenos"> 878</span><span class="w">      </span><span class="n">idatyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="linenos"> 879</span><span class="w">      </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 880</span><span class="w">      </span><span class="n">ip3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 881</span><span class="w">      </span><span class="n">idateo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 882</span>
<span class="linenos"> 883</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 884</span><span class="w">        </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos"> 885</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstecr</span><span class="p">(</span><span class="n">corns</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jn</span><span class="p">),</span><span class="n">ipak</span><span class="p">,</span><span class="n">nulcorns_sqrt</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 886</span><span class="w">                       </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;ZZ&#39;</span><span class="p">,</span><span class="s1">&#39;CORNS_SQRT&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">idatyp</span><span class="p">,.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos"> 887</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos"> 888</span>
<span class="linenos"> 889</span><span class="k">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstfrm</span><span class="p">(</span><span class="n">nulcorns_sqrt</span><span class="p">)</span><span class="w">  </span>
<span class="linenos"> 890</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fclos</span><span class="p">(</span><span class="n">nulcorns_sqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 891</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos"> 892</span>
<span class="linenos"> 893</span><span class="k">  END SUBROUTINE </span><span class="n">WRITECORNS_SQRT</span><span class="w"></span>
<span class="linenos"> 894</span>
<span class="linenos"> 895</span>
<span class="linenos"> 896</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">READCORNS_SQRT</span><span class="p">(</span><span class="n">lfound_sqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 897</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos"> 898</span><span class="k">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lfound_sqrt</span><span class="w"></span>
<span class="linenos"> 899</span>
<span class="linenos"> 900</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">icornskey</span><span class="w"></span>
<span class="linenos"> 901</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jcol</span><span class="p">,</span><span class="n">jrow</span><span class="w"></span>
<span class="linenos"> 902</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zcornssrc</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos"> 903</span>
<span class="linenos"> 904</span><span class="w">    </span><span class="c">! standard file variables</span>
<span class="linenos"> 905</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="w"></span>
<span class="linenos"> 906</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="w"></span>
<span class="linenos"> 907</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">idateo</span><span class="w"></span>
<span class="linenos"> 908</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cltypvar</span><span class="w"></span>
<span class="linenos"> 909</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos"> 910</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cletiket</span><span class="w"></span>
<span class="linenos"> 911</span>
<span class="linenos"> 912</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">zcornssrc</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 913</span>
<span class="linenos"> 914</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;READCORNS_SQRT: looking for CORNS_SQRT with NTRUNC =&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 915</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 916</span>
<span class="linenos"> 917</span><span class="w">      </span><span class="c">! Looking for FST record parameters..</span>
<span class="linenos"> 918</span><span class="w">      </span><span class="n">idateo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 919</span><span class="w">      </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CORNS_SQRT&#39;</span><span class="w"></span>
<span class="linenos"> 920</span><span class="w">      </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 921</span><span class="w">      </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos"> 922</span><span class="w">      </span><span class="n">ip3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos"> 923</span><span class="w">      </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;X&#39;</span><span class="w"></span>
<span class="linenos"> 924</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ZZ&#39;</span><span class="w"></span>
<span class="linenos"> 925</span><span class="w">      </span><span class="n">icornskey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">ZCORNSSRC</span><span class="p">,</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">INI</span><span class="p">,</span><span class="n">INJ</span><span class="p">,</span><span class="n">INK</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 926</span>
<span class="linenos"> 927</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 928</span><span class="k">        if</span><span class="p">(</span><span class="n">icornskey</span><span class="w"> </span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 929</span><span class="k">          write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;READCORNS_SQRT: CORNS_SQRT not found in stats file, use computed sqrt&#39;</span><span class="w"></span>
<span class="linenos"> 930</span><span class="w">          </span><span class="n">lfound_sqrt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 931</span><span class="w">          </span><span class="k">return</span>
<span class="linenos"> 932</span><span class="k">        else</span>
<span class="linenos"> 933</span><span class="k">          write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;READCORNS_SQRT: CORNS_SQRT found in stats file, will use it instead of computed sqrt&#39;</span><span class="w"></span>
<span class="linenos"> 934</span><span class="w">          </span><span class="n">lfound_sqrt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 935</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos"> 936</span><span class="k">      endif</span>
<span class="linenos"> 937</span>
<span class="linenos"> 938</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ini</span><span class="w"> </span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">inj</span><span class="w"> </span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="w"> </span><span class="n">nkgdim2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 939</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;READCORNS2: BG stat levels inconsitencies&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 940</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos"> 941</span>
<span class="linenos"> 942</span><span class="k">      do </span><span class="n">jcol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 943</span><span class="w">        </span><span class="k">do </span><span class="n">jrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos"> 944</span><span class="w">          </span><span class="n">corns</span><span class="p">(</span><span class="n">jrow</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcornssrc</span><span class="p">(</span><span class="n">jrow</span><span class="p">,</span><span class="n">jcol</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 945</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos"> 946</span><span class="k">      enddo</span>
<span class="linenos"> 947</span>
<span class="linenos"> 948</span><span class="k">    enddo</span>
<span class="linenos"> 949</span>
<span class="linenos"> 950</span><span class="k">    deallocate</span><span class="p">(</span><span class="n">zcornssrc</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 951</span>
<span class="linenos"> 952</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">READCORNS_SQRT</span><span class="w"></span>
<span class="linenos"> 953</span>
<span class="linenos"> 954</span>
<span class="linenos"> 955</span><span class="w">  </span><span class="k">FUNCTION </span><span class="n">GASPARICOHN</span><span class="p">(</span><span class="n">ztlen</span><span class="p">,</span><span class="n">zr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 956</span>
<span class="linenos"> 957</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">gasparicohn</span><span class="w"></span>
<span class="linenos"> 958</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ztlen</span><span class="p">,</span><span class="n">zr</span><span class="p">,</span><span class="n">zlc</span><span class="w"></span>
<span class="linenos"> 959</span>
<span class="linenos"> 960</span><span class="w">    </span><span class="n">zlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ztlen</span><span class="o">/</span><span class="mf">2.0d0</span><span class="w"></span>
<span class="linenos"> 961</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">zr</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">zlc</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 962</span><span class="k">      </span><span class="n">gasparicohn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">0.250d0</span><span class="o">*</span><span class="p">(</span><span class="n">zr</span><span class="o">/</span><span class="n">zlc</span><span class="p">)</span><span class="o">**</span><span class="mi">5</span><span class="o">+</span><span class="mf">0.5d0</span><span class="o">*</span><span class="p">(</span><span class="n">zr</span><span class="o">/</span><span class="n">zlc</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="w">             </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 963</span><span class="w">                  </span><span class="o">+</span><span class="mf">0.625d0</span><span class="o">*</span><span class="p">(</span><span class="n">zr</span><span class="o">/</span><span class="n">zlc</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="o">-</span><span class="p">(</span><span class="mf">5.0d0</span><span class="o">/</span><span class="mf">3.0d0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zr</span><span class="o">/</span><span class="n">zlc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos"> 964</span><span class="w">    </span><span class="n">elseif</span><span class="p">(</span><span class="n">zr</span><span class="p">.</span><span class="n">le</span><span class="p">.(</span><span class="mf">2.0d0</span><span class="o">*</span><span class="n">zlc</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 965</span><span class="k">      </span><span class="n">gasparicohn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0d0</span><span class="o">/</span><span class="mi">1</span><span class="mf">2.0d0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zr</span><span class="o">/</span><span class="n">zlc</span><span class="p">)</span><span class="o">**</span><span class="mi">5</span><span class="o">-</span><span class="mf">0.5d0</span><span class="o">*</span><span class="p">(</span><span class="n">zr</span><span class="o">/</span><span class="n">zlc</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 966</span><span class="w">                  </span><span class="o">+</span><span class="mf">0.625d0</span><span class="o">*</span><span class="p">(</span><span class="n">zr</span><span class="o">/</span><span class="n">zlc</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="o">+</span><span class="p">(</span><span class="mf">5.0d0</span><span class="o">/</span><span class="mf">3.0d0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zr</span><span class="o">/</span><span class="n">zlc</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 967</span><span class="w">                  </span><span class="o">-</span><span class="mf">5.0d0</span><span class="o">*</span><span class="p">(</span><span class="n">zr</span><span class="o">/</span><span class="n">zlc</span><span class="p">)</span><span class="o">+</span><span class="mf">4.0d0</span><span class="o">-</span><span class="p">(</span><span class="mf">2.0d0</span><span class="o">/</span><span class="mf">3.0d0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zlc</span><span class="o">/</span><span class="n">zr</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 968</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 969</span><span class="k">      </span><span class="n">gasparicohn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 970</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos"> 971</span><span class="k">    if</span><span class="p">(</span><span class="n">gasparicohn</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="n">gasparicohn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 972</span>
<span class="linenos"> 973</span><span class="w">  </span><span class="k">END FUNCTION </span><span class="n">GASPARICOHN</span><span class="w"></span>
<span class="linenos"> 974</span>
<span class="linenos"> 975</span>
<span class="linenos"> 976</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_CALCCORR</span><span class="p">(</span><span class="n">zgd</span><span class="p">,</span><span class="n">pcscl</span><span class="p">,</span><span class="n">klev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 977</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos"> 978</span><span class="k">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">klev</span><span class="w"></span>
<span class="linenos"> 979</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zgd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">klev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 980</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pcscl</span><span class="p">(</span><span class="n">klev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 981</span>
<span class="linenos"> 982</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jlat</span><span class="p">,</span><span class="w"> </span><span class="n">jlon</span><span class="w"></span>
<span class="linenos"> 983</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zr</span><span class="p">,</span><span class="w"> </span><span class="n">dlfac</span><span class="p">,</span><span class="w"> </span><span class="n">dltemp</span><span class="p">,</span><span class="w"> </span><span class="n">dln</span><span class="p">,</span><span class="w"> </span><span class="n">dlcsurn</span><span class="p">,</span><span class="w"> </span><span class="n">dlc</span><span class="p">,</span><span class="w"> </span><span class="n">dlcorr</span><span class="w"></span>
<span class="linenos"> 984</span>
<span class="linenos"> 985</span><span class="w">    </span><span class="c">! parameters that define the correlation function</span>
<span class="linenos"> 986</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ntoar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="linenos"> 987</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dlalpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2d0</span><span class="w"></span>
<span class="linenos"> 988</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kcorrtyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 989</span>
<span class="linenos"> 990</span><span class="w">    </span><span class="n">dlfac</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mf">1.d0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.d0</span><span class="o">+</span><span class="n">dlalpha</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 991</span><span class="w">    </span><span class="n">dln</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">1.d0</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">ntoar</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 992</span><span class="w">    </span><span class="n">dltemp</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">3.d0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.d0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dlalpha</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.d0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dlalpha</span><span class="o">/</span><span class="p">(</span><span class="n">dln</span><span class="o">*</span><span class="n">dln</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 993</span><span class="w">    </span><span class="n">dltemp</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">dsqrt</span><span class="p">(</span><span class="n">dltemp</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 994</span>
<span class="linenos"> 995</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kcorrtyp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 996</span><span class="w">      </span><span class="c">! Gaussian correlation</span>
<span class="linenos"> 997</span><span class="w">      </span><span class="k">do  </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">klev</span><span class="w"></span>
<span class="linenos"> 998</span><span class="w">        </span><span class="n">dlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.d0</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">pcscl</span><span class="p">(</span><span class="n">jlev</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 999</span><span class="w">        </span><span class="n">dlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5d0</span><span class="o">*</span><span class="n">dlc</span><span class="o">*</span><span class="n">dlc</span><span class="w"></span>
<span class="linenos">1000</span><span class="w">        </span><span class="k">do  </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">1001</span><span class="w">          </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ec_ra</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="n">gst_getRmu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">gstID</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1002</span><span class="w">          </span><span class="n">dlcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">dexp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">zr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dlc</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1003</span><span class="w">          </span><span class="k">do  </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">1004</span><span class="w">            </span><span class="n">zgd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlcorr</span><span class="w"></span>
<span class="linenos">1005</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">1006</span><span class="k">        enddo</span>
<span class="linenos">1007</span><span class="k">      enddo</span>
<span class="linenos">1008</span><span class="k">    </span><span class="n">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">kcorrtyp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1009</span><span class="w">      </span><span class="c">! Autoregressive (SOAR) correlation</span>
<span class="linenos">1010</span><span class="w">      </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">klev</span><span class="w"></span>
<span class="linenos">1011</span><span class="w">        </span><span class="n">dlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dltemp</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">pcscl</span><span class="p">(</span><span class="n">jlev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1012</span><span class="w">        </span><span class="n">dlcsurn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlc</span><span class="o">/</span><span class="n">dln</span><span class="w"></span>
<span class="linenos">1013</span><span class="w">        </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">1014</span><span class="w">          </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ec_ra</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="n">gst_getRmu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">gstID</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1015</span><span class="w">          </span><span class="n">dlcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.d0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dlc</span><span class="o">*</span><span class="n">zr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">zr</span><span class="o">*</span><span class="n">dlc</span><span class="o">*</span><span class="n">zr</span><span class="o">*</span><span class="n">dlc</span><span class="o">/</span><span class="mf">3.d0</span><span class="p">)</span><span class="o">*</span><span class="nb">dexp</span><span class="p">(</span><span class="o">-</span><span class="n">zr</span><span class="o">*</span><span class="n">dlc</span><span class="p">)</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1016</span><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">dlalpha</span><span class="o">*</span><span class="p">(</span><span class="mf">1.d0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dlcsurn</span><span class="o">*</span><span class="n">zr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">zr</span><span class="o">*</span><span class="n">dlcsurn</span><span class="o">*</span><span class="n">zr</span><span class="o">*</span><span class="n">dlcsurn</span><span class="o">/</span><span class="mf">3.d0</span><span class="p">)</span><span class="o">*</span><span class="nb">dexp</span><span class="p">(</span><span class="o">-</span><span class="n">zr</span><span class="o">*</span><span class="n">dlcsurn</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1017</span><span class="w">          </span><span class="n">dlcorr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlcorr</span><span class="o">*</span><span class="n">dlfac</span><span class="w"></span>
<span class="linenos">1018</span><span class="w">          </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">1019</span><span class="w">            </span><span class="n">zgd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlcorr</span><span class="w"></span>
<span class="linenos">1020</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">1021</span><span class="k">        enddo</span>
<span class="linenos">1022</span><span class="k">      enddo</span>
<span class="linenos">1023</span><span class="k">    else</span>
<span class="linenos">1024</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;CALCCORR- Undefined correlation type&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1025</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos">1026</span>
<span class="linenos">1027</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_calcCorr</span><span class="w"></span>
<span class="linenos">1028</span>
<span class="linenos">1029</span>
<span class="linenos">1030</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_SUTG</span><span class="w"></span>
<span class="linenos">1031</span><span class="w">    </span><span class="k">use </span><span class="n">timeCoord_mod</span><span class="w"></span>
<span class="linenos">1032</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1033</span>
<span class="linenos">1034</span><span class="k">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">llpb</span><span class="w"></span>
<span class="linenos">1035</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ikey</span><span class="p">,</span><span class="w"> </span><span class="n">jlat</span><span class="p">,</span><span class="w"> </span><span class="n">jlon</span><span class="p">,</span><span class="w"> </span><span class="n">jla</span><span class="p">,</span><span class="w"> </span><span class="n">ezgprm</span><span class="p">,</span><span class="w"> </span><span class="n">ezqkdef</span><span class="w"></span>
<span class="linenos">1036</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="w"> </span><span class="n">inlev</span><span class="p">,</span><span class="w"> </span><span class="n">itggid</span><span class="p">,</span><span class="w"> </span><span class="n">inmxlev</span><span class="p">,</span><span class="w"> </span><span class="n">iset</span><span class="p">,</span><span class="w"> </span><span class="n">nsize</span><span class="w"></span>
<span class="linenos">1037</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ezdefset</span><span class="w"></span>
<span class="linenos">1038</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1style</span><span class="p">,</span><span class="n">ip1kind</span><span class="w"></span>
<span class="linenos">1039</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">koutmpg</span><span class="w"></span>
<span class="linenos">1040</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dltg</span><span class="p">(:,:),</span><span class="w"> </span><span class="n">tgstdbg_tmp</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">1041</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cortgg</span><span class="p">(</span><span class="n">nla_mpiglobal</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1042</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rcscltg_vec</span><span class="p">(</span><span class="n">nlev_T_even</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1043</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">zabs</span><span class="p">,</span><span class="w"> </span><span class="n">zpole</span><span class="p">,</span><span class="w"> </span><span class="n">dlfac</span><span class="w"></span>
<span class="linenos">1044</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zsp_mpilocal</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nlev_T_even</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1045</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zgd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nlev_T_even</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1046</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">nla_mpiglobal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1047</span>
<span class="linenos">1048</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">my_zsp_mpiglobal</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">1049</span>
<span class="linenos">1050</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TrialLandSeaMask</span><span class="p">(:,:),</span><span class="w"> </span><span class="n">TrialSeaIceMask</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">1051</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">AnalLandSeaMask</span><span class="p">(:,:),</span><span class="w"> </span><span class="n">AnalSeaIceMask</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">1052</span>
<span class="linenos">1053</span><span class="w">    </span><span class="c">! standard file variables</span>
<span class="linenos">1054</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="w"> </span><span class="n">idatyp</span><span class="w"></span>
<span class="linenos">1055</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="w"></span>
<span class="linenos">1056</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ierr</span><span class="p">,</span><span class="n">ntrials</span><span class="w"></span>
<span class="linenos">1057</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">idateo</span><span class="w"></span>
<span class="linenos">1058</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fstprm</span><span class="p">,</span><span class="n">fstinf</span><span class="p">,</span><span class="n">iultg</span><span class="p">,</span><span class="n">fnom</span><span class="p">,</span><span class="n">fclos</span><span class="p">,</span><span class="n">fstouv</span><span class="p">,</span><span class="n">fstfrm</span><span class="w"></span>
<span class="linenos">1059</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1s</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">nulbgsts</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1060</span>
<span class="linenos">1061</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TrlmNumberWanted</span><span class="w"></span>
<span class="linenos">1062</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fstlir</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">nultrl</span><span class="p">,</span><span class="w"> </span><span class="n">ni_trial</span><span class="p">,</span><span class="w"> </span><span class="n">nj_trial</span><span class="w"></span>
<span class="linenos">1063</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">deet</span><span class="p">,</span><span class="w"> </span><span class="n">npas</span><span class="p">,</span><span class="w"> </span><span class="n">nbits</span><span class="p">,</span><span class="w"> </span><span class="n">datyp</span><span class="w"></span>
<span class="linenos">1064</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ig1</span><span class="p">,</span><span class="n">ig2</span><span class="p">,</span><span class="n">ig3</span><span class="p">,</span><span class="n">ig4</span><span class="p">,</span><span class="n">swa</span><span class="p">,</span><span class="w"> </span><span class="n">lng</span><span class="p">,</span><span class="w"> </span><span class="n">dltf</span><span class="p">,</span><span class="w"> </span><span class="n">ubc</span><span class="w"></span>
<span class="linenos">1065</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extra1</span><span class="p">,</span><span class="w"> </span><span class="n">extra2</span><span class="p">,</span><span class="w"> </span><span class="n">extra3</span><span class="w"></span>
<span class="linenos">1066</span><span class="w">    </span>
<span class="linenos">1067</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TrialGridID</span><span class="w"></span>
<span class="linenos">1068</span>
<span class="linenos">1069</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cltypvar</span><span class="w"></span>
<span class="linenos">1070</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clgrtyp</span><span class="w"></span>
<span class="linenos">1071</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1072</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cletiket</span><span class="w"></span>
<span class="linenos">1073</span>
<span class="linenos">1074</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">flnum</span><span class="w"></span>
<span class="linenos">1075</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">trialfile</span><span class="w"></span>
<span class="linenos">1076</span>
<span class="linenos">1077</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">trialExists</span><span class="w"></span>
<span class="linenos">1078</span>
<span class="linenos">1079</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1080</span><span class="w">    </span><span class="c">!- 1.  Reading and processing TG standard deviations</span>
<span class="linenos">1081</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1082</span>
<span class="linenos">1083</span><span class="w">    </span><span class="c">!- 1.1 Read the Std. Dev. field from ./bgcov file</span>
<span class="linenos">1084</span><span class="w">    </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;TG&#39;</span><span class="w"></span>
<span class="linenos">1085</span><span class="w">    </span><span class="n">idateo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1086</span><span class="w">    </span><span class="n">inmxlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1087</span><span class="w">    </span><span class="n">ntrials</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1088</span><span class="w">    </span><span class="n">nulbgsts</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nulbgst</span><span class="w"></span>
<span class="linenos">1089</span>
<span class="linenos">1090</span><span class="w">    </span><span class="k">call </span><span class="n">utl_getfldprm</span><span class="p">(</span><span class="n">IP1S</span><span class="p">,</span><span class="w"> </span><span class="n">IP2</span><span class="p">,</span><span class="w"> </span><span class="n">IP3</span><span class="p">,</span><span class="w"> </span><span class="n">INLEV</span><span class="p">,</span><span class="w"> </span><span class="n">CLETIKET</span><span class="p">,</span><span class="w"> </span><span class="n">CLTYPVAR</span><span class="p">,</span><span class="w"> </span><span class="n">ITGGID</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1091</span><span class="w">                       </span><span class="n">clnomvar</span><span class="p">,</span><span class="w"> </span><span class="n">idateo</span><span class="p">,</span><span class="w"> </span><span class="n">inmxlev</span><span class="p">,</span><span class="w"> </span><span class="n">nulbgsts</span><span class="p">,</span><span class="w"> </span><span class="n">ip1style</span><span class="p">,</span><span class="w"> </span><span class="n">ip1kind</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1092</span><span class="w">                       </span><span class="n">ntrials</span><span class="p">,</span><span class="w"> </span><span class="n">koutmpg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1093</span><span class="w">    </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ip1s</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1094</span>
<span class="linenos">1095</span><span class="w">    </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ezgprm</span><span class="p">(</span><span class="n">itggid</span><span class="p">,</span><span class="n">CLGRTYP</span><span class="p">,</span><span class="n">INI</span><span class="p">,</span><span class="n">INJ</span><span class="p">,</span><span class="n">IG1</span><span class="p">,</span><span class="n">IG2</span><span class="p">,</span><span class="n">IG3</span><span class="p">,</span><span class="n">IG4</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1096</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">dltg</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1097</span>
<span class="linenos">1098</span><span class="w">    </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">dltg</span><span class="p">,</span><span class="n">koutmpg</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1099</span><span class="w">           </span><span class="n">ip2</span><span class="p">,</span><span class="w"> </span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">cltypvar</span><span class="p">,</span><span class="w"> </span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1100</span>
<span class="linenos">1101</span><span class="w">    </span><span class="c">!- 1.2 Rearrange the data according to the analysis grid (if necessary)</span>
<span class="linenos">1102</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">clgrtyp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;G&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ni_l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ini</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nj_l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inj</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ig1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1103</span><span class="w">          </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ig2</span><span class="w"> </span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ig3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">ig4</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1104</span><span class="w">      </span><span class="c">!- 1.2.1 The std. dev. on the analysis grid </span>
<span class="linenos">1105</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1106</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">ni_l</span><span class="w"></span>
<span class="linenos">1107</span><span class="w">          </span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dltg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1108</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">1109</span><span class="k">      enddo</span>
<span class="linenos">1110</span>
<span class="linenos">1111</span><span class="k">    </span><span class="n">elseif</span><span class="p">(</span><span class="n">clgrtyp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;G&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ni_l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ini</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nj_l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">inj</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ig1</span><span class="w"> </span><span class="o">==</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1112</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ig2</span><span class="w"> </span><span class="o">==</span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ig3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">ig4</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1113</span><span class="w">       </span><span class="c">!- 1.2.2 flipped Gaussian grid no longer supported</span>
<span class="linenos">1114</span><span class="w">       </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bhi_sutg: The flipped Gaussian grid is no longer supported!&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1115</span>
<span class="linenos">1116</span><span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1117</span><span class="w">       </span><span class="c">!- 1.2.3 The std. dev. are NOT on the analysis grid. Interpolation is needed</span>
<span class="linenos">1118</span><span class="w">       </span><span class="n">iset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ezdefset</span><span class="p">(</span><span class="n">AnalGridID</span><span class="p">,</span><span class="n">itggid</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1119</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">TweakTG</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1120</span><span class="k">          </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">int_hInterpScalar</span><span class="p">(</span><span class="n">tgstdbg</span><span class="p">,</span><span class="n">dltg</span><span class="p">,</span><span class="n">interpDegree</span><span class="o">=</span><span class="s1">&#39;NEAREST&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1121</span><span class="w">       </span><span class="k">else</span>
<span class="linenos">1122</span><span class="k">          </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">int_hInterpScalar</span><span class="p">(</span><span class="n">tgstdbg</span><span class="p">,</span><span class="n">dltg</span><span class="p">,</span><span class="n">interpDegree</span><span class="o">=</span><span class="s1">&#39;CUBIC&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1123</span><span class="w">       </span><span class="k">end if</span>
<span class="linenos">1124</span>
<span class="linenos">1125</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">1126</span>
<span class="linenos">1127</span><span class="w">    </span><span class="c">!- 1.3 Tweaking the Std Dev.</span>
<span class="linenos">1128</span>
<span class="linenos">1129</span><span class="w">    </span><span class="c">!- 1.3.1 If specified at the top of the module, do not accept TG errors of more than value specified above</span>
<span class="linenos">1130</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">llimtg</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1131</span><span class="k">       if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1132</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Capping TG Std. Dev. using a max value (K) = &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">rlimsuptg</span><span class="w"></span>
<span class="linenos">1133</span><span class="w">       </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tgstdbg</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rlimsuptg</span><span class="p">)</span><span class="w"> </span><span class="n">tgstdbg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlimsuptg</span><span class="w"></span>
<span class="linenos">1134</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1135</span>
<span class="linenos">1136</span><span class="w">    </span><span class="c">!- 1.3.2 Take into account the Land-Sea mask and the Sea-Ice mask of the day</span>
<span class="linenos">1137</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">TweakTG</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1138</span>
<span class="linenos">1139</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1140</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Adjusting TG Std Dev based on LandSea and SeaIce masks&#39;</span><span class="w"></span>
<span class="linenos">1141</span>
<span class="linenos">1142</span><span class="w">      </span><span class="c">!- Read MG and GL in the middle of the assimilation time window</span>
<span class="linenos">1143</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tim_nStepObs</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1144</span><span class="k">         </span><span class="n">TrlmNumberWanted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1145</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">1146</span><span class="k">         </span><span class="n">TrlmNumberWanted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">nint</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">tim_nStepObs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.d0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.d0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1147</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1148</span>
<span class="linenos">1149</span><span class="k">      write</span><span class="p">(</span><span class="n">flnum</span><span class="p">,</span><span class="s1">&#39;(I2.2)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">TrlmNumberWanted</span><span class="w"></span>
<span class="linenos">1150</span><span class="w">      </span><span class="n">trialfile</span><span class="o">=</span><span class="s1">&#39;./trlm_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">flnum</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1151</span><span class="w">      </span><span class="k">inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">trialfile</span><span class="p">),</span><span class="n">exist</span><span class="o">=</span><span class="n">trialExists</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1152</span>
<span class="linenos">1153</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">trialExists</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1154</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1155</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Trial file not found = &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">trialfile</span><span class="w"></span>
<span class="linenos">1156</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Look for an ensemble of trial files &#39;</span><span class="w"></span>
<span class="linenos">1157</span>
<span class="linenos">1158</span><span class="w">        </span><span class="n">trialfile</span><span class="o">=</span><span class="s1">&#39;./trlm_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">flnum</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_0001&#39;</span><span class="w"></span>
<span class="linenos">1159</span><span class="w">        </span><span class="k">inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">trialfile</span><span class="p">),</span><span class="n">exist</span><span class="o">=</span><span class="n">trialExists</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1160</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">trialExists</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1161</span><span class="k">           if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Ensemble trial file not found = &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">trialfile</span><span class="w"></span>
<span class="linenos">1162</span><span class="w">           </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;BMatrixHI : DID NOT FIND A TRIAL FIELD FILE&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1163</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1164</span><span class="k">      end if</span>
<span class="linenos">1165</span>
<span class="linenos">1166</span><span class="k">      </span><span class="n">nultrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1167</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fnom</span><span class="p">(</span><span class="n">nultrl</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">trialfile</span><span class="p">),</span><span class="s1">&#39;RND+OLD+R/O&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1168</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstouv</span><span class="p">(</span><span class="n">nultrl</span><span class="p">,</span><span class="s1">&#39;RND+OLD&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1169</span>
<span class="linenos">1170</span><span class="w">      </span><span class="c">!- Determine grid size and EZSCINT ID</span>
<span class="linenos">1171</span><span class="w">      </span><span class="n">idateo</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1172</span><span class="w">      </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"></span>
<span class="linenos">1173</span><span class="w">      </span><span class="n">ip1</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1174</span><span class="w">      </span><span class="n">ip2</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1175</span><span class="w">      </span><span class="n">ip3</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1176</span><span class="w">      </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"></span>
<span class="linenos">1177</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;MG&#39;</span><span class="w"></span>
<span class="linenos">1178</span>
<span class="linenos">1179</span><span class="w">      </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="w"> </span><span class="n">nultrl</span><span class="p">,</span><span class="w">                                             </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! IN</span>
<span class="linenos">1180</span><span class="w">                    </span><span class="n">ni_trial</span><span class="p">,</span><span class="w"> </span><span class="n">nj_trial</span><span class="p">,</span><span class="w"> </span><span class="n">ink</span><span class="p">,</span><span class="w">                            </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! OUT</span>
<span class="linenos">1181</span><span class="w">                    </span><span class="n">idateo</span><span class="p">,</span><span class="w"> </span><span class="n">cletiket</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">ip2</span><span class="p">,</span><span class="w"> </span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">cltypvar</span><span class="p">,</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c">! IN</span>
<span class="linenos">1182</span>
<span class="linenos">1183</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1184</span><span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1185</span><span class="w">         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bMatrixHI: Unable to find trial field = &#39;</span><span class="p">,</span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1186</span><span class="w">         </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;BMatrixHI&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1187</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1188</span>
<span class="linenos">1189</span><span class="k">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstprm</span><span class="p">(</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w">                                                 </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! IN</span>
<span class="linenos">1190</span><span class="w">                     </span><span class="n">idateo</span><span class="p">,</span><span class="w"> </span><span class="n">deet</span><span class="p">,</span><span class="w"> </span><span class="n">npas</span><span class="p">,</span><span class="w"> </span><span class="n">ni_trial</span><span class="p">,</span><span class="w"> </span><span class="n">nj_trial</span><span class="p">,</span><span class="w"> </span><span class="n">ink</span><span class="p">,</span><span class="w"> </span><span class="n">nbits</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! OUT</span>
<span class="linenos">1191</span><span class="w">                     </span><span class="n">datyp</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">ip2</span><span class="p">,</span><span class="w"> </span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">cltypvar</span><span class="p">,</span><span class="w"> </span><span class="n">clnomvar</span><span class="p">,</span><span class="w"> </span><span class="n">cletiket</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! OUT</span>
<span class="linenos">1192</span><span class="w">                     </span><span class="n">clgrtyp</span><span class="p">,</span><span class="w"> </span><span class="n">ig1</span><span class="p">,</span><span class="w"> </span><span class="n">ig2</span><span class="p">,</span><span class="w"> </span><span class="n">ig3</span><span class="p">,</span><span class="w">                              </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! OUT</span>
<span class="linenos">1193</span><span class="w">                     </span><span class="n">ig4</span><span class="p">,</span><span class="w"> </span><span class="n">swa</span><span class="p">,</span><span class="w"> </span><span class="n">lng</span><span class="p">,</span><span class="w"> </span><span class="n">dltf</span><span class="p">,</span><span class="w"> </span><span class="n">ubc</span><span class="p">,</span><span class="w"> </span><span class="n">extra1</span><span class="p">,</span><span class="w"> </span><span class="n">extra2</span><span class="p">,</span><span class="w"> </span><span class="n">extra3</span><span class="w"> </span><span class="p">)</span><span class="w">     </span><span class="c">! OUT</span>
<span class="linenos">1194</span>
<span class="linenos">1195</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">TrialLandSeaMask</span><span class="p">(</span><span class="n">ni_trial</span><span class="p">,</span><span class="w"> </span><span class="n">nj_trial</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1196</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">TrialSeaIceMask</span><span class="p">(</span><span class="n">ni_trial</span><span class="p">,</span><span class="w"> </span><span class="n">nj_trial</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1197</span>
<span class="linenos">1198</span><span class="w">      </span><span class="n">idateo</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1199</span><span class="w">      </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"></span>
<span class="linenos">1200</span><span class="w">      </span><span class="n">ip1</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1201</span><span class="w">      </span><span class="n">ip2</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1202</span><span class="w">      </span><span class="n">ip3</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1203</span><span class="w">      </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"></span>
<span class="linenos">1204</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;MG&#39;</span><span class="w"></span>
<span class="linenos">1205</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstlir</span><span class="p">(</span><span class="n">TrialLandSeaMask</span><span class="p">,</span><span class="w"> </span><span class="n">nultrl</span><span class="p">,</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="w"> </span><span class="n">inj</span><span class="p">,</span><span class="w"> </span><span class="n">ink</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1206</span><span class="w">                    </span><span class="n">idateo</span><span class="w"> </span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">ip2</span><span class="p">,</span><span class="w"> </span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">cltypvar</span><span class="p">,</span><span class="w"> </span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1207</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1208</span><span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1209</span><span class="w">         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bMatrixHI: Unable to read trial field = &#39;</span><span class="p">,</span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1210</span><span class="w">         </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;BMatrixHI : fstlir failed&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1211</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1212</span>
<span class="linenos">1213</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ini</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">ni_trial</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">inj</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">nj_trial</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1214</span><span class="k">          write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1215</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bMatrixHI: Invalid dimensions for ...&#39;</span><span class="w"></span>
<span class="linenos">1216</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;nomvar      =&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1217</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;etiket      =&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">cletiket</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1218</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ip1         =&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="w"></span>
<span class="linenos">1219</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Found ni,nj =&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="w"> </span><span class="n">inj</span><span class="w"> </span>
<span class="linenos">1220</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Should be   =&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ni_trial</span><span class="p">,</span><span class="w"> </span><span class="n">nj_trial</span><span class="w"></span>
<span class="linenos">1221</span><span class="w">          </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bMatrixHI&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1222</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1223</span>
<span class="linenos">1224</span><span class="k">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;GL&#39;</span><span class="w"></span>
<span class="linenos">1225</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstlir</span><span class="p">(</span><span class="n">TrialSeaIceMask</span><span class="p">,</span><span class="w"> </span><span class="n">nultrl</span><span class="p">,</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="w"> </span><span class="n">inj</span><span class="p">,</span><span class="w"> </span><span class="n">ink</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1226</span><span class="w">                    </span><span class="n">idateo</span><span class="w"> </span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">ip2</span><span class="p">,</span><span class="w"> </span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">cltypvar</span><span class="p">,</span><span class="w"> </span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1227</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1228</span><span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1229</span><span class="w">         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bMatrixHI: Unable to read trial field = &#39;</span><span class="p">,</span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1230</span><span class="w">         </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;BMatrixHI : fstlir failed&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1231</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1232</span>
<span class="linenos">1233</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ini</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">ni_trial</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">inj</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">nj_trial</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1234</span><span class="k">          write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1235</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bMatrixHI: Invalid dimensions for ...&#39;</span><span class="w"></span>
<span class="linenos">1236</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;nomvar      =&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1237</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;etiket      =&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">cletiket</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1238</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ip1         =&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="w"></span>
<span class="linenos">1239</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Found ni,nj =&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="w"> </span><span class="n">inj</span><span class="w"> </span>
<span class="linenos">1240</span><span class="w">          </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Should be   =&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ni_trial</span><span class="p">,</span><span class="w"> </span><span class="n">nj_trial</span><span class="w"></span>
<span class="linenos">1241</span><span class="w">          </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bMatrixHI&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1242</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1243</span>
<span class="linenos">1244</span><span class="k">      </span><span class="n">TrialGridID</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ezqkdef</span><span class="p">(</span><span class="w"> </span><span class="n">ni_trial</span><span class="p">,</span><span class="w"> </span><span class="n">nj_trial</span><span class="p">,</span><span class="w"> </span><span class="n">clgrtyp</span><span class="p">,</span><span class="w"> </span><span class="n">ig1</span><span class="p">,</span><span class="w"> </span><span class="n">ig2</span><span class="p">,</span><span class="w"> </span><span class="n">ig3</span><span class="p">,</span><span class="w"> </span><span class="n">ig4</span><span class="p">,</span><span class="w"> </span><span class="n">nultrl</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="c">! IN</span>
<span class="linenos">1245</span><span class="w"> </span>
<span class="linenos">1246</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstfrm</span><span class="p">(</span><span class="n">nultrl</span><span class="p">)</span><span class="w">  </span>
<span class="linenos">1247</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fclos</span><span class="p">(</span><span class="n">nultrl</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1248</span>
<span class="linenos">1249</span><span class="w">      </span><span class="c">!- Interpolate to the Analysis Grid</span>
<span class="linenos">1250</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">AnalLandSeaMask</span><span class="p">(</span><span class="n">ni_l</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1251</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">AnalSeaIceMask</span><span class="p">(</span><span class="n">ni_l</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1252</span>
<span class="linenos">1253</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ezdefset</span><span class="p">(</span><span class="n">AnalGridID</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="n">TrialGridID</span><span class="w">     </span><span class="p">)</span><span class="w"> </span><span class="c">! IN,  IN</span>
<span class="linenos">1254</span>
<span class="linenos">1255</span><span class="w">      </span><span class="c">! Nearest-neighbor interpolation</span>
<span class="linenos">1256</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">int_hInterpScalar</span><span class="p">(</span><span class="n">AnalLandSeaMask</span><span class="p">,</span><span class="w"> </span><span class="n">TrialLandSeaMask</span><span class="p">,</span><span class="w"> </span><span class="n">interpDegree</span><span class="o">=</span><span class="s1">&#39;NEAREST&#39;</span><span class="p">)</span><span class="w"> </span><span class="c">! OUT, IN</span>
<span class="linenos">1257</span><span class="w">      </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">int_hInterpScalar</span><span class="p">(</span><span class="n">AnalSeaIceMask</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">TrialSeaIceMask</span><span class="p">,</span><span class="w">  </span><span class="n">interpDegree</span><span class="o">=</span><span class="s1">&#39;NEAREST&#39;</span><span class="p">)</span><span class="w"> </span><span class="c">! OUT, IN</span>
<span class="linenos">1258</span>
<span class="linenos">1259</span><span class="w">      </span><span class="k">deallocate</span><span class="p">(</span><span class="n">TrialLandSeaMask</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1260</span><span class="w">      </span><span class="k">deallocate</span><span class="p">(</span><span class="n">TrialSeaIceMask</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1261</span>
<span class="linenos">1262</span><span class="w">      </span><span class="c">!- Modify the input/regridded TG Std. Dev.</span>
<span class="linenos">1263</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1264</span><span class="w">         </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">ni_l</span><span class="w"></span>
<span class="linenos">1265</span>
<span class="linenos">1266</span><span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">AnalLandSeaMask</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1267</span><span class="w">             </span><span class="c">! We take this as a land point.</span>
<span class="linenos">1268</span><span class="w">             </span><span class="c">! Force std. dev. to capping value</span>
<span class="linenos">1269</span><span class="w">             </span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlimsuptg</span><span class="w"></span>
<span class="linenos">1270</span><span class="w">           </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">AnalSeaIceMask</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1271</span><span class="w">             </span><span class="c">! We have significant sea ice on this sea point.</span>
<span class="linenos">1272</span><span class="w">             </span><span class="c">! Force std. dev. to capping value</span>
<span class="linenos">1273</span><span class="w">             </span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rlimsuptg</span><span class="w"></span>
<span class="linenos">1274</span><span class="w">           </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1275</span><span class="w">             </span><span class="c">! We have an open water point. Make sure that the std. dev. is realistic</span>
<span class="linenos">1276</span><span class="w">             </span><span class="c">! 1.55 is slightly above the max value over the ocean in the legacy TG Std. Dev. field (in 2014)</span>
<span class="linenos">1277</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.55d0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1278</span><span class="k">                </span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.9d0</span><span class="w"></span>
<span class="linenos">1279</span><span class="w">             </span><span class="k">end if</span>
<span class="linenos">1280</span><span class="k">           end if</span>
<span class="linenos">1281</span>
<span class="linenos">1282</span><span class="k">         end do</span>
<span class="linenos">1283</span><span class="k">      end do</span><span class="w"></span>
<span class="linenos">1284</span>
<span class="linenos">1285</span><span class="w">      </span><span class="c">!- Write the modified Std. Dev.</span>
<span class="linenos">1286</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1287</span><span class="k">        allocate</span><span class="p">(</span><span class="n">tgstdbg_tmp</span><span class="p">(</span><span class="n">ni_l</span><span class="p">,</span><span class="n">nj_l</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1288</span><span class="w">        </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1289</span><span class="w">          </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">ni_l</span><span class="w"></span>
<span class="linenos">1290</span><span class="w">             </span><span class="n">tgstdbg_tmp</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1291</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">1292</span><span class="k">        end do</span>
<span class="linenos">1293</span>
<span class="linenos">1294</span><span class="k">        </span><span class="n">iultg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1295</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fnom</span><span class="p">(</span><span class="n">iultg</span><span class="p">,</span><span class="s1">&#39;tg_stddev_of_the_day.fst&#39;</span><span class="p">,</span><span class="s1">&#39;RND&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1296</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstouv</span><span class="p">(</span><span class="n">iultg</span><span class="p">,</span><span class="s1">&#39;RND&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1297</span>
<span class="linenos">1298</span><span class="w">        </span><span class="n">ini</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ni_l</span><span class="w"></span>
<span class="linenos">1299</span><span class="w">        </span><span class="n">inj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1300</span><span class="w">        </span><span class="n">ink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1301</span><span class="w">        </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1302</span><span class="w">        </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1303</span><span class="w">        </span><span class="n">ip3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1304</span><span class="w">        </span><span class="n">idateo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1305</span><span class="w">        </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;E&#39;</span><span class="w"></span>
<span class="linenos">1306</span><span class="w">        </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;TG&#39;</span><span class="w"></span>
<span class="linenos">1307</span><span class="w">        </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;TWEAK_STDDEV&#39;</span><span class="w"></span>
<span class="linenos">1308</span><span class="w">        </span><span class="n">clgrtyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;G&#39;</span><span class="w"></span>
<span class="linenos">1309</span><span class="w">        </span><span class="n">ig1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1310</span><span class="w">        </span><span class="n">ig2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1311</span><span class="w">        </span><span class="n">ig3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1312</span><span class="w">        </span><span class="n">ig4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1313</span><span class="w">        </span><span class="n">idatyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1314</span>
<span class="linenos">1315</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstecr</span><span class="p">(</span><span class="n">tgstdbg_tmp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">iultg</span><span class="p">,</span><span class="w"> </span><span class="n">idateo</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1316</span><span class="w">                       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="w"> </span><span class="n">inj</span><span class="p">,</span><span class="w"> </span><span class="n">ink</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">ip2</span><span class="p">,</span><span class="w"> </span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">cltypvar</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1317</span><span class="w">                       </span><span class="n">clnomvar</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">clgrtyp</span><span class="p">,</span><span class="n">ig1</span><span class="p">,</span><span class="w"> </span><span class="n">ig2</span><span class="p">,</span><span class="w"> </span><span class="n">ig3</span><span class="p">,</span><span class="w"> </span><span class="n">ig4</span><span class="p">,</span><span class="w"> </span><span class="n">idatyp</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1318</span><span class="w">                       </span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">1319</span>
<span class="linenos">1320</span><span class="w">        </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1321</span><span class="w">          </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">ni_l</span><span class="w"></span>
<span class="linenos">1322</span><span class="w">             </span><span class="n">tgstdbg_tmp</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AnalLandSeaMask</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1323</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">1324</span><span class="k">        end do</span>
<span class="linenos">1325</span><span class="k">        </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;P&#39;</span><span class="w"></span>
<span class="linenos">1326</span><span class="w">        </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;MG&#39;</span><span class="w"></span>
<span class="linenos">1327</span><span class="w">        </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;TRIAL2ANAL&#39;</span><span class="w"></span>
<span class="linenos">1328</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstecr</span><span class="p">(</span><span class="n">tgstdbg_tmp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">iultg</span><span class="p">,</span><span class="w"> </span><span class="n">idateo</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1329</span><span class="w">                       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="w"> </span><span class="n">inj</span><span class="p">,</span><span class="w"> </span><span class="n">ink</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">ip2</span><span class="p">,</span><span class="w"> </span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">cltypvar</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1330</span><span class="w">                       </span><span class="n">clnomvar</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">clgrtyp</span><span class="p">,</span><span class="n">ig1</span><span class="p">,</span><span class="w"> </span><span class="n">ig2</span><span class="p">,</span><span class="w"> </span><span class="n">ig3</span><span class="p">,</span><span class="w"> </span><span class="n">ig4</span><span class="p">,</span><span class="w"> </span><span class="n">idatyp</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1331</span><span class="w">                       </span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">1332</span>
<span class="linenos">1333</span><span class="w">        </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1334</span><span class="w">          </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">ni_l</span><span class="w"></span>
<span class="linenos">1335</span><span class="w">             </span><span class="n">tgstdbg_tmp</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AnalSeaIceMask</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1336</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">1337</span><span class="k">        end do       </span>
<span class="linenos">1338</span><span class="k">        </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;P&#39;</span><span class="w"></span>
<span class="linenos">1339</span><span class="w">        </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;GL&#39;</span><span class="w"></span>
<span class="linenos">1340</span><span class="w">        </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;TRIAL2ANAL&#39;</span><span class="w"></span>
<span class="linenos">1341</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstecr</span><span class="p">(</span><span class="n">tgstdbg_tmp</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">iultg</span><span class="p">,</span><span class="w"> </span><span class="n">idateo</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1342</span><span class="w">                       </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="w"> </span><span class="n">inj</span><span class="p">,</span><span class="w"> </span><span class="n">ink</span><span class="p">,</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="w"> </span><span class="n">ip2</span><span class="p">,</span><span class="w"> </span><span class="n">ip3</span><span class="p">,</span><span class="w"> </span><span class="n">cltypvar</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1343</span><span class="w">                       </span><span class="n">clnomvar</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">clgrtyp</span><span class="p">,</span><span class="n">ig1</span><span class="p">,</span><span class="w"> </span><span class="n">ig2</span><span class="p">,</span><span class="w"> </span><span class="n">ig3</span><span class="p">,</span><span class="w"> </span><span class="n">ig4</span><span class="p">,</span><span class="w"> </span><span class="n">idatyp</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1344</span><span class="w">                       </span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">1345</span>
<span class="linenos">1346</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstfrm</span><span class="p">(</span><span class="n">iultg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1347</span><span class="w">        </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fclos</span><span class="p">(</span><span class="n">iultg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1348</span>
<span class="linenos">1349</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">tgstdbg_tmp</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1350</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1351</span>
<span class="linenos">1352</span><span class="k">      deallocate</span><span class="p">(</span><span class="n">AnalLandSeaMask</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1353</span><span class="w">      </span><span class="k">deallocate</span><span class="p">(</span><span class="n">AnalSeaIceMask</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1354</span>
<span class="linenos">1355</span><span class="w">    </span><span class="k">end if</span><span class="w"> </span><span class="c">! if ( TweakTG )</span>
<span class="linenos">1356</span>
<span class="linenos">1357</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1358</span><span class="w">    </span><span class="c">!- 2. Compute correlations in spectral space (CORNS)</span>
<span class="linenos">1359</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1360</span><span class="w">    </span><span class="n">zgd</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1361</span><span class="w">    </span><span class="n">zsp_mpilocal</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1362</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">my_zsp_mpiglobal</span><span class="p">(</span><span class="n">nla_mpiglobal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span>
<span class="linenos">1363</span><span class="w">    </span><span class="n">my_zsp_mpiglobal</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1364</span>
<span class="linenos">1365</span><span class="w">    </span><span class="k">do </span><span class="n">jla</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nla_mpiglobal</span><span class="w"></span>
<span class="linenos">1366</span><span class="w">       </span><span class="n">cortgg</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1367</span><span class="w">       </span><span class="n">cortgg</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1368</span><span class="w">    </span><span class="k">enddo</span><span class="w"></span>
<span class="linenos">1369</span>
<span class="linenos">1370</span><span class="w">    </span><span class="c">! 2.4.2  Compute correlations in physical space</span>
<span class="linenos">1371</span><span class="w">    </span><span class="n">rcscltg_vec</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rcscltg</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1372</span><span class="w">    </span><span class="k">call </span><span class="n">BHI_calccorr</span><span class="p">(</span><span class="n">zgd</span><span class="p">,</span><span class="n">rcscltg_vec</span><span class="p">,</span><span class="n">nlev_T_even</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1373</span>
<span class="linenos">1374</span><span class="w">    </span><span class="c">! 2.4.3  Bring back the result in spectral space</span>
<span class="linenos">1375</span><span class="w">    </span><span class="k">call </span><span class="n">gst_setID</span><span class="p">(</span><span class="n">gstID2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1376</span><span class="w">    </span><span class="k">call </span><span class="n">gst_reespe</span><span class="p">(</span><span class="n">zsp_mpilocal</span><span class="p">,</span><span class="n">zgd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1377</span>
<span class="linenos">1378</span><span class="w">    </span><span class="c">! and make the result mpiglobal</span>
<span class="linenos">1379</span><span class="w">    </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mymEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mymSkip</span><span class="w"></span>
<span class="linenos">1380</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mynBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mynEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mynSkip</span><span class="w"></span>
<span class="linenos">1381</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1382</span><span class="k">          </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">1383</span><span class="w">          </span><span class="n">ila_mpilocal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1384</span><span class="w">          </span><span class="n">my_zsp_mpiglobal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp_mpilocal</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1385</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos">1386</span><span class="k">      enddo</span>
<span class="linenos">1387</span><span class="k">    enddo</span>
<span class="linenos">1388</span><span class="k">    </span><span class="n">nsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nla_mpiglobal</span><span class="w"></span>
<span class="linenos">1389</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_allreduce</span><span class="p">(</span><span class="n">my_zsp_mpiglobal</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">zsp_mpiglobal</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">),</span><span class="n">nsize</span><span class="p">,</span><span class="s2">&quot;mpi_double_precision&quot;</span><span class="p">,</span><span class="s2">&quot;mpi_sum&quot;</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1390</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">my_zsp_mpiglobal</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">1391</span><span class="w">    </span><span class="c">! 2.4.4  Check positiveness</span>
<span class="linenos">1392</span><span class="w">    </span><span class="n">llpb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1393</span><span class="w">    </span><span class="k">do </span><span class="n">jla</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1394</span><span class="w">      </span><span class="nb">zabs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1395</span><span class="w">      </span><span class="n">llpb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">llpb</span><span class="p">.</span><span class="nb">or</span><span class="p">.((</span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="nb">zabs</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="nb">epsilon</span><span class="p">(</span><span class="nb">zabs</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">1396</span><span class="w">    </span><span class="k">enddo</span>
<span class="linenos">1397</span><span class="k">    if</span><span class="p">(</span><span class="n">llpb</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1398</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39; AUTOCORRELATION  NEGATIVES&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1399</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos">1400</span><span class="k">    do </span><span class="n">jla</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1401</span><span class="w">      </span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">abs</span><span class="p">(</span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1402</span><span class="w">    </span><span class="k">enddo</span>
<span class="linenos">1403</span>
<span class="linenos">1404</span><span class="k">    </span><span class="n">zpole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.d0</span><span class="w"></span>
<span class="linenos">1405</span><span class="w">    </span><span class="k">do  </span><span class="n">jla</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1406</span><span class="w">      </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jla</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1407</span><span class="w">      </span><span class="n">zpole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zpole</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">((</span><span class="mf">2.d0</span><span class="o">*</span><span class="n">jn</span><span class="o">+</span><span class="mf">1.d0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.d0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1408</span><span class="w">    </span><span class="k">enddo</span>
<span class="linenos">1409</span><span class="k">    if</span><span class="p">(</span><span class="n">zpole</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="mf">0.d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1410</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;POLE VALUE NEGATIVE IN SUTG&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1411</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos">1412</span><span class="k">    do </span><span class="n">jla</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1413</span><span class="w">      </span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">zpole</span><span class="w"></span>
<span class="linenos">1414</span><span class="w">      </span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">zpole</span><span class="w"></span>
<span class="linenos">1415</span><span class="w">    </span><span class="k">enddo</span><span class="w"></span>
<span class="linenos">1416</span>
<span class="linenos">1417</span><span class="w">    </span><span class="c">!  2.4.5  Correlation</span>
<span class="linenos">1418</span><span class="w">    </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1419</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jm</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1420</span><span class="w">        </span><span class="n">jla</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">1421</span><span class="w">        </span><span class="n">dlfac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5d0</span><span class="o">/</span><span class="nb">dsqrt</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">jn</span><span class="o">+</span><span class="mf">1.d0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.d0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1422</span><span class="w">        </span><span class="n">cortgg</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlfac</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1423</span><span class="w">        </span><span class="n">cortgg</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlfac</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">zsp_mpiglobal</span><span class="p">(</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1424</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">1425</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">1426</span>
<span class="linenos">1427</span><span class="w">    </span><span class="c">! 2.5. For zonal modes : set to zero the imaginary part and set the correct factor 1.0 for the real part</span>
<span class="linenos">1428</span><span class="w">    </span><span class="k">do </span><span class="n">jla</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1429</span><span class="w">      </span><span class="n">cortgg</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5d0</span><span class="o">*</span><span class="n">cortgg</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1430</span><span class="w">      </span><span class="n">cortgg</span><span class="p">(</span><span class="n">jla</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1431</span><span class="w">    </span><span class="k">enddo</span><span class="w"></span>
<span class="linenos">1432</span>
<span class="linenos">1433</span><span class="w">    </span><span class="c">! 2.6. Result in corns array</span>
<span class="linenos">1434</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1435</span><span class="w">      </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1436</span><span class="w">      </span><span class="n">corns</span><span class="p">(</span><span class="n">nspositTG</span><span class="p">,</span><span class="n">nspositTG</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.d0</span><span class="o">*</span><span class="n">cortgg</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1437</span><span class="w">    </span><span class="k">enddo</span>
<span class="linenos">1438</span>
<span class="linenos">1439</span><span class="k">    deallocate</span><span class="p">(</span><span class="n">dltg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1440</span><span class="w">    </span><span class="c">!write(*,*)&#39;DONE in SUTG&#39;</span>
<span class="linenos">1441</span>
<span class="linenos">1442</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">BHI_sutg</span><span class="w"></span>
<span class="linenos">1443</span>
<span class="linenos">1444</span>
<span class="linenos">1445</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_convol</span><span class="w"></span>
<span class="linenos">1446</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1447</span>
<span class="linenos">1448</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">dlfact2</span><span class="p">,</span><span class="n">dlc</span><span class="p">,</span><span class="n">dsummed</span><span class="w"></span>
<span class="linenos">1449</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">dtlen</span><span class="p">,</span><span class="n">zr</span><span class="p">,</span><span class="n">dlfact</span><span class="w"></span>
<span class="linenos">1450</span><span class="w">    </span><span class="kt">integer </span><span class="n">jn</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk</span><span class="w"></span>
<span class="linenos">1451</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">zsp</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">),</span><span class="n">zgr</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1452</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">dlwti</span><span class="p">(</span><span class="n">nj_l</span><span class="p">),</span><span class="n">zrmu</span><span class="p">(</span><span class="n">nj_l</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1453</span>
<span class="linenos">1454</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">         </span><span class="kd">::</span><span class="w"> </span><span class="n">RPORVO</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">600</span><span class="mf">0.D3</span><span class="w"></span>
<span class="linenos">1455</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">         </span><span class="kd">::</span><span class="w"> </span><span class="n">RPORDI</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">600</span><span class="mf">0.D3</span><span class="w"></span>
<span class="linenos">1456</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">         </span><span class="kd">::</span><span class="w"> </span><span class="n">RPORTT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="mf">0.D3</span><span class="w"></span>
<span class="linenos">1457</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">         </span><span class="kd">::</span><span class="w"> </span><span class="n">RPORQ</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="mf">0.D3</span><span class="w"></span>
<span class="linenos">1458</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">         </span><span class="kd">::</span><span class="w"> </span><span class="n">RPORPS</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">300</span><span class="mf">0.D3</span><span class="w"></span>
<span class="linenos">1459</span>
<span class="linenos">1460</span><span class="w">    </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1461</span><span class="w">       </span><span class="n">dlwti</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getrwt</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1462</span><span class="w">       </span><span class="n">zrmu</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getrmu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1463</span><span class="w">    </span><span class="k">end do</span><span class="w"></span>
<span class="linenos">1464</span>
<span class="linenos">1465</span><span class="c">!     1.2 CONVERT THE CORRELATIONS IN SPECTRAL SPACE INTO SPECTRAL</span>
<span class="linenos">1466</span><span class="c">!         COEFFICIENTS OF THE CORRELATION FUNCTION AND FUNCTION TO BE</span>
<span class="linenos">1467</span><span class="c">!         SELF-CONVOLVED</span>
<span class="linenos">1468</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1469</span><span class="w">      </span><span class="n">dlfact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mf">2.0d0</span><span class="o">*</span><span class="n">jn</span><span class="w"> </span><span class="o">+</span><span class="mf">1.0d0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0d0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.25d0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1470</span><span class="w">      </span><span class="n">dlfact2</span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mf">2.0d0</span><span class="o">*</span><span class="n">jn</span><span class="w"> </span><span class="o">+</span><span class="mf">1.0d0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0d0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.25d0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1471</span><span class="w">      </span><span class="k">do </span><span class="n">jk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1472</span><span class="w">        </span><span class="n">zsp</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">dlfact</span><span class="o">*</span><span class="n">dlfact2</span><span class="w"></span>
<span class="linenos">1473</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">1474</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">1475</span>
<span class="linenos">1476</span><span class="w">    </span><span class="c">! Transform to physical space</span>
<span class="linenos">1477</span><span class="w">    </span><span class="k">call </span><span class="n">gst_zleginv</span><span class="p">(</span><span class="n">gstID</span><span class="p">,</span><span class="n">zgr</span><span class="p">,</span><span class="n">zsp</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1478</span>
<span class="linenos">1479</span><span class="w">    </span><span class="c">! Truncate in horizontal extent with Gaussian window</span>
<span class="linenos">1480</span><span class="w">    </span><span class="k">do </span><span class="n">jk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1481</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jk</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">nspositVO</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">jk</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1482</span><span class="k">        </span><span class="n">dtlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rporvo</span><span class="w"></span>
<span class="linenos">1483</span><span class="w">      </span><span class="n">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">jk</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">nspositDI</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">jk</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1484</span><span class="k">        </span><span class="n">dtlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rpordi</span><span class="w"></span>
<span class="linenos">1485</span><span class="w">      </span><span class="n">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">jk</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">nspositTT</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">jk</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">nspositTT</span><span class="o">+</span><span class="n">nlev_T</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1486</span><span class="k">        </span><span class="n">dtlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rportt</span><span class="w"></span>
<span class="linenos">1487</span><span class="w">      </span><span class="n">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">jk</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">nspositQ</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">jk</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">nspositQ</span><span class="o">+</span><span class="n">nlev_T</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1488</span><span class="k">        </span><span class="n">dtlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rporq</span><span class="w"></span>
<span class="linenos">1489</span><span class="w">      </span><span class="n">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">jk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nspositPS</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1490</span><span class="k">        </span><span class="n">dtlen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rporps</span><span class="w"></span>
<span class="linenos">1491</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1492</span>
<span class="linenos">1493</span><span class="k">      if</span><span class="p">(</span><span class="n">dtlen</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1494</span><span class="k">        </span><span class="n">dlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.d0</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">dtlen</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1495</span><span class="w">        </span><span class="n">dlc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5d0</span><span class="o">*</span><span class="n">dlc</span><span class="o">*</span><span class="n">dlc</span><span class="w"></span>
<span class="linenos">1496</span><span class="w">        </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1497</span><span class="w">          </span><span class="n">zr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ec_ra</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">acos</span><span class="p">(</span><span class="n">zrmu</span><span class="p">(</span><span class="n">jlat</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1498</span><span class="w">          </span><span class="n">dlfact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">dexp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">zr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dlc</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1499</span><span class="w">          </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlfact</span><span class="o">*</span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1500</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">1501</span><span class="k">      endif</span><span class="w"></span>
<span class="linenos">1502</span>
<span class="linenos">1503</span><span class="w">      </span><span class="c">!write(*,*) &#39;zeroing length (km)=&#39;,jk,dtlen/1000.0</span>
<span class="linenos">1504</span><span class="w">    </span><span class="k">enddo</span><span class="w"></span>
<span class="linenos">1505</span>
<span class="linenos">1506</span><span class="w">    </span><span class="c">! Transform back to spectral space</span>
<span class="linenos">1507</span><span class="w">    </span><span class="k">call </span><span class="n">gst_zlegdir</span><span class="p">(</span><span class="n">gstID</span><span class="p">,</span><span class="n">zgr</span><span class="p">,</span><span class="n">zsp</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1508</span>
<span class="linenos">1509</span><span class="w">    </span><span class="c">! Convert back to correlations</span>
<span class="linenos">1510</span><span class="w">    </span><span class="k">do </span><span class="n">jk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1511</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1512</span><span class="w">         </span><span class="n">zsp</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0d0</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0d0</span><span class="o">*</span><span class="n">jn</span><span class="o">+</span><span class="mf">1.0d0</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">0.25d0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1513</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">1514</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">1515</span>
<span class="linenos">1516</span><span class="w">    </span><span class="c">! PUT BACK INTO RSTDDEV</span>
<span class="linenos">1517</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1518</span><span class="w">      </span><span class="k">do </span><span class="n">jk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1519</span><span class="w">         </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1520</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">1521</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">1522</span><span class="w"> </span>
<span class="linenos">1523</span><span class="w">    </span><span class="c">! Re-normalize to ensure correlations</span>
<span class="linenos">1524</span><span class="w">    </span><span class="k">do </span><span class="n">jk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1525</span><span class="w">      </span><span class="n">dsummed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.d0</span><span class="w"></span>
<span class="linenos">1526</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1527</span><span class="w">        </span><span class="n">dsummed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dsummed</span><span class="o">+</span><span class="w"> </span><span class="nb">dble</span><span class="p">(</span><span class="n">rstddev</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(((</span><span class="mf">2.d0</span><span class="o">*</span><span class="n">jn</span><span class="p">)</span><span class="o">+</span><span class="mf">1.d0</span><span class="p">)</span><span class="o">/</span><span class="mf">2.d0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1528</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">1529</span><span class="k">      </span><span class="n">dsummed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">dsummed</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1530</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1531</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">dsummed</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">1.d-30</span><span class="p">)</span><span class="w"> </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">/</span><span class="n">dsummed</span><span class="w"></span>
<span class="linenos">1532</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">1533</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">1534</span>
<span class="linenos">1535</span><span class="w">    </span><span class="c">!     CONVERT THE SPECTRAL COEFFICIENTS OF THE CORRELATION FUNCTION</span>
<span class="linenos">1536</span><span class="w">    </span><span class="c">!     .  BACK INTO CORRELATIONS OF SPECTRAL COMPONENTS</span>
<span class="linenos">1537</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1538</span><span class="w">      </span><span class="n">dlfact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">0.5d0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0d0</span><span class="o">/</span><span class="p">((</span><span class="mf">2.0d0</span><span class="o">*</span><span class="n">jn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0d0</span><span class="p">))</span><span class="o">**</span><span class="mf">0.25d0</span><span class="w"></span>
<span class="linenos">1539</span><span class="w">      </span><span class="k">do </span><span class="n">jk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1540</span><span class="w">        </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="n">dlfact</span><span class="w"></span>
<span class="linenos">1541</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">1542</span><span class="k">    enddo</span>
<span class="linenos">1543</span>
<span class="linenos">1544</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_convol</span><span class="w"></span>
<span class="linenos">1545</span>
<span class="linenos">1546</span>
<span class="linenos">1547</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_setCrossCorr</span><span class="p">(</span><span class="n">kn</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1548</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1549</span>
<span class="linenos">1550</span><span class="k">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kn</span><span class="p">,</span><span class="w"> </span><span class="n">jblock1</span><span class="p">,</span><span class="w"> </span><span class="n">inbrblock</span><span class="p">,</span><span class="w"> </span><span class="n">jblock2</span><span class="w"></span>
<span class="linenos">1551</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jk1</span><span class="p">,</span><span class="w"> </span><span class="n">jk2</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_all</span><span class="p">(</span><span class="n">numvar3d</span><span class="p">),</span><span class="w"> </span><span class="n">levOffset</span><span class="p">(</span><span class="n">numvar3d</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1552</span>
<span class="linenos">1553</span><span class="w">    </span><span class="n">inbrblock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numvar3d</span><span class="w"></span>
<span class="linenos">1554</span><span class="w">    </span><span class="n">nlev_all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLev_M</span><span class="w"></span>
<span class="linenos">1555</span><span class="w">    </span><span class="n">nlev_all</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLev_M</span><span class="w"></span>
<span class="linenos">1556</span><span class="w">    </span><span class="n">nlev_all</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLev_T</span><span class="w"></span>
<span class="linenos">1557</span><span class="w">    </span><span class="n">nlev_all</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nLev_T</span><span class="w"></span>
<span class="linenos">1558</span><span class="w">    </span><span class="n">levOffset</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1559</span><span class="w">    </span><span class="n">levOffset</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="n">nLev_M</span><span class="w"></span>
<span class="linenos">1560</span><span class="w">    </span><span class="n">levOffset</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_M</span><span class="w"></span>
<span class="linenos">1561</span><span class="w">    </span><span class="n">levOffset</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_M</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="n">nLev_T</span><span class="w"></span>
<span class="linenos">1562</span><span class="w">    </span><span class="n">levOffset</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_M</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nLev_T</span><span class="w"></span>
<span class="linenos">1563</span>
<span class="linenos">1564</span><span class="w">    </span><span class="c">! Set cross-variable correlations to 0 ...</span>
<span class="linenos">1565</span><span class="w">    </span><span class="k">do </span><span class="n">jblock1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inbrblock</span><span class="w"></span>
<span class="linenos">1566</span><span class="w">      </span><span class="k">do </span><span class="n">jblock2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inbrblock</span><span class="w"></span>
<span class="linenos">1567</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jblock1</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">jblock2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1568</span><span class="k">          do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_all</span><span class="p">(</span><span class="n">jblock2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1569</span><span class="w">            </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_all</span><span class="p">(</span><span class="n">jblock1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1570</span><span class="w">              </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">levOffset</span><span class="p">(</span><span class="n">jblock1</span><span class="p">),</span><span class="n">jk2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">levOffset</span><span class="p">(</span><span class="n">jblock2</span><span class="p">),</span><span class="n">kn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1571</span><span class="w">            </span><span class="k">enddo</span>
<span class="linenos">1572</span><span class="k">          enddo</span>
<span class="linenos">1573</span><span class="k">        endif</span>
<span class="linenos">1574</span><span class="k">      enddo</span>
<span class="linenos">1575</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">1576</span>
<span class="linenos">1577</span><span class="w">    </span><span class="c">! ... but T&#39;ln(ps&#39;) correlations</span>
<span class="linenos">1578</span><span class="w">    </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1579</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levOffset</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">levOffset</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">numvar2d</span><span class="w"></span>
<span class="linenos">1580</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">jk1</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">nspositPS</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">jk2</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">nspositTT</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1581</span><span class="w">             </span><span class="n">jk2</span><span class="p">.</span><span class="n">ge</span><span class="p">.(</span><span class="n">nspositTT</span><span class="o">+</span><span class="n">nlev_T</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">jk1</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">jk2</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1582</span><span class="k">          </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">kn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1583</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos">1584</span><span class="k">      enddo</span>
<span class="linenos">1585</span><span class="k">    enddo</span>
<span class="linenos">1586</span>
<span class="linenos">1587</span><span class="k">    do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levOffset</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">levOffset</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">numvar2d</span><span class="w"></span>
<span class="linenos">1588</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1589</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">jk2</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">nspositPS</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">jk1</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">nspositTT</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1590</span><span class="w">             </span><span class="n">jk1</span><span class="p">.</span><span class="n">ge</span><span class="p">.(</span><span class="n">nspositTT</span><span class="o">+</span><span class="n">nlev_T</span><span class="p">))</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.(</span><span class="n">jk1</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">jk2</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1591</span><span class="k">          </span><span class="n">corns</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">kn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1592</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos">1593</span><span class="k">      enddo</span>
<span class="linenos">1594</span><span class="k">    enddo</span>
<span class="linenos">1595</span>
<span class="linenos">1596</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_setCrossCorr</span><span class="w"></span>
<span class="linenos">1597</span>
<span class="linenos">1598</span>
<span class="linenos">1599</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_READCORNS2</span><span class="w"></span>
<span class="linenos">1600</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1601</span>
<span class="linenos">1602</span><span class="k">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kip1</span><span class="w"></span>
<span class="linenos">1603</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">istdkey</span><span class="p">,</span><span class="n">icornskey</span><span class="w"></span>
<span class="linenos">1604</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iksdim</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="n">jrow</span><span class="w"></span>
<span class="linenos">1605</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(:)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zstdsrc</span><span class="w"></span>
<span class="linenos">1606</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(:,:)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zcornssrc</span><span class="w"></span>
<span class="linenos">1607</span>
<span class="linenos">1608</span><span class="w">    </span><span class="c">! standard file variables</span>
<span class="linenos">1609</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="w"></span>
<span class="linenos">1610</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="w"></span>
<span class="linenos">1611</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">idateo</span><span class="w"></span>
<span class="linenos">1612</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cltypvar</span><span class="w"></span>
<span class="linenos">1613</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1614</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cletiket</span><span class="w"></span>
<span class="linenos">1615</span>
<span class="linenos">1616</span><span class="w">    </span><span class="n">iksdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_M</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="w">    </span><span class="c">! assume 4 3d variables and 1 2d variable (TG not included)</span>
<span class="linenos">1617</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">zcornssrc</span><span class="p">(</span><span class="n">iksdim</span><span class="p">,</span><span class="n">iksdim</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1618</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">zstdsrc</span><span class="p">(</span><span class="n">iksdim</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1619</span>
<span class="linenos">1620</span><span class="w">    </span><span class="n">kip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1621</span>
<span class="linenos">1622</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1623</span>
<span class="linenos">1624</span><span class="w">      </span><span class="c">! Looking for FST record parameters..</span>
<span class="linenos">1625</span>
<span class="linenos">1626</span><span class="w">      </span><span class="n">idateo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1627</span><span class="w">      </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;RSTDDEV&#39;</span><span class="w"></span>
<span class="linenos">1628</span><span class="w">      </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kip1</span><span class="w"></span>
<span class="linenos">1629</span><span class="w">      </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">1630</span><span class="w">      </span><span class="n">ip3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1631</span><span class="w">      </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;X&#39;</span><span class="w"></span>
<span class="linenos">1632</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;SS&#39;</span><span class="w"></span>
<span class="linenos">1633</span>
<span class="linenos">1634</span><span class="w">      </span><span class="n">istdkey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">ZSTDSRC</span><span class="p">,</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">INI</span><span class="p">,</span><span class="n">INJ</span><span class="p">,</span><span class="n">INK</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1635</span>
<span class="linenos">1636</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">istdkey</span><span class="w"> </span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1637</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;READCORNS2: Problem with background stat file&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1638</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1639</span>
<span class="linenos">1640</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ini</span><span class="w"> </span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="w"> </span><span class="n">iksdim</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1641</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;READCORNS2: BG stat levels inconsitencies&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1642</span><span class="w">      </span><span class="k">endif</span><span class="w"></span>
<span class="linenos">1643</span>
<span class="linenos">1644</span><span class="w">      </span><span class="c">! Looking for FST record parameters..</span>
<span class="linenos">1645</span>
<span class="linenos">1646</span><span class="w">      </span><span class="n">idateo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1647</span><span class="w">      </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CORRNS&#39;</span><span class="w"></span>
<span class="linenos">1648</span><span class="w">      </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kip1</span><span class="w"></span>
<span class="linenos">1649</span><span class="w">      </span><span class="n">IP2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JN</span><span class="w"></span>
<span class="linenos">1650</span><span class="w">      </span><span class="n">ip3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1651</span><span class="w">      </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;X&#39;</span><span class="w"></span>
<span class="linenos">1652</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ZZ&#39;</span><span class="w"></span>
<span class="linenos">1653</span><span class="w">      </span><span class="n">icornskey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">ZCORNSSRC</span><span class="p">,</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">INI</span><span class="p">,</span><span class="n">INJ</span><span class="p">,</span><span class="n">INK</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1654</span>
<span class="linenos">1655</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">icornskey</span><span class="w"> </span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1656</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;READCORNS2: Problem with background stat file&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1657</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1658</span>
<span class="linenos">1659</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ini</span><span class="w"> </span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="w"> </span><span class="n">iksdim</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">inj</span><span class="w"> </span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="w"> </span><span class="n">iksdim</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1660</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;READCORNS2: BG stat levels inconsitencies&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1661</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1662</span>
<span class="linenos">1663</span><span class="k">      do </span><span class="n">jcol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos">1664</span><span class="w">        </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jcol</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1665</span><span class="w">        </span><span class="k">do </span><span class="n">jrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim2</span><span class="w"></span>
<span class="linenos">1666</span><span class="w">          </span><span class="n">corns</span><span class="p">(</span><span class="n">jrow</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1667</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">1668</span><span class="k">      enddo</span>
<span class="linenos">1669</span>
<span class="linenos">1670</span><span class="k">      do </span><span class="n">jcol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">iksdim</span><span class="w"></span>
<span class="linenos">1671</span><span class="w">        </span><span class="k">do </span><span class="n">jrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">iksdim</span><span class="w"></span>
<span class="linenos">1672</span><span class="w">          </span><span class="n">corns</span><span class="p">(</span><span class="n">jrow</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcornssrc</span><span class="p">(</span><span class="n">jrow</span><span class="p">,</span><span class="n">jcol</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1673</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">1674</span><span class="k">      enddo</span><span class="w"></span>
<span class="linenos">1675</span>
<span class="linenos">1676</span><span class="w">      </span><span class="c">! Set cross-variable correlations to zero except between T&#39; and ln(ps&#39;)</span>
<span class="linenos">1677</span><span class="w">      </span><span class="k">call </span><span class="n">BHI_setcrosscorr</span><span class="p">(</span><span class="n">jn</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1678</span>
<span class="linenos">1679</span><span class="w">      </span><span class="k">do </span><span class="n">jrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">iksdim</span><span class="w"></span>
<span class="linenos">1680</span><span class="w">        </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jrow</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zstdsrc</span><span class="p">(</span><span class="n">jrow</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1681</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">1682</span>
<span class="linenos">1683</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">1684</span>
<span class="linenos">1685</span><span class="w">    </span><span class="c">! Apply convolution to RSTDDEV correlations</span>
<span class="linenos">1686</span>
<span class="linenos">1687</span><span class="w">    </span><span class="k">call </span><span class="n">BHI_convol</span><span class="w"> </span>
<span class="linenos">1688</span>
<span class="linenos">1689</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1690</span>
<span class="linenos">1691</span><span class="w">      </span><span class="c">! Re-build of correlation matrix: factorization of corns with convoluted RSTDDEV</span>
<span class="linenos">1692</span><span class="w">      </span><span class="k">do </span><span class="n">jcol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1693</span><span class="w">        </span><span class="k">do </span><span class="n">jrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">1694</span><span class="w">          </span><span class="n">corns</span><span class="p">(</span><span class="n">jrow</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jrow</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">corns</span><span class="p">(</span><span class="n">jrow</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="n">rstddev</span><span class="p">(</span><span class="n">jcol</span><span class="p">,</span><span class="n">jn</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1695</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">1696</span><span class="k">      enddo</span>
<span class="linenos">1697</span>
<span class="linenos">1698</span><span class="k">    enddo</span>
<span class="linenos">1699</span>
<span class="linenos">1700</span><span class="k">    deallocate</span><span class="p">(</span><span class="n">zcornssrc</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1701</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">zstdsrc</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1702</span>
<span class="linenos">1703</span><span class="w">    </span><span class="c">!write(*,*) &#39;Done in READCORNS2&#39;</span>
<span class="linenos">1704</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">BHI_READCORNS2</span><span class="w"></span>
<span class="linenos">1705</span>
<span class="linenos">1706</span>
<span class="linenos">1707</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_RDSPSTD</span><span class="w"></span>
<span class="linenos">1708</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1709</span>
<span class="linenos">1710</span><span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">inbrvar3d</span><span class="o">=</span><span class="mi">5</span><span class="w"></span>
<span class="linenos">1711</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">inbrvar2d</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1712</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jvar</span><span class="p">,</span><span class="n">jn</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="w"></span>
<span class="linenos">1713</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ikey</span><span class="p">,</span><span class="w"> </span><span class="n">jlevo</span><span class="p">,</span><span class="w"> </span><span class="n">jlat</span><span class="p">,</span><span class="n">firstn</span><span class="p">,</span><span class="n">lastn</span><span class="w"></span>
<span class="linenos">1714</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zsp</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">)),</span><span class="n">zspbuf</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1715</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1716</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varName3d</span><span class="p">(</span><span class="n">inbrvar3d</span><span class="p">),</span><span class="n">varName2d</span><span class="p">(</span><span class="n">inbrvar2d</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1717</span>
<span class="linenos">1718</span><span class="w">    </span><span class="c">! standard file variables</span>
<span class="linenos">1719</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="w"></span>
<span class="linenos">1720</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="w"></span>
<span class="linenos">1721</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">idate</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="n">nlev_MT</span><span class="w"></span>
<span class="linenos">1722</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cltypvar</span><span class="w"></span>
<span class="linenos">1723</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1724</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cletiket</span><span class="w"></span>
<span class="linenos">1725</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fstinf</span><span class="w"></span>
<span class="linenos">1726</span>
<span class="linenos">1727</span><span class="w">    </span><span class="k">data </span><span class="n">varName3d</span><span class="o">/</span><span class="s1">&#39;PP  &#39;</span><span class="p">,</span><span class="s1">&#39;UC  &#39;</span><span class="p">,</span><span class="s1">&#39;UT  &#39;</span><span class="p">,</span><span class="s1">&#39;LQ  &#39;</span><span class="p">,</span><span class="s1">&#39;TB  &#39;</span><span class="o">/</span><span class="w"></span>
<span class="linenos">1728</span><span class="w">    </span><span class="k">data </span><span class="n">varName2d</span><span class="o">/</span><span class="s1">&#39;UP  &#39;</span><span class="p">,</span><span class="s1">&#39;PB  &#39;</span><span class="o">/</span><span class="w"></span>
<span class="linenos">1729</span>
<span class="linenos">1730</span><span class="w">    </span><span class="n">rgsig</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1731</span><span class="w">    </span><span class="n">rgsigtb</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1732</span><span class="w">    </span><span class="n">rgsigpsb</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1733</span>
<span class="linenos">1734</span><span class="c">!   2. Reading the data</span>
<span class="linenos">1735</span>
<span class="linenos">1736</span><span class="w">    </span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1737</span><span class="w">    </span><span class="n">ip1</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1738</span><span class="w">    </span><span class="n">ip2</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1739</span><span class="w">    </span><span class="n">ip3</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1740</span>
<span class="linenos">1741</span><span class="w">    </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;SPSTDDEV&#39;</span><span class="w"></span>
<span class="linenos">1742</span><span class="w">    </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;X&#39;</span><span class="w"></span>
<span class="linenos">1743</span>
<span class="linenos">1744</span><span class="w">    </span><span class="k">do </span><span class="n">jvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inbrvar3d</span><span class="w"></span>
<span class="linenos">1745</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varName3d</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1746</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">vnl_varLevelFromVarName</span><span class="p">(</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;MM&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1747</span><span class="k">        </span><span class="n">nlev_MT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">1748</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">1749</span><span class="k">        </span><span class="n">nlev_MT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">1750</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1751</span><span class="k">      </span><span class="n">firstn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1752</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1753</span><span class="w">        </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">1754</span><span class="w">        </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1755</span>
<span class="linenos">1756</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">ikey</span><span class="w"> </span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1757</span><span class="k">          </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">zspbuf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1758</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">1759</span><span class="k">          if</span><span class="p">(</span><span class="n">firstn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">firstn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">1760</span><span class="w">          </span><span class="n">lastn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">1761</span><span class="w">          </span><span class="n">zspbuf</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1762</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos">1763</span>
<span class="linenos">1764</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">ini</span><span class="w"> </span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="w"> </span><span class="n">nlev_MT</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1765</span><span class="k">          call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;RDSPSTD: BG stat levels inconsitencies&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1766</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos">1767</span>
<span class="linenos">1768</span><span class="k">        do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_MT</span><span class="w"></span>
<span class="linenos">1769</span><span class="w">          </span><span class="n">zsp</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zspbuf</span><span class="p">(</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1770</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">1771</span><span class="k">      enddo</span>
<span class="linenos">1772</span><span class="k">      if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.</span><span class="nb">and</span><span class="p">.</span><span class="n">firstn</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1773</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;WARNING: CANNOT FIND SPSTD FOR &#39;</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1774</span><span class="w">                     </span><span class="s1">&#39; AT N BETWEEN &#39;</span><span class="p">,</span><span class="n">firstn</span><span class="p">,</span><span class="s1">&#39; AND &#39;</span><span class="p">,</span><span class="n">lastn</span><span class="p">,</span><span class="s1">&#39;, SETTING TO ZERO!!!&#39;</span><span class="w"></span>
<span class="linenos">1775</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1776</span>
<span class="linenos">1777</span><span class="k">      call </span><span class="n">gst_zleginv</span><span class="p">(</span><span class="n">gstID</span><span class="p">,</span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">zsp</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">nlev_MT</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1778</span>
<span class="linenos">1779</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;PP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1780</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1781</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">1782</span><span class="w">            </span><span class="n">rgsiguu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1783</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">1784</span><span class="k">        enddo</span>
<span class="linenos">1785</span><span class="k">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UC&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;CC&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1786</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1787</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">1788</span><span class="w">            </span><span class="n">rgsigvv</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1789</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">1790</span><span class="k">        enddo</span>
<span class="linenos">1791</span><span class="k">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UT&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1792</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1793</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">1794</span><span class="w">            </span><span class="n">rgsigtt</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1795</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">1796</span><span class="k">        enddo</span>
<span class="linenos">1797</span><span class="k">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TB&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1798</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1799</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">1800</span><span class="w">            </span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1801</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">1802</span><span class="k">        enddo</span>
<span class="linenos">1803</span><span class="k">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;LQ&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1804</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1805</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">1806</span><span class="w">            </span><span class="n">rgsigq</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1807</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">1808</span><span class="k">        enddo</span>
<span class="linenos">1809</span><span class="k">      endif</span>
<span class="linenos">1810</span>
<span class="linenos">1811</span><span class="k">    enddo</span>
<span class="linenos">1812</span>
<span class="linenos">1813</span><span class="k">    </span><span class="n">nlev_MT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1814</span><span class="w">    </span><span class="k">do </span><span class="n">jvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inbrvar2d</span><span class="w"></span>
<span class="linenos">1815</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varName2d</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1816</span><span class="w">      </span><span class="n">firstn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1817</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">1818</span><span class="w">        </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">1819</span><span class="w">        </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1820</span>
<span class="linenos">1821</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">ikey</span><span class="w"> </span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1822</span><span class="k">          </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">zspbuf</span><span class="p">,</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1823</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">1824</span><span class="k">          if</span><span class="p">(</span><span class="n">firstn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">firstn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">1825</span><span class="w">          </span><span class="n">lastn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">1826</span><span class="w">          </span><span class="n">zspbuf</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1827</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos">1828</span>
<span class="linenos">1829</span><span class="k">        </span><span class="n">zsp</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zspbuf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1830</span>
<span class="linenos">1831</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">1832</span><span class="k">      if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.</span><span class="nb">and</span><span class="p">.</span><span class="n">firstn</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1833</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;WARNING: CANNOT FIND SPSTD FOR &#39;</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1834</span><span class="w">                     </span><span class="s1">&#39; AT N BETWEEN &#39;</span><span class="p">,</span><span class="n">firstn</span><span class="p">,</span><span class="s1">&#39; AND &#39;</span><span class="p">,</span><span class="n">lastn</span><span class="p">,</span><span class="s1">&#39;, SETTING TO ZERO!!!&#39;</span><span class="w"></span>
<span class="linenos">1835</span>
<span class="linenos">1836</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1837</span>
<span class="linenos">1838</span><span class="k">      call </span><span class="n">gst_zleginv</span><span class="p">(</span><span class="n">gstID</span><span class="p">,</span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">zsp</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">nlev_MT</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1839</span>
<span class="linenos">1840</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1841</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1842</span><span class="w">          </span><span class="n">rgsigps</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1843</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">1844</span><span class="k">      endif</span>
<span class="linenos">1845</span><span class="k">      if</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;PB&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1846</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">1847</span><span class="w">          </span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1848</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">1849</span><span class="k">      endif</span>
<span class="linenos">1850</span>
<span class="linenos">1851</span><span class="k">    enddo</span>
<span class="linenos">1852</span>
<span class="linenos">1853</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_RDSPSTD</span><span class="w"></span>
<span class="linenos">1854</span>
<span class="linenos">1855</span>
<span class="linenos">1856</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_RDSTD</span><span class="w"></span>
<span class="linenos">1857</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1858</span>
<span class="linenos">1859</span><span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">inbrvar3d</span><span class="o">=</span><span class="mi">5</span><span class="w"></span>
<span class="linenos">1860</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">inbrvar2d</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1861</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jvar</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="w"></span>
<span class="linenos">1862</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ikey</span><span class="w"></span>
<span class="linenos">1863</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1864</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varName3d</span><span class="p">(</span><span class="n">inbrvar3d</span><span class="p">),</span><span class="n">varName2d</span><span class="p">(</span><span class="n">inbrvar2d</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1865</span>
<span class="linenos">1866</span><span class="w">    </span><span class="c">! standard file variables</span>
<span class="linenos">1867</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="w">  </span>
<span class="linenos">1868</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="w"></span>
<span class="linenos">1869</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">idate</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="n">nlev_MT</span><span class="w"></span>
<span class="linenos">1870</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cltypvar</span><span class="w"></span>
<span class="linenos">1871</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1872</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cletiket</span><span class="w"></span>
<span class="linenos">1873</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fstinf</span><span class="w"></span>
<span class="linenos">1874</span>
<span class="linenos">1875</span><span class="w">    </span><span class="k">data </span><span class="n">varName3d</span><span class="o">/</span><span class="s1">&#39;PP  &#39;</span><span class="p">,</span><span class="s1">&#39;UC  &#39;</span><span class="p">,</span><span class="s1">&#39;UT  &#39;</span><span class="p">,</span><span class="s1">&#39;LQ  &#39;</span><span class="p">,</span><span class="s1">&#39;TB  &#39;</span><span class="o">/</span><span class="w"></span>
<span class="linenos">1876</span><span class="w">    </span><span class="k">data </span><span class="n">varName2d</span><span class="o">/</span><span class="s1">&#39;UP  &#39;</span><span class="p">,</span><span class="s1">&#39;PB  &#39;</span><span class="o">/</span><span class="w"></span>
<span class="linenos">1877</span>
<span class="linenos">1878</span><span class="w">    </span><span class="n">rgsig</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1879</span><span class="w">    </span><span class="n">rgsigtb</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1880</span><span class="w">    </span><span class="n">rgsigpsb</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1881</span>
<span class="linenos">1882</span><span class="c">!   2. Reading the data</span>
<span class="linenos">1883</span>
<span class="linenos">1884</span><span class="w">    </span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1885</span><span class="w">    </span><span class="n">ip1</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1886</span><span class="w">    </span><span class="n">ip2</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1887</span><span class="w">    </span><span class="n">ip3</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1888</span>
<span class="linenos">1889</span><span class="w">    </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;STDDEV&#39;</span><span class="w"></span>
<span class="linenos">1890</span><span class="w">    </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;E&#39;</span><span class="w"></span>
<span class="linenos">1891</span>
<span class="linenos">1892</span><span class="w">    </span><span class="k">do </span><span class="n">jvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inbrvar3d</span><span class="w"></span>
<span class="linenos">1893</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varName3d</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1894</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">vnl_varLevelFromVarName</span><span class="p">(</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;MM&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1895</span><span class="k">        </span><span class="n">nlev_MT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">1896</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">1897</span><span class="k">        </span><span class="n">nlev_MT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">1898</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1899</span>
<span class="linenos">1900</span><span class="k">      </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1901</span>
<span class="linenos">1902</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ikey</span><span class="w"> </span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1903</span><span class="k">        </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1904</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">1905</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;RDSTD: could not read varName=&#39;</span><span class="p">,</span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1906</span><span class="w">        </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;RDSTD&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">1907</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1908</span>
<span class="linenos">1909</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ink</span><span class="w"> </span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="w"> </span><span class="n">nlev_MT</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1910</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ink, nlev_MT=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ink</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_MT</span><span class="w"></span>
<span class="linenos">1911</span><span class="w">        </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;RDSPSTD: BG stat levels inconsitencies&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1912</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1913</span>
<span class="linenos">1914</span><span class="k">      if</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;PP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1915</span><span class="k">        </span><span class="n">rgsiguu</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1916</span><span class="w">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UC&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;CC&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1917</span><span class="k">        </span><span class="n">rgsigvv</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1918</span><span class="w">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UT&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1919</span><span class="k">        </span><span class="n">rgsigtt</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_T</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1920</span><span class="w">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TB&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1921</span><span class="k">        </span><span class="n">rgsigtb</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_T</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1922</span><span class="w">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;LQ&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1923</span><span class="k">        </span><span class="n">rgsigq</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_T</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1924</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1925</span>
<span class="linenos">1926</span><span class="k">    enddo</span>
<span class="linenos">1927</span>
<span class="linenos">1928</span><span class="k">    </span><span class="n">nlev_MT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1929</span><span class="w">    </span><span class="k">do </span><span class="n">jvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inbrvar2d</span><span class="w"></span>
<span class="linenos">1930</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varName2d</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1931</span>
<span class="linenos">1932</span><span class="w">      </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1933</span>
<span class="linenos">1934</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ikey</span><span class="w"> </span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1935</span><span class="k">        </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">zgr</span><span class="p">,</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1936</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">1937</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;RDSTD: could not read varName=&#39;</span><span class="p">,</span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1938</span><span class="w">        </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;RDSTD&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">1939</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1940</span>
<span class="linenos">1941</span><span class="k">      if</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1942</span><span class="k">        </span><span class="n">rgsigps</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1943</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1944</span><span class="k">      if</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;PB&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1945</span><span class="k">        </span><span class="n">rgsigpsb</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1946</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1947</span>
<span class="linenos">1948</span><span class="k">    enddo</span>
<span class="linenos">1949</span>
<span class="linenos">1950</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_RDSTD</span><span class="w"></span>
<span class="linenos">1951</span>
<span class="linenos">1952</span>
<span class="linenos">1953</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_RDSPSTD_NEWFMT</span><span class="w"></span>
<span class="linenos">1954</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1955</span>
<span class="linenos">1956</span><span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">inbrvar3d</span><span class="o">=</span><span class="mi">5</span><span class="w"></span>
<span class="linenos">1957</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">inbrvar2d</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1958</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jvar</span><span class="p">,</span><span class="n">jn</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="n">ntrunc_file</span><span class="w"></span>
<span class="linenos">1959</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ikey</span><span class="p">,</span><span class="n">jlevo</span><span class="p">,</span><span class="n">jlat</span><span class="w"></span>
<span class="linenos">1960</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zsp</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1961</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zspbuf</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">1962</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">nlev_M</span><span class="p">,</span><span class="n">nlev_T</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1963</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varName3d</span><span class="p">(</span><span class="n">inbrvar3d</span><span class="p">),</span><span class="n">varName2d</span><span class="p">(</span><span class="n">inbrvar2d</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1964</span>
<span class="linenos">1965</span><span class="w">    </span><span class="c">! standard file variables</span>
<span class="linenos">1966</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="w"></span>
<span class="linenos">1967</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="w"></span>
<span class="linenos">1968</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">idate</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="n">nlev_MT</span><span class="w"></span>
<span class="linenos">1969</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cltypvar</span><span class="w"></span>
<span class="linenos">1970</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">1971</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cletiket</span><span class="w"></span>
<span class="linenos">1972</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fstinf</span><span class="w"></span>
<span class="linenos">1973</span>
<span class="linenos">1974</span><span class="w">    </span><span class="k">data </span><span class="n">varName3d</span><span class="o">/</span><span class="s1">&#39;PP  &#39;</span><span class="p">,</span><span class="s1">&#39;UC  &#39;</span><span class="p">,</span><span class="s1">&#39;UT  &#39;</span><span class="p">,</span><span class="s1">&#39;LQ  &#39;</span><span class="p">,</span><span class="s1">&#39;TB  &#39;</span><span class="o">/</span><span class="w"></span>
<span class="linenos">1975</span><span class="w">    </span><span class="k">data </span><span class="n">varName2d</span><span class="o">/</span><span class="s1">&#39;UP  &#39;</span><span class="p">,</span><span class="s1">&#39;PB  &#39;</span><span class="o">/</span><span class="w"></span>
<span class="linenos">1976</span>
<span class="linenos">1977</span><span class="w">    </span><span class="n">rgsig</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1978</span><span class="w">    </span><span class="n">rgsigtb</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1979</span><span class="w">    </span><span class="n">rgsigpsb</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1980</span>
<span class="linenos">1981</span><span class="c">!   2. Reading the data</span>
<span class="linenos">1982</span>
<span class="linenos">1983</span><span class="w">    </span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1984</span><span class="w">    </span><span class="n">ip2</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1985</span><span class="w">    </span><span class="n">ip3</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1986</span>
<span class="linenos">1987</span><span class="w">    </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;SPSTDDEV&#39;</span><span class="w"></span>
<span class="linenos">1988</span><span class="w">    </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;X&#39;</span><span class="w"></span>
<span class="linenos">1989</span>
<span class="linenos">1990</span><span class="w">    </span><span class="c">! check if file is old format</span>
<span class="linenos">1991</span><span class="w">    </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1992</span><span class="w">    </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varName3d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1993</span><span class="w">    </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1994</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ini,inj,ink=&#39;</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="w"></span>
<span class="linenos">1995</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">inix</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1996</span><span class="k">      write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;BHI_RDSPSTD_NEWFMT: ini&gt;1, SPSTDDEV is in old format, calling BHI_RDSPSTD...&#39;</span><span class="w"></span>
<span class="linenos">1997</span><span class="w">      </span><span class="k">call </span><span class="n">bhi_rdspstd</span><span class="w"></span>
<span class="linenos">1998</span><span class="w">      </span><span class="k">return</span>
<span class="linenos">1999</span><span class="k">    endif</span><span class="w"></span>
<span class="linenos">2000</span>
<span class="linenos">2001</span><span class="w">    </span><span class="c">!write(*,*) &#39;Reading 3D variables&#39;</span>
<span class="linenos">2002</span><span class="w">    </span><span class="k">do </span><span class="n">jvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inbrvar3d</span><span class="w"></span>
<span class="linenos">2003</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varName3d</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2004</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">vnl_varLevelFromVarName</span><span class="p">(</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;MM&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2005</span><span class="k">        </span><span class="n">nlev_MT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">2006</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2007</span><span class="k">        </span><span class="n">nlev_MT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">2008</span><span class="w">      </span><span class="k">endif</span><span class="w"></span>
<span class="linenos">2009</span><span class="w">      </span><span class="c">!write(*,*)&#39;Reading &#39;,clnomvar</span>
<span class="linenos">2010</span><span class="w">      </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_MT</span><span class="w"></span>
<span class="linenos">2011</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">vnl_varLevelFromVarName</span><span class="p">(</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;MM&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2012</span><span class="k">          </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vco_anl</span><span class="p">%</span><span class="n">ip1_M</span><span class="p">(</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2013</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">2014</span><span class="k">          </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vco_anl</span><span class="p">%</span><span class="n">ip1_T</span><span class="p">(</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2015</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos">2016</span><span class="k">        </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">ntrunc_file</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2017</span><span class="w">        </span><span class="n">ntrunc_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ntrunc_file</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2018</span>
<span class="linenos">2019</span><span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">zspbuf</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc_file</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2020</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">ikey</span><span class="w"> </span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2021</span><span class="k">          </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">zspbuf</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc_file</span><span class="p">),</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2022</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">2023</span><span class="k">          write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;RDSPSTD_NEWFMT: &#39;</span><span class="p">,</span><span class="n">jvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">,</span><span class="n">nlev_MT</span><span class="p">,</span><span class="n">jlevo</span><span class="p">,</span><span class="n">ikey</span><span class="p">,</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">ntrunc_file</span><span class="w"></span>
<span class="linenos">2024</span><span class="w">          </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;RDSPSTD_NEWFMT: SPSTDDEV record not found&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2025</span><span class="w">        </span><span class="k">endif</span>
<span class="linenos">2026</span>
<span class="linenos">2027</span><span class="k">        </span><span class="n">zsp</span><span class="p">(:,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2028</span><span class="w">        </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">ntrunc_file</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2029</span><span class="w">          </span><span class="n">zsp</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zspbuf</span><span class="p">(</span><span class="n">jn</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2030</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">2031</span><span class="k">        deallocate</span><span class="p">(</span><span class="n">zspbuf</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2032</span>
<span class="linenos">2033</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">2034</span>
<span class="linenos">2035</span><span class="k">      call </span><span class="n">gst_zleginv</span><span class="p">(</span><span class="n">gstID</span><span class="p">,</span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">zsp</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">nlev_MT</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2036</span>
<span class="linenos">2037</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;PP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2038</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">2039</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">2040</span><span class="w">            </span><span class="n">rgsiguu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2041</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">2042</span><span class="k">        enddo</span>
<span class="linenos">2043</span><span class="k">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UC&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;CC&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2044</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">2045</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">2046</span><span class="w">            </span><span class="n">rgsigvv</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2047</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">2048</span><span class="k">        enddo</span>
<span class="linenos">2049</span><span class="k">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UT&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2050</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">2051</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">2052</span><span class="w">            </span><span class="n">rgsigtt</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2053</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">2054</span><span class="k">        enddo</span>
<span class="linenos">2055</span><span class="k">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TB&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2056</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">2057</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">2058</span><span class="w">            </span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2059</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">2060</span><span class="k">        enddo</span>
<span class="linenos">2061</span><span class="k">      </span><span class="n">elseif</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;LQ&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2062</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">2063</span><span class="w">          </span><span class="k">do </span><span class="n">jlevo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">2064</span><span class="w">            </span><span class="n">rgsigq</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlevo</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2065</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">2066</span><span class="k">        enddo</span>
<span class="linenos">2067</span><span class="k">      endif</span>
<span class="linenos">2068</span>
<span class="linenos">2069</span><span class="k">    enddo</span>
<span class="linenos">2070</span>
<span class="linenos">2071</span><span class="k">    </span><span class="n">nlev_MT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2072</span><span class="w">    </span><span class="k">do </span><span class="n">jvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">inbrvar2d</span><span class="w"></span>
<span class="linenos">2073</span><span class="w">      </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varName2d</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2074</span><span class="w">      </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2075</span><span class="w">      </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">ntrunc_file</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2076</span><span class="w">      </span><span class="n">ntrunc_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ntrunc_file</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2077</span>
<span class="linenos">2078</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">zspbuf</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc_file</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2079</span>
<span class="linenos">2080</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ikey</span><span class="w"> </span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2081</span><span class="k">        </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">zspbuf</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc_file</span><span class="p">),</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="nb">idate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2082</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2083</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;RDSPSTD_NEWFMT: &#39;</span><span class="p">,</span><span class="n">jvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">,</span><span class="n">nlev_MT</span><span class="p">,</span><span class="n">jlevo</span><span class="p">,</span><span class="n">ikey</span><span class="p">,</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">ntrunc_file</span><span class="w"></span>
<span class="linenos">2084</span><span class="w">        </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;RDSPSTD_NEWFMT: SPSTDDEV record not found&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2085</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">2086</span>
<span class="linenos">2087</span><span class="k">      </span><span class="n">zsp</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2088</span><span class="w">      </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">ntrunc_file</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2089</span><span class="w">        </span><span class="n">zsp</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zspbuf</span><span class="p">(</span><span class="n">jn</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2090</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">2091</span><span class="k">      deallocate</span><span class="p">(</span><span class="n">zspbuf</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2092</span>
<span class="linenos">2093</span><span class="w">      </span><span class="k">call </span><span class="n">gst_zleginv</span><span class="p">(</span><span class="n">gstID</span><span class="p">,</span><span class="n">zgr</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">zsp</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_MT</span><span class="p">),</span><span class="n">nlev_MT</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2094</span>
<span class="linenos">2095</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2096</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">2097</span><span class="w">          </span><span class="n">rgsigps</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2098</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">2099</span><span class="k">      endif</span>
<span class="linenos">2100</span><span class="k">      if</span><span class="p">(</span><span class="n">clnomvar</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;PB&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2101</span><span class="k">        do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">2102</span><span class="w">          </span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgr</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2103</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">2104</span><span class="k">      endif</span>
<span class="linenos">2105</span>
<span class="linenos">2106</span><span class="k">    enddo</span>
<span class="linenos">2107</span>
<span class="linenos">2108</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_RDSPSTD_NEWFMT</span><span class="w"></span>
<span class="linenos">2109</span>
<span class="linenos">2110</span>
<span class="linenos">2111</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_RDSPPTOT</span><span class="w"></span>
<span class="linenos">2112</span><span class="w">    </span><span class="k">IMPLICIT NONE</span>
<span class="linenos">2113</span>
<span class="linenos">2114</span><span class="k">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jk1</span><span class="p">,</span><span class="w"> </span><span class="n">jk2</span><span class="p">,</span><span class="w"> </span><span class="n">ikey</span><span class="p">,</span><span class="w"> </span><span class="n">ilen</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="w"></span>
<span class="linenos">2115</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zsptheta</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2116</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zgrtheta</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2117</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zPtoTsrc</span><span class="p">(</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2118</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zspPtoT</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">ntrunc</span><span class="p">,</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2119</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zgrPtoT</span><span class="p">(</span><span class="n">nj_l</span><span class="p">,</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2120</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ztheta</span><span class="p">(</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2121</span><span class="w">    </span>
<span class="linenos">2122</span><span class="w">    </span><span class="c">! standard file variables</span>
<span class="linenos">2123</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="w"></span>
<span class="linenos">2124</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="w"></span>
<span class="linenos">2125</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">idateo</span><span class="w"></span>
<span class="linenos">2126</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cltypvar</span><span class="w"></span>
<span class="linenos">2127</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">clnomvar</span><span class="w"></span>
<span class="linenos">2128</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cletiket</span><span class="w"></span>
<span class="linenos">2129</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fstinf</span><span class="w"></span>
<span class="linenos">2130</span><span class="w">    </span>
<span class="linenos">2131</span><span class="w">    </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2132</span><span class="w">    </span><span class="n">ip3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2133</span><span class="w">    </span><span class="n">idateo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2134</span><span class="w">    </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;SP_THETA&#39;</span><span class="w"></span>
<span class="linenos">2135</span><span class="w">    </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;X&#39;</span><span class="w"></span>
<span class="linenos">2136</span><span class="w">    </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ZZ&#39;</span><span class="w"></span>
<span class="linenos">2137</span>
<span class="linenos">2138</span><span class="w">    </span><span class="c">! read spectral coefficients for theta</span>
<span class="linenos">2139</span>
<span class="linenos">2140</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">2141</span><span class="w">      </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">2142</span><span class="w">      </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2143</span>
<span class="linenos">2144</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ikey</span><span class="w"> </span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2145</span><span class="k">        </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">ztheta</span><span class="p">,</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2146</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2147</span><span class="k">        if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;WARNING: CANNOT FIND THETA FOR &#39;</span><span class="p">,</span><span class="n">jn</span><span class="p">,</span><span class="s1">&#39; SETTING TO ZERO!!!&#39;</span><span class="w"></span>
<span class="linenos">2148</span><span class="w">        </span><span class="n">ztheta</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2149</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">2150</span>
<span class="linenos">2151</span><span class="k">      do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">2152</span><span class="w">        </span><span class="n">zsptheta</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="n">jk1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ztheta</span><span class="p">(</span><span class="n">jk1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2153</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">2154</span>
<span class="linenos">2155</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">2156</span>
<span class="linenos">2157</span><span class="w">    </span><span class="c">! converting theta in physical space</span>
<span class="linenos">2158</span>
<span class="linenos">2159</span><span class="w">    </span><span class="k">call </span><span class="n">gst_zleginv</span><span class="p">(</span><span class="n">gstID</span><span class="p">,</span><span class="n">zgrtheta</span><span class="p">,</span><span class="n">zsptheta</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2160</span>
<span class="linenos">2161</span><span class="w">    </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">2162</span><span class="w">      </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">2163</span><span class="w">        </span><span class="n">tantheta</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">tan</span><span class="p">(</span><span class="n">zgrtheta</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2164</span><span class="w">      </span><span class="k">end do</span>
<span class="linenos">2165</span><span class="k">    end do</span>
<span class="linenos">2166</span>
<span class="linenos">2167</span><span class="k">    </span><span class="n">ip1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2168</span><span class="w">    </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2169</span><span class="w">    </span><span class="n">ip3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2170</span><span class="w">    </span><span class="n">idateo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2171</span><span class="w">    </span><span class="n">cletiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;SP_PtoT&#39;</span><span class="w"></span>
<span class="linenos">2172</span><span class="w">    </span><span class="n">cltypvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;X&#39;</span><span class="w"></span>
<span class="linenos">2173</span><span class="w">    </span><span class="n">clnomvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ZZ&#39;</span><span class="w"></span>
<span class="linenos">2174</span>
<span class="linenos">2175</span><span class="w">    </span><span class="c">! read of spectral coefficients for P to T operator</span>
<span class="linenos">2176</span>
<span class="linenos">2177</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">2178</span><span class="w">      </span><span class="n">ip2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">2179</span><span class="w">      </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fstinf</span><span class="p">(</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">inix</span><span class="p">,</span><span class="n">injx</span><span class="p">,</span><span class="n">inkx</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2180</span>
<span class="linenos">2181</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">ikey</span><span class="w"> </span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2182</span><span class="k">        </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_fstlir</span><span class="p">(</span><span class="n">zPtoTsrc</span><span class="p">,</span><span class="n">nulbgst</span><span class="p">,</span><span class="n">ini</span><span class="p">,</span><span class="n">inj</span><span class="p">,</span><span class="n">ink</span><span class="p">,</span><span class="n">idateo</span><span class="p">,</span><span class="n">cletiket</span><span class="p">,</span><span class="n">ip1</span><span class="p">,</span><span class="n">ip2</span><span class="p">,</span><span class="n">ip3</span><span class="p">,</span><span class="n">cltypvar</span><span class="p">,</span><span class="n">clnomvar</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2183</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2184</span><span class="k">        if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;WARNING: CANNOT FIND P_to_T FOR &#39;</span><span class="p">,</span><span class="n">jn</span><span class="p">,</span><span class="s1">&#39; SETTING TO ZERO!!!&#39;</span><span class="w"></span>
<span class="linenos">2185</span><span class="w">        </span><span class="n">zPtoTsrc</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2186</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">2187</span>
<span class="linenos">2188</span><span class="k">      do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">2189</span><span class="w">        </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2190</span><span class="w">          </span><span class="n">zspPtoT</span><span class="p">(</span><span class="n">jn</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zPtoTsrc</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2191</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">2192</span><span class="k">      enddo</span>
<span class="linenos">2193</span>
<span class="linenos">2194</span><span class="k">    enddo</span>
<span class="linenos">2195</span>
<span class="linenos">2196</span><span class="k">    </span><span class="n">ilen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev_M</span><span class="o">*</span><span class="p">(</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2197</span><span class="w">    </span><span class="k">call </span><span class="n">gst_zleginv</span><span class="p">(</span><span class="n">gstID</span><span class="p">,</span><span class="n">zgrPtoT</span><span class="p">,</span><span class="n">zspPtoT</span><span class="p">,</span><span class="n">ilen</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2198</span>
<span class="linenos">2199</span><span class="w">    </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj_l</span><span class="w"></span>
<span class="linenos">2200</span><span class="w">      </span><span class="k">do </span><span class="n">jk2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">2201</span><span class="w">        </span><span class="k">do </span><span class="n">jk1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2202</span><span class="w">          </span><span class="n">PtoT</span><span class="p">(</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgrPtoT</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jk1</span><span class="p">,</span><span class="n">jk2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2203</span><span class="w">        </span><span class="k">end do</span>
<span class="linenos">2204</span><span class="k">      end do</span>
<span class="linenos">2205</span><span class="k">    enddo</span>
<span class="linenos">2206</span>
<span class="linenos">2207</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_RDSPPTOT</span><span class="w"></span>
<span class="linenos">2208</span>
<span class="linenos">2209</span>
<span class="linenos">2210</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_truncateCV</span><span class="p">(</span><span class="n">controlVector_inout</span><span class="p">,</span><span class="n">ntruncCut</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2211</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">2212</span><span class="w">    </span><span class="c">! set to zero all coefficients with total wavenumber &gt; ntruncCut</span>
<span class="linenos">2213</span>
<span class="linenos">2214</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">controlVector_inout</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2215</span><span class="w">    </span><span class="kt">integer</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">ntruncCut</span><span class="w"></span>
<span class="linenos">2216</span><span class="w">    </span><span class="kt">integer</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jdim</span><span class="w"></span>
<span class="linenos">2217</span>
<span class="linenos">2218</span><span class="w">    </span><span class="k">if</span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">initialized</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2219</span><span class="k">      if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_truncateCV: bMatrixHI not initialized&#39;</span><span class="w"></span>
<span class="linenos">2220</span><span class="w">      </span><span class="k">return</span>
<span class="linenos">2221</span><span class="k">    endif</span>
<span class="linenos">2222</span>
<span class="linenos">2223</span><span class="k">    if</span><span class="p">(</span><span class="n">ntruncCut</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ntrunc</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2224</span><span class="k">      write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">ntruncCut</span><span class="p">,</span><span class="w"> </span><span class="n">ntrunc</span><span class="w"></span>
<span class="linenos">2225</span><span class="w">      </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bhi_truncateCV: ntruncCut is greater than ntrunc!&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2226</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos">2227</span>
<span class="linenos">2228</span><span class="k">    </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">2229</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">2230</span><span class="w">      </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mymEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mymSkip</span><span class="w"></span>
<span class="linenos">2231</span><span class="w">        </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mynBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mynEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mynSkip</span><span class="w"></span>
<span class="linenos">2232</span><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2233</span><span class="k">            </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2234</span><span class="w">            </span><span class="n">ila_mpilocal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2235</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2236</span><span class="w">              </span><span class="c">! only real component for jm=0</span>
<span class="linenos">2237</span><span class="w">              </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2238</span><span class="w">              </span><span class="k">if</span><span class="p">(</span><span class="n">jn</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ntruncCut</span><span class="p">)</span><span class="w"> </span><span class="n">controlVector_inout</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2239</span><span class="w">            </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2240</span><span class="w">              </span><span class="c">! both real and imaginary components for jm&gt;0</span>
<span class="linenos">2241</span><span class="w">              </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2242</span><span class="w">              </span><span class="k">if</span><span class="p">(</span><span class="n">jn</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ntruncCut</span><span class="p">)</span><span class="w"> </span><span class="n">controlVector_inout</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2243</span><span class="w">              </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2244</span><span class="w">              </span><span class="k">if</span><span class="p">(</span><span class="n">jn</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ntruncCut</span><span class="p">)</span><span class="w"> </span><span class="n">controlVector_inout</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2245</span><span class="w">            </span><span class="k">endif</span>
<span class="linenos">2246</span><span class="k">          endif</span>
<span class="linenos">2247</span><span class="k">        enddo</span>
<span class="linenos">2248</span><span class="k">      enddo</span>
<span class="linenos">2249</span><span class="k">    enddo</span>
<span class="linenos">2250</span>
<span class="linenos">2251</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_truncateCV</span><span class="w"></span>
<span class="linenos">2252</span>
<span class="linenos">2253</span>
<span class="linenos">2254</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_bSqrt</span><span class="p">(</span><span class="n">controlVector_in</span><span class="p">,</span><span class="w"> </span><span class="n">statevector</span><span class="p">,</span><span class="w"> </span><span class="n">stateVectorRef_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2255</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">2256</span>
<span class="linenos">2257</span><span class="w">    </span><span class="c">! Arguments</span>
<span class="linenos">2258</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">                    </span><span class="kd">::</span><span class="w"> </span><span class="n">controlVector_in</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2259</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_gsv</span><span class="p">)</span><span class="w">           </span><span class="kd">::</span><span class="w"> </span><span class="n">statevector</span><span class="w"></span>
<span class="linenos">2260</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_gsv</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">statevectorRef_opt</span><span class="w"></span>
<span class="linenos">2261</span>
<span class="linenos">2262</span><span class="w">    </span><span class="c">! Locals</span>
<span class="linenos">2263</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">gd_out</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">2264</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">hiControlVector</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nkgdimSqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2265</span>
<span class="linenos">2266</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_bsqrt: starting&#39;</span><span class="w"></span>
<span class="linenos">2267</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Memory Used: &#39;</span><span class="p">,</span><span class="n">get_max_rss</span><span class="p">()</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="s1">&#39;Mb&#39;</span><span class="w"></span>
<span class="linenos">2268</span>
<span class="linenos">2269</span><span class="w">    </span><span class="k">if</span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">initialized</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2270</span><span class="k">      if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bMatrixHI not initialized&#39;</span><span class="w"></span>
<span class="linenos">2271</span><span class="w">      </span><span class="k">return</span>
<span class="linenos">2272</span><span class="k">    endif</span>
<span class="linenos">2273</span>
<span class="linenos">2274</span><span class="k">    allocate</span><span class="p">(</span><span class="n">gd_out</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2275</span>
<span class="linenos">2276</span><span class="w">    </span><span class="k">call </span><span class="n">bhi_cain</span><span class="p">(</span><span class="n">controlVector_in</span><span class="p">,</span><span class="n">hiControlVector</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2277</span><span class="w">    </span><span class="k">call </span><span class="n">bhi_spa2gd</span><span class="p">(</span><span class="n">hiControlVector</span><span class="p">,</span><span class="n">gd_out</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2278</span>
<span class="linenos">2279</span><span class="w">    </span><span class="k">call </span><span class="n">copyToStatevector</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">gd_out</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2280</span>
<span class="linenos">2281</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="s1">&#39;HU&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2282</span><span class="k">      call </span><span class="n">gvt_transform</span><span class="p">(</span><span class="w"> </span><span class="n">statevector</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w">                         </span><span class="c">! INOUT</span>
<span class="linenos">2283</span><span class="w">                          </span><span class="s1">&#39;LQtoHU_tlm&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w">                         </span><span class="c">! IN</span>
<span class="linenos">2284</span><span class="w">                          </span><span class="n">stateVectorRef_opt</span><span class="o">=</span><span class="n">stateVectorRef_opt</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c">! IN</span>
<span class="linenos">2285</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2286</span>
<span class="linenos">2287</span><span class="k">    deallocate</span><span class="p">(</span><span class="n">gd_out</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2288</span>
<span class="linenos">2289</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Memory Used: &#39;</span><span class="p">,</span><span class="n">get_max_rss</span><span class="p">()</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="s1">&#39;Mb&#39;</span><span class="w"></span>
<span class="linenos">2290</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_bsqrt: done&#39;</span><span class="w"></span>
<span class="linenos">2291</span>
<span class="linenos">2292</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">BHI_bSqrt</span><span class="w"></span>
<span class="linenos">2293</span>
<span class="linenos">2294</span>
<span class="linenos">2295</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_bSqrtAd</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="w"> </span><span class="n">controlVector_out</span><span class="p">,</span><span class="w"> </span><span class="n">stateVectorRef_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2296</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">2297</span>
<span class="linenos">2298</span><span class="w">    </span><span class="c">! Arguments</span>
<span class="linenos">2299</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">                    </span><span class="kd">::</span><span class="w"> </span><span class="n">controlVector_out</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2300</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_gsv</span><span class="p">)</span><span class="w">           </span><span class="kd">::</span><span class="w"> </span><span class="n">statevector</span><span class="w"></span>
<span class="linenos">2301</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_gsv</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">statevectorRef_opt</span><span class="w"></span>
<span class="linenos">2302</span>
<span class="linenos">2303</span><span class="w">    </span><span class="c">! Locals</span>
<span class="linenos">2304</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">gd_in</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">2305</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">hiControlVector</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nkgdimSqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2306</span>
<span class="linenos">2307</span><span class="w">    </span><span class="k">if</span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">initialized</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2308</span><span class="k">      if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bMatrixHI not initialized&#39;</span><span class="w"></span>
<span class="linenos">2309</span><span class="w">      </span><span class="k">return</span>
<span class="linenos">2310</span><span class="k">    endif</span>
<span class="linenos">2311</span>
<span class="linenos">2312</span><span class="k">    if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_bsqrtad: starting&#39;</span><span class="w"></span>
<span class="linenos">2313</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Memory Used: &#39;</span><span class="p">,</span><span class="n">get_max_rss</span><span class="p">()</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="s1">&#39;Mb&#39;</span><span class="w"></span>
<span class="linenos">2314</span>
<span class="linenos">2315</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">gd_in</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2316</span><span class="w">    </span><span class="n">gd_in</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.d0</span><span class="w"></span>
<span class="linenos">2317</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="s1">&#39;HU&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2318</span><span class="k">      call </span><span class="n">gvt_transform</span><span class="p">(</span><span class="w"> </span><span class="n">statevector</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w">                          </span><span class="c">! INOUT</span>
<span class="linenos">2319</span><span class="w">                          </span><span class="s1">&#39;LQtoHU_ad&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w">                          </span><span class="c">! IN</span>
<span class="linenos">2320</span><span class="w">                          </span><span class="n">stateVectorRef_opt</span><span class="o">=</span><span class="n">stateVectorRef_opt</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c">! IN</span>
<span class="linenos">2321</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2322</span>
<span class="linenos">2323</span><span class="k">    call </span><span class="n">copyFromStatevector</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">gd_in</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2324</span>
<span class="linenos">2325</span><span class="w">    </span><span class="k">call </span><span class="n">bhi_spa2gdad</span><span class="p">(</span><span class="n">gd_in</span><span class="p">,</span><span class="n">hiControlVector</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2326</span>
<span class="linenos">2327</span><span class="w">    </span><span class="k">call </span><span class="n">bhi_cainad</span><span class="p">(</span><span class="n">hiControlVector</span><span class="p">,</span><span class="n">controlVector_out</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2328</span>
<span class="linenos">2329</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">gd_in</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2330</span>
<span class="linenos">2331</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Memory Used: &#39;</span><span class="p">,</span><span class="n">get_max_rss</span><span class="p">()</span><span class="o">/</span><span class="mi">1024</span><span class="p">,</span><span class="s1">&#39;Mb&#39;</span><span class="w"></span>
<span class="linenos">2332</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;bhi_bsqrtad: done&#39;</span><span class="w"></span>
<span class="linenos">2333</span>
<span class="linenos">2334</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">BHI_bSqrtAd</span><span class="w"></span>
<span class="linenos">2335</span>
<span class="linenos">2336</span>
<span class="linenos">2337</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">copyToStatevector</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">gd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2338</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">2339</span><span class="k">    type</span><span class="p">(</span><span class="n">struct_gsv</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">statevector</span><span class="w"></span>
<span class="linenos">2340</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2341</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlon</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jlev2</span><span class="p">,</span><span class="w"> </span><span class="n">jlat</span><span class="p">,</span><span class="w"> </span><span class="n">jvar</span><span class="p">,</span><span class="w"> </span><span class="n">ilev1</span><span class="p">,</span><span class="w"> </span><span class="n">ilev2</span><span class="w"></span>
<span class="linenos">2342</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">field_r8</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">2343</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">field_r4</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">2344</span>
<span class="linenos">2345</span><span class="w">    </span><span class="k">do </span><span class="n">jvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">vnl_numvarmax</span><span class="w"> </span>
<span class="linenos">2346</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2347</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">gsv_getDataKind</span><span class="p">(</span><span class="n">statevector</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2348</span><span class="k">          call </span><span class="n">gsv_getField</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">field_r8</span><span class="p">,</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2349</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">2350</span><span class="k">          call </span><span class="n">gsv_getField</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">field_r4</span><span class="p">,</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2351</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">2352</span><span class="k">        if</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UU  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2353</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositVO</span><span class="w"></span>
<span class="linenos">2354</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;VV  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2355</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositDI</span><span class="w"></span>
<span class="linenos">2356</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TT  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2357</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositTT</span><span class="w"></span>
<span class="linenos">2358</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;HU  &#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;LQ  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2359</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositQ</span><span class="w"></span>
<span class="linenos">2360</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;P0  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2361</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositPS</span><span class="w"></span>
<span class="linenos">2362</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TG  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2363</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositTG</span><span class="w"></span>
<span class="linenos">2364</span><span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2365</span><span class="w">          </span><span class="c">! Cycle (instead of abort) to allow for non-NWP assimilation (e.g. chemical data assimilation)</span>
<span class="linenos">2366</span><span class="c">!          call utl_abort(&#39;bmatrixhi_mod: copyToStatevector: No covariances available for variable:&#39; // vnl_varNameList(jvar))</span>
<span class="linenos">2367</span><span class="w">          </span><span class="k">cycle</span>
<span class="linenos">2368</span><span class="k">        endif</span>
<span class="linenos">2369</span><span class="k">        </span><span class="n">ilev2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilev1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsv_getNumLev</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">vnl_varLevelFromVarname</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2370</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gsv_getDataKind</span><span class="p">(</span><span class="n">statevector</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2371</span><span class="k">          do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilev1</span><span class="p">,</span><span class="w"> </span><span class="n">ilev2</span><span class="w"></span>
<span class="linenos">2372</span><span class="w">            </span><span class="n">jlev2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jlev</span><span class="o">-</span><span class="n">ilev1</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2373</span><span class="w">            </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">2374</span><span class="w">              </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">2375</span><span class="w">                </span><span class="n">field_r8</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2376</span><span class="w">              </span><span class="k">enddo</span>
<span class="linenos">2377</span><span class="k">            enddo</span>
<span class="linenos">2378</span><span class="k">          enddo</span>
<span class="linenos">2379</span><span class="k">        else</span>
<span class="linenos">2380</span><span class="k">          do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilev1</span><span class="p">,</span><span class="w"> </span><span class="n">ilev2</span><span class="w"></span>
<span class="linenos">2381</span><span class="w">            </span><span class="n">jlev2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jlev</span><span class="o">-</span><span class="n">ilev1</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2382</span><span class="w">            </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">2383</span><span class="w">              </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">2384</span><span class="w">                </span><span class="n">field_r4</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2385</span><span class="w">              </span><span class="k">enddo</span>
<span class="linenos">2386</span><span class="k">            enddo</span>
<span class="linenos">2387</span><span class="k">          enddo</span>
<span class="linenos">2388</span><span class="k">        end if</span>
<span class="linenos">2389</span><span class="k">      endif</span>
<span class="linenos">2390</span><span class="k">    enddo</span>
<span class="linenos">2391</span>
<span class="linenos">2392</span><span class="k">  END SUBROUTINE </span><span class="n">copyToStatevector</span><span class="w"></span>
<span class="linenos">2393</span>
<span class="linenos">2394</span>
<span class="linenos">2395</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">copyFromStatevector</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">gd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2396</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">2397</span><span class="k">    type</span><span class="p">(</span><span class="n">struct_gsv</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">statevector</span><span class="w"></span>
<span class="linenos">2398</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2399</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlon</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jlev2</span><span class="p">,</span><span class="w"> </span><span class="n">jlat</span><span class="p">,</span><span class="w"> </span><span class="n">jvar</span><span class="p">,</span><span class="w"> </span><span class="n">ilev1</span><span class="p">,</span><span class="w"> </span><span class="n">ilev2</span><span class="w"></span>
<span class="linenos">2400</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">field_r8</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">2401</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">field_r4</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">2402</span>
<span class="linenos">2403</span><span class="w">    </span><span class="k">do </span><span class="n">jvar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">vnl_numvarmax</span><span class="w"> </span>
<span class="linenos">2404</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">gsv_varExist</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2405</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">gsv_getDataKind</span><span class="p">(</span><span class="n">statevector</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2406</span><span class="k">          call </span><span class="n">gsv_getField</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">field_r8</span><span class="p">,</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2407</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">2408</span><span class="k">          call </span><span class="n">gsv_getField</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">field_r4</span><span class="p">,</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2409</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">2410</span><span class="k">        if</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;UU  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2411</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositVO</span><span class="w"></span>
<span class="linenos">2412</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;VV  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2413</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositDI</span><span class="w"></span>
<span class="linenos">2414</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TT  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2415</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositTT</span><span class="w"></span>
<span class="linenos">2416</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;HU  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2417</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositQ</span><span class="w"></span>
<span class="linenos">2418</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;P0  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2419</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositPS</span><span class="w"></span>
<span class="linenos">2420</span><span class="w">        </span><span class="n">elseif</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TG  &#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2421</span><span class="k">          </span><span class="n">ilev1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nspositTG</span><span class="w"></span>
<span class="linenos">2422</span><span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2423</span><span class="w">          </span><span class="c">! Cycle (instead of abort) to allow for non-NWP assimilation (e.g. chemical data assimilation)</span>
<span class="linenos">2424</span><span class="w">          </span><span class="k">cycle</span>
<span class="linenos">2425</span><span class="k">        endif</span>
<span class="linenos">2426</span><span class="k">        </span><span class="n">ilev2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilev1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsv_getNumLev</span><span class="p">(</span><span class="n">statevector</span><span class="p">,</span><span class="n">vnl_varLevelFromVarname</span><span class="p">(</span><span class="n">vnl_varNameList</span><span class="p">(</span><span class="n">jvar</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2427</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gsv_getDataKind</span><span class="p">(</span><span class="n">statevector</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2428</span><span class="k">          do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilev1</span><span class="p">,</span><span class="w"> </span><span class="n">ilev2</span><span class="w"></span>
<span class="linenos">2429</span><span class="w">            </span><span class="n">jlev2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jlev</span><span class="o">-</span><span class="n">ilev1</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2430</span><span class="w">            </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">2431</span><span class="w">              </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">2432</span><span class="w">                </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field_r8</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2433</span><span class="w">              </span><span class="k">enddo</span>
<span class="linenos">2434</span><span class="k">            enddo</span>
<span class="linenos">2435</span><span class="k">          enddo</span>
<span class="linenos">2436</span><span class="k">        else</span>
<span class="linenos">2437</span><span class="k">          do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilev1</span><span class="p">,</span><span class="w"> </span><span class="n">ilev2</span><span class="w"></span>
<span class="linenos">2438</span><span class="w">            </span><span class="n">jlev2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jlev</span><span class="o">-</span><span class="n">ilev1</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2439</span><span class="w">            </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">2440</span><span class="w">              </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">2441</span><span class="w">                </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field_r4</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2442</span><span class="w">              </span><span class="k">enddo</span>
<span class="linenos">2443</span><span class="k">            enddo</span>
<span class="linenos">2444</span><span class="k">          enddo</span>
<span class="linenos">2445</span><span class="k">        end if</span>
<span class="linenos">2446</span><span class="k">      endif</span>
<span class="linenos">2447</span><span class="k">    enddo</span>
<span class="linenos">2448</span>
<span class="linenos">2449</span><span class="k">  END SUBROUTINE </span><span class="n">copyFromStatevector</span><span class="w"></span>
<span class="linenos">2450</span>
<span class="linenos">2451</span>
<span class="linenos">2452</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_reduceToMPILocal</span><span class="p">(</span><span class="n">cv_mpilocal</span><span class="p">,</span><span class="n">cv_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2453</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">2454</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_mpilocal</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2455</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2456</span>
<span class="linenos">2457</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_allMaxMpilocal</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">2458</span>
<span class="linenos">2459</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cvDim_allMpilocal</span><span class="p">(:),</span><span class="w"> </span><span class="n">displs</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2460</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">allnBeg</span><span class="p">(:),</span><span class="n">allnEnd</span><span class="p">(:),</span><span class="n">allnSkip</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2461</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">allmBeg</span><span class="p">(:),</span><span class="n">allmEnd</span><span class="p">(:),</span><span class="n">allmSkip</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2462</span>
<span class="linenos">2463</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jproc</span><span class="p">,</span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="n">ierr</span><span class="w"></span>
<span class="linenos">2464</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="n">jn</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jdim_mpiglobal</span><span class="w"></span>
<span class="linenos">2465</span>
<span class="linenos">2466</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_allreduce</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2467</span><span class="w">                            </span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;MPI_INTEGER&quot;</span><span class="p">,</span><span class="s2">&quot;MPI_MAX&quot;</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2468</span>
<span class="linenos">2469</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2470</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cvDim_allMpiLocal</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2471</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2472</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cvDim_allMpiLocal</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2473</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2474</span>
<span class="linenos">2475</span><span class="k">    call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">cvDim_mpiLocal</span><span class="w">   </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2476</span><span class="w">                         </span><span class="n">cvDim_allMpiLocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2477</span>
<span class="linenos">2478</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2479</span><span class="k">       allocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2480</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2481</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2482</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2483</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2484</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2485</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2486</span><span class="k">       allocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2487</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2488</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2489</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2490</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2491</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2492</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2493</span>
<span class="linenos">2494</span><span class="k">    call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynBeg</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2495</span><span class="w">                         </span><span class="n">allnBeg</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2496</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynEnd</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2497</span><span class="w">                         </span><span class="n">allnEnd</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2498</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynSkip</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2499</span><span class="w">                         </span><span class="n">allnSkip</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2500</span>
<span class="linenos">2501</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymBeg</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2502</span><span class="w">                         </span><span class="n">allmBeg</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2503</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymEnd</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2504</span><span class="w">                         </span><span class="n">allmEnd</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2505</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymSkip</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2506</span><span class="w">                         </span><span class="n">allmSkip</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2507</span>
<span class="linenos">2508</span><span class="w">    </span><span class="c">! Prepare to data to be distributed</span>
<span class="linenos">2509</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2510</span>
<span class="linenos">2511</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2512</span>
<span class="linenos">2513</span><span class="w">       </span><span class="c">!$OMP PARALLEL DO PRIVATE(jproc,jdim_mpilocal,jlev,jm,jn,ila_mpiglobal,jdim_mpiglobal)</span>
<span class="linenos">2514</span><span class="w">       </span><span class="k">do </span><span class="n">jproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2515</span><span class="w">          </span><span class="n">cv_allmaxmpilocal</span><span class="p">(:,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.d0</span><span class="w"></span>
<span class="linenos">2516</span><span class="w">          </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">2517</span>
<span class="linenos">2518</span><span class="w">          </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">2519</span><span class="w">             </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allmBeg</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allmEnd</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allmSkip</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2520</span><span class="w">                </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allnBeg</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allnEnd</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allnSkip</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2521</span>
<span class="linenos">2522</span><span class="w">                   </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2523</span><span class="k">                      </span>
<span class="linenos">2524</span><span class="k">                      </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2525</span><span class="w">                      </span>
<span class="linenos">2526</span><span class="w">                      </span><span class="c">! figure out index into global control vector</span>
<span class="linenos">2527</span><span class="w">                      </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2528</span><span class="w">                         </span><span class="c">! for jm=0 only real part</span>
<span class="linenos">2529</span><span class="w">                         </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="w"></span>
<span class="linenos">2530</span><span class="w">                      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2531</span><span class="w">                         </span><span class="c">! for jm&gt;0 both real and imaginary part</span>
<span class="linenos">2532</span><span class="w">                         </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">ila_mpiglobal</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2533</span><span class="w">                      </span><span class="k">endif</span><span class="w"></span>
<span class="linenos">2534</span><span class="w">                      </span><span class="c">! add offset for level</span>
<span class="linenos">2535</span><span class="w">                      </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2536</span><span class="w">                      </span>
<span class="linenos">2537</span><span class="w">                      </span><span class="c">! index into local control vector computer as in cain</span>
<span class="linenos">2538</span><span class="w">                      </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2539</span><span class="w">                         </span><span class="c">! only real component for jm=0</span>
<span class="linenos">2540</span><span class="w">                         </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2541</span><span class="w">                         </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2542</span><span class="w">                      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2543</span><span class="w">                         </span><span class="c">! both real and imaginary components for jm&gt;0</span>
<span class="linenos">2544</span><span class="w">                         </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2545</span><span class="w">                         </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2546</span><span class="w">                         </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2547</span><span class="w">                         </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2548</span><span class="w">                      </span><span class="k">endif</span>
<span class="linenos">2549</span><span class="k">                      </span>
<span class="linenos">2550</span><span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cvDim_allMpiLocal</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2551</span><span class="k">                         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2552</span><span class="w">                         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ERROR: jdim_mpilocal &gt; cvDim_allMpiLocal(jproc+1)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_mpilocal</span><span class="w"></span>
<span class="linenos">2553</span><span class="w">                         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;       proc, jlev, jn, jm = &#39;</span><span class="p">,</span><span class="n">jproc</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2554</span><span class="w">                         </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bhi_reduceToMPILocal&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2555</span><span class="w">                      </span><span class="k">end if</span>
<span class="linenos">2556</span><span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cvDim_mpiglobal</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2557</span><span class="k">                         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2558</span><span class="w">                         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ERROR: jdim_mpiglobal &gt; cvDim_mpiglobal&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">jdim_mpiglobal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_mpiglobal</span><span class="w"></span>
<span class="linenos">2559</span><span class="w">                         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;       proc, jlev, jn, jm = &#39;</span><span class="p">,</span><span class="n">jproc</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2560</span><span class="w">                         </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bhi_reduceToMPILocal&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2561</span><span class="w">                      </span><span class="k">end if</span>
<span class="linenos">2562</span>
<span class="linenos">2563</span><span class="k">                   endif</span>
<span class="linenos">2564</span><span class="k">                enddo</span>
<span class="linenos">2565</span><span class="k">             enddo</span>
<span class="linenos">2566</span><span class="k">          enddo</span>
<span class="linenos">2567</span><span class="k"> </span>
<span class="linenos">2568</span><span class="k">       end do</span><span class="w"> </span><span class="c">! jproc</span>
<span class="linenos">2569</span><span class="w">       </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">2570</span>
<span class="linenos">2571</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2572</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2573</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2574</span>
<span class="linenos">2575</span><span class="w">    </span><span class="c">!- Distribute</span>
<span class="linenos">2576</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">displs</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2577</span><span class="w">    </span><span class="k">do </span><span class="n">jproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2578</span><span class="w">       </span><span class="n">displs</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jproc</span><span class="o">*</span><span class="n">cvDim_maxMpiLocal</span><span class="w"> </span><span class="c">! displacement wrt cv_allMaxMpiLocal from which</span>
<span class="linenos">2579</span><span class="w">                                                 </span><span class="c">! to take the outgoing data to process jproc</span>
<span class="linenos">2580</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">2581</span>
<span class="linenos">2582</span><span class="k">    call </span><span class="n">rpn_comm_scatterv</span><span class="p">(</span><span class="n">cv_allMaxMpiLocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_allMpiLocal</span><span class="p">,</span><span class="w"> </span><span class="n">displs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mpi_double_precision&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2583</span><span class="w">                           </span><span class="n">cv_mpiLocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_mpiLocal</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mpi_double_precision&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2584</span><span class="w">                           </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2585</span>
<span class="linenos">2586</span><span class="w">    </span><span class="c">!- End</span>
<span class="linenos">2587</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">displs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2588</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">cv_allMaxMpiLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2589</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">cvDim_allMpiLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2590</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2591</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2592</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2593</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2594</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2595</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2596</span>
<span class="linenos">2597</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">BHI_reduceToMPILocal</span><span class="w"></span>
<span class="linenos">2598</span>
<span class="linenos">2599</span>
<span class="linenos">2600</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_reduceToMPILocal_r4</span><span class="p">(</span><span class="n">cv_mpilocal</span><span class="p">,</span><span class="n">cv_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2601</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">2602</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_mpilocal</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2603</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2604</span>
<span class="linenos">2605</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_allMaxMpilocal</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">2606</span>
<span class="linenos">2607</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cvDim_allMpilocal</span><span class="p">(:),</span><span class="w"> </span><span class="n">displs</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2608</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">allnBeg</span><span class="p">(:),</span><span class="n">allnEnd</span><span class="p">(:),</span><span class="n">allnSkip</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2609</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">allmBeg</span><span class="p">(:),</span><span class="n">allmEnd</span><span class="p">(:),</span><span class="n">allmSkip</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2610</span>
<span class="linenos">2611</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jproc</span><span class="p">,</span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="n">ierr</span><span class="w"></span>
<span class="linenos">2612</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="n">jn</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jdim_mpiglobal</span><span class="w"></span>
<span class="linenos">2613</span>
<span class="linenos">2614</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_allreduce</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2615</span><span class="w">                            </span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;MPI_INTEGER&quot;</span><span class="p">,</span><span class="s2">&quot;MPI_MAX&quot;</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2616</span>
<span class="linenos">2617</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2618</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cvDim_allMpiLocal</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2619</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2620</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cvDim_allMpiLocal</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2621</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2622</span>
<span class="linenos">2623</span><span class="k">    call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">cvDim_mpiLocal</span><span class="w">   </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2624</span><span class="w">                         </span><span class="n">cvDim_allMpiLocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2625</span>
<span class="linenos">2626</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2627</span><span class="k">       allocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2628</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2629</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2630</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2631</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2632</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2633</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2634</span><span class="k">       allocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2635</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2636</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2637</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2638</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2639</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2640</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2641</span>
<span class="linenos">2642</span><span class="k">    call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynBeg</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2643</span><span class="w">                         </span><span class="n">allnBeg</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2644</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynEnd</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2645</span><span class="w">                         </span><span class="n">allnEnd</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2646</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynSkip</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2647</span><span class="w">                         </span><span class="n">allnSkip</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2648</span>
<span class="linenos">2649</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymBeg</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2650</span><span class="w">                         </span><span class="n">allmBeg</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2651</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymEnd</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2652</span><span class="w">                         </span><span class="n">allmEnd</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2653</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymSkip</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2654</span><span class="w">                         </span><span class="n">allmSkip</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2655</span>
<span class="linenos">2656</span><span class="w">    </span><span class="c">! Prepare to data to be distributed</span>
<span class="linenos">2657</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2658</span>
<span class="linenos">2659</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2660</span>
<span class="linenos">2661</span><span class="w">       </span><span class="c">!$OMP PARALLEL DO PRIVATE(jproc,jdim_mpilocal,jlev,jm,jn,ila_mpiglobal,jdim_mpiglobal)</span>
<span class="linenos">2662</span><span class="w">       </span><span class="k">do </span><span class="n">jproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2663</span><span class="w">          </span><span class="n">cv_allmaxmpilocal</span><span class="p">(:,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.d0</span><span class="w"></span>
<span class="linenos">2664</span><span class="w">          </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">2665</span>
<span class="linenos">2666</span><span class="w">          </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">2667</span><span class="w">             </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allmBeg</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allmEnd</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allmSkip</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2668</span><span class="w">                </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allnBeg</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allnEnd</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allnSkip</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2669</span>
<span class="linenos">2670</span><span class="w">                   </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2671</span><span class="k">                      </span>
<span class="linenos">2672</span><span class="k">                      </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2673</span><span class="w">                      </span>
<span class="linenos">2674</span><span class="w">                      </span><span class="c">! figure out index into global control vector</span>
<span class="linenos">2675</span><span class="w">                      </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2676</span><span class="w">                         </span><span class="c">! for jm=0 only real part</span>
<span class="linenos">2677</span><span class="w">                         </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="w"></span>
<span class="linenos">2678</span><span class="w">                      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2679</span><span class="w">                         </span><span class="c">! for jm&gt;0 both real and imaginary part</span>
<span class="linenos">2680</span><span class="w">                         </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">ila_mpiglobal</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2681</span><span class="w">                      </span><span class="k">endif</span><span class="w"></span>
<span class="linenos">2682</span><span class="w">                      </span><span class="c">! add offset for level</span>
<span class="linenos">2683</span><span class="w">                      </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2684</span><span class="w">                      </span>
<span class="linenos">2685</span><span class="w">                      </span><span class="c">! index into local control vector computer as in cain</span>
<span class="linenos">2686</span><span class="w">                      </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2687</span><span class="w">                         </span><span class="c">! only real component for jm=0</span>
<span class="linenos">2688</span><span class="w">                         </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2689</span><span class="w">                         </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2690</span><span class="w">                      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2691</span><span class="w">                         </span><span class="c">! both real and imaginary components for jm&gt;0</span>
<span class="linenos">2692</span><span class="w">                         </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2693</span><span class="w">                         </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2694</span><span class="w">                         </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2695</span><span class="w">                         </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2696</span><span class="w">                      </span><span class="k">endif</span>
<span class="linenos">2697</span><span class="k">                      </span>
<span class="linenos">2698</span><span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cvDim_allMpiLocal</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2699</span><span class="k">                         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2700</span><span class="w">                         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ERROR: jdim_mpilocal &gt; cvDim_allMpiLocal(jproc+1)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_mpilocal</span><span class="w"></span>
<span class="linenos">2701</span><span class="w">                         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;       proc, jlev, jn, jm = &#39;</span><span class="p">,</span><span class="n">jproc</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2702</span><span class="w">                         </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bhi_reduceToMPILocal&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2703</span><span class="w">                      </span><span class="k">end if</span>
<span class="linenos">2704</span><span class="k">                      if</span><span class="w"> </span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cvDim_mpiglobal</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2705</span><span class="k">                         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2706</span><span class="w">                         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ERROR: jdim_mpiglobal &gt; cvDim_mpiglobal&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">jdim_mpiglobal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_mpiglobal</span><span class="w"></span>
<span class="linenos">2707</span><span class="w">                         </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;       proc, jlev, jn, jm = &#39;</span><span class="p">,</span><span class="n">jproc</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2708</span><span class="w">                         </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;bhi_reduceToMPILocal&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2709</span><span class="w">                      </span><span class="k">end if</span>
<span class="linenos">2710</span>
<span class="linenos">2711</span><span class="k">                   endif</span>
<span class="linenos">2712</span><span class="k">                enddo</span>
<span class="linenos">2713</span><span class="k">             enddo</span>
<span class="linenos">2714</span><span class="k">          enddo</span>
<span class="linenos">2715</span><span class="k"> </span>
<span class="linenos">2716</span><span class="k">       end do</span><span class="w"> </span><span class="c">! jproc</span>
<span class="linenos">2717</span><span class="w">       </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">2718</span>
<span class="linenos">2719</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2720</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2721</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2722</span>
<span class="linenos">2723</span><span class="w">    </span><span class="c">!- Distribute</span>
<span class="linenos">2724</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">displs</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2725</span><span class="w">    </span><span class="k">do </span><span class="n">jproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2726</span><span class="w">       </span><span class="n">displs</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jproc</span><span class="o">*</span><span class="n">cvDim_maxMpiLocal</span><span class="w"> </span><span class="c">! displacement wrt cv_allMaxMpiLocal from which</span>
<span class="linenos">2727</span><span class="w">                                                 </span><span class="c">! to take the outgoing data to process jproc</span>
<span class="linenos">2728</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">2729</span>
<span class="linenos">2730</span><span class="k">    call </span><span class="n">rpn_comm_scatterv</span><span class="p">(</span><span class="n">cv_allMaxMpiLocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_allMpiLocal</span><span class="p">,</span><span class="w"> </span><span class="n">displs</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mpi_real4&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2731</span><span class="w">                           </span><span class="n">cv_mpiLocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_mpiLocal</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mpi_real4&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2732</span><span class="w">                           </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2733</span>
<span class="linenos">2734</span><span class="w">    </span><span class="c">!- End</span>
<span class="linenos">2735</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">displs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2736</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">cv_allMaxMpiLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2737</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">cvDim_allMpiLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2738</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2739</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2740</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2741</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2742</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2743</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2744</span>
<span class="linenos">2745</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">BHI_reduceToMPILocal_r4</span><span class="w"></span>
<span class="linenos">2746</span>
<span class="linenos">2747</span>
<span class="linenos">2748</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_expandToMPIGlobal</span><span class="p">(</span><span class="n">cv_mpilocal</span><span class="p">,</span><span class="n">cv_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2749</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">2750</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_mpilocal</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2751</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2752</span>
<span class="linenos">2753</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_maxmpilocal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2754</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_allmaxmpilocal</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">null</span><span class="p">()</span><span class="w"></span>
<span class="linenos">2755</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">allnBeg</span><span class="p">(:),</span><span class="n">allnEnd</span><span class="p">(:),</span><span class="n">allnSkip</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2756</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">allmBeg</span><span class="p">(:),</span><span class="n">allmEnd</span><span class="p">(:),</span><span class="n">allmSkip</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2757</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="p">,</span><span class="w"> </span><span class="n">jproc</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">jdim_mpiglobal</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_maxmpilocal</span><span class="w"></span>
<span class="linenos">2758</span>
<span class="linenos">2759</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2760</span><span class="w">    </span><span class="c">!- 1.  Gather all local control vectors onto mpi task 0</span>
<span class="linenos">2761</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2762</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_allreduce</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">,</span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="s2">&quot;mpi_max&quot;</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2763</span>
<span class="linenos">2764</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">cv_maxmpilocal</span><span class="p">(</span><span class="n">cvDim_maxmpilocal</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2765</span>
<span class="linenos">2766</span><span class="w">    </span><span class="k">nullify</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2767</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2768</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2769</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2770</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2771</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2772</span>
<span class="linenos">2773</span><span class="k">    </span><span class="n">cv_maxmpilocal</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2774</span><span class="w">    </span><span class="n">cv_maxmpilocal</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_mpilocal</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2775</span>
<span class="linenos">2776</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">cv_maxmpilocal</span><span class="p">,</span><span class="w">    </span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mpi_double_precision&quot;</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2777</span><span class="w">                         </span><span class="n">cv_allmaxmpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mpi_double_precision&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">2778</span>
<span class="linenos">2779</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">cv_maxmpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2780</span>
<span class="linenos">2781</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2782</span><span class="w">    </span><span class="c">!- 2.  Reorganize gathered mpilocal control vectors into the mpiglobal control vector</span>
<span class="linenos">2783</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2784</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2785</span><span class="k">       allocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2786</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2787</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2788</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2789</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2790</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2791</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2792</span><span class="k">       allocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2793</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2794</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2795</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2796</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2797</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2798</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2799</span>
<span class="linenos">2800</span><span class="k">    call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynBeg</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2801</span><span class="w">                         </span><span class="n">allnBeg</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2802</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynEnd</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2803</span><span class="w">                         </span><span class="n">allnEnd</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2804</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynSkip</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2805</span><span class="w">                         </span><span class="n">allnSkip</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2806</span>
<span class="linenos">2807</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymBeg</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2808</span><span class="w">                         </span><span class="n">allmBeg</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2809</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymEnd</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2810</span><span class="w">                         </span><span class="n">allmEnd</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2811</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymSkip</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2812</span><span class="w">                         </span><span class="n">allmSkip</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2813</span>
<span class="linenos">2814</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2815</span><span class="k">      </span><span class="n">cv_mpiglobal</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2816</span>
<span class="linenos">2817</span><span class="w">      </span><span class="c">!$OMP PARALLEL DO PRIVATE(jproc,jdim_mpilocal,jlev,jm,jn,ila_mpiglobal,jdim_mpiglobal)</span>
<span class="linenos">2818</span><span class="w">      </span><span class="k">do </span><span class="n">jproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2819</span><span class="w">        </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">2820</span>
<span class="linenos">2821</span><span class="w">        </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">2822</span><span class="w">          </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allmBeg</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allmEnd</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allmSkip</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2823</span><span class="w">            </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allnBeg</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allnEnd</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allnSkip</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2824</span><span class="w">              </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2825</span>
<span class="linenos">2826</span><span class="k">                </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2827</span>
<span class="linenos">2828</span><span class="w">                </span><span class="c">! figure out index into global control vector</span>
<span class="linenos">2829</span><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2830</span><span class="w">                  </span><span class="c">! for jm=0 only real part</span>
<span class="linenos">2831</span><span class="w">                  </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="w"></span>
<span class="linenos">2832</span><span class="w">                </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2833</span><span class="w">                  </span><span class="c">! for jm&gt;0 both real and imaginary part</span>
<span class="linenos">2834</span><span class="w">                  </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">ila_mpiglobal</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2835</span><span class="w">                </span><span class="k">endif</span><span class="w"></span>
<span class="linenos">2836</span><span class="w">                </span><span class="c">! add offset for level</span>
<span class="linenos">2837</span><span class="w">                </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2838</span>
<span class="linenos">2839</span><span class="w">                </span><span class="c">! index into local control vector</span>
<span class="linenos">2840</span><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2841</span><span class="w">                  </span><span class="c">! only real component for jm=0</span>
<span class="linenos">2842</span><span class="w">                  </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2843</span><span class="w">                  </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2844</span><span class="w">                </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2845</span><span class="w">                  </span><span class="c">! both real and imaginary components for jm&gt;0</span>
<span class="linenos">2846</span><span class="w">                  </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2847</span><span class="w">                  </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2848</span><span class="w">                  </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2849</span><span class="w">                  </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2850</span><span class="w">                </span><span class="k">endif</span>
<span class="linenos">2851</span>
<span class="linenos">2852</span><span class="k">                if</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">cvDim_mpiglobal</span><span class="p">)</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2853</span><span class="w">                  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ERROR: jdim,cvDim,mpiglobal=&#39;</span><span class="p">,</span><span class="n">jdim_mpiglobal</span><span class="p">,</span><span class="n">cvDim_mpiglobal</span><span class="p">,</span><span class="n">jlev</span><span class="p">,</span><span class="n">jn</span><span class="p">,</span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2854</span>
<span class="linenos">2855</span><span class="w">              </span><span class="k">endif</span>
<span class="linenos">2856</span><span class="k">            enddo</span>
<span class="linenos">2857</span><span class="k">          enddo</span>
<span class="linenos">2858</span><span class="k">        enddo</span>
<span class="linenos">2859</span><span class="k">      enddo</span><span class="w"> </span><span class="c">! jproc</span>
<span class="linenos">2860</span><span class="w">      </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">2861</span>
<span class="linenos">2862</span><span class="w">    </span><span class="k">endif</span><span class="w"> </span><span class="c">! myid == 0 </span>
<span class="linenos">2863</span>
<span class="linenos">2864</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2865</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2866</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2867</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2868</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2869</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2870</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2871</span>
<span class="linenos">2872</span><span class="w">  </span><span class="k">end SUBROUTINE </span><span class="n">BHI_expandToMPIGlobal</span><span class="w"></span>
<span class="linenos">2873</span>
<span class="linenos">2874</span>
<span class="linenos">2875</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_expandToMPIGlobal_r4</span><span class="p">(</span><span class="n">cv_mpilocal</span><span class="p">,</span><span class="n">cv_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2876</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">2877</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_mpilocal</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2878</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_mpiglobal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2879</span>
<span class="linenos">2880</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_maxmpilocal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2881</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cv_allmaxmpilocal</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">null</span><span class="p">()</span><span class="w"></span>
<span class="linenos">2882</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">allnBeg</span><span class="p">(:),</span><span class="n">allnEnd</span><span class="p">(:),</span><span class="n">allnSkip</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2883</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">allmBeg</span><span class="p">(:),</span><span class="n">allmEnd</span><span class="p">(:),</span><span class="n">allmSkip</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2884</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="p">,</span><span class="w"> </span><span class="n">jproc</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">jdim_mpiglobal</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_maxmpilocal</span><span class="w"></span>
<span class="linenos">2885</span>
<span class="linenos">2886</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2887</span><span class="w">    </span><span class="c">!- 1.  Gather all local control vectors onto mpi task 0</span>
<span class="linenos">2888</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2889</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_allreduce</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">,</span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="s2">&quot;mpi_max&quot;</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2890</span>
<span class="linenos">2891</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">cv_maxmpilocal</span><span class="p">(</span><span class="n">cvDim_maxmpilocal</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2892</span>
<span class="linenos">2893</span><span class="w">    </span><span class="k">nullify</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2894</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2895</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2896</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2897</span><span class="k">       allocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2898</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2899</span>
<span class="linenos">2900</span><span class="k">    </span><span class="n">cv_maxmpilocal</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2901</span><span class="w">    </span><span class="n">cv_maxmpilocal</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_mpilocal</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2902</span>
<span class="linenos">2903</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">cv_maxmpilocal</span><span class="p">,</span><span class="w">    </span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mpi_real4&quot;</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2904</span><span class="w">                         </span><span class="n">cv_allmaxmpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">cvDim_maxmpilocal</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mpi_real4&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">2905</span>
<span class="linenos">2906</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">cv_maxmpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2907</span>
<span class="linenos">2908</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2909</span><span class="w">    </span><span class="c">!- 2.  Reorganize gathered mpilocal control vectors into the mpiglobal control vector</span>
<span class="linenos">2910</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2911</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2912</span><span class="k">       allocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2913</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2914</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2915</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2916</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2917</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2918</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2919</span><span class="k">       allocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2920</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2921</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2922</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2923</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2924</span><span class="w">       </span><span class="k">allocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2925</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2926</span>
<span class="linenos">2927</span><span class="k">    call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynBeg</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2928</span><span class="w">                         </span><span class="n">allnBeg</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2929</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynEnd</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2930</span><span class="w">                         </span><span class="n">allnEnd</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2931</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mynSkip</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2932</span><span class="w">                         </span><span class="n">allnSkip</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2933</span>
<span class="linenos">2934</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymBeg</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2935</span><span class="w">                         </span><span class="n">allmBeg</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2936</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymEnd</span><span class="w">  </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2937</span><span class="w">                         </span><span class="n">allmEnd</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2938</span><span class="w">    </span><span class="k">call </span><span class="n">rpn_comm_gather</span><span class="p">(</span><span class="n">mymSkip</span><span class="w"> </span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2939</span><span class="w">                         </span><span class="n">allmSkip</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;mpi_integer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;GRID&quot;</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2940</span>
<span class="linenos">2941</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2942</span><span class="k">      </span><span class="n">cv_mpiglobal</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2943</span>
<span class="linenos">2944</span><span class="w">      </span><span class="c">!$OMP PARALLEL DO PRIVATE(jproc,jdim_mpilocal,jlev,jm,jn,ila_mpiglobal,jdim_mpiglobal)</span>
<span class="linenos">2945</span><span class="w">      </span><span class="k">do </span><span class="n">jproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">mmpi_nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2946</span><span class="w">        </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">2947</span>
<span class="linenos">2948</span><span class="w">        </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">2949</span><span class="w">          </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allmBeg</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allmEnd</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allmSkip</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2950</span><span class="w">            </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allnBeg</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allnEnd</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">allnSkip</span><span class="p">(</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2951</span><span class="w">              </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2952</span>
<span class="linenos">2953</span><span class="k">                </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2954</span>
<span class="linenos">2955</span><span class="w">                </span><span class="c">! figure out index into global control vector</span>
<span class="linenos">2956</span><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2957</span><span class="w">                  </span><span class="c">! for jm=0 only real part</span>
<span class="linenos">2958</span><span class="w">                  </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="w"></span>
<span class="linenos">2959</span><span class="w">                </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2960</span><span class="w">                  </span><span class="c">! for jm&gt;0 both real and imaginary part</span>
<span class="linenos">2961</span><span class="w">                  </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">ila_mpiglobal</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2962</span><span class="w">                </span><span class="k">endif</span><span class="w"></span>
<span class="linenos">2963</span><span class="w">                </span><span class="c">! add offset for level</span>
<span class="linenos">2964</span><span class="w">                </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpiglobal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ntrunc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2965</span>
<span class="linenos">2966</span><span class="w">                </span><span class="c">! index into local control vector</span>
<span class="linenos">2967</span><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2968</span><span class="w">                  </span><span class="c">! only real component for jm=0</span>
<span class="linenos">2969</span><span class="w">                  </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2970</span><span class="w">                  </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2971</span><span class="w">                </span><span class="k">else</span><span class="w"></span>
<span class="linenos">2972</span><span class="w">                  </span><span class="c">! both real and imaginary components for jm&gt;0</span>
<span class="linenos">2973</span><span class="w">                  </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2974</span><span class="w">                  </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2975</span><span class="w">                  </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim_mpilocal</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2976</span><span class="w">                  </span><span class="n">cv_mpiglobal</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv_allmaxmpilocal</span><span class="p">(</span><span class="n">jdim_mpilocal</span><span class="p">,</span><span class="n">jproc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2977</span><span class="w">                </span><span class="k">endif</span>
<span class="linenos">2978</span>
<span class="linenos">2979</span><span class="k">                if</span><span class="p">(</span><span class="n">jdim_mpiglobal</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">cvDim_mpiglobal</span><span class="p">)</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2980</span><span class="w">                  </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ERROR: jdim,cvDim,mpiglobal=&#39;</span><span class="p">,</span><span class="n">jdim_mpiglobal</span><span class="p">,</span><span class="n">cvDim_mpiglobal</span><span class="p">,</span><span class="n">jlev</span><span class="p">,</span><span class="n">jn</span><span class="p">,</span><span class="n">jm</span><span class="w"></span>
<span class="linenos">2981</span>
<span class="linenos">2982</span><span class="w">              </span><span class="k">endif</span>
<span class="linenos">2983</span><span class="k">            enddo</span>
<span class="linenos">2984</span><span class="k">          enddo</span>
<span class="linenos">2985</span><span class="k">        enddo</span>
<span class="linenos">2986</span><span class="k">      enddo</span><span class="w"> </span><span class="c">! jproc</span>
<span class="linenos">2987</span><span class="w">      </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">2988</span>
<span class="linenos">2989</span><span class="w">    </span><span class="k">endif</span><span class="w"> </span><span class="c">! myid == 0 </span>
<span class="linenos">2990</span>
<span class="linenos">2991</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnBeg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2992</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2993</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allnSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2994</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmBeg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2995</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2996</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">allmSkip</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2997</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">cv_allmaxmpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2998</span>
<span class="linenos">2999</span><span class="w">  </span><span class="k">end SUBROUTINE </span><span class="n">BHI_expandToMPIGlobal_r4</span><span class="w"></span>
<span class="linenos">3000</span>
<span class="linenos">3001</span>
<span class="linenos">3002</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_cain</span><span class="p">(</span><span class="n">controlVector_in</span><span class="p">,</span><span class="n">hiControlVector_out</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3003</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">3004</span>
<span class="linenos">3005</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">controlVector_in</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3006</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nkgdimSqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3007</span>
<span class="linenos">3008</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jdim</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="w"></span>
<span class="linenos">3009</span>
<span class="linenos">3010</span><span class="w">    </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3011</span><span class="w">    </span><span class="n">hiControlVector_out</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3012</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">3013</span><span class="w">      </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mymEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mymSkip</span><span class="w"></span>
<span class="linenos">3014</span><span class="w">        </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mynBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mynEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mynSkip</span><span class="w"></span>
<span class="linenos">3015</span><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3016</span><span class="k">            </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">3017</span><span class="w">            </span><span class="n">ila_mpilocal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3018</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3019</span><span class="w">              </span><span class="c">! only real component for jm=0</span>
<span class="linenos">3020</span><span class="w">              </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3021</span><span class="w">              </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controlVector_in</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3022</span><span class="w">            </span><span class="k">else</span><span class="w"></span>
<span class="linenos">3023</span><span class="w">              </span><span class="c">! both real and imaginary components for jm&gt;0</span>
<span class="linenos">3024</span><span class="w">              </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3025</span><span class="w">              </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controlVector_in</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3026</span><span class="w">              </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3027</span><span class="w">              </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controlVector_in</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3028</span><span class="w">            </span><span class="k">endif</span>
<span class="linenos">3029</span><span class="k">          endif</span>
<span class="linenos">3030</span><span class="k">        enddo</span>
<span class="linenos">3031</span><span class="k">      enddo</span>
<span class="linenos">3032</span><span class="k">    enddo</span>
<span class="linenos">3033</span>
<span class="linenos">3034</span><span class="k">  end SUBROUTINE </span><span class="n">BHI_cain</span><span class="w"></span>
<span class="linenos">3035</span>
<span class="linenos">3036</span>
<span class="linenos">3037</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_cainAd</span><span class="p">(</span><span class="n">hiControlVector_in</span><span class="p">,</span><span class="n">controlVector_out</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3038</span><span class="w">    </span><span class="k">IMPLICIT NONE</span>
<span class="linenos">3039</span>
<span class="linenos">3040</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">controlVector_out</span><span class="p">(</span><span class="n">cvDim_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3041</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hiControlVector_in</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nkgdimSqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3042</span>
<span class="linenos">3043</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jdim</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="w"></span>
<span class="linenos">3044</span>
<span class="linenos">3045</span><span class="w">    </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3046</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">3047</span><span class="w">      </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mymEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mymSkip</span><span class="w"></span>
<span class="linenos">3048</span><span class="w">        </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mynBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mynEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mynSkip</span><span class="w"></span>
<span class="linenos">3049</span><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3050</span><span class="k">            </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">3051</span><span class="w">            </span><span class="n">ila_mpilocal</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3052</span><span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3053</span><span class="w">              </span><span class="c">! only real component for jm=0</span>
<span class="linenos">3054</span><span class="w">              </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3055</span><span class="w">              </span><span class="n">controlVector_out</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controlVector_out</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hiControlVector_in</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3056</span><span class="w">            </span><span class="k">else</span><span class="w"></span>
<span class="linenos">3057</span><span class="w">              </span><span class="c">! both real and imaginary components for jm&gt;0</span>
<span class="linenos">3058</span><span class="w">              </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3059</span><span class="w">              </span><span class="n">controlVector_out</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controlVector_out</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hiControlVector_in</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0d0</span><span class="w"></span>
<span class="linenos">3060</span><span class="w">              </span><span class="n">jdim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdim</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3061</span><span class="w">              </span><span class="n">controlVector_out</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controlVector_out</span><span class="p">(</span><span class="n">jdim</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hiControlVector_in</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0d0</span><span class="w"></span>
<span class="linenos">3062</span><span class="w">            </span><span class="k">endif</span>
<span class="linenos">3063</span><span class="k">          endif</span>
<span class="linenos">3064</span><span class="k">        enddo</span>
<span class="linenos">3065</span><span class="k">      enddo</span>
<span class="linenos">3066</span><span class="k">    enddo</span>
<span class="linenos">3067</span>
<span class="linenos">3068</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_cainAd</span><span class="w"></span>
<span class="linenos">3069</span>
<span class="linenos">3070</span>
<span class="linenos">3071</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_SPA2GD</span><span class="p">(</span><span class="n">hiControlVector_in</span><span class="p">,</span><span class="n">gd_out</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3072</span><span class="w">    </span><span class="k">IMPLICIT NONE</span>
<span class="linenos">3073</span>
<span class="linenos">3074</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hiControlVector_in</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nkgdimSqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3075</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">gd_out</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3076</span>
<span class="linenos">3077</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">sptb</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nlev_T_even</span><span class="p">),</span><span class="n">sp</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3078</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tb0</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nlev_T_even</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3079</span>
<span class="linenos">3080</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">icount</span><span class="w"></span>
<span class="linenos">3081</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">sq2</span><span class="p">,</span><span class="w"> </span><span class="n">zp</span><span class="w"></span>
<span class="linenos">3082</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zsp</span><span class="p">(:,:,:),</span><span class="w"> </span><span class="n">zsp2</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">3083</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jlon</span><span class="p">,</span><span class="w"> </span><span class="n">jlat</span><span class="p">,</span><span class="w"> </span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">klatPtoT</span><span class="w"></span>
<span class="linenos">3084</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zgdpsi</span><span class="p">(:,:,:),</span><span class="n">zgdchi</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">3085</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">target</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3086</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dla2</span><span class="p">,</span><span class="w"> </span><span class="n">dl1sa2</span><span class="p">,</span><span class="w"> </span><span class="n">zcoriolis</span><span class="p">,</span><span class="w"> </span><span class="n">zpsb</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3087</span>
<span class="linenos">3088</span><span class="w">    </span><span class="n">klatPtoT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3089</span>
<span class="linenos">3090</span><span class="w">    </span><span class="c">! maybe not needed:</span>
<span class="linenos">3091</span><span class="w">    </span><span class="n">sp</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3092</span><span class="w">    </span><span class="n">sptb</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3093</span>
<span class="linenos">3094</span><span class="w">    </span><span class="n">sq2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">2.0d0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3095</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">zsp</span><span class="p">(</span><span class="n">nkgdimSqrt</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">mymCount</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3096</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">zsp2</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">mymCount</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3097</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(jn,jm,jlev,ila_mpiglobal,ila_mpilocal,zsp2,zsp,icount)</span>
<span class="linenos">3098</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mynBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mynEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mynSkip</span><span class="w"></span>
<span class="linenos">3099</span>
<span class="linenos">3100</span><span class="w">      </span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3101</span><span class="w">      </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mymEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mymSkip</span><span class="w"></span>
<span class="linenos">3102</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3103</span><span class="k">          </span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icount</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3104</span><span class="w">          </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">3105</span><span class="w">          </span><span class="n">ila_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3106</span><span class="w">          </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">3107</span><span class="w">            </span><span class="n">zsp</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hiControlVector_in</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3108</span><span class="w">            </span><span class="n">zsp</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hiControlVector_in</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3109</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">3110</span><span class="k">        endif</span>
<span class="linenos">3111</span><span class="k">      enddo</span>
<span class="linenos">3112</span>
<span class="linenos">3113</span><span class="k">      if</span><span class="p">(</span><span class="n">icount</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3114</span>
<span class="linenos">3115</span><span class="k">        CALL </span><span class="n">DGEMM</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">icount</span><span class="p">,</span><span class="n">nkgdimSqrt</span><span class="p">,</span><span class="mf">1.0d0</span><span class="p">,</span><span class="n">corns</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jn</span><span class="p">),</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">zsp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">nkgdimSqrt</span><span class="p">,</span><span class="mf">0.0d0</span><span class="p">,</span><span class="n">zsp2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">nkgdim2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3116</span>
<span class="linenos">3117</span><span class="w">        </span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3118</span><span class="w">        </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mymEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mymSkip</span><span class="w"></span>
<span class="linenos">3119</span><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3120</span><span class="k">            </span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icount</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3121</span><span class="w">            </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">3122</span><span class="w">            </span><span class="n">ila_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3123</span><span class="w">            </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">3124</span><span class="w">              </span><span class="n">sp</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp2</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3125</span><span class="w">              </span><span class="n">sp</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp2</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3126</span><span class="w">            </span><span class="k">enddo</span>
<span class="linenos">3127</span><span class="k">            do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">3128</span><span class="w">              </span><span class="n">sptb</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp2</span><span class="p">(</span><span class="n">jlev</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3129</span><span class="w">              </span><span class="n">sptb</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp2</span><span class="p">(</span><span class="n">jlev</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3130</span><span class="w">            </span><span class="k">enddo</span>
<span class="linenos">3131</span><span class="k">          endif</span>
<span class="linenos">3132</span><span class="k">        enddo</span>
<span class="linenos">3133</span>
<span class="linenos">3134</span><span class="k">      endif</span><span class="w"></span>
<span class="linenos">3135</span>
<span class="linenos">3136</span><span class="w">      </span><span class="c">! make adjustments for jm=0</span>
<span class="linenos">3137</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">mymBeg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3138</span>
<span class="linenos">3139</span><span class="k">        </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNind</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">3140</span><span class="w">        </span><span class="n">ila_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3141</span>
<span class="linenos">3142</span><span class="w">        </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">3143</span><span class="w">          </span><span class="n">sp</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">sq2</span><span class="w"></span>
<span class="linenos">3144</span><span class="w">          </span><span class="n">sp</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3145</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3146</span><span class="k">        do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">3147</span><span class="w">          </span><span class="n">sptb</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sptb</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">sq2</span><span class="w"></span>
<span class="linenos">3148</span><span class="w">          </span><span class="n">sptb</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3149</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3150</span>
<span class="linenos">3151</span><span class="k">      endif</span>
<span class="linenos">3152</span>
<span class="linenos">3153</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3154</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3155</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">zsp</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3156</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">zsp2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3157</span>
<span class="linenos">3158</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(JLAT,JLEV,JLON)</span>
<span class="linenos">3159</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">3160</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">3161</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3162</span><span class="w">          </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3163</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3164</span><span class="k">      enddo</span>
<span class="linenos">3165</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3166</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3167</span>
<span class="linenos">3168</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(JLAT,JLEV,JLON)</span>
<span class="linenos">3169</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T_even</span><span class="w"></span>
<span class="linenos">3170</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">3171</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3172</span><span class="w">          </span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3173</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3174</span><span class="k">      enddo</span>
<span class="linenos">3175</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3176</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3177</span>
<span class="linenos">3178</span><span class="w">    </span><span class="k">call </span><span class="n">gst_setID</span><span class="p">(</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3179</span><span class="w">    </span><span class="k">call </span><span class="n">gst_speree</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">gd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3180</span><span class="w">    </span><span class="k">call </span><span class="n">gst_setID</span><span class="p">(</span><span class="n">gstID2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3181</span><span class="w">    </span><span class="k">call </span><span class="n">gst_speree</span><span class="p">(</span><span class="n">sptb</span><span class="p">,</span><span class="n">tb0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3182</span>
<span class="linenos">3183</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(jlat,zcoriolis,jlev,jlon,zp)</span>
<span class="linenos">3184</span><span class="w">    </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">3185</span><span class="w">      </span><span class="n">zcoriolis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.d0</span><span class="o">*</span><span class="n">ec_Omega</span><span class="o">*</span><span class="n">gst_getRmu</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3186</span><span class="w">      </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3187</span><span class="w">        </span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3188</span><span class="w">        </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevPtoT</span><span class="w"></span>
<span class="linenos">3189</span><span class="w">         </span><span class="n">zp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoriolis</span><span class="o">*</span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3190</span><span class="w">         </span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PtoT</span><span class="p">(</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">,</span><span class="n">klatPtoT</span><span class="p">)</span><span class="o">*</span><span class="n">zp</span><span class="w"></span>
<span class="linenos">3191</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3192</span><span class="k">      enddo</span>
<span class="linenos">3193</span>
<span class="linenos">3194</span><span class="k">      do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">3195</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3196</span><span class="w">          </span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoriolis</span><span class="o">*</span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3197</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3198</span><span class="k">      enddo</span>
<span class="linenos">3199</span>
<span class="linenos">3200</span><span class="k">      do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">3201</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3202</span><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">jlev</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">nspositTG</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3203</span><span class="k">            </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">rgsig</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3204</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">3205</span><span class="k">            </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3206</span><span class="w">          </span><span class="k">endif</span>
<span class="linenos">3207</span><span class="k">        enddo</span>
<span class="linenos">3208</span><span class="k">      enddo</span>
<span class="linenos">3209</span>
<span class="linenos">3210</span><span class="k">      do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">3211</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3212</span><span class="w">          </span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3213</span><span class="w">          </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositTT</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositTT</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3214</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3215</span><span class="k">      enddo</span>
<span class="linenos">3216</span><span class="k">      do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3217</span><span class="w">        </span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="o">*</span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3218</span><span class="w">        </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositPS</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositPS</span><span class="p">)</span><span class="o">+</span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3219</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">3220</span><span class="k">    enddo</span><span class="w">  </span><span class="c">! jlat</span>
<span class="linenos">3221</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3222</span>
<span class="linenos">3223</span><span class="w">    </span><span class="n">zgdpsi</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:,</span><span class="n">myLatBeg</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nspositVO</span><span class="p">:(</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">nlev_M</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3224</span><span class="w">    </span><span class="n">zgdchi</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:,</span><span class="n">myLatBeg</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nspositDI</span><span class="p">:(</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">nlev_M</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3225</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(jlat,jlev,jlon)</span>
<span class="linenos">3226</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev_bdl</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">3227</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">3228</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3229</span><span class="w">          </span><span class="n">zgdchi</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgdchi</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tantheta</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="o">*</span><span class="n">zgdpsi</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3230</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3231</span><span class="k">      enddo</span>
<span class="linenos">3232</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3233</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3234</span>
<span class="linenos">3235</span><span class="w">    </span><span class="n">sp</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3236</span>
<span class="linenos">3237</span><span class="w">    </span><span class="k">call </span><span class="n">gst_setID</span><span class="p">(</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3238</span><span class="w">    </span><span class="k">call </span><span class="n">gst_reespe</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">gd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3239</span>
<span class="linenos">3240</span><span class="w">    </span><span class="n">dla2</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ec_ra</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ec_ra</span><span class="w"></span>
<span class="linenos">3241</span><span class="w">    </span><span class="n">dl1sa2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.d0</span><span class="o">/</span><span class="n">dla2</span><span class="w"></span>
<span class="linenos">3242</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(JLEV,JLA_MPILOCAL,ILA_MPIGLOBAL)</span>
<span class="linenos">3243</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">3244</span><span class="w">      </span><span class="k">do </span><span class="n">jla_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nla_mpilocal</span><span class="w"></span>
<span class="linenos">3245</span><span class="w">        </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpiglobal</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3246</span><span class="w">        </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dl1sa2</span><span class="o">*</span><span class="n">gst_getrnnp1</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3247</span><span class="w">        </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dl1sa2</span><span class="o">*</span><span class="n">gst_getrnnp1</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3248</span><span class="w">        </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dl1sa2</span><span class="o">*</span><span class="n">gst_getrnnp1</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3249</span><span class="w">        </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dl1sa2</span><span class="o">*</span><span class="n">gst_getrnnp1</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3250</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">3251</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3252</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3253</span>
<span class="linenos">3254</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(JLAT,JLEV,JLON)</span>
<span class="linenos">3255</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">3256</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">3257</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3258</span><span class="w">          </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3259</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3260</span><span class="k">      enddo</span>
<span class="linenos">3261</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3262</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3263</span>
<span class="linenos">3264</span><span class="w">    </span><span class="k">call </span><span class="n">gst_setID</span><span class="p">(</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3265</span><span class="w">    </span><span class="k">call </span><span class="n">gst_spgd</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">gd</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3266</span>
<span class="linenos">3267</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(JLAT,JLEV,JLON)</span>
<span class="linenos">3268</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">3269</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">3270</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3271</span><span class="w">          </span><span class="n">gd_out</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3272</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3273</span><span class="k">      enddo</span>
<span class="linenos">3274</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3275</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3276</span>
<span class="linenos">3277</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">BHI_SPA2GD</span><span class="w"></span>
<span class="linenos">3278</span>
<span class="linenos">3279</span>
<span class="linenos">3280</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_SPA2GDAD</span><span class="p">(</span><span class="n">gd_in</span><span class="p">,</span><span class="n">hiControlVector_out</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3281</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">3282</span>
<span class="linenos">3283</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nkgdimSqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3284</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">gd_in</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3285</span>
<span class="linenos">3286</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">sptb</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nlev_T_even</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3287</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">nla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3288</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tb0</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nlev_T_even</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3289</span>
<span class="linenos">3290</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">jm</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="w"> </span><span class="n">icount</span><span class="w"></span>
<span class="linenos">3291</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">sq2</span><span class="p">,</span><span class="w"> </span><span class="n">zp</span><span class="w"></span>
<span class="linenos">3292</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zsp</span><span class="p">(:,:,:),</span><span class="w"> </span><span class="n">zsp2</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">3293</span>
<span class="linenos">3294</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jlon</span><span class="p">,</span><span class="w"> </span><span class="n">jlat</span><span class="p">,</span><span class="w"> </span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="w"> </span><span class="n">klatPtoT</span><span class="w"></span>
<span class="linenos">3295</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dl1sa2</span><span class="p">,</span><span class="w"> </span><span class="n">dla2</span><span class="p">,</span><span class="w"> </span><span class="n">zcoriolis</span><span class="p">,</span><span class="w"> </span><span class="n">zpsb</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3296</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zgdpsi</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="p">,</span><span class="n">zgdchi</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">3297</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">target</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nkgdim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3298</span>
<span class="linenos">3299</span><span class="w">    </span><span class="n">klatPtoT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3300</span>
<span class="linenos">3301</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(JLAT,JLEV,JLON)</span>
<span class="linenos">3302</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">3303</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">3304</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3305</span><span class="w">          </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd_in</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3306</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3307</span><span class="k">      enddo</span>
<span class="linenos">3308</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3309</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3310</span>
<span class="linenos">3311</span><span class="w">    </span><span class="k">call </span><span class="n">gst_setID</span><span class="p">(</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3312</span><span class="w">    </span><span class="k">call </span><span class="n">gst_spgda</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">gd</span><span class="p">,</span><span class="n">nlev_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3313</span>
<span class="linenos">3314</span><span class="w">    </span><span class="n">dla2</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">ec_ra</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ec_ra</span><span class="w"></span>
<span class="linenos">3315</span><span class="w">    </span><span class="n">dl1sa2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.d0</span><span class="o">/</span><span class="n">dla2</span><span class="w"></span>
<span class="linenos">3316</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(JLEV,JLA_MPILOCAL,ILA_MPIGLOBAL)</span>
<span class="linenos">3317</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">3318</span><span class="w">      </span><span class="k">do </span><span class="n">jla_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nla_mpilocal</span><span class="w"></span>
<span class="linenos">3319</span><span class="w">        </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpiglobal</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3320</span><span class="w">        </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dl1sa2</span><span class="o">*</span><span class="n">gst_getrnnp1</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3321</span><span class="w">        </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dl1sa2</span><span class="o">*</span><span class="n">gst_getrnnp1</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3322</span><span class="w">        </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dl1sa2</span><span class="o">*</span><span class="n">gst_getrnnp1</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3323</span><span class="w">        </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">jla_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dl1sa2</span><span class="o">*</span><span class="n">gst_getrnnp1</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3324</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">3325</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3326</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3327</span>
<span class="linenos">3328</span><span class="w">    </span><span class="k">call </span><span class="n">gst_setID</span><span class="p">(</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3329</span><span class="w">    </span><span class="k">call </span><span class="n">gst_speree</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">gd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3330</span>
<span class="linenos">3331</span><span class="w">    </span><span class="n">zgdpsi</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:,</span><span class="n">myLatBeg</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nspositVO</span><span class="p">:(</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">nlev_M</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3332</span><span class="w">    </span><span class="n">zgdchi</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:,</span><span class="n">myLatBeg</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">myLonBeg</span><span class="p">:</span><span class="n">myLonEnd</span><span class="p">,</span><span class="n">myLatBeg</span><span class="p">:</span><span class="n">myLatEnd</span><span class="p">,</span><span class="n">nspositDI</span><span class="p">:(</span><span class="n">nspositDI</span><span class="o">+</span><span class="n">nlev_M</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3333</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(jlat,jlev,jlon)</span>
<span class="linenos">3334</span><span class="w">    </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev_bdl</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_M</span><span class="w"></span>
<span class="linenos">3335</span><span class="w">      </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">3336</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3337</span><span class="w">          </span><span class="n">zgdpsi</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zgdpsi</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tantheta</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="o">*</span><span class="n">zgdchi</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3338</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3339</span><span class="k">      enddo</span>
<span class="linenos">3340</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3341</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3342</span>
<span class="linenos">3343</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(jlat,zcoriolis,jlev,jlon,zp)</span>
<span class="linenos">3344</span><span class="w">    </span><span class="k">do </span><span class="n">jlat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLatBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLatEnd</span><span class="w"></span>
<span class="linenos">3345</span><span class="w">      </span><span class="n">zcoriolis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.d0</span><span class="o">*</span><span class="n">ec_Omega</span><span class="o">*</span><span class="n">gst_getRMU</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3346</span><span class="w">      </span><span class="n">tb0</span><span class="p">(:,</span><span class="n">jlat</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3347</span><span class="w">      </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">3348</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3349</span><span class="w">          </span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositTT</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3350</span><span class="w">          </span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">rgsigtb</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3351</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3352</span><span class="k">      enddo</span>
<span class="linenos">3353</span><span class="k">      do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3354</span><span class="w">        </span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositPS</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3355</span><span class="w">        </span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="o">*</span><span class="n">rgsigpsb</span><span class="p">(</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3356</span><span class="w">      </span><span class="k">enddo</span>
<span class="linenos">3357</span>
<span class="linenos">3358</span><span class="k">      do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">3359</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3360</span><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="n">jlev</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">nspositTG</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3361</span><span class="k">            </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">rgsig</span><span class="p">(</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3362</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">3363</span><span class="k">            </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositTG</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositTG</span><span class="p">)</span><span class="o">*</span><span class="n">tgstdbg</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3364</span><span class="w">          </span><span class="k">endif</span>
<span class="linenos">3365</span><span class="k">        enddo</span>
<span class="linenos">3366</span><span class="k">      enddo</span>
<span class="linenos">3367</span>
<span class="linenos">3368</span><span class="k">      do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">3369</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3370</span><span class="w">          </span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoriolis</span><span class="o">*</span><span class="n">tb0</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3371</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3372</span><span class="k">      enddo</span>
<span class="linenos">3373</span>
<span class="linenos">3374</span><span class="k">      do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevPtoT</span><span class="w"></span>
<span class="linenos">3375</span><span class="w">        </span><span class="k">do </span><span class="n">jlon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myLonBeg</span><span class="p">,</span><span class="w"> </span><span class="n">myLonEnd</span><span class="w"></span>
<span class="linenos">3376</span><span class="w">          </span><span class="n">zp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PtoT</span><span class="p">(</span><span class="n">nlev_T</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">,</span><span class="n">klatPtoT</span><span class="p">)</span><span class="o">*</span><span class="n">zpsb</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3377</span><span class="w">          </span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoriolis</span><span class="o">*</span><span class="n">zp</span><span class="o">+</span><span class="n">gd</span><span class="p">(</span><span class="n">jlon</span><span class="p">,</span><span class="n">jlat</span><span class="p">,</span><span class="n">nspositVO</span><span class="o">+</span><span class="n">jlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3378</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3379</span><span class="k">      enddo</span>
<span class="linenos">3380</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3381</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO </span>
<span class="linenos">3382</span>
<span class="linenos">3383</span><span class="w">    </span><span class="k">call </span><span class="n">gst_setID</span><span class="p">(</span><span class="n">gstID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3384</span><span class="w">    </span><span class="k">call </span><span class="n">gst_reespe</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">gd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3385</span><span class="w">    </span><span class="k">call </span><span class="n">gst_setID</span><span class="p">(</span><span class="n">gstID2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3386</span><span class="w">    </span><span class="k">call </span><span class="n">gst_reespe</span><span class="p">(</span><span class="n">sptb</span><span class="p">,</span><span class="n">tb0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3387</span>
<span class="linenos">3388</span><span class="w">    </span><span class="n">hiControlVector_out</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3389</span><span class="w">    </span><span class="n">sq2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">2.0d0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3390</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">zsp</span><span class="p">(</span><span class="n">nkgdimSqrt</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">mymCount</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3391</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">zsp2</span><span class="p">(</span><span class="n">nkgdim2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">mymCount</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3392</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(JN,JM,JLEV,ILA_MPILOCAL,ILA_MPIGLOBAL,zsp,zsp2,icount)</span>
<span class="linenos">3393</span><span class="w">    </span><span class="k">do </span><span class="n">jn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mynBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mynEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mynSkip</span><span class="w"></span>
<span class="linenos">3394</span>
<span class="linenos">3395</span><span class="w">      </span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3396</span><span class="w">      </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="w"> </span><span class="n">mymEnd</span><span class="p">,</span><span class="w"> </span><span class="n">mymSkip</span><span class="w"></span>
<span class="linenos">3397</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">jm</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">jn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3398</span><span class="k">          </span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icount</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3399</span><span class="w">          </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNind</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">3400</span><span class="w">          </span><span class="n">ila_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3401</span><span class="w">          </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdim</span><span class="w"></span>
<span class="linenos">3402</span><span class="w">            </span><span class="n">zsp2</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3403</span><span class="w">            </span><span class="n">zsp2</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sp</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3404</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">3405</span><span class="k">          do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_T</span><span class="w"></span>
<span class="linenos">3406</span><span class="w">            </span><span class="n">zsp2</span><span class="p">(</span><span class="n">jlev</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sptb</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3407</span><span class="w">            </span><span class="n">zsp2</span><span class="p">(</span><span class="n">jlev</span><span class="o">+</span><span class="n">nkgdim</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sptb</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3408</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">3409</span><span class="k">        endif</span>
<span class="linenos">3410</span><span class="k">      enddo</span>
<span class="linenos">3411</span>
<span class="linenos">3412</span><span class="k">      if</span><span class="p">(</span><span class="n">icount</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3413</span>
<span class="linenos">3414</span><span class="k">        CALL </span><span class="n">DGEMM</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="n">nkgdimSqrt</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">icount</span><span class="p">,</span><span class="n">nkgdim2</span><span class="p">,</span><span class="mf">1.0d0</span><span class="p">,</span><span class="n">corns</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jn</span><span class="p">),</span><span class="n">nkgdim2</span><span class="p">,</span><span class="n">zsp2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">nkgdim2</span><span class="p">,</span><span class="mf">0.0d0</span><span class="p">,</span><span class="n">zsp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">nkgdimSqrt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3415</span>
<span class="linenos">3416</span><span class="w">        </span><span class="n">icount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3417</span><span class="w">        </span><span class="k">do </span><span class="n">jm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mymBeg</span><span class="p">,</span><span class="w"> </span><span class="n">jn</span><span class="p">,</span><span class="w"> </span><span class="n">mymSkip</span><span class="w"></span>
<span class="linenos">3418</span><span class="w">          </span><span class="n">icount</span><span class="o">=</span><span class="n">icount</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3419</span><span class="w">          </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="n">jm</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jm</span><span class="w"></span>
<span class="linenos">3420</span><span class="w">          </span><span class="n">ila_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3421</span><span class="w">          </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">3422</span><span class="w">            </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3423</span><span class="w">            </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zsp</span><span class="p">(</span><span class="n">jlev</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">icount</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3424</span><span class="w">          </span><span class="k">enddo</span>
<span class="linenos">3425</span><span class="k">        enddo</span>
<span class="linenos">3426</span>
<span class="linenos">3427</span><span class="k">      endif</span><span class="w"></span>
<span class="linenos">3428</span>
<span class="linenos">3429</span><span class="w">      </span><span class="c">! make adjustments for jm=0</span>
<span class="linenos">3430</span><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">mymBeg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3431</span>
<span class="linenos">3432</span><span class="k">        </span><span class="n">ila_mpiglobal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_getNIND</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">gstID</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jn</span><span class="w"></span>
<span class="linenos">3433</span><span class="w">        </span><span class="n">ila_mpilocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilaList_mpilocal</span><span class="p">(</span><span class="n">ila_mpiglobal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3434</span>
<span class="linenos">3435</span><span class="w">        </span><span class="k">do </span><span class="n">jlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nkgdimSqrt</span><span class="w"></span>
<span class="linenos">3436</span><span class="w">          </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">sq2</span><span class="w"></span>
<span class="linenos">3437</span><span class="w">          </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hiControlVector_out</span><span class="p">(</span><span class="n">ila_mpilocal</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">jlev</span><span class="p">)</span><span class="o">*</span><span class="n">sq2</span><span class="w"></span>
<span class="linenos">3438</span><span class="w">        </span><span class="k">enddo</span>
<span class="linenos">3439</span>
<span class="linenos">3440</span><span class="k">      endif</span>
<span class="linenos">3441</span>
<span class="linenos">3442</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">3443</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3444</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">zsp</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3445</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">zsp2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3446</span>
<span class="linenos">3447</span><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">BHI_SPA2GDAD</span><span class="w"></span>
<span class="linenos">3448</span>
<span class="linenos">3449</span>
<span class="linenos">3450</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">BHI_Finalize</span><span class="p">()</span><span class="w"></span>
<span class="linenos">3451</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">3452</span>
<span class="linenos">3453</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">initialized</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3454</span><span class="k">       deallocate</span><span class="p">(</span><span class="n">pressureProfile_M</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3455</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">pressureProfile_T</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3456</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">PtoT</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3457</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">tantheta</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3458</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">rgsig</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3459</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">tgstdbg</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3460</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">rgsigtb</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3461</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">rgsigpsb</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3462</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">corns</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3463</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">rstddev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3464</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">3465</span>
<span class="linenos">3466</span><span class="k">  END SUBROUTINE </span><span class="n">BHI_Finalize</span><span class="w"></span>
<span class="linenos">3467</span>
<span class="linenos">3468</span>
<span class="linenos">3469</span><span class="k">END MODULE </span><span class="n">BmatrixHI_mod</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</section>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li><a href="../index.html">MIDAS  documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2018, ECCC.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>
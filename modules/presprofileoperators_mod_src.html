<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>presprofileoperators_mod source &mdash; MIDAS  documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="MIDAS  documentation" href="../index.html" /> 
  </head>
  <body>
  <div>
    <img src="../_static/MIDAS_header.png" alt="MIDAS" />
  </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li><a href="../index.html">MIDAS  documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/modules/presprofileoperators_mod_src.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <section id="presprofileoperators-mod-source">
<h1>presprofileoperators_mod source<a class="headerlink" href="#presprofileoperators-mod-source" title="Permalink to this headline">Â¶</a></h1>
<blockquote>
<div><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="c">!-------------------------------------- LICENCE BEGIN ------------------------------------</span>
<span class="linenos">   2</span><span class="c">!Environment Canada - Atmospheric Science and Technology License/Disclaimer,</span>
<span class="linenos">   3</span><span class="c">!                     version 3; Last Modified: May 7, 2008.</span>
<span class="linenos">   4</span><span class="c">!This is free but copyrighted software; you can use/redistribute/modify it under the terms</span>
<span class="linenos">   5</span><span class="c">!of the Environment Canada - Atmospheric Science and Technology License/Disclaimer</span>
<span class="linenos">   6</span><span class="c">!version 3 or (at your option) any later version that should be found at:</span>
<span class="linenos">   7</span><span class="c">!http://collaboration.cmc.ec.gc.ca/science/rpn.comm/license.html</span>
<span class="linenos">   8</span><span class="c">!</span>
<span class="linenos">   9</span><span class="c">!This software is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;</span>
<span class="linenos">  10</span><span class="c">!without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="linenos">  11</span><span class="c">!See the above mentioned License/Disclaimer for more details.</span>
<span class="linenos">  12</span><span class="c">!You should have received a copy of the License/Disclaimer along with this software;</span>
<span class="linenos">  13</span><span class="c">!if not, you can write to: EC-RPN COMM Group, 2121 TransCanada, suite 500, Dorval (Quebec),</span>
<span class="linenos">  14</span><span class="c">!CANADA, H9P 1J3; or send e-mail to service.rpn@ec.gc.ca</span>
<span class="linenos">  15</span><span class="c">!-------------------------------------- LICENCE END --------------------------------------</span>
<span class="linenos">  16</span>
<span class="linenos">  17</span><span class="k">module </span><span class="n">presProfileOperators_mod</span><span class="w"></span>
<span class="linenos">  18</span><span class="w">  </span><span class="c">! MODULE presProfileOperators_mod (prefix=&#39;ppo&#39; category=&#39;8. Low-level utilities and constants&#39;)</span>
<span class="linenos">  19</span><span class="w">  </span><span class="c">!</span>
<span class="linenos">  20</span><span class="w">  </span><span class="c">!:Purpose: Vertical interpolation, integration, and layer averaging subroutines.</span>
<span class="linenos">  21</span><span class="w">  </span><span class="c">!           Includes the special routines designed to interpolate to the </span>
<span class="linenos">  22</span><span class="w">  </span><span class="c">!           (widely spaced) RTTOV pressure levels.</span>
<span class="linenos">  23</span><span class="w">  </span><span class="c">!</span>
<span class="linenos">  24</span><span class="w">  </span><span class="k">use </span><span class="n">utilities_mod</span><span class="w"></span>
<span class="linenos">  25</span>
<span class="linenos">  26</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos">  27</span><span class="k">  save</span>
<span class="linenos">  28</span><span class="k">  private</span><span class="w"></span>
<span class="linenos">  29</span>
<span class="linenos">  30</span><span class="w">  </span><span class="c">! public procedures</span>
<span class="linenos">  31</span><span class="w">  </span>
<span class="linenos">  32</span><span class="w">  </span><span class="c">! Linear interpolation routine</span>
<span class="linenos">  33</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ppo_lintv</span><span class="w"></span>
<span class="linenos">  34</span><span class="w">  </span>
<span class="linenos">  35</span><span class="w">  </span><span class="c">! Stand-alone interpolator calling routine providing interpolation weights </span>
<span class="linenos">  36</span><span class="w">  </span><span class="c">! For weights W(:,:) and initial vector X(:), the interpolated vector would be W*X</span>
<span class="linenos">  37</span><span class="w">  </span><span class="c">! Will call one of the following prodedures:</span>
<span class="linenos">  38</span><span class="w">  </span><span class="c">!    ppo_layeravgInterpWgts     - weights for linear piecewise weighted averaging interpolation</span>
<span class="linenos">  39</span><span class="w">  </span><span class="c">!    ppo_piecewiseLinearWgts    - weights for piecewise linear interpolation</span>
<span class="linenos">  40</span><span class="w">  </span><span class="c">! The first of routines is similar in content to those used with RTTOV pressure levels.</span>
<span class="linenos">  41</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ppo_vertInterpWgts</span><span class="w">    </span><span class="c">! Main call routine</span>
<span class="linenos">  42</span>
<span class="linenos">  43</span><span class="w">  </span><span class="c">! Routines common to ppo_vertIntegWgts and ppo_vertAvgWgts indicated below.</span>
<span class="linenos">  44</span><span class="w">  </span><span class="c">!     ppo_getLevelIndex - get the vertical input level index for level</span>
<span class="linenos">  45</span><span class="w">  </span><span class="c">!                         within target layer and nearest specified layer boundary</span>
<span class="linenos">  46</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ppo_vertLayersSetup</span><span class="w"></span>
<span class="linenos">  47</span><span class="w">  </span>
<span class="linenos">  48</span><span class="w">  </span><span class="c">! Work arrays for ppo_vertInteg* and ppo_vertAvg*</span>
<span class="linenos">  49</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(:),</span><span class="w"> </span><span class="n">weights</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">  50</span><span class="w">  </span>
<span class="linenos">  51</span><span class="w">  </span><span class="c">! Stand-alone integration routines providing integration weights </span>
<span class="linenos">  52</span><span class="w">  </span><span class="c">! For weights W(:,:) and initial vector X(:), the integrated values would be W*X  </span>
<span class="linenos">  53</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ppo_vertIntegWgts</span><span class="w"></span>
<span class="linenos">  54</span>
<span class="linenos">  55</span><span class="w">  </span><span class="c">! Stand-alone layer averaging routine (in lp(P)) providing weights </span>
<span class="linenos">  56</span><span class="w">  </span><span class="c">! For weights W(:,:) and initial vector X(:), the average values would be W*X  </span>
<span class="linenos">  57</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ppo_vertAvgWgts</span><span class="w"></span>
<span class="linenos">  58</span><span class="w">  </span>
<span class="linenos">  59</span><span class="w">  </span><span class="k">contains</span><span class="w"></span>
<span class="linenos">  60</span>
<span class="linenos">  61</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">  62</span><span class="w">  </span><span class="c">! PPO_LINTV</span>
<span class="linenos">  63</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">  64</span><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">PPO_LINTV</span><span class="w"> </span><span class="p">(</span><span class="n">PVLEV</span><span class="p">,</span><span class="n">PVI</span><span class="p">,</span><span class="n">KNI</span><span class="p">,</span><span class="w"> </span><span class="n">KNPROF</span><span class="p">,</span><span class="n">KNO</span><span class="p">,</span><span class="n">PPO</span><span class="p">,</span><span class="n">PVO</span><span class="p">)</span><span class="w"></span>
<span class="linenos">  65</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">  66</span><span class="w">      </span><span class="c">!:Purpose: To perform the vertical interpolation in log of pressure and</span>
<span class="linenos">  67</span><span class="w">      </span><span class="c">!          constant-value extrapolation of one-dimensional vectors. Input</span>
<span class="linenos">  68</span><span class="w">      </span><span class="c">!          pressure levels can vary for each profile.</span>
<span class="linenos">  69</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">  70</span><span class="w">      </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">  71</span>
<span class="linenos">  72</span><span class="w">      </span><span class="c">! Arguments:</span>
<span class="linenos">  73</span><span class="w">      </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">pvlev</span><span class="p">(</span><span class="n">kni</span><span class="p">,</span><span class="n">knprof</span><span class="p">)</span><span class="w"> </span><span class="c">! Vertical levels, pressure (source)</span>
<span class="linenos">  74</span><span class="w">      </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">pvi</span><span class="p">(</span><span class="n">kni</span><span class="p">,</span><span class="n">knprof</span><span class="p">)</span><span class="w">   </span><span class="c">! Vector to be interpolated (source)</span>
<span class="linenos">  75</span><span class="w">      </span><span class="kt">integer</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">kni</span><span class="w">               </span><span class="c">! Number of input levels (source)</span>
<span class="linenos">  76</span><span class="w">      </span><span class="kt">integer</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">knprof</span><span class="w">            </span><span class="c">! Number of profiles</span>
<span class="linenos">  77</span><span class="w">      </span><span class="kt">integer</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">kno</span><span class="w">               </span><span class="c">! Number of output levels (destination)</span>
<span class="linenos">  78</span><span class="w">      </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ppo</span><span class="p">(</span><span class="n">kno</span><span class="p">,</span><span class="n">knprof</span><span class="p">)</span><span class="w">   </span><span class="c">! Vertical levels, pressure (destination)</span>
<span class="linenos">  79</span><span class="w">      </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pvo</span><span class="p">(</span><span class="n">kno</span><span class="p">,</span><span class="n">knprof</span><span class="p">)</span><span class="w">   </span><span class="c">! Interpolated profiles (destination)</span>
<span class="linenos">  80</span>
<span class="linenos">  81</span><span class="w">      </span><span class="c">! Locals:</span>
<span class="linenos">  82</span><span class="w">      </span><span class="kt">INTEGER  </span><span class="n">JI</span><span class="p">,</span><span class="w"> </span><span class="n">JK</span><span class="p">,</span><span class="w"> </span><span class="n">JO</span><span class="p">,</span><span class="w"> </span><span class="n">profileIndex</span><span class="p">,</span><span class="w"> </span><span class="n">IK</span><span class="p">,</span><span class="w"> </span><span class="n">IORDER</span><span class="w"></span>
<span class="linenos">  83</span><span class="w">      </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">     </span><span class="n">ZPI</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">KNI</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">KNPROF</span><span class="p">)</span><span class="w"></span>
<span class="linenos">  84</span><span class="w">      </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">     </span><span class="n">ZPVI</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">KNI</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">KNPROF</span><span class="p">)</span><span class="w"></span>
<span class="linenos">  85</span><span class="w">      </span><span class="kt">INTEGER  </span><span class="n">IL</span><span class="w">  </span><span class="p">(</span><span class="n">KNO</span><span class="w">    </span><span class="p">,</span><span class="n">KNPROF</span><span class="p">)</span><span class="w"></span>
<span class="linenos">  86</span><span class="w">      </span>
<span class="linenos">  87</span><span class="w">      </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">ZW1</span><span class="p">,</span><span class="w"> </span><span class="n">ZW2</span><span class="w"></span>
<span class="linenos">  88</span><span class="w">      </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="n">ZP</span><span class="p">,</span><span class="w"> </span><span class="n">XI</span><span class="p">,</span><span class="w"> </span><span class="n">ZRT</span><span class="p">,</span><span class="w"> </span><span class="n">ZP1</span><span class="p">,</span><span class="w"> </span><span class="n">ZP2</span><span class="w"></span>
<span class="linenos">  89</span>
<span class="linenos">  90</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">  91</span><span class="w">      </span><span class="c">!**   1. Initialization for vertical extrapolation (extra dummy levels)</span>
<span class="linenos">  92</span><span class="w">      </span><span class="c">!     .  --------------------------------------------------------------</span>
<span class="linenos">  93</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">  94</span><span class="w">      </span>
<span class="linenos">  95</span><span class="w">      </span><span class="n">ZPI</span><span class="p">(</span><span class="mi">0</span><span class="p">,:)</span><span class="o">=</span><span class="mi">200</span><span class="mf">0.D0</span><span class="w"></span>
<span class="linenos">  96</span><span class="w">      </span><span class="n">ZPI</span><span class="p">(</span><span class="n">KNI</span><span class="o">+</span><span class="mi">1</span><span class="p">,:)</span><span class="o">=</span><span class="mi">200</span><span class="mf">0.D0</span><span class="w"></span>
<span class="linenos">  97</span><span class="w">      </span>
<span class="linenos">  98</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">  99</span><span class="w">      </span><span class="c">!**      1.1 Determine if input pressure levels are in ascending or</span>
<span class="linenos"> 100</span><span class="w">      </span><span class="c">!     .      descending order.</span>
<span class="linenos"> 101</span><span class="w">      </span><span class="c">!     .     -------------------------------------------------------</span>
<span class="linenos"> 102</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 103</span><span class="w">      </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PVLEV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="o">&lt;</span><span class="w">  </span><span class="n">PVLEV</span><span class="p">(</span><span class="n">KNI</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<span class="linenos"> 104</span><span class="k">         </span><span class="n">IORDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 105</span><span class="w">      </span><span class="k">ELSE</span>
<span class="linenos"> 106</span><span class="k">         </span><span class="n">IORDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 107</span><span class="w">      </span><span class="k">END IF</span><span class="w"></span>
<span class="linenos"> 108</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 109</span><span class="w">      </span><span class="c">!**   2. Compute pressure levels pressure</span>
<span class="linenos"> 110</span><span class="w">      </span><span class="c">!     .  ------------------------------------------------</span>
<span class="linenos"> 111</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 112</span>
<span class="linenos"> 113</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 114</span><span class="w">      </span><span class="c">!**   2.1 Source levels</span>
<span class="linenos"> 115</span><span class="w">      </span><span class="c">!     .   -------------</span>
<span class="linenos"> 116</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 117</span><span class="w">          </span>
<span class="linenos"> 118</span><span class="w">      </span><span class="n">ZPI</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">KNI</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PVLEV</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">KNI</span><span class="p">,:)</span><span class="w"></span>
<span class="linenos"> 119</span>
<span class="linenos"> 120</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 121</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 122</span><span class="w">      </span><span class="c">!*    3.  Interpolate in log of pressure or extrapolate with constant value</span>
<span class="linenos"> 123</span><span class="w">      </span><span class="c">!*    .   for each destination pressure level</span>
<span class="linenos"> 124</span><span class="w">      </span><span class="c">!     .   -----------------------------------------------------------------</span>
<span class="linenos"> 125</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 126</span>
<span class="linenos"> 127</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 128</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 129</span><span class="w">      </span><span class="c">!*    .  3.1  Find the adjacent level below</span>
<span class="linenos"> 130</span><span class="w">      </span><span class="c">!     .       -----------------------------</span>
<span class="linenos"> 131</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 132</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 133</span><span class="w">      </span>
<span class="linenos"> 134</span><span class="w">      </span><span class="n">IL</span><span class="p">(:,:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 135</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 136</span><span class="w">      </span><span class="k">DO </span><span class="n">JI</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">KNI</span><span class="w"></span>
<span class="linenos"> 137</span><span class="w">         </span><span class="k">DO </span><span class="n">profileIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">KNPROF</span><span class="w"></span>
<span class="linenos"> 138</span><span class="w">            </span><span class="k">DO </span><span class="n">JO</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">KNO</span><span class="w"></span>
<span class="linenos"> 139</span><span class="w">              </span><span class="n">ZRT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PPO</span><span class="p">(</span><span class="n">JO</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 140</span><span class="w">               </span><span class="n">ZP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZPI</span><span class="p">(</span><span class="n">JI</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 141</span><span class="w">               </span><span class="n">XI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">SIGN</span><span class="p">(</span><span class="mf">1.0D0</span><span class="p">,</span><span class="n">IORDER</span><span class="o">*</span><span class="p">(</span><span class="n">ZRT</span><span class="o">-</span><span class="n">ZP</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 142</span><span class="w">               </span><span class="n">IL</span><span class="p">(</span><span class="n">JO</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IL</span><span class="p">(</span><span class="n">JO</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">MAX</span><span class="p">(</span><span class="mf">0.0D0</span><span class="p">,</span><span class="n">XI</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 143</span><span class="w">            </span><span class="k">END DO</span>
<span class="linenos"> 144</span><span class="k">         END DO</span>
<span class="linenos"> 145</span><span class="k">      END DO</span><span class="w"></span>
<span class="linenos"> 146</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 147</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 148</span><span class="w">      </span><span class="c">!*    .  3.2  Fill extra levels, for constant value extrapolation</span>
<span class="linenos"> 149</span><span class="w">      </span><span class="c">!     .       ---------------------------------------------------</span>
<span class="linenos"> 150</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 151</span><span class="w">      </span>
<span class="linenos"> 152</span><span class="w">      </span><span class="k">DO </span><span class="n">profileIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">KNPROF</span><span class="w"></span>
<span class="linenos"> 153</span><span class="w">         </span><span class="k">DO </span><span class="n">JK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">KNI</span><span class="w"></span>
<span class="linenos"> 154</span><span class="w">            </span><span class="n">ZPVI</span><span class="p">(</span><span class="n">JK</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PVI</span><span class="p">(</span><span class="n">JK</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 155</span><span class="w">         </span><span class="k">END DO</span>
<span class="linenos"> 156</span><span class="k">      END DO</span>
<span class="linenos"> 157</span><span class="k">      DO </span><span class="n">profileIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">KNPROF</span><span class="w"></span>
<span class="linenos"> 158</span><span class="w">         </span><span class="n">ZPVI</span><span class="p">(</span><span class="mi">0</span><span class="w">    </span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PVI</span><span class="p">(</span><span class="mi">1</span><span class="w">  </span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 159</span><span class="w">         </span><span class="n">ZPVI</span><span class="p">(</span><span class="n">KNI</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PVI</span><span class="p">(</span><span class="n">KNI</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 160</span><span class="w">      </span><span class="k">END DO</span><span class="w"></span>
<span class="linenos"> 161</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 162</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 163</span><span class="w">      </span><span class="c">!*    .  3.3  Interpolation/extrapolation</span>
<span class="linenos"> 164</span><span class="w">      </span><span class="c">!     .       ---------------------------</span>
<span class="linenos"> 165</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 166</span><span class="w">      </span>
<span class="linenos"> 167</span><span class="w">      </span><span class="k">DO </span><span class="n">profileIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">KNPROF</span><span class="w"></span>
<span class="linenos"> 168</span><span class="w">        </span><span class="k">DO </span><span class="n">JO</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">KNO</span><span class="w"></span>
<span class="linenos"> 169</span><span class="w">          </span><span class="n">ZP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PPO</span><span class="p">(</span><span class="n">JO</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 170</span><span class="w">          </span><span class="n">IK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IL</span><span class="p">(</span><span class="n">JO</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 171</span><span class="w">          </span><span class="n">ZP1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZPI</span><span class="p">(</span><span class="n">IK</span><span class="w">  </span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 172</span><span class="w">          </span><span class="n">ZP2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZPI</span><span class="p">(</span><span class="n">IK</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 173</span><span class="w">          </span><span class="n">ZW1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">LOG</span><span class="p">(</span><span class="n">ZP</span><span class="o">/</span><span class="n">ZP2</span><span class="p">)</span><span class="o">/</span><span class="nb">LOG</span><span class="p">(</span><span class="n">ZP1</span><span class="o">/</span><span class="n">ZP2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 174</span><span class="w">          </span><span class="n">ZW2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.D0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ZW1</span><span class="w"></span>
<span class="linenos"> 175</span><span class="w">          </span><span class="n">PVO</span><span class="p">(</span><span class="n">JO</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZW1</span><span class="o">*</span><span class="n">ZPVI</span><span class="p">(</span><span class="n">IK</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="n">ZW2</span><span class="o">*</span><span class="n">ZPVI</span><span class="p">(</span><span class="n">IK</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">profileIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 176</span><span class="w">        </span><span class="k">END DO</span>
<span class="linenos"> 177</span><span class="k">      END DO</span>
<span class="linenos"> 178</span><span class="k">           </span>
<span class="linenos"> 179</span><span class="k">  END SUBROUTINE </span><span class="n">PPO_LINTV</span><span class="w"></span>
<span class="linenos"> 180</span>
<span class="linenos"> 181</span><span class="w">  </span><span class="c">!==========================================================================</span>
<span class="linenos"> 182</span><span class="w">  </span><span class="c">!---- Stand-alone interpolation routine providing interpolation weights ---</span>
<span class="linenos"> 183</span><span class="w">  </span><span class="c">! For weights W(:,:) and initial vector X(:), the integrated values would be W*X.  </span>
<span class="linenos"> 184</span>
<span class="linenos"> 185</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 186</span><span class="w">  </span><span class="c">! ppo_vertInterpWgts</span>
<span class="linenos"> 187</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 188</span><span class="w">  </span><span class="k">subroutine </span><span class="n">ppo_vertInterpWgts</span><span class="p">(</span><span class="n">pressInput</span><span class="p">,</span><span class="n">pressTarget</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">,</span><span class="n">numTargetLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 189</span><span class="w">                                 </span><span class="n">wgts</span><span class="p">,</span><span class="n">kstart</span><span class="p">,</span><span class="n">kend</span><span class="p">,</span><span class="n">method_opt</span><span class="p">,</span><span class="n">skipType_opt</span><span class="p">,</span><span class="n">outbound_opt</span><span class="p">,</span><span class="n">success_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 190</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 191</span><span class="w">    </span><span class="c">!:Purpose: Determination of interpolation weights for interpolation to points </span>
<span class="linenos"> 192</span><span class="w">    </span><span class="c">!          in a profile. Applies interpolation in log(Pressure).</span>
<span class="linenos"> 193</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 194</span><span class="w">    </span><span class="c">!:Input:</span>
<span class="linenos"> 195</span><span class="w">    </span><span class="c">!       :pressInput:       pressure on reference column levels assumed to be in ascending order</span>
<span class="linenos"> 196</span><span class="w">    </span><span class="c">!       :pressTarget:      target pressure levels assumed to be in ascending order</span>
<span class="linenos"> 197</span><span class="w">    </span><span class="c">!       :numInputLevs:     number of input/reference levels</span>
<span class="linenos"> 198</span><span class="w">    </span><span class="c">!       :numTargetLevs:    number of target levels</span>
<span class="linenos"> 199</span><span class="w">    </span><span class="c">!       :method_opt:       Specified interpolation method</span>
<span class="linenos"> 200</span><span class="w">    </span><span class="c">!       :skipType_opt:     Skipping processing of specific target levels depending on case:</span>
<span class="linenos"> 201</span><span class="w">    </span><span class="c">!                          &#39;default&#39;  - extrapolation allowed and skipping application via input success_opt only</span>
<span class="linenos"> 202</span><span class="w">    </span><span class="c">!                          &#39;noExtrap&#39; - no extrapolation as well as additional skipping via input success_opt</span>
<span class="linenos"> 203</span><span class="w">    </span><span class="c">!                          &#39;doAll&amp;noExtrap&#39;  - no extrapolation only (all other levels processed)</span>
<span class="linenos"> 204</span><span class="w">    </span><span class="c">!:InOut:</span>
<span class="linenos"> 205</span><span class="w">    </span><span class="c">!       :outbound_opt:     Flag set when beyond range of reference levels</span>
<span class="linenos"> 206</span><span class="w">    </span><span class="c">!       :success_opt:      LOgical indicating a valid target level</span>
<span class="linenos"> 207</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 208</span><span class="w">    </span><span class="c">!:Output:</span>
<span class="linenos"> 209</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 210</span><span class="w">    </span><span class="c">!       :wgts:             Interpolation coefficients/weights</span>
<span class="linenos"> 211</span><span class="w">    </span><span class="c">!       :kstart:           Index of first relevant referenence/input level for each target level</span>
<span class="linenos"> 212</span><span class="w">    </span><span class="c">!       :kend:             Index of last relevant referenence/input level for each target levbel</span>
<span class="linenos"> 213</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 214</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos"> 215</span>
<span class="linenos"> 216</span><span class="w">    </span><span class="c">! Arguments:    </span>
<span class="linenos"> 217</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">numInputLevs</span><span class="w">  </span><span class="c">! # of original/input vertical levels</span>
<span class="linenos"> 218</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">numTargetLevs</span><span class="w"> </span><span class="c">! # of target vertical levels</span>
<span class="linenos"> 219</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pressInput</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w">  </span><span class="c">! pressure on reference column levels assumed to be in ascending order</span>
<span class="linenos"> 220</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pressTarget</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! target pressure levels assumed to be in ascending order</span>
<span class="linenos"> 221</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">method_opt</span><span class="w">   </span><span class="c">! Specified interpolation method</span>
<span class="linenos"> 222</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skipType_opt</span><span class="w"> </span><span class="c">! Skipping processing of specific target levels depending on case</span>
<span class="linenos"> 223</span>
<span class="linenos"> 224</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">outbound_opt</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Flag indicating if obs outside model vertical range (0 for no)</span>
<span class="linenos"> 225</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success_opt</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w">  </span><span class="c">! success of interpolation</span>
<span class="linenos"> 226</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">wgts</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Averaging weights</span>
<span class="linenos"> 227</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kstart</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Index of first relevant original/input level for each target level</span>
<span class="linenos"> 228</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kend</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w">   </span><span class="c">! Index of last relevant original/input level for each target level</span>
<span class="linenos"> 229</span>
<span class="linenos"> 230</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos"> 231</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TargetIndex</span><span class="w"> </span>
<span class="linenos"> 232</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">logPressInput</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">),</span><span class="n">logPressTarget</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 233</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pieceLinearWgts</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 234</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 235</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="n">skipType</span><span class="w"></span>
<span class="linenos"> 236</span>
<span class="linenos"> 237</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">method_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 238</span><span class="k">      </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method_opt</span><span class="w"></span>
<span class="linenos"> 239</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 240</span><span class="k">      </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos"> 241</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 242</span><span class="k">        </span>
<span class="linenos"> 243</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">skipType_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 244</span><span class="k">      </span><span class="n">skipType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skipType_opt</span><span class="w"></span>
<span class="linenos"> 245</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 246</span><span class="k">      </span><span class="n">skipType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos"> 247</span><span class="w">    </span><span class="k">end if </span>
<span class="linenos"> 248</span><span class="k"> </span>
<span class="linenos"> 249</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">success_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 250</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">skipType</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;doAll&amp;noExtrap&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 251</span><span class="k">        </span><span class="n">success</span><span class="p">(:)</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 252</span><span class="w">      </span><span class="k">else</span>
<span class="linenos"> 253</span><span class="k">        </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">success_opt</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 254</span><span class="w">      </span><span class="k">end if </span>
<span class="linenos"> 255</span><span class="k">    else</span>
<span class="linenos"> 256</span><span class="k">      </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 257</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos"> 258</span><span class="w">    </span>
<span class="linenos"> 259</span><span class="w">    </span><span class="c">! Flag to prevent extrapolation beyond the range of the reference column levels</span>
<span class="linenos"> 260</span><span class="w">        </span>
<span class="linenos"> 261</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">skipType</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;noExtrap&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">skipType</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;doAll&amp;noExtrap&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 262</span>
<span class="linenos"> 263</span><span class="k">      do </span><span class="n">TargetIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numTargetLevs</span><span class="w"></span>
<span class="linenos"> 264</span>
<span class="linenos"> 265</span><span class="w">        </span><span class="c">! Check if target level is outside reference column range</span>
<span class="linenos"> 266</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PressTarget</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PressInput</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 267</span><span class="w">             </span><span class="n">PressTarget</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">PressInput</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 268</span><span class="k">          </span><span class="n">success</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 269</span><span class="w">          </span><span class="n">success_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 270</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">present</span><span class="p">(</span><span class="n">outbound_opt</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="linenos"> 271</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">PressTarget</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">PressInput</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 272</span><span class="k">            </span><span class="n">outbound_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 273</span><span class="w">          </span><span class="k">else</span>
<span class="linenos"> 274</span><span class="k">            </span><span class="n">outbound_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>
<span class="linenos"> 275</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos"> 276</span><span class="k">        end if</span>
<span class="linenos"> 277</span><span class="k">      end do</span>
<span class="linenos"> 278</span><span class="k">    end if</span>
<span class="linenos"> 279</span><span class="k">        </span>
<span class="linenos"> 280</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 281</span>
<span class="linenos"> 282</span><span class="w">      </span><span class="c">! Piecewise log-linear interpolation</span>
<span class="linenos"> 283</span><span class="w">      </span>
<span class="linenos"> 284</span><span class="w">      </span><span class="n">logPressInput</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">PressInput</span><span class="p">(:))</span><span class="w"></span>
<span class="linenos"> 285</span><span class="w">      </span><span class="n">logPressTarget</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">PressTarget</span><span class="p">(:))</span><span class="w"></span>
<span class="linenos"> 286</span>
<span class="linenos"> 287</span><span class="w">      </span><span class="k">call </span><span class="n">ppo_piecewiseLinearWgts</span><span class="p">(</span><span class="n">logPressTarget</span><span class="p">,</span><span class="n">logPressInput</span><span class="p">,</span><span class="n">numTargetLevs</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 288</span><span class="w">                                 </span><span class="n">pieceLinearWgts</span><span class="p">,</span><span class="n">kstart</span><span class="p">,</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 289</span><span class="w">                                              </span>
<span class="linenos"> 290</span><span class="w">      </span><span class="n">kend</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kstart</span><span class="p">(:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">      </span>
<span class="linenos"> 291</span><span class="w">      </span><span class="k">do </span><span class="n">TargetIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numTargetLevs</span><span class="w"></span>
<span class="linenos"> 292</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">success</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 293</span><span class="k">          </span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">      </span>
<span class="linenos"> 294</span><span class="w">          </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">))</span><span class="o">=</span><span class="n">pieceLinearWgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 295</span><span class="w">          </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">))</span><span class="o">=</span><span class="n">pieceLinearWgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 296</span><span class="w">        </span><span class="k">else</span>
<span class="linenos"> 297</span><span class="k">          </span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 298</span><span class="w">          </span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 299</span><span class="w">          </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 300</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos"> 301</span><span class="k">      end do</span>
<span class="linenos"> 302</span>
<span class="linenos"> 303</span><span class="k">    else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">method</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;wgtAvg&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">numTargetLevs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 304</span><span class="w">    </span>
<span class="linenos"> 305</span><span class="w">      </span><span class="c">! Piecewise weighted averaging according to distance </span>
<span class="linenos"> 306</span><span class="w">      </span><span class="c">! Involves all model levels within the profile range</span>
<span class="linenos"> 307</span><span class="w">      </span>
<span class="linenos"> 308</span><span class="w">      </span><span class="n">logPressInput</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">PressInput</span><span class="p">(:))</span><span class="w"></span>
<span class="linenos"> 309</span><span class="w">      </span><span class="n">logPressTarget</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">PressTarget</span><span class="p">(:))</span><span class="w"></span>
<span class="linenos"> 310</span><span class="w">      </span>
<span class="linenos"> 311</span><span class="w">      </span><span class="k">call </span><span class="n">ppo_layeravgInterpWgts</span><span class="p">(</span><span class="n">logPressTarget</span><span class="p">,</span><span class="n">logPressInput</span><span class="p">,</span><span class="n">numTargetLevs</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 312</span><span class="w">                                  </span><span class="n">wgts</span><span class="p">,</span><span class="n">kstart</span><span class="p">,</span><span class="n">kend</span><span class="p">,</span><span class="n">validLevel_opt</span><span class="o">=</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 313</span>
<span class="linenos"> 314</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 315</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;ppo_vertInterpWgts: This interpolation observation operator is not recognized&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 316</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 317</span><span class="k">    </span>
<span class="linenos"> 318</span><span class="k">  end subroutine </span><span class="n">ppo_vertInterpWgts</span><span class="w"></span>
<span class="linenos"> 319</span><span class="w">  </span>
<span class="linenos"> 320</span><span class="w">  </span><span class="c">!------------ routines for interface ppo_linearInterpWgts ----------------</span>
<span class="linenos"> 321</span><span class="w">  </span>
<span class="linenos"> 322</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 323</span><span class="w">  </span><span class="c">! ppo_piecewiseLinearWgts</span>
<span class="linenos"> 324</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 325</span><span class="w">  </span><span class="k">subroutine </span><span class="n">ppo_piecewiseLinearWgts</span><span class="p">(</span><span class="n">pvo</span><span class="p">,</span><span class="n">pvi</span><span class="p">,</span><span class="n">kno</span><span class="p">,</span><span class="n">kni</span><span class="p">,</span><span class="n">wgts</span><span class="p">,</span><span class="n">kstart</span><span class="p">,</span><span class="n">validLevel_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 326</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 327</span><span class="w">    </span><span class="c">!:Purpose: To obtain peacewise linear interpolation weigths.</span>
<span class="linenos"> 328</span><span class="w">    </span><span class="c">!          Assumes pv*(i) &lt; pv*(i+1). Constant values extrapolation is applied.</span>
<span class="linenos"> 329</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 330</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos"> 331</span>
<span class="linenos"> 332</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos"> 333</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">pvi</span><span class="p">(</span><span class="n">kni</span><span class="p">)</span><span class="w">     </span><span class="c">! Vertical levels, pressure (source)</span>
<span class="linenos"> 334</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">kni</span><span class="w">          </span><span class="c">! Number of input levels (source)</span>
<span class="linenos"> 335</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">kno</span><span class="w">          </span><span class="c">! Number of output levels (destination)</span>
<span class="linenos"> 336</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">pvo</span><span class="p">(</span><span class="n">kno</span><span class="p">)</span><span class="w">     </span><span class="c">! Vertical levels, pressure (destination)</span>
<span class="linenos"> 337</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">wgts</span><span class="p">(</span><span class="n">kno</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="c">! Interpolation weights (destination)</span>
<span class="linenos"> 338</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kstart</span><span class="p">(</span><span class="n">kno</span><span class="p">)</span><span class="w">  </span><span class="c">! Index i of pvlev level associated to  pvo(j,1)</span>
<span class="linenos"> 339</span><span class="w">                                         </span><span class="c">! pvo(j,2) is for pvlev level i+1</span>
<span class="linenos"> 340</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">validLevel_opt</span><span class="p">(</span><span class="n">kno</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 341</span><span class="w">    </span>
<span class="linenos"> 342</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos"> 343</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pviIndex</span><span class="p">,</span><span class="w"> </span><span class="n">pvoIndex</span><span class="p">,</span><span class="w"> </span><span class="n">ik</span><span class="w"></span>
<span class="linenos"> 344</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lowerlevel</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">KNO</span><span class="p">)</span><span class="w">     </span>
<span class="linenos"> 345</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zw1</span><span class="p">,</span><span class="w"> </span><span class="n">zp2</span><span class="w"></span>
<span class="linenos"> 346</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">validLevel</span><span class="p">(</span><span class="n">kno</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 347</span><span class="w">      </span>
<span class="linenos"> 348</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">validLevel_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 349</span><span class="k">      </span><span class="n">validLevel</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validLevel_opt</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 350</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 351</span><span class="k">      </span><span class="n">validLevel</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 352</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos"> 353</span><span class="w">    </span>
<span class="linenos"> 354</span><span class="w">    </span><span class="c">! Find the adjacent level below</span>
<span class="linenos"> 355</span><span class="w">    </span>
<span class="linenos"> 356</span><span class="w">    </span><span class="n">lowerlevel</span><span class="p">(:)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 357</span><span class="w">    </span><span class="n">lowerlevel</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kno</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 358</span><span class="w">    </span><span class="k">do </span><span class="n">pvoIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kno</span><span class="w"></span>
<span class="linenos"> 359</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">validLevel</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">))</span><span class="w"> </span><span class="k">cycle </span>
<span class="linenos"> 360</span><span class="k">      do </span><span class="n">pviIndex</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lowerlevel</span><span class="p">(</span><span class="n">pvoIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="n">kni</span><span class="w"></span>
<span class="linenos"> 361</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">pvo</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pvi</span><span class="p">(</span><span class="n">pviIndex</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 362</span><span class="k">          </span><span class="n">lowerlevel</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pviIndex</span><span class="w"></span>
<span class="linenos"> 363</span><span class="w">          </span><span class="k">exit </span>
<span class="linenos"> 364</span><span class="k">        end if</span>
<span class="linenos"> 365</span><span class="k">      end do</span>
<span class="linenos"> 366</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">pviIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">kni</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">lowerlevel</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 367</span><span class="k">        </span><span class="n">lowerlevel</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">:</span><span class="n">kno</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kni</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 368</span><span class="w">        </span><span class="k">exit</span>
<span class="linenos"> 369</span><span class="k">      end if</span>
<span class="linenos"> 370</span><span class="k">    end do</span><span class="w"></span>
<span class="linenos"> 371</span><span class="w">    </span>
<span class="linenos"> 372</span><span class="w">    </span><span class="c">! Determine interpolation/extrapolation weights</span>
<span class="linenos"> 373</span><span class="w">  </span>
<span class="linenos"> 374</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(pvoIndex,ik,zp2,zw1)    </span>
<span class="linenos"> 375</span><span class="w">    </span><span class="k">do </span><span class="n">pvoIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kno</span><span class="w"></span>
<span class="linenos"> 376</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">validLevel</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then    </span>
<span class="linenos"> 377</span><span class="k">        </span><span class="n">kstart</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 378</span><span class="w">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 379</span><span class="w">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 380</span><span class="w">        </span><span class="k">cycle</span>
<span class="linenos"> 381</span><span class="k">      end if</span>
<span class="linenos"> 382</span><span class="k">      </span>
<span class="linenos"> 383</span><span class="k">      </span><span class="n">ik</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lowerlevel</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 384</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ik</span><span class="w"> </span><span class="o">&lt;=</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 385</span><span class="k">        </span><span class="n">kstart</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 386</span><span class="w">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos"> 387</span><span class="w">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 388</span><span class="w">      </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ik</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">kni</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 389</span><span class="k">        </span><span class="n">kstart</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">)</span><span class="o">=</span><span class="n">kni</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 390</span><span class="w">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 391</span><span class="w">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos"> 392</span><span class="w">      </span><span class="k">else</span>
<span class="linenos"> 393</span><span class="k">        </span><span class="n">zp2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pvi</span><span class="p">(</span><span class="n">ik</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 394</span><span class="w">        </span><span class="n">zw1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pvo</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">)</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">pvi</span><span class="p">(</span><span class="n">ik</span><span class="p">)</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 395</span><span class="w">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="n">zw1</span><span class="w"></span>
<span class="linenos"> 396</span><span class="w">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0d0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zw1</span><span class="w"></span>
<span class="linenos"> 397</span><span class="w">        </span><span class="n">kstart</span><span class="p">(</span><span class="n">pvoIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ik</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 398</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos"> 399</span><span class="k">    end do</span><span class="w"></span>
<span class="linenos"> 400</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos"> 401</span><span class="w">           </span>
<span class="linenos"> 402</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">ppo_piecewiseLinearWgts</span><span class="w"></span>
<span class="linenos"> 403</span>
<span class="linenos"> 404</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 405</span><span class="w">  </span><span class="c">! ppo_layeravgInterpWgts</span>
<span class="linenos"> 406</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 407</span><span class="w">  </span><span class="k">subroutine </span><span class="n">ppo_layeravgInterpWgts</span><span class="p">(</span><span class="n">PX1</span><span class="p">,</span><span class="n">PX2</span><span class="p">,</span><span class="n">KN1</span><span class="p">,</span><span class="n">KN2</span><span class="p">,</span><span class="n">PZ</span><span class="p">,</span><span class="n">kstart</span><span class="p">,</span><span class="n">kend</span><span class="p">,</span><span class="n">PZS1_opt</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 408</span><span class="w">                                     </span><span class="n">PZS2_opt</span><span class="p">,</span><span class="n">PZDPS_opt</span><span class="p">,</span><span class="n">rttov_opt</span><span class="p">,</span><span class="n">validLevel_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 409</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 410</span><span class="w">    </span><span class="c">!:Purpose: Determine profile interpolation weights by considering integrations </span>
<span class="linenos"> 411</span><span class="w">    </span><span class="c">!          over of series of  segments [PX1(KI-1),PX1(KI+1)] using  piecewise </span>
<span class="linenos"> 412</span><span class="w">    </span><span class="c">!          linear weighting with weights of zero at  KI-1 and KI+1 and </span>
<span class="linenos"> 413</span><span class="w">    </span><span class="c">!          max weight at KI. KI ranges from 1 to KN1.</span>
<span class="linenos"> 414</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 415</span><span class="w">    </span><span class="c">!          Can also provide gradient contributions from both </span>
<span class="linenos"> 416</span><span class="w">    </span><span class="c">!          linear and non-linear components of interpolator. The non-linear </span>
<span class="linenos"> 417</span><span class="w">    </span><span class="c">!          components (case PZS* is present) stem from vertical coordinate </span>
<span class="linenos"> 418</span><span class="w">    </span><span class="c">!          independent variables (e.g. dependency on Ps). The gradients </span>
<span class="linenos"> 419</span><span class="w">    </span><span class="c">!          contributions from the linear components are the interpolation weights.</span>
<span class="linenos"> 420</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 421</span><span class="w">    </span><span class="c">!          For the interpolation model f(x) where</span>
<span class="linenos"> 422</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 423</span><span class="w">    </span><span class="c">!                f(v,x) = F(v)*x</span>
<span class="linenos"> 424</span><span class="w">    </span><span class="c">!                       ~ F(vo)*xo + F(vo)*(x-xo) + (dF/dv)*xo*(v-vo)</span>
<span class="linenos"> 425</span><span class="w">    </span><span class="c">!                       = F(vo)*x + (dF/dv)*xo*(v-vo)                (eqn 1)</span>
<span class="linenos"> 426</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 427</span><span class="w">    </span><span class="c">!          </span>
<span class="linenos"> 428</span><span class="w">    </span><span class="c">!                 F(vo):  array of interpolation weights</span>
<span class="linenos"> 429</span><span class="w">    </span><span class="c">!                         = array of gradients from the linear component</span>
<span class="linenos"> 430</span><span class="w">    </span><span class="c">!                 (dF/dv)*xo:  </span>
<span class="linenos"> 431</span><span class="w">    </span><span class="c">!                         array of gradients from linearized component.</span>
<span class="linenos"> 432</span><span class="w">    </span><span class="c">!                         (dF/dv) or (dF/dv)*(v-vo) provided when pzs* is present</span>
<span class="linenos"> 433</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 434</span><span class="w">    </span><span class="c">!          Method:</span>
<span class="linenos"> 435</span><span class="w">    </span><span class="c">!             - Piecewise weighted interpolation in ln(P).</span>
<span class="linenos"> 436</span><span class="w">    </span><span class="c">!             - Journal reference:</span>
<span class="linenos"> 437</span><span class="w">    </span><span class="c">!               Rochon, Y.J., L. Garand, D.S. Turner, and S. Polavarapu.</span>
<span class="linenos"> 438</span><span class="w">    </span><span class="c">!               Jacobian mapping between coordinate systems in data assimilation,</span>
<span class="linenos"> 439</span><span class="w">    </span><span class="c">!               Q. J. of the Royal Met. Soc., vol 133, 1547-1558, 2007.</span>
<span class="linenos"> 440</span><span class="w">    </span><span class="c">!               (www.interscience.wiley.com) DOI:10.1002/qj.117</span>
<span class="linenos"> 441</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 442</span><span class="w">    </span><span class="c">!               URL:</span>
<span class="linenos"> 443</span><span class="w">    </span><span class="c">!               http://www3.interscience.wiley.com/cgi-bin/fulltext/116320452/PDFSTART</span>
<span class="linenos"> 444</span><span class="w">    </span><span class="c">!  </span>
<span class="linenos"> 445</span><span class="w">    </span><span class="c">!:Comments:</span>
<span class="linenos"> 446</span><span class="w">    </span><span class="c">!                    </span>
<span class="linenos"> 447</span><span class="w">    </span><span class="c">!     Assumption: PX1(i)&lt;PX1(i+1) &amp; PX2(i)&lt;PX2(i+1)</span>
<span class="linenos"> 448</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 449</span><span class="w">    </span><span class="c">!     1) The input profile is now extrapolated at constant value.</span>
<span class="linenos"> 450</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 451</span><span class="w">    </span><span class="c">!     The impact is of most practical significance for instruments where </span>
<span class="linenos"> 452</span><span class="w">    </span><span class="c">!     the weighting function peaks at or near the surface such as SSMI.</span>
<span class="linenos"> 453</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 454</span><span class="w">    </span><span class="c">!     This approach increases the weights of contribution from</span>
<span class="linenos"> 455</span><span class="w">    </span><span class="c">!     the lowest and highest input domain levels for output</span>
<span class="linenos"> 456</span><span class="w">    </span><span class="c">!     layers intersecting these input domain boundaries. It consists</span>
<span class="linenos"> 457</span><span class="w">    </span><span class="c">!     of applying contant value extrapolation by introducing  </span>
<span class="linenos"> 458</span><span class="w">    </span><span class="c">!     &#39;fake&#39; or &#39;virtual&#39; layers. For the lowest level of the input domain, </span>
<span class="linenos"> 459</span><span class="w">    </span><span class="c">!     as example, this implies creating a virtual surface layer which </span>
<span class="linenos"> 460</span><span class="w">    </span><span class="c">!     extends to the lower boundary of the output domain layer which </span>
<span class="linenos"> 461</span><span class="w">    </span><span class="c">!     contains the input domain surface. This increases the</span>
<span class="linenos"> 462</span><span class="w">    </span><span class="c">!     contributing weight of the surface which would be otherwise </span>
<span class="linenos"> 463</span><span class="w">    </span><span class="c">!     understimated in the original code due to the interpolator </span>
<span class="linenos"> 464</span><span class="w">    </span><span class="c">!     actually doing piecewise weighted averaging.</span>
<span class="linenos"> 465</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 466</span><span class="w">    </span><span class="c">!     2) COmment out use of &#39;zb&#39; for consistency with RTTOV-9 when </span>
<span class="linenos"> 467</span><span class="w">    </span><span class="c">!     rttov_opt = .true.</span>
<span class="linenos"> 468</span><span class="w">    </span><span class="c">!     See the four lines ending with !C1 and version 7 comment above.</span>
<span class="linenos"> 469</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 470</span><span class="w">    </span><span class="c">!     3) A major reduction in computational time results from only</span>
<span class="linenos"> 471</span><span class="w">    </span><span class="c">!     assigning values to the non-zero ranges of the 2D output</span>
<span class="linenos"> 472</span><span class="w">    </span><span class="c">!     arrays. These ranges of the 2D areas are identified by &#39;kstart&#39;</span>
<span class="linenos"> 473</span><span class="w">    </span><span class="c">!     and &#39;kend&#39;. Initialization to zero for values within these ranges </span>
<span class="linenos"> 474</span><span class="w">    </span><span class="c">!     is done using 1D work arrays &#39;zpz&#39; and &#39;zpzd&#39;, with the resulting</span>
<span class="linenos"> 475</span><span class="w">    </span><span class="c">!     values then being assigned to the related elements of &#39;PZ&#39; and </span>
<span class="linenos"> 476</span><span class="w">    </span><span class="c">!     &#39;PZDPS&#39;.</span>
<span class="linenos"> 477</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 478</span><span class="w">    </span><span class="c">!     Therefore, elements of &#39;PZ&#39; and &#39;PZDPS&#39; outside these ranges </span>
<span class="linenos"> 479</span><span class="w">    </span><span class="c">!     could be undefined (i.e. NaN if not 0.0) and should not be used.</span>
<span class="linenos"> 480</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 481</span><span class="w">    </span><span class="c">!     Other notable reductions in computational time stem (a) from inlining</span>
<span class="linenos"> 482</span><span class="w">    </span><span class="c">!     of &#39;sublayer&#39; code (applied to a reduced degree in &#39;layeravg&#39; as</span>
<span class="linenos"> 483</span><span class="w">    </span><span class="c">!     compared to &#39;rttov_layeravg_*) and (b) from updating the start </span>
<span class="linenos"> 484</span><span class="w">    </span><span class="c">!     position &#39;istart&#39; of the loops over J. The latter was faciliated </span>
<span class="linenos"> 485</span><span class="w">    </span><span class="c">!     by moving the loop over KI inside &#39;layeravg&#39;.</span>
<span class="linenos"> 486</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 487</span><span class="w">    </span><span class="c">!     These improvements were originally devised and implemented by </span>
<span class="linenos"> 488</span><span class="w">    </span><span class="c">!     Deborah Salmond and Mats Hamrud (ECMWF) in the RTTOV-9 routines </span>
<span class="linenos"> 489</span><span class="w">    </span><span class="c">!     &#39;rttov_layeravg*&#39;.</span>
<span class="linenos"> 490</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 491</span><span class="w">    </span><span class="c">!     4) Contributors to improvements and changes to the original version </span>
<span class="linenos"> 492</span><span class="w">    </span><span class="c">!     of &#39;layeravg&#39; and to &#39;rttov_layeravg*&#39;: members of the RTTOV9 </span>
<span class="linenos"> 493</span><span class="w">    </span><span class="c">!     development team, namely Niels Bormann, Alan Geer, Deborah Salmond,</span>
<span class="linenos"> 494</span><span class="w">    </span><span class="c">!     and Mats Hamrud of ECMWF, Peter Rayer and Roger Saunders of the </span>
<span class="linenos"> 495</span><span class="w">    </span><span class="c">!     Met Office and Pascal Brunel of Meteo-France, and Y.J. Rochon (EC).</span>
<span class="linenos"> 496</span><span class="w">    </span><span class="c">!                                </span>
<span class="linenos"> 497</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos"> 498</span><span class="w">     </span>
<span class="linenos"> 499</span><span class="w">    </span><span class="c">!Arguments:</span>
<span class="linenos"> 500</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">KN1</span><span class="w">          </span><span class="c">! Dimension of PX1</span>
<span class="linenos"> 501</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">KN2</span><span class="w">          </span><span class="c">! Dimension of other arrays</span>
<span class="linenos"> 502</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">PX1</span><span class="p">(</span><span class="n">KN1</span><span class="p">)</span><span class="w">     </span><span class="c">! Levels of output domain (e.g. lnP; in increasing values)</span>
<span class="linenos"> 503</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">PX2</span><span class="p">(</span><span class="n">KN2</span><span class="p">)</span><span class="w">     </span><span class="c">! Levels of input domain (e.g. lnP; in increasing values)</span>
<span class="linenos"> 504</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">PZ</span><span class="p">(</span><span class="n">KN1</span><span class="p">,</span><span class="n">KN2</span><span class="p">)</span><span class="w">  </span><span class="c">! F(vo): Resultant accumulated weighting factors </span>
<span class="linenos"> 505</span><span class="w">                                          </span><span class="c">! for interpolation from input to output domain</span>
<span class="linenos"> 506</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">KSTART</span><span class="p">(</span><span class="n">KN1</span><span class="p">)</span><span class="w">  </span><span class="c">! Start index for relevant PZ row</span>
<span class="linenos"> 507</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">KEND</span><span class="p">(</span><span class="n">KN1</span><span class="p">)</span><span class="w">    </span><span class="c">! End index of relevant PZ row</span>
<span class="linenos"> 508</span>
<span class="linenos"> 509</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">PZS1_opt</span><span class="p">(</span><span class="n">KN1</span><span class="p">)</span><span class="w"> </span><span class="c">! dPX1/dv or perturbation dPX1/dv * delta(v) where PX1(v), e.g. v=Ps    </span>
<span class="linenos"> 510</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">PZS2_opt</span><span class="p">(</span><span class="n">KN2</span><span class="p">)</span><span class="w"> </span><span class="c">! dPX2/dv or perturbation dPX2/dv * delta(v) where PX2(v), e.g. v=Ps</span>
<span class="linenos"> 511</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">PZDPS_opt</span><span class="p">(</span><span class="n">KN1</span><span class="p">,</span><span class="n">KN2</span><span class="p">)</span><span class="w"> </span><span class="c">! dF/dv or perturbations (dF/dv)*(v-vo): </span>
<span class="linenos"> 512</span><span class="w">    </span><span class="c">!                                                     ! Resultant accumulated factors for the</span>
<span class="linenos"> 513</span><span class="w">    </span><span class="c">!                                                     ! gradients w.r.t. v (or perturbations)</span>
<span class="linenos"> 514</span><span class="w">    </span><span class="c">!                                                     ! associated to coordinates</span>
<span class="linenos"> 515</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">RTTOV_OPT</span><span class="w">  </span><span class="c">! Commented out use of &#39;zb&#39; when .true. for consistency with RTTOV-9</span>
<span class="linenos"> 516</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">validLevel_opt</span><span class="p">(</span><span class="n">kn1</span><span class="p">)</span><span class="w"> </span><span class="c">! Logical indicating validity of each output level</span>
<span class="linenos"> 517</span><span class="w">                  </span>
<span class="linenos"> 518</span><span class="w">    </span><span class="c">!Locals:                </span>
<span class="linenos"> 519</span><span class="w">    </span><span class="kt">logical</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">LGRADP</span><span class="p">,</span><span class="n">lgradp1</span><span class="p">,</span><span class="n">lgradp2</span><span class="p">,</span><span class="n">validLevel</span><span class="p">(</span><span class="n">kn1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 520</span><span class="w">    </span><span class="kt">integer</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">J</span><span class="p">,</span><span class="n">IC</span><span class="p">,</span><span class="n">ISTART</span><span class="p">,</span><span class="n">KI</span><span class="w"></span>
<span class="linenos"> 521</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">Z1</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">KN1</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">ZW1</span><span class="p">,</span><span class="n">ZW2</span><span class="p">,</span><span class="n">ZSUM</span><span class="p">,</span><span class="n">ZB</span><span class="p">,</span><span class="n">ZBPS</span><span class="p">,</span><span class="n">ZWPS1</span><span class="p">,</span><span class="n">ZWPS2</span><span class="p">,</span><span class="n">ZDXD</span><span class="w"></span>
<span class="linenos"> 522</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">PZ1</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">KN1</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">PZS2</span><span class="p">(</span><span class="n">KN2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 523</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">DZ</span><span class="p">(</span><span class="n">KN1</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">DZD</span><span class="p">(</span><span class="n">KN1</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">DXD</span><span class="p">(</span><span class="n">KN2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 524</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ZPZ</span><span class="p">(</span><span class="n">KN2</span><span class="p">),</span><span class="n">ZPZD</span><span class="p">(</span><span class="n">KN2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 525</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">WX1</span><span class="p">,</span><span class="n">WX2</span><span class="p">,</span><span class="n">Y1</span><span class="p">,</span><span class="n">Y2</span><span class="p">,</span><span class="n">DY</span><span class="p">,</span><span class="n">DAD</span><span class="w"></span>
<span class="linenos"> 526</span>
<span class="linenos"> 527</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">WGT1</span><span class="o">=</span><span class="mf">0.0d0</span><span class="p">,</span><span class="w"> </span><span class="n">WGT2</span><span class="o">=</span><span class="mf">1.0d0</span><span class="p">,</span><span class="w"> </span><span class="n">WGT3</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 528</span>
<span class="linenos"> 529</span><span class="w">    </span><span class="c">!- Set integration/averaging range boundaries for output domain.</span>
<span class="linenos"> 530</span><span class="w">    </span><span class="c">!  Range of integration for each layer ki is z1(ki-1) to z1(ki+1).</span>
<span class="linenos"> 531</span><span class="w">    </span><span class="c">!  Weighting function is linear with weights of 0.0 at z1(ki-1) and </span>
<span class="linenos"> 532</span><span class="w">    </span><span class="c">!  z1(ki+1) and a weight of 1.0 at z1(ki).</span>
<span class="linenos"> 533</span>
<span class="linenos"> 534</span><span class="w">    </span><span class="n">z1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kn1</span><span class="p">)</span><span class="o">=</span><span class="n">px1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kn1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 535</span><span class="w">    </span><span class="n">z1</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mf">2.0</span><span class="o">*</span><span class="n">px1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">px1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 536</span><span class="w">    </span><span class="n">z1</span><span class="p">(</span><span class="n">kn1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">2.0</span><span class="o">*</span><span class="n">px1</span><span class="p">(</span><span class="n">kn1</span><span class="p">)</span><span class="o">-</span><span class="n">px1</span><span class="p">(</span><span class="n">kn1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 537</span>
<span class="linenos"> 538</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">pzs1_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then </span>
<span class="linenos"> 539</span><span class="k">      </span><span class="n">lgradp1</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 540</span><span class="w">      </span><span class="n">lgradp</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w">     </span>
<span class="linenos"> 541</span><span class="w">      </span><span class="n">pz1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kn1</span><span class="p">)</span><span class="o">=</span><span class="n">pzs1_opt</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kn1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 542</span><span class="w">      </span><span class="n">pz1</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mf">2.0</span><span class="o">*</span><span class="n">pzs1_opt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">pzs1_opt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 543</span><span class="w">      </span><span class="n">pz1</span><span class="p">(</span><span class="n">kn1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">2.0</span><span class="o">*</span><span class="n">pzs1_opt</span><span class="p">(</span><span class="n">kn1</span><span class="p">)</span><span class="o">-</span><span class="n">pzs1_opt</span><span class="p">(</span><span class="n">kn1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 544</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 545</span><span class="k">      </span><span class="n">lgradp1</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 546</span><span class="w">      </span><span class="n">lgradp</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 547</span><span class="w">      </span><span class="n">pz1</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">kn1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 548</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 549</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">pzs2_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then </span>
<span class="linenos"> 550</span><span class="k">      </span><span class="n">lgradp2</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"> </span>
<span class="linenos"> 551</span><span class="w">      </span><span class="n">lgradp</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w">     </span>
<span class="linenos"> 552</span><span class="w">      </span><span class="n">pzs2</span><span class="p">(:)</span><span class="o">=</span><span class="n">pzs2_opt</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 553</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 554</span><span class="k">      </span><span class="n">lgradp2</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 555</span><span class="w">      </span><span class="n">pzs2</span><span class="p">(:)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 556</span><span class="w">    </span><span class="k">end if       </span>
<span class="linenos"> 557</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">validLevel_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 558</span><span class="k">      </span><span class="n">validLevel</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validLevel_opt</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 559</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 560</span><span class="k">      </span><span class="n">validLevel</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 561</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos"> 562</span><span class="w">     </span>
<span class="linenos"> 563</span><span class="w">    </span><span class="c">!- Pre-calculate values (dzd and dxd) used by subroutine sublayer</span>
<span class="linenos"> 564</span>
<span class="linenos"> 565</span><span class="w">    </span><span class="n">dz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kn1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">z1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kn1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">z1</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">kn1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 566</span><span class="w">    </span><span class="n">dzd</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kn1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0d0</span><span class="o">/</span><span class="n">dz</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kn1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 567</span>
<span class="linenos"> 568</span><span class="w">    </span><span class="n">dxd</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="n">kn2</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0d0</span><span class="o">/</span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="n">kn2</span><span class="p">)</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kn2</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 569</span><span class="w">    </span><span class="n">dxd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">dxd</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 570</span><span class="w">    </span><span class="n">dxd</span><span class="p">(</span><span class="n">kn2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">dxd</span><span class="p">(</span><span class="n">kn2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 571</span>
<span class="linenos"> 572</span><span class="w">    </span><span class="c">!- Determine forward interpolator or TLM coefficients</span>
<span class="linenos"> 573</span><span class="w">       </span>
<span class="linenos"> 574</span><span class="w">    </span><span class="c">!- Loop over output domain levels for determining </span>
<span class="linenos"> 575</span><span class="w">    </span><span class="c">!  contributing weights of input domain levels over </span>
<span class="linenos"> 576</span><span class="w">    </span><span class="c">!  segments [PX1(KI-1),PX1(KI+1)]</span>
<span class="linenos"> 577</span>
<span class="linenos"> 578</span><span class="w">    </span><span class="n">istart</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 579</span><span class="w">    </span><span class="k">do </span><span class="n">ki</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kn1</span><span class="w"></span>
<span class="linenos"> 580</span>
<span class="linenos"> 581</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">validLevel</span><span class="p">(</span><span class="n">ki</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 582</span><span class="k">         </span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 583</span><span class="w">         </span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 584</span><span class="w">         </span><span class="n">pz</span><span class="p">(</span><span class="n">ki</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 585</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lgradp</span><span class="p">)</span><span class="w"> </span><span class="n">pzdps_opt</span><span class="p">(</span><span class="n">ki</span><span class="p">,:)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 586</span><span class="w">         </span><span class="k">cycle</span>
<span class="linenos"> 587</span><span class="k">      end if</span><span class="w">         </span>
<span class="linenos"> 588</span><span class="w">      </span>
<span class="linenos"> 589</span><span class="w">      </span><span class="c">! -- Consider constant value extrapolations cases for output domain </span>
<span class="linenos"> 590</span><span class="w">      </span><span class="c">!    layers entirely outside the input domain.</span>
<span class="linenos"> 591</span>
<span class="linenos"> 592</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">le</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 593</span>
<span class="linenos"> 594</span><span class="w">        </span><span class="c">! pz(ki,1) is set to 1.0 to force constant value extrapolation</span>
<span class="linenos"> 595</span><span class="w">        </span><span class="c">! of field (e.g. temperature) above highest input level.</span>
<span class="linenos"> 596</span>
<span class="linenos"> 597</span><span class="w">        </span><span class="n">pz</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos"> 598</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lgradp</span><span class="p">)</span><span class="w"> </span><span class="n">pzdps_opt</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos"> 599</span><span class="w">        </span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 600</span><span class="w">        </span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 601</span><span class="w">        </span><span class="k">CYCLE</span>
<span class="linenos"> 602</span>
<span class="linenos"> 603</span><span class="k">      else if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="n">ge</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 604</span>
<span class="linenos"> 605</span><span class="w">        </span><span class="c">! pz(ki:kni,kn2) is set to 1.0 to force constant value extrapolation </span>
<span class="linenos"> 606</span><span class="w">        </span><span class="c">! of field (e.g. temperature) below lowest input level.</span>
<span class="linenos"> 607</span><span class="w"> </span>
<span class="linenos"> 608</span><span class="w">        </span><span class="n">pz</span><span class="p">(</span><span class="n">ki</span><span class="p">:</span><span class="n">kn1</span><span class="p">,</span><span class="n">kn2</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos"> 609</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lgradp</span><span class="p">)</span><span class="w"> </span><span class="n">pzdps_opt</span><span class="p">(</span><span class="n">ki</span><span class="p">:</span><span class="n">kn1</span><span class="p">,</span><span class="n">kn2</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos"> 610</span><span class="w">        </span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">:</span><span class="n">kn1</span><span class="p">)</span><span class="o">=</span><span class="n">kn2</span><span class="w"></span>
<span class="linenos"> 611</span><span class="w">        </span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">:</span><span class="n">kn1</span><span class="p">)</span><span class="o">=</span><span class="n">kn2</span><span class="w"></span>
<span class="linenos"> 612</span><span class="w">        </span><span class="k">return</span>
<span class="linenos"> 613</span><span class="k">      end if</span><span class="w">   </span>
<span class="linenos"> 614</span>
<span class="linenos"> 615</span><span class="w">      </span><span class="c">! -- Consider piecewise averaging interpolation for output domain</span>
<span class="linenos"> 616</span><span class="w">      </span><span class="c">!    layers and layer segments within the input domain.</span>
<span class="linenos"> 617</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 618</span><span class="w">      </span><span class="c">! -- Loop over input layers within the (z1(ki-1),z1(ki)) and </span>
<span class="linenos"> 619</span><span class="w">      </span><span class="c">!    (z1(ki),z1(ki+1)) integration ranges.</span>
<span class="linenos"> 620</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 621</span><span class="w">      </span><span class="c">! Accumulate contributions to integration components over the </span>
<span class="linenos"> 622</span><span class="w">      </span><span class="c">!     different segments.</span>
<span class="linenos"> 623</span>
<span class="linenos"> 624</span><span class="w">      </span><span class="n">ic</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 625</span><span class="w">      </span><span class="n">zpz</span><span class="p">(</span><span class="n">istart</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 626</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lgradp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 627</span><span class="k">        </span><span class="n">zpzd</span><span class="p">(</span><span class="n">istart</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 628</span><span class="w">        </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">istart</span><span class="p">,</span><span class="n">kn2</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 629</span><span class="w">          </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 630</span><span class="w">          </span><span class="n">zpzd</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 631</span>
<span class="linenos"> 632</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">).</span><span class="n">ge</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos"> 633</span>
<span class="linenos"> 634</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 635</span>
<span class="linenos"> 636</span><span class="w">            </span><span class="c">! Integration over the segment of the range (z1(ki-1),z1(ki))</span>
<span class="linenos"> 637</span><span class="w">            </span><span class="c">! intersecting with the range (px2(j),px2(j+1))=(x1,x2)</span>
<span class="linenos"> 638</span>
<span class="linenos"> 639</span><span class="w">            </span><span class="k">call </span><span class="n">ppo_sublayerInterpWgts</span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">wgt1</span><span class="p">,</span><span class="n">wgt2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 640</span><span class="w">                 </span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dxd</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 641</span><span class="w">                 </span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 642</span><span class="w">                 </span><span class="n">pzs2</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">pzs2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">zpzd</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">zpzd</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">lgradp1</span><span class="p">,</span><span class="n">lgradp2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 643</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ic</span><span class="o">=</span><span class="n">j</span><span class="w"></span>
<span class="linenos"> 644</span><span class="w">          </span><span class="k">endif</span>
<span class="linenos"> 645</span>
<span class="linenos"> 646</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 647</span>
<span class="linenos"> 648</span><span class="w">            </span><span class="c">! Integration over the segment of the range (z1(ki),z1(ki+1))</span>
<span class="linenos"> 649</span><span class="w">            </span><span class="c">! intersecting with the range (px2(j),px2(j+1))=(x1,x2).</span>
<span class="linenos"> 650</span>
<span class="linenos"> 651</span><span class="w">            </span><span class="k">call </span><span class="n">ppo_sublayerInterpWgts</span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">wgt2</span><span class="p">,</span><span class="n">wgt3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 652</span><span class="w">                 </span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dxd</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 653</span><span class="w">                 </span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 654</span><span class="w">                 </span><span class="n">pzs2</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">pzs2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">zpzd</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">zpzd</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">lgradp1</span><span class="p">,</span><span class="n">lgradp2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 655</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ic</span><span class="o">=</span><span class="n">j</span><span class="w"></span>
<span class="linenos"> 656</span><span class="w">          </span><span class="k">endif</span>
<span class="linenos"> 657</span><span class="k">        enddo</span>
<span class="linenos"> 658</span>
<span class="linenos"> 659</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 660</span><span class="k">          </span><span class="n">j</span><span class="o">=</span><span class="n">kn2</span><span class="w">    </span>
<span class="linenos"> 661</span><span class="w">          </span><span class="n">pz</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos"> 662</span><span class="w">          </span><span class="n">pzdps_opt</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos"> 663</span><span class="w">          </span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="n">j</span><span class="w"></span>
<span class="linenos"> 664</span><span class="w">          </span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="n">j</span><span class="w"></span>
<span class="linenos"> 665</span><span class="w">          </span><span class="k">CYCLE</span>
<span class="linenos"> 666</span><span class="k">	else</span>
<span class="linenos"> 667</span><span class="k">          </span><span class="n">istart</span><span class="o">=</span><span class="n">ic</span><span class="w"></span>
<span class="linenos"> 668</span><span class="w">          </span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="n">istart</span><span class="w"></span>
<span class="linenos"> 669</span><span class="w">          </span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="n">j</span><span class="w">	</span>
<span class="linenos"> 670</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos"> 671</span>
<span class="linenos"> 672</span><span class="k">      else</span><span class="w"></span>
<span class="linenos"> 673</span>
<span class="linenos"> 674</span><span class="w">        </span><span class="c">! Same as above but with a compressed subset of &#39;sublayer&#39; inlined </span>
<span class="linenos"> 675</span><span class="w">        </span><span class="c">! for improved speed at least in setting interplation weights.</span>
<span class="linenos"> 676</span><span class="w">        </span><span class="c">! This follows the corresponding change in &#39;rttov_layeravg&#39; </span>
<span class="linenos"> 677</span><span class="w">        </span><span class="c">! by Deborah Salmond and Mats Hamrud (ECMWF) and takes advantage</span>
<span class="linenos"> 678</span><span class="w">        </span><span class="c">! of the known wgt* values in each case.</span>
<span class="linenos"> 679</span><span class="w">        </span><span class="c">!</span>
<span class="linenos"> 680</span><span class="w">        </span><span class="c">! See &#39;ppo_sublayerInterpWgts&#39; for information on applied equations.</span>
<span class="linenos"> 681</span>
<span class="linenos"> 682</span><span class="w">        </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">istart</span><span class="p">,</span><span class="n">kn2</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 683</span><span class="w">          </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 684</span>
<span class="linenos"> 685</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">).</span><span class="n">ge</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos"> 686</span><span class="k">	  </span>
<span class="linenos"> 687</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 688</span>
<span class="linenos"> 689</span><span class="w">            </span><span class="c">! Integration over the segment of the range (z1(ki-1),z1(ki))</span>
<span class="linenos"> 690</span><span class="w">            </span><span class="c">! intersecting with the range (px2(j),px2(j+1))=(x1,x2)</span>
<span class="linenos"> 691</span>
<span class="linenos"> 692</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 693</span><span class="k">              </span><span class="n">y1</span><span class="o">=</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 694</span><span class="w">              </span><span class="n">wx1</span><span class="o">=</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 695</span><span class="w">            </span><span class="k">else</span>
<span class="linenos"> 696</span><span class="k">              </span><span class="n">y1</span><span class="o">=</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 697</span><span class="w">              </span><span class="n">wx1</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 698</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos"> 699</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 700</span><span class="k">              </span><span class="n">wx2</span><span class="o">=</span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 701</span><span class="w">              </span><span class="n">dy</span><span class="o">=</span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 702</span><span class="w">              </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">wx1</span><span class="w"></span>
<span class="linenos"> 703</span><span class="w">              </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">wx2</span><span class="w"></span>
<span class="linenos"> 704</span><span class="w">            </span><span class="k">else</span>
<span class="linenos"> 705</span><span class="k">              </span><span class="n">dad</span><span class="o">=</span><span class="n">dxd</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dz</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 706</span><span class="w">              </span><span class="n">dy</span><span class="o">=</span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">*</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 707</span><span class="w">              </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="p">(</span><span class="n">wx1</span><span class="o">-</span><span class="n">dad</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 708</span><span class="w">              </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="p">(</span><span class="n">dz</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">+</span><span class="n">dad</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 709</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos"> 710</span>
<span class="linenos"> 711</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ic</span><span class="o">=</span><span class="n">j</span><span class="w"></span>
<span class="linenos"> 712</span><span class="w">          </span><span class="k">endif</span>
<span class="linenos"> 713</span>
<span class="linenos"> 714</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 715</span>
<span class="linenos"> 716</span><span class="w">            </span><span class="c">! Integration over the segment of the range (z1(ki),z1(ki+1))</span>
<span class="linenos"> 717</span><span class="w">            </span><span class="c">! intersecting with the range (px2(j),px2(j+1))=(x1,x2).</span>
<span class="linenos"> 718</span>
<span class="linenos"> 719</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 720</span><span class="k">              </span><span class="n">y2</span><span class="o">=</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 721</span><span class="w">              </span><span class="n">wx2</span><span class="o">=</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">y2</span><span class="w"></span>
<span class="linenos"> 722</span><span class="w">            </span><span class="k">else</span>
<span class="linenos"> 723</span><span class="k">              </span><span class="n">y2</span><span class="o">=</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 724</span><span class="w">              </span><span class="n">wx2</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 725</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos"> 726</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 727</span><span class="k">              </span><span class="n">wx1</span><span class="o">=</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 728</span><span class="w">              </span><span class="n">dy</span><span class="o">=</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="o">*</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 729</span><span class="w">              </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">wx1</span><span class="w"></span>
<span class="linenos"> 730</span><span class="w">              </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">wx2</span><span class="w"></span>
<span class="linenos"> 731</span><span class="w">            </span><span class="k">else  </span>
<span class="linenos"> 732</span><span class="k">              </span><span class="n">dad</span><span class="o">=</span><span class="n">dxd</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dz</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 733</span><span class="w">              </span><span class="n">dy</span><span class="o">=</span><span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">))</span><span class="o">*</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 734</span><span class="w">              </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="p">(</span><span class="n">dz</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">dad</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 735</span><span class="w">              </span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="p">(</span><span class="n">wx2</span><span class="o">+</span><span class="n">dad</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 736</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos"> 737</span>
<span class="linenos"> 738</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ic</span><span class="o">=</span><span class="n">j</span><span class="w"></span>
<span class="linenos"> 739</span><span class="w">          </span><span class="k">endif</span>
<span class="linenos"> 740</span><span class="k">        enddo</span>
<span class="linenos"> 741</span>
<span class="linenos"> 742</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">ic</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 743</span><span class="k">          </span><span class="n">j</span><span class="o">=</span><span class="n">kn2</span><span class="w">    </span>
<span class="linenos"> 744</span><span class="w">          </span><span class="n">pz</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos"> 745</span><span class="w">          </span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="n">j</span><span class="w"></span>
<span class="linenos"> 746</span><span class="w">          </span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="n">j</span><span class="w"></span>
<span class="linenos"> 747</span><span class="w">          </span><span class="k">CYCLE</span>
<span class="linenos"> 748</span><span class="k">	else</span>
<span class="linenos"> 749</span><span class="k">          </span><span class="n">istart</span><span class="o">=</span><span class="n">ic</span><span class="w"></span>
<span class="linenos"> 750</span><span class="w">          </span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="n">istart</span><span class="w"></span>
<span class="linenos"> 751</span><span class="w">          </span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">=</span><span class="n">j</span><span class="w">	</span>
<span class="linenos"> 752</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos"> 753</span>
<span class="linenos"> 754</span><span class="k">      end if</span><span class="w"></span>
<span class="linenos"> 755</span>
<span class="linenos"> 756</span><span class="w">      </span><span class="c">! -- Consider constant value extrapolation contribution for output domain</span>
<span class="linenos"> 757</span><span class="w">      </span><span class="c">!    layers crossing lower or upper input domain boundaries.</span>
<span class="linenos"> 758</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 759</span><span class="w">      </span><span class="c">! -- Extend to below (and/or above) lowest (and/or highest) input levels</span>
<span class="linenos"> 760</span><span class="w">      </span><span class="c">!    if output layer intersects the corresponding input domain boundary.</span>
<span class="linenos"> 761</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 762</span><span class="w">      </span><span class="c">!    A virtual layer covering the region between the input domain boundary </span>
<span class="linenos"> 763</span><span class="w">      </span><span class="c">!    and the boundary of the output layer is added. This increases the</span>
<span class="linenos"> 764</span><span class="w">      </span><span class="c">!    contributing in weight of the input domain boundary roughly by the </span>
<span class="linenos"> 765</span><span class="w">      </span><span class="c">!    relative thickness of the virtual layer to the entire output layer </span>
<span class="linenos"> 766</span><span class="w">      </span><span class="c">!    thickness.</span>
<span class="linenos"> 767</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 768</span><span class="w">      </span><span class="c">!    This follows updates by Alan Geer (ECMWF) in rttov_layeravg </span>
<span class="linenos"> 769</span><span class="w">      </span><span class="c">!    of RTTOV-9. It is done for two reasons:</span>
<span class="linenos"> 770</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 771</span><span class="w">      </span><span class="c">!       1) Piecewise weighted averaging using only the region</span>
<span class="linenos"> 772</span><span class="w">      </span><span class="c">!          within the input domain will tend to underestimate the impact</span>
<span class="linenos"> 773</span><span class="w">      </span><span class="c">!          of the input level boundary.</span>
<span class="linenos"> 774</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 775</span><span class="w">      </span><span class="c">!       2) The regression coefficients of the output domain</span>
<span class="linenos"> 776</span><span class="w">      </span><span class="c">!          model are based on complete output domain layers, this being</span>
<span class="linenos"> 777</span><span class="w">      </span><span class="c">!          consistent with RTTOV convention. </span>
<span class="linenos"> 778</span><span class="w">    </span>
<span class="linenos"> 779</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 780</span>
<span class="linenos"> 781</span><span class="w">        </span><span class="c">! Increase contribution from lowest input level.</span>
<span class="linenos"> 782</span>
<span class="linenos"> 783</span><span class="w">        </span><span class="n">zw1</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 784</span><span class="w">        </span><span class="n">zw2</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 785</span><span class="w">        </span><span class="n">zwps1</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 786</span><span class="w">        </span><span class="n">zwps2</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 787</span><span class="w">        </span><span class="n">zb</span><span class="o">=</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 788</span><span class="w">        </span><span class="n">zbps</span><span class="o">=</span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 789</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">rttov_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 790</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">rttov_opt</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 791</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mi">2</span><span class="o">*</span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="p">)</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">ki</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">kn1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">     </span><span class="c">!C1</span>
<span class="linenos"> 792</span><span class="w">              </span><span class="n">zb</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="p">)</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w">                                    </span><span class="c">!C1</span>
<span class="linenos"> 793</span><span class="w">              </span><span class="n">zbps</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pzs2</span><span class="p">(</span><span class="n">kn2</span><span class="p">)</span><span class="o">-</span><span class="n">pzs2</span><span class="p">(</span><span class="n">kn2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w">                                </span><span class="c">!C1</span>
<span class="linenos"> 794</span><span class="w">            </span><span class="k">end if</span><span class="w">                                                        </span><span class="c">!C1</span>
<span class="linenos"> 795</span><span class="w">          </span><span class="k">end if                                                       </span>
<span class="linenos"> 796</span><span class="k">        end if</span>
<span class="linenos"> 797</span><span class="k">        </span><span class="n">zdxd</span><span class="o">=</span><span class="mf">1.0d0</span><span class="o">/</span><span class="p">(</span><span class="n">zb</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 798</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">zb</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 799</span><span class="k">          call </span><span class="n">ppo_sublayerInterpWgts</span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">wgt2</span><span class="p">,</span><span class="n">wgt3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 800</span><span class="w">                          </span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="p">),</span><span class="n">zb</span><span class="p">,</span><span class="n">zdxd</span><span class="p">,</span><span class="n">zw1</span><span class="p">,</span><span class="n">zw2</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 801</span><span class="w">                          </span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 802</span><span class="w">                          </span><span class="n">pzs2</span><span class="p">(</span><span class="n">kn2</span><span class="p">),</span><span class="n">zbps</span><span class="p">,</span><span class="n">zwps1</span><span class="p">,</span><span class="n">zwps2</span><span class="p">,</span><span class="n">lgradp1</span><span class="p">,</span><span class="n">lgradp2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 803</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos"> 804</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 805</span><span class="k">          call </span><span class="n">ppo_sublayerInterpWgts</span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">wgt1</span><span class="p">,</span><span class="n">wgt2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 806</span><span class="w">                          </span><span class="n">px2</span><span class="p">(</span><span class="n">kn2</span><span class="p">),</span><span class="n">zb</span><span class="p">,</span><span class="n">zdxd</span><span class="p">,</span><span class="n">zw1</span><span class="p">,</span><span class="n">zw2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 807</span><span class="w">                          </span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 808</span><span class="w">                          </span><span class="n">pzs2</span><span class="p">(</span><span class="n">kn2</span><span class="p">),</span><span class="n">zbps</span><span class="p">,</span><span class="n">zwps1</span><span class="p">,</span><span class="n">zwps2</span><span class="p">,</span><span class="n">lgradp1</span><span class="p">,</span><span class="n">lgradp2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 809</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos"> 810</span><span class="k">        </span><span class="n">zpz</span><span class="p">(</span><span class="n">kn2</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">kn2</span><span class="p">)</span><span class="o">+</span><span class="n">zw1</span><span class="o">+</span><span class="n">zw2</span><span class="w"></span>
<span class="linenos"> 811</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lgradp</span><span class="p">)</span><span class="w"> </span><span class="n">zpzd</span><span class="p">(</span><span class="n">kn2</span><span class="p">)</span><span class="o">=</span><span class="n">zpzd</span><span class="p">(</span><span class="n">kn2</span><span class="p">)</span><span class="o">+</span><span class="n">zwps1</span><span class="o">+</span><span class="n">zwps2</span><span class="w"></span>
<span class="linenos"> 812</span><span class="w">      </span><span class="k">end if       </span>
<span class="linenos"> 813</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 814</span>
<span class="linenos"> 815</span><span class="w">        </span><span class="c">! Increase contribution from highest input level.</span>
<span class="linenos"> 816</span>
<span class="linenos"> 817</span><span class="w">        </span><span class="n">zw1</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 818</span><span class="w">        </span><span class="n">zw2</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 819</span><span class="w">        </span><span class="n">zwps1</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 820</span><span class="w">        </span><span class="n">zwps2</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 821</span><span class="w">        </span><span class="n">zb</span><span class="o">=</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 822</span><span class="w">        </span><span class="n">zbps</span><span class="o">=</span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 823</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">rttov_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 824</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">rttov_opt</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 825</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mi">2</span><span class="o">*</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">ki</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">          </span><span class="c">!C1</span>
<span class="linenos"> 826</span><span class="w">              </span><span class="n">zb</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">px2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w">                                       </span><span class="c">!C1</span>
<span class="linenos"> 827</span><span class="w">              </span><span class="n">zbps</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pzs2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">pzs2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w">                                   </span><span class="c">!C1</span>
<span class="linenos"> 828</span><span class="w">            </span><span class="k">end if</span><span class="w">                                                     </span><span class="c">!C1</span>
<span class="linenos"> 829</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos"> 830</span><span class="k">        end if</span>
<span class="linenos"> 831</span><span class="k">        </span><span class="n">zdxd</span><span class="o">=</span><span class="mf">1.0d0</span><span class="o">/</span><span class="p">(</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zb</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 832</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">zb</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 833</span><span class="k">          call </span><span class="n">ppo_sublayerInterpWgts</span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">wgt1</span><span class="p">,</span><span class="n">wgt2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 834</span><span class="w">                          </span><span class="n">zb</span><span class="p">,</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">zdxd</span><span class="p">,</span><span class="n">zw1</span><span class="p">,</span><span class="n">zw2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 835</span><span class="w">                          </span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 836</span><span class="w">                          </span><span class="n">zbps</span><span class="p">,</span><span class="n">pzs2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">zwps1</span><span class="p">,</span><span class="n">zwps2</span><span class="p">,</span><span class="n">lgradp1</span><span class="p">,</span><span class="n">lgradp2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 837</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos"> 838</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 839</span><span class="k">          call </span><span class="n">ppo_sublayerInterpWgts</span><span class="p">(</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">z1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dzd</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">wgt2</span><span class="p">,</span><span class="n">wgt3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 840</span><span class="w">                          </span><span class="n">zb</span><span class="p">,</span><span class="n">px2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">zdxd</span><span class="p">,</span><span class="n">zw1</span><span class="p">,</span><span class="n">zw2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 841</span><span class="w">                          </span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="p">),</span><span class="n">pz1</span><span class="p">(</span><span class="n">ki</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 842</span><span class="w">                          </span><span class="n">zbps</span><span class="p">,</span><span class="n">pzs2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">zwps1</span><span class="p">,</span><span class="n">zwps2</span><span class="p">,</span><span class="n">lgradp1</span><span class="p">,</span><span class="n">lgradp2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 843</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos"> 844</span><span class="k">        </span><span class="n">zpz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">zw1</span><span class="o">+</span><span class="n">zw2</span><span class="w"></span>
<span class="linenos"> 845</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lgradp</span><span class="p">)</span><span class="w"> </span><span class="n">zpzd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zpzd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">zwps1</span><span class="o">+</span><span class="n">zwps2</span><span class="w"></span>
<span class="linenos"> 846</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos"> 847</span>
<span class="linenos"> 848</span><span class="w">      </span><span class="c">! -- Normalize sum to unity (instead of calculating and dividing by</span>
<span class="linenos"> 849</span><span class="w">      </span><span class="c">!    weighting denominator)</span>
<span class="linenos"> 850</span>
<span class="linenos"> 851</span><span class="w">      </span><span class="n">zsum</span><span class="o">=</span><span class="mf">1.0d0</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">zpz</span><span class="p">(</span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">):</span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">)))</span><span class="w"></span>
<span class="linenos"> 852</span><span class="w">      </span><span class="n">pz</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">):</span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">))</span><span class="o">=</span><span class="n">zpz</span><span class="p">(</span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">):</span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">))</span><span class="o">*</span><span class="n">zsum</span><span class="w"></span>
<span class="linenos"> 853</span>
<span class="linenos"> 854</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lgradp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 855</span>
<span class="linenos"> 856</span><span class="w">        </span><span class="c">! Normalize and account for denominator gradients, i.e.</span>
<span class="linenos"> 857</span>
<span class="linenos"> 858</span><span class="w">        </span><span class="c">! d[sum1(w*t)/sum2(w)]/dv = sum1[t*(dw/dv)]/sum2(w) </span>
<span class="linenos"> 859</span><span class="w">        </span><span class="c">!                          -sum1[t*w]*sum2[(dw/dv)]/sum2(w)^2       </span>
<span class="linenos"> 860</span>
<span class="linenos"> 861</span><span class="w">        </span><span class="n">pzdps_opt</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">):</span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">))</span><span class="o">=</span><span class="p">(</span><span class="n">zpzd</span><span class="p">(</span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">):</span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>
<span class="linenos"> 862</span><span class="w">                             </span><span class="o">-</span><span class="n">pz</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">):</span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 863</span><span class="w">                             </span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">zpzd</span><span class="p">(</span><span class="n">kstart</span><span class="p">(</span><span class="n">ki</span><span class="p">):</span><span class="n">kend</span><span class="p">(</span><span class="n">ki</span><span class="p">))))</span><span class="o">*</span><span class="n">zsum</span><span class="w"></span>
<span class="linenos"> 864</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos"> 865</span>
<span class="linenos"> 866</span><span class="k">    end do</span>
<span class="linenos"> 867</span>
<span class="linenos"> 868</span><span class="k">  end subroutine </span><span class="n">ppo_layeravgInterpWgts</span><span class="w"></span>
<span class="linenos"> 869</span>
<span class="linenos"> 870</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 871</span><span class="w">  </span><span class="c">! ppo_sublayerInterpWgts</span>
<span class="linenos"> 872</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 873</span><span class="w">  </span><span class="k">subroutine </span><span class="n">ppo_sublayerInterpWgts</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span><span class="n">z2</span><span class="p">,</span><span class="n">dzd</span><span class="p">,</span><span class="n">wgt1</span><span class="p">,</span><span class="n">wgt2</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">dxd</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 874</span><span class="w">                                     </span><span class="n">pzs1</span><span class="p">,</span><span class="n">pzs2</span><span class="p">,</span><span class="n">pxs1</span><span class="p">,</span><span class="n">pxs2</span><span class="p">,</span><span class="n">wps1</span><span class="p">,</span><span class="n">wps2</span><span class="p">,</span><span class="n">lgradpx</span><span class="p">,</span><span class="n">lgradpz</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 875</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 876</span><span class="w">    </span><span class="c">!:Purpose: Determine weight coefficient contributions to w1 and w2 to assign</span>
<span class="linenos"> 877</span><span class="w">    </span><span class="c">!          to input domain (e.g. NWP model) variables at x1 and x2. Weights </span>
<span class="linenos"> 878</span><span class="w">    </span><span class="c">!          are determined from integration over the intersecting segment (y1,y2) </span>
<span class="linenos"> 879</span><span class="w">    </span><span class="c">!          of the ranges (x1,x2) for the input domain and (z1,z2) for the </span>
<span class="linenos"> 880</span><span class="w">    </span><span class="c">!          output domain. Integrals are approximated via the trapezoidal rule:</span>
<span class="linenos"> 881</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 882</span><span class="w">    </span><span class="c">!          integral of f(x)=w(x)*t(x) from y1 to y2</span>
<span class="linenos"> 883</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 884</span><span class="w">    </span><span class="c">!                                      = (f(y1)+f(y2))/2*(y2-y1)</span>
<span class="linenos"> 885</span><span class="w">    </span><span class="c">!                                      = w(y1)*t(y1)+w(y2)*t(y2)</span>
<span class="linenos"> 886</span><span class="w">    </span><span class="c">!                                      = w1*t(x1)+w2*t(x2)</span>
<span class="linenos"> 887</span><span class="w">    </span><span class="c">!                                      = w1*t1+w2*t2     </span>
<span class="linenos"> 888</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 889</span><span class="w">    </span><span class="c">!          This is synonomous to having an integrand linear in x.</span>
<span class="linenos"> 890</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 891</span><span class="w">    </span><span class="c">!          In the above (and below) equation(s), w1 and w2 are contributions to </span>
<span class="linenos"> 892</span><span class="w">    </span><span class="c">!          the input values.</span>
<span class="linenos"> 893</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 894</span><span class="w">    </span><span class="c">!          The weights for linearized contributions of non-linear interpolator</span>
<span class="linenos"> 895</span><span class="w">    </span><span class="c">!          components, i.e. gradient w.r.t. the vertical coordinate </span>
<span class="linenos"> 896</span><span class="w">    </span><span class="c">!          independent variable (e.g. v*=Ps), are calculated </span>
<span class="linenos"> 897</span><span class="w">    </span><span class="c">!          when LGRADP* is .true.:</span>
<span class="linenos"> 898</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 899</span><span class="w">    </span><span class="c">!                pzps = pzps + (df/dx1)*(dx1/dvx1)+(df/dx2)*(dx2/dvx2)</span>
<span class="linenos"> 900</span><span class="w">    </span><span class="c">!                            + (df/dz1)*(dz1/dvz1)+(df/dz2)*(dz2/dvz2)</span>
<span class="linenos"> 901</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 902</span><span class="w">    </span><span class="c">!                     = pzpz + (dw1/dx1*t1+dw2/dx1*t2)*pxs1</span>
<span class="linenos"> 903</span><span class="w">    </span><span class="c">!                            + (dw1/dx2*t1+dw2/dx2*t2)*pxs2</span>
<span class="linenos"> 904</span><span class="w">    </span><span class="c">!                            + (dw1/dz1*t1+dw2/dz1*t2)*pzs1</span>
<span class="linenos"> 905</span><span class="w">    </span><span class="c">!                            + (dw1/dz2*t1+dw2/dz2*t2)*pzs2</span>
<span class="linenos"> 906</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 907</span><span class="w">    </span><span class="c">!          This routine provides terms on the right-hand-side.</span>
<span class="linenos"> 908</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 909</span><span class="w">    </span><span class="c">!          Note: pxs* and pzs* can be provided either as gradients or </span>
<span class="linenos"> 910</span><span class="w">    </span><span class="c">!          perturbations.</span>
<span class="linenos"> 911</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 912</span><span class="w">    </span><span class="c">!          Method:</span>
<span class="linenos"> 913</span><span class="w">    </span><span class="c">!          - Piecewise weighted interpolation in ln(P).</span>
<span class="linenos"> 914</span><span class="w">    </span><span class="c">!          - Journal reference:</span>
<span class="linenos"> 915</span><span class="w">    </span><span class="c">!            Rochon, Y.J., L. Garand, D.S. Turner, and S. Polavarapu.</span>
<span class="linenos"> 916</span><span class="w">    </span><span class="c">!            Jacobian mapping between coordinate systems in data assimilation,</span>
<span class="linenos"> 917</span><span class="w">    </span><span class="c">!            Q. J. of the Royal Met. Soc., vol 133, 1547-1558, 2007. </span>
<span class="linenos"> 918</span><span class="w">    </span><span class="c">!            (www.interscience.wiley.com) DOI:10.1002/qj.117</span>
<span class="linenos"> 919</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 920</span><span class="w">    </span><span class="c">!           URL: </span>
<span class="linenos"> 921</span><span class="w">    </span><span class="c">!           http://www3.interscience.wiley.com/cgi-bin/fulltext/116320452/PDFSTART </span>
<span class="linenos"> 922</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 923</span><span class="w">    </span><span class="c">!:Comments:</span>
<span class="linenos"> 924</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 925</span><span class="w">    </span><span class="c">!     Assumptions:</span>
<span class="linenos"> 926</span><span class="w">    </span><span class="c">!     </span>
<span class="linenos"> 927</span><span class="w">    </span><span class="c">!        1) x1&lt;x2</span>
<span class="linenos"> 928</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 929</span><span class="w">    </span><span class="c">!        2) z1&lt;z2</span>
<span class="linenos"> 930</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 931</span><span class="w">    </span><span class="c">!        3) The ranges (z1,z2) and (x1,x2) overlap. The overlap region</span>
<span class="linenos"> 932</span><span class="w">    </span><span class="c">!        will be identified as (y1,y2) with y1&lt;y2.</span>
<span class="linenos"> 933</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 934</span><span class="w">    </span><span class="c">!     1) w(y1) and w(y2) are obtained by linear interpolation of the linear</span>
<span class="linenos"> 935</span><span class="w">    </span><span class="c">!     weighting function w with w(z1)=wgt1 and w(z2)=wgt2.</span>
<span class="linenos"> 936</span><span class="w">    </span><span class="c">!                                      </span>
<span class="linenos"> 937</span><span class="w">    </span><span class="c">!     2) The w1 and w2 above are determined by expanding t(y1) and t(y2)</span>
<span class="linenos"> 938</span><span class="w">    </span><span class="c">!     as linear functions of t(x1)=t1 and t(x2)=t2.</span>
<span class="linenos"> 939</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 940</span><span class="w">    </span><span class="c">!     3) The factor of 1/2 in</span>
<span class="linenos"> 941</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 942</span><span class="w">    </span><span class="c">!                          (f(y1)+f(y2))/2*(y2-y1)</span>
<span class="linenos"> 943</span><span class="w">    </span><span class="c">!                           = w(y1)*t(y1)+w(y2)*t(y2)</span>
<span class="linenos"> 944</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 945</span><span class="w">    </span><span class="c">!     is omitted as normalization is performed in the calling routine</span>
<span class="linenos"> 946</span><span class="w">    </span><span class="c">!     LAYERAVG.</span>
<span class="linenos"> 947</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 948</span><span class="w">    </span><span class="c">!     4) The code version of the interpolator part of &#39;int_sublayerInterpWgts&#39;</span>
<span class="linenos"> 949</span><span class="w">    </span><span class="c">!     provided for RTTOV-9 assumed the following conditions:</span>
<span class="linenos"> 950</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 951</span><span class="w">    </span><span class="c">!        (wgt1,wgt2)=(0,1),  d1=(y1-x1)=0 from y1=x1 or</span>
<span class="linenos"> 952</span><span class="w">    </span><span class="c">!                            wy1=0 from wgt1=0 and y1=z1,</span>
<span class="linenos"> 953</span><span class="w">    </span><span class="c">!     or</span>
<span class="linenos"> 954</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 955</span><span class="w">    </span><span class="c">!        (wgt1,wgt2)=(1,0),  d2=(y2-x2)=0 when y2=x2 or</span>
<span class="linenos"> 956</span><span class="w">    </span><span class="c">!                            wy2=0 from wgt2=0 and y2=z2</span>
<span class="linenos"> 957</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 958</span><span class="w">    </span><span class="c">!     and took account of the implications on d* and wy*.</span>
<span class="linenos"> 959</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 960</span><span class="w">    </span><span class="c">!     The version presented here has each step accompanied by</span>
<span class="linenos"> 961</span><span class="w">    </span><span class="c">!     related equations. It does not assume the above restrictions on  </span>
<span class="linenos"> 962</span><span class="w">    </span><span class="c">!     wgt1 and wgt2. This version is provided in the </span>
<span class="linenos"> 963</span><span class="w">    </span><span class="c">!     comments section of the RTTOV-9 module &#39;rttov_sublayer&#39;.</span>
<span class="linenos"> 964</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 965</span><span class="w">    </span><span class="c">!     5)  When LGRADP*=.true., this routine provides terms needed for </span>
<span class="linenos"> 966</span><span class="w">    </span><span class="c">!     the gradients w.r.t.the vertical coordinate independent variable, </span>
<span class="linenos"> 967</span><span class="w">    </span><span class="c">!     e.g. Ps. </span>
<span class="linenos"> 968</span><span class="w">    </span><span class="c">!                           </span>
<span class="linenos"> 969</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos"> 970</span>
<span class="linenos"> 971</span><span class="w">    </span><span class="c">!Arguments:                           </span>
<span class="linenos"> 972</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">LGRADPz</span><span class="w"> </span><span class="c">! Outpout domain logical indicating if gradient w.r.t. vertical coordinate </span>
<span class="linenos"> 973</span><span class="w">                                   </span><span class="c">! independent variable if required</span>
<span class="linenos"> 974</span><span class="w">				   </span><span class="c">! i.e. d/dv where P(v) (e.g. v=Ps).</span>
<span class="linenos"> 975</span><span class="w">                                   </span><span class="c">! True for yes.</span>
<span class="linenos"> 976</span>
<span class="linenos"> 977</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">LGRADPx</span><span class="w"> </span><span class="c">! Input domain logical indicating if gradient w.r.t. vertical coordinate </span>
<span class="linenos"> 978</span><span class="w">                                   </span><span class="c">! independent variable if required</span>
<span class="linenos"> 979</span><span class="w">				   </span><span class="c">! i.e. d/dv where P(v) (e.g. v=Ps).</span>
<span class="linenos"> 980</span><span class="w">                                   </span><span class="c">! True for yes.</span>
<span class="linenos"> 981</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">z1</span><span class="w">   </span><span class="c">! Upper level of output domain half-layer (z1&lt;z2)</span>
<span class="linenos"> 982</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">z2</span><span class="w">   </span><span class="c">! Lower level of output domain half-layer</span>
<span class="linenos"> 983</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">x1</span><span class="w">   </span><span class="c">! Upper boundary of input layer (x1&lt;x2)</span>
<span class="linenos"> 984</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">x2</span><span class="w">   </span><span class="c">! Lower boundary of input layer</span>
<span class="linenos"> 985</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">wgt1</span><span class="w"> </span><span class="c">! Weight at z1 (0.0 or 1.0 or ...)</span>
<span class="linenos"> 986</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">wgt2</span><span class="w"> </span><span class="c">! Weight at z2 (1.0 or 0.0 or ...)</span>
<span class="linenos"> 987</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">pzs1</span><span class="w"> </span><span class="c">! dz1/dvz or perturbation dz1/dvz * delta(vz)</span>
<span class="linenos"> 988</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">pzs2</span><span class="w"> </span><span class="c">! dz2/dvz or perturbation dz2/dvz * delta(vz)</span>
<span class="linenos"> 989</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">pxs1</span><span class="w"> </span><span class="c">! dx1/dvx or perturbation dx1/dvx * delta(vx)</span>
<span class="linenos"> 990</span><span class="w">                                 </span><span class="c">! (required when LGRADPx=.true.)</span>
<span class="linenos"> 991</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">pxs2</span><span class="w"> </span><span class="c">! dx2/dvx or perturbation dx2/dvx * delta(vx)</span>
<span class="linenos"> 992</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">dxd</span><span class="w">  </span><span class="c">! 1.0/(x2-x1)=1.0/dx</span>
<span class="linenos"> 993</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">dzd</span><span class="w">  </span><span class="c">! 1.0/(z2-z1)=1.0/dz</span>
<span class="linenos"> 994</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">w1</span><span class="w"> </span><span class="c">! Starting (in) and updated (out) weight </span>
<span class="linenos"> 995</span><span class="w">    </span><span class="c">!                            ! assigned to variable at upper level x1</span>
<span class="linenos"> 996</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">w2</span><span class="w"> </span><span class="c">! Starting (in) and updated (out) weight </span>
<span class="linenos"> 997</span><span class="w">    </span><span class="c">!                            ! assigned to variable at upper level x2</span>
<span class="linenos"> 998</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">wps1</span><span class="w"> </span><span class="c">! Starting (in) and updated (out) value of</span>
<span class="linenos"> 999</span><span class="w">    </span><span class="c">!                              ! (pxs1*dw1/dx1 + pxs2*dw1/dx2</span>
<span class="linenos">1000</span><span class="w">    </span><span class="c">!                              ! +pzs1*dw1/dz1 + pzs2*dw1/dz2)</span>
<span class="linenos">1001</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">wps2</span><span class="w"> </span><span class="c">! Starting (in) and updated (out) value of</span>
<span class="linenos">1002</span><span class="w">    </span><span class="c">!                              ! pxs1*dw2/dx1 + pxs2*dw2/dx2</span>
<span class="linenos">1003</span><span class="w">    </span><span class="c">!                              ! +pzs1*dw2/dz1 + pzs2*dw2/dz2)</span>
<span class="linenos">1004</span><span class="w">    </span><span class="c">!                              ! (required when LGRADP*=.true.)</span>
<span class="linenos">1005</span><span class="w">     </span>
<span class="linenos">1006</span><span class="w">    </span><span class="c">!Locals:           </span>
<span class="linenos">1007</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">y1</span><span class="w">  </span><span class="c">! Upper boundary of integral range (y1&lt;y2)</span>
<span class="linenos">1008</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">y2</span><span class="w">  </span><span class="c">! Lower boundary of integral range</span>
<span class="linenos">1009</span><span class="w">    </span><span class="kt">real</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">wx1</span><span class="p">,</span><span class="n">wx2</span><span class="p">,</span><span class="n">wy1</span><span class="p">,</span><span class="n">wy2</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dzdd</span><span class="w"></span>
<span class="linenos">1010</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">dxy1</span><span class="p">,</span><span class="n">dxy2</span><span class="p">,</span><span class="n">dxyd1</span><span class="p">,</span><span class="n">dxyd2</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="w"></span>
<span class="linenos">1011</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">dydzdd</span><span class="p">,</span><span class="n">dy1z1</span><span class="p">,</span><span class="n">dy2z2</span><span class="p">,</span><span class="n">d1d1</span><span class="p">,</span><span class="n">d1d2</span><span class="w"></span>
<span class="linenos">1012</span><span class="w">    </span><span class="kt">integer</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ibot</span><span class="p">,</span><span class="n">itop</span><span class="w"></span>
<span class="linenos">1013</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zthreshold</span><span class="w"></span>
<span class="linenos">1014</span>
<span class="linenos">1015</span><span class="w">    </span><span class="c">!  1. Initialization</span>
<span class="linenos">1016</span>
<span class="linenos">1017</span><span class="w">    </span><span class="c">!- Set upper and lower boundaries of integration layer (y1,y2):</span>
<span class="linenos">1018</span><span class="w">    </span><span class="c">!        (y1,y2) = ( max(x1,z1), min(x2,z2) )</span>
<span class="linenos">1019</span><span class="w">    </span><span class="n">itop</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1020</span><span class="w">    </span><span class="n">ibot</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1021</span><span class="w">    </span><span class="n">y1</span><span class="o">=</span><span class="n">z1</span><span class="w"></span>
<span class="linenos">1022</span><span class="w">    </span><span class="n">y2</span><span class="o">=</span><span class="n">z2</span><span class="w"></span>
<span class="linenos">1023</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">y1</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">x1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1024</span><span class="k">      </span><span class="n">y1</span><span class="o">=</span><span class="n">x1</span><span class="w"></span>
<span class="linenos">1025</span><span class="w">      </span><span class="n">itop</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1026</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1027</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">y2</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">x2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1028</span><span class="k">      </span><span class="n">y2</span><span class="o">=</span><span class="n">x2</span><span class="w"></span>
<span class="linenos">1029</span><span class="w">      </span><span class="n">ibot</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1030</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1031</span><span class="k">    </span><span class="n">dy</span><span class="o">=</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="w"></span>
<span class="linenos">1032</span>
<span class="linenos">1033</span><span class="w">    </span><span class="c">!- Verify for negative and zero (and near-zero) y2-y1 values.</span>
<span class="linenos">1034</span><span class="w">     </span>
<span class="linenos">1035</span><span class="w">    </span><span class="n">zthreshold</span><span class="o">=</span><span class="nb">epsilon</span><span class="p">(</span><span class="mf">1.0d0</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos">1036</span><span class="w">    </span><span class="n">c1</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span><span class="o">*</span><span class="n">zthreshold</span><span class="w"></span>
<span class="linenos">1037</span>
<span class="linenos">1038</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dy</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1039</span><span class="k">      write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;y1,y2 = &#39;</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">y2</span><span class="w"> </span>
<span class="linenos">1040</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;z1,z2 = &#39;</span><span class="p">,</span><span class="n">z1</span><span class="p">,</span><span class="n">z2</span><span class="w"> </span>
<span class="linenos">1041</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;x1,x2 = &#39;</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="w"></span>
<span class="linenos">1042</span><span class="w">      </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;ppo_sublayerInterpWgts: dy is negative&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1043</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">dy</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">c1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1044</span><span class="w">      </span><span class="c">! dy~0; weights can be taken as having values of zero.</span>
<span class="linenos">1045</span><span class="w">      </span><span class="c">! w1 and w2 unchanged.</span>
<span class="linenos">1046</span><span class="w">      </span><span class="k">return</span>
<span class="linenos">1047</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">1048</span><span class="w">    </span>
<span class="linenos">1049</span><span class="w">    </span><span class="c">!  2. Interpolation weights (equivalent to gradient contributions from</span>
<span class="linenos">1050</span><span class="w">    </span><span class="c">!     linear component of interpolator)</span>
<span class="linenos">1051</span>
<span class="linenos">1052</span><span class="w">    </span><span class="c">!- Determine w(y1) and w(y2) of the integral f = w(y1)*t(y1)+w(y2)*t(y2)</span>
<span class="linenos">1053</span><span class="w">    </span><span class="c">!                                              = wy1*t(y1)+wy2*t(y2)</span>
<span class="linenos">1054</span>
<span class="linenos">1055</span><span class="w">    </span><span class="c">!  Weights are obtained by linear interpolation of the linear</span>
<span class="linenos">1056</span><span class="w">    </span><span class="c">!  weighting function w with w(z1)=wgt1 and w(z2)=wgt2.</span>
<span class="linenos">1057</span>
<span class="linenos">1058</span><span class="w">    </span><span class="n">dzdd</span><span class="o">=</span><span class="n">dzd</span><span class="o">*</span><span class="p">(</span><span class="n">wgt2</span><span class="o">-</span><span class="n">wgt1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1059</span><span class="w">    </span><span class="n">dy1z1</span><span class="o">=</span><span class="n">y1</span><span class="o">-</span><span class="n">z1</span><span class="w"></span>
<span class="linenos">1060</span><span class="w">    </span><span class="n">wx1</span><span class="o">=</span><span class="n">wgt1</span><span class="o">+</span><span class="n">dy1z1</span><span class="o">*</span><span class="n">dzdd</span><span class="w"></span>
<span class="linenos">1061</span><span class="w">     </span>
<span class="linenos">1062</span><span class="w">    </span><span class="n">dydzdd</span><span class="o">=</span><span class="n">dy</span><span class="o">*</span><span class="n">dzdd</span><span class="w"></span>
<span class="linenos">1063</span><span class="w">    </span><span class="n">wx2</span><span class="o">=</span><span class="n">wx1</span><span class="o">+</span><span class="n">dydzdd</span><span class="w">    </span><span class="c">!  wx2=wgt1+(y2-z1)*dzdd=wgt2+(y2-z2)*dzdd</span>
<span class="linenos">1064</span><span class="w">     </span>
<span class="linenos">1065</span><span class="w">    </span><span class="n">wy1</span><span class="o">=</span><span class="n">dy</span><span class="o">*</span><span class="n">wx1</span><span class="w"></span>
<span class="linenos">1066</span><span class="w">    </span><span class="n">wy2</span><span class="o">=</span><span class="n">dy</span><span class="o">*</span><span class="n">wx2</span><span class="w"></span>
<span class="linenos">1067</span>
<span class="linenos">1068</span><span class="w">   </span><span class="c">!- Determine contribution of w1 and w2 for f=w1*t(x1)+w2*t(x2). </span>
<span class="linenos">1069</span>
<span class="linenos">1070</span><span class="w">   </span><span class="c">!  The w1 and w2 contributions above are determined by expanding t(y1)</span>
<span class="linenos">1071</span><span class="w">   </span><span class="c">!  and t(y2) in f = w(y1)*t(y1)+w(y2)*t(y2) as linear functions of </span>
<span class="linenos">1072</span><span class="w">   </span><span class="c">!  t(x1)=t1 and t(x2)=t2.</span>
<span class="linenos">1073</span><span class="w">   </span><span class="c">!</span>
<span class="linenos">1074</span><span class="w">   </span><span class="c">!        t(y1) = t1+(y1-x1)*(t2-t1)/(x2-x1) = t1+(y1-x1)*dxd*(t2-t1)</span>
<span class="linenos">1075</span><span class="w">   </span><span class="c">!        t(y2) = t2+(y2-x2)*(t2-t1)/(x2-x1) = t2+(y2-x2)*dxd*(t2-t1)</span>
<span class="linenos">1076</span><span class="w">   </span><span class="c">!</span>
<span class="linenos">1077</span><span class="w">   </span><span class="c">!  Therefore,</span>
<span class="linenos">1078</span><span class="w">   </span><span class="c">!</span>
<span class="linenos">1079</span><span class="w">   </span><span class="c">!        f = wy1*[t1+(y1-x1)*dxd*(t2-t1)]</span>
<span class="linenos">1080</span><span class="w">   </span><span class="c">!           +wy2*[t2+(y2-x2)*dxd*(t2-t1)]</span>
<span class="linenos">1081</span><span class="w">   </span><span class="c">!</span>
<span class="linenos">1082</span><span class="w">   </span><span class="c">!          = t1*[wy1-wy1*(y1-x1)*dxd-wy2*(y2-x2)*dxd]</span>
<span class="linenos">1083</span><span class="w">   </span><span class="c">!           +t2*[wy1*(y1-x1)*dxd+wy2+wy2*(y2-x2)*dxd]</span>
<span class="linenos">1084</span><span class="w">   </span><span class="c">!</span>
<span class="linenos">1085</span><span class="w">   </span><span class="c">!  Aside: Contribution to w1+w2 = wy1+wy2 = 2 * w[(y2+y1)/2]</span>
<span class="linenos">1086</span><span class="w"> </span>
<span class="linenos">1087</span><span class="w">    </span><span class="n">dxy1</span><span class="o">=</span><span class="n">y1</span><span class="o">-</span><span class="n">x1</span><span class="w"></span>
<span class="linenos">1088</span><span class="w">    </span><span class="n">d1</span><span class="o">=</span><span class="n">dxy1</span><span class="o">*</span><span class="n">dxd</span><span class="w"></span>
<span class="linenos">1089</span>
<span class="linenos">1090</span><span class="w">    </span><span class="n">dxy2</span><span class="o">=</span><span class="n">y2</span><span class="o">-</span><span class="n">x2</span><span class="w"></span>
<span class="linenos">1091</span><span class="w">    </span><span class="n">d2</span><span class="o">=</span><span class="n">dxy2</span><span class="o">*</span><span class="n">dxd</span><span class="w"></span>
<span class="linenos">1092</span><span class="w">    </span>
<span class="linenos">1093</span><span class="w">    </span><span class="n">d1d1</span><span class="o">=</span><span class="mf">1.0d0</span><span class="o">-</span><span class="n">d1</span><span class="w"></span>
<span class="linenos">1094</span><span class="w">    </span><span class="n">d1d2</span><span class="o">=</span><span class="mf">1.0d0</span><span class="o">+</span><span class="n">d2</span><span class="w">  </span>
<span class="linenos">1095</span>
<span class="linenos">1096</span><span class="w">    </span><span class="n">w1</span><span class="o">=</span><span class="n">w1</span><span class="o">+</span><span class="n">wy1</span><span class="o">*</span><span class="n">d1d1</span><span class="o">-</span><span class="n">wy2</span><span class="o">*</span><span class="n">d2</span><span class="w"></span>
<span class="linenos">1097</span><span class="w">    </span><span class="n">w2</span><span class="o">=</span><span class="n">w2</span><span class="o">+</span><span class="n">wy1</span><span class="o">*</span><span class="n">d1</span><span class="o">+</span><span class="n">wy2</span><span class="o">*</span><span class="n">d1d2</span><span class="w">  </span>
<span class="linenos">1098</span>
<span class="linenos">1099</span><span class="w">    </span><span class="c">!  Aside used below: wy1*d1d1-wy2*d2 = wy1 + wy2 - (wy1*d1d1-wy2*d2)</span>
<span class="linenos">1100</span>
<span class="linenos">1101</span><span class="w">    </span><span class="c">!  3. Provide gradient contributions from linearized terms of non-linear</span>
<span class="linenos">1102</span><span class="w">    </span><span class="c">!     component of interpolator (i.e. vertical coordinate dependency)</span>
<span class="linenos">1103</span>
<span class="linenos">1104</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">LGRADPx</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1105</span><span class="w">     </span>
<span class="linenos">1106</span><span class="w">      </span><span class="c">!  -- 3.1 Provide linearized contribution of non-linear interpolator</span>
<span class="linenos">1107</span><span class="w">      </span><span class="c">!     component to TLM - this part in relation to the input vertical  </span>
<span class="linenos">1108</span><span class="w">      </span><span class="c">!     coordinate:</span>
<span class="linenos">1109</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1110</span><span class="w">      </span><span class="c">!                    (df/dx1)*(dx1/dv)+(df/dx2)*(dx2/dv)</span>
<span class="linenos">1111</span><span class="w">      </span><span class="c">!                        =  (dw1/dx1*t1+dw2/dx1*t2)*pxs1</span>
<span class="linenos">1112</span><span class="w">      </span><span class="c">!                         + (dw1/dx2*t1+dw2/dx2*t2)*pxs2</span>
<span class="linenos">1113</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1114</span><span class="w">      </span><span class="c">!     a1 and a2 are used below to denote dw*/dx1 and dw*/dx2.</span>
<span class="linenos">1115</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1116</span><span class="w">      </span><span class="c">!     Gradients of w1 and w2 with respect to x1 and x2 are done in two parts:</span>
<span class="linenos">1117</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1118</span><span class="w">      </span><span class="c">!          - Part I:  The gradients calc excludes the cases where one </span>
<span class="linenos">1119</span><span class="w">      </span><span class="c">!                     might have y1=x1 and or y2=x2.</span>
<span class="linenos">1120</span><span class="w">      </span><span class="c">!          - Part II: The gradient terms related to y1=x1 and or y2=x2 are</span>
<span class="linenos">1121</span><span class="w">      </span><span class="c">!                     added.</span>
<span class="linenos">1122</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1123</span><span class="w">      </span><span class="c">!  -- Gradient of f w.r.t x1</span>
<span class="linenos">1124</span><span class="w">      </span><span class="c">!    </span>
<span class="linenos">1125</span><span class="w">      </span><span class="c">!  -- Gradients of w1 and w2 w.r.t. x1:</span>
<span class="linenos">1126</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1127</span><span class="w">      </span><span class="c">!     PART I:</span>
<span class="linenos">1128</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1129</span><span class="w">      </span><span class="c">!         For this case:</span>
<span class="linenos">1130</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1131</span><span class="w">      </span><span class="c">!            d(d1)/dx1 = dxd*(-1+dxy1*dxd) </span>
<span class="linenos">1132</span><span class="w">      </span><span class="c">!            d(d2)/dx1 = dxd*dxy2*dxd</span>
<span class="linenos">1133</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1134</span><span class="w">      </span><span class="c">!            d(wy1)/dx1=0, d(wy2)/dx1=0</span>
<span class="linenos">1135</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1136</span><span class="w">      </span><span class="c">!         Note: d(dj)/dx* = 0.0 when dj=0.0 due to y1=x1 or y2=x2</span>
<span class="linenos">1137</span><span class="w">      </span>
<span class="linenos">1138</span><span class="w">      </span><span class="n">dxyd1</span><span class="o">=</span><span class="n">d1</span><span class="o">*</span><span class="n">dxd</span><span class="w"></span>
<span class="linenos">1139</span><span class="w">      </span><span class="n">dxyd2</span><span class="o">=</span><span class="n">d2</span><span class="o">*</span><span class="n">dxd</span><span class="w">                                </span>
<span class="linenos">1140</span><span class="w">      </span><span class="n">a1</span><span class="o">=</span><span class="n">wy1</span><span class="o">*</span><span class="p">(</span><span class="n">dxd</span><span class="o">-</span><span class="n">dxyd1</span><span class="p">)</span><span class="o">-</span><span class="n">wy2</span><span class="o">*</span><span class="n">dxyd2</span><span class="w"></span>
<span class="linenos">1141</span><span class="w">      </span><span class="n">a2</span><span class="o">=-</span><span class="n">a1</span><span class="w">        </span><span class="c">! a2=wy1*(-dxd+dxyd1)+wy2*dxyd2</span>
<span class="linenos">1142</span>
<span class="linenos">1143</span><span class="w">      </span><span class="c">!     PART II:</span>
<span class="linenos">1144</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1145</span><span class="w">      </span><span class="c">!        For the extra terms: (gradients w.r.t. y1=x1)</span>
<span class="linenos">1146</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1147</span><span class="w">      </span><span class="c">!            d(d1)/dy1 = dxd</span>
<span class="linenos">1148</span><span class="w">      </span><span class="c">!            d(d2)/dy1 = 0</span>
<span class="linenos">1149</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1150</span><span class="w">      </span><span class="c">!            d(wy1)/dy1 = -wx1+dzdd*dy</span>
<span class="linenos">1151</span><span class="w">      </span><span class="c">!            d(wy2)/dy1 = -wx2</span>
<span class="linenos">1152</span><span class="w">      </span>
<span class="linenos">1153</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">itop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1154</span>
<span class="linenos">1155</span><span class="w">        </span><span class="c">! Case y1=x1 (d1=0)</span>
<span class="linenos">1156</span>
<span class="linenos">1157</span><span class="w">        </span><span class="n">c1</span><span class="o">=</span><span class="n">wy1</span><span class="o">*</span><span class="n">dxd</span><span class="w"></span>
<span class="linenos">1158</span><span class="w">        </span><span class="n">c2</span><span class="o">=-</span><span class="n">wx1</span><span class="o">+</span><span class="n">dydzdd</span><span class="w"></span>
<span class="linenos">1159</span><span class="w">        </span><span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">-</span><span class="n">c1</span><span class="o">+</span><span class="n">c2</span><span class="o">+</span><span class="n">wx2</span><span class="o">*</span><span class="n">d2</span><span class="w"></span>
<span class="linenos">1160</span><span class="w">        </span><span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">+</span><span class="n">c1</span><span class="o">-</span><span class="n">wx2</span><span class="o">*</span><span class="n">d1d2</span><span class="w"></span>
<span class="linenos">1161</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1162</span>
<span class="linenos">1163</span><span class="w">      </span><span class="c">!  -- Add to accumulated gradient terms</span>
<span class="linenos">1164</span>
<span class="linenos">1165</span><span class="w">      </span><span class="n">wps1</span><span class="o">=</span><span class="n">wps1</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">pxs1</span><span class="w"></span>
<span class="linenos">1166</span><span class="w">      </span><span class="n">wps2</span><span class="o">=</span><span class="n">wps2</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">pxs1</span><span class="w"></span>
<span class="linenos">1167</span>
<span class="linenos">1168</span><span class="w">      </span><span class="c">!  -- Gradient of f w.r.t. x2</span>
<span class="linenos">1169</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1170</span><span class="w">      </span><span class="c">!  -- Gradients of w1 and w2 w.r.t. x2:</span>
<span class="linenos">1171</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1172</span><span class="w">      </span><span class="c">!     PART I:</span>
<span class="linenos">1173</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1174</span><span class="w">      </span><span class="c">!         For this case:</span>
<span class="linenos">1175</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1176</span><span class="w">      </span><span class="c">!            d(d1)/dx2 = -dxd*dxy1*dxd</span>
<span class="linenos">1177</span><span class="w">      </span><span class="c">!            d(d2)/dx2 = -dxd*(1+dxy2*dxd)</span>
<span class="linenos">1178</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1179</span><span class="w">      </span><span class="c">!            d(wy1)/dx2=0,  d(wy2)/dx2=0</span>
<span class="linenos">1180</span><span class="w">      </span>
<span class="linenos">1181</span><span class="w">      </span><span class="n">a1</span><span class="o">=</span><span class="n">wy1</span><span class="o">*</span><span class="n">dxyd1</span><span class="o">+</span><span class="n">wy2</span><span class="o">*</span><span class="p">(</span><span class="n">dxd</span><span class="o">+</span><span class="n">dxyd2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1182</span><span class="w">      </span><span class="n">a2</span><span class="o">=-</span><span class="n">a1</span><span class="w">         </span><span class="c">! a2=-wy1*dxyd1-wy2*(dxd+dxyd2)</span>
<span class="linenos">1183</span><span class="w">                    </span>
<span class="linenos">1184</span><span class="w">      </span><span class="c">!     PART II:</span>
<span class="linenos">1185</span><span class="w">      </span><span class="c">!     </span>
<span class="linenos">1186</span><span class="w">      </span><span class="c">!        For the extra terms: (gradients w.r.t. y2=x2)</span>
<span class="linenos">1187</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1188</span><span class="w">      </span><span class="c">!            d(d1)/dy2 = 0</span>
<span class="linenos">1189</span><span class="w">      </span><span class="c">!            d(d2)/dy2 = dxd</span>
<span class="linenos">1190</span><span class="w">      </span><span class="c">!            </span>
<span class="linenos">1191</span><span class="w">      </span><span class="c">!            d(wy1)/dy2 = wx1</span>
<span class="linenos">1192</span><span class="w">      </span><span class="c">!            d(wy2)/dy2 = wx2+dzdd*dy</span>
<span class="linenos">1193</span><span class="w">                </span>
<span class="linenos">1194</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ibot</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1195</span>
<span class="linenos">1196</span><span class="w">        </span><span class="c">! Case y2=x2 (d2=0)</span>
<span class="linenos">1197</span>
<span class="linenos">1198</span><span class="w">        </span><span class="n">c1</span><span class="o">=</span><span class="n">wy2</span><span class="o">*</span><span class="n">dxd</span><span class="w"></span>
<span class="linenos">1199</span><span class="w">        </span><span class="n">c2</span><span class="o">=</span><span class="n">wx2</span><span class="o">+</span><span class="n">dydzdd</span><span class="w"></span>
<span class="linenos">1200</span><span class="w">        </span><span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">-</span><span class="n">c1</span><span class="o">+</span><span class="n">wx1</span><span class="o">*</span><span class="n">d1d1</span><span class="w"></span>
<span class="linenos">1201</span><span class="w">        </span><span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">+</span><span class="n">c1</span><span class="o">+</span><span class="n">c2</span><span class="o">+</span><span class="n">wx1</span><span class="o">*</span><span class="n">d1</span><span class="w"></span>
<span class="linenos">1202</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1203</span>
<span class="linenos">1204</span><span class="w">      </span><span class="c">!  -- Add to accumulated gradient terms</span>
<span class="linenos">1205</span>
<span class="linenos">1206</span><span class="w">      </span><span class="n">wps1</span><span class="o">=</span><span class="n">wps1</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">pxs2</span><span class="w"></span>
<span class="linenos">1207</span><span class="w">      </span><span class="n">wps2</span><span class="o">=</span><span class="n">wps2</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">pxs2</span><span class="w"></span>
<span class="linenos">1208</span>
<span class="linenos">1209</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1210</span>
<span class="linenos">1211</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">LGRADPz</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1212</span><span class="w">     </span>
<span class="linenos">1213</span><span class="w">      </span><span class="c">!  -- 3.2 Provide linearized contribution of non-linear interpolator</span>
<span class="linenos">1214</span><span class="w">      </span><span class="c">!     component to the TLM - this part in relation to the output vertical </span>
<span class="linenos">1215</span><span class="w">      </span><span class="c">!     coordinate:</span>
<span class="linenos">1216</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1217</span><span class="w">      </span><span class="c">!                    (df/dz1)*(dz1/dv)+(df/dz2)*(dz2/dv)</span>
<span class="linenos">1218</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1219</span><span class="w">      </span><span class="c">!                        =  (dw1/dz1*t1+dw2/dz1*t2)*pzs1</span>
<span class="linenos">1220</span><span class="w">      </span><span class="c">!                         + (dw1/dz2*t1+dw2/dz2*t2)*pzs2</span>
<span class="linenos">1221</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1222</span><span class="w">      </span><span class="c">!     a1 and a2 are used below to denote dw*/dz1 and dw*/dz2.</span>
<span class="linenos">1223</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1224</span><span class="w">      </span><span class="c">!     Gradients of w1 and w2 with respect to z1 and z2 are done in two parts:</span>
<span class="linenos">1225</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1226</span><span class="w">      </span><span class="c">!          - Part I:  The gradients calc excludes the cases where one </span>
<span class="linenos">1227</span><span class="w">      </span><span class="c">!                     might have y1=z1 and or y2=z2.</span>
<span class="linenos">1228</span><span class="w">      </span><span class="c">!          - Part II: The gradient terms related to y1=z1 and or y2=z2 are</span>
<span class="linenos">1229</span><span class="w">      </span><span class="c">!                     added.</span>
<span class="linenos">1230</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1231</span><span class="w">      </span><span class="c">!  -- Gradient of f w.r.t z1</span>
<span class="linenos">1232</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1233</span><span class="w">      </span><span class="c">!  -- Gradients of w1 and w2 w.r.t. z1:</span>
<span class="linenos">1234</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1235</span><span class="w">      </span><span class="c">!     PART I: Excludes y1=z1 consideration</span>
<span class="linenos">1236</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1237</span><span class="w">      </span><span class="c">!        d(wy1)/dz1 = dy*dzdd*((y1-z1)*dzd-1)=dy*dzdd*(y1-z2)*dzd</span>
<span class="linenos">1238</span><span class="w">      </span><span class="c">!        d(wy2)/dz1 = dy*dzdd*(y2-z2)*dzd</span>
<span class="linenos">1239</span><span class="w">      </span>
<span class="linenos">1240</span><span class="w">      </span><span class="n">dy2z2</span><span class="o">=</span><span class="n">y2</span><span class="o">-</span><span class="n">z2</span><span class="w"></span>
<span class="linenos">1241</span><span class="w">      </span><span class="n">dxyd2</span><span class="o">=</span><span class="n">dydzdd</span><span class="o">*</span><span class="n">dzd</span><span class="w"></span>
<span class="linenos">1242</span><span class="w">      </span><span class="n">dxyd1</span><span class="o">=</span><span class="n">dxyd2</span><span class="o">*</span><span class="n">dy1z1</span><span class="w"></span>
<span class="linenos">1243</span><span class="w">      </span><span class="n">dxyd2</span><span class="o">=</span><span class="n">dxyd2</span><span class="o">*</span><span class="n">dy2z2</span><span class="w"></span>
<span class="linenos">1244</span><span class="w">      </span><span class="n">a1</span><span class="o">=</span><span class="p">(</span><span class="n">dxyd1</span><span class="o">-</span><span class="n">dydzdd</span><span class="p">)</span><span class="o">*</span><span class="n">d1d1</span><span class="o">-</span><span class="n">dxyd2</span><span class="o">*</span><span class="n">d2</span><span class="w"></span>
<span class="linenos">1245</span><span class="w">      </span><span class="n">a2</span><span class="o">=</span><span class="n">dxyd1</span><span class="o">+</span><span class="n">dxyd2</span><span class="o">-</span><span class="p">(</span><span class="n">dydzdd</span><span class="o">+</span><span class="n">a1</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">1246</span>
<span class="linenos">1247</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">itop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span>
<span class="linenos">1248</span>
<span class="linenos">1249</span><span class="w">        </span><span class="c">! PART II: y1=z1</span>
<span class="linenos">1250</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">1251</span><span class="w">        </span><span class="c">!          d(d1)/dy1 = dxd</span>
<span class="linenos">1252</span><span class="w">        </span><span class="c">!          d(d2)/dy1 = 0</span>
<span class="linenos">1253</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">1254</span><span class="w">        </span><span class="c">!          d(wy1)/dy1 = -wx1+dzdd*dy </span>
<span class="linenos">1255</span><span class="w">        </span><span class="c">!          d(wy2)/dy1 = -wx2</span>
<span class="linenos">1256</span>
<span class="linenos">1257</span><span class="w">        </span><span class="n">c1</span><span class="o">=</span><span class="n">wy1</span><span class="o">*</span><span class="n">dxd</span><span class="w"></span>
<span class="linenos">1258</span><span class="w">        </span><span class="n">c2</span><span class="o">=-</span><span class="n">wx1</span><span class="o">+</span><span class="n">dydzdd</span><span class="w"></span>
<span class="linenos">1259</span><span class="w">        </span><span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">-</span><span class="n">c1</span><span class="o">+</span><span class="n">c2</span><span class="o">*</span><span class="n">d1d1</span><span class="o">+</span><span class="n">wx2</span><span class="o">*</span><span class="n">d2</span><span class="w"></span>
<span class="linenos">1260</span><span class="w">        </span><span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">+</span><span class="n">c1</span><span class="o">+</span><span class="n">c2</span><span class="o">*</span><span class="n">d1</span><span class="o">-</span><span class="n">wx2</span><span class="o">*</span><span class="n">d1d2</span><span class="w"></span>
<span class="linenos">1261</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1262</span>
<span class="linenos">1263</span><span class="w">      </span><span class="c">!  -- Add to accumulated gradient terms</span>
<span class="linenos">1264</span>
<span class="linenos">1265</span><span class="w">      </span><span class="n">wps1</span><span class="o">=</span><span class="n">wps1</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">pzs1</span><span class="w"></span>
<span class="linenos">1266</span><span class="w">      </span><span class="n">wps2</span><span class="o">=</span><span class="n">wps2</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">pzs1</span><span class="w"></span>
<span class="linenos">1267</span>
<span class="linenos">1268</span><span class="w">      </span><span class="c">!  -- Gradient of f w.r.t. z2</span>
<span class="linenos">1269</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1270</span><span class="w">      </span><span class="c">!  -- Gradients of w1 and w2 w.r.t. z2:</span>
<span class="linenos">1271</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1272</span><span class="w">      </span><span class="c">!     PART I: Excludes y2=z2 consideration</span>
<span class="linenos">1273</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1274</span><span class="w">      </span><span class="c">!         d(wy1)/dz2 = -dy*dzdd*(y1-z1)*dzd</span>
<span class="linenos">1275</span><span class="w">      </span><span class="c">!         d(wy2)/dz2 = -dy*dzdd*(1+(y2-z2)*dzd)=-dy*dzdd*(y2-z1)*dzd</span>
<span class="linenos">1276</span><span class="w">      </span>
<span class="linenos">1277</span><span class="w">      </span><span class="n">a1</span><span class="o">=-</span><span class="n">dxyd1</span><span class="o">*</span><span class="n">d1d1</span><span class="o">+</span><span class="p">(</span><span class="n">dxyd2</span><span class="o">+</span><span class="n">dydzdd</span><span class="p">)</span><span class="o">*</span><span class="n">d2</span><span class="w"></span>
<span class="linenos">1278</span><span class="w">      </span><span class="n">a2</span><span class="o">=-</span><span class="p">(</span><span class="n">dxyd1</span><span class="o">+</span><span class="n">dxyd2</span><span class="o">+</span><span class="n">dydzdd</span><span class="o">+</span><span class="n">a1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1279</span>
<span class="linenos">1280</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ibot</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1281</span>
<span class="linenos">1282</span><span class="w">        </span><span class="c">! PART II: y2=z2</span>
<span class="linenos">1283</span><span class="w">        </span><span class="c">!     </span>
<span class="linenos">1284</span><span class="w">        </span><span class="c">!          d(d1)/dy2 = 0</span>
<span class="linenos">1285</span><span class="w">        </span><span class="c">!          d(d2)/dy2 = dxd</span>
<span class="linenos">1286</span><span class="w">        </span><span class="c">!            </span>
<span class="linenos">1287</span><span class="w">        </span><span class="c">!          d(wy1)/dy2 = wx1</span>
<span class="linenos">1288</span><span class="w">        </span><span class="c">!          d(wy2)/dy2 = wx2+dzdd*dy</span>
<span class="linenos">1289</span><span class="w">        </span>
<span class="linenos">1290</span><span class="w">        </span><span class="n">c1</span><span class="o">=</span><span class="n">wy2</span><span class="o">*</span><span class="n">dxd</span><span class="w"></span>
<span class="linenos">1291</span><span class="w">        </span><span class="n">c2</span><span class="o">=</span><span class="n">wx2</span><span class="o">+</span><span class="n">dydzdd</span><span class="w"></span>
<span class="linenos">1292</span><span class="w">        </span><span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="o">-</span><span class="n">c1</span><span class="o">-</span><span class="n">c2</span><span class="o">*</span><span class="n">d2</span><span class="o">+</span><span class="n">wx1</span><span class="o">*</span><span class="n">d1d1</span><span class="w"></span>
<span class="linenos">1293</span><span class="w">        </span><span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="o">+</span><span class="n">c1</span><span class="o">+</span><span class="n">c2</span><span class="o">*</span><span class="n">d1d2</span><span class="o">+</span><span class="n">wx1</span><span class="o">*</span><span class="n">d1</span><span class="w"> </span>
<span class="linenos">1294</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1295</span>
<span class="linenos">1296</span><span class="w">      </span><span class="c">!  -- Add to accumulated gradient terms</span>
<span class="linenos">1297</span>
<span class="linenos">1298</span><span class="w">      </span><span class="n">wps1</span><span class="o">=</span><span class="n">wps1</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">pzs2</span><span class="w"></span>
<span class="linenos">1299</span><span class="w">      </span><span class="n">wps2</span><span class="o">=</span><span class="n">wps2</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="n">pzs2</span><span class="w"></span>
<span class="linenos">1300</span>
<span class="linenos">1301</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1302</span>
<span class="linenos">1303</span><span class="k">  end subroutine </span><span class="n">ppo_sublayerInterpWgts</span><span class="w"></span>
<span class="linenos">1304</span>
<span class="linenos">1305</span><span class="w">  </span><span class="c">!==========================================================================</span>
<span class="linenos">1306</span><span class="w">  </span><span class="c">!--- Stand-alone integration (and averaging) routines providing weights ---</span>
<span class="linenos">1307</span><span class="w">  </span><span class="c">! For weights W(:,:) and initial vector X(:), the integrated (or average) </span>
<span class="linenos">1308</span><span class="w">  </span><span class="c">! values would be W*X.  </span>
<span class="linenos">1309</span>
<span class="linenos">1310</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1311</span><span class="w">  </span><span class="c">! ppo_vertLayersSetup</span>
<span class="linenos">1312</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1313</span><span class="w">  </span><span class="k">subroutine </span><span class="n">ppo_vertLayersSetup</span><span class="p">(</span><span class="n">operatorType</span><span class="p">,</span><span class="n">pressInput</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1314</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1315</span><span class="w">    </span><span class="c">!:Purpose: Preliminary calculations for producing components required for</span>
<span class="linenos">1316</span><span class="w">    </span><span class="c">!          vertical integration (or averaging) w.r.t. pressure for the full  </span>
<span class="linenos">1317</span><span class="w">    </span><span class="c">!          vertical rangeor a set of target layers. To be called before </span>
<span class="linenos">1318</span><span class="w">    </span><span class="c">!          routine ppo_vertIntegWgts or ppo_vertAvgWgts.</span>
<span class="linenos">1319</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1320</span><span class="w">    </span><span class="c">!          Integration calculations are performed appling quadratic interpolation </span>
<span class="linenos">1321</span><span class="w">    </span><span class="c">!          in P between level. </span>
<span class="linenos">1322</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1323</span><span class="w">    </span><span class="c">!:Input:</span>
<span class="linenos">1324</span><span class="w">    </span><span class="c">!         :operatorType:       &#39;integ&#39; for intergration; &#39;avg&#39; for averaging</span>
<span class="linenos">1325</span><span class="w">    </span><span class="c">!         :pressInput:         Reference input levels</span>
<span class="linenos">1326</span><span class="w">    </span><span class="c">!         :numInputLevs:       # of model vertical levels</span>
<span class="linenos">1327</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1328</span><span class="w">    </span><span class="c">!:Output:</span>
<span class="linenos">1329</span><span class="w">    </span><span class="c">!         :boundaries(numInputLevs+1):  Input layer boundaries assuming</span>
<span class="linenos">1330</span><span class="w">    </span><span class="c">!                                       provided input levels can be taken as</span>
<span class="linenos">1331</span><span class="w">    </span><span class="c">!                                       mid-layer values.</span>
<span class="linenos">1332</span><span class="w">    </span><span class="c">!         :weights:                     Second order Lagrangian</span>
<span class="linenos">1333</span><span class="w">    </span><span class="c">!                                       interp integration weights or </span>
<span class="linenos">1334</span><span class="w">    </span><span class="c">!                                       unity for averaging weights</span>
<span class="linenos">1335</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1336</span><span class="w">    </span><span class="c">!:Comments:</span>
<span class="linenos">1337</span><span class="w">    </span><span class="c">!         - This subroutine does the following:</span>
<span class="linenos">1338</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1339</span><span class="w">    </span><span class="c">!           - Setting of layer boundaries</span>
<span class="linenos">1340</span><span class="w">    </span><span class="c">!           - If integration, determining integration weights associated </span>
<span class="linenos">1341</span><span class="w">    </span><span class="c">!             to second order Lagrangian interpolation. Otherwise, initialize</span>
<span class="linenos">1342</span><span class="w">    </span><span class="c">!             weights to unity.</span>
<span class="linenos">1343</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1344</span><span class="w">    </span><span class="c">!         - Layer boundaries are taken as mid-point between provided levels in</span>
<span class="linenos">1345</span><span class="w">    </span><span class="c">!           lnP coordinate. Layer values are set to be the values</span>
<span class="linenos">1346</span><span class="w">    </span><span class="c">!           interpolated to the mid-point in P within the various layers.</span>
<span class="linenos">1347</span><span class="w">    </span><span class="c">!           Interpolation in P is done quadratically. </span>
<span class="linenos">1348</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1349</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1350</span>
<span class="linenos">1351</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1352</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">operatorType</span><span class="w">       </span><span class="c">! &#39;integ&#39; for integration; &#39;avg&#39; for averaging</span>
<span class="linenos">1353</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">    </span><span class="kd">::</span><span class="w"> </span><span class="n">numInputLevs</span><span class="w">             </span><span class="c">! # of model vertical levels</span>
<span class="linenos">1354</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">    </span><span class="kd">::</span><span class="w"> </span><span class="n">pressInput</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Reference input levels</span>
<span class="linenos">1355</span>
<span class="linenos">1356</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1357</span>
<span class="linenos">1358</span><span class="w">    </span><span class="kt">integer</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos">1359</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">zp</span><span class="p">,</span><span class="w"> </span><span class="n">zp1</span><span class="p">,</span><span class="w"> </span><span class="n">zp2</span><span class="p">,</span><span class="w"> </span><span class="n">zp3</span><span class="p">,</span><span class="w"> </span><span class="n">zr1</span><span class="p">,</span><span class="w"> </span><span class="n">zr2</span><span class="p">,</span><span class="w"> </span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1360</span>
<span class="linenos">1361</span><span class="w">    </span><span class="c">! Determine P boundaries of layers and save weights for</span>
<span class="linenos">1362</span><span class="w">    </span><span class="c">! use in setting integration (or averaging) weights.</span>
<span class="linenos">1363</span><span class="w">    </span><span class="c">! N.B.: Boundaries of layers set to mid-point between input levels</span>
<span class="linenos">1364</span><span class="w">      </span>
<span class="linenos">1365</span><span class="w">    </span><span class="c">! Calculate layer boundaries</span>
<span class="linenos">1366</span>
<span class="linenos">1367</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">boundaries</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">boundaries</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1368</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1369</span><span class="w">    </span>
<span class="linenos">1370</span><span class="w">    </span><span class="n">boundaries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">pressInput</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1371</span><span class="w">    </span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="n">pressInput</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1372</span>
<span class="linenos">1373</span><span class="w">    </span><span class="c">!$OMP PARALLEL DO PRIVATE(levelIndex)    </span>
<span class="linenos">1374</span><span class="w">    </span><span class="k">DO </span><span class="n">levelIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1375</span><span class="w">       </span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">pressInput</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pressInput</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1376</span><span class="w">    </span><span class="k">END DO</span><span class="w"></span>
<span class="linenos">1377</span><span class="w">    </span><span class="c">!$OMP END PARALLEL DO </span>
<span class="linenos">1378</span>
<span class="linenos">1379</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1380</span><span class="w">    </span>
<span class="linenos">1381</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">operatorType</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;avg&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1382</span><span class="w">    </span>
<span class="linenos">1383</span><span class="w">      </span><span class="c">! Initialize weights as scaling factors of unity.</span>
<span class="linenos">1384</span>
<span class="linenos">1385</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">weights</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w">      </span>
<span class="linenos">1386</span><span class="w">      </span><span class="n">weights</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos">1387</span><span class="w">    </span>
<span class="linenos">1388</span><span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1389</span>
<span class="linenos">1390</span><span class="w">      </span><span class="c">! Set second degree Lagrangian interpolator weights</span>
<span class="linenos">1391</span>
<span class="linenos">1392</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">weights</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">))</span><span class="w">            </span>
<span class="linenos">1393</span><span class="w">      </span><span class="n">weights</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">1394</span><span class="w">    </span>
<span class="linenos">1395</span><span class="w">      </span><span class="c">! Interpolation to mid-layer level in P using</span>
<span class="linenos">1396</span><span class="w">      </span><span class="c">! second degree Lagrangian interpolator.</span>
<span class="linenos">1397</span><span class="w">      </span><span class="c">! N.B.: Integration is w.r.t. P</span>
<span class="linenos">1398</span><span class="w">    </span>
<span class="linenos">1399</span><span class="w">      </span><span class="c">! Calculating for levelIndex=1</span>
<span class="linenos">1400</span><span class="w">    </span>
<span class="linenos">1401</span><span class="w">      </span><span class="n">zp1</span><span class="o">=</span><span class="w"> </span><span class="n">pressInput</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1402</span><span class="w">      </span><span class="n">zp2</span><span class="o">=</span><span class="w"> </span><span class="n">pressInput</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1403</span><span class="w">      </span><span class="n">zp3</span><span class="o">=</span><span class="w"> </span><span class="n">pressInput</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1404</span><span class="w">      </span><span class="n">zp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">boundaries</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span><span class="w"></span>
<span class="linenos">1405</span><span class="w">      </span><span class="n">zr1</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1406</span><span class="w">      </span><span class="n">zr2</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1407</span><span class="w">      </span><span class="n">zr3</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1408</span><span class="w">      </span><span class="n">weights</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zr1</span><span class="w"></span>
<span class="linenos">1409</span><span class="w">      </span><span class="n">weights</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zr2</span><span class="w"></span>
<span class="linenos">1410</span><span class="w">      </span><span class="n">weights</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1411</span>
<span class="linenos">1412</span><span class="w">      </span><span class="c">!$OMP PARALLEL DO PRIVATE(levelIndex,zp1,zp2,zp3,zp,zr1,zr2,zr3)    </span>
<span class="linenos">1413</span><span class="w">      </span><span class="k">DO </span><span class="n">levelIndex</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">numInputLevs</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1414</span><span class="w">        </span><span class="n">zp1</span><span class="o">=</span><span class="n">pressInput</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1415</span><span class="w">        </span><span class="n">zp2</span><span class="o">=</span><span class="n">pressInput</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1416</span><span class="w">        </span><span class="n">zp3</span><span class="o">=</span><span class="n">pressInput</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1417</span><span class="w">        </span><span class="n">zp</span><span class="o">=</span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span><span class="w"></span>
<span class="linenos">1418</span><span class="w">        </span><span class="n">zr1</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1419</span><span class="w">        </span><span class="n">zr2</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1420</span><span class="w">        </span><span class="n">zr3</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1421</span><span class="w">        </span><span class="n">weights</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">zr1</span><span class="w"></span>
<span class="linenos">1422</span><span class="w">        </span><span class="n">weights</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">zr2</span><span class="w"></span>
<span class="linenos">1423</span><span class="w">        </span><span class="n">weights</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1424</span><span class="w">      </span><span class="k">ENDDO</span><span class="w"></span>
<span class="linenos">1425</span><span class="w">      </span><span class="c">!$OMP END PARALLEL DO </span>
<span class="linenos">1426</span><span class="w">    </span>
<span class="linenos">1427</span><span class="w">      </span><span class="c">! Calculating  for levelIndex=numInputLevs</span>
<span class="linenos">1428</span><span class="w">    </span>
<span class="linenos">1429</span><span class="w">      </span><span class="n">zp1</span><span class="o">=</span><span class="w"> </span><span class="n">pressInput</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1430</span><span class="w">      </span><span class="n">zp2</span><span class="o">=</span><span class="w"> </span><span class="n">pressInput</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1431</span><span class="w">      </span><span class="n">zp3</span><span class="o">=</span><span class="w"> </span><span class="n">pressInput</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1432</span><span class="w">      </span><span class="n">zp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span><span class="w"></span>
<span class="linenos">1433</span><span class="w">      </span><span class="n">zr1</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1434</span><span class="w">      </span><span class="n">zr2</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1435</span><span class="w">      </span><span class="n">zr3</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1436</span><span class="w">      </span><span class="n">weights</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">)</span><span class="o">=</span><span class="n">zr1</span><span class="w"></span>
<span class="linenos">1437</span><span class="w">      </span><span class="n">weights</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">)</span><span class="o">=</span><span class="n">zr2</span><span class="w"></span>
<span class="linenos">1438</span><span class="w">      </span><span class="n">weights</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">)</span><span class="o">=</span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1439</span>
<span class="linenos">1440</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1441</span>
<span class="linenos">1442</span><span class="k">  end subroutine </span><span class="n">ppo_vertLayersSetup</span><span class="w"></span>
<span class="linenos">1443</span>
<span class="linenos">1444</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1445</span><span class="w">  </span><span class="c">! ppo_vertIntegWgts</span>
<span class="linenos">1446</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1447</span><span class="w">  </span><span class="k">subroutine </span><span class="n">ppo_vertIntegWgts</span><span class="p">(</span><span class="n">targetLayersTop</span><span class="p">,</span><span class="n">targetLayersBot</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1448</span><span class="w">                                </span><span class="n">numTargetLevs</span><span class="p">,</span><span class="n">kstart</span><span class="p">,</span><span class="n">kend</span><span class="p">,</span><span class="n">wgts</span><span class="p">,</span><span class="n">wgts_opt</span><span class="p">,</span><span class="n">skipType_opt</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1449</span><span class="w">                                </span><span class="n">outbound_opt</span><span class="p">,</span><span class="n">success_opt</span><span class="p">,</span><span class="n">dealloc_opt</span><span class="p">)</span><span class="w">   </span>
<span class="linenos">1450</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1451</span><span class="w">    </span><span class="c">!:Purpose: To calculate integration weights &quot;wgts&quot; required for vertical integration w.r.t.</span>
<span class="linenos">1452</span><span class="w">    </span><span class="c">!          pressure for the full vertical range or a set of target layers. </span>
<span class="linenos">1453</span><span class="w">    </span><span class="c">!          Given the calculated weights and a user intergrand array vector X, the integral </span>
<span class="linenos">1454</span><span class="w">    </span><span class="c">!          for a given layer i would be given by sum(wgts(i,:)*X(:))</span>
<span class="linenos">1455</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1456</span><span class="w">    </span><span class="c">!          Integration calculations are performed applying quadratic interpolation </span>
<span class="linenos">1457</span><span class="w">    </span><span class="c">!          in P between level.</span>
<span class="linenos">1458</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1459</span><span class="w">    </span><span class="c">!          Routine ppo_vertLayersSetup to be called beforehand to generate Lagrangian weights</span>
<span class="linenos">1460</span><span class="w">    </span><span class="c">!          and related layer boundaries (arrays &#39;weights&#39; and &#39;boundaries&#39;)</span>
<span class="linenos">1461</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">1462</span><span class="w">    </span><span class="c">!:Input:</span>
<span class="linenos">1463</span><span class="w">    </span><span class="c">!         :targetLayersTop:    top of target layers</span>
<span class="linenos">1464</span><span class="w">    </span><span class="c">!         :targetLayersBot:    bottom of target layers</span>
<span class="linenos">1465</span><span class="w">    </span><span class="c">!         :numInputLevs:       # of original/input vertical levels</span>
<span class="linenos">1466</span><span class="w">    </span><span class="c">!         :numTargetLevs:      # of target vertical levels</span>
<span class="linenos">1467</span><span class="w">    </span><span class="c">!         :kstart:             Index of first relevant original/input level for each target level</span>
<span class="linenos">1468</span><span class="w">    </span><span class="c">!         :kend:               Index of last relevant original/input level for each target level</span>
<span class="linenos">1469</span><span class="w">    </span><span class="c">!                              If kstart and kend are non-zero on input, </span>
<span class="linenos">1470</span><span class="w">    </span><span class="c">!                              the input are initial estimates of the values.</span>
<span class="linenos">1471</span><span class="w">    </span><span class="c">!         :weights:            See routine ppo_vertLayersSetup</span>
<span class="linenos">1472</span><span class="w">    </span><span class="c">!         :boundaries:         Boundaries of input layers</span>
<span class="linenos">1473</span><span class="w">    </span><span class="c">!         :skipType_opt:       Skipping processing of specific target layers depending on case:</span>
<span class="linenos">1474</span><span class="w">    </span><span class="c">!                              &#39;default&#39; - skipping application via input success_opt only</span>
<span class="linenos">1475</span><span class="w">    </span><span class="c">!                              &#39;doAll&amp;noExtrap&#39; - application of both success_opt and outbound_opt</span>
<span class="linenos">1476</span><span class="w">    </span><span class="c">!         :outbound_opt:       Flag set when beyond range of reference/input levels</span>
<span class="linenos">1477</span><span class="w">    </span><span class="c">!         :success_opt:        Logical indicating a valid target layer</span>
<span class="linenos">1478</span><span class="w">    </span><span class="c">!         :dealloc_opt:        Logical indicating if deallocation is desired when done. (default: .false.)</span>
<span class="linenos">1479</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1480</span><span class="w">    </span><span class="c">!:Output:</span>
<span class="linenos">1481</span><span class="w">    </span><span class="c">!         :wgts(numTargetLevs,numInputLevs):     Integration weights</span>
<span class="linenos">1482</span><span class="w">    </span><span class="c">!         :wgts_opt(numTargetLevs,numInputLevs): Part of integrtation weights not related to resolution</span>
<span class="linenos">1483</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1484</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1485</span>
<span class="linenos">1486</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1487</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">numInputLevs</span><span class="w">  </span><span class="c">! # of original/input vertical levels</span>
<span class="linenos">1488</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">numTargetLevs</span><span class="w"> </span><span class="c">! # of target vertical levels</span>
<span class="linenos">1489</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">targetLayersTop</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! top of target layers</span>
<span class="linenos">1490</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">targetLayersBot</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! bottom of target layers</span>
<span class="linenos">1491</span>
<span class="linenos">1492</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">wgts</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Averaging weights</span>
<span class="linenos">1493</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kstart</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Index of first relevant original/input level for each target level</span>
<span class="linenos">1494</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kend</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w">   </span><span class="c">! Index of last relevant original/input level for each target level</span>
<span class="linenos">1495</span>
<span class="linenos">1496</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skipType_opt</span><span class="w"> </span><span class="c">! Skipping processing of specific target layers depending on case</span>
<span class="linenos">1497</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">dealloc_opt</span><span class="w"> </span><span class="c">! Logical indicating if deallocation is desired when done</span>
<span class="linenos">1498</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Part of averaging weights not related to resolution</span>
<span class="linenos">1499</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">outbound_opt</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Flag indicating if obs outside input vertical range (0 for no)</span>
<span class="linenos">1500</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success_opt</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w">  </span><span class="c">! success of interpolation</span>
<span class="linenos">1501</span>
<span class="linenos">1502</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1503</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TargetIndex</span><span class="w">   </span>
<span class="linenos">1504</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1505</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skipType</span><span class="w"></span>
<span class="linenos">1506</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ivweights</span><span class="o">=</span><span class="mi">2</span><span class="w">  </span><span class="c">! Order of Lagrangian interpolation.</span>
<span class="linenos">1507</span>
<span class="linenos">1508</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">levelIndex</span><span class="p">,</span><span class="n">JK</span><span class="p">,</span><span class="n">ILMAX2</span><span class="p">,</span><span class="n">ILMIN2</span><span class="w"></span>
<span class="linenos">1509</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ILMIN</span><span class="p">,</span><span class="w"> </span><span class="n">ILMAX</span><span class="w"></span>
<span class="linenos">1510</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zp</span><span class="p">,</span><span class="w"> </span><span class="n">zp1</span><span class="p">,</span><span class="w"> </span><span class="n">zp2</span><span class="p">,</span><span class="w"> </span><span class="n">zp3</span><span class="p">,</span><span class="w"> </span><span class="n">zr1</span><span class="p">,</span><span class="w"> </span><span class="n">zr2</span><span class="p">,</span><span class="w"> </span><span class="n">zr3</span><span class="p">,</span><span class="w"> </span><span class="n">ptop</span><span class="p">,</span><span class="w"> </span><span class="n">pbtm</span><span class="w"></span>
<span class="linenos">1511</span><span class="w">    </span>
<span class="linenos">1512</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">skipType_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1513</span><span class="k">      </span><span class="n">skipType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skipType_opt</span><span class="w"></span>
<span class="linenos">1514</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">1515</span><span class="k">      </span><span class="n">skipType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos">1516</span><span class="w">    </span><span class="k">end if </span>
<span class="linenos">1517</span><span class="k"> </span>
<span class="linenos">1518</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">success_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1519</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">skipType</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;doAll&amp;noExtrap&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1520</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">outbound_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1521</span><span class="k">          where</span><span class="w"> </span><span class="p">(</span><span class="n">outbound_opt</span><span class="p">(:)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1522</span><span class="w">            </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1523</span><span class="w">          </span><span class="n">elsewhere</span><span class="w"></span>
<span class="linenos">1524</span><span class="w">            </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1525</span><span class="w">          </span><span class="k">end where</span>
<span class="linenos">1526</span><span class="k">        else</span>
<span class="linenos">1527</span><span class="k">          </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1528</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1529</span><span class="k">      else</span>
<span class="linenos">1530</span><span class="k">        </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">success_opt</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">1531</span><span class="w">      </span><span class="k">end if </span>
<span class="linenos">1532</span><span class="k">    else</span>
<span class="linenos">1533</span><span class="k">      </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1534</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1535</span><span class="k">        </span>
<span class="linenos">1536</span><span class="k">    do </span><span class="n">TargetIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numTargetLevs</span><span class="w"></span>
<span class="linenos">1537</span>
<span class="linenos">1538</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1539</span><span class="k">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="w"></span>
<span class="linenos">1540</span><span class="w">        </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="w">          </span>
<span class="linenos">1541</span><span class="w">        </span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1542</span><span class="w">        </span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1543</span><span class="w">        </span><span class="k">cycle</span>
<span class="linenos">1544</span><span class="k">      end if</span>
<span class="linenos">1545</span>
<span class="linenos">1546</span><span class="k">      </span><span class="n">ptop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetLayersTop</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1547</span><span class="w">      </span><span class="n">pbtm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetLayersBot</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1548</span><span class="w">         </span>
<span class="linenos">1549</span><span class="w">      </span><span class="c">! Find the range of vertical levels over which to perform the integration</span>
<span class="linenos">1550</span><span class="w">      </span><span class="c">! and set the integration weights over this range.</span>
<span class="linenos">1551</span><span class="w">          </span>
<span class="linenos">1552</span><span class="w">      </span><span class="n">ilmin</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1553</span><span class="w">      </span><span class="n">ilmax</span><span class="o">=</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1554</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptop</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.01</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1555</span><span class="w">          </span><span class="n">pbtm</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.99</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1556</span>
<span class="linenos">1557</span><span class="w">        </span><span class="c">! Total column integration part</span>
<span class="linenos">1558</span>
<span class="linenos">1559</span><span class="w">        </span><span class="c">!$OMP PARALLEL DO PRIVATE(jk,levelIndex)                  </span>
<span class="linenos">1560</span><span class="w">        </span><span class="k">do </span><span class="n">jk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1561</span><span class="w">          </span><span class="k">do </span><span class="n">levelIndex</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">jk</span><span class="o">-</span><span class="n">ivweights</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">,</span><span class="n">jk</span><span class="o">+</span><span class="n">ivweights</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1562</span><span class="w">            </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="o">=</span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1563</span><span class="w">	          </span><span class="o">+</span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1564</span><span class="w">                  </span><span class="o">-</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="o">*</span><span class="n">weights</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1565</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1566</span><span class="w">              </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="o">=</span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="o">+</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1567</span><span class="w">	                               </span><span class="n">weights</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1568</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">1569</span><span class="k">        end do</span><span class="w"></span>
<span class="linenos">1570</span><span class="w">        </span><span class="c">!$OMP END PARALLEL DO                 </span>
<span class="linenos">1571</span><span class="w">             </span>
<span class="linenos">1572</span><span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1573</span>
<span class="linenos">1574</span><span class="w">        </span><span class="c">! Partial column integration part (special treatment at boundaries)</span>
<span class="linenos">1575</span><span class="w">     </span>
<span class="linenos">1576</span><span class="w">        </span><span class="c">! Identify input layer boundaries just within the target layer.</span>
<span class="linenos">1577</span><span class="w">             </span>
<span class="linenos">1578</span><span class="w">        </span><span class="n">ilmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ppo_getLevelIndex</span><span class="p">(</span><span class="n">ptop</span><span class="p">,</span><span class="w"> </span><span class="n">boundaries</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1579</span><span class="w">        </span><span class="n">ilmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ppo_getLevelIndex</span><span class="p">(</span><span class="n">pbtm</span><span class="p">,</span><span class="w"> </span><span class="n">boundaries</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;btm&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1580</span><span class="w">               </span>
<span class="linenos">1581</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ilmin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ilmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1582</span>
<span class="linenos">1583</span><span class="w">          </span><span class="c">! Entire target layer within one input layer</span>
<span class="linenos">1584</span><span class="w">                </span>
<span class="linenos">1585</span><span class="w">          </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">ilmax</span><span class="w"></span>
<span class="linenos">1586</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="mi">3</span><span class="w"></span>
<span class="linenos">1587</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1588</span><span class="w">          </span><span class="n">zp1</span><span class="o">=</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1589</span><span class="w">          </span><span class="n">zp2</span><span class="o">=</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1590</span><span class="w">          </span><span class="n">zp3</span><span class="o">=</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1591</span><span class="w">          </span><span class="n">zp</span><span class="o">=</span><span class="p">(</span><span class="n">ptop</span><span class="o">+</span><span class="n">pbtm</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="w"></span>
<span class="linenos">1592</span><span class="w">          </span><span class="n">zr1</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1593</span><span class="w">          </span><span class="n">zr2</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1594</span><span class="w">          </span><span class="n">zr3</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1595</span><span class="w">                </span>
<span class="linenos">1596</span><span class="w">          </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">pbtm</span><span class="o">-</span><span class="n">ptop</span><span class="p">)</span><span class="o">*</span><span class="n">zr1</span><span class="w"></span>
<span class="linenos">1597</span><span class="w">          </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">pbtm</span><span class="o">-</span><span class="n">ptop</span><span class="p">)</span><span class="o">*</span><span class="n">zr2</span><span class="w"></span>
<span class="linenos">1598</span><span class="w">          </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">pbtm</span><span class="o">-</span><span class="n">ptop</span><span class="p">)</span><span class="o">*</span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1599</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1600</span><span class="k">            </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">zr1</span><span class="w"></span>
<span class="linenos">1601</span><span class="w">            </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">zr2</span><span class="w"></span>
<span class="linenos">1602</span><span class="w">            </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1603</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1604</span><span class="k">          </span><span class="n">ilmin</span><span class="o">=</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1605</span><span class="w">          </span><span class="n">ilmax</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos">1606</span><span class="w">                  </span>
<span class="linenos">1607</span><span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1608</span><span class="w">                </span>
<span class="linenos">1609</span><span class="w">          </span><span class="c">! Determine terms from the inner layers (excluding the lower and upper</span>
<span class="linenos">1610</span><span class="w">          </span><span class="c">! boundary layers when these layers not covering entire input layers)</span>
<span class="linenos">1611</span><span class="w">                </span>
<span class="linenos">1612</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pbtm</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">)</span><span class="o">*</span><span class="mf">0.99</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1613</span><span class="k">            </span><span class="n">ilmax2</span><span class="o">=</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1614</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">1615</span><span class="k">            </span><span class="n">ilmax2</span><span class="o">=</span><span class="n">ilmax</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1616</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1617</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">ptop</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.01</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1618</span><span class="k">            </span><span class="n">ilmin</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1619</span><span class="w">            </span><span class="n">ilmin2</span><span class="o">=</span><span class="n">ilmin</span><span class="w"></span>
<span class="linenos">1620</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">1621</span><span class="k">            </span><span class="n">ilmin2</span><span class="o">=</span><span class="n">ilmin</span><span class="w"></span>
<span class="linenos">1622</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1623</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">ilmin2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ilmax2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1624</span><span class="w">            </span><span class="c">!$OMP PARALLEL DO PRIVATE(jk,levelIndex)                  </span>
<span class="linenos">1625</span><span class="w">            </span><span class="k">do </span><span class="n">jk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilmin2</span><span class="p">,</span><span class="n">ilmax2</span><span class="w"></span>
<span class="linenos">1626</span><span class="w">              </span><span class="k">do </span><span class="n">levelIndex</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">jk</span><span class="o">-</span><span class="n">ivweights</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">,</span><span class="n">jk</span><span class="o">+</span><span class="n">ivweights</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1627</span><span class="w">                </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="o">=</span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1628</span><span class="w">                         </span><span class="o">-</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="o">*</span><span class="n">weights</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1629</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1630</span><span class="w">                  </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="o">=</span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span><span class="o">+</span><span class="n">weights</span><span class="p">(</span><span class="n">jk</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1631</span><span class="w">              </span><span class="k">end do</span>
<span class="linenos">1632</span><span class="k">            end do</span><span class="w"></span>
<span class="linenos">1633</span><span class="w">            </span><span class="c">!$OMP END PARALLEL DO               </span>
<span class="linenos">1634</span><span class="w">          </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1635</span><span class="w">                </span>
<span class="linenos">1636</span><span class="w">          </span><span class="c">! Determine terms from the lower and upper boundary layers</span>
<span class="linenos">1637</span><span class="w">          </span><span class="c">! when these layers do not cover entire input layers.</span>
<span class="linenos">1638</span><span class="w">                </span>
<span class="linenos">1639</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pbtm</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">)</span><span class="o">*</span><span class="mf">0.99</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1640</span><span class="k">                     </span>
<span class="linenos">1641</span><span class="k">            </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">ilmax</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1642</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1643</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="mi">3</span><span class="w"></span>
<span class="linenos">1644</span><span class="w">            </span><span class="n">zp1</span><span class="o">=</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1645</span><span class="w">            </span><span class="n">zp2</span><span class="o">=</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1646</span><span class="w">            </span><span class="n">zp3</span><span class="o">=</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1647</span><span class="w">            </span><span class="n">zp</span><span class="o">=</span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmax</span><span class="p">)</span><span class="o">+</span><span class="n">pbtm</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="w"></span>
<span class="linenos">1648</span><span class="w">            </span><span class="n">zr1</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1649</span><span class="w">            </span><span class="n">zr2</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1650</span><span class="w">            </span><span class="n">zr3</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1651</span><span class="w">                   </span>
<span class="linenos">1652</span><span class="w">            </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">pbtm</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmax</span><span class="p">))</span><span class="o">*</span><span class="n">zr1</span><span class="w"></span>
<span class="linenos">1653</span><span class="w">            </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">pbtm</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmax</span><span class="p">))</span><span class="o">*</span><span class="n">zr2</span><span class="w"></span>
<span class="linenos">1654</span><span class="w">            </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">pbtm</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmax</span><span class="p">))</span><span class="o">*</span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1655</span><span class="w">           </span>
<span class="linenos">1656</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1657</span><span class="k">              </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">zr1</span><span class="w"></span>
<span class="linenos">1658</span><span class="w">              </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">zr2</span><span class="w"></span>
<span class="linenos">1659</span><span class="w">              </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">+</span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1660</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos">1661</span><span class="k">            </span><span class="n">ilmax</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos">1662</span><span class="w">                  </span>
<span class="linenos">1663</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1664</span><span class="k">                  </span>
<span class="linenos">1665</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">ptop</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.01</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1666</span><span class="k">                     </span>
<span class="linenos">1667</span><span class="k">            </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">ilmin</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1668</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1669</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">numInputLevs</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">numInputLevs</span><span class="o">-</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1670</span><span class="w">            </span><span class="n">zp1</span><span class="o">=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1671</span><span class="w">            </span><span class="n">zp2</span><span class="o">=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1672</span><span class="w">            </span><span class="n">zp3</span><span class="o">=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1673</span><span class="w">            </span><span class="n">zp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmin</span><span class="p">)</span><span class="o">+</span><span class="n">ptop</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="w"></span>
<span class="linenos">1674</span><span class="w">            </span><span class="n">zr1</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp1</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1675</span><span class="w">            </span><span class="n">zr2</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp2</span><span class="o">-</span><span class="n">zp3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1676</span><span class="w">            </span><span class="n">zr3</span><span class="o">=</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">zp</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zp3</span><span class="o">-</span><span class="n">zp1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1677</span><span class="w">                   </span>
<span class="linenos">1678</span><span class="w">            </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmin</span><span class="p">)</span><span class="o">-</span><span class="n">ptop</span><span class="p">)</span><span class="o">*</span><span class="n">zr1</span><span class="w"></span>
<span class="linenos">1679</span><span class="w">            </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmin</span><span class="p">)</span><span class="o">-</span><span class="n">ptop</span><span class="p">)</span><span class="o">*</span><span class="n">zr2</span><span class="w"></span>
<span class="linenos">1680</span><span class="w">            </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmin</span><span class="p">)</span><span class="o">-</span><span class="n">ptop</span><span class="p">)</span><span class="o">*</span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1681</span><span class="w">                   </span>
<span class="linenos">1682</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1683</span><span class="k">              </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">+</span><span class="n">zr1</span><span class="w"></span>
<span class="linenos">1684</span><span class="w">              </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">zr2</span><span class="w"></span>
<span class="linenos">1685</span><span class="w">              </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">zr3</span><span class="w"></span>
<span class="linenos">1686</span><span class="w"> 	    </span><span class="k">end if</span>
<span class="linenos">1687</span><span class="k">            </span><span class="n">ilmin</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos">1688</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ilmax</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">ilmax</span><span class="o">=</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1689</span><span class="w">                   </span>
<span class="linenos">1690</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1691</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">ilmin</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ilmax</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">ilmin</span><span class="o">=</span><span class="n">ilmax</span><span class="o">-</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1692</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1693</span><span class="k">      end if</span>
<span class="linenos">1694</span>
<span class="linenos">1695</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1696</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">-</span><span class="n">ilmin</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1697</span><span class="w">	    </span><span class="nb">abs</span><span class="p">(</span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">-</span><span class="n">ilmax</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1698</span><span class="k">	    </span>
<span class="linenos">1699</span><span class="k">          write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ppo_vertIntegWgts: Suspected error in layer&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1700</span><span class="w">	        </span><span class="s1">&#39; identification: &#39;</span><span class="p">,</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">),</span><span class="n">ilmin</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1701</span><span class="w">	        </span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">),</span><span class="n">ilmax</span><span class="w"></span>
<span class="linenos">1702</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1703</span><span class="k">      end if</span>
<span class="linenos">1704</span>
<span class="linenos">1705</span><span class="k">      </span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="n">ilmin</span><span class="w"></span>
<span class="linenos">1706</span><span class="w">      </span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="n">ilmax</span><span class="w"></span>
<span class="linenos">1707</span><span class="w">       </span>
<span class="linenos">1708</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">1709</span>
<span class="linenos">1710</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">dealloc_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1711</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">dealloc_opt</span><span class="p">)</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">boundaries</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1712</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1713</span><span class="k">    </span>
<span class="linenos">1714</span><span class="k">  end subroutine </span><span class="n">ppo_vertIntegWgts</span><span class="w"></span>
<span class="linenos">1715</span>
<span class="linenos">1716</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1717</span><span class="w">  </span><span class="c">! ppo_getLevelIndex</span>
<span class="linenos">1718</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1719</span><span class="w">  </span><span class="kt">integer </span><span class="k">function </span><span class="n">ppo_getLevelIndex</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="w"> </span><span class="n">layerBoundaryLevels</span><span class="p">,</span><span class="w"> </span><span class="n">topbtm</span><span class="p">,</span><span class="w"> </span><span class="n">numBoundaries</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1720</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1721</span><span class="w">    </span><span class="c">!:Purpose: To get the vertical input level index for level</span>
<span class="linenos">1722</span><span class="w">    </span><span class="c">!          within target layer and nearest specified layer boundary.  </span>
<span class="linenos">1723</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1724</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1725</span>
<span class="linenos">1726</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1727</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">numBoundaries</span><span class="w">  </span><span class="c">! Number of layer boundaries       </span>
<span class="linenos">1728</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">level</span><span class="w">          </span><span class="c">! Target layer index      </span>
<span class="linenos">1729</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">layerBoundaryLevels</span><span class="p">(</span><span class="n">numBoundaries</span><span class="p">)</span><span class="w"> </span><span class="c">! Layer boundaries</span>
<span class="linenos">1730</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">topbtm</span><span class="w">      </span><span class="c">! indicating whether we are looking for top or bottom level</span>
<span class="linenos">1731</span>
<span class="linenos">1732</span><span class="w">    </span><span class="c">! Locals</span>
<span class="linenos">1733</span><span class="w">    </span><span class="kt">integer</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">ilev1</span><span class="p">,</span><span class="w"> </span><span class="n">ilev2</span><span class="w"></span>
<span class="linenos">1734</span><span class="w">    </span><span class="kt">integer</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos">1735</span>
<span class="linenos">1736</span><span class="w">    </span><span class="c">! Find the model levels adjacent to pressure level </span>
<span class="linenos">1737</span>
<span class="linenos">1738</span><span class="w">    </span><span class="c">! Default values</span>
<span class="linenos">1739</span><span class="w">    </span>
<span class="linenos">1740</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1741</span><span class="k">      if</span><span class="w"> </span><span class="p">((</span><span class="n">topbtm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;btm&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">topbtm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;BTM&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1742</span><span class="k">        </span><span class="n">ppo_getLevelIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numBoundaries</span><span class="w"></span>
<span class="linenos">1743</span><span class="w">      </span><span class="k">endif</span>
<span class="linenos">1744</span><span class="k">      if</span><span class="w"> </span><span class="p">((</span><span class="n">topbtm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;top&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">topbtm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TOP&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1745</span><span class="k">        </span><span class="n">ppo_getLevelIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1746</span><span class="w">      </span><span class="k">endif                                                  </span>
<span class="linenos">1747</span><span class="k">    endif</span>
<span class="linenos">1748</span><span class="k">      </span>
<span class="linenos">1749</span><span class="k">    </span><span class="n">ilev1</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1750</span><span class="w">    </span><span class="n">ilev2</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1751</span><span class="w">    </span><span class="k">do </span><span class="n">levelIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numBoundaries</span><span class="w"></span>
<span class="linenos">1752</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">layerBoundaryLevels</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1753</span><span class="k">        </span><span class="n">ilev1</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos">1754</span><span class="w">        </span><span class="n">ilev2</span><span class="o">=</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1755</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">1756</span><span class="k">        exit</span>
<span class="linenos">1757</span><span class="k">      endif</span>
<span class="linenos">1758</span><span class="k">    enddo</span><span class="w"></span>
<span class="linenos">1759</span>
<span class="linenos">1760</span><span class="w">    </span><span class="c">! Find the input level index</span>
<span class="linenos">1761</span>
<span class="linenos">1762</span><span class="w">    </span><span class="c">! If we are looking for top level, the index is the level immediately </span>
<span class="linenos">1763</span><span class="w">    </span><span class="c">! below. if looking for bottom level, the index is the one immediately </span>
<span class="linenos">1764</span><span class="w">    </span><span class="c">! above.</span>
<span class="linenos">1765</span><span class="w">    </span>
<span class="linenos">1766</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">topbtm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;btm&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">topbtm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;BTM&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1767</span><span class="k">      </span><span class="n">ppo_getLevelIndex</span><span class="o">=</span><span class="n">ilev1</span><span class="w"></span>
<span class="linenos">1768</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">((</span><span class="n">topbtm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;top&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">topbtm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TOP&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1769</span><span class="k">      </span><span class="n">ppo_getLevelIndex</span><span class="o">=</span><span class="n">ilev2</span><span class="w"></span>
<span class="linenos">1770</span><span class="w">    </span><span class="k">endif</span>
<span class="linenos">1771</span>
<span class="linenos">1772</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">ppo_getLevelIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">ppo_getLevelIndex</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1773</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ppo_getLevelIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">numBoundaries</span><span class="p">)</span><span class="w"> </span><span class="n">ppo_getLevelIndex</span><span class="o">=</span><span class="n">numBoundaries</span><span class="w"></span>
<span class="linenos">1774</span><span class="w">  </span>
<span class="linenos">1775</span><span class="w">  </span><span class="k">end function </span><span class="n">ppo_getLevelIndex</span><span class="w"></span>
<span class="linenos">1776</span>
<span class="linenos">1777</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1778</span><span class="w">  </span><span class="c">! ppo_vertAvgWgts</span>
<span class="linenos">1779</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1780</span><span class="w">  </span><span class="k">subroutine </span><span class="n">ppo_vertAvgWgts</span><span class="p">(</span><span class="n">targetLayersTop</span><span class="p">,</span><span class="n">targetLayersBot</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1781</span><span class="w">                             </span><span class="n">numTargetLevs</span><span class="p">,</span><span class="n">kstart</span><span class="p">,</span><span class="n">kend</span><span class="p">,</span><span class="n">wgts</span><span class="p">,</span><span class="n">wgts_opt</span><span class="p">,</span><span class="n">skipType_opt</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1782</span><span class="w">                             </span><span class="n">outbound_opt</span><span class="p">,</span><span class="n">success_opt</span><span class="p">,</span><span class="n">dealloc_opt</span><span class="p">)</span><span class="w">   </span>
<span class="linenos">1783</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1784</span><span class="w">    </span><span class="c">!:Purpose: To calculate averaging weights &quot;wgts&quot; required for vertical averaging </span>
<span class="linenos">1785</span><span class="w">    </span><span class="c">!          w.r.t. ln(pressure) for the full vertical range or a set of target layers. </span>
<span class="linenos">1786</span><span class="w">    </span><span class="c">!          Given the calculated weights and a user input array vector X, the average </span>
<span class="linenos">1787</span><span class="w">    </span><span class="c">!          for a given layer i would be given by sum(wgts(i,:)*X(:))</span>
<span class="linenos">1788</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1789</span><span class="w">    </span><span class="c">!          Routine ppo_vertLayersSetup to be called beforehand to initial weigths</span>
<span class="linenos">1790</span><span class="w">    </span><span class="c">!          and related layer boundaries (arrays &#39;weights&#39; and &#39;boundaries&#39;)</span>
<span class="linenos">1791</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">1792</span><span class="w">    </span><span class="c">!:Input:</span>
<span class="linenos">1793</span><span class="w">    </span><span class="c">!         :targetLayersTop:    top of target layers</span>
<span class="linenos">1794</span><span class="w">    </span><span class="c">!         :targetLayersBot:    bottom of target layers</span>
<span class="linenos">1795</span><span class="w">    </span><span class="c">!         :numInputLevs:       # of original/input vertical levels</span>
<span class="linenos">1796</span><span class="w">    </span><span class="c">!         :numTargetLevs:      # of target vertical levels</span>
<span class="linenos">1797</span><span class="w">    </span><span class="c">!         :kstart:             Index of first relevant original/input level for each target level</span>
<span class="linenos">1798</span><span class="w">    </span><span class="c">!         :kend:               Index of last relevant original/input level for each target level</span>
<span class="linenos">1799</span><span class="w">    </span><span class="c">!                              If kstart and kend are non-zero on input, </span>
<span class="linenos">1800</span><span class="w">    </span><span class="c">!                              the input are initial estimates of the values.</span>
<span class="linenos">1801</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">1802</span><span class="w">    </span><span class="c">!         :weights:            See routine ppo_vertLayersSetup</span>
<span class="linenos">1803</span><span class="w">    </span><span class="c">!         :boundaries:         Boundaries of input layers</span>
<span class="linenos">1804</span><span class="w">    </span><span class="c">!         :skipType_opt:       Skipping processing of specific target layers depending on case:</span>
<span class="linenos">1805</span><span class="w">    </span><span class="c">!                              &#39;default&#39; - skipping application via input success_opt only</span>
<span class="linenos">1806</span><span class="w">    </span><span class="c">!                              &#39;doAll&amp;noExtrap&#39; - application of both success_opt and outbound_opt</span>
<span class="linenos">1807</span><span class="w">    </span><span class="c">!         :outbound_opt:       Flag set when beyond range of reference/input levels</span>
<span class="linenos">1808</span><span class="w">    </span><span class="c">!         :success_opt:        Logical indicating a valid target layer</span>
<span class="linenos">1809</span><span class="w">    </span><span class="c">!         :dealloc_opt:        Logical indicating if deallocation is desired when done. (default: .false.)</span>
<span class="linenos">1810</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1811</span><span class="w">    </span><span class="c">!:Output:</span>
<span class="linenos">1812</span><span class="w">    </span><span class="c">!         :wgts(numTargetLevs,numInputLevs):     Averaging weights</span>
<span class="linenos">1813</span><span class="w">    </span><span class="c">!         :wgts_opt(numTargetLevs,numInputLevs): Part of averaging weights not related to resolution</span>
<span class="linenos">1814</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1815</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1816</span>
<span class="linenos">1817</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1818</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">numInputLevs</span><span class="w">  </span><span class="c">! # of original/input vertical levels</span>
<span class="linenos">1819</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">numTargetLevs</span><span class="w"> </span><span class="c">! # of target vertical levels</span>
<span class="linenos">1820</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">targetLayersTop</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! top of target layers</span>
<span class="linenos">1821</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">targetLayersBot</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! bottom of target layers</span>
<span class="linenos">1822</span>
<span class="linenos">1823</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">wgts</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Averaging weights</span>
<span class="linenos">1824</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kstart</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Index of first relevant original/input level for each target level</span>
<span class="linenos">1825</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kend</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w">   </span><span class="c">! Index of last relevant original/input level for each target level</span>
<span class="linenos">1826</span>
<span class="linenos">1827</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skipType_opt</span><span class="w"> </span><span class="c">! Skipping processing of specific target layers depending on case</span>
<span class="linenos">1828</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">dealloc_opt</span><span class="w"> </span><span class="c">! Logical indicating if deallocation is desired when done</span>
<span class="linenos">1829</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">,</span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Part of averaging weights not related to resolution</span>
<span class="linenos">1830</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">outbound_opt</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Flag indicating if obs outside input vertical range (0 for no)</span>
<span class="linenos">1831</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success_opt</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w">  </span><span class="c">! success of interpolation</span>
<span class="linenos">1832</span>
<span class="linenos">1833</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1834</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TargetIndex</span><span class="w">   </span>
<span class="linenos">1835</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="p">(</span><span class="n">numTargetLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1836</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skipType</span><span class="w"></span>
<span class="linenos">1837</span>
<span class="linenos">1838</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">levelIndex</span><span class="p">,</span><span class="n">ILMAX2</span><span class="p">,</span><span class="n">ILMIN2</span><span class="w"></span>
<span class="linenos">1839</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ILMIN</span><span class="p">,</span><span class="w"> </span><span class="n">ILMAX</span><span class="w"></span>
<span class="linenos">1840</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">SumWeights</span><span class="p">,</span><span class="w"> </span><span class="n">TargetLayerThickWgt</span><span class="p">,</span><span class="w"> </span><span class="n">ptop</span><span class="p">,</span><span class="w"> </span><span class="n">pbtm</span><span class="w"></span>
<span class="linenos">1841</span><span class="w">    </span>
<span class="linenos">1842</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">skipType_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1843</span><span class="k">      </span><span class="n">skipType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">skipType_opt</span><span class="w"></span>
<span class="linenos">1844</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">1845</span><span class="k">      </span><span class="n">skipType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos">1846</span><span class="w">    </span><span class="k">end if </span>
<span class="linenos">1847</span><span class="k"> </span>
<span class="linenos">1848</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">success_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1849</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">skipType</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;doAll&amp;noExtrap&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1850</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">outbound_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1851</span><span class="k">          where</span><span class="w"> </span><span class="p">(</span><span class="n">outbound_opt</span><span class="p">(:)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1852</span><span class="w">             </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1853</span><span class="w">          </span><span class="n">elsewhere</span><span class="w"></span>
<span class="linenos">1854</span><span class="w">             </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1855</span><span class="w">          </span><span class="k">end where</span>
<span class="linenos">1856</span><span class="k">        else</span>
<span class="linenos">1857</span><span class="k">           </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1858</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1859</span><span class="k">      else</span>
<span class="linenos">1860</span><span class="k">        </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">success_opt</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">1861</span><span class="w">      </span><span class="k">end if </span>
<span class="linenos">1862</span><span class="k">    else</span>
<span class="linenos">1863</span><span class="k">      </span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1864</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1865</span><span class="k">        </span>
<span class="linenos">1866</span><span class="k">    do </span><span class="n">TargetIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numTargetLevs</span><span class="w"></span>
<span class="linenos">1867</span>
<span class="linenos">1868</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1869</span><span class="k">        </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="w"></span>
<span class="linenos">1870</span><span class="w">        </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="w">          </span>
<span class="linenos">1871</span><span class="w">        </span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1872</span><span class="w">        </span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1873</span><span class="w">        </span><span class="k">cycle</span>
<span class="linenos">1874</span><span class="k">      end if</span>
<span class="linenos">1875</span>
<span class="linenos">1876</span><span class="k">      </span><span class="n">ptop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetLayersTop</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1877</span><span class="w">      </span><span class="n">pbtm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetLayersBot</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1878</span><span class="w">      </span><span class="n">TargetLayerThickWgt</span><span class="o">=</span><span class="mf">1.0D0</span><span class="o">/</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pbtm</span><span class="p">,</span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">ptop</span><span class="p">,</span><span class="n">boundaries</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">1879</span><span class="w">         </span>
<span class="linenos">1880</span><span class="w">      </span><span class="c">! Find the range of vertical levels over which to perform the averaging</span>
<span class="linenos">1881</span><span class="w">      </span><span class="c">! and set the averaging weights over this range.</span>
<span class="linenos">1882</span><span class="w">          </span>
<span class="linenos">1883</span><span class="w">      </span><span class="n">ilmin</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1884</span><span class="w">      </span><span class="n">ilmax</span><span class="o">=</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1885</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptop</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.01</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pbtm</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.99</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1886</span>
<span class="linenos">1887</span><span class="w">        </span><span class="c">! Total column averaging part</span>
<span class="linenos">1888</span>
<span class="linenos">1889</span><span class="w">        </span><span class="n">SumWeights</span><span class="o">=</span><span class="mf">1.0D0</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">numInputLevs</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1890</span><span class="w">        </span><span class="c">!$OMP PARALLEL DO PRIVATE(levelIndex)                  </span>
<span class="linenos">1891</span><span class="w">        </span><span class="k">do </span><span class="n">levelIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1892</span><span class="w">          </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1893</span><span class="w">                </span><span class="o">-</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="o">*</span><span class="n">TargetLayerThickWgt</span><span class="w"></span>
<span class="linenos">1894</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1895</span><span class="w">            </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">SumWeights</span><span class="w"></span>
<span class="linenos">1896</span><span class="w">        </span><span class="k">end do</span><span class="w"></span>
<span class="linenos">1897</span><span class="w">        </span><span class="c">!$OMP END PARALLEL DO                 </span>
<span class="linenos">1898</span><span class="w">             </span>
<span class="linenos">1899</span><span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1900</span>
<span class="linenos">1901</span><span class="w">        </span><span class="c">! Partial column averaging part (special treatment at boundaries)</span>
<span class="linenos">1902</span><span class="w">     </span>
<span class="linenos">1903</span><span class="w">        </span><span class="c">! Identify the vertical input level indices for levels</span>
<span class="linenos">1904</span><span class="w">        </span><span class="c">! within target layer and nearest specified layer boundary. </span>
<span class="linenos">1905</span>
<span class="linenos">1906</span><span class="w">        </span><span class="n">ilmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ppo_getLevelIndex</span><span class="p">(</span><span class="n">ptop</span><span class="p">,</span><span class="w"> </span><span class="n">boundaries</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1907</span><span class="w">        </span><span class="n">ilmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ppo_getLevelIndex</span><span class="p">(</span><span class="n">pbtm</span><span class="p">,</span><span class="w"> </span><span class="n">boundaries</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;btm&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">numInputLevs</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1908</span><span class="w">               </span>
<span class="linenos">1909</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ilmin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ilmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1910</span>
<span class="linenos">1911</span><span class="w">          </span><span class="c">! Entire target layer within one input layer</span>
<span class="linenos">1912</span><span class="w">                </span>
<span class="linenos">1913</span><span class="w">          </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">ilmin</span><span class="w"></span>
<span class="linenos">1914</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1915</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1916</span>
<span class="linenos">1917</span><span class="w">          </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0D0</span><span class="w"></span>
<span class="linenos">1918</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0D0</span><span class="w"></span>
<span class="linenos">1919</span><span class="w">	  </span>
<span class="linenos">1920</span><span class="w">          </span><span class="n">ilmin</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos">1921</span><span class="w">          </span><span class="n">ilmax</span><span class="o">=</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1922</span><span class="w">                  </span>
<span class="linenos">1923</span><span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1924</span><span class="w">                </span>
<span class="linenos">1925</span><span class="w">          </span><span class="c">! Determine terms from the inner layers (excluding the lower and upper</span>
<span class="linenos">1926</span><span class="w">          </span><span class="c">! boundary layers when these layers not covering entire input layers)</span>
<span class="linenos">1927</span><span class="w">                </span>
<span class="linenos">1928</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pbtm</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">)</span><span class="o">*</span><span class="mf">0.99</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1929</span><span class="k">            </span><span class="n">ilmax2</span><span class="o">=</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1930</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">1931</span><span class="k">            </span><span class="n">ilmax2</span><span class="o">=</span><span class="n">ilmax</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1932</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1933</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">ptop</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.01</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1934</span><span class="k">            </span><span class="n">ilmin</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1935</span><span class="w">            </span><span class="n">ilmin2</span><span class="o">=</span><span class="n">ilmin</span><span class="w"></span>
<span class="linenos">1936</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">1937</span><span class="k">            </span><span class="n">ilmin2</span><span class="o">=</span><span class="n">ilmin</span><span class="w"></span>
<span class="linenos">1938</span><span class="w">          </span><span class="k">end if	</span>
<span class="linenos">1939</span><span class="k">	    </span>
<span class="linenos">1940</span><span class="k">          </span><span class="n">SumWeights</span><span class="o">=</span><span class="mf">1.0D0</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">(</span><span class="n">ilmin</span><span class="p">:</span><span class="n">ilmax</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1941</span><span class="w">	  </span>
<span class="linenos">1942</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ilmin2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ilmax2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1943</span><span class="w">            </span><span class="c">!$OMP PARALLEL DO PRIVATE(levelIndex)                  </span>
<span class="linenos">1944</span><span class="w">            </span><span class="k">do </span><span class="n">levelIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilmin2</span><span class="p">,</span><span class="n">ilmax2</span><span class="w"></span>
<span class="linenos">1945</span><span class="w">              </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1946</span><span class="w">	        </span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">boundaries</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="o">*</span><span class="n">TargetLayerThickWgt</span><span class="w"></span>
<span class="linenos">1947</span><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">SumWeights</span><span class="w"></span>
<span class="linenos">1948</span><span class="w">            </span><span class="k">end do</span><span class="w"></span>
<span class="linenos">1949</span><span class="w">            </span><span class="c">!$OMP END PARALLEL DO               </span>
<span class="linenos">1950</span><span class="w">          </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1951</span><span class="w">                </span>
<span class="linenos">1952</span><span class="w">          </span><span class="c">! Determine terms from the lower and upper boundary layers</span>
<span class="linenos">1953</span><span class="w">          </span><span class="c">! when these layers do not cover entire input layers.</span>
<span class="linenos">1954</span><span class="w">                </span>
<span class="linenos">1955</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pbtm</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">numInputLevs</span><span class="p">)</span><span class="o">*</span><span class="mf">0.99</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1956</span><span class="k">                     </span>
<span class="linenos">1957</span><span class="k">            </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">ilmax</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1958</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1959</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1960</span><span class="w">                   </span>
<span class="linenos">1961</span><span class="w">            </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1962</span><span class="w">	      </span><span class="p">(</span><span class="n">pbtm</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmax</span><span class="p">))</span><span class="o">*</span><span class="n">TargetLayerThickWgt</span><span class="w"></span>
<span class="linenos">1963</span><span class="w">            </span>
<span class="linenos">1964</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">SumWeights</span><span class="w"></span>
<span class="linenos">1965</span>
<span class="linenos">1966</span><span class="w">            </span><span class="n">ilmax</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos">1967</span><span class="w">                  </span>
<span class="linenos">1968</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1969</span><span class="k">                  </span>
<span class="linenos">1970</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">ptop</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">boundaries</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.01</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1971</span><span class="k">                     </span>
<span class="linenos">1972</span><span class="k">            </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">ilmin</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1973</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1974</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">numInputLevs</span><span class="p">)</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">numInputLevs</span><span class="w"></span>
<span class="linenos">1975</span><span class="w">                   </span>
<span class="linenos">1976</span><span class="w">            </span><span class="n">wgts</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1977</span><span class="w">	      </span><span class="p">(</span><span class="n">boundaries</span><span class="p">(</span><span class="n">ilmin</span><span class="p">)</span><span class="o">-</span><span class="n">ptop</span><span class="p">)</span><span class="o">*</span><span class="n">TargetLayerThickWgt</span><span class="w"></span>
<span class="linenos">1978</span>
<span class="linenos">1979</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">wgts_opt</span><span class="p">))</span><span class="w"> </span><span class="n">wgts_opt</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">)</span><span class="o">=</span><span class="n">SumWeights</span><span class="w"></span>
<span class="linenos">1980</span><span class="w">	      </span>
<span class="linenos">1981</span><span class="w">            </span><span class="n">ilmin</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos">1982</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ilmax</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">ilmax</span><span class="o">=</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1983</span><span class="w">                   </span>
<span class="linenos">1984</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1985</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">ilmin</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ilmax</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">ilmin</span><span class="o">=</span><span class="n">ilmax</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1986</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1987</span><span class="k">      end if</span>
<span class="linenos">1988</span>
<span class="linenos">1989</span><span class="k">      </span><span class="n">kstart</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="n">ilmin</span><span class="w"></span>
<span class="linenos">1990</span><span class="w">      </span><span class="n">kend</span><span class="p">(</span><span class="n">TargetIndex</span><span class="p">)</span><span class="o">=</span><span class="n">ilmax</span><span class="w"></span>
<span class="linenos">1991</span><span class="w">       </span>
<span class="linenos">1992</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">1993</span>
<span class="linenos">1994</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">dealloc_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1995</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">dealloc_opt</span><span class="p">)</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">boundaries</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1996</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1997</span><span class="k">    </span>
<span class="linenos">1998</span><span class="k">  end subroutine </span><span class="n">ppo_vertAvgWgts</span><span class="w"></span>
<span class="linenos">1999</span><span class="w">   </span>
<span class="linenos">2000</span><span class="k">end module </span><span class="n">presProfileOperators_mod</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</section>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li><a href="../index.html">MIDAS  documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2018, ECCC.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>
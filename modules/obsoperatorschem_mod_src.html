<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>obsoperatorschem_mod source &mdash; MIDAS  documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="MIDAS  documentation" href="../index.html" /> 
  </head>
  <body>
  <div>
    <img src="../_static/MIDAS_header.png" alt="MIDAS" />
  </div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li><a href="../index.html">MIDAS  documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/modules/obsoperatorschem_mod_src.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <section id="obsoperatorschem-mod-source">
<h1>obsoperatorschem_mod source<a class="headerlink" href="#obsoperatorschem-mod-source" title="Permalink to this headline">Â¶</a></h1>
<blockquote>
<div><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="c">!-------------------------------------- LICENCE BEGIN ------------------------------------</span>
<span class="linenos">   2</span><span class="c">!Environment Canada - Atmospheric Science and Technology License/Disclaimer,</span>
<span class="linenos">   3</span><span class="c">!                     version 3; Last Modified: May 7, 2008.</span>
<span class="linenos">   4</span><span class="c">!This is free but copyrighted software; you can use/redistribute/modify it under the terms</span>
<span class="linenos">   5</span><span class="c">!of the Environment Canada - Atmospheric Science and Technology License/Disclaimer</span>
<span class="linenos">   6</span><span class="c">!version 3 or (at your option) any later version that should be found at:</span>
<span class="linenos">   7</span><span class="c">!http://collaboration.cmc.ec.gc.ca/science/rpn.comm/license.html</span>
<span class="linenos">   8</span><span class="c">!</span>
<span class="linenos">   9</span><span class="c">!This software is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;</span>
<span class="linenos">  10</span><span class="c">!without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="linenos">  11</span><span class="c">!See the above mentioned License/Disclaimer for more details.</span>
<span class="linenos">  12</span><span class="c">!You should have received a copy of the License/Disclaimer along with this software;</span>
<span class="linenos">  13</span><span class="c">!if not, you can write to: EC-RPN COMM Group, 2121 TransCanada, suite 500, Dorval (Quebec),</span>
<span class="linenos">  14</span><span class="c">!CANADA, H9P 1J3; or send e-mail to service.rpn@ec.gc.ca</span>
<span class="linenos">  15</span><span class="c">!-------------------------------------- LICENCE END --------------------------------------</span>
<span class="linenos">  16</span>
<span class="linenos">  17</span><span class="k">module </span><span class="n">obsOperatorsChem_mod</span><span class="w"></span>
<span class="linenos">  18</span><span class="w">  </span><span class="c">! MODULE obsOperatorsChem_mod (prefix=&#39;oopc&#39; category=&#39;5. Observation operators&#39;)</span>
<span class="linenos">  19</span><span class="w">  </span><span class="c">!</span>
<span class="linenos">  20</span><span class="w">  </span><span class="c">!:Purpose: Observation operators for CH obs family, including nonlinear, tangent-linear</span>
<span class="linenos">  21</span><span class="w">  </span><span class="c">!           and adjoint versions, and related setup and input routines.</span>
<span class="linenos">  22</span><span class="w">  </span><span class="c">!</span>
<span class="linenos">  23</span><span class="w">  </span><span class="k">use </span><span class="n">earthConstants_mod</span><span class="w"></span>
<span class="linenos">  24</span><span class="w">  </span><span class="k">use </span><span class="n">mathPhysConstants_mod</span><span class="w"></span>
<span class="linenos">  25</span><span class="w">  </span><span class="k">use </span><span class="n">obsSpaceData_mod</span><span class="w"></span>
<span class="linenos">  26</span><span class="w">  </span><span class="k">use </span><span class="n">columnData_mod</span><span class="w"> </span>
<span class="linenos">  27</span><span class="w">  </span><span class="k">use </span><span class="n">bufr_mod</span><span class="w"></span>
<span class="linenos">  28</span><span class="w">  </span><span class="k">use </span><span class="n">physicsFunctions_mod</span><span class="w"></span>
<span class="linenos">  29</span><span class="w">  </span><span class="k">use </span><span class="n">midasMpi_mod</span><span class="w"></span>
<span class="linenos">  30</span><span class="w">  </span><span class="k">use </span><span class="n">utilities_mod</span><span class="w"></span>
<span class="linenos">  31</span><span class="w">  </span><span class="k">use </span><span class="n">varNameList_mod</span><span class="w"></span>
<span class="linenos">  32</span><span class="w">  </span><span class="k">use </span><span class="n">obsSubSpaceData_mod</span><span class="w"></span>
<span class="linenos">  33</span><span class="w">  </span><span class="k">use </span><span class="n">obsFiles_mod</span><span class="w"></span>
<span class="linenos">  34</span><span class="w">  </span><span class="k">use </span><span class="n">codtyp_mod</span><span class="w"></span>
<span class="linenos">  35</span><span class="w">  </span><span class="k">use </span><span class="n">ozoneClim_mod</span><span class="w"></span>
<span class="linenos">  36</span><span class="w">  </span><span class="k">use </span><span class="n">presProfileOperators_mod</span><span class="w"></span>
<span class="linenos">  37</span><span class="w">  </span><span class="k">use </span><span class="n">timeCoord_mod</span><span class="w"></span>
<span class="linenos">  38</span><span class="w">  </span><span class="k">use </span><span class="n">bCovarSetupChem_mod</span><span class="w"></span>
<span class="linenos">  39</span><span class="w">  </span>
<span class="linenos">  40</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos">  41</span><span class="k">  save</span>
<span class="linenos">  42</span><span class="k">  private</span><span class="w"></span>
<span class="linenos">  43</span>
<span class="linenos">  44</span><span class="w">  </span><span class="c">! public procedures</span>
<span class="linenos">  45</span><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_CHobsoperators</span><span class="p">,</span><span class="w"> </span><span class="n">oopc_diagnOnly</span><span class="p">,</span><span class="w"> </span><span class="n">oopc_addEfftempObsfile</span><span class="w"></span>
<span class="linenos">  46</span>
<span class="linenos">  47</span><span class="w">  </span><span class="c">!-------------------------------------------------------------------------</span>
<span class="linenos">  48</span><span class="w">  </span><span class="c">! Various structures and parameters for the CH family</span>
<span class="linenos">  49</span>
<span class="linenos">  50</span><span class="w">  </span><span class="c">! module structures</span>
<span class="linenos">  51</span><span class="w">  </span><span class="c">! -----------------</span>
<span class="linenos">  52</span>
<span class="linenos">  53</span><span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">struct_oopc_obsoperators</span><span class="w">  </span>
<span class="linenos">  54</span><span class="w">  </span>
<span class="linenos">  55</span><span class="w">    </span><span class="c">!  Structure holding work variables for individual observation operator</span>
<span class="linenos">  56</span><span class="w">    </span><span class="c">!  applications</span>
<span class="linenos">  57</span><span class="w">    </span><span class="c">!     </span>
<span class="linenos">  58</span><span class="w">    </span><span class="c">!  Variable               Description</span>
<span class="linenos">  59</span><span class="w">    </span><span class="c">!  --------               -----------</span>
<span class="linenos">  60</span><span class="w">    </span><span class="c">!  nobslev                Number of observations in the profile</span>
<span class="linenos">  61</span><span class="w">    </span><span class="c">!  nmodlev                Number of model levels in the column</span>
<span class="linenos">  62</span><span class="w">    </span><span class="c">!  varno                  BUFR descriptor element for obs units</span>
<span class="linenos">  63</span><span class="w">    </span><span class="c">!  constituentId          BUFR code element of local GRIB Table 08046 identifying the constituent</span>
<span class="linenos">  64</span><span class="w">    </span><span class="c">!                         (similar to BUFR Table 08043)</span>
<span class="linenos">  65</span><span class="w">    </span><span class="c">!  operatorCategory       CH obs operator category. One of the following.</span>
<span class="linenos">  66</span><span class="w">    </span><span class="c">!                           &#39;Interp&#39;: interpolators</span>
<span class="linenos">  67</span><span class="w">    </span><span class="c">!                           &#39;Surface&#39;: surface point operators</span>
<span class="linenos">  68</span><span class="w">    </span><span class="c">!                           &#39;Integ&#39;: integration operators</span>
<span class="linenos">  69</span><span class="w">    </span><span class="c">!                           &#39;LayerAvg&#39;: layer averaging operators</span>
<span class="linenos">  70</span><span class="w">    </span><span class="c">!                         Automatically assigned based on obs BUFR element</span>
<span class="linenos">  71</span><span class="w">    </span><span class="c">!                         and, when relevant, assocciated obsinfo_chm content.</span>
<span class="linenos">  72</span><span class="w">    </span><span class="c">!  layerIdentified        .true. if a layer (with identified layer boundaries)</span>
<span class="linenos">  73</span><span class="w">    </span><span class="c">!                         .false if layer boundaries are not available.</span>
<span class="linenos">  74</span><span class="w">    </span><span class="c">!  valertop               Layer top (final work values in Pa)</span>
<span class="linenos">  75</span><span class="w">    </span><span class="c">!  vlayerbottom           Layer bottom (final work values in Pa)</span>
<span class="linenos">  76</span><span class="w">    </span><span class="c">!  zh                     Initial innovation model array (other than conversion constants)</span>
<span class="linenos">  77</span><span class="w">    </span><span class="c">!  zhp                    Part of innovation operator not related to resolution.</span>
<span class="linenos">  78</span><span class="w">    </span><span class="c">!  modlevindexTop         Top level of non-zero values in zh</span>
<span class="linenos">  79</span><span class="w">    </span><span class="c">!  modlevindexBot         Bottom level of non-zero values in zh</span>
<span class="linenos">  80</span><span class="w">    </span><span class="c">!  trial                  Trial (background) profile on model levels at observation location</span>
<span class="linenos">  81</span><span class="w">    </span><span class="c">!  tt                     Temperature profile on model levels (Kelvin)</span>
<span class="linenos">  82</span><span class="w">    </span><span class="c">!  hu                     Specific humidity  on model levels</span>
<span class="linenos">  83</span><span class="w">    </span><span class="c">!  height                 Height on model levels (m)</span>
<span class="linenos">  84</span><span class="w">    </span><span class="c">!  pp                     Pressure on model levels (Pa)</span>
<span class="linenos">  85</span><span class="w">    </span><span class="c">!  lat                    Latitude of observation (radians)</span>
<span class="linenos">  86</span><span class="w">    </span><span class="c">!  lon                    Longitude of observation (radians)</span>
<span class="linenos">  87</span><span class="w">    </span><span class="c">!  obslev                 Observation profile level values (OBS_PPP)</span>
<span class="linenos">  88</span><span class="w">    </span><span class="c">!  obsSpaceTrial          obs estimate on obs levels based on trial/background profile          </span>
<span class="linenos">  89</span><span class="w">    </span><span class="c">!  varName                Variable/obs nomvar</span>
<span class="linenos">  90</span><span class="w">    </span><span class="c">!  stnid                  Observation station ID</span>
<span class="linenos">  91</span><span class="w">    </span><span class="c">!  date                   YYYYMMDD (date of obs)</span>
<span class="linenos">  92</span><span class="w">    </span><span class="c">!  hhmm                   HHMM (time of obs)</span>
<span class="linenos">  93</span><span class="w">    </span><span class="c">!  obs_index              Observation index</span>
<span class="linenos">  94</span><span class="w">    </span><span class="c">!                         Note: Depending on the data of interest, the index of a required array element or </span>
<span class="linenos">  95</span><span class="w">    </span><span class="c">!                               profile associated to an observation can be identified from (lat,long,date,hhmm,</span>
<span class="linenos">  96</span><span class="w">    </span><span class="c">!                               stnid, optional task-dependent identifier if needed) or &quot;obs_index&quot;. </span>
<span class="linenos">  97</span><span class="w">    </span><span class="c">!                               The latter is for associations of data identified within</span>
<span class="linenos">  98</span><span class="w">    </span><span class="c">!                               processing of individual CPUs. Each of the two index identifiers is represented </span>
<span class="linenos">  99</span><span class="w">    </span><span class="c">!                               by the unique character string identifier &#39;code&#39; of struct_oss_obsdata</span>
<span class="linenos"> 100</span><span class="w">    </span><span class="c">!                               (e.g. see obsdata_get_header_code_r for use of (lat,long,date,hhmm,stnid)).</span>
<span class="linenos"> 101</span><span class="w">    </span><span class="c">!  vco                    Index of vertical coord type for obs</span>
<span class="linenos"> 102</span><span class="w">    </span><span class="c">!                           1 - Altitudes (m)</span>
<span class="linenos"> 103</span><span class="w">    </span><span class="c">!                           2 - Pressure (Pa)</span>
<span class="linenos"> 104</span><span class="w">    </span><span class="c">!                           3 - Channel index</span>
<span class="linenos"> 105</span><span class="w">    </span><span class="c">!                           4 - not provided with obs. Obs is for total column values.</span>
<span class="linenos"> 106</span><span class="w">    </span><span class="c">!                           5 - not provided with obs. Obs is a surface point value.</span>
<span class="linenos"> 107</span><span class="w">    </span><span class="c">!  iavgkern               Integer indicating if averaging kernels are to be applied. Value</span>
<span class="linenos"> 108</span><span class="w">    </span><span class="c">!                         of zero indicates no averaging kernel to be applied. Non-zero value</span>
<span class="linenos"> 109</span><span class="w">    </span><span class="c">!                         indicates index in oopc_avgkern%obsSubSpace arrays.</span>
<span class="linenos"> 110</span><span class="w">    </span><span class="c">!  applyGenOper           Indicates if the generalized observation operator should be applied</span>
<span class="linenos"> 111</span><span class="w">    </span><span class="c">!  columnBound            Boundary imposed on a column measurement</span>
<span class="linenos"> 112</span><span class="w">    </span><span class="c">!  ixtr                   Indicates when outside model vertical range (when &gt;0)</span>
<span class="linenos"> 113</span><span class="w">    </span><span class="c">!  success                Indicates if the observation is to be assimilated</span>
<span class="linenos"> 114</span><span class="w">    </span><span class="c">!                         or was successfully assimilated </span>
<span class="linenos"> 115</span><span class="w">    </span>
<span class="linenos"> 116</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nobslev</span><span class="p">,</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">constituentId</span><span class="p">,</span><span class="n">vco</span><span class="p">,</span><span class="n">varno</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">hhmm</span><span class="p">,</span><span class="n">iavgkern</span><span class="p">,</span><span class="n">obs_index</span><span class="w"></span>
<span class="linenos"> 117</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">layerIdentified</span><span class="p">,</span><span class="n">applyGenOper</span><span class="w"></span>
<span class="linenos"> 118</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span><span class="n">columnBound</span><span class="w"></span>
<span class="linenos"> 119</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">stnid</span><span class="w"></span>
<span class="linenos"> 120</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">operatorCategory</span><span class="w"></span>
<span class="linenos"> 121</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">varName</span><span class="w"></span>
<span class="linenos"> 122</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vlayertop</span><span class="p">(:),</span><span class="n">vlayerbottom</span><span class="p">(:),</span><span class="n">tt</span><span class="p">(:),</span><span class="n">height</span><span class="p">(:),</span><span class="n">pp</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 123</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zh</span><span class="p">(:,:),</span><span class="n">zhp</span><span class="p">(:,:),</span><span class="n">obslev</span><span class="p">(:),</span><span class="n">hu</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 124</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ixtr</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 125</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 126</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">trial</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 127</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">modlevindexTop</span><span class="p">(:),</span><span class="n">modlevindexBot</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 128</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obsSpaceTrial</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 129</span>
<span class="linenos"> 130</span><span class="w">  </span><span class="k">end type </span><span class="n">struct_oopc_obsoperators</span><span class="w"></span>
<span class="linenos"> 131</span><span class="w"> </span>
<span class="linenos"> 132</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oopc_obsoperators</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obsoper</span><span class="w"></span>
<span class="linenos"> 133</span><span class="w">  </span>
<span class="linenos"> 134</span><span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">struct_oopc_operatorsDepot</span><span class="w"> </span>
<span class="linenos"> 135</span><span class="w">  </span>
<span class="linenos"> 136</span><span class="w">    </span><span class="c">!  Structure holding saved arrays for observation operators</span>
<span class="linenos"> 137</span><span class="w">    </span><span class="c">!  A subset of &#39;struct_oopc_obsoperators&#39;</span>
<span class="linenos"> 138</span><span class="w">    </span><span class="c">!     </span>
<span class="linenos"> 139</span><span class="w">    </span><span class="c">!  Variable               Description</span>
<span class="linenos"> 140</span><span class="w">    </span><span class="c">!  --------               -----------</span>
<span class="linenos"> 141</span><span class="w">    </span><span class="c">!  nobslev                Number of observations in the profile</span>
<span class="linenos"> 142</span><span class="w">    </span><span class="c">!  valertop               Layer top (final work values in Pa)</span>
<span class="linenos"> 143</span><span class="w">    </span><span class="c">!  vlayerbottom           Layer bottom (final work values in Pa)</span>
<span class="linenos"> 144</span><span class="w">    </span><span class="c">!  zh                     Initial innovation model array (other than conversion constants)</span>
<span class="linenos"> 145</span><span class="w">    </span><span class="c">!  zhp                    Part of innovation operator not related to resolution.</span>
<span class="linenos"> 146</span><span class="w">    </span><span class="c">!  modlevindexTop         Top level of non-zero values in zh</span>
<span class="linenos"> 147</span><span class="w">    </span><span class="c">!  modlevindexBot         Bottom level of non-zero values in zh</span>
<span class="linenos"> 148</span><span class="w">    </span><span class="c">!  trial                  Trial (background) profile on model levels at observation location</span>
<span class="linenos"> 149</span><span class="w">    </span><span class="c">!  iavgkern               Integer indicating if averaging kernels are to be applied. Value</span>
<span class="linenos"> 150</span><span class="w">    </span><span class="c">!                         of zero indicates no averaging kernel to be applied. Non-zero value</span>
<span class="linenos"> 151</span><span class="w">    </span><span class="c">!                         indicates index in oopc_avgkern%obsSubSpace arrays.</span>
<span class="linenos"> 152</span><span class="w">    </span><span class="c">!  applyGenOper           Indicates if the generalized observation operator should be applied</span>
<span class="linenos"> 153</span><span class="w">    </span><span class="c">!  ixtr                   Indicates when outside model vertical range (when &gt;0)</span>
<span class="linenos"> 154</span><span class="w">    </span><span class="c">!  success                Indicates if the observation is to be assimilated</span>
<span class="linenos"> 155</span><span class="w">    </span><span class="c">!                         or was successfully assimilated </span>
<span class="linenos"> 156</span><span class="w">    </span>
<span class="linenos"> 157</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nobslev</span><span class="p">,</span><span class="n">iavgkern</span><span class="w"></span>
<span class="linenos"> 158</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">applyGenOper</span><span class="w"></span>
<span class="linenos"> 159</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vlayertop</span><span class="p">(:),</span><span class="n">vlayerbottom</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 160</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zh</span><span class="p">(:,:),</span><span class="n">zhp</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos"> 161</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ixtr</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 162</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 163</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">trial</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 164</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">modlevindexTop</span><span class="p">(:),</span><span class="n">modlevindexBot</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 165</span>
<span class="linenos"> 166</span><span class="w">  </span><span class="k">end type </span><span class="n">struct_oopc_operatorsDepot</span><span class="w"></span>
<span class="linenos"> 167</span>
<span class="linenos"> 168</span><span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">struct_oopc_info</span><span class="w"></span>
<span class="linenos"> 169</span><span class="w">  </span>
<span class="linenos"> 170</span><span class="w">    </span><span class="c">!  Information arrays retrieved from auxiliary file regarding vertical levels </span>
<span class="linenos"> 171</span><span class="w">    </span><span class="c">!  or averaging kernels</span>
<span class="linenos"> 172</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 173</span><span class="w">    </span><span class="c">!  Variable               Description</span>
<span class="linenos"> 174</span><span class="w">    </span><span class="c">!  --------               -----------</span>
<span class="linenos"> 175</span><span class="w">    </span><span class="c">!  n_stnid                Number of sub-families (identified via STNIDs)</span>
<span class="linenos"> 176</span><span class="w">    </span><span class="c">!  stnids                 Sub-families (STNIDs; * are wild cards)</span>
<span class="linenos"> 177</span><span class="w">    </span><span class="c">!  element                BUFR element in data block</span>
<span class="linenos"> 178</span><span class="w">    </span><span class="c">!  profElement            BUFR element of profile required by obs operator if</span>
<span class="linenos"> 179</span><span class="w">    </span><span class="c">!                         if it differs from &#39;element&#39; (e.g. see &#39;n_col&#39; and &#39;type&#39; below).</span>
<span class="linenos"> 180</span><span class="w">    </span><span class="c">!  source                 0: Set entirely from the auxiliary file being read. No </span>
<span class="linenos"> 181</span><span class="w">    </span><span class="c">!                            initial values read from observation files</span>
<span class="linenos"> 182</span><span class="w">    </span><span class="c">!                         1: Initial values in observation files for constant number</span>
<span class="linenos"> 183</span><span class="w">    </span><span class="c">!                            of vertical levels (may be adjusted after input)</span>
<span class="linenos"> 184</span><span class="w">    </span><span class="c">!  vco                    Index of vertical coord type for obs</span>
<span class="linenos"> 185</span><span class="w">    </span><span class="c">!                           1 - Altitudes (m)</span>
<span class="linenos"> 186</span><span class="w">    </span><span class="c">!                           2 - Pressure (Pa)</span>
<span class="linenos"> 187</span><span class="w">    </span><span class="c">!                           3 - Channel index</span>
<span class="linenos"> 188</span><span class="w">    </span><span class="c">!                           4 - not provided with obs. Obs is for total column values.</span>
<span class="linenos"> 189</span><span class="w">    </span><span class="c">!                           5 - not provided with obs. Obs is a surface point value.</span>
<span class="linenos"> 190</span><span class="w">    </span><span class="c">!                           6 - sigma vertical coordinate (*Psfc to give levels in Pa); in this module only.</span>
<span class="linenos"> 191</span><span class="w">    </span><span class="c">!  ibegin                 Position index of start of data for given</span>
<span class="linenos"> 192</span><span class="w">    </span><span class="c">!                         sub-family.</span>
<span class="linenos"> 193</span><span class="w">    </span><span class="c">!  n_lvl                  Lengh of corresponding obs profile (number of rows)</span>
<span class="linenos"> 194</span><span class="w">    </span><span class="c">!  n_col                  Length of array for each obs element (number of columns; optional) </span>
<span class="linenos"> 195</span><span class="w">    </span><span class="c">!                         - Usually n_lvl will be the number of vertical levels of profiles </span>
<span class="linenos"> 196</span><span class="w">    </span><span class="c">!                           and n_col is not needed.</span>
<span class="linenos"> 197</span><span class="w">    </span><span class="c">!                         - For averaging kernels:</span>
<span class="linenos"> 198</span><span class="w">    </span><span class="c">!                            - When the obs are single level data, n_lvl=1 or 2. If it requires more levels</span>
<span class="linenos"> 199</span><span class="w">    </span><span class="c">!                              or data for observation operators, n_col = number of additional data </span>
<span class="linenos"> 200</span><span class="w">    </span><span class="c">!                            - The a-priori contribution (I-A)xa can be added as the element on each row.</span>
<span class="linenos"> 201</span><span class="w">    </span><span class="c">!                              When done and n_lvl&gt;1, n_col would be expected to be n_lvl+1</span>
<span class="linenos"> 202</span><span class="w">    </span><span class="c">!                            - If an integeration over the n_lvl values (&gt;1) needs to be performed,</span>
<span class="linenos"> 203</span><span class="w">    </span><span class="c">!                              the column n_col = n_lvl+2 provides the integration weights for a summations</span>
<span class="linenos"> 204</span><span class="w">    </span><span class="c">!                              that gives the integral.</span>
<span class="linenos"> 205</span><span class="w">    </span><span class="c">!                         - For vertical levels:</span>
<span class="linenos"> 206</span><span class="w">    </span><span class="c">!                            - n_col will be set to 2 as default for layer boundaries</span>
<span class="linenos"> 207</span><span class="w">    </span><span class="c">!                            - n_col needs to be set to 1 to use this simply as a single vertical level profile</span>
<span class="linenos"> 208</span><span class="w">    </span><span class="c">!  n_lat                  Number of latitudes</span>
<span class="linenos"> 209</span><span class="w">    </span><span class="c">!  lat                    Latitudes (degrees; ordered in increasing size)</span>
<span class="linenos"> 210</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 211</span><span class="w">    </span><span class="c">!  vlayertop              Layer top </span>
<span class="linenos"> 212</span><span class="w">    </span><span class="c">!  vlayerbottom           Layer bottom</span>
<span class="linenos"> 213</span><span class="w">    </span><span class="c">!  rak                    Averaging kernel matrices</span>
<span class="linenos"> 214</span><span class="w">    </span><span class="c">!  type                   Operation subtypes.</span>
<span class="linenos"> 215</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 216</span><span class="w">    </span><span class="c">!                         Currently relevant only for averaging kernels:</span>
<span class="linenos"> 217</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 218</span><span class="w">    </span><span class="c">!                           Type name          Description</span>
<span class="linenos"> 219</span><span class="w">    </span><span class="c">!                           ============================================================</span>
<span class="linenos"> 220</span><span class="w">    </span><span class="c">!                           &#39;default&#39;          No special treatment (default)</span>
<span class="linenos"> 221</span><span class="w">    </span><span class="c">!                           &#39;log&#39;              Application of log-space averaging kernel</span>
<span class="linenos"> 222</span><span class="w">    </span><span class="c">!                           ============================================================</span>
<span class="linenos"> 223</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 224</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w">  </span><span class="n">n_stnid</span><span class="w"></span>
<span class="linenos"> 225</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">stnids</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 226</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="k">type</span><span class="p">(:)</span><span class="w">  </span>
<span class="linenos"> 227</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">element</span><span class="p">(:),</span><span class="n">source</span><span class="p">(:),</span><span class="n">profElement</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 228</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vco</span><span class="p">(:),</span><span class="n">n_lat</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 229</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ibegin</span><span class="p">(:),</span><span class="n">n_lvl</span><span class="p">(:),</span><span class="n">n_col</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 230</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rak</span><span class="p">(:),</span><span class="n">vlayertop</span><span class="p">(:),</span><span class="n">vlayerbottom</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 231</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lat</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 232</span><span class="w"> </span>
<span class="linenos"> 233</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oss_obsdata</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obsSubSpace</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 234</span><span class="w"> </span>
<span class="linenos"> 235</span><span class="w">  </span><span class="k">end type </span><span class="n">struct_oopc_info</span><span class="w"></span>
<span class="linenos"> 236</span>
<span class="linenos"> 237</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oopc_info</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_levels</span><span class="w"></span>
<span class="linenos"> 238</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oopc_info</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="w"></span>
<span class="linenos"> 239</span>
<span class="linenos"> 240</span><span class="w">  </span><span class="c">! Arrays for integration upper boundary of retrieved total column measurements </span>
<span class="linenos"> 241</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oss_obsdata</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_columnBoundary</span><span class="w"></span>
<span class="linenos"> 242</span>
<span class="linenos"> 243</span><span class="w">  </span><span class="c">! File name of auxiliary text file constaining supplemental observation information</span>
<span class="linenos"> 244</span><span class="w">  </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">50</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_aux_filename</span><span class="o">=</span><span class="s2">&quot;obsinfo_chm&quot;</span><span class="w"> </span>
<span class="linenos"> 245</span>
<span class="linenos"> 246</span><span class="w">  </span><span class="c">! Max nummber of constituents (max size of related arrays)</span>
<span class="linenos"> 247</span><span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_constituentsSize</span><span class="o">=</span><span class="mi">30</span><span class="w">  </span><span class="c">! = max allowed value of &quot;iconstituentId&quot; for Table 08046.</span>
<span class="linenos"> 248</span><span class="w">                                                  </span><span class="c">! Value to be increased as needed up to a max of 6999 as values</span>
<span class="linenos"> 249</span><span class="w">                                                  </span><span class="c">! &gt; 7000 (and less 0) are assumed assigned to non-constituent fields  </span>
<span class="linenos"> 250</span>
<span class="linenos"> 251</span><span class="w">  </span><span class="c">! Arrays containing input reference fields and fields interpolated </span>
<span class="linenos"> 252</span><span class="w">  </span><span class="c">! to obs locations</span>
<span class="linenos"> 253</span><span class="w">  </span>
<span class="linenos"> 254</span><span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">struct_oopc_field</span><span class="w"></span>
<span class="linenos"> 255</span>
<span class="linenos"> 256</span><span class="w">    </span><span class="c">!  Structure for storing reference (climatological) fields needed for</span>
<span class="linenos"> 257</span><span class="w">    </span><span class="c">!  operatorSubType(2,:) == &#39;genOper&#39; with </span>
<span class="linenos"> 258</span><span class="w">    </span><span class="c">!  genOperConstraintType == &#39;Diff&#39; (see below).</span>
<span class="linenos"> 259</span><span class="w">    </span><span class="c">!     </span>
<span class="linenos"> 260</span><span class="w">    </span><span class="c">!  Variable               Description</span>
<span class="linenos"> 261</span><span class="w">    </span><span class="c">!  --------               -----------</span>
<span class="linenos"> 262</span><span class="w">    </span><span class="c">!  field                  Gridded 3D field (lon,lat,vlev) or 2D field (1,lat,vlev)</span>
<span class="linenos"> 263</span><span class="w">    </span><span class="c">!  nlat                   number of latitudes</span>
<span class="linenos"> 264</span><span class="w">    </span><span class="c">!  nlon                   number of longitudes</span>
<span class="linenos"> 265</span><span class="w">    </span><span class="c">!  nlev                   number of vertical levels</span>
<span class="linenos"> 266</span><span class="w">    </span><span class="c">!  lat,lon                lat,lon grid in radians</span>
<span class="linenos"> 267</span><span class="w">    </span><span class="c">!  vlev                   vertical levels</span>
<span class="linenos"> 268</span><span class="w">    </span><span class="c">!  ivkind                 Index of vertical coordinate type. Defintion may vary according to source.</span>
<span class="linenos"> 269</span><span class="w">    </span><span class="c">!                         For fields read from RPN files and use of convip:</span>
<span class="linenos"> 270</span><span class="w">    </span><span class="c">!                             0: P is in height [m] (metres) with respect to sea level </span>
<span class="linenos"> 271</span><span class="w">    </span><span class="c">!                             1: P is in stddev [sg] (0.0 -&gt; 1.0) </span>
<span class="linenos"> 272</span><span class="w">    </span><span class="c">!                             2: P is in pressure [mb] (millibars) </span>
<span class="linenos"> 273</span><span class="w">    </span><span class="c">!                             3: P is in an arbitrary code </span>
<span class="linenos"> 274</span><span class="w">    </span><span class="c">!                             4: P is in height [M] (metres) with respect to ground level </span>
<span class="linenos"> 275</span><span class="w">    </span><span class="c">!                             5: P is in hybrid coordinates [hy] </span>
<span class="linenos"> 276</span><span class="w">    </span><span class="c">!                             6: P is in theta [th] </span>
<span class="linenos"> 277</span><span class="w">    </span><span class="c">!                         For use with obs                      </span>
<span class="linenos"> 278</span><span class="w">    </span>
<span class="linenos"> 279</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">field</span><span class="p">(:,:,:),</span><span class="n">lat</span><span class="p">(:),</span><span class="n">lon</span><span class="p">(:),</span><span class="n">vlev</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 280</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nlev</span><span class="p">,</span><span class="n">nlon</span><span class="p">,</span><span class="n">nlat</span><span class="p">,</span><span class="n">ivkind</span><span class="w"></span>
<span class="linenos"> 281</span><span class="w">  </span>
<span class="linenos"> 282</span><span class="w">  </span><span class="k">end type </span><span class="n">struct_oopc_field</span><span class="w"></span>
<span class="linenos"> 283</span>
<span class="linenos"> 284</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oss_obsdata</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_bgRef</span><span class="w"></span>
<span class="linenos"> 285</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oopc_field</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_climFields</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 286</span>
<span class="linenos"> 287</span><span class="w">  </span><span class="c">! Arrays to contain the calculated concentration-weighted effective temperature</span>
<span class="linenos"> 288</span><span class="w">  </span><span class="c">! associated to total column data. It will be stored in the observation file.</span>
<span class="linenos"> 289</span>
<span class="linenos"> 290</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oss_obsdata</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_efftemp</span><span class="w"></span>
<span class="linenos"> 291</span>
<span class="linenos"> 292</span><span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">struct_bcsc_bgStats</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bgStats</span><span class="w"> </span><span class="c">! Background covariances</span>
<span class="linenos"> 293</span>
<span class="linenos"> 294</span><span class="w">  </span><span class="c">! Setup initialization key</span>
<span class="linenos"> 295</span><span class="w">  </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">initializedChem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w">    </span>
<span class="linenos"> 296</span><span class="w">  </span>
<span class="linenos"> 297</span><span class="w">  </span><span class="c">! Operator storage initialization key</span>
<span class="linenos"> 298</span><span class="w">  </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">initializedOperators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w">    </span>
<span class="linenos"> 299</span><span class="w"> </span>
<span class="linenos"> 300</span><span class="w">  </span><span class="c">! General config/setup information parameters </span>
<span class="linenos"> 301</span><span class="w">  </span><span class="c">! See description list of NAMCHEM namelist parameters and others </span>
<span class="linenos"> 302</span><span class="w">  </span><span class="c">! in routine oopc_readNamchem.</span>
<span class="linenos"> 303</span><span class="w">  </span><span class="c">! Following variables/parameters could be placed in a data structure/type</span>
<span class="linenos"> 304</span><span class="w">  </span><span class="c">! (e.g. struct_oopc_nmlparm)</span>
<span class="linenos"> 305</span>
<span class="linenos"> 306</span><span class="w">  </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_genOperConstraintType</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 307</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_genOperHCorrlenExpnt</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w">  </span>
<span class="linenos"> 308</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_genOperOmAStatsFactor</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 309</span><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_tropo_mode</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">),</span><span class="n">oopc_tropo_bound</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 310</span><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_obsdata_maxsize</span><span class="w"></span>
<span class="linenos"> 311</span><span class="w">  </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_tropo_column_top</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 312</span><span class="w">  </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">oopc_storeOperators</span><span class="w"></span>
<span class="linenos"> 313</span><span class="w">  </span>
<span class="linenos"> 314</span><span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_maxfamnum</span><span class="o">=</span><span class="mi">1</span><span class="w">           </span><span class="c">! Could be used for other families as well with &gt;1</span>
<span class="linenos"> 315</span><span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_maxsize</span><span class="o">=</span><span class="mi">100</span><span class="w">           </span><span class="c">! max size of assim_* arrays  </span>
<span class="linenos"> 316</span>
<span class="linenos"> 317</span><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_famNum</span><span class="w"></span>
<span class="linenos"> 318</span><span class="w">  </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_fam</span><span class="p">(</span><span class="n">assim_maxfamnum</span><span class="p">)</span><span class="w"> </span><span class="c">! List of families to which filt_diagnOnly is to apply</span>
<span class="linenos"> 319</span><span class="w">  </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_all</span><span class="p">(</span><span class="n">assim_maxfamnum</span><span class="p">)</span><span class="w"> </span><span class="c">! Choose to assimilate all obs of specified family</span>
<span class="linenos"> 320</span><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_num</span><span class="p">(</span><span class="n">assim_maxfamnum</span><span class="p">)</span><span class="w"> </span><span class="c">! Number of combinations identified for assimilation</span>
<span class="linenos"> 321</span><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_varno</span><span class="p">(</span><span class="n">assim_maxfamnum</span><span class="p">,</span><span class="n">assim_maxsize</span><span class="p">)</span><span class="w"> </span><span class="c">! List of bufr elements to assimilate (0 means all)</span>
<span class="linenos"> 322</span><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_nlev</span><span class="p">(</span><span class="n">assim_maxfamnum</span><span class="p">,</span><span class="n">assim_maxsize</span><span class="p">)</span><span class="w"> </span><span class="c">! 0: multi- and uni-lev; 1: uni-lev; &gt;1 multi-lev</span>
<span class="linenos"> 323</span><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_exclude_nflag</span><span class="p">(</span><span class="n">assim_maxfamnum</span><span class="p">)</span><span class="w"> </span><span class="c">! List of bits for excluding obs from assimilation</span>
<span class="linenos"> 324</span><span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_exclude_flag</span><span class="p">(</span><span class="n">assim_maxfamnum</span><span class="p">,</span><span class="n">assim_maxsize</span><span class="p">)</span><span class="w"> </span><span class="c">! Number of bits for excluding obs</span>
<span class="linenos"> 325</span><span class="w">  </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">assim_stnid</span><span class="p">(</span><span class="n">assim_maxfamnum</span><span class="p">,</span><span class="n">assim_maxsize</span><span class="p">)</span><span class="w"> </span><span class="c">! List of stnid to assimilation &#39;*&#39; for wild card</span>
<span class="linenos"> 326</span><span class="w">  </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">operatorSubType</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">assim_maxsize</span><span class="p">)</span><span class="w"> </span><span class="c">! Operator sub-type name</span>
<span class="linenos"> 327</span><span class="w">  </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">modelName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;GEM-MACH&#39;</span><span class="w"> </span><span class="c">! Identification of the model</span>
<span class="linenos"> 328</span>
<span class="linenos"> 329</span><span class="w">  </span><span class="c">!**************************************************************************</span>
<span class="linenos"> 330</span><span class="w">  </span>
<span class="linenos"> 331</span><span class="w">  </span><span class="k">contains</span><span class="w"></span>
<span class="linenos"> 332</span>
<span class="linenos"> 333</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 334</span><span class="w">  </span><span class="c">! oopc_setupCH</span>
<span class="linenos"> 335</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 336</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_setupCH</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 337</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 338</span><span class="w">    </span><span class="c">!:Purpose: To set up additional information required by constituent obs and</span>
<span class="linenos"> 339</span><span class="w">    </span><span class="c">!          not provided in obsSpaceData.  Also to assign observation layer</span>
<span class="linenos"> 340</span><span class="w">    </span><span class="c">!          top and bottom levels (and averaging kernel matrices).</span>
<span class="linenos"> 341</span><span class="w">    </span><span class="c">!          See &#39;oopc_CHobsoperators&#39;. </span>
<span class="linenos"> 342</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 343</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos"> 344</span>
<span class="linenos"> 345</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos"> 346</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="c">! Mode of observation operator</span>
<span class="linenos"> 347</span>
<span class="linenos"> 348</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos"> 349</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="w"></span>
<span class="linenos"> 350</span><span class="w">    </span>
<span class="linenos"> 351</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Begin oopc_setupCH&#39;</span><span class="w"></span>
<span class="linenos"> 352</span>
<span class="linenos"> 353</span><span class="w">    </span><span class="c">! Read NAMCHEM namelist and set related parameters</span>
<span class="linenos"> 354</span>
<span class="linenos"> 355</span><span class="w">    </span><span class="k">call </span><span class="n">oopc_readNamchem</span><span class="w"></span>
<span class="linenos"> 356</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;oopc_setupCH: Completed oopc_readNamchem&#39;</span><span class="w"></span>
<span class="linenos"> 357</span><span class="w">      </span>
<span class="linenos"> 358</span><span class="w">    </span><span class="c">! Read reference vertical levels (where needed) or </span>
<span class="linenos"> 359</span><span class="w">    </span><span class="c">! top and bottom layer boundaries of partial (or total) column meausurements</span>
<span class="linenos"> 360</span><span class="w">  </span>
<span class="linenos"> 361</span><span class="w">    </span><span class="k">call </span><span class="n">oopc_readLevels</span><span class="w"></span>
<span class="linenos"> 362</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;oopc_setupCH: Completed oopc_readLevels&#39;</span><span class="w"></span>
<span class="linenos"> 363</span><span class="w">      </span>
<span class="linenos"> 364</span><span class="w">    </span><span class="c">! To deallocate space if required elsewhere, one should use</span>
<span class="linenos"> 365</span><span class="w">    </span><span class="c">! call oopc_deallocLevels</span>
<span class="linenos"> 366</span><span class="w">   </span>
<span class="linenos"> 367</span><span class="w">    </span><span class="c">! Read averaging kernel matrices</span>
<span class="linenos"> 368</span><span class="w">  </span>
<span class="linenos"> 369</span><span class="w">    </span><span class="k">call </span><span class="n">oopc_readAvgkern</span><span class="w"></span>
<span class="linenos"> 370</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;oopc_setupCH: Completed oopc_readAvgkern&#39;</span><span class="w"></span>
<span class="linenos"> 371</span><span class="w">  </span>
<span class="linenos"> 372</span><span class="w">    </span><span class="c">! To deallocate space if required elsewhere, one should use</span>
<span class="linenos"> 373</span><span class="w">    </span><span class="c">! call oopc_deallocAvgkern</span>
<span class="linenos"> 374</span><span class="w">  </span>
<span class="linenos"> 375</span><span class="w">    </span><span class="c">! Read reference (e.g. climatological) fields</span>
<span class="linenos"> 376</span><span class="w">  </span>
<span class="linenos"> 377</span><span class="w">    </span><span class="k">call </span><span class="n">oopc_readFields</span><span class="p">(</span><span class="n">oopc_climFields</span><span class="p">,</span><span class="n">oopc_aux_filename</span><span class="p">,</span><span class="s1">&#39;CH&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 378</span><span class="w">                         </span><span class="n">oopc_constituentsSize</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">oopc_genOperConstraintType</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 379</span><span class="w">			 </span><span class="n">success</span><span class="p">,</span><span class="n">filetype_opt</span><span class="o">=</span><span class="s1">&#39;TXT&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 380</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 381</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_setupCH: Failed in oopc_readFields&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 382</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 383</span><span class="k">    write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;oopc_setupCH: Completed oopc_readFields&#39;</span><span class="w"></span>
<span class="linenos"> 384</span><span class="w">    </span>
<span class="linenos"> 385</span><span class="w">    </span><span class="c">! Allocation of oopc_efftemp done in oopc_setupCH instead of obsdata_add_data1d</span>
<span class="linenos"> 386</span><span class="w">    </span><span class="c">! to ensure allocation is done for all processors, including those without associated data.</span>
<span class="linenos"> 387</span><span class="w">    </span><span class="c">! This is to ensure that rpn_comm_allgather will work in routine obsdata_MPIGather.</span>
<span class="linenos"> 388</span>
<span class="linenos"> 389</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">oopc_efftemp</span><span class="p">%</span><span class="n">data1d</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 390</span><span class="k">      call </span><span class="n">oss_obsdata_alloc</span><span class="p">(</span><span class="n">oopc_efftemp</span><span class="p">,</span><span class="n">oopc_obsdata_maxsize</span><span class="p">,</span><span class="n">dim1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 391</span><span class="w">      </span><span class="n">oopc_efftemp</span><span class="p">%</span><span class="n">nrep</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 392</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos"> 393</span>
<span class="linenos"> 394</span><span class="w">    </span><span class="c">! Get background error std dev stats when they may be required</span>
<span class="linenos"> 395</span><span class="w">    </span>
<span class="linenos"> 396</span><span class="w">    </span><span class="n">bgStats</span><span class="p">%</span><span class="n">initialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 397</span><span class="w">    </span>
<span class="linenos"> 398</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="n">operatorSubType</span><span class="p">(</span><span class="mi">2</span><span class="p">,:)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;genOper&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 399</span><span class="k">      call </span><span class="n">bcsc_getCovarCH</span><span class="p">(</span><span class="n">bgStats</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 400</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 401</span>
<span class="linenos"> 402</span><span class="k">    write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Completed oopc_setupCH&#39;</span><span class="w"></span>
<span class="linenos"> 403</span><span class="w">  </span>
<span class="linenos"> 404</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_setupCH</span><span class="w"></span>
<span class="linenos"> 405</span>
<span class="linenos"> 406</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 407</span><span class="w">  </span><span class="c">! oopc_readNamchem</span>
<span class="linenos"> 408</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 409</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_readNamchem</span><span class="w"></span>
<span class="linenos"> 410</span><span class="w">    </span><span class="c">!:Purpose: Read and store miscellaneous flags and constants.</span>
<span class="linenos"> 411</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 412</span><span class="w">    </span><span class="c">!:Comment: assim_* arrays could instead be made available to all families</span>
<span class="linenos"> 413</span><span class="w">    </span><span class="c">!          by moving them to a different input namelist (and changing its</span>
<span class="linenos"> 414</span><span class="w">    </span><span class="c">!          dimensions settings).</span>
<span class="linenos"> 415</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 416</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 417</span><span class="w">    </span><span class="c">!     :genOperConstraintType:</span>
<span class="linenos"> 418</span><span class="w">    </span><span class="c">!                           Reference profile type for weighted integration</span>
<span class="linenos"> 419</span><span class="w">    </span><span class="c">!                           or layer averaging (generalized observation) </span>
<span class="linenos"> 420</span><span class="w">    </span><span class="c">!                           operator.</span>
<span class="linenos"> 421</span><span class="w">    </span><span class="c">!                           Relevant for operatorSubType(2,i)=&#39;genOper&#39;.</span>
<span class="linenos"> 422</span><span class="w">    </span><span class="c">!                           ================================================</span>
<span class="linenos"> 423</span><span class="w">    </span><span class="c">!                           &#39;Trial&#39;  use trial field xb for mass weighted</span>
<span class="linenos"> 424</span><span class="w">    </span><span class="c">!                                    increment distribution</span>
<span class="linenos"> 425</span><span class="w">    </span><span class="c">!                           &#39;Diff&#39;   use a combination of the difference of</span>
<span class="linenos"> 426</span><span class="w">    </span><span class="c">!                                    an external reference xc and the trial</span>
<span class="linenos"> 427</span><span class="w">    </span><span class="c">!                                    field xb, i.e. mass weighted increment</span>
<span class="linenos"> 428</span><span class="w">    </span><span class="c">!                                    distribution as a(xc-xb) + b*xc where a</span>
<span class="linenos"> 429</span><span class="w">    </span><span class="c">!                                    and b depend on the size of</span>
<span class="linenos"> 430</span><span class="w">    </span><span class="c">!                                    sum[(xc-xb)/sig(xb)]^2 over the profile</span>
<span class="linenos"> 431</span><span class="w">    </span><span class="c">!                             ==============================================</span>
<span class="linenos"> 432</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 433</span><span class="w">    </span><span class="c">!     :genOperHCorrlenExpnt: Used with operatorSubType(2,i) =&#39;genOper&#39;</span>
<span class="linenos"> 434</span><span class="w">    </span><span class="c">!                           Exponent for partially mitigating the effect of </span>
<span class="linenos"> 435</span><span class="w">    </span><span class="c">!                           the influence of neighbouring column amonunt obs</span>
<span class="linenos"> 436</span><span class="w">    </span><span class="c">!                           from background error correlations.</span>
<span class="linenos"> 437</span><span class="w">    </span><span class="c">!                           Emperically obtained exponent value.</span>
<span class="linenos"> 438</span><span class="w">    </span><span class="c">!                           Not optimal for all possible local horizontal data densities.</span>
<span class="linenos"> 439</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 440</span><span class="w">    </span><span class="c">!     :genOperOmAStatsFactor:  OmA RMS (or std dev) conservation factor for </span>
<span class="linenos"> 441</span><span class="w">    </span><span class="c">!                           operatorSubType(2,i) =&#39;genOper&#39;.</span>
<span class="linenos"> 442</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 443</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 444</span><span class="w">    </span><span class="c">!     :assim_fam:           List of families to which filt_diagnOnly is to</span>
<span class="linenos"> 445</span><span class="w">    </span><span class="c">!                           apply.</span>
<span class="linenos"> 446</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 447</span><span class="w">    </span><span class="c">!     :assim_exclude_flag:  Array specifying bits for identifying</span>
<span class="linenos"> 448</span><span class="w">    </span><span class="c">!                           diagnostic-only observations for observations</span>
<span class="linenos"> 449</span><span class="w">    </span><span class="c">!                           that would otherwise be assimilated according to</span>
<span class="linenos"> 450</span><span class="w">    </span><span class="c">!                           the other assim_* arrays</span>
<span class="linenos"> 451</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 452</span><span class="w">    </span><span class="c">!     :assim_exclude_nflag: Number of bit flags to specify in</span>
<span class="linenos"> 453</span><span class="w">    </span><span class="c">!                           assim_exclude_flag array</span>
<span class="linenos"> 454</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 455</span><span class="w">    </span><span class="c">!     :assim_all:           Logical indicating if all assimilatable obs of</span>
<span class="linenos"> 456</span><span class="w">    </span><span class="c">!                           the specified family will be assimilated</span>
<span class="linenos"> 457</span><span class="w">    </span><span class="c">!                           (default is .true.)</span>
<span class="linenos"> 458</span><span class="w">    </span><span class="c">!                           When assim_all is .false., account for the setttings </span>
<span class="linenos"> 459</span><span class="w">    </span><span class="c">!                           of assim_num, assim_varno, assim_stnid, assim_nlev.</span>
<span class="linenos"> 460</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 461</span><span class="w">    </span><span class="c">!     :assim_num:           Relevant when assim_all = ,false.</span>
<span class="linenos"> 462</span><span class="w">    </span><span class="c">!                           Number combinations (stnid, bufr element,</span>
<span class="linenos"> 463</span><span class="w">    </span><span class="c">!                           multi/uni-level) identified for assimilation.</span>
<span class="linenos"> 464</span><span class="w">    </span><span class="c">!                           All others will not be assimilated. OmP and OmA</span>
<span class="linenos"> 465</span><span class="w">    </span><span class="c">!                           diagnostics and output will still be produced</span>
<span class="linenos"> 466</span><span class="w">    </span><span class="c">!                           for non-assimilated datasets.</span>
<span class="linenos"> 467</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 468</span><span class="w">    </span><span class="c">!                             ===  =======================================</span>
<span class="linenos"> 469</span><span class="w">    </span><span class="c">!                              0   none are to be assimilated when assim_all</span>
<span class="linenos"> 470</span><span class="w">    </span><span class="c">!                                  is .false. (default)</span>
<span class="linenos"> 471</span><span class="w">    </span><span class="c">!                             &gt;0   sets of (stnid, bufr varno,</span>
<span class="linenos"> 472</span><span class="w">    </span><span class="c">!                                  multi/uni-levels) to be assimilated</span>
<span class="linenos"> 473</span><span class="w">    </span><span class="c">!                             ===  =======================================</span>
<span class="linenos"> 474</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 475</span><span class="w">    </span><span class="c">!     :assim_varno:         Bufr elements of obs sets for assimilation. A</span>
<span class="linenos"> 476</span><span class="w">    </span><span class="c">!                           value of 0 implies that all are to be used.</span>
<span class="linenos"> 477</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 478</span><span class="w">    </span><span class="c">!     :assim_stnid:         Stnids of obs sets for assimilation. &#39;*&#39; denote</span>
<span class="linenos"> 479</span><span class="w">    </span><span class="c">!                           wild cards</span>
<span class="linenos"> 480</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 481</span><span class="w">    </span><span class="c">!     :assim_nlev:            ===  =========================</span>
<span class="linenos"> 482</span><span class="w">    </span><span class="c">!                              0   multi-level and uni-level</span>
<span class="linenos"> 483</span><span class="w">    </span><span class="c">!                              1   uni_level</span>
<span class="linenos"> 484</span><span class="w">    </span><span class="c">!                             &gt;1   multi-level </span>
<span class="linenos"> 485</span><span class="w">    </span><span class="c">!                             ===  =========================</span>
<span class="linenos"> 486</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 487</span><span class="w">    </span><span class="c">!     :tropo_mode:          Integer indicating if special treatment is to be</span>
<span class="linenos"> 488</span><span class="w">    </span><span class="c">!                           given to the troposphere when assimilating total</span>
<span class="linenos"> 489</span><span class="w">    </span><span class="c">!                           column measurements. Values indicate</span>
<span class="linenos"> 490</span><span class="w">    </span><span class="c">!                             ===  =======================================</span>
<span class="linenos"> 491</span><span class="w">    </span><span class="c">!                              0   No special treatment given (default)</span>
<span class="linenos"> 492</span><span class="w">    </span><span class="c">!                              1   Values of the adjoint model above</span>
<span class="linenos"> 493</span><span class="w">    </span><span class="c">!                                  obsoper%columnBound set to zero. If</span>
<span class="linenos"> 494</span><span class="w">    </span><span class="c">!                                  specified, generalized innovation</span>
<span class="linenos"> 495</span><span class="w">    </span><span class="c">!                                  operator only applied below</span>
<span class="linenos"> 496</span><span class="w">    </span><span class="c">!                                  obsoper%columnBound in the tangent</span>
<span class="linenos"> 497</span><span class="w">    </span><span class="c">!                                  linear model.</span>
<span class="linenos"> 498</span><span class="w">    </span><span class="c">!                              2   Values of tangent linear model and</span>
<span class="linenos"> 499</span><span class="w">    </span><span class="c">!                                  adjoint model above obsoper%columnBound</span>
<span class="linenos"> 500</span><span class="w">    </span><span class="c">!                                  set to zero.</span>
<span class="linenos"> 501</span><span class="w">    </span><span class="c">!                             ===  =======================================</span>
<span class="linenos"> 502</span><span class="w">    </span><span class="c">!                           Array index refers to BUFR code element of Table</span>
<span class="linenos"> 503</span><span class="w">    </span><span class="c">!                           08046 (iconstituentId) identifying the</span>
<span class="linenos"> 504</span><span class="w">    </span><span class="c">!                           constituent. Relevant for total column</span>
<span class="linenos"> 505</span><span class="w">    </span><span class="c">!                           measurements only.</span>
<span class="linenos"> 506</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 507</span><span class="w">    </span><span class="c">!     :tropo_bound:         Integer indicating which column top value to use</span>
<span class="linenos"> 508</span><span class="w">    </span><span class="c">!                           if tropo_mode is non-zero.</span>
<span class="linenos"> 509</span><span class="w">    </span><span class="c">!                             ===  =======================================</span>
<span class="linenos"> 510</span><span class="w">    </span><span class="c">!                              0   Use fixed value of tropo_column_top</span>
<span class="linenos"> 511</span><span class="w">    </span><span class="c">!                              1   Use model determination of tropopause</span>
<span class="linenos"> 512</span><span class="w">    </span><span class="c">!                              2   Use model determination of PBL</span>
<span class="linenos"> 513</span><span class="w">    </span><span class="c">!                             ===  =======================================</span>
<span class="linenos"> 514</span><span class="w">    </span><span class="c">!                           Options 1 and 2 will default to the value set</span>
<span class="linenos"> 515</span><span class="w">    </span><span class="c">!                           in tropo_column_top if the model derived column</span>
<span class="linenos"> 516</span><span class="w">    </span><span class="c">!                           top could not be determined. Relevant for total</span>
<span class="linenos"> 517</span><span class="w">    </span><span class="c">!                           column measurements only.</span>
<span class="linenos"> 518</span><span class="w">    </span><span class="c">!                          </span>
<span class="linenos"> 519</span><span class="w">    </span><span class="c">!     :tropo_column_top:    Default value to use for the column boundary</span>
<span class="linenos"> 520</span><span class="w">    </span><span class="c">!                           (in Pa). Array index refers to BUFR code element</span>
<span class="linenos"> 521</span><span class="w">    </span><span class="c">!                           of Table 08046 (iconstituentId) identifying</span>
<span class="linenos"> 522</span><span class="w">    </span><span class="c">!                           the constituent. Relevant for total column</span>
<span class="linenos"> 523</span><span class="w">    </span><span class="c">!                           measurements only.</span>
<span class="linenos"> 524</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 525</span><span class="w">    </span><span class="c">!     :obsdata_maxsize:     Max allowed size of work arrays (in terms of</span>
<span class="linenos"> 526</span><span class="w">    </span><span class="c">!                           number of obs) associated to ordered observation</span>
<span class="linenos"> 527</span><span class="w">    </span><span class="c">!                           indices</span>
<span class="linenos"> 528</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 529</span><span class="w">    </span><span class="c">! </span>
<span class="linenos"> 530</span><span class="w">    </span><span class="c">!     :modelName:           Identifier of forecast model</span>
<span class="linenos"> 531</span><span class="w">    </span><span class="c">!                           Default: &#39;GEM-MACH&#39;</span>
<span class="linenos"> 532</span><span class="w">    </span><span class="c">!                           Set to &#39;GEM&#39; for varNames of &#39;O3L&#39;, &#39;CH4L&#39;, and &#39;N2OL&#39;</span>
<span class="linenos"> 533</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 534</span><span class="w">    </span><span class="c">!     :operatorSubType(2,i):Operator sub-type name.</span>
<span class="linenos"> 535</span><span class="w">    </span><span class="c">!                           Index (2,i) for sub-type to apply for stnid in element (1,i)</span>
<span class="linenos"> 536</span><span class="w">    </span><span class="c">!                           See related &quot;obsoper@operatorCategory&quot; automatically assigned</span>
<span class="linenos"> 537</span><span class="w">    </span><span class="c">!                           based on obs BUFR element and obsinfo_chm content.</span>
<span class="linenos"> 538</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 539</span><span class="w">    </span><span class="c">!                           Operator        Sub-type name    Description</span>
<span class="linenos"> 540</span><span class="w">    </span><span class="c">!                           Category </span>
<span class="linenos"> 541</span><span class="w">    </span><span class="c">!                           =============  =====================================================================</span>
<span class="linenos"> 542</span><span class="w">    </span><span class="c">!                           &#39;Interp&#39;        &#39;default&#39;        Piecewise linear interpolation (default)</span>
<span class="linenos"> 543</span><span class="w">    </span><span class="c">!                                           &#39;wgtAvg&#39;         Piecewise weighted averaging  interpolator</span>
<span class="linenos"> 544</span><span class="w">    </span><span class="c">!                           &#39;Surface&#39;       &#39;default&#39;        No special treatment (default)</span>
<span class="linenos"> 545</span><span class="w">    </span><span class="c">!                           &#39;Integ&#39;         &#39;default&#39;        Simple/basic vertical integration (default)</span>
<span class="linenos"> 546</span><span class="w">    </span><span class="c">!                                           &#39;genOper&#39;        Weighted vertical integration - see &#39;genOper*&#39; parameters</span>
<span class="linenos"> 547</span><span class="w">    </span><span class="c">!                           &#39;LayerAvg&#39;      &#39;default&#39;        Simple layer averaging (default)</span>
<span class="linenos"> 548</span><span class="w">    </span><span class="c">!                                           &#39;genOper&#39;        Weighted vertical layer averaging - see &#39;genOper*&#39; parameters</span>
<span class="linenos"> 549</span><span class="w">    </span><span class="c">!                           ====================================================================================</span>
<span class="linenos"> 550</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 551</span><span class="w">    </span><span class="c">!                           Notes:</span>
<span class="linenos"> 552</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 553</span><span class="w">    </span><span class="c">!                           - &#39;genOper&#39; requires NAMBCHM namelist parameter settings</span>
<span class="linenos"> 554</span><span class="w">    </span><span class="c">!                             getPhysSpaceStats=.true. and </span>
<span class="linenos"> 555</span><span class="w">    </span><span class="c">!                             getPhysSpaceHCorrel=.true.</span>
<span class="linenos"> 556</span><span class="w">    </span><span class="c">!                           - Application of averaging kernels is directed only</span>
<span class="linenos"> 557</span><span class="w">    </span><span class="c">!                             by the content of the obsinfo_chm file &#39;SECTION III&#39;</span>
<span class="linenos"> 558</span><span class="w">    </span><span class="c">!                                             </span>
<span class="linenos"> 559</span><span class="w">    </span><span class="c">!     :storeOperators:      Logical indicating if linear operators are stored for re-use in TL and AD calc.</span>
<span class="linenos"> 560</span><span class="w">    </span><span class="c">!                           If so, the linear operators will not be re-calculated at different iterations.</span>
<span class="linenos"> 561</span><span class="w">    </span><span class="c">!                           Not used when tropo_mode&gt;=1</span>
<span class="linenos"> 562</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 563</span><span class="w">    </span>
<span class="linenos"> 564</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos"> 565</span>
<span class="linenos"> 566</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos"> 567</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fnom</span><span class="p">,</span><span class="w"> </span><span class="n">fclos</span><span class="w"></span>
<span class="linenos"> 568</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ierr</span><span class="p">,</span><span class="w"> </span><span class="n">ios</span><span class="p">,</span><span class="w"> </span><span class="n">nulnam</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="linenos"> 569</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">namfile</span><span class="w"> </span>
<span class="linenos"> 570</span>
<span class="linenos"> 571</span><span class="w">    </span><span class="c">! Namelist variables (local)</span>
<span class="linenos"> 572</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tropo_mode</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w"> </span><span class="c">! Special treatment for troposphere of total column obs</span>
<span class="linenos"> 573</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tropo_bound</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w"> </span><span class="c">! Indicate which column top value used for special treatment</span>
<span class="linenos"> 574</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tropo_column_top</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w"> </span><span class="c">! Default for column boundary (in Pa) of total column obs</span>
<span class="linenos"> 575</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">storeOperators</span><span class="w"> </span><span class="c">! Choose to store linear operators for re-use in TL/AD</span>
<span class="linenos"> 576</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">genOperConstraintType</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w"> </span><span class="c">! Strong constraint for generalized obs operator (see oopc_genOper)</span>
<span class="linenos"> 577</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">genOperHCorrlenExpnt</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w">  </span><span class="c">! Exponent for horiz. correl. length weighting in oopc_genOper</span>
<span class="linenos"> 578</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">genOperOmAStatsFactor</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">oopc_constituentsSize</span><span class="p">)</span><span class="w"> </span><span class="c">! Additional OmAStats normalization factor for oopc_genOper</span>
<span class="linenos"> 579</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obsdata_maxsize</span><span class="w"> </span><span class="c">! Max number of obs associated with ordered obs indices</span>
<span class="linenos"> 580</span>
<span class="linenos"> 581</span><span class="w">    </span><span class="k">external </span><span class="n">fnom</span><span class="p">,</span><span class="n">fclos</span><span class="w"></span>
<span class="linenos"> 582</span>
<span class="linenos"> 583</span><span class="w">    </span><span class="k">namelist</span><span class="w"> </span><span class="o">/</span><span class="n">namchem</span><span class="o">/</span><span class="w"> </span><span class="n">assim_fam</span><span class="p">,</span><span class="n">assim_all</span><span class="p">,</span><span class="n">assim_num</span><span class="p">,</span><span class="n">assim_stnid</span><span class="p">,</span><span class="n">assim_varno</span><span class="p">,</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 584</span><span class="w">                       </span><span class="n">assim_nlev</span><span class="p">,</span><span class="w"> </span><span class="n">assim_exclude_nflag</span><span class="p">,</span><span class="n">assim_exclude_flag</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 585</span><span class="w">                       </span><span class="n">tropo_mode</span><span class="p">,</span><span class="n">tropo_bound</span><span class="p">,</span><span class="n">tropo_column_top</span><span class="p">,</span><span class="n">obsdata_maxsize</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 586</span><span class="w">                       </span><span class="n">modelName</span><span class="p">,</span><span class="n">operatorSubType</span><span class="p">,</span><span class="n">storeOperators</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 587</span><span class="w">		       </span><span class="n">genOperConstraintType</span><span class="p">,</span><span class="n">genOperHCorrlenExpnt</span><span class="p">,</span><span class="n">genOperOmAStatsFactor</span><span class="w"></span>
<span class="linenos"> 588</span><span class="w">  </span>
<span class="linenos"> 589</span><span class="w">    </span><span class="c">! Default NAMCHEM values</span>
<span class="linenos"> 590</span>
<span class="linenos"> 591</span><span class="w">    </span><span class="n">genOperConstraintType</span><span class="p">(:)</span><span class="o">=</span><span class="s1">&#39;Trial&#39;</span><span class="w"></span>
<span class="linenos"> 592</span><span class="w">    </span><span class="n">genOperHCorrlenExpnt</span><span class="p">(:)</span><span class="o">=</span><span class="mf">1.7</span><span class="w"></span>
<span class="linenos"> 593</span><span class="w">    </span><span class="n">genOperOmAStatsFactor</span><span class="p">(:)</span><span class="o">=</span><span class="mf">1.0</span><span class="w"></span>
<span class="linenos"> 594</span><span class="w">    </span>
<span class="linenos"> 595</span><span class="w">    </span><span class="n">obsdata_maxsize</span><span class="o">=</span><span class="mi">90000</span><span class="w"></span>
<span class="linenos"> 596</span><span class="w">    </span>
<span class="linenos"> 597</span><span class="w">    </span><span class="n">storeOperators</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 598</span><span class="w">    </span><span class="n">assim_fam</span><span class="p">(:)</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="w"></span>
<span class="linenos"> 599</span><span class="w">    </span><span class="n">assim_fam</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="s1">&#39;CH&#39;</span><span class="w"></span>
<span class="linenos"> 600</span><span class="w">    </span><span class="n">assim_famNum</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 601</span><span class="w">    </span><span class="n">assim_all</span><span class="p">(:)</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 602</span><span class="w">    </span><span class="n">assim_num</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span><span class="w">  </span>
<span class="linenos"> 603</span><span class="w">    </span><span class="n">assim_stnid</span><span class="p">(:,:)</span><span class="o">=</span><span class="s1">&#39;*********&#39;</span><span class="w"></span>
<span class="linenos"> 604</span><span class="w">    </span><span class="n">assim_varno</span><span class="p">(:,:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 605</span><span class="w">    </span><span class="n">assim_nlev</span><span class="p">(:,:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 606</span><span class="w"> </span>
<span class="linenos"> 607</span><span class="w">    </span><span class="n">assim_exclude_nflag</span><span class="p">(:)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 608</span><span class="w">    </span><span class="n">assim_exclude_flag</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mi">6</span><span class="w">  </span><span class="c">! this is for the &#39;in reserve&#39; bit for a BURP marker</span>
<span class="linenos"> 609</span><span class="w">    </span><span class="n">assim_exclude_flag</span><span class="p">(:,</span><span class="mi">2</span><span class="p">:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 610</span>
<span class="linenos"> 611</span><span class="w">    </span><span class="n">tropo_mode</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 612</span><span class="w">    </span><span class="n">tropo_bound</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 613</span><span class="w">    </span><span class="n">tropo_column_top</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos"> 614</span><span class="w">    </span>
<span class="linenos"> 615</span><span class="w">    </span><span class="n">operatorSubType</span><span class="p">(</span><span class="mi">1</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"></span>
<span class="linenos"> 616</span><span class="w">    </span><span class="n">operatorSubType</span><span class="p">(</span><span class="mi">2</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos"> 617</span>
<span class="linenos"> 618</span><span class="w">    </span><span class="c">! Read from namelist file NAMCHEM</span>
<span class="linenos"> 619</span>
<span class="linenos"> 620</span><span class="w">    </span><span class="n">namfile</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="s2">&quot;flnml&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 621</span><span class="w">    </span><span class="n">nulnam</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 622</span><span class="w">    </span><span class="n">ierr</span><span class="o">=</span><span class="n">fnom</span><span class="p">(</span><span class="n">nulnam</span><span class="p">,</span><span class="n">namfile</span><span class="p">,</span><span class="s1">&#39;R/O&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 623</span>
<span class="linenos"> 624</span><span class="w">    </span><span class="k">read</span><span class="p">(</span><span class="n">nulnam</span><span class="p">,</span><span class="n">nml</span><span class="o">=</span><span class="n">namchem</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 625</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ios</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="mi">4</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">ios</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then </span>
<span class="linenos"> 626</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readNamchem: Error in reading NAMCHEM namelist. iostat = &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">ios</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w">   </span>
<span class="linenos"> 627</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">mmpi_myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 628</span><span class="k">      write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">nml</span><span class="o">=</span><span class="n">namchem</span><span class="p">)</span><span class="w">   </span>
<span class="linenos"> 629</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 630</span><span class="k">  </span>
<span class="linenos"> 631</span><span class="k">    </span><span class="n">ierr</span><span class="o">=</span><span class="n">fclos</span><span class="p">(</span><span class="n">nulnam</span><span class="p">)</span><span class="w">      </span>
<span class="linenos"> 632</span>
<span class="linenos"> 633</span><span class="w">    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="n">assim_fam</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 634</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">assim_fam</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos"> 635</span><span class="k">    end do</span>
<span class="linenos"> 636</span><span class="k">    </span><span class="n">assim_famnum</span><span class="o">=</span><span class="n">i</span><span class="w"></span>
<span class="linenos"> 637</span>
<span class="linenos"> 638</span><span class="w">    </span><span class="n">oopc_genOperConstraintType</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">genOperConstraintType</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 639</span><span class="w">    </span><span class="n">oopc_genOperHCorrlenExpnt</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">genOperHCorrlenExpnt</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 640</span><span class="w">    </span><span class="n">oopc_genOperOmAStatsFactor</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">genOperOmAStatsFactor</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 641</span><span class="w">    </span><span class="n">oopc_tropo_mode</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tropo_mode</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 642</span><span class="w">    </span><span class="n">oopc_tropo_bound</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tropo_bound</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 643</span><span class="w">    </span><span class="n">oopc_tropo_column_top</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tropo_column_top</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 644</span><span class="w">    </span><span class="n">oopc_storeOperators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeOperators</span><span class="w"></span>
<span class="linenos"> 645</span><span class="w">    </span><span class="n">oopc_obsdata_maxsize</span><span class="o">=</span><span class="n">obsdata_maxsize</span><span class="w"></span>
<span class="linenos"> 646</span><span class="w">  </span>
<span class="linenos"> 647</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_readNamchem</span><span class="w"></span>
<span class="linenos"> 648</span>
<span class="linenos"> 649</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------  </span>
<span class="linenos"> 650</span><span class="w">  </span><span class="c">!------- Routines related to reference or layer top &amp; bottom levels -------</span>
<span class="linenos"> 651</span>
<span class="linenos"> 652</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 653</span><span class="w">  </span><span class="c">! oopc_readLevels</span>
<span class="linenos"> 654</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 655</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_readLevels</span><span class="w"></span>
<span class="linenos"> 656</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 657</span><span class="w">    </span><span class="c">!:Purpose: To read and to store reference levels (where needed) or top- and </span>
<span class="linenos"> 658</span><span class="w">    </span><span class="c">!          bottom-layer boundaries for CH sub-families.</span>
<span class="linenos"> 659</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 660</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos"> 661</span>
<span class="linenos"> 662</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos"> 663</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fnom</span><span class="p">,</span><span class="w"> </span><span class="n">fclos</span><span class="w"></span>
<span class="linenos"> 664</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ierr</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jelm</span><span class="p">,</span><span class="w"> </span><span class="n">nulstat</span><span class="p">,</span><span class="w"> </span><span class="n">ios</span><span class="p">,</span><span class="w"> </span><span class="n">isize</span><span class="p">,</span><span class="w"> </span><span class="n">icount</span><span class="w"></span>
<span class="linenos"> 665</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">LnewExists</span><span class="p">,</span><span class="n">newread</span><span class="w"></span>
<span class="linenos"> 666</span><span class="w">  </span>
<span class="linenos"> 667</span><span class="w">    </span><span class="kt">character</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos"> 668</span>
<span class="linenos"> 669</span><span class="w">    </span><span class="k">external </span><span class="n">fnom</span><span class="p">,</span><span class="n">fclos</span><span class="w"></span>
<span class="linenos"> 670</span><span class="w">  </span>
<span class="linenos"> 671</span><span class="w">    </span><span class="c">! Initialization</span>
<span class="linenos"> 672</span>
<span class="linenos"> 673</span><span class="w">    </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 674</span>
<span class="linenos"> 675</span><span class="w">    </span><span class="k">inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">),</span><span class="n">EXIST</span><span class="o">=</span><span class="n">LnewExists</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 676</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">LnewExists</span><span class="w"> </span><span class="p">)</span><span class="k">then</span>
<span class="linenos"> 677</span><span class="k">      write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">   </span><span class="s1">&#39;---------------------------------------------------------------&#39;</span><span class="w"></span>
<span class="linenos"> 678</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">   </span><span class="s1">&#39;oopc_readLevels: COULD NOT FIND AUXILIARY file &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 679</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">   </span><span class="s1">&#39;---------------------------------------------------------------&#39;</span><span class="w"></span>
<span class="linenos"> 680</span><span class="w">      </span><span class="k">return</span>
<span class="linenos"> 681</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos"> 682</span>
<span class="linenos"> 683</span><span class="w">    </span><span class="c">! Check for available layer info.</span>
<span class="linenos"> 684</span>
<span class="linenos"> 685</span><span class="w">    </span><span class="n">nulstat</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 686</span><span class="w">    </span><span class="n">ierr</span><span class="o">=</span><span class="n">fnom</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">),</span><span class="s1">&#39;SEQ&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 687</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 688</span><span class="k">      open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">nulstat</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">),</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;OLD&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 689</span><span class="w">    </span><span class="k">else</span>
<span class="linenos"> 690</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readLevels: COULD NOT OPEN AUXILIARY file &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 691</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos"> 692</span>
<span class="linenos"> 693</span><span class="k">    </span><span class="n">ios</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 694</span><span class="w">    </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos"> 695</span><span class="w">    </span><span class="k">do while</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="n">ligne</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">13</span><span class="p">)))</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;SECTION II:&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 696</span><span class="w">      </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos"> 697</span><span class="w">    </span><span class="k">end do</span><span class="w">    </span>
<span class="linenos"> 698</span><span class="w">  </span>
<span class="linenos"> 699</span><span class="w">    </span><span class="c">! Read number of observation set sub-families (STNIDs and ...) and allocate space</span>
<span class="linenos"> 700</span><span class="w">   </span>
<span class="linenos"> 701</span><span class="w">    </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"></span>
<span class="linenos"> 702</span><span class="w">    </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">isize</span><span class="w"></span>
<span class="linenos"> 703</span>
<span class="linenos"> 704</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">stnids</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 705</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vco</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 706</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">),</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">ibegin</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 707</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">element</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">),</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 708</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">isize</span><span class="p">),</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">isize</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 709</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 710</span><span class="w"> </span>
<span class="linenos"> 711</span><span class="w">    </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">element</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 712</span><span class="w">    </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vco</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 713</span><span class="w">    </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">source</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 714</span><span class="w">    </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(:)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 715</span><span class="w">    </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_col</span><span class="p">(:)</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>
<span class="linenos"> 716</span>
<span class="linenos"> 717</span><span class="w">    </span><span class="c">! Begin reading for each sub-family</span>
<span class="linenos"> 718</span><span class="w">    </span><span class="c">! Important: Combination of STNID, BUFR element and number of vertical levels</span>
<span class="linenos"> 719</span><span class="w">    </span><span class="c">!            to determine association to the observations.</span>
<span class="linenos"> 720</span>
<span class="linenos"> 721</span><span class="w">    </span><span class="n">icount</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 722</span><span class="w">    </span><span class="k">do </span><span class="n">jelm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"></span>
<span class="linenos"> 723</span><span class="w">      </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">ibegin</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="o">=</span><span class="n">icount</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 724</span>
<span class="linenos"> 725</span><span class="w">      </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos"> 726</span>
<span class="linenos"> 727</span><span class="w">      </span><span class="c">! Read STNID (* is a wildcard)</span>
<span class="linenos"> 728</span><span class="w">    </span>
<span class="linenos"> 729</span><span class="w">      </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(2X,A9)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">stnids</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 730</span>
<span class="linenos"> 731</span><span class="w">      </span><span class="c">! Read (1) Obs BUFR element.</span>
<span class="linenos"> 732</span><span class="w">      </span><span class="c">!      (2) Vertical coord type (1, 2, or 3)</span>
<span class="linenos"> 733</span><span class="w">      </span><span class="c">!      (3) Flag indication if EOR provided from this auxiliary file or</span>
<span class="linenos"> 734</span><span class="w">      </span><span class="c">!          to be read from the observation file,</span>
<span class="linenos"> 735</span><span class="w">      </span><span class="c">!      (4) Number of vertical levels (rows)</span>
<span class="linenos"> 736</span><span class="w">      </span><span class="c">!      (5) Number of vertical level profiles/columns (optional; default is 2)</span>
<span class="linenos"> 737</span><span class="w">      </span><span class="c">!</span>
<span class="linenos"> 738</span><span class="w">      </span><span class="c">! Important: Combination of STNID, BUFR element and number of vertical levels  </span>
<span class="linenos"> 739</span><span class="w">      </span><span class="c">!            to determine association to the observations.</span>
<span class="linenos"> 740</span>
<span class="linenos"> 741</span><span class="w">      </span><span class="n">newread</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 742</span><span class="w">      </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">element</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vco</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 743</span><span class="w">        </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 744</span><span class="w">      </span><span class="n">newread</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 745</span><span class="w"> </span><span class="mi">20</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newread</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 746</span><span class="k">        backspace</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 747</span><span class="w">        </span><span class="k">backspace</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w">       </span>
<span class="linenos"> 748</span><span class="w">        </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">element</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vco</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 749</span><span class="w">          </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 750</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos"> 751</span>
<span class="linenos"> 752</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">icount</span><span class="o">+</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">isize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 753</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readLevels: READING PROBLEM. &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 754</span><span class="w">	                </span><span class="s1">&#39;Max array size exceeded: &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 755</span><span class="w">                        </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">isize</span><span class="p">)))</span><span class="w"></span>
<span class="linenos"> 756</span><span class="w">      </span><span class="k">end if    </span>
<span class="linenos"> 757</span>
<span class="linenos"> 758</span><span class="k">      read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos"> 759</span><span class="w">          </span>
<span class="linenos"> 760</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 761</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 762</span><span class="k">      </span>
<span class="linenos"> 763</span><span class="k">          do </span><span class="n">jlev</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 764</span><span class="w">            </span><span class="n">icount</span><span class="o">=</span><span class="n">icount</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 765</span><span class="w">          </span>
<span class="linenos"> 766</span><span class="w">            </span><span class="c">! Read top and bottom levels</span>
<span class="linenos"> 767</span><span class="w">           </span>
<span class="linenos"> 768</span><span class="w">            </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w">                 </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 769</span><span class="w">                   </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">icount</span><span class="p">),</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">icount</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 770</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos"> 771</span><span class="k">          </span>
<span class="linenos"> 772</span><span class="k">        else</span>
<span class="linenos"> 773</span><span class="k">        </span>
<span class="linenos"> 774</span><span class="k">          do </span><span class="n">jlev</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 775</span><span class="w">            </span><span class="n">icount</span><span class="o">=</span><span class="n">icount</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 776</span><span class="w">          </span>
<span class="linenos"> 777</span><span class="w">            </span><span class="c">! Read single level</span>
<span class="linenos"> 778</span><span class="w">           </span>
<span class="linenos"> 779</span><span class="w">            </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w">                 </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 780</span><span class="w">                   </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">icount</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 781</span><span class="w">            </span>
<span class="linenos"> 782</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos"> 783</span><span class="k">          </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(:)</span><span class="o">=</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 784</span>
<span class="linenos"> 785</span><span class="w">        </span><span class="k">end if              </span>
<span class="linenos"> 786</span><span class="k">      end if</span>
<span class="linenos"> 787</span>
<span class="linenos"> 788</span><span class="k">    end do</span>
<span class="linenos"> 789</span><span class="k">   </span>
<span class="linenos"> 790</span><span class="k"> </span><span class="mi">10</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ios</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 791</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readLevels: READING PROBLEM. &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 792</span><span class="w">           </span><span class="s1">&#39;File read error message number: &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">ios</span><span class="p">)))</span><span class="w"></span>
<span class="linenos"> 793</span><span class="w">    </span><span class="k">end if    </span>
<span class="linenos"> 794</span><span class="k"> </span>
<span class="linenos"> 795</span><span class="k"> </span><span class="mi">11</span><span class="w"> </span><span class="k">CLOSE</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">nulstat</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 796</span><span class="w">    </span><span class="n">ierr</span><span class="o">=</span><span class="n">fclos</span><span class="p">(</span><span class="n">nulstat</span><span class="p">)</span><span class="w">    </span>
<span class="linenos"> 797</span>
<span class="linenos"> 798</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_readLevels</span><span class="w"></span>
<span class="linenos"> 799</span>
<span class="linenos"> 800</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 801</span><span class="w">  </span><span class="c">! oopc_getLevels</span>
<span class="linenos"> 802</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 803</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_getLevels</span><span class="w"></span>
<span class="linenos"> 804</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 805</span><span class="w">    </span><span class="c">!:Purpose: To return reference model levels or layer boundaries for an observation. </span>
<span class="linenos"> 806</span><span class="w">    </span><span class="c">!          Combination of STNID, element variable number and number of vertical </span>
<span class="linenos"> 807</span><span class="w">    </span><span class="c">!          levels to determine association to the observations. Default values</span>
<span class="linenos"> 808</span><span class="w">    </span><span class="c">!          for top and bottom layers for total column measurements are to be</span>
<span class="linenos"> 809</span><span class="w">    </span><span class="c">!          provided.</span>
<span class="linenos"> 810</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 811</span><span class="w">    </span>
<span class="linenos"> 812</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos"> 813</span>
<span class="linenos"> 814</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos"> 815</span>
<span class="linenos"> 816</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos"> 817</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nlev</span><span class="w">              </span><span class="c">! number of levels in the observation</span>
<span class="linenos"> 818</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">istnid</span><span class="p">,</span><span class="n">stnidIndex</span><span class="p">,</span><span class="n">startIndex</span><span class="p">,</span><span class="n">levelIndex</span><span class="p">,</span><span class="n">level</span><span class="w"></span>
<span class="linenos"> 819</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iset</span><span class="w"></span>
<span class="linenos"> 820</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">levelsTop</span><span class="p">(:),</span><span class="n">levelsBot</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos"> 821</span><span class="w">    </span>
<span class="linenos"> 822</span><span class="w">    </span><span class="n">nlev</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos"> 823</span>
<span class="linenos"> 824</span><span class="w">    </span><span class="c">! Find stnid with same number of vertical levels, and same BUFR element</span>
<span class="linenos"> 825</span><span class="w">          </span>
<span class="linenos"> 826</span><span class="w">    </span><span class="n">istnid</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos"> 827</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">layerIdentified</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 828</span>
<span class="linenos"> 829</span><span class="w">    </span><span class="k">do </span><span class="n">stnidIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"></span>
<span class="linenos"> 830</span>
<span class="linenos"> 831</span><span class="w">       </span><span class="c">! First compare STNID values allowing for * and blanks in </span>
<span class="linenos"> 832</span><span class="w">       </span><span class="c">! oopc_levels%stnids(JN) as wildcards</span>
<span class="linenos"> 833</span><span class="w">       </span><span class="n">iset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_stnid_equal</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">stnids</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 834</span>
<span class="linenos"> 835</span><span class="w">       </span><span class="c">! Check if number of levels, code, and vertical coordinate type are equal.</span>
<span class="linenos"> 836</span><span class="w">       </span><span class="c">! If number of levels is one and no vertical coordinate provided for total column measurement (i.e. obsoper%vco == 4),</span>
<span class="linenos"> 837</span><span class="w">       </span><span class="c">! then check of vertical coordinate type is disregarded afterwards.       </span>
<span class="linenos"> 838</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iset</span><span class="p">)</span><span class="w"> </span><span class="k">then	      </span>
<span class="linenos"> 839</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">element</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 840</span><span class="w">             </span><span class="p">(</span><span class="n">nlev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 841</span><span class="w">	     </span><span class="p">(</span><span class="n">nlev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 842</span><span class="w">             </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vco</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 843</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 844</span><span class="k">	    </span>
<span class="linenos"> 845</span><span class="k">            </span><span class="n">istnid</span><span class="o">=</span><span class="n">stnidIndex</span><span class="w"></span>
<span class="linenos"> 846</span><span class="w">            </span><span class="k">exit</span>
<span class="linenos"> 847</span><span class="k">	      </span>
<span class="linenos"> 848</span><span class="k">          end if</span>
<span class="linenos"> 849</span><span class="k">       end if</span>
<span class="linenos"> 850</span><span class="k">       </span>
<span class="linenos"> 851</span><span class="k">    end do</span>
<span class="linenos"> 852</span><span class="k">    </span>
<span class="linenos"> 853</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">istnid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 854</span><span class="w">       </span><span class="c">! If integrated layer information not found, if a total column measurement</span>
<span class="linenos"> 855</span><span class="w">       </span><span class="c">! set to defaults, else do nothing</span>
<span class="linenos"> 856</span>
<span class="linenos"> 857</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufr_IsIntegral</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nlev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then          </span>
<span class="linenos"> 858</span><span class="k">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">layerIdentified</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 859</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 860</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 861</span><span class="w">       </span><span class="k">end if</span>
<span class="linenos"> 862</span>
<span class="linenos"> 863</span><span class="k">    else</span><span class="w"></span>
<span class="linenos"> 864</span><span class="w">       </span><span class="c">! level or layer information has been found in auxiliary file</span>
<span class="linenos"> 865</span><span class="w">       </span>
<span class="linenos"> 866</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nlev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nlev</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos"> 867</span><span class="w">         </span><span class="c">! layer information has been found in auxiliary file</span>
<span class="linenos"> 868</span><span class="w">         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">layerIdentified</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 869</span><span class="w">         </span><span class="n">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">ibegin</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 870</span><span class="w">         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">startIndex</span><span class="p">:</span><span class="n">startIndex</span><span class="o">+</span><span class="n">nlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 871</span><span class="w">         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">startIndex</span><span class="p">:</span><span class="n">startIndex</span><span class="o">+</span><span class="n">nlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span>
<span class="linenos"> 872</span><span class="w">       </span><span class="k">else</span><span class="w"> </span>
<span class="linenos"> 873</span><span class="w">                </span>
<span class="linenos"> 874</span><span class="w">         </span><span class="c">! Alternative level or layer information has been found</span>
<span class="linenos"> 875</span><span class="w">         </span><span class="c">! Must be pressure or sigma</span>
<span class="linenos"> 876</span><span class="w">         </span>
<span class="linenos"> 877</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vco</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 878</span><span class="w">	   </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vco</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 879</span><span class="k">	   </span>
<span class="linenos"> 880</span><span class="k">           call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_getLevels: Cannot handle this vertical coordinate type&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 881</span><span class="w">	 </span><span class="k">end if </span>
<span class="linenos"> 882</span><span class="k">          </span>
<span class="linenos"> 883</span><span class="k">         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">=</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 884</span><span class="w">         </span>
<span class="linenos"> 885</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">layerIdentified</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos"> 886</span><span class="w">        </span>
<span class="linenos"> 887</span><span class="w">         </span><span class="n">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">ibegin</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 888</span>
<span class="linenos"> 889</span><span class="w">         </span><span class="k">allocate</span><span class="p">(</span><span class="n">levelsTop</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w">   </span>
<span class="linenos"> 890</span><span class="w">         </span><span class="k">allocate</span><span class="p">(</span><span class="n">levelsBot</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w"></span>
<span class="linenos"> 891</span><span class="w">         </span><span class="n">levelsTop</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">startIndex</span><span class="p">:</span><span class="n">startIndex</span><span class="o">+</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 892</span><span class="w">         </span><span class="n">levelsBot</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">startIndex</span><span class="p">:</span><span class="n">startIndex</span><span class="o">+</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 893</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">vco</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 894</span><span class="k">           </span><span class="n">levelsTop</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levelsTop</span><span class="p">(:)</span><span class="o">*</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 895</span><span class="w">           </span><span class="n">levelsBot</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levelsBot</span><span class="p">(:)</span><span class="o">*</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 896</span><span class="w">         </span><span class="k">end if</span><span class="w"></span>
<span class="linenos"> 897</span><span class="w">          </span>
<span class="linenos"> 898</span><span class="w">         </span><span class="c">! Ensure levels do not go below the surface</span>
<span class="linenos"> 899</span>
<span class="linenos"> 900</span><span class="w">         </span><span class="k">do </span><span class="n">levelIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos"> 901</span><span class="w">           </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelsBot</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w"> </span><span class="k">then  </span>
<span class="linenos"> 902</span><span class="k">             </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos"> 903</span><span class="w">             </span><span class="n">levelsBot</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 904</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">levelsTop</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 905</span><span class="k">               </span><span class="n">levelsTop</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 906</span><span class="w">	     </span><span class="k">end if</span>
<span class="linenos"> 907</span><span class="k">             exit</span>
<span class="linenos"> 908</span><span class="k">           end if</span>
<span class="linenos"> 909</span><span class="k">         end do</span><span class="w"></span>
<span class="linenos"> 910</span><span class="w">           </span>
<span class="linenos"> 911</span><span class="w">         </span><span class="c">! Reset work array sizes and settings</span>
<span class="linenos"> 912</span><span class="w">         </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 913</span><span class="w">         </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 914</span>
<span class="linenos"> 915</span><span class="w">         </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w">       </span><span class="c">! Reference vertical levels</span>
<span class="linenos"> 916</span><span class="w">         </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w">    </span><span class="c">! Layer tops for layer measurements</span>
<span class="linenos"> 917</span><span class="w">         </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w"> </span><span class="c">! Layer bottoms for layer measurements</span>
<span class="linenos"> 918</span><span class="w">         </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w">  </span><span class="c">! Index of highest model level (lowest index) involved with obs element</span>
<span class="linenos"> 919</span><span class="w">         </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w">  </span><span class="c">! Index of lowest model level (highest index) involved with obs element</span>
<span class="linenos"> 920</span><span class="w">         </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w">   </span><span class="c">! Local model operator H (excluding conversion constants and horizontal interpolation)</span>
<span class="linenos"> 921</span><span class="w">         </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w">  </span><span class="c">! Part of zh that excludes aspects related to vertical resolition</span>
<span class="linenos"> 922</span>
<span class="linenos"> 923</span><span class="w">         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levelsTop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 924</span><span class="w">         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levelsBot</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 925</span><span class="w">         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">levelsTop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 926</span><span class="w">         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(:,:)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 927</span><span class="w">         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(:,:)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos"> 928</span>
<span class="linenos"> 929</span><span class="w">         </span><span class="k">deallocate</span><span class="p">(</span><span class="n">levelsTop</span><span class="p">,</span><span class="n">levelsBot</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 930</span>
<span class="linenos"> 931</span><span class="w">       </span><span class="k">end if</span>
<span class="linenos"> 932</span>
<span class="linenos"> 933</span><span class="k">       </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(:)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 934</span><span class="w">       </span><span class="n">startIndex</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>
<span class="linenos"> 935</span><span class="w">       </span><span class="k">do </span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos"> 936</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 937</span><span class="k">	   </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 938</span><span class="w">	 </span><span class="k">else </span>
<span class="linenos"> 939</span><span class="k">           do </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">startIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="w"></span>
<span class="linenos"> 940</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 941</span><span class="k">                </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos"> 942</span><span class="w">		</span><span class="k">exit</span>
<span class="linenos"> 943</span><span class="k">             else if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 944</span><span class="k">                </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="n">levelIndex</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 945</span><span class="w">                </span><span class="k">exit</span>
<span class="linenos"> 946</span><span class="k">             end if</span>
<span class="linenos"> 947</span><span class="k">           end do</span>
<span class="linenos"> 948</span><span class="k">           if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 949</span><span class="k">             if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w">  </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 950</span><span class="w">               </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 951</span><span class="w">           </span><span class="k">end if</span>
<span class="linenos"> 952</span><span class="k">           </span><span class="n">startIndex</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos"> 953</span><span class="w">         </span><span class="k">end if</span>
<span class="linenos"> 954</span><span class="k">       end do</span>
<span class="linenos"> 955</span><span class="k">       </span>
<span class="linenos"> 956</span><span class="k">                                   </span>
<span class="linenos"> 957</span><span class="k">       </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(:)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(:)</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 958</span><span class="w">       </span><span class="n">startIndex</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 959</span><span class="w">       </span><span class="k">do </span><span class="n">level</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 960</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 961</span><span class="k">	   </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="w"></span>
<span class="linenos"> 962</span><span class="w">	 </span><span class="k">else </span>
<span class="linenos"> 963</span><span class="k">           do </span><span class="n">levelIndex</span><span class="o">=</span><span class="n">startIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 964</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 965</span><span class="k">                </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos"> 966</span><span class="w">	        </span><span class="k">exit</span>
<span class="linenos"> 967</span><span class="k">             else if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">levelIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 968</span><span class="k">                </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="n">levelIndex</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos"> 969</span><span class="w">                </span><span class="k">exit</span>
<span class="linenos"> 970</span><span class="k">             end if</span>
<span class="linenos"> 971</span><span class="k">           end do</span>
<span class="linenos"> 972</span><span class="k">           if</span><span class="w"> </span><span class="p">(</span><span class="n">level</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos"> 973</span><span class="k">             if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w">  </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos"> 974</span><span class="w">               </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 975</span><span class="w">           </span><span class="k">end if</span>
<span class="linenos"> 976</span><span class="k">	   </span><span class="n">startIndex</span><span class="o">=</span><span class="n">levelIndex</span><span class="w"></span>
<span class="linenos"> 977</span><span class="w">	 </span><span class="k">end if</span>
<span class="linenos"> 978</span><span class="k">       end do</span>
<span class="linenos"> 979</span><span class="k">       </span>
<span class="linenos"> 980</span><span class="k">    end if</span>
<span class="linenos"> 981</span>
<span class="linenos"> 982</span><span class="k">  end subroutine </span><span class="n">oopc_getLevels</span><span class="w"></span>
<span class="linenos"> 983</span>
<span class="linenos"> 984</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 985</span><span class="w">  </span><span class="c">! oopc_deallocLevels</span>
<span class="linenos"> 986</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos"> 987</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_deallocLevels</span><span class="w"></span>
<span class="linenos"> 988</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 989</span><span class="w">    </span><span class="c">!:Purpose: To deallocate temporary storage space used for layer info</span>
<span class="linenos"> 990</span><span class="w">    </span><span class="c">!</span>
<span class="linenos"> 991</span>
<span class="linenos"> 992</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos"> 993</span>
<span class="linenos"> 994</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="linenos"> 995</span>
<span class="linenos"> 996</span><span class="k">    call </span><span class="n">oopc_deallocInfo</span><span class="p">(</span><span class="n">oopc_levels</span><span class="p">)</span><span class="w"></span>
<span class="linenos"> 997</span><span class="w"> </span>
<span class="linenos"> 998</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_deallocLevels</span><span class="w"></span>
<span class="linenos"> 999</span>
<span class="linenos">1000</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1001</span><span class="w">  </span><span class="c">!-------------- Routines related to averaging kernel matrices -------------</span>
<span class="linenos">1002</span>
<span class="linenos">1003</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1004</span><span class="w">  </span><span class="c">! oopc_readAvgkern</span>
<span class="linenos">1005</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1006</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_readAvgkern</span><span class="w"></span>
<span class="linenos">1007</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1008</span><span class="w">    </span><span class="c">!:Purpose: To read averaging kernels from auxiliary file or observation file</span>
<span class="linenos">1009</span><span class="w">    </span><span class="c">!              </span>
<span class="linenos">1010</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1011</span>
<span class="linenos">1012</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1013</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ndim</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1014</span>
<span class="linenos">1015</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">istnid</span><span class="w"></span>
<span class="linenos">1016</span>
<span class="linenos">1017</span><span class="w">    </span><span class="c">! read the averaging kernel information from the auxiliary file</span>
<span class="linenos">1018</span><span class="w">    </span><span class="k">call </span><span class="n">oopc_readAvgkernAuxfile</span><span class="w"></span>
<span class="linenos">1019</span>
<span class="linenos">1020</span><span class="w">    </span><span class="c">! set size of observation file array</span>
<span class="linenos">1021</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">obsSubSpace</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1022</span>
<span class="linenos">1023</span><span class="w">    </span><span class="c">! read from observation file</span>
<span class="linenos">1024</span><span class="w">    </span><span class="k">do </span><span class="n">istnid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"></span>
<span class="linenos">1025</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1026</span><span class="w">        </span>
<span class="linenos">1027</span><span class="w">        </span><span class="c">! retrieve data from stats blocks (with bkstp=14 and block_type=&#39;DATA&#39;)</span>
<span class="linenos">1028</span><span class="w">        </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">obsSubSpace</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsf_obsSub_read</span><span class="p">(</span><span class="s1">&#39;CH&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1029</span><span class="w">	  </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">stnids</span><span class="p">(</span><span class="n">istnid</span><span class="p">),</span><span class="n">bufr_avgkern</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">istnid</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1030</span><span class="w">          </span><span class="n">ndim</span><span class="p">,</span><span class="w"> </span><span class="n">numColumns_opt</span><span class="o">=</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">istnid</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1031</span><span class="w">	  </span><span class="n">bkstp_opt</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="n">block_opt</span><span class="o">=</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">match_nlev_opt</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">1032</span><span class="w">     </span>
<span class="linenos">1033</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1034</span><span class="k">    end do</span>
<span class="linenos">1035</span>
<span class="linenos">1036</span><span class="k">  end subroutine </span><span class="n">oopc_readAvgkern</span><span class="w"></span>
<span class="linenos">1037</span>
<span class="linenos">1038</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1039</span><span class="w">  </span><span class="c">! oopc_readAvgkernAuxfile</span>
<span class="linenos">1040</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1041</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_readAvgkernAuxfile</span><span class="w"></span>
<span class="linenos">1042</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1043</span><span class="w">    </span><span class="c">!:Purpose: To read and to store averaging kernel matricesfor CH sub-families</span>
<span class="linenos">1044</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1045</span><span class="w">    </span><span class="c">!:Comments:</span>
<span class="linenos">1046</span><span class="w">    </span><span class="c">!      - Currently implemented for only one latitude band</span>
<span class="linenos">1047</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1048</span>
<span class="linenos">1049</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1050</span>
<span class="linenos">1051</span><span class="w">    </span><span class="c">!Locals:</span>
<span class="linenos">1052</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fnom</span><span class="p">,</span><span class="w"> </span><span class="n">fclos</span><span class="w"></span>
<span class="linenos">1053</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ierr</span><span class="p">,</span><span class="w"> </span><span class="n">jlev</span><span class="p">,</span><span class="w"> </span><span class="n">jelm</span><span class="p">,</span><span class="w"> </span><span class="n">nulstat</span><span class="p">,</span><span class="w"> </span><span class="n">ios</span><span class="p">,</span><span class="w"> </span><span class="n">isize</span><span class="p">,</span><span class="w"> </span><span class="n">icount</span><span class="p">,</span><span class="w"> </span><span class="n">iend</span><span class="w"></span>
<span class="linenos">1054</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">LnewExists</span><span class="p">,</span><span class="n">newread</span><span class="w"></span>
<span class="linenos">1055</span><span class="w">  </span>
<span class="linenos">1056</span><span class="w">    </span><span class="kt">character</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos">1057</span>
<span class="linenos">1058</span><span class="w">    </span><span class="k">external </span><span class="n">fnom</span><span class="p">,</span><span class="n">fclos</span><span class="w"></span>
<span class="linenos">1059</span>
<span class="linenos">1060</span><span class="w">    </span><span class="c">! Initialization</span>
<span class="linenos">1061</span>
<span class="linenos">1062</span><span class="w">    </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1063</span>
<span class="linenos">1064</span><span class="w">    </span><span class="k">inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">),</span><span class="n">EXIST</span><span class="o">=</span><span class="n">LnewExists</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1065</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">LnewExists</span><span class="w"> </span><span class="p">)</span><span class="k">then</span>
<span class="linenos">1066</span><span class="k">      write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">   </span><span class="s1">&#39;-------------------------------------------------------&#39;</span><span class="w"></span>
<span class="linenos">1067</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">   </span><span class="s1">&#39;oopc_readAvgkernAuxfile: COULD NOT FIND AUXILIARY file &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1068</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">   </span><span class="s1">&#39;-------------------------------------------------------&#39;</span><span class="w"></span>
<span class="linenos">1069</span><span class="w">      </span><span class="k">return</span>
<span class="linenos">1070</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">1071</span>
<span class="linenos">1072</span><span class="w">    </span><span class="c">! Check for available layer info.</span>
<span class="linenos">1073</span>
<span class="linenos">1074</span><span class="w">    </span><span class="n">nulstat</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1075</span><span class="w">    </span><span class="n">ierr</span><span class="o">=</span><span class="n">fnom</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">),</span><span class="s1">&#39;SEQ&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1076</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1077</span><span class="k">      open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">nulstat</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">),</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;OLD&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1078</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">1079</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readAvgkernAuxfile: COULD NOT OPEN AUXILIARY file &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_aux_filename</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1080</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1081</span>
<span class="linenos">1082</span><span class="k">    </span><span class="n">ios</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1083</span><span class="w">    </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos">1084</span><span class="w">    </span><span class="k">do while</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="n">ligne</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">14</span><span class="p">)))</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;SECTION III:&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">1085</span><span class="w">      </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos">1086</span><span class="w">    </span><span class="k">end do</span><span class="w">    </span>
<span class="linenos">1087</span><span class="w">  </span>
<span class="linenos">1088</span><span class="w">    </span><span class="c">! Read number of observation set sub-families (STNIDs and ...) and allocate space</span>
<span class="linenos">1089</span><span class="w">   </span>
<span class="linenos">1090</span><span class="w">    </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"></span>
<span class="linenos">1091</span><span class="w">    </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">isize</span><span class="w"></span>
<span class="linenos">1092</span>
<span class="linenos">1093</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">stnids</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1094</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1095</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">ibegin</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1096</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">element</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1097</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1098</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1099</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="k">type</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1100</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">profElement</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1101</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">rak</span><span class="p">(</span><span class="n">isize</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1102</span><span class="w"> </span>
<span class="linenos">1103</span><span class="w">    </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">element</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1104</span><span class="w">    </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">source</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1105</span><span class="w">    </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(:)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1106</span><span class="w">    </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(:)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1107</span><span class="w">    </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="k">type</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos">1108</span>
<span class="linenos">1109</span><span class="w">    </span><span class="c">! Begin reading for each sub-family</span>
<span class="linenos">1110</span><span class="w">    </span><span class="c">! Important: Combination of STNID, BUFR element and number of vertical levels </span>
<span class="linenos">1111</span><span class="w">    </span><span class="c">!            to determine association to the observations.</span>
<span class="linenos">1112</span>
<span class="linenos">1113</span><span class="w">    </span><span class="n">icount</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1114</span><span class="w">    </span><span class="n">STNIDLOOP</span><span class="p">:</span><span class="w"> </span><span class="k">do </span><span class="n">jelm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"></span>
<span class="linenos">1115</span><span class="w">      </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">ibegin</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="o">=</span><span class="n">icount</span><span class="w"></span>
<span class="linenos">1116</span>
<span class="linenos">1117</span><span class="w">      </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos">1118</span>
<span class="linenos">1119</span><span class="w">      </span><span class="c">! Read STNID (* is a wildcard)</span>
<span class="linenos">1120</span><span class="w">    </span>
<span class="linenos">1121</span><span class="w">      </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(2X,A9,1X,A15)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">stnids</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="k">type</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1122</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="k">type</span><span class="p">(</span><span class="n">jelm</span><span class="p">))</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;log&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1123</span><span class="k">        </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="k">type</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos">1124</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1125</span>
<span class="linenos">1126</span><span class="w">      </span><span class="c">! Read (1) Obs BUFR element.</span>
<span class="linenos">1127</span><span class="w">      </span><span class="c">!      (2) Flag indication if avgkern provided from this auxiliary file or</span>
<span class="linenos">1128</span><span class="w">      </span><span class="c">!          to be read from an observation file,</span>
<span class="linenos">1129</span><span class="w">      </span><span class="c">!      (3) Number of obs in profile (number of rows)</span>
<span class="linenos">1130</span><span class="w">      </span><span class="c">!      (4) Number of columns (optional read; number of obs operator vertical levels with or without the</span>
<span class="linenos">1131</span><span class="w">      </span><span class="c">!          resultant a priori contribution (I-A)xa).</span>
<span class="linenos">1132</span><span class="w">      </span><span class="c">!          If number of rows (n_lvl) equals 1, the actual levels for the columns need to be specified from </span>
<span class="linenos">1133</span><span class="w">      </span><span class="c">!          section II (see routine oopc_readLevels)</span>
<span class="linenos">1134</span><span class="w">      </span><span class="c">!</span>
<span class="linenos">1135</span><span class="w">      </span><span class="c">! Important: Combination of STNID, BUFR element and number of vertical levels</span>
<span class="linenos">1136</span><span class="w">      </span><span class="c">!            to determine association to the observations.</span>
<span class="linenos">1137</span>
<span class="linenos">1138</span><span class="w">      </span><span class="n">newread</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1139</span><span class="w">      </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">element</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1140</span><span class="w">        </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">profElement</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1141</span><span class="w">      </span><span class="n">newread</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1142</span><span class="w"> </span><span class="mi">20</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newread</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1143</span><span class="k">        backspace</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1144</span><span class="w">        </span><span class="k">backspace</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1145</span><span class="w">        </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">element</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1146</span><span class="w">          </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">jelm</span><span class="p">),</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1147</span><span class="w">        </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="o">=</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">1148</span><span class="w">        </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">profElement</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">element</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1149</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1150</span><span class="k">      </span>
<span class="linenos">1151</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">icount</span><span class="o">+</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">isize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1152</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readAvgkernAuxfile: READING PROBLEM. &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1153</span><span class="w">	               </span><span class="s1">&#39;Max array size exceeded:&#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">isize</span><span class="p">)))</span><span class="w">    </span>
<span class="linenos">1154</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1155</span><span class="k">      read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos">1156</span>
<span class="linenos">1157</span><span class="w">      </span><span class="c">! disregard data section if values to be specified in BUFR file</span>
<span class="linenos">1158</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">cycle </span><span class="n">STNIDLOOP</span><span class="w"></span>
<span class="linenos">1159</span><span class="w">    </span>
<span class="linenos">1160</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then   </span>
<span class="linenos">1161</span><span class="k">        do </span><span class="n">jlev</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1162</span>
<span class="linenos">1163</span><span class="w">          </span><span class="n">iend</span><span class="o">=</span><span class="n">icount</span><span class="o">+</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">jelm</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1164</span><span class="w">       </span>
<span class="linenos">1165</span><span class="w">          </span><span class="c">! Read averaging kernel matrix   </span>
<span class="linenos">1166</span><span class="w">          </span><span class="k">read</span><span class="p">(</span><span class="n">nulstat</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">rak</span><span class="p">(</span><span class="n">icount</span><span class="p">:</span><span class="n">iend</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1167</span>
<span class="linenos">1168</span><span class="w">          </span><span class="n">icount</span><span class="o">=</span><span class="n">iend</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1169</span>
<span class="linenos">1170</span><span class="w">        </span><span class="k">end do</span>
<span class="linenos">1171</span><span class="k">      end if</span>
<span class="linenos">1172</span>
<span class="linenos">1173</span><span class="k">    end do </span><span class="n">STNIDLOOP</span><span class="w"></span>
<span class="linenos">1174</span><span class="w">   </span>
<span class="linenos">1175</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ios</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1176</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readAvgkernAuxfile: READING PROBLEM. &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1177</span><span class="w">                     </span><span class="s1">&#39;File read error message number: &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">ios</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">1178</span><span class="w">    </span><span class="k">end if   </span>
<span class="linenos">1179</span><span class="k"> </span>
<span class="linenos">1180</span><span class="k"> </span><span class="mi">11</span><span class="w"> </span><span class="k">CLOSE</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">nulstat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1181</span><span class="w">    </span><span class="n">ierr</span><span class="o">=</span><span class="n">fclos</span><span class="p">(</span><span class="n">nulstat</span><span class="p">)</span><span class="w">    </span>
<span class="linenos">1182</span>
<span class="linenos">1183</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_readAvgkernAuxfile</span><span class="w"></span>
<span class="linenos">1184</span>
<span class="linenos">1185</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1186</span><span class="w">  </span><span class="c">! oopc_deallocAvgkern</span>
<span class="linenos">1187</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1188</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_deallocAvgkern</span><span class="w"></span>
<span class="linenos">1189</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1190</span><span class="w">    </span><span class="c">!:Purpose: To deallocate temporary storage space used for averaging kernels</span>
<span class="linenos">1191</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1192</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1193</span>
<span class="linenos">1194</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1195</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">istnid</span><span class="w"></span>
<span class="linenos">1196</span>
<span class="linenos">1197</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="linenos">1198</span>
<span class="linenos">1199</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">obsSubSpace</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1200</span><span class="k">      do </span><span class="n">istnid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"></span>
<span class="linenos">1201</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1202</span><span class="k">	  call </span><span class="n">oss_obsdata_dealloc</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">obsSubSpace</span><span class="p">(</span><span class="n">istnid</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1203</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1204</span><span class="k">      end do</span>
<span class="linenos">1205</span><span class="k">      deallocate</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">obsSubSpace</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1206</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1207</span>
<span class="linenos">1208</span><span class="k">    call </span><span class="n">oopc_deallocInfo</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1209</span><span class="w">  </span>
<span class="linenos">1210</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_deallocAvgkern</span><span class="w"></span>
<span class="linenos">1211</span>
<span class="linenos">1212</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1213</span><span class="w">  </span><span class="c">! oopc_findAvgkern</span>
<span class="linenos">1214</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1215</span><span class="w">  </span><span class="k">function </span><span class="n">oopc_findAvgkern</span><span class="p">(</span><span class="n">cstnid</span><span class="p">,</span><span class="n">varno</span><span class="p">,</span><span class="n">nlev</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1216</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1217</span><span class="w">    </span><span class="c">!:Purpose: To find the averaging kernel for an observation if one is</span>
<span class="linenos">1218</span><span class="w">    </span><span class="c">!          specified. Returns 0 if either not found or not specified.</span>
<span class="linenos">1219</span><span class="w">    </span><span class="c">!          Combination of STNID, BUFR element and number of vertical levels</span>
<span class="linenos">1220</span><span class="w">    </span><span class="c">!          to determine association to the observations.</span>
<span class="linenos">1221</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1222</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1223</span><span class="k">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">istnid</span><span class="w"> </span><span class="c">! Index of averaging kernel in oopc_avgkern if found. Zero indicates  averaging kernel not found.</span>
<span class="linenos">1224</span>
<span class="linenos">1225</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1226</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cstnid</span><span class="w"> </span><span class="c">! station id</span>
<span class="linenos">1227</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varno</span><span class="w"> </span><span class="c">! BUFR descriptor element</span>
<span class="linenos">1228</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nlev</span><span class="w">  </span><span class="c">! number of levels in the observation</span>
<span class="linenos">1229</span>
<span class="linenos">1230</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1231</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">stnidIndex</span><span class="w"></span>
<span class="linenos">1232</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iset</span><span class="w"></span>
<span class="linenos">1233</span>
<span class="linenos">1234</span><span class="w">    </span><span class="c">! Find stnid with same number of vertical levels, and same BUFR element</span>
<span class="linenos">1235</span><span class="w">          </span>
<span class="linenos">1236</span><span class="w">    </span><span class="n">istnid</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1237</span>
<span class="linenos">1238</span><span class="w">    </span><span class="k">do </span><span class="n">stnidIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="w"></span>
<span class="linenos">1239</span>
<span class="linenos">1240</span><span class="w">      </span><span class="c">! First compare STNID values allowing for * and blanks in </span>
<span class="linenos">1241</span><span class="w">      </span><span class="c">! oopc_avgkern%stnids(stnidIndex) as wildcards</span>
<span class="linenos">1242</span><span class="w">      </span><span class="n">iset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utl_stnid_equal</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">stnids</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">),</span><span class="n">CSTNID</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1243</span>
<span class="linenos">1244</span><span class="w">      </span><span class="c">! Check if number of levels and BUFR code are equal.</span>
<span class="linenos">1245</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iset</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1246</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">varno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">element</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1247</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">nlev</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">nlev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1248</span><span class="w">	      </span><span class="n">nlev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1249</span><span class="w">              </span><span class="n">nlev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1250</span><span class="w">              </span><span class="n">nlev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1251</span><span class="k">	      </span>
<span class="linenos">1252</span><span class="k">            </span><span class="n">istnid</span><span class="o">=</span><span class="n">stnidIndex</span><span class="w"></span>
<span class="linenos">1253</span><span class="w">            </span><span class="k">exit</span>
<span class="linenos">1254</span><span class="k">          end if</span>
<span class="linenos">1255</span><span class="k">        end if</span>
<span class="linenos">1256</span><span class="k">      end if</span>
<span class="linenos">1257</span><span class="k">              </span>
<span class="linenos">1258</span><span class="k">    end do</span>
<span class="linenos">1259</span>
<span class="linenos">1260</span><span class="k">  end function </span><span class="n">oopc_findAvgkern</span><span class="w"></span>
<span class="linenos">1261</span>
<span class="linenos">1262</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1263</span><span class="w">  </span><span class="c">! oopc_getAvgkern</span>
<span class="linenos">1264</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1265</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_getAvgkern</span><span class="p">(</span><span class="n">istnid</span><span class="p">,</span><span class="n">nlev</span><span class="p">,</span><span class="n">ncol</span><span class="p">,</span><span class="n">code</span><span class="p">,</span><span class="n">avg_kern</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1266</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1267</span><span class="w">    </span><span class="c">!:Purpose: To return averaging kernel for an observation.</span>
<span class="linenos">1268</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1269</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1270</span>
<span class="linenos">1271</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1272</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">istnid</span><span class="w">       </span><span class="c">! index of averaging kernel in oopc_avgkern</span>
<span class="linenos">1273</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="c">! measurement identifier</span>
<span class="linenos">1274</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">nlev</span><span class="w">         </span><span class="c">! number of observation levels</span>
<span class="linenos">1275</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">ncol</span><span class="w">         </span><span class="c">! number of columns for avg kernel info (without the a priori contribution)</span>
<span class="linenos">1276</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">avg_kern</span><span class="p">(</span><span class="n">nlev</span><span class="p">,</span><span class="n">ncol</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c">! the averaging kernel, plus the possible a priori contribution</span>
<span class="linenos">1277</span><span class="w">                                                  </span><span class="c">! and integration weights.</span>
<span class="linenos">1278</span>
<span class="linenos">1279</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1280</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">startIndex</span><span class="p">,</span><span class="n">endIndex</span><span class="w"></span>
<span class="linenos">1281</span>
<span class="linenos">1282</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">istnid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">istnid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_stnid</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1283</span><span class="k">       </span>
<span class="linenos">1284</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1285</span><span class="w">        </span><span class="c">! Check number of columns</span>
<span class="linenos">1286</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ncol</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1287</span><span class="w">	    </span><span class="n">ncol</span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1288</span><span class="k">	    </span>
<span class="linenos">1289</span><span class="k">          call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_getAvgkern: Inconsistency &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1290</span><span class="w">	                 </span><span class="s1">&#39;in avg kern size for &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">stnids</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">1291</span><span class="w">        </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1292</span><span class="w">	      </span>
<span class="linenos">1293</span><span class="w">        </span><span class="c">! get averaging kernel from auxiliary file</span>
<span class="linenos">1294</span><span class="w">        </span><span class="n">startIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">ibegin</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1295</span><span class="w">        </span><span class="n">endIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev</span><span class="o">*</span><span class="p">(</span><span class="n">startIndex</span><span class="o">+</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1296</span><span class="w">        </span><span class="n">avg_kern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">RESHAPE</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">rak</span><span class="p">(</span><span class="n">startIndex</span><span class="p">:</span><span class="n">endIndex</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1297</span><span class="w">	                 </span><span class="p">(</span><span class="o">/</span><span class="n">nlev</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">istnid</span><span class="p">)</span><span class="o">/</span><span class="p">),</span><span class="n">ORDER</span><span class="w"> </span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1298</span><span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1299</span><span class="w">        </span><span class="c">! get averaging kernel from observation file</span>
<span class="linenos">1300</span><span class="w">        </span><span class="n">avg_kern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">istnid</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1301</span><span class="w">	  </span><span class="n">oss_obsdata_get_array2d</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">obsSubSpace</span><span class="p">(</span><span class="n">istnid</span><span class="p">),</span><span class="n">code</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1302</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1303</span>
<span class="linenos">1304</span><span class="k">    else</span>
<span class="linenos">1305</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;oopc_getAvgkern: Invalid station ID index.&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1306</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1307</span>
<span class="linenos">1308</span><span class="k">  end subroutine </span><span class="n">oopc_getAvgkern</span><span class="w"></span>
<span class="linenos">1309</span>
<span class="linenos">1310</span><span class="w">  </span><span class="c">!----------------------------------- Misc ---------------------------------</span>
<span class="linenos">1311</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1312</span>
<span class="linenos">1313</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1314</span><span class="w">  </span><span class="c">! oopc_dealocInfo</span>
<span class="linenos">1315</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1316</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_deallocInfo</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1317</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1318</span><span class="w">    </span><span class="c">!:Purpose: To deallocate struct_oopc_info instance</span>
<span class="linenos">1319</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1320</span><span class="w">    </span>
<span class="linenos">1321</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1322</span>
<span class="linenos">1323</span><span class="k">    type</span><span class="p">(</span><span class="n">struct_oopc_info</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">info</span><span class="w"></span>
<span class="linenos">1324</span>
<span class="linenos">1325</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">stnids</span><span class="p">))</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">stnids</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1326</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">element</span><span class="p">))</span><span class="w">      </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">element</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1327</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">source</span><span class="p">))</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">source</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1328</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">vco</span><span class="p">))</span><span class="w">          </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">vco</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1329</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">n_lat</span><span class="p">))</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">n_lat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1330</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">ibegin</span><span class="p">))</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">ibegin</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1331</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">))</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1332</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">rak</span><span class="p">))</span><span class="w">          </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">rak</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1333</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">))</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1334</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1335</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">lat</span><span class="p">))</span><span class="w">          </span><span class="k">deallocate</span><span class="p">(</span><span class="n">info</span><span class="p">%</span><span class="n">lat</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1336</span>
<span class="linenos">1337</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_deallocInfo</span><span class="w"></span>
<span class="linenos">1338</span>
<span class="linenos">1339</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1340</span><span class="w">  </span><span class="c">! oopc_diagnOnly</span>
<span class="linenos">1341</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1342</span><span class="w">  </span><span class="kt">logical </span><span class="k">function </span><span class="n">oopc_diagnOnly</span><span class="p">(</span><span class="n">cfamName</span><span class="p">,</span><span class="n">cstnid</span><span class="p">,</span><span class="n">varno</span><span class="p">,</span><span class="n">nobslev</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1343</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">1344</span><span class="w">    </span><span class="c">!:Purpose: To identify whether or not the obs set identified by the</span>
<span class="linenos">1345</span><span class="w">    </span><span class="c">!          combination of (cstnid,varno,nobslev) will be assimilated or</span>
<span class="linenos">1346</span><span class="w">    </span><span class="c">!          else used for independent verifications after</span>
<span class="linenos">1347</span><span class="w">    </span><span class="c">!          assimilation/minimization</span>
<span class="linenos">1348</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">1349</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1350</span>
<span class="linenos">1351</span><span class="w">    </span><span class="c">! Arguments</span>
<span class="linenos">1352</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cfamName</span><span class="w"> </span><span class="c">! Family name</span>
<span class="linenos">1353</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">cstnid</span><span class="w">   </span><span class="c">! Input station id</span>
<span class="linenos">1354</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varno</span><span class="w">   </span><span class="c">! Obs BUFR number</span>
<span class="linenos">1355</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nobslev</span><span class="w"> </span><span class="c">! Number of levels</span>
<span class="linenos">1356</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">flag</span><span class="w">    </span><span class="c">! observation integer flag</span>
<span class="linenos">1357</span>
<span class="linenos">1358</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1359</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">elemId</span><span class="p">,</span><span class="n">ifam</span><span class="w"></span>
<span class="linenos">1360</span><span class="w">    </span>
<span class="linenos">1361</span><span class="w">    </span><span class="n">ifam</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1362</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">assim_famNum</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1363</span><span class="k">      do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">assim_famNum</span><span class="w"></span>
<span class="linenos">1364</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">assim_fam</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cfamName</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1365</span><span class="k">          </span><span class="n">ifam</span><span class="o">=</span><span class="n">i</span><span class="w"></span>
<span class="linenos">1366</span><span class="w">          </span><span class="k">exit</span>
<span class="linenos">1367</span><span class="k">        end if</span>
<span class="linenos">1368</span><span class="k">      end do</span>
<span class="linenos">1369</span><span class="k">    end if</span>
<span class="linenos">1370</span>
<span class="linenos">1371</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">ifam</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1372</span><span class="w">      </span><span class="c">! assimilate all observations</span>
<span class="linenos">1373</span><span class="w">      </span><span class="n">oopc_diagnOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1374</span><span class="w">      </span><span class="k">return    </span>
<span class="linenos">1375</span><span class="k">    end if</span>
<span class="linenos">1376</span><span class="k">    </span>
<span class="linenos">1377</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">assim_all</span><span class="p">(</span><span class="n">ifam</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1378</span><span class="w">      </span><span class="c">! assimilate all observations</span>
<span class="linenos">1379</span><span class="w">      </span><span class="n">oopc_diagnOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1380</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">assim_num</span><span class="p">(</span><span class="n">ifam</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1381</span><span class="w">      </span><span class="c">! assimilate no observations</span>
<span class="linenos">1382</span><span class="w">      </span><span class="n">oopc_diagnOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1383</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">assim_num</span><span class="p">(</span><span class="n">ifam</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1384</span><span class="w">      </span><span class="c">! check if this observation is listed in the assim_* arrays</span>
<span class="linenos">1385</span><span class="w">      </span><span class="n">elemId</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1386</span><span class="w">      </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">assim_num</span><span class="p">(</span><span class="n">ifam</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1387</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">utl_stnid_equal</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">assim_stnid</span><span class="p">(</span><span class="n">ifam</span><span class="p">,</span><span class="n">i</span><span class="p">)),</span><span class="nb">trim</span><span class="p">(</span><span class="n">cstnid</span><span class="p">)))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1388</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">assim_varno</span><span class="p">(</span><span class="n">ifam</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">assim_varno</span><span class="p">(</span><span class="n">ifam</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">varno</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1389</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">assim_nlev</span><span class="p">(</span><span class="n">ifam</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">nobslev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1390</span><span class="w">	        </span><span class="n">assim_nlev</span><span class="p">(</span><span class="n">ifam</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1391</span><span class="w">                </span><span class="p">(</span><span class="n">nobslev</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">assim_nlev</span><span class="p">(</span><span class="n">ifam</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1392</span><span class="k">		    </span>
<span class="linenos">1393</span><span class="k">              </span><span class="n">elemId</span><span class="o">=</span><span class="n">i</span><span class="w"></span>
<span class="linenos">1394</span><span class="w">              </span><span class="k">exit</span>
<span class="linenos">1395</span><span class="k">            end if</span>
<span class="linenos">1396</span><span class="k">          end if</span>
<span class="linenos">1397</span><span class="k">        end if</span>
<span class="linenos">1398</span><span class="k">      end do</span>
<span class="linenos">1399</span><span class="k">      </span><span class="n">oopc_diagnOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elemId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1400</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1401</span><span class="k">    </span>
<span class="linenos">1402</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_diagnOnly</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"></span>
<span class="linenos">1403</span>
<span class="linenos">1404</span><span class="w">    </span><span class="c">! check if the observation integer flag has a bit marked by assim_exclude_flag (same flagging as in filt_suprep)</span>
<span class="linenos">1405</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">assim_exclude_nflag</span><span class="p">(</span><span class="n">ifam</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1406</span><span class="k">      do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">assim_exclude_nflag</span><span class="p">(</span><span class="n">ifam</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1407</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">btest</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">assim_exclude_flag</span><span class="p">(</span><span class="n">ifam</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1408</span><span class="k">          </span><span class="n">oopc_diagnOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1409</span><span class="w">          </span><span class="k">return</span>
<span class="linenos">1410</span><span class="k">        end if</span>
<span class="linenos">1411</span><span class="k">      end do</span>
<span class="linenos">1412</span><span class="k">    end if</span>
<span class="linenos">1413</span>
<span class="linenos">1414</span><span class="k">  end function </span><span class="n">oopc_diagnOnly</span><span class="w"></span>
<span class="linenos">1415</span>
<span class="linenos">1416</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1417</span><span class="w">  </span><span class="c">! oopc_checkType</span>
<span class="linenos">1418</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1419</span><span class="w">  </span><span class="k">function </span><span class="n">oopc_checkType</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">,</span><span class="n">TypeSet</span><span class="p">,</span><span class="n">stnid</span><span class="p">,</span><span class="k">type</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">sameType</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1420</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1421</span><span class="w">    </span><span class="c">!:Purpose: To determine if specified combination of (stnid,type) found</span>
<span class="linenos">1422</span><span class="w">    </span><span class="c">!          in (StnidSet,TypeSet).</span>
<span class="linenos">1423</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1424</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1425</span>
<span class="linenos">1426</span><span class="k">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">sametype</span><span class="w"></span>
<span class="linenos">1427</span>
<span class="linenos">1428</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1429</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">StnidSet</span><span class="p">(:),</span><span class="n">TypeSet</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">1430</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">stnid</span><span class="p">,</span><span class="k">type</span><span class="w"></span>
<span class="linenos">1431</span><span class="w">    </span>
<span class="linenos">1432</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1433</span><span class="w">    </span>
<span class="linenos">1434</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">stnidIndex</span><span class="w"></span>
<span class="linenos">1435</span><span class="w">          </span>
<span class="linenos">1436</span><span class="w">    </span><span class="n">sameType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1437</span><span class="w">    </span>
<span class="linenos">1438</span><span class="w">    </span><span class="k">do </span><span class="n">stnidIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1439</span><span class="w">    </span>
<span class="linenos">1440</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">TypeSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1441</span><span class="w">           </span><span class="nb">trim</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">1442</span>
<span class="linenos">1443</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">utl_stnid_equal</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">),</span><span class="n">stnid</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1444</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">stnid</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1445</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">TypeSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="k">type</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1446</span><span class="k">            </span><span class="n">sameType</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1447</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">1448</span><span class="k">            </span><span class="n">sameType</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1449</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1450</span><span class="k">          exit</span>
<span class="linenos">1451</span><span class="k">        else</span>
<span class="linenos">1452</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">TypeSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="k">type</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">sameType</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w">           </span>
<span class="linenos">1453</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1454</span><span class="k">      end if</span>
<span class="linenos">1455</span><span class="k">       </span>
<span class="linenos">1456</span><span class="k">    end do</span>
<span class="linenos">1457</span>
<span class="linenos">1458</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">sameType</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="k">type</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">sameType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1459</span><span class="w">    </span>
<span class="linenos">1460</span><span class="w">  </span><span class="k">end function </span><span class="n">oopc_checkType</span><span class="w"></span>
<span class="linenos">1461</span>
<span class="linenos">1462</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1463</span><span class="w">  </span><span class="c">! oopc_getType</span>
<span class="linenos">1464</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1465</span><span class="w">  </span><span class="k">function </span><span class="n">oopc_getType</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">,</span><span class="n">TypeSet</span><span class="p">,</span><span class="n">stnid</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="k">type</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1466</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1467</span><span class="w">    </span><span class="c">!:Purpose: To determine &quot;type&quot; for specified &quot;stnid&quot; found in &quot;(StnidSet,Typesef)&quot;.</span>
<span class="linenos">1468</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1469</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">1470</span>
<span class="linenos">1471</span><span class="k">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="k">type</span><span class="w"></span>
<span class="linenos">1472</span>
<span class="linenos">1473</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1474</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">StnidSet</span><span class="p">(:),</span><span class="n">TypeSet</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">1475</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">stnid</span><span class="w"></span>
<span class="linenos">1476</span><span class="w">    </span>
<span class="linenos">1477</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1478</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">stnidIndex</span><span class="w"></span>
<span class="linenos">1479</span><span class="w">          </span>
<span class="linenos">1480</span><span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos">1481</span><span class="w">    </span>
<span class="linenos">1482</span><span class="w">    </span><span class="k">do </span><span class="n">stnidIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1483</span><span class="w">    </span>
<span class="linenos">1484</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">TypeSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1485</span><span class="w">           </span><span class="nb">trim</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">1486</span>
<span class="linenos">1487</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">utl_stnid_equal</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">),</span><span class="n">stnid</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1488</span><span class="k">        type</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">TypeSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1489</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">StnidSet</span><span class="p">(</span><span class="n">stnidIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">stnid</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">1490</span><span class="k">      end if</span>
<span class="linenos">1491</span><span class="k">       </span>
<span class="linenos">1492</span><span class="k">    end do</span>
<span class="linenos">1493</span><span class="k">    </span>
<span class="linenos">1494</span><span class="k">  end function </span><span class="n">oopc_getType</span><span class="w"></span>
<span class="linenos">1495</span>
<span class="linenos">1496</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1497</span><span class="w">  </span><span class="c">!------------------ Routines associated to oopc_efftemp --------------------</span>
<span class="linenos">1498</span>
<span class="linenos">1499</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1500</span><span class="w">  </span><span class="c">! oopc_addEfftempObsdata</span>
<span class="linenos">1501</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1502</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_addEfftempObsdata</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="n">temp_eff</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1503</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1504</span><span class="w">    </span><span class="c">!:Purpose: To add effective temperature value to its obsdata object</span>
<span class="linenos">1505</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1506</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1507</span>
<span class="linenos">1508</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1509</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="c">! unique identifying code</span>
<span class="linenos">1510</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp_eff</span><span class="p">(:)</span><span class="w">   </span><span class="c">! effective temperature</span>
<span class="linenos">1511</span>
<span class="linenos">1512</span><span class="w">    </span><span class="k">call </span><span class="n">oss_obsdata_add_data1d</span><span class="p">(</span><span class="n">oopc_efftemp</span><span class="p">,</span><span class="n">temp_eff</span><span class="p">,</span><span class="n">code</span><span class="p">,</span><span class="n">oopc_obsdata_maxsize</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1513</span><span class="w">    </span>
<span class="linenos">1514</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_addEfftempObsdata</span><span class="w"></span>
<span class="linenos">1515</span>
<span class="linenos">1516</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1517</span><span class="w">  </span><span class="c">! oopc_addEfftempObsfile</span>
<span class="linenos">1518</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1519</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_addEfftempObsfile</span><span class="p">()</span><span class="w"></span>
<span class="linenos">1520</span><span class="w">    </span><span class="c">!          </span>
<span class="linenos">1521</span><span class="w">    </span><span class="c">!:Purpose: To add effective temperatures in obs file.</span>
<span class="linenos">1522</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1523</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1524</span>
<span class="linenos">1525</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">1526</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nrep_modified</span><span class="p">,</span><span class="n">varno</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1527</span>
<span class="linenos">1528</span><span class="w">    </span><span class="c">! If needed, add effective temperature values in obs file for total column measurements</span>
<span class="linenos">1529</span>
<span class="linenos">1530</span><span class="w">    </span><span class="k">call </span><span class="n">oss_obsdata_MPIallgather</span><span class="p">(</span><span class="n">oopc_efftemp</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1531</span><span class="w">    </span>
<span class="linenos">1532</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_efftemp</span><span class="p">%</span><span class="n">nrep</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1533</span><span class="k">      </span><span class="n">varno</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mi">12001</span><span class="w"></span>
<span class="linenos">1534</span><span class="w">      </span><span class="n">nrep_modified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsf_obsSub_update</span><span class="p">(</span><span class="n">oopc_efftemp</span><span class="p">,</span><span class="s1">&#39;CH&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1535</span><span class="w">                      </span><span class="n">varno</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_efftemp</span><span class="p">%</span><span class="n">dim2</span><span class="p">)),</span><span class="n">bkstp_opt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1536</span><span class="w">                      </span><span class="n">block_opt</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span><span class="n">multi_opt</span><span class="o">=</span><span class="s1">&#39;UNI&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">1537</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;oopc_addEfftempObsfile: Added &#39;</span><span class="p">,</span><span class="n">nrep_modified</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1538</span><span class="w">                 </span><span class="s1">&#39; effective temperature values in the obs file.&#39;</span><span class="w"></span>
<span class="linenos">1539</span><span class="w">    </span><span class="k">end if </span>
<span class="linenos">1540</span>
<span class="linenos">1541</span><span class="k">  end subroutine </span><span class="n">oopc_addEfftempObsfile</span><span class="w"></span>
<span class="linenos">1542</span>
<span class="linenos">1543</span><span class="w">  </span><span class="c">!-------------- CONTROL ROUTINES FOR OBSERVATION OPERATORS ----------------</span>
<span class="linenos">1544</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1545</span>
<span class="linenos">1546</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1547</span><span class="w">  </span><span class="c">! oopc_CHobsoperators</span>
<span class="linenos">1548</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">1549</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_CHobsoperators</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="w"> </span><span class="n">obsSpaceData</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1550</span><span class="w">                                 </span><span class="n">columnAnlInc_opt</span><span class="p">,</span><span class="w"> </span><span class="n">jobs_opt</span><span class="p">,</span><span class="w"> </span><span class="n">destObsColumn_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1551</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1552</span><span class="w">    </span><span class="c">!:Purpose: To apply the observation operators for chemical constituents.</span>
<span class="linenos">1553</span><span class="w">    </span><span class="c">!          Mode of operator set by mode (see also kmode below).</span>
<span class="linenos">1554</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1555</span><span class="w">    </span><span class="c">!:Comments:</span>
<span class="linenos">1556</span><span class="w">    </span><span class="c">!      - See type struct_oopc_obsoperators for description of obsoper elements.</span>
<span class="linenos">1557</span><span class="w">    </span><span class="c">!      - Currently can only handle the case when nlev_bkgrnd == nlev_inc</span>
<span class="linenos">1558</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1559</span><span class="w">    </span><span class="c">!:Arguments:</span>
<span class="linenos">1560</span><span class="w">    </span><span class="c">!   :columnTrl:      Column of x_background interpolated to observation</span>
<span class="linenos">1561</span><span class="w">    </span><span class="c">!                    location. Can have the same vertical levels as the</span>
<span class="linenos">1562</span><span class="w">    </span><span class="c">!                    trial field (columnhr) or as the increment field</span>
<span class="linenos">1563</span><span class="w">    </span><span class="c">!                    (columng)</span>
<span class="linenos">1564</span><span class="w">    </span><span class="c">!   :mode: (kmode retained internally following the switch to mode as input)</span>
<span class="linenos">1565</span><span class="w">    </span><span class="c">!    +------+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+</span>
<span class="linenos">1566</span><span class="w">    </span><span class="c">!    | mode  |kmode|       Mode of         |             Results               |</span>
<span class="linenos">1567</span><span class="w">    </span><span class="c">!    |       |     | Observation Operator  |                                   |</span>
<span class="linenos">1568</span><span class="w">    </span><span class="c">!    +=======+=====+=======================+===================================+</span>
<span class="linenos">1569</span><span class="w">    </span><span class="c">!    |  nl   |  0  |for general simulation |OmP and total Jo(x_background)     |</span>
<span class="linenos">1570</span><span class="w">    </span><span class="c">!    |       |     |operator               |for CH. OmP saved in OBS_OMP of    |</span>
<span class="linenos">1571</span><span class="w">    </span><span class="c">!    |       |     |(non-linear and linear)|obsSpaceData                       |</span>
<span class="linenos">1572</span><span class="w">    </span><span class="c">!    +-------+-----+-----------------------+-----------------------------------+</span>
<span class="linenos">1573</span><span class="w">    </span><span class="c">!    | HBHT  |  1  |for identification or  |background error standard dev.     |</span>
<span class="linenos">1574</span><span class="w">    </span><span class="c">!    |       |     |determination of       |in observation space saved in      |</span>
<span class="linenos">1575</span><span class="w">    </span><span class="c">!    |       |     |of sqrt(diag(H*B*H^T). |in OBS_HPHT of obsSpaceData        |</span>
<span class="linenos">1576</span><span class="w">    </span><span class="c">!    |       |     |Depends on the presence|if OmP error std dev not initially</span>
<span class="linenos">1577</span><span class="w">    </span><span class="c">!    |       |     |of OmP error std dev   |available in OBS_OMPE              |</span>
<span class="linenos">1578</span><span class="w">    </span><span class="c">!    +-------+-----+-----------------------+-----------------------------------+</span>
<span class="linenos">1579</span><span class="w">    </span><span class="c">!    |  tl   |  2  |for tangent linear     |Hdx saved in OBS_WORK of           |</span>
<span class="linenos">1580</span><span class="w">    </span><span class="c">!    |       |     |operator               |obsSpaceData                       |</span>
<span class="linenos">1581</span><span class="w">    </span><span class="c">!    +------+-----+-----------------------+-----------------------------------+</span>
<span class="linenos">1582</span><span class="w">    </span><span class="c">!    |adjoint|  3  |for adjoint of tangent |H^T * R^-1 (OmP-Hdx) in            |</span>
<span class="linenos">1583</span><span class="w">    </span><span class="c">!    |       |     |linear operator        |columnAnlInc_opt                      |</span>
<span class="linenos">1584</span><span class="w">    </span><span class="c">!    +-------+-----+-----------------------+-----------------------------------+    </span>
<span class="linenos">1585</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1586</span><span class="w">    </span><span class="c">!   :columnAnlInc_opt:  Optional argument for input/output of column of</span>
<span class="linenos">1587</span><span class="w">    </span><span class="c">!                    increment (column). For kmode=2, used as input for</span>
<span class="linenos">1588</span><span class="w">    </span><span class="c">!                    increment H_horiz dx interpolated to observation</span>
<span class="linenos">1589</span><span class="w">    </span><span class="c">!                    location. For kmode=3, used as output for H^T * R^-1</span>
<span class="linenos">1590</span><span class="w">    </span><span class="c">!                    (OmP-Hdx). Required for kmode=2,3.</span>
<span class="linenos">1591</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1592</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1593</span><span class="w">    </span><span class="c">!   :jobs_opt:       Optional output of total Jo(x_background) for chemical</span>
<span class="linenos">1594</span><span class="w">    </span><span class="c">!                    constituents. Required for kmode=0 and not provided</span>
<span class="linenos">1595</span><span class="w">    </span><span class="c">!                    otherwise.</span>
<span class="linenos">1596</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1597</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1598</span>
<span class="linenos">1599</span>
<span class="linenos">1600</span><span class="w">    </span><span class="c">! More Comments (not rendered in Sphinx):</span>
<span class="linenos">1601</span><span class="w">    </span><span class="c">!      - Two equivalent methods for looping over a report body.</span>
<span class="linenos">1602</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1603</span><span class="w">    </span><span class="c">!        Method 1:</span>
<span class="linenos">1604</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1605</span><span class="w">    </span><span class="c">!             call obs_set_current_body_list(obsSpaceData,headerIndex)</span>
<span class="linenos">1606</span><span class="w">    </span><span class="c">!             BODY: do</span>
<span class="linenos">1607</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1608</span><span class="w">    </span><span class="c">!                bodyIndex = obs_getBodyIndex(obsSpaceData)</span>
<span class="linenos">1609</span><span class="w">    </span><span class="c">!                if (bodyIndex &lt; 0) exit BODY1</span>
<span class="linenos">1610</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1611</span><span class="w">    </span><span class="c">!                ... obs_bodyElem_r(obsSpaceData, ... ,bodyIndex)</span>
<span class="linenos">1612</span><span class="w">    </span><span class="c">!  </span>
<span class="linenos">1613</span><span class="w">    </span><span class="c">!             end do BODY</span>
<span class="linenos">1614</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1615</span><span class="w">    </span><span class="c">!        Method 2:</span>
<span class="linenos">1616</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1617</span><span class="w">    </span><span class="c">!             bodyIndex_start = obs_headElem_i(obsSpaceData,OBS_RLN,headerIndex)</span>
<span class="linenos">1618</span><span class="w">    </span><span class="c">!             bodyIndex_end = bodyIndex_start+obs_headElem_i(obsSpaceData,OBS_NLV,headerIndex)-1</span>
<span class="linenos">1619</span><span class="w">    </span><span class="c">!             do  bodyIndex=bodyIndex_start,bodyIndex_end</span>
<span class="linenos">1620</span><span class="w">    </span><span class="c">!                ... obs_bodyElem_r(obsSpaceData, ... ,bodyIndex)   </span>
<span class="linenos">1621</span><span class="w">    </span><span class="c">!             end do</span>
<span class="linenos">1622</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">1623</span><span class="w">    </span>
<span class="linenos">1624</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">1625</span><span class="w">    </span>
<span class="linenos">1626</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">1627</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_columnData</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">columnTrl</span><span class="w"></span>
<span class="linenos">1628</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_obs</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="kd">::</span><span class="n">obsSpaceData</span><span class="w"> </span><span class="c">! Observation-space data object</span>
<span class="linenos">1629</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">mode</span><span class="w"></span>
<span class="linenos">1630</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_columnData</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">columnAnlInc_opt</span><span class="w"></span>
<span class="linenos">1631</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jobs_opt</span><span class="w"></span>
<span class="linenos">1632</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">destObsColumn_opt</span><span class="w"></span>
<span class="linenos">1633</span>
<span class="linenos">1634</span><span class="w">    </span><span class="c">! Local variables</span>
<span class="linenos">1635</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zomp</span><span class="p">,</span><span class="n">zinc</span><span class="p">,</span><span class="n">zoer</span><span class="p">,</span><span class="n">zhbht</span><span class="w"></span>
<span class="linenos">1636</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="c">! Mode of observation operator</span>
<span class="linenos">1637</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">external</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fclos</span><span class="w"></span>
<span class="linenos">1638</span>
<span class="linenos">1639</span><span class="w">    </span><span class="c">! Obs space local variables</span>
<span class="linenos">1640</span>
<span class="linenos">1641</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">headerIndex</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="n">bodyIndex_start</span><span class="p">,</span><span class="n">bodyIndex_end</span><span class="w"></span>
<span class="linenos">1642</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">icodtyp</span><span class="p">,</span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">nobslev</span><span class="p">,</span><span class="n">varno</span><span class="p">,</span><span class="n">maxnumHeaders</span><span class="p">,</span><span class="n">headerCount</span><span class="w"></span>
<span class="linenos">1643</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">destObsColumn</span><span class="w"></span>
<span class="linenos">1644</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">stnid</span><span class="w"></span>
<span class="linenos">1645</span>
<span class="linenos">1646</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iass</span><span class="p">(:),</span><span class="n">flag</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">1647</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">process_obs</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">1648</span>
<span class="linenos">1649</span><span class="w">    </span><span class="c">! Model space profile local variables</span>
<span class="linenos">1650</span>
<span class="linenos">1651</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obs_col</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">1652</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">col</span><span class="p">(:),</span><span class="n">model_col</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">1653</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nlev_bkgrnd</span><span class="p">,</span><span class="n">nlev_inc</span><span class="p">,</span><span class="n">modlevIndex</span><span class="w"></span>
<span class="linenos">1654</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;TH&#39;</span><span class="w"></span>
<span class="linenos">1655</span>
<span class="linenos">1656</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;nl&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1657</span><span class="k">      </span><span class="n">kmode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1658</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;HBHT&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1659</span><span class="k">      </span><span class="n">kmode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1660</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;tl&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1661</span><span class="k">      </span><span class="n">kmode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1662</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;adjoint&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1663</span><span class="k">      </span><span class="n">kmode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="linenos">1664</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1665</span><span class="w">    </span>
<span class="linenos">1666</span><span class="w">    </span><span class="c">! Apply setup on first call</span>
<span class="linenos">1667</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">initializedChem</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1668</span><span class="k">      call </span><span class="n">oopc_setupCH</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1669</span><span class="w">      </span><span class="n">initializedChem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">1670</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;HBHT&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">bgStats</span><span class="p">%</span><span class="n">initialized</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1671</span><span class="k">      call </span><span class="n">bcsc_getCovarCH</span><span class="p">(</span><span class="n">bgStats</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1672</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1673</span><span class="k">    </span>
<span class="linenos">1674</span><span class="k">    if</span><span class="w"> </span><span class="p">((</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">present</span><span class="p">(</span><span class="n">columnAnlInc_opt</span><span class="p">)))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1675</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;oopc_CHobsoperators: columnAnlInc_opt must &quot;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1676</span><span class="w">                     </span><span class="s2">&quot;be specified for kmode = &quot;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">utl_str</span><span class="p">(</span><span class="n">kmode</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1677</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1678</span><span class="w">     </span>
<span class="linenos">1679</span><span class="w">    </span><span class="c">! Initializations</span>
<span class="linenos">1680</span><span class="w">    </span>
<span class="linenos">1681</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">present</span><span class="p">(</span><span class="n">destObsColumn_opt</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1682</span><span class="k">      </span><span class="n">destObsColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">destObsColumn_opt</span><span class="w"></span>
<span class="linenos">1683</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">1684</span><span class="k">      </span><span class="n">destObsColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_omp</span><span class="w"></span>
<span class="linenos">1685</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">1686</span><span class="k">        </span>
<span class="linenos">1687</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">jobs_opt</span><span class="p">))</span><span class="w"> </span><span class="n">jobs_opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.d0</span><span class="w"></span>
<span class="linenos">1688</span>
<span class="linenos">1689</span><span class="w">    </span><span class="n">nlev_bkgrnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_getNumLev</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="n">varLevel</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1690</span><span class="w">    </span>
<span class="linenos">1691</span><span class="w">    </span><span class="c">! Allocate memory for model_col. Not necessary for kmode=0 since model_col points to obsoper%trial.</span>
<span class="linenos">1692</span><span class="w">    </span><span class="k">select case</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1693</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1694</span><span class="w">      </span><span class="n">nlev_inc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_getNumLev</span><span class="p">(</span><span class="n">columnAnlInc_opt</span><span class="p">,</span><span class="n">varLevel</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1695</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">model_col</span><span class="p">(</span><span class="n">nlev_inc</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1696</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nlev_inc</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">nlev_bkgrnd</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1697</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;oopc_CHobsoperators: nlev_inc &quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1698</span><span class="w">                   </span><span class="s2">&quot;and nlev_bkgrnd not the same: &quot;</span><span class="p">,</span><span class="n">nlev_inc</span><span class="p">,</span><span class="w"> </span><span class="n">nlev_bkgrnd</span><span class="w"></span>
<span class="linenos">1699</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">1700</span><span class="k">    case</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1701</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">model_col</span><span class="p">(</span><span class="n">nlev_bkgrnd</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1702</span><span class="w">    </span><span class="k">end select</span><span class="w"></span>
<span class="linenos">1703</span>
<span class="linenos">1704</span><span class="w">    </span><span class="c">! Allocations outside oopc_obsoperInit since this can be done outside the HEADER loop.</span>
<span class="linenos">1705</span><span class="w">    </span><span class="c">! See oopc_obsoperInit for assignment of array content.</span>
<span class="linenos">1706</span><span class="w">    </span>
<span class="linenos">1707</span><span class="w">    </span><span class="c">! Model obs background, height, TT, and HU profiles.</span>
<span class="linenos">1708</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">(</span><span class="n">nlev_bkgrnd</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">(</span><span class="n">nlev_bkgrnd</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="p">(</span><span class="n">nlev_bkgrnd</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">hu</span><span class="p">(</span><span class="n">nlev_bkgrnd</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1709</span><span class="w">    </span><span class="c">! Model PP and pressure model layer boundaries taken as the middle between model levels.</span>
<span class="linenos">1710</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">nlev_bkgrnd</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1711</span><span class="w">    </span>
<span class="linenos">1712</span><span class="w">    </span><span class="c">! Determine number of obs</span>
<span class="linenos">1713</span><span class="w">    </span><span class="n">maxnumHeaders</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1714</span><span class="w">    </span><span class="k">call </span><span class="n">obs_set_current_header_list</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="s1">&#39;CH&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1715</span><span class="w">    </span><span class="k">do</span>
<span class="linenos">1716</span><span class="k">      </span><span class="n">maxnumHeaders</span><span class="o">=</span><span class="n">maxnumHeaders</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1717</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obs_getHeaderIndex</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">1718</span><span class="k">    end do</span><span class="w"></span>
<span class="linenos">1719</span>
<span class="linenos">1720</span><span class="w">    </span><span class="c">! Loop over all header indices of the &#39;CH&#39; family:</span>
<span class="linenos">1721</span><span class="w">    </span>
<span class="linenos">1722</span><span class="w">    </span><span class="n">headerCount</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1723</span><span class="w">    </span><span class="k">call </span><span class="n">obs_set_current_header_list</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="s1">&#39;CH&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1724</span><span class="w">    </span><span class="n">HEADER</span><span class="p">:</span><span class="w"> </span><span class="k">do</span>
<span class="linenos">1725</span>
<span class="linenos">1726</span><span class="k">      </span><span class="n">headerCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">headerCount</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1727</span><span class="w">      </span><span class="n">headerIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_getHeaderIndex</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1728</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">headerIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">exit </span><span class="n">HEADER</span><span class="w"></span>
<span class="linenos">1729</span><span class="w">  </span>
<span class="linenos">1730</span><span class="w">      </span><span class="n">icodtyp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_ITY</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1731</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">icodtyp</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">codtyp_get_codtyp</span><span class="p">(</span><span class="s1">&#39;CHEMREMOTE&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1732</span><span class="w">        </span><span class="n">icodtyp</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">codtyp_get_codtyp</span><span class="p">(</span><span class="s1">&#39;CHEMINSITU&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">cycle </span><span class="n">HEADER</span><span class="w"></span>
<span class="linenos">1733</span><span class="w">      </span>
<span class="linenos">1734</span><span class="w">      </span><span class="n">stnid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_elem_c</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="s1">&#39;STID&#39;</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1735</span><span class="w">      </span><span class="n">bodyIndex_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_RLN</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1736</span><span class="w">      </span><span class="n">bodyIndex_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bodyIndex_start</span><span class="o">+</span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_NLV</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1737</span>
<span class="linenos">1738</span><span class="w">      </span><span class="c">! Set number of obs profile elements by removing count of BUFR_SCALE_EXPONENT elements</span>
<span class="linenos">1739</span><span class="w">      </span><span class="n">nobslev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_NLV</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w">  </span>
<span class="linenos">1740</span><span class="w">      </span><span class="k">do </span><span class="n">bodyIndex</span><span class="o">=</span><span class="n">bodyIndex_start</span><span class="p">,</span><span class="n">bodyIndex_end</span><span class="w"></span>
<span class="linenos">1741</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VNM</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1742</span><span class="w">          </span><span class="n">BUFR_SCALE_EXPONENT</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1743</span><span class="k">	  </span><span class="n">nobslev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nobslev</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1744</span><span class="w">	</span><span class="k">end if</span>
<span class="linenos">1745</span><span class="k">      end do</span><span class="w"></span>
<span class="linenos">1746</span>
<span class="linenos">1747</span><span class="w">      </span><span class="c">! varno is expected to be the same for all profile points where OBS_VNM value /= BUFR_SCALE_EXPONENT</span>
<span class="linenos">1748</span><span class="w">      </span><span class="k">do </span><span class="n">bodyIndex</span><span class="o">=</span><span class="n">bodyIndex_start</span><span class="p">,</span><span class="n">bodyIndex_end</span><span class="w"></span>
<span class="linenos">1749</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VNM</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1750</span><span class="w">	    </span><span class="o">/=</span><span class="w"> </span><span class="n">BUFR_SCALE_EXPONENT</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1751</span><span class="k">	     </span>
<span class="linenos">1752</span><span class="k">          </span><span class="n">varno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VNM</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1753</span><span class="w">          </span><span class="k">exit</span>
<span class="linenos">1754</span><span class="k">        end if</span>
<span class="linenos">1755</span><span class="k">      end do</span><span class="w"></span>
<span class="linenos">1756</span>
<span class="linenos">1757</span><span class="w">      </span><span class="c">! Allocate memory for remaining profile data not in obsoper</span>
<span class="linenos">1758</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">obs_col</span><span class="p">(</span><span class="n">nobslev</span><span class="p">),</span><span class="n">iass</span><span class="p">(</span><span class="n">nobslev</span><span class="p">),</span><span class="n">process_obs</span><span class="p">(</span><span class="n">nobslev</span><span class="p">),</span><span class="n">flag</span><span class="p">(</span><span class="n">nobslev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1759</span>
<span class="linenos">1760</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1761</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">nobslev</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(</span><span class="n">nobslev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1762</span>
<span class="linenos">1763</span><span class="w">      </span><span class="c">! Check to see if background error variances available</span>
<span class="linenos">1764</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1765</span><span class="k">        </span><span class="n">process_obs</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bcsc_StatsExistForVarName</span><span class="p">(</span><span class="n">vnl_varnameFromVarnum</span><span class="p">(</span><span class="n">varno</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1766</span><span class="w">			 </span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_CHM</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1767</span><span class="w">			 </span><span class="n">modelName</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1768</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1769</span><span class="w"> </span>
<span class="linenos">1770</span><span class="w">      </span><span class="c">! Prepare for checking if any processing is needed according to initial flag values     </span>
<span class="linenos">1771</span><span class="w">      </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1772</span><span class="w"> </span>
<span class="linenos">1773</span><span class="w">      </span><span class="k">do </span><span class="n">bodyIndex</span><span class="o">=</span><span class="n">bodyIndex_start</span><span class="p">,</span><span class="n">bodyIndex_end</span><span class="w"></span>
<span class="linenos">1774</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VNM</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1775</span><span class="w">	     </span><span class="o">/=</span><span class="w"> </span><span class="n">BUFR_SCALE_EXPONENT</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1776</span>
<span class="linenos">1777</span><span class="k">          </span><span class="n">obslevIndex</span><span class="o">=</span><span class="n">obslevIndex</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1778</span>
<span class="linenos">1779</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1780</span><span class="w">	    </span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_XTR</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="c">! indicates if obs extends outside model profile vertical range</span>
<span class="linenos">1781</span><span class="w">          </span><span class="n">iass</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_ASS</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="c">! indicates if obs is to be assimilated</span>
<span class="linenos">1782</span><span class="w">          </span><span class="n">flag</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_FLG</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="c">! observation integer flag</span>
<span class="linenos">1783</span><span class="w">               </span>
<span class="linenos">1784</span><span class="w">          </span><span class="c">! Indicates if this obs should be processed by oopc_obsoperators</span>
<span class="linenos">1785</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1786</span><span class="k">            </span><span class="n">process_obs</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1787</span><span class="w">	             </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">iass</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obs_assimilated</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1788</span><span class="w">	              </span><span class="n">process_obs</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1789</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">1790</span><span class="k">            </span><span class="n">process_obs</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1791</span><span class="w">	                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">iass</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obs_assimilated</span><span class="w"></span>
<span class="linenos">1792</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1793</span>
<span class="linenos">1794</span><span class="k">        end if</span>
<span class="linenos">1795</span><span class="k">      end do</span><span class="w"></span>
<span class="linenos">1796</span>
<span class="linenos">1797</span><span class="w">      </span><span class="c">! Initialize processing success flag</span>
<span class="linenos">1798</span><span class="w">      </span>
<span class="linenos">1799</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">process_obs</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nobslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1800</span><span class="w">      </span>
<span class="linenos">1801</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">all</span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">process_obs</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1802</span>
<span class="linenos">1803</span><span class="w">        </span><span class="c">! All observations in the profile flagged so can skip obs operator for current measurement</span>
<span class="linenos">1804</span>
<span class="linenos">1805</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1806</span><span class="k">          </span><span class="n">model_col</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="w"></span>
<span class="linenos">1807</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnl_varnameFromVarnum</span><span class="p">(</span><span class="n">varno</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1808</span><span class="w">	    </span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_CHM</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">),</span><span class="n">modelName</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1809</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">1810</span>
<span class="linenos">1811</span><span class="k">      else  </span>
<span class="linenos">1812</span>
<span class="linenos">1813</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1814</span><span class="w">          </span><span class="c">! Check if &quot;OmP error std dev&quot; is already available</span>
<span class="linenos">1815</span><span class="w">          </span><span class="k">call </span><span class="n">obs_set_current_body_list</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1816</span><span class="w">          </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1817</span><span class="w">          </span><span class="n">BODYINDEX1</span><span class="p">:</span><span class="w"> </span><span class="k">do </span><span class="n">bodyIndex</span><span class="o">=</span><span class="n">bodyIndex_start</span><span class="p">,</span><span class="n">bodyIndex_end</span><span class="w"></span>
<span class="linenos">1818</span><span class="w">	  </span>
<span class="linenos">1819</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VNM</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1820</span><span class="w">	        </span><span class="n">BUFR_SCALE_EXPONENT</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="linenos">1821</span><span class="k">		</span>
<span class="linenos">1822</span><span class="k">            </span><span class="n">obslevIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obslevIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span>
<span class="linenos">1823</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">process_obs</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1824</span><span class="k">              if</span><span class="w"> </span><span class="p">(</span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OMPE</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1825</span><span class="w">                </span><span class="c">! &quot;OmP error std dev&quot; is already available for this measurement.</span>
<span class="linenos">1826</span><span class="w">		</span><span class="c">! Go to the next measurement.</span>
<span class="linenos">1827</span><span class="w">                  </span>
<span class="linenos">1828</span><span class="w">                </span><span class="c">! TEMPORARY: First, estimate OBS_HPHT for storage in output files (in the event it is needed externally for</span>
<span class="linenos">1829</span><span class="w">                </span><span class="c">! other purposes (e.g. total column ozone bias correction and corresponding re-doing for marker settings)               </span>
<span class="linenos">1830</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OMPE</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1831</span><span class="w">		     </span><span class="mf">1.1d0</span><span class="o">*</span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OER</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1832</span>
<span class="linenos">1833</span><span class="k">                  </span><span class="n">zhbht</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OMPE</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1834</span><span class="w">		          </span><span class="o">-</span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OER</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1835</span><span class="w">                  </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_HPHT</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="n">zhbht</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1836</span><span class="w">                </span><span class="k">else</span>
<span class="linenos">1837</span><span class="k">                  call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_HPHT</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1838</span><span class="w">		       </span><span class="mf">0.5d0</span><span class="o">*</span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OER</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">1839</span><span class="w">                </span><span class="k">end if</span>
<span class="linenos">1840</span><span class="k">     </span>
<span class="linenos">1841</span><span class="k">                deallocate</span><span class="p">(</span><span class="n">process_obs</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">,</span><span class="n">iass</span><span class="p">,</span><span class="n">obs_col</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1842</span><span class="w">                  </span>
<span class="linenos">1843</span><span class="w">                </span><span class="k">cycle </span><span class="n">HEADER</span><span class="w"></span>
<span class="linenos">1844</span><span class="w">              </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1845</span><span class="w">                </span><span class="c">! Proceed with the calc of sqrt(diag(HBHT))</span>
<span class="linenos">1846</span><span class="w">                </span><span class="k">exit </span><span class="n">BODYINDEX1</span><span class="w"></span>
<span class="linenos">1847</span><span class="w">              </span><span class="k">end if</span>
<span class="linenos">1848</span><span class="k">            end if</span>
<span class="linenos">1849</span><span class="k">          end do </span><span class="n">BODYINDEX1</span><span class="w"></span>
<span class="linenos">1850</span><span class="w">        </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1851</span>
<span class="linenos">1852</span><span class="w">        </span><span class="c">! Initialize obsoper variables and allocate arrays        </span>
<span class="linenos">1853</span><span class="w">	</span><span class="k">call </span><span class="n">oopc_obsoperInit</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="n">columnTrl</span><span class="p">,</span><span class="n">nlev_bkgrnd</span><span class="p">,</span><span class="n">nobslev</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="n">varno</span><span class="p">,</span><span class="n">stnid</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1854</span><span class="w"> </span>
<span class="linenos">1855</span><span class="w">        </span><span class="c">! Initialize model_col, dependent on kmode. Used for input for kmode=0,2, output for kmode=3.</span>
<span class="linenos">1856</span><span class="w">        </span><span class="c">! model_col represents for kmode 0) the horizontally interpolated background H_horiz(x_b)</span>
<span class="linenos">1857</span><span class="w">        </span><span class="c">!                                1) not used</span>
<span class="linenos">1858</span><span class="w">        </span><span class="c">!                                2) the analysis increment H_horiz dx</span>
<span class="linenos">1859</span><span class="w">        </span><span class="c">!                                3) the result of applying the adjoint of H_vert </span>
<span class="linenos">1860</span>
<span class="linenos">1861</span><span class="w">        </span><span class="k">select case</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1862</span><span class="w">        </span><span class="k">case</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1863</span><span class="w">          </span><span class="n">model_col</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="w"></span>
<span class="linenos">1864</span><span class="w">        </span><span class="k">case</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1865</span><span class="w">          </span><span class="k">do </span><span class="n">modlevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nlev_inc</span><span class="w"></span>
<span class="linenos">1866</span><span class="w">            </span><span class="n">model_col</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_getElem</span><span class="p">(</span><span class="n">columnAnlInc_opt</span><span class="p">,</span><span class="n">modlevIndex</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1867</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">1868</span><span class="k">        case</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1869</span><span class="w">          </span><span class="n">model_col</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="w"></span>
<span class="linenos">1870</span><span class="w">        </span><span class="k">end select</span><span class="w"></span>
<span class="linenos">1871</span><span class="w">               </span>
<span class="linenos">1872</span><span class="w">        </span><span class="c">! Loop over all body indices (profile elements) to acquire remaining data</span>
<span class="linenos">1873</span><span class="w">      </span>
<span class="linenos">1874</span><span class="w">        </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1875</span><span class="w">        </span><span class="k">call </span><span class="n">obs_set_current_body_list</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1876</span><span class="w">        </span><span class="n">BODY1</span><span class="p">:</span><span class="w"> </span><span class="k">do</span>
<span class="linenos">1877</span>
<span class="linenos">1878</span><span class="k">          </span><span class="n">bodyIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_getBodyIndex</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1879</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bodyIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">exit </span><span class="n">BODY1</span><span class="w"></span>
<span class="linenos">1880</span><span class="w">            </span>
<span class="linenos">1881</span><span class="w">          </span><span class="c">! Get position in profile and skip over BUFR_SCALE_EXPONENT elements</span>
<span class="linenos">1882</span>
<span class="linenos">1883</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VNM</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1884</span><span class="w">	      </span><span class="n">BUFR_SCALE_EXPONENT</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1885</span><span class="k">	      </span>
<span class="linenos">1886</span><span class="k">            </span><span class="n">obslevIndex</span><span class="o">=</span><span class="n">obslevIndex</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1887</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">1888</span><span class="k">            cycle </span><span class="n">BODY1</span><span class="w"></span>
<span class="linenos">1889</span><span class="w">          </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1890</span>
<span class="linenos">1891</span><span class="w">          </span><span class="c">! Get vertical coordinate data. Valid for point data values in profiles.</span>
<span class="linenos">1892</span><span class="w">          </span><span class="c">! For layer data values, vertical coordinate data will instead be assigned within oopc_obsoperators.</span>
<span class="linenos">1893</span>
<span class="linenos">1894</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1895</span><span class="w">	    </span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_PPP</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1896</span>
<span class="linenos">1897</span><span class="w">          </span><span class="c">! Get normalized increment</span>
<span class="linenos">1898</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1899</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">iass</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1900</span><span class="k">              </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_WORK</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1901</span><span class="w">            </span><span class="k">else</span>
<span class="linenos">1902</span><span class="k">              </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="w"></span>
<span class="linenos">1903</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos">1904</span><span class="k">          end if</span><span class="w"></span>
<span class="linenos">1905</span>
<span class="linenos">1906</span><span class="w">          </span><span class="c">! Get obs estimate from trial field (if kmode&gt;1)</span>
<span class="linenos">1907</span><span class="w">            </span>
<span class="linenos">1908</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1909</span><span class="k">            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">obsSpaceTrial</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos">1910</span><span class="w">          </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1911</span><span class="w">            </span><span class="c">! Store for use by TL and AD of non-linear operators</span>
<span class="linenos">1912</span><span class="w">            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">obsSpaceTrial</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1913</span><span class="w">	      </span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VAR</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1914</span><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OMP</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1915</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">1916</span><span class="k">            </span>
<span class="linenos">1917</span><span class="k">        end do </span><span class="n">BODY1</span><span class="w"></span>
<span class="linenos">1918</span><span class="w">      </span>
<span class="linenos">1919</span><span class="w">        </span><span class="c">! Apply observation operator. model_col,obs_col are the inputs/outputs in model,observation</span>
<span class="linenos">1920</span><span class="w">        </span><span class="c">! space, respectively. Other required inputs are in obsoper. Input/output is as follows:</span>
<span class="linenos">1921</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">1922</span><span class="w">        </span><span class="c">!    kmode      model_col      obs_col</span>
<span class="linenos">1923</span><span class="w">        </span><span class="c">!    -----      ---------      -------</span>
<span class="linenos">1924</span><span class="w">        </span><span class="c">!      0           in            out</span>
<span class="linenos">1925</span><span class="w">        </span><span class="c">!      1         not used        out</span>
<span class="linenos">1926</span><span class="w">        </span><span class="c">!      2           in            out</span>
<span class="linenos">1927</span><span class="w">        </span><span class="c">!      3           out           in</span>
<span class="linenos">1928</span>
<span class="linenos">1929</span><span class="w">        </span><span class="k">call </span><span class="n">oopc_obsoperators</span><span class="p">(</span><span class="n">model_col</span><span class="p">,</span><span class="n">obs_col</span><span class="p">,</span><span class="n">maxnumHeaders</span><span class="p">,</span><span class="n">headerCount</span><span class="p">,</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1930</span>
<span class="linenos">1931</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1932</span>
<span class="linenos">1933</span><span class="w">      </span><span class="c">! Output results</span>
<span class="linenos">1934</span><span class="w">      </span>
<span class="linenos">1935</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1936</span><span class="w">        </span><span class="c">! Store H^T * R^-1 (OmP-Hdx) in columnInc</span>
<span class="linenos">1937</span><span class="w">                     </span>
<span class="linenos">1938</span><span class="w">        </span><span class="n">col</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">col_getColumn</span><span class="p">(</span><span class="n">columnAnlInc_opt</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1939</span><span class="w">        </span><span class="n">col</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_bkgrnd</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_col</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nlev_bkgrnd</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1940</span>
<span class="linenos">1941</span><span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">1942</span><span class="w">        </span><span class="c">! Store results in obsSpaceData</span>
<span class="linenos">1943</span>
<span class="linenos">1944</span><span class="w">        </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">1945</span><span class="w">        </span><span class="k">call </span><span class="n">obs_set_current_body_list</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1946</span><span class="w">        </span><span class="n">BODY2</span><span class="p">:</span><span class="w"> </span><span class="k">do</span>
<span class="linenos">1947</span><span class="k">          </span><span class="n">bodyIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_getBodyIndex</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1948</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bodyIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">exit </span><span class="n">BODY2</span><span class="w"></span>
<span class="linenos">1949</span>
<span class="linenos">1950</span><span class="w">          </span><span class="c">! Get position in profile and skip over BUFR_SCALE_EXPONENT elements</span>
<span class="linenos">1951</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VNM</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1952</span><span class="w">	      </span><span class="n">BUFR_SCALE_EXPONENT</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1953</span><span class="k">	      </span>
<span class="linenos">1954</span><span class="k">            </span><span class="n">obslevIndex</span><span class="o">=</span><span class="n">obslevIndex</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">1955</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">1956</span><span class="k">            cycle </span><span class="n">BODY2</span><span class="w"></span>
<span class="linenos">1957</span><span class="w">          </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1958</span>
<span class="linenos">1959</span><span class="w">          </span><span class="c">! Check for success in calculations</span>
<span class="linenos">1960</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">process_obs</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1961</span><span class="w">            </span><span class="c">! Observation was flagged within this call of oopc_CHobsoperators</span>
<span class="linenos">1962</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_ASS</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="n">obs_notAssimilated</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1963</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OMP</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="mf">0.0D0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1964</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OMA</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="mf">0.0D0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1965</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_HPHT</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="mf">0.0D0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1966</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_WORK</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="mf">0.0D0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1967</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_FLG</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">1968</span><span class="w">	         </span><span class="nb">ibset</span><span class="p">(</span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_FLG</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">),</span><span class="mi">9</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">1969</span><span class="w">            </span><span class="k">cycle </span><span class="n">BODY2</span><span class="w"></span>
<span class="linenos">1970</span><span class="w">          </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">iass</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1971</span><span class="w">            </span><span class="c">! Observation was flagged previous to this call of oopc_CHobsoperators</span>
<span class="linenos">1972</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_ASS</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="n">obs_notAssimilated</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1973</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OMP</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="mf">0.0D0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1974</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OMA</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="mf">0.0D0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1975</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_HPHT</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="mf">0.0D0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1976</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_WORK</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="mf">0.0D0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1977</span><span class="w">            </span><span class="k">cycle </span><span class="n">BODY2</span><span class="w"></span>
<span class="linenos">1978</span><span class="w">          </span><span class="k">else if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">process_obs</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">1979</span><span class="k">            call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_HPHT</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="mf">0.0D0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1980</span><span class="w">            </span><span class="k">cycle </span><span class="n">BODY2</span><span class="w"></span>
<span class="linenos">1981</span><span class="w">          </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">1982</span>
<span class="linenos">1983</span><span class="w">          </span><span class="c">! Store result in appropriate location in obsSpaceData</span>
<span class="linenos">1984</span><span class="w">          </span><span class="k">select case</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1985</span><span class="w">          </span><span class="k">case</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1986</span><span class="w">            </span>
<span class="linenos">1987</span><span class="w">            </span><span class="c">! Store OmP in OBS_OMP and add to Jo(x_background) of CH.   </span>
<span class="linenos">1988</span><span class="w">                           </span>
<span class="linenos">1989</span><span class="w">            </span><span class="n">zomp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VAR</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1990</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">destObsColumn</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="n">zomp</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1991</span>
<span class="linenos">1992</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_diagnOnly</span><span class="p">(</span><span class="s1">&#39;CH&#39;</span><span class="p">,</span><span class="n">stnid</span><span class="p">,</span><span class="n">varno</span><span class="p">,</span><span class="n">nobslev</span><span class="p">,</span><span class="n">flag</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1993</span><span class="w">              </span><span class="c">! Observation is for diagnostics and is not to be assimilated</span>
<span class="linenos">1994</span><span class="w">              </span><span class="k">call </span><span class="n">obs_bodySet_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_ASS</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="n">obs_notAssimilated</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1995</span><span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">jobs_opt</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">iass</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">1996</span><span class="w">              </span><span class="c">! Add to Jo contribution (factor of 0.5 to be applied outside report loop)</span>
<span class="linenos">1997</span><span class="w">              </span><span class="n">zinc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zomp</span><span class="o">/</span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OER</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">1998</span><span class="w">              </span><span class="n">jobs_opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jobs_opt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">zinc</span><span class="o">**</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">1999</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos">2000</span>
<span class="linenos">2001</span><span class="k">          case</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2002</span><span class="w">            </span>
<span class="linenos">2003</span><span class="w">            </span><span class="c">! Background error standard deviations in</span>
<span class="linenos">2004</span><span class="w">            </span><span class="c">! observation space, sqrt(diag(H*B_static*H^T)), </span>
<span class="linenos">2005</span><span class="w">            </span><span class="c">! saved in OBS_HPHT of obsSpaceData.</span>
<span class="linenos">2006</span><span class="w">            </span><span class="c">! Resulting OmP error std dev estimate saved in OBS_OMPE</span>
<span class="linenos">2007</span>
<span class="linenos">2008</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_HPHT</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2009</span><span class="w">               </span>
<span class="linenos">2010</span><span class="w">            </span><span class="n">zoer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_bodyElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OER</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2011</span><span class="w">            </span><span class="n">zomp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">*</span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">zoer</span><span class="o">*</span><span class="n">zoer</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2012</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_OMPE</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="n">zomp</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2013</span>
<span class="linenos">2014</span><span class="w">          </span><span class="k">case</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2015</span><span class="w">            </span>
<span class="linenos">2016</span><span class="w">            </span><span class="c">!   Store Hdx in OBS_WORK of obsSpaceData               </span>
<span class="linenos">2017</span><span class="w">            </span><span class="k">call </span><span class="n">obs_bodySet_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_WORK</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">,</span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2018</span><span class="w">          </span><span class="k">end select</span>
<span class="linenos">2019</span>
<span class="linenos">2020</span><span class="k">        end do </span><span class="n">BODY2</span><span class="w"></span>
<span class="linenos">2021</span>
<span class="linenos">2022</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2023</span>
<span class="linenos">2024</span><span class="w">      </span><span class="c">! Deallocate profile data</span>
<span class="linenos">2025</span><span class="w">      </span><span class="k">deallocate</span><span class="p">(</span><span class="n">process_obs</span><span class="p">,</span><span class="n">iass</span><span class="p">,</span><span class="n">obs_col</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2026</span><span class="w">      </span><span class="k">call </span><span class="n">oopc_obsoper_dealloc</span><span class="w"></span>
<span class="linenos">2027</span><span class="w">  </span>
<span class="linenos">2028</span><span class="w">    </span><span class="k">end do </span><span class="n">HEADER</span><span class="w"></span>
<span class="linenos">2029</span>
<span class="linenos">2030</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2031</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">hu</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2032</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">model_col</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2033</span><span class="w">  </span>
<span class="linenos">2034</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">jobs_opt</span><span class="p">))</span><span class="w"> </span><span class="n">jobs_opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5d0</span><span class="o">*</span><span class="n">jobs_opt</span><span class="w"></span>
<span class="linenos">2035</span><span class="w">    </span>
<span class="linenos">2036</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_CHobsoperators</span><span class="w"></span>
<span class="linenos">2037</span>
<span class="linenos">2038</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2039</span><span class="w">  </span><span class="c">! oopc_obsoperInit</span>
<span class="linenos">2040</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2041</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_obsoperInit</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="n">columnTrl</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2042</span><span class="w">                              </span><span class="n">nmodlev</span><span class="p">,</span><span class="n">nobslev</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="n">varno</span><span class="p">,</span><span class="n">stnid</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2043</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2044</span><span class="w">    </span><span class="c">!:Purpose: To initialize struct_oopc_obsoperators variables and to allocate</span>
<span class="linenos">2045</span><span class="w">    </span><span class="c">!          arrays.</span>
<span class="linenos">2046</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2047</span><span class="w">    </span><span class="c">!:Comments: </span>
<span class="linenos">2048</span><span class="w">    </span><span class="c">!           - Allocation of arrays that are dependent on only nlev_bkgrd</span>
<span class="linenos">2049</span><span class="w">    </span><span class="c">!             (nmodlev) have been moved outside this subroutine so that they</span>
<span class="linenos">2050</span><span class="w">    </span><span class="c">!             are allocated only once.</span>
<span class="linenos">2051</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2052</span><span class="w">    </span><span class="c">!:Arguments:</span>
<span class="linenos">2053</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2054</span><span class="w">    </span><span class="c">!     :columnTrl:  Column of x_background interpolated to observation</span>
<span class="linenos">2055</span><span class="w">    </span><span class="c">!                  location. Can have the same vertical levels as the</span>
<span class="linenos">2056</span><span class="w">    </span><span class="c">!                  trial field (columnTrl) or as the increment field</span>
<span class="linenos">2057</span><span class="w">    </span><span class="c">!                  (columnAnlInc)</span>
<span class="linenos">2058</span><span class="w">    </span><span class="c">!     :kmode:      Mode of observation operator  </span>
<span class="linenos">2059</span><span class="w">    </span><span class="c">!                  - 0 for non-linear/linear model in assimilation (all models</span>
<span class="linenos">2060</span><span class="w">    </span><span class="c">!                    included are currently linear)</span>
<span class="linenos">2061</span><span class="w">    </span><span class="c">!                  - 1 for determination of sqrt(diag(H*B*H^T))</span>
<span class="linenos">2062</span><span class="w">    </span><span class="c">!                  - 2 for tangent linear model</span>
<span class="linenos">2063</span><span class="w">    </span><span class="c">!                  - 3 for adjoint model </span>
<span class="linenos">2064</span><span class="w">    </span><span class="c">!    </span>
<span class="linenos">2065</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">2066</span>
<span class="linenos">2067</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">2068</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_obs</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obsSpaceData</span><span class="w"> </span><span class="c">! Obs-Space Data object</span>
<span class="linenos">2069</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">headerIndex</span><span class="w"> </span><span class="c">! Measurement index in obsSpaceData</span>
<span class="linenos">2070</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_columnData</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">columnTrl</span><span class="w"></span>
<span class="linenos">2071</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nmodlev</span><span class="w"> </span><span class="c">! Number of background field (model) levels</span>
<span class="linenos">2072</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nobslev</span><span class="w"> </span><span class="c">! Number of obs elements (see oopc_obsoper_proceed)</span>
<span class="linenos">2073</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kmode</span><span class="w">   </span><span class="c">! Mode of observation operator</span>
<span class="linenos">2074</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varno</span><span class="w">   </span><span class="c">! obs unit BUFR number</span>
<span class="linenos">2075</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">stnid</span><span class="w"> </span><span class="c">! Station ID</span>
<span class="linenos">2076</span>
<span class="linenos">2077</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">2078</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bodyIndex</span><span class="w"> </span><span class="c">! Measurement element index in obsSpaceDate (see oopc_obsoper_proceed)</span>
<span class="linenos">2079</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">jl</span><span class="p">,</span><span class="n">nmodlev_uv</span><span class="w"></span>
<span class="linenos">2080</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">col_height_ptr</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2081</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uu</span><span class="p">(:),</span><span class="n">vv</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2082</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;TH&#39;</span><span class="w"></span>
<span class="linenos">2083</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">checkID</span><span class="w"></span>
<span class="linenos">2084</span>
<span class="linenos">2085</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nmodlev</span><span class="w"></span>
<span class="linenos">2086</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos">2087</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">obs_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">headerIndex</span><span class="w"></span>
<span class="linenos">2088</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varno</span><span class="w"></span>
<span class="linenos">2089</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stnid</span><span class="w"></span>
<span class="linenos">2090</span>
<span class="linenos">2091</span><span class="w">    </span><span class="c">! Get obs space info that are part of the profile header</span>
<span class="linenos">2092</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">date</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_DAT</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2093</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">hhmm</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_ETM</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2094</span><span class="w">    </span><span class="c">! Constituent identifyer following local version of WMO GRIB Table 08046 (similar to BUFR Table 08043)</span>
<span class="linenos">2095</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_CHM</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2096</span><span class="w">    </span>
<span class="linenos">2097</span><span class="w">    </span><span class="c">! Check if constituent id is recognized (function will abort if not recognized)</span>
<span class="linenos">2098</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7000</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2099</span><span class="k">      </span><span class="n">checkID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnl_varMassFromVarnum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2100</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2101</span>
<span class="linenos">2102</span><span class="k">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_headElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_LAT</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2103</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_headElem_r</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_LON</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2104</span>
<span class="linenos">2105</span><span class="w">    </span><span class="c">! Body info that we only need for first point in the profile</span>
<span class="linenos">2106</span><span class="w">    </span><span class="n">bodyIndex</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">obs_headElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_RLN</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2107</span><span class="w">    </span><span class="c">! Index of vertical coordinate type    </span>
<span class="linenos">2108</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VCO</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">)</span><span class="w">  </span>
<span class="linenos">2109</span><span class="w">    </span><span class="c">! Model field name (NOMVAR value)</span>
<span class="linenos">2110</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnl_varnameFromVarnum</span><span class="p">(</span><span class="n">obs_bodyElem_i</span><span class="p">(</span><span class="n">obsSpaceData</span><span class="p">,</span><span class="n">OBS_VNM</span><span class="p">,</span><span class="n">bodyIndex</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">,</span><span class="n">modelName</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2111</span>
<span class="linenos">2112</span><span class="w">    </span><span class="c">! Allocate arrays</span>
<span class="linenos">2113</span>
<span class="linenos">2114</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="p">(</span><span class="n">nobslev</span><span class="p">))</span><span class="w">       </span><span class="c">! Reference vertical levels</span>
<span class="linenos">2115</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">nobslev</span><span class="p">))</span><span class="w">    </span><span class="c">! Layer tops for layer measurements</span>
<span class="linenos">2116</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">nobslev</span><span class="p">))</span><span class="w"> </span><span class="c">! Layer bottoms for layer measurements</span>
<span class="linenos">2117</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">nobslev</span><span class="p">))</span><span class="w">  </span><span class="c">! Index of highest model level (lowest index) involved with obs element</span>
<span class="linenos">2118</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">nobslev</span><span class="p">))</span><span class="w">  </span><span class="c">! Index of lowest model level (highest index) involved with obs element</span>
<span class="linenos">2119</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obsSpaceTrial</span><span class="p">(</span><span class="n">nobslev</span><span class="p">))</span><span class="w">    </span><span class="c">! Obs estimate from trial field </span>
<span class="linenos">2120</span>
<span class="linenos">2121</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">nobslev</span><span class="p">,</span><span class="n">nmodlev</span><span class="p">))</span><span class="w">   </span><span class="c">! Local model operator H (excluding conversion constants and horizontal interpolation)</span>
<span class="linenos">2122</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">nobslev</span><span class="p">,</span><span class="n">nmodlev</span><span class="p">))</span><span class="w">  </span><span class="c">! Part of zh that excludes aspects related to vertical resolution</span>
<span class="linenos">2123</span>
<span class="linenos">2124</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(:,:)</span><span class="o">=</span><span class="mf">0.0D0</span><span class="w"></span>
<span class="linenos">2125</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(:,:)</span><span class="o">=</span><span class="mf">0.0D0</span><span class="w"></span>
<span class="linenos">2126</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(:)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2127</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(:)</span><span class="o">=</span><span class="n">nmodlev</span><span class="w"></span>
<span class="linenos">2128</span><span class="w">    </span>
<span class="linenos">2129</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">col_varExist</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="s1">&#39;TT&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2130</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_required_field</span><span class="p">(</span><span class="s1">&#39;TT&#39;</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2131</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;chem_opsoper_init: TT required for BUFR code &quot;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2132</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2133</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">2134</span>
<span class="linenos">2135</span><span class="w">    </span><span class="c">! Get background profiles at observation location</span>
<span class="linenos">2136</span><span class="w">    </span><span class="k">do </span><span class="n">jl</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nmodlev</span><span class="w"></span>
<span class="linenos">2137</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">jl</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_getPressure</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="n">jl</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="n">varLevel</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2138</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">(</span><span class="n">jl</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_getElem</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="n">jl</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2139</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="p">(</span><span class="n">jl</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_getElem</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="n">jl</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="s1">&#39;TT&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2140</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">2141</span>
<span class="linenos">2142</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">col_varExist</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="s1">&#39;TT&#39;</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">col_varExist</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="s1">&#39;HU&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2143</span><span class="w">        </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">col_varExist</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="s1">&#39;P0&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w">   </span>
<span class="linenos">2144</span><span class="w">        </span>
<span class="linenos">2145</span><span class="w">      </span><span class="c">! Height would have been generated in the call to sugomobs. </span>
<span class="linenos">2146</span><span class="w">      </span><span class="c">! Convert from geopotential to geopotential height.</span>
<span class="linenos">2147</span><span class="w">      </span><span class="n">col_height_ptr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">col_getColumn</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="s1">&#39;Z_T&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2148</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_height_ptr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2149</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2150</span><span class="k">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="w"></span>
<span class="linenos">2151</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2152</span>
<span class="linenos">2153</span><span class="w">    </span><span class="c">! Get specific humidity if available</span>
<span class="linenos">2154</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">col_varExist</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="s1">&#39;HU&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2155</span><span class="k">      do </span><span class="n">jl</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nmodlev</span><span class="w"></span>
<span class="linenos">2156</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">hu</span><span class="p">(</span><span class="n">jl</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_getElem</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="n">jl</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="s1">&#39;HU&#39;</span><span class="p">)</span><span class="w">  </span><span class="c">! lnq was replaced by q</span>
<span class="linenos">2157</span><span class="w">      </span><span class="k">end do</span>
<span class="linenos">2158</span><span class="k">    else</span>
<span class="linenos">2159</span><span class="k">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">hu</span><span class="p">(:)</span><span class="o">=-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2160</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2161</span><span class="w">    </span>
<span class="linenos">2162</span><span class="w">    </span><span class="c">! If applicable, get column upper boundaries for use with total column </span>
<span class="linenos">2163</span><span class="w">    </span><span class="c">! measurements when the related increment profile is to be restricted to </span>
<span class="linenos">2164</span><span class="w">    </span><span class="c">! the lower atmosphere (e.g. troposphere or PBL; when tropo_bound&gt;0 )</span>
<span class="linenos">2165</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nobslev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2166</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2167</span><span class="k">          </span>
<span class="linenos">2168</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">col_varExist</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="s1">&#39;HU&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2169</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">col_varExist</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="s1">&#39;UU&#39;</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">col_varExist</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="s1">&#39;VV&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2170</span><span class="k">            </span><span class="n">nmodlev_uv</span><span class="o">=</span><span class="n">col_getNumLev</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="s1">&#39;MM&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2171</span><span class="w">            </span><span class="k">allocate</span><span class="p">(</span><span class="n">uu</span><span class="p">(</span><span class="n">nmodlev_uv</span><span class="p">),</span><span class="n">vv</span><span class="p">(</span><span class="n">nmodlev_uv</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2172</span><span class="w">            </span><span class="k">do </span><span class="n">jl</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nmodlev_uv</span><span class="w"></span>
<span class="linenos">2173</span><span class="w">              </span><span class="n">uu</span><span class="p">(</span><span class="n">jl</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_getElem</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="n">jl</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="s1">&#39;UU&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2174</span><span class="w">              </span><span class="n">vv</span><span class="p">(</span><span class="n">jl</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col_getElem</span><span class="p">(</span><span class="n">columnTrl</span><span class="p">,</span><span class="n">jl</span><span class="p">,</span><span class="n">headerIndex</span><span class="p">,</span><span class="s1">&#39;VV&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2175</span><span class="w">            </span><span class="k">end do</span>
<span class="linenos">2176</span><span class="k">            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_getColBoundary</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">,&amp;</span><span class="w"></span>
<span class="linenos">2177</span><span class="w">	      </span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2178</span><span class="w">	      </span><span class="n">hu_opt</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">hu</span><span class="p">,</span><span class="n">uu_opt</span><span class="o">=</span><span class="n">uu</span><span class="p">,</span><span class="n">vv_opt</span><span class="o">=</span><span class="n">vv</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2179</span><span class="w">            </span><span class="k">deallocate</span><span class="p">(</span><span class="n">uu</span><span class="p">,</span><span class="n">vv</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2180</span><span class="w">          </span><span class="k">else </span>
<span class="linenos">2181</span><span class="k">            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_getColBoundary</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">,</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">,</span><span class="n">hu_opt</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">hu</span><span class="p">)</span><span class="w">   </span>
<span class="linenos">2182</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">2183</span>
<span class="linenos">2184</span><span class="k">        else</span>
<span class="linenos">2185</span><span class="k">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_getColBoundary</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">,</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2186</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">2187</span>
<span class="linenos">2188</span><span class="k">        call </span><span class="n">oopc_addColBoundary</span><span class="p">(</span><span class="n">headerIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="p">)</span><span class="w">  </span><span class="c">! save boundary for kmode&gt;0 calls using headerIndex</span>
<span class="linenos">2189</span>
<span class="linenos">2190</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2191</span><span class="k">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_retrieveColBoundary</span><span class="p">(</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2192</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2193</span><span class="k">    else</span>
<span class="linenos">2194</span><span class="k">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="w"></span>
<span class="linenos">2195</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2196</span>
<span class="linenos">2197</span><span class="k">  end subroutine </span><span class="n">oopc_obsoperInit</span><span class="w"></span>
<span class="linenos">2198</span>
<span class="linenos">2199</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2200</span><span class="w">  </span><span class="c">! oopc_obsoper_dealloc</span>
<span class="linenos">2201</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2202</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_obsoper_dealloc</span><span class="w"></span>
<span class="linenos">2203</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2204</span><span class="w">    </span><span class="c">!:Purpose: To deallocate arrays for struct_oopc_obsoperators.</span>
<span class="linenos">2205</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2206</span><span class="w">    </span><span class="c">!:Comments:</span>
<span class="linenos">2207</span><span class="w">    </span><span class="c">!           - Deallocation of arrays that are dependent on only nmodlev have</span>
<span class="linenos">2208</span><span class="w">    </span><span class="c">!             been moved outside this subroutine so that they are</span>
<span class="linenos">2209</span><span class="w">    </span><span class="c">!             deallocated only once.</span>
<span class="linenos">2210</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2211</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">2212</span>
<span class="linenos">2213</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">2214</span><span class="w">    </span><span class="c">! type(struct_oopc_obsoperators), intent(inout) :: obsoper ! (see module oopc_obsoper) </span>
<span class="linenos">2215</span>
<span class="linenos">2216</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="p">))</span><span class="w">       </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2217</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">))</span><span class="w">    </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2218</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2219</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">))</span><span class="w">           </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2220</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">))</span><span class="w">          </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2221</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">))</span><span class="w">  </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2222</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">))</span><span class="w">  </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2223</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obsSpaceTrial</span><span class="p">))</span><span class="w">  </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obsSpaceTrial</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2224</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">))</span><span class="w">      </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2225</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">))</span><span class="w">         </span><span class="k">deallocate</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2226</span>
<span class="linenos">2227</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_obsoper_dealloc</span><span class="w"></span>
<span class="linenos">2228</span><span class="w">    </span>
<span class="linenos">2229</span><span class="w">  </span><span class="c">!---------------------- Routines for observation operators ----------------</span>
<span class="linenos">2230</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2231</span>
<span class="linenos">2232</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2233</span><span class="w">  </span><span class="c">! oopc_obsoperators</span>
<span class="linenos">2234</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2235</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_obsoperators</span><span class="p">(</span><span class="n">model_col</span><span class="p">,</span><span class="n">obs_col</span><span class="p">,</span><span class="n">maxnumHeaders</span><span class="p">,</span><span class="n">headerCount</span><span class="p">,</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2236</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2237</span><span class="w">    </span><span class="c">!:Purpose: To apply observation operator for indicated observation data and</span>
<span class="linenos">2238</span><span class="w">    </span><span class="c">!          condition.</span>
<span class="linenos">2239</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2240</span><span class="w">    </span><span class="c">!:Arguments:</span>
<span class="linenos">2241</span><span class="w">    </span><span class="c">!     :kmode: mode of observation operator</span>
<span class="linenos">2242</span><span class="w">    </span><span class="c">!               0) general (potentially non-linear) simulation operator</span>
<span class="linenos">2243</span><span class="w">    </span><span class="c">!               1) determination of sqrt(diag(H*B*H^T))</span>
<span class="linenos">2244</span><span class="w">    </span><span class="c">!               2) tangent linear operator</span>
<span class="linenos">2245</span><span class="w">    </span><span class="c">!               3) linear adjoint operator</span>
<span class="linenos">2246</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2247</span><span class="w">    </span><span class="c">!     :obs_col:   Observation space input/output profile</span>
<span class="linenos">2248</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2249</span><span class="w">    </span><span class="c">!                  +------+------+------+------+------+------+------+</span>
<span class="linenos">2250</span><span class="w">    </span><span class="c">!                  |kmode |    input/output    | profile            |</span>
<span class="linenos">2251</span><span class="w">    </span><span class="c">!                  +======+====================+====================+</span>
<span class="linenos">2252</span><span class="w">    </span><span class="c">!                  |  0   |        out         | H(xb)              |</span>
<span class="linenos">2253</span><span class="w">    </span><span class="c">!                  +------+--------------------+--------------------+</span>
<span class="linenos">2254</span><span class="w">    </span><span class="c">!                  |  1   |        out         | sqrt(diag(H*B*H^T))|</span>
<span class="linenos">2255</span><span class="w">    </span><span class="c">!                  +------+--------------------+--------------------+</span>
<span class="linenos">2256</span><span class="w">    </span><span class="c">!                  |  2   |        out         | H*dx               |</span>
<span class="linenos">2257</span><span class="w">    </span><span class="c">!                  +------+--------------------+--------------------+</span>
<span class="linenos">2258</span><span class="w">    </span><span class="c">!                  |  3   |        in          | R**-1 (Hdx-d)      |</span>
<span class="linenos">2259</span><span class="w">    </span><span class="c">!                  +------+--------------------+--------------------+</span>
<span class="linenos">2260</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2261</span><span class="w">    </span><span class="c">!     :model_col: Model space input/output profile</span>
<span class="linenos">2262</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2263</span><span class="w">    </span><span class="c">!                  +------+------+------+------+------+------+------+</span>
<span class="linenos">2264</span><span class="w">    </span><span class="c">!                  |kmode |   input/output     | profile            |</span>
<span class="linenos">2265</span><span class="w">    </span><span class="c">!                  +======+====================+====================+</span>
<span class="linenos">2266</span><span class="w">    </span><span class="c">!                  |  0   |       in           | xb                 |</span>
<span class="linenos">2267</span><span class="w">    </span><span class="c">!                  +------+--------------------+--------------------+</span>
<span class="linenos">2268</span><span class="w">    </span><span class="c">!                  |  1   |       not used     | not used           |</span>
<span class="linenos">2269</span><span class="w">    </span><span class="c">!                  +------+--------------------+--------------------+</span>
<span class="linenos">2270</span><span class="w">    </span><span class="c">!                  |  2   |       in           | dx at obs location |</span>
<span class="linenos">2271</span><span class="w">    </span><span class="c">!                  +------+--------------------+--------------------+</span>
<span class="linenos">2272</span><span class="w">    </span><span class="c">!                  |  3   |       out          | adjoint product    |</span>
<span class="linenos">2273</span><span class="w">    </span><span class="c">!                  |      |                    | H^T(...)           |</span>
<span class="linenos">2274</span><span class="w">    </span><span class="c">!                  +------+--------------------+--------------------+</span>
<span class="linenos">2275</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2276</span><span class="w">    </span><span class="c">!     :maxnumHeaders:  Total number of CH obs for this CPU</span>
<span class="linenos">2277</span><span class="w">    </span><span class="c">!     :headerCount:    Obs number up to maxnumHeaders</span>
<span class="linenos">2278</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2279</span><span class="w">    </span><span class="c">! Further changes required for generalization:</span>
<span class="linenos">2280</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2281</span><span class="w">    </span><span class="c">!  1) Add layer average operators.</span>
<span class="linenos">2282</span><span class="w">    </span><span class="c">!  2) Add AOD operators (summation over model layers).</span>
<span class="linenos">2283</span><span class="w">    </span><span class="c">!  3) Add option to include use of obs error correlation matrix for kmode=2,3 </span>
<span class="linenos">2284</span><span class="w">    </span><span class="c">!     (This may/will need to be done in oop_Hchm and oop_HTchm where the division </span>
<span class="linenos">2285</span><span class="w">    </span><span class="c">!      by stddev_obs is applied. A new routine will be needed for this</span>
<span class="linenos">2286</span><span class="w">    </span><span class="c">!      operation - and others for reading the correlation matrices similarly to the</span>
<span class="linenos">2287</span><span class="w">    </span><span class="c">!      averaging kernels.)</span>
<span class="linenos">2288</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2289</span><span class="w">    </span><span class="c">! Comments:</span>
<span class="linenos">2290</span><span class="w">    </span><span class="c">!      - When kmode=0, call from oopc_CHobsoperators passes model_col as a pointer to</span>
<span class="linenos">2291</span><span class="w">    </span><span class="c">!        obsoper%trial.</span>
<span class="linenos">2292</span><span class="w">    </span><span class="c">!      - Does not yet account for potential future applications of obs </span>
<span class="linenos">2293</span><span class="w">    </span><span class="c">!        vertical correlation matrices.</span>
<span class="linenos">2294</span><span class="w">    </span><span class="c">!      - Potential specification of background error std. dev. (fdeStddev(:,1:2)) and correlation matrices </span>
<span class="linenos">2295</span><span class="w">    </span><span class="c">!        for the ensemble-based and lam cases to/could be done when stats for these become in use with constituents.</span>
<span class="linenos">2296</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2297</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">2298</span>
<span class="linenos">2299</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">2300</span><span class="w">    </span><span class="c">! type(struct_oopc_obsoperators), intent(inout) :: obsoper ! (see module oopc_obsoper) </span>
<span class="linenos">2301</span>
<span class="linenos">2302</span><span class="w">    </span><span class="c">! I/O arguments: obs space variables</span>
<span class="linenos">2303</span><span class="w">    </span>
<span class="linenos">2304</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kmode</span><span class="p">,</span><span class="n">maxnumHeaders</span><span class="p">,</span><span class="n">headerCount</span><span class="w"></span>
<span class="linenos">2305</span>
<span class="linenos">2306</span><span class="w">    </span><span class="c">! I/O arguments: model space profile data and others</span>
<span class="linenos">2307</span>
<span class="linenos">2308</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">),</span><span class="w"> </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2309</span>
<span class="linenos">2310</span><span class="w">    </span><span class="c">! Locals: </span>
<span class="linenos">2311</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">successLocal</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2312</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zwork</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">),</span><span class="n">unit_conversion</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2313</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">temp_eff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2314</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">avg_kern</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">2315</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">modlevIndex</span><span class="p">,</span><span class="n">varIndex</span><span class="p">,</span><span class="n">nobslevOriginal</span><span class="p">,</span><span class="n">varnoOriginal</span><span class="w"></span>
<span class="linenos">2316</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">code_len</span><span class="o">=</span><span class="mi">90</span><span class="w"></span>
<span class="linenos">2317</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">code_len</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">code</span><span class="w">    </span><span class="c">! Must be at least as large as oopc_code_len</span>
<span class="linenos">2318</span><span class="w">     </span>
<span class="linenos">2319</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">code_len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">oss_obsdata_code_len</span><span class="p">())</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2320</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_obsoperators: Length of code string&#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2321</span><span class="w">                     </span><span class="s1">&#39; needs to be increased to &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2322</span><span class="w">	             </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">oss_obsdata_code_len</span><span class="p">())))</span><span class="w"></span>
<span class="linenos">2323</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2324</span><span class="w"> </span>
<span class="linenos">2325</span><span class="w">    </span><span class="c">! Determine if layer boundaries are assigned to this data source OR, for obsoper%nobslev = 1, </span>
<span class="linenos">2326</span><span class="w">    </span><span class="c">! if the number of observation operator levels differ (i.e. use of 1D averaging kernels) </span>
<span class="linenos">2327</span><span class="w">    </span><span class="c">! If so, obtain them for use in this routine. </span>
<span class="linenos">2328</span><span class="w">    </span><span class="c">! Routine provides obsoper%layerIdentified,</span>
<span class="linenos">2329</span><span class="w">    </span><span class="c">!                  obsoper%vlayertop(nobslev), </span>
<span class="linenos">2330</span><span class="w">    </span><span class="c">!                  obsoper%vlayerbottom(nobslev)</span>
<span class="linenos">2331</span><span class="w">    </span><span class="c">! and resets obsoper%nobslev, obsoper%obslev for alternative work vertical levels. </span>
<span class="linenos">2332</span><span class="w">    </span><span class="c">! The original obsoper%nobslev is saved as nobslevOriginal</span>
<span class="linenos">2333</span><span class="w"> </span>
<span class="linenos">2334</span><span class="w">    </span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos">2335</span><span class="w">    </span><span class="n">varnoOriginal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="w"></span>
<span class="linenos">2336</span><span class="w">    </span><span class="k">call </span><span class="n">oopc_getLevels</span><span class="w"></span>
<span class="linenos">2337</span>
<span class="linenos">2338</span><span class="w">    </span><span class="c">! Prepare observation operator</span>
<span class="linenos">2339</span><span class="w">  </span>
<span class="linenos">2340</span><span class="w">    </span><span class="k">call </span><span class="n">oopc_prepareOperator</span><span class="p">(</span><span class="n">model_col</span><span class="p">,</span><span class="n">avg_kern</span><span class="p">,</span><span class="n">nobslevOriginal</span><span class="p">,</span><span class="n">maxnumHeaders</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2341</span><span class="w">                              </span><span class="n">headerCount</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="n">unit_conversion</span><span class="p">,</span><span class="n">successLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2342</span>
<span class="linenos">2343</span><span class="w">    </span><span class="c">! Finalize required quantities depending on kmode</span>
<span class="linenos">2344</span><span class="w">   </span>
<span class="linenos">2345</span><span class="w">    </span><span class="k">select case</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2346</span>
<span class="linenos">2347</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2348</span>
<span class="linenos">2349</span><span class="w">      </span><span class="c">! Finalize non-linear/linear operator step</span>
<span class="linenos">2350</span><span class="w">     </span>
<span class="linenos">2351</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2352</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_checkType</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">stnids</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2353</span><span class="w">	                   </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="k">type</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">,</span><span class="s1">&#39;log&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2354</span><span class="k">          </span>
<span class="linenos">2355</span><span class="k">          </span><span class="n">zwork</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2356</span><span class="w">          </span><span class="k">do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos">2357</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">successLocal</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2358</span><span class="w">              </span><span class="n">zwork</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">log</span><span class="p">(</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2359</span><span class="w">	        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2360</span><span class="w">                </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="p">))</span><span class="w"></span>
<span class="linenos">2361</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">2362</span>
<span class="linenos">2363</span><span class="k">          do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2364</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2365</span><span class="k">              </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="nb">dot_product</span><span class="p">(</span><span class="n">avg_kern</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2366</span><span class="w">	                            </span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">),</span><span class="n">zwork</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2367</span><span class="w">            </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2368</span><span class="w">	    </span>
<span class="linenos">2369</span><span class="w">            </span><span class="c">! Add a priori contribution when provided</span>
<span class="linenos">2370</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2371</span><span class="k">	      </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2372</span><span class="w">	                             </span><span class="n">avg_kern</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2373</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos">2374</span><span class="k">	    </span>
<span class="linenos">2375</span><span class="k">            </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">exp</span><span class="p">(</span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2376</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">2377</span><span class="k">         </span>
<span class="linenos">2378</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2379</span><span class="w">	       </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2380</span><span class="k">	    </span>
<span class="linenos">2381</span><span class="k">            </span><span class="n">obs_col</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="w"> </span><span class="n">avg_kern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2382</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">obs_col</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">2383</span><span class="w">	  </span><span class="k">end if</span>
<span class="linenos">2384</span><span class="k">        else</span><span class="w"> </span>
<span class="linenos">2385</span>
<span class="linenos">2386</span><span class="w">          </span><span class="c">! Standard treatment for linear model</span>
<span class="linenos">2387</span><span class="w">            </span>
<span class="linenos">2388</span><span class="w">          </span><span class="k">do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2389</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2390</span><span class="k">              </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,&amp;</span><span class="w"></span>
<span class="linenos">2391</span><span class="w">	        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2392</span><span class="w">                </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2393</span><span class="w">            </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2394</span><span class="w">            </span><span class="c">! Add a priori contribution when provided</span>
<span class="linenos">2395</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2396</span><span class="k">              </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2397</span><span class="w">	      </span><span class="n">avg_kern</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2398</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos">2399</span><span class="k">          end do</span><span class="w"></span>
<span class="linenos">2400</span><span class="w">         </span>
<span class="linenos">2401</span><span class="w">          </span><span class="c">! Account for integration via weighted summation</span>
<span class="linenos">2402</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2403</span><span class="w">	       </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2404</span><span class="w">	       </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2405</span><span class="k">	    </span>
<span class="linenos">2406</span><span class="k">            </span><span class="n">obs_col</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="w"> </span><span class="n">avg_kern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2407</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">obs_col</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">2408</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">2409</span><span class="k">        end if</span>
<span class="linenos">2410</span>
<span class="linenos">2411</span><span class="k">      else</span><span class="w"></span>
<span class="linenos">2412</span>
<span class="linenos">2413</span><span class="w">        </span><span class="c">! Standard treatment for linear model</span>
<span class="linenos">2414</span><span class="w">            </span>
<span class="linenos">2415</span><span class="w">        </span><span class="k">do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nobslevOriginal</span><span class="w"></span>
<span class="linenos">2416</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2417</span><span class="k">            </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2418</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2419</span><span class="w">              </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2420</span><span class="w">	  </span><span class="k">end if</span>
<span class="linenos">2421</span><span class="k">        end do</span>
<span class="linenos">2422</span><span class="k">       </span>
<span class="linenos">2423</span><span class="k">      end if</span><span class="w"></span>
<span class="linenos">2424</span>
<span class="linenos">2425</span><span class="w">      </span><span class="c">! Calculate concentration-weighted effective temperature (for output purpose)</span>
<span class="linenos">2426</span>
<span class="linenos">2427</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7000</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2428</span><span class="w">        </span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Integ&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2429</span><span class="w">	</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2430</span><span class="k">	</span>
<span class="linenos">2431</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="k">all</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obs_col</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2432</span><span class="k">          </span><span class="n">temp_eff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2433</span><span class="w">	    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2434</span><span class="w">            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2435</span><span class="w">	    </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2436</span><span class="w">            </span><span class="o">/</span><span class="n">obs_col</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2437</span><span class="w">          </span><span class="n">code</span><span class="o">=</span><span class="n">oss_obsdata_get_header_code</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lon</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="p">,&amp;</span><span class="w"></span>
<span class="linenos">2438</span><span class="w">	    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">date</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">hhmm</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2439</span><span class="w">          </span><span class="k">call </span><span class="n">oopc_addEfftempObsdata</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="n">temp_eff</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2440</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">2441</span><span class="k">      end if</span>
<span class="linenos">2442</span><span class="k">                       </span>
<span class="linenos">2443</span><span class="k">    case</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2444</span>
<span class="linenos">2445</span><span class="w">      </span><span class="c">! Compute sqrt(diag(H*B*H^T))</span>
<span class="linenos">2446</span>
<span class="linenos">2447</span><span class="w">      </span><span class="c">! Apply unit conversion to observation operator</span>
<span class="linenos">2448</span><span class="w">      </span><span class="k">do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nobslevOriginal</span><span class="w"></span>
<span class="linenos">2449</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2450</span><span class="k">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unit_conversion</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,:)</span><span class="w"></span>
<span class="linenos">2451</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">2452</span><span class="k">      end do</span><span class="w"></span>
<span class="linenos">2453</span>
<span class="linenos">2454</span><span class="w">      </span><span class="c">! Get background error std dev profile at obs location</span>
<span class="linenos">2455</span><span class="w">      </span><span class="n">fdeStddev</span><span class="p">(:,:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">2456</span><span class="w">      </span><span class="k">call </span><span class="n">bcsc_getBgStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2457</span><span class="w">                            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lon</span><span class="p">,</span><span class="n">fdeStddev</span><span class="p">(:,</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span>
<span class="linenos">2458</span>
<span class="linenos">2459</span><span class="w">      </span><span class="c">! Identify variable position index in background error correlation matrices</span>
<span class="linenos">2460</span>
<span class="linenos">2461</span><span class="w">      </span><span class="n">varIndex</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2462</span><span class="w">      </span><span class="k">do while</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">bgStats</span><span class="p">%</span><span class="n">varNameList</span><span class="p">(</span><span class="n">varIndex</span><span class="p">))</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2463</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">bgStats</span><span class="p">%</span><span class="n">varNameList</span><span class="p">(</span><span class="n">varIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">2464</span><span class="k">        </span><span class="n">varIndex</span><span class="o">=</span><span class="n">varIndex</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2465</span><span class="w">      </span><span class="k">end do</span>
<span class="linenos">2466</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">bgStats</span><span class="p">%</span><span class="n">varNameList</span><span class="p">(</span><span class="n">varIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2467</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_obsoperators: Correlation matrix not found for &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2468</span><span class="w">	               </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">2469</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2470</span>
<span class="linenos">2471</span><span class="k">      do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nobslevOriginal</span><span class="w"></span>
<span class="linenos">2472</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2473</span><span class="k">          do </span><span class="n">modlevIndex</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2474</span><span class="w">	                  </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2475</span><span class="w">		  </span>
<span class="linenos">2476</span><span class="w">            </span><span class="n">zwork</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2477</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2478</span><span class="w">              </span><span class="o">*</span><span class="n">bgStats</span><span class="p">%</span><span class="n">corvert</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2479</span><span class="w">	        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="n">varIndex</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2480</span><span class="w">              </span><span class="o">*</span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2481</span><span class="w">	        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2482</span><span class="w">              </span><span class="o">*</span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2483</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">2484</span><span class="k">          </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2485</span><span class="w">	    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2486</span><span class="w">            </span><span class="o">*</span><span class="n">zwork</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2487</span><span class="w">    </span>
<span class="linenos">2488</span><span class="w">          </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w">  </span><span class="c">! save as sqrt(h*B*h^T)</span>
<span class="linenos">2489</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">2490</span><span class="k">          </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos">2491</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">2492</span><span class="k">      end do</span>
<span class="linenos">2493</span>
<span class="linenos">2494</span><span class="k">    case</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2495</span>
<span class="linenos">2496</span><span class="w">      </span><span class="c">! Finalize TL operator application</span>
<span class="linenos">2497</span>
<span class="linenos">2498</span><span class="w">      </span><span class="c">! Standard treatment for linear and linearized model</span>
<span class="linenos">2499</span><span class="w">            </span>
<span class="linenos">2500</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2501</span>
<span class="linenos">2502</span><span class="k">        do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2503</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2504</span><span class="k">            </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2505</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2506</span><span class="w">              </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2507</span><span class="w">	  </span><span class="k">end if </span>
<span class="linenos">2508</span><span class="k">        end do</span><span class="w"></span>
<span class="linenos">2509</span><span class="w">         </span>
<span class="linenos">2510</span><span class="w">        </span><span class="c">! Account for integration via weighted summation</span>
<span class="linenos">2511</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2512</span><span class="w">	     </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2513</span><span class="w">	     </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2514</span><span class="k">	  </span>
<span class="linenos">2515</span><span class="k">          </span><span class="n">obs_col</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="w"> </span><span class="n">avg_kern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2516</span><span class="w">	    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">obs_col</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">2517</span>
<span class="linenos">2518</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">2519</span><span class="k">      else</span>
<span class="linenos">2520</span><span class="k">     </span>
<span class="linenos">2521</span><span class="k">        do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nobslevOriginal</span><span class="w"></span>
<span class="linenos">2522</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2523</span><span class="k">            </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2524</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2525</span><span class="w">              </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2526</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">2527</span><span class="k">            </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2528</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">2529</span><span class="k">        end do</span>
<span class="linenos">2530</span><span class="k">     </span>
<span class="linenos">2531</span><span class="k">      end if</span>
<span class="linenos">2532</span><span class="k">     </span>
<span class="linenos">2533</span><span class="k">    case</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2534</span>
<span class="linenos">2535</span><span class="w">      </span><span class="c">! H^T*grad contribution from adjoint of tangent linear model.</span>
<span class="linenos">2536</span>
<span class="linenos">2537</span><span class="w">      </span><span class="n">model_col</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos">2538</span><span class="w">       </span>
<span class="linenos">2539</span><span class="w">      </span><span class="c">! Standard treatment for linear and linearized model</span>
<span class="linenos">2540</span><span class="w">       </span>
<span class="linenos">2541</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2542</span>
<span class="linenos">2543</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2544</span><span class="w">	     </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2545</span><span class="w">	     </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2546</span><span class="w">       </span>
<span class="linenos">2547</span><span class="w">          </span><span class="c">! Account for integration via weighted summation</span>
<span class="linenos">2548</span><span class="w">          </span><span class="n">zwork</span><span class="p">(:)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w">         </span>
<span class="linenos">2549</span><span class="w">          </span><span class="k">do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2550</span><span class="w">            </span><span class="n">zwork</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2551</span><span class="w">	      </span><span class="nb">sum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2552</span><span class="w">              </span><span class="n">avg_kern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">2553</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">2554</span><span class="k">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="mi">1</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">2555</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2556</span><span class="w">            </span><span class="n">zwork</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2557</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">2558</span><span class="k">      end if          </span>
<span class="linenos">2559</span>
<span class="linenos">2560</span><span class="k">      do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nobslevOriginal</span><span class="w"></span>
<span class="linenos">2561</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2562</span><span class="k">          </span><span class="n">zwork</span><span class="p">(:)</span><span class="o">=</span><span class="mf">0.0D0</span><span class="w"></span>
<span class="linenos">2563</span><span class="w">          </span><span class="n">zwork</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2564</span><span class="w">             </span><span class="n">obs_col</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">*</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2565</span><span class="w">	     </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2566</span><span class="w">                </span>
<span class="linenos">2567</span><span class="w">          </span><span class="k">call </span><span class="n">oopc_convertUnits</span><span class="p">(</span><span class="n">zwork</span><span class="p">,</span><span class="n">incr_opt</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">2568</span><span class="w">          </span>
<span class="linenos">2569</span><span class="w">          </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2570</span><span class="w">             </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2571</span><span class="w">             </span><span class="n">zwork</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2572</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">2573</span><span class="k">      end do</span>
<span class="linenos">2574</span><span class="k">     </span>
<span class="linenos">2575</span><span class="k">    end select</span>
<span class="linenos">2576</span>
<span class="linenos">2577</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">avg_kern</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2578</span><span class="w">     </span>
<span class="linenos">2579</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_obsoperators</span><span class="w"></span>
<span class="linenos">2580</span>
<span class="linenos">2581</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2582</span><span class="w">  </span><span class="c">! oopc_prepareOperator</span>
<span class="linenos">2583</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2584</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_prepareOperator</span><span class="p">(</span><span class="n">model_col</span><span class="p">,</span><span class="n">avg_kern</span><span class="p">,</span><span class="n">nobslevOriginal</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2585</span><span class="w">                                  </span><span class="n">maxnumHeaders</span><span class="p">,</span><span class="n">headerCount</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="n">unit_conversion</span><span class="p">,</span><span class="n">successLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2586</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2587</span><span class="w">    </span><span class="c">!:Purpose: To prepare observation operator</span>
<span class="linenos">2588</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2589</span><span class="w">    </span>
<span class="linenos">2590</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">2591</span><span class="w">    </span>
<span class="linenos">2592</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">2593</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="c">! Mode of observation operator</span>
<span class="linenos">2594</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="c">! Number of actual obs elements in measurement</span>
<span class="linenos">2595</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">maxnumHeaders</span><span class="w">   </span><span class="c">! Total number of CH obs for this CPU</span>
<span class="linenos">2596</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">headerCount</span><span class="w">     </span><span class="c">! Obs counter/index</span>
<span class="linenos">2597</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2598</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">unit_conversion</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2599</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">successLocal</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2600</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">avg_kern</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">2601</span>
<span class="linenos">2602</span><span class="w">    </span><span class="c">! Locals:  </span>
<span class="linenos">2603</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">press_obs</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2604</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ixtrLocal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2605</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">zhmin</span><span class="w"></span>
<span class="linenos">2606</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">modlevIndex</span><span class="w"></span>
<span class="linenos">2607</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">code_len</span><span class="o">=</span><span class="mi">90</span><span class="w"></span>
<span class="linenos">2608</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">code_len</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">code</span><span class="w">    </span><span class="c">! Must be at least as large as oopc_code_len</span>
<span class="linenos">2609</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">message</span><span class="w"></span>
<span class="linenos">2610</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">successDepot</span><span class="w"></span>
<span class="linenos">2611</span>
<span class="linenos">2612</span><span class="w">    </span><span class="c">! Check if obs BUFR element needs to be changed with use of averaging kernels</span>
<span class="linenos">2613</span><span class="w">    </span>
<span class="linenos">2614</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2615</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2616</span><span class="w">           </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2617</span><span class="k">	   </span>
<span class="linenos">2618</span><span class="k">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="o">=</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">ProfElement</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2619</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2620</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">2621</span>
<span class="linenos">2622</span><span class="w">    </span><span class="c">! Identify observation operator based on observation units and presence or</span>
<span class="linenos">2623</span><span class="w">    </span><span class="c">! not of layer boundaries</span>
<span class="linenos">2624</span>
<span class="linenos">2625</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bufr_IsIntegral</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2626</span><span class="k">      if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">obsoper</span><span class="p">%</span><span class="n">layerIdentified</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2627</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">   </span><span class="s1">&#39;----------------------------------------------------------&#39;</span><span class="w"></span>
<span class="linenos">2628</span><span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">   </span><span class="s1">&#39;STNID, BUFR index, nobslev: &#39;</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2629</span><span class="w">	             </span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos">2630</span><span class="w">        </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_obsoperators: Required layer boundaries not available!&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2631</span><span class="w">      </span><span class="k">else</span><span class="w">      </span>
<span class="linenos">2632</span><span class="w">        </span><span class="c">! Vertical integration operator</span>
<span class="linenos">2633</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="o">=</span><span class="s1">&#39;Integ&#39;</span><span class="w"></span>
<span class="linenos">2634</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2635</span><span class="k">    else if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">layerIdentified</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2636</span><span class="w">      </span><span class="c">! Layer averaging operator</span>
<span class="linenos">2637</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="o">=</span><span class="s1">&#39;LayerAvg&#39;</span><span class="w"></span>
<span class="linenos">2638</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">  </span>
<span class="linenos">2639</span><span class="w">      </span><span class="c">! Surface point (in-situ) measurement</span>
<span class="linenos">2640</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="o">=</span><span class="s1">&#39;Surface&#39;</span><span class="w"></span>
<span class="linenos">2641</span><span class="w">    </span><span class="k">else</span><span class="w">    </span>
<span class="linenos">2642</span><span class="w">      </span><span class="c">! Vertical interpolation operator</span>
<span class="linenos">2643</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="o">=</span><span class="s1">&#39;Interp&#39;</span><span class="w"></span>
<span class="linenos">2644</span><span class="w">    </span><span class="k">end if</span><span class="w">  </span>
<span class="linenos">2645</span>
<span class="linenos">2646</span><span class="w">    </span><span class="c">! Look for pre-calculated operator</span>
<span class="linenos">2647</span>
<span class="linenos">2648</span><span class="w">    </span><span class="n">successDepot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_operatorDepot</span><span class="p">(</span><span class="n">headerCount</span><span class="p">,</span><span class="n">maxnumHeaders</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="s1">&#39;get&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2649</span>
<span class="linenos">2650</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">successDepot</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2651</span>
<span class="linenos">2652</span><span class="w">      </span><span class="c">! Get averaging kernels if requested</span>
<span class="linenos">2653</span>
<span class="linenos">2654</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2655</span>
<span class="linenos">2656</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">avg_kern</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">avg_kern</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2657</span><span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">avg_kern</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2658</span><span class="w">	                  </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2659</span><span class="w">    </span>
<span class="linenos">2660</span><span class="w">        </span><span class="n">code</span><span class="o">=</span><span class="n">oss_obsdata_get_header_code</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lon</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2661</span><span class="w">	  </span><span class="n">obsoper</span><span class="p">%</span><span class="n">hhmm</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2662</span><span class="w">        </span><span class="k">call </span><span class="n">oopc_getAvgkern</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2663</span><span class="w">                             </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="n">code</span><span class="p">,</span><span class="n">avg_kern</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2664</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2665</span>
<span class="linenos">2666</span><span class="w">      </span><span class="c">! Apply unit conversion (apply later when kmode=3)</span>
<span class="linenos">2667</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">oopc_convertUnits</span><span class="p">(</span><span class="n">model_col</span><span class="p">,</span><span class="n">incr_opt</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">2668</span>
<span class="linenos">2669</span><span class="w">      </span><span class="k">return</span>
<span class="linenos">2670</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">2671</span>
<span class="linenos">2672</span><span class="w">    </span><span class="c">! Indicate if the generalized innovation operator is to be applied.</span>
<span class="linenos">2673</span>
<span class="linenos">2674</span><span class="w">    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">2675</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2676</span><span class="w">      </span><span class="n">oopc_checkType</span><span class="p">(</span><span class="n">operatorSubType</span><span class="p">(</span><span class="mi">1</span><span class="p">,:),</span><span class="n">operatorSubType</span><span class="p">(</span><span class="mi">2</span><span class="p">,:),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2677</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">,</span><span class="s1">&#39;genOper&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then </span>
<span class="linenos">2678</span><span class="k">      </span>
<span class="linenos">2679</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Integ&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2680</span><span class="w">	                    </span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;LayerAvg&#39;</span><span class="w">   </span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2681</span><span class="k">       </span>
<span class="linenos">2682</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2683</span><span class="w">          </span><span class="c">! Set reference profiles for use with generalized innovation operator</span>
<span class="linenos">2684</span><span class="w">	  </span><span class="c">! when kmode&gt;=2</span>
<span class="linenos">2685</span><span class="w">          </span><span class="k">call </span><span class="n">oopc_addToProfileSet</span><span class="p">(</span><span class="n">oopc_climFields</span><span class="p">,</span><span class="n">oopc_bgRef</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2686</span><span class="w">	         </span><span class="n">oopc_constituentsSize</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2687</span><span class="w">		 </span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">obs_index</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2688</span><span class="w">		 </span><span class="n">oopc_obsdata_maxsize</span><span class="p">,</span><span class="n">varKind_opt</span><span class="o">=</span><span class="s1">&#39;CH&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2689</span><span class="w">                 </span><span class="n">varNumber_opt</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2690</span><span class="w">		 </span><span class="n">tt_opt</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="p">,</span><span class="n">hu_opt</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">hu</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2691</span><span class="w">		 </span>
<span class="linenos">2692</span><span class="w">          </span><span class="c">! Get background error std dev profile at obs locations</span>
<span class="linenos">2693</span><span class="w">          </span><span class="n">fdeStddev</span><span class="p">(:,:)</span><span class="o">=</span><span class="mf">0.D0</span><span class="w"></span>
<span class="linenos">2694</span><span class="w">	  </span>
<span class="linenos">2695</span><span class="w">          </span><span class="k">call </span><span class="n">bcsc_getBgStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2696</span><span class="w">	    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">lon</span><span class="p">,</span><span class="n">fdeStddev</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">vlev_opt</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2697</span>
<span class="linenos">2698</span><span class="w">          </span><span class="k">call </span><span class="n">bcsc_addBgStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obs_index</span><span class="p">,</span><span class="n">fdeStddev</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2699</span><span class="w">	    </span><span class="n">oopc_obsdata_maxsize</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2700</span><span class="w">  </span>
<span class="linenos">2701</span><span class="w">        </span><span class="k">end if 	</span>
<span class="linenos">2702</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">2703</span>
<span class="linenos">2704</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2705</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">2706</span><span class="w">    </span>
<span class="linenos">2707</span><span class="w">    </span><span class="c">! Apply unit conversion (apply unit conversion later for kmode=3)</span>
<span class="linenos">2708</span>
<span class="linenos">2709</span><span class="w">    </span><span class="k">select case</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2710</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2711</span><span class="w">      </span><span class="c">! Perform transformation and unit conversion on obsoper%trial.</span>
<span class="linenos">2712</span><span class="w">      </span><span class="c">! Note that model_col =&gt; obsoper%trial for kmode=0.</span>
<span class="linenos">2713</span><span class="w">      </span><span class="k">call </span><span class="n">oopc_convertUnits</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2714</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2715</span><span class="w">      </span><span class="c">! Save the conversion factor in &lt;unit_conversion&gt;</span>
<span class="linenos">2716</span><span class="w">      </span><span class="n">unit_conversion</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>
<span class="linenos">2717</span><span class="w">      </span><span class="k">call </span><span class="n">oopc_convertUnits</span><span class="p">(</span><span class="n">unit_conversion</span><span class="p">,</span><span class="n">incr_opt</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">2718</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2719</span><span class="w">      </span><span class="k">call </span><span class="n">oopc_convertUnits</span><span class="p">(</span><span class="n">model_col</span><span class="p">,</span><span class="n">incr_opt</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">2720</span><span class="w">    </span><span class="k">end select</span>
<span class="linenos">2721</span>
<span class="linenos">2722</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2723</span><span class="w">      </span><span class="c">! Perform unit conversion on obsoper%trial when applying the generalized</span>
<span class="linenos">2724</span><span class="w">      </span><span class="c">! obs operator for kmode=2,3. Keep obsoper%trial in ug/kg in this case.</span>
<span class="linenos">2725</span><span class="w">      </span><span class="k">call </span><span class="n">oopc_convertUnits</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">,</span><span class="n">ppb_opt</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">2726</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">2727</span>
<span class="linenos">2728</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">press_obs</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">press_obs</span><span class="p">,</span><span class="n">ixtrLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2729</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">press_obs</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">),</span><span class="n">ixtrLocal</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2730</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2731</span><span class="k">      </span><span class="n">ixtrLocal</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2732</span><span class="w">      </span><span class="n">successLocal</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2733</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2734</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(:)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2735</span><span class="k">        </span><span class="n">ixtrLocal</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">2736</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2737</span><span class="k">        </span><span class="n">ixtrLocal</span><span class="p">(:)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2738</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2739</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2740</span><span class="k">        </span><span class="n">successLocal</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">2741</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2742</span><span class="k">        </span><span class="n">successLocal</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">2743</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2744</span><span class="k">    end if</span><span class="w"> </span>
<span class="linenos">2745</span>
<span class="linenos">2746</span><span class="w">    </span><span class="c">! Convert observation vertical coordinate value(s) to pressure if needed</span>
<span class="linenos">2747</span><span class="w">    </span>
<span class="linenos">2748</span><span class="w">    </span><span class="k">select case</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2749</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2750</span><span class="w">      </span><span class="c">! Convert altitude to pressure</span>
<span class="linenos">2751</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Interp&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2752</span><span class="k">        </span><span class="n">press_obs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phf_convert_z_to_pressure</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2753</span><span class="w">	            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2754</span><span class="w">                    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="p">,</span><span class="n">successLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2755</span><span class="w">        </span><span class="c">! Allows for obs levels below the lowest TH level and above the surface</span>
<span class="linenos">2756</span><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2757</span><span class="w">	  </span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2758</span><span class="w">	  </span><span class="n">press_obs</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2759</span><span class="w">	  </span>
<span class="linenos">2760</span><span class="w">      </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Integ&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2761</span><span class="w">               </span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;LayerAvg&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2762</span><span class="k">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phf_convert_z_to_pressure</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2763</span><span class="w">	                    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2764</span><span class="w">                            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2765</span><span class="w">			    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="p">,</span><span class="n">successLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2766</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phf_convert_z_to_pressure</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2767</span><span class="w">	                       </span><span class="n">obsoper</span><span class="p">%</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2768</span><span class="w">                               </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2769</span><span class="w">			       </span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="p">,</span><span class="n">successLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2770</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2771</span><span class="k">    case</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2772</span><span class="w">      </span><span class="c">! Pressure, no conversion needed</span>
<span class="linenos">2773</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Interp&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">press_obs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">obslev</span><span class="w"></span>
<span class="linenos">2774</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2775</span><span class="w">      </span><span class="c">! No actions taken</span>
<span class="linenos">2776</span><span class="w">    </span><span class="k">case </span><span class="n">default</span><span class="w"></span>
<span class="linenos">2777</span><span class="w">      </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;oopc_obsoperators: vertical coordinate type vco = &quot;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2778</span><span class="w">                      </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="p">))</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2779</span><span class="w">		      </span><span class="s2">&quot; not available for this operator.&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2780</span><span class="w">    </span><span class="k">end select</span><span class="w"></span>
<span class="linenos">2781</span>
<span class="linenos">2782</span><span class="w">    </span><span class="c">! Determine if averaging kernel is to be applied</span>
<span class="linenos">2783</span>
<span class="linenos">2784</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2785</span><span class="k">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_findAvgkern</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2786</span><span class="w">                         </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2787</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2788</span><span class="k">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_findAvgkern</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2789</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2790</span><span class="w">  </span>
<span class="linenos">2791</span><span class="w">    </span><span class="c">! Apply appropriate core observation operator</span>
<span class="linenos">2792</span><span class="w">   </span>
<span class="linenos">2793</span><span class="w">    </span><span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="p">))</span><span class="w"></span>
<span class="linenos">2794</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="s1">&#39;Interp&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2795</span>
<span class="linenos">2796</span><span class="w">      </span><span class="c">! Vertical interpolation operator</span>
<span class="linenos">2797</span><span class="w">     </span>
<span class="linenos">2798</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2799</span><span class="k">        </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;doAll&amp;noExtrap&#39;</span><span class="w"></span>
<span class="linenos">2800</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2801</span><span class="k">        </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;noExtrap&#39;</span><span class="w"></span>
<span class="linenos">2802</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2803</span><span class="k">      call </span><span class="n">ppo_vertInterpWgts</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="n">press_obs</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2804</span><span class="w">           </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2805</span><span class="w">	   </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">,</span><span class="n">method_opt</span><span class="o">=</span><span class="n">oopc_getType</span><span class="p">(</span><span class="n">operatorSubType</span><span class="p">(</span><span class="mi">1</span><span class="p">,:),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2806</span><span class="w">	   </span><span class="n">operatorSubType</span><span class="p">(</span><span class="mi">2</span><span class="p">,:),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">),</span><span class="n">skipType_opt</span><span class="o">=</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2807</span><span class="w">	   </span><span class="n">outbound_opt</span><span class="o">=</span><span class="n">ixtrLocal</span><span class="p">,</span><span class="n">success_opt</span><span class="o">=</span><span class="n">successLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2808</span><span class="w"> </span>
<span class="linenos">2809</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="s1">&#39;Surface&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2810</span>
<span class="linenos">2811</span><span class="w">      </span><span class="c">! Surface point measurement</span>
<span class="linenos">2812</span>
<span class="linenos">2813</span><span class="w">      </span><span class="c">! Set weight to unity for lowest model level.</span>
<span class="linenos">2814</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos">2815</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>
<span class="linenos">2816</span>
<span class="linenos">2817</span><span class="w">      </span><span class="c">! Set range of elements for model vertical levels</span>
<span class="linenos">2818</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="w"></span>
<span class="linenos">2819</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="w"> </span>
<span class="linenos">2820</span><span class="w">    </span>
<span class="linenos">2821</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="s1">&#39;Integ&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2822</span><span class="w">  </span>
<span class="linenos">2823</span><span class="w">      </span><span class="c">! Layer integration operator</span>
<span class="linenos">2824</span>
<span class="linenos">2825</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2826</span><span class="k">        </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;doAll&amp;noExtrap&#39;</span><span class="w"></span>
<span class="linenos">2827</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2828</span><span class="k">        </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos">2829</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2830</span><span class="k">      </span>
<span class="linenos">2831</span><span class="k">      call </span><span class="n">oopc_vertObsLayersWgts</span><span class="p">(</span><span class="s1">&#39;integ&#39;</span><span class="p">,</span><span class="n">ixtrLocal</span><span class="p">,</span><span class="n">successLocal</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2832</span>
<span class="linenos">2833</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="s1">&#39;LayerAvg&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2834</span><span class="w">    </span>
<span class="linenos">2835</span><span class="w">      </span><span class="c">! Layer averaging operator</span>
<span class="linenos">2836</span>
<span class="linenos">2837</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2838</span><span class="k">        </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;doAll&amp;noExtrap&#39;</span><span class="w"></span>
<span class="linenos">2839</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2840</span><span class="k">        </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="w"></span>
<span class="linenos">2841</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2842</span>
<span class="linenos">2843</span><span class="k">      call </span><span class="n">oopc_vertObsLayersWgts</span><span class="p">(</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span><span class="n">ixtrLocal</span><span class="p">,</span><span class="n">successLocal</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="n">message</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2844</span>
<span class="linenos">2845</span><span class="w">    </span><span class="k">end select</span>
<span class="linenos">2846</span>
<span class="linenos">2847</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2848</span><span class="k">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ixtrLocal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2849</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">successLocal</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">2850</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">2851</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="k">all</span><span class="p">(</span><span class="n">ixtrLocal</span><span class="p">(:)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2852</span><span class="k">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(:)</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">2853</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2854</span><span class="k">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(:)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2855</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2856</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="k">all</span><span class="p">(</span><span class="n">successLocal</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2857</span><span class="k">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">2858</span><span class="w">      </span><span class="k">else</span>
<span class="linenos">2859</span><span class="k">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">2860</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2861</span><span class="k">    end if </span>
<span class="linenos">2862</span><span class="k">    deallocate</span><span class="p">(</span><span class="n">press_obs</span><span class="p">,</span><span class="n">ixtrLocal</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2863</span><span class="w">  </span>
<span class="linenos">2864</span><span class="w">    </span><span class="c">! Apply averaging kernels if requested</span>
<span class="linenos">2865</span>
<span class="linenos">2866</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2867</span>
<span class="linenos">2868</span><span class="k">      allocate</span><span class="p">(</span><span class="n">avg_kern</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2869</span><span class="w">               </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">2870</span><span class="w">       </span>
<span class="linenos">2871</span><span class="w">      </span><span class="n">code</span><span class="o">=</span><span class="n">oss_obsdata_get_header_code</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lon</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2872</span><span class="w">                                       </span><span class="n">obsoper</span><span class="p">%</span><span class="n">date</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">hhmm</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2873</span><span class="w">      </span><span class="k">call </span><span class="n">oopc_getAvgkern</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2874</span><span class="w">                           </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2875</span><span class="w">                           </span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="n">code</span><span class="p">,</span><span class="n">avg_kern</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2876</span><span class="w">     </span>
<span class="linenos">2877</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_checkType</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">stnids</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="k">type</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2878</span><span class="w">                         </span><span class="s1">&#39;default&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2879</span><span class="k">        do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2880</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2881</span>
<span class="linenos">2882</span><span class="w">            </span><span class="c">! Apply averaging kernels to observation operator(s)</span>
<span class="linenos">2883</span><span class="w">            </span>
<span class="linenos">2884</span><span class="w">            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">matmul</span><span class="p">(</span><span class="n">avg_kern</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2885</span><span class="w">	                                </span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(:,:))</span><span class="w"></span>
<span class="linenos">2886</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2887</span><span class="k">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2888</span><span class="w">	        </span><span class="nb">matmul</span><span class="p">(</span><span class="n">avg_kern</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(:,:))</span><span class="w"></span>
<span class="linenos">2889</span><span class="w">	    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">2890</span><span class="w">           </span>
<span class="linenos">2891</span><span class="w">            </span><span class="c">! Extend vertical range of obs operator according to the influence of</span>
<span class="linenos">2892</span><span class="w">            </span><span class="c">! the averaging kernel. Either extend to the entire model vertical range</span>
<span class="linenos">2893</span><span class="w">            </span><span class="c">! (commented out below) or to the vertical range with non-negligable values.</span>
<span class="linenos">2894</span>
<span class="linenos">2895</span><span class="w">            </span><span class="c">! obsoper%modlevindexTop(obslevIndex) = 1</span>
<span class="linenos">2896</span><span class="w">            </span><span class="c">! obsoper%modlevindexBot(obslevIndex) = obsoper%nmodlev</span>
<span class="linenos">2897</span>
<span class="linenos">2898</span><span class="w">            </span><span class="n">zhmin</span><span class="o">=</span><span class="mf">1.0D-10</span><span class="o">*</span><span class="nb">maxval</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,:)))</span><span class="w"></span>
<span class="linenos">2899</span><span class="w">            </span><span class="k">do </span><span class="n">modlevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2900</span><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">modlevIndex</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">zhmin</span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">2901</span><span class="k">            end do</span>
<span class="linenos">2902</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">modlevIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2903</span><span class="k">	      </span><span class="n">modlevIndex</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2904</span><span class="w">	    </span><span class="k">end if</span>
<span class="linenos">2905</span><span class="k">            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modlevIndex</span><span class="w"></span>
<span class="linenos">2906</span><span class="w">            </span><span class="k">do </span><span class="n">modlevIndex</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">2907</span><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">modlevIndex</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">zhmin</span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">2908</span><span class="k">            end do</span>
<span class="linenos">2909</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2910</span><span class="k">	      </span><span class="n">modlevIndex</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2911</span><span class="w">	    </span><span class="k">end if</span>
<span class="linenos">2912</span><span class="k">            </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">modlevIndex</span><span class="w"></span>
<span class="linenos">2913</span><span class="w">           </span>
<span class="linenos">2914</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">2915</span><span class="k">        end do</span>
<span class="linenos">2916</span><span class="k"> </span>
<span class="linenos">2917</span><span class="k">      else if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_checkType</span><span class="p">(</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">stnids</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2918</span><span class="w">               </span><span class="n">obsoper</span><span class="p">%</span><span class="n">stnid</span><span class="p">,</span><span class="s1">&#39;log&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2919</span><span class="k">              </span>
<span class="linenos">2920</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">2921</span><span class="w">        </span>
<span class="linenos">2922</span><span class="w">          </span><span class="c">! Apply log-space averaging kernel below - no transformation needed here</span>
<span class="linenos">2923</span><span class="w">          </span><span class="c">! Do not merge the averaging kernel (avgkern) and the vertical interpolator (zh) </span>
<span class="linenos">2924</span><span class="w">          </span>
<span class="linenos">2925</span><span class="w">        </span><span class="k">else</span><span class="w"> </span>
<span class="linenos">2926</span><span class="w">              </span>
<span class="linenos">2927</span><span class="w">          </span><span class="c">! Apply linearization of operator involving the log-space averaging kernel </span>
<span class="linenos">2928</span><span class="w">                      </span>
<span class="linenos">2929</span><span class="w">          </span><span class="k">do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos">2930</span><span class="w">            </span><span class="n">avg_kern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2931</span><span class="w">	      </span><span class="n">avg_kern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">),</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2932</span><span class="w">              </span><span class="nb">dot_product</span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2933</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2934</span><span class="w">              </span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2935</span><span class="w">	                    </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">2936</span><span class="w">          </span><span class="k">end do                                 </span>
<span class="linenos">2937</span>
<span class="linenos">2938</span><span class="k">          do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_avgkern</span><span class="p">%</span><span class="n">n_lvl</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">2939</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2940</span><span class="k">              </span><span class="n">avg_kern</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2941</span><span class="w">	        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">obsSpaceTrial</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">*</span><span class="n">avg_kern</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2942</span><span class="w">		</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2943</span>
<span class="linenos">2944</span><span class="w">              </span><span class="c">! Merge the averaging kernel matrix (avgkern) and the </span>
<span class="linenos">2945</span><span class="w">	      </span><span class="c">! vertical interpolator (initial zh) </span>
<span class="linenos">2946</span><span class="w">              </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">matmul</span><span class="p">(</span><span class="n">avg_kern</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2947</span><span class="w">	        </span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">),</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(:,:))</span><span class="w"></span>
<span class="linenos">2948</span><span class="w">             </span>
<span class="linenos">2949</span><span class="w">            </span><span class="k">end if</span>
<span class="linenos">2950</span><span class="k">          end do</span>
<span class="linenos">2951</span><span class="k">           </span>
<span class="linenos">2952</span><span class="k">        end if</span><span class="w">  </span>
<span class="linenos">2953</span><span class="w">       </span>
<span class="linenos">2954</span><span class="w">        </span><span class="c">! Note that obsoper%applyGenOper=.true. is not set up for this case</span>
<span class="linenos">2955</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2956</span><span class="k">	  call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;prepareOperator: Log &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2957</span><span class="w">	                 </span><span class="s1">&#39;space averaging kernels not currently usable with &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2958</span><span class="w">	                 </span><span class="s1">&#39;obsoper%applyGenOper=.true.&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2959</span><span class="w">	</span><span class="k">end if</span>
<span class="linenos">2960</span><span class="k">      else</span>
<span class="linenos">2961</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_prepareOperator: This averaging kernel &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2962</span><span class="w">	               </span><span class="s1">&#39;application not yet available&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2963</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2964</span><span class="k">    else</span>
<span class="linenos">2965</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">nobslevOriginal</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">2966</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oops_prepareOperator: Case of differing obs &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">2967</span><span class="w">	               </span><span class="s1">&#39;and calculation levels not recognized.&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2968</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">2969</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">2970</span>
<span class="linenos">2971</span><span class="w">    </span><span class="c">! Apply generalized innovation operator if requested</span>
<span class="linenos">2972</span>
<span class="linenos">2973</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">oopc_genOper</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2974</span>
<span class="linenos">2975</span><span class="w">    </span><span class="c">! Save operator if needed</span>
<span class="linenos">2976</span><span class="w">    </span>
<span class="linenos">2977</span><span class="w">    </span><span class="n">successDepot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_operatorDepot</span><span class="p">(</span><span class="n">headerCount</span><span class="p">,</span><span class="n">maxnumHeaders</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="s1">&#39;save&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2978</span><span class="w">    </span>
<span class="linenos">2979</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_prepareOperator</span><span class="w"></span>
<span class="linenos">2980</span>
<span class="linenos">2981</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2982</span><span class="w">  </span><span class="c">! oopc_operatorDepot</span>
<span class="linenos">2983</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">2984</span><span class="w">  </span><span class="k">function </span><span class="n">oopc_operatorDepot</span><span class="p">(</span><span class="n">headerCount</span><span class="p">,</span><span class="n">maxnumHeaders</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">2985</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2986</span><span class="w">    </span><span class="c">!:Purpose: To save or get previously calculated linear observation operator</span>
<span class="linenos">2987</span><span class="w">    </span><span class="c">!          for use by TL and AD operators</span>
<span class="linenos">2988</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">2989</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">2990</span><span class="w">    </span>
<span class="linenos">2991</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">2992</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kmode</span><span class="w">           </span><span class="c">! Mode of observation operator</span>
<span class="linenos">2993</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">headerCount</span><span class="w">     </span><span class="c">! Obs counter/index</span>
<span class="linenos">2994</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">maxnumHeaders</span><span class="w">   </span><span class="c">! Total number of CH obs for this CPU</span>
<span class="linenos">2995</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="c">! &#39;save&#39; or &#39;get&#39; operator for current obs</span>
<span class="linenos">2996</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="w">                     </span><span class="c">! Succes of action succeeded  </span>
<span class="linenos">2997</span>
<span class="linenos">2998</span><span class="w">    </span><span class="c">! Locals:  </span>
<span class="linenos">2999</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">save</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">maxnumOperators</span><span class="w"></span>
<span class="linenos">3000</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oopc_operatorsDepot</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">save</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">operators</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3001</span><span class="w">    </span>
<span class="linenos">3002</span><span class="w">    </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3003</span><span class="w">        </span>
<span class="linenos">3004</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">oopc_storeOperators</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">headerCount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3005</span><span class="w">         </span><span class="p">(</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="n">oopc_tropo_mode</span><span class="p">(:)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3006</span><span class="w">	   </span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">operatorCategory</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Integ&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="linenos">3007</span><span class="k">    </span>
<span class="linenos">3008</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;get&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">initializedOperators</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">&gt;=</span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3009</span><span class="w">    </span>
<span class="linenos">3010</span><span class="w">      </span><span class="c">! Check for available pre-calculated operator</span>
<span class="linenos">3011</span>
<span class="linenos">3012</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">nobslev</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3013</span>
<span class="linenos">3014</span><span class="w">        </span><span class="c">! Update arrays/values that might have changed or would otherwise be set </span>
<span class="linenos">3015</span><span class="w">        </span><span class="c">! below when not stored earlier.</span>
<span class="linenos">3016</span>
<span class="linenos">3017</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">trial</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3018</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">vlayertop</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3019</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">vlayerbottom</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3020</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">modlevindexTop</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3021</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">modlevindexBot</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3022</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">zh</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">3023</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">ixtr</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3024</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">success</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3025</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">iavgkern</span><span class="w"></span>
<span class="linenos">3026</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">applyGenOper</span><span class="w"></span>
<span class="linenos">3027</span>
<span class="linenos">3028</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3029</span><span class="k">	  </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">zhp</span><span class="p">(:,:)</span><span class="w"> </span>
<span class="linenos">3030</span><span class="w">	</span><span class="k">end if</span>
<span class="linenos">3031</span>
<span class="linenos">3032</span><span class="k">        </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"> </span>
<span class="linenos">3033</span><span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">3034</span><span class="w">        </span><span class="c">! Calculations will be performed in th calling routine to prepare </span>
<span class="linenos">3035</span><span class="w">	</span><span class="c">! the operator fields    </span>
<span class="linenos">3036</span><span class="w">      </span><span class="k">end if  </span>
<span class="linenos">3037</span><span class="k">         </span>
<span class="linenos">3038</span><span class="k">    else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;save&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span>
<span class="linenos">3039</span><span class="w">    </span>
<span class="linenos">3040</span><span class="w">      </span><span class="c">! Save operator for later use</span>
<span class="linenos">3041</span><span class="w">      </span>
<span class="linenos">3042</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">initializedOperators</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3043</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">operators</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3044</span><span class="w">        </span><span class="n">maxnumOperators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxnumHeaders</span><span class="w"></span>
<span class="linenos">3045</span><span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">maxnumOperators</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3046</span><span class="w">        </span><span class="n">initializedOperators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3047</span><span class="w">         </span>
<span class="linenos">3048</span><span class="w">        </span><span class="n">operators</span><span class="p">(:)%</span><span class="n">nobslev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3049</span>
<span class="linenos">3050</span><span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;oopc_operatorDepot: Max number of operators to save: &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3051</span><span class="w">	  </span><span class="n">maxnumOperators</span><span class="w"></span>
<span class="linenos">3052</span><span class="w">         </span>
<span class="linenos">3053</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">3054</span>
<span class="linenos">3055</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">zh</span><span class="p">))</span><span class="w"> </span><span class="k">then </span>
<span class="linenos">3056</span><span class="k">        deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">trial</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3057</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">vlayertop</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3058</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">vlayertop</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3059</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">modlevindexTop</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3060</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">modlevindexBot</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3061</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">zh</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3062</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">ixtr</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3063</span><span class="w">        </span><span class="k">deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3064</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">zhp</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3065</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">3066</span><span class="k">      </span>
<span class="linenos">3067</span><span class="k">      allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">trial</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w">    </span>
<span class="linenos">3068</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w">    </span>
<span class="linenos">3069</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3070</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w"> </span>
<span class="linenos">3071</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w"> </span>
<span class="linenos">3072</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">zh</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w"> </span>
<span class="linenos">3073</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">success</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w">    </span>
<span class="linenos">3074</span><span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">ixtr</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">))</span><span class="w">    </span>
<span class="linenos">3075</span><span class="w">      </span>
<span class="linenos">3076</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">nobslev</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos">3077</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">iavgkern</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"></span>
<span class="linenos">3078</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">applyGenOper</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="w"></span>
<span class="linenos">3079</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">trial</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3080</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">vlayertop</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3081</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">vlayerbottom</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3082</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">modlevindexTop</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3083</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">modlevindexBot</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3084</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">zh</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">3085</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">ixtr</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">ixtr</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3086</span><span class="w">      </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">success</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">3087</span><span class="w"> </span>
<span class="linenos">3088</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3089</span><span class="k">        allocate</span><span class="p">(</span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w"> </span>
<span class="linenos">3090</span><span class="w">        </span><span class="n">operators</span><span class="p">(</span><span class="n">headerCount</span><span class="p">)%</span><span class="n">zhp</span><span class="p">(:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">3091</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">3092</span><span class="k">      </span>
<span class="linenos">3093</span><span class="k">      </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"> </span>
<span class="linenos">3094</span>
<span class="linenos">3095</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">3096</span><span class="k">    </span>
<span class="linenos">3097</span><span class="k">  end function </span><span class="n">oopc_operatorDepot</span><span class="w"></span>
<span class="linenos">3098</span><span class="w">  </span>
<span class="linenos">3099</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3100</span><span class="w">  </span><span class="c">! oopc_convertUnits</span>
<span class="linenos">3101</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3102</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_convertUnits</span><span class="p">(</span><span class="n">model_col</span><span class="p">,</span><span class="n">ppb_opt</span><span class="p">,</span><span class="n">incr_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3103</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3104</span><span class="w">    </span><span class="c">!:Purpose: To set unit-conversion factor for consistency of Hx units with</span>
<span class="linenos">3105</span><span class="w">    </span><span class="c">!          obs units.</span>
<span class="linenos">3106</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3107</span><span class="w">    </span><span class="c">!:Arguments:</span>
<span class="linenos">3108</span><span class="w">    </span><span class="c">!     :ppb_opt:        indicates whether model_col should be kept in</span>
<span class="linenos">3109</span><span class="w">    </span><span class="c">!                      ug/kg instead of the units dictated by the BUFR</span>
<span class="linenos">3110</span><span class="w">    </span><span class="c">!                      number (optional, .false. by default)</span>
<span class="linenos">3111</span><span class="w">    </span><span class="c">!     :incr_opt:       indicates if model_col is actually an increment </span>
<span class="linenos">3112</span><span class="w">    </span><span class="c">!                      (optional, .false. by default). Needed for non-linear</span>
<span class="linenos">3113</span><span class="w">    </span><span class="c">!                      transformations (i.e. for &#39;HU&#39;)</span>
<span class="linenos">3114</span><span class="w">    </span><span class="c">!     :model_col       Array to be converted. Either trial or increment-related.</span>
<span class="linenos">3115</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3116</span><span class="w">    </span><span class="c">!:Comments:</span>
<span class="linenos">3117</span><span class="w">    </span><span class="c">!    </span>
<span class="linenos">3118</span><span class="w">    </span><span class="c">!      A. Standard model/analysis species field provided as mass mixing </span>
<span class="linenos">3119</span><span class="w">    </span><span class="c">!         ratio in ug/kg (ppb). Conversion to ppb is applied when this is </span>
<span class="linenos">3120</span><span class="w">    </span><span class="c">!         not the case except for AOD and surface emissions.</span>
<span class="linenos">3121</span><span class="w">    </span><span class="c">!         As this is hard-coded, any changes in analysis variable must</span>
<span class="linenos">3122</span><span class="w">    </span><span class="c">!         be reflected by correspondingly modifying this module.</span>
<span class="linenos">3123</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3124</span><span class="w">    </span><span class="c">!      B. Unit-conversion factor is calculated in oopc_convertUnits</span>
<span class="linenos">3125</span><span class="w">    </span><span class="c">!         from the following factors:</span>
<span class="linenos">3126</span><span class="w">    </span><span class="c">!           (1) physical constants</span>
<span class="linenos">3127</span><span class="w">    </span><span class="c">!           (2) parameters related to a particular species such as molecular</span>
<span class="linenos">3128</span><span class="w">    </span><span class="c">!               mass</span>
<span class="linenos">3129</span><span class="w">    </span><span class="c">!           (3) variables such as T and P from background field at each</span>
<span class="linenos">3130</span><span class="w">    </span><span class="c">!               iteration</span>
<span class="linenos">3131</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3132</span><span class="w">    </span><span class="c">!      C. The baseline integral observation operator can be interpreted as</span>
<span class="linenos">3133</span><span class="w">    </span><span class="c">!         being integrals of the gas partial pressure, giving products in</span>
<span class="linenos">3134</span><span class="w">    </span><span class="c">!         kg/m^2, e.g. with sample discretized layer integrals::</span>
<span class="linenos">3135</span><span class="w">    </span><span class="c">!                (mass density) * dz = - d(gas partial pressure)/g </span>
<span class="linenos">3136</span><span class="w">    </span><span class="c">!                                    = - [rho(gas)/rho(air)]*dP/g</span>
<span class="linenos">3137</span><span class="w">    </span><span class="c">!                                    = - 1E-9 * [mass mixing ratio in parts per billion (ppb)]*dP/g </span>
<span class="linenos">3138</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3139</span><span class="w">    </span><span class="c">!         The actual integration in pressure (in Pascal) is performed</span>
<span class="linenos">3140</span><span class="w">    </span><span class="c">!         outside this routine. For integral products in kg/m^2, the output</span>
<span class="linenos">3141</span><span class="w">    </span><span class="c">!         of this routine is to be in mmr/(m/s^2)  (mmr=mass mixing ratio),</span>
<span class="linenos">3142</span><span class="w">    </span><span class="c">!         which is equivalent to (1E-9 ug/kg)/(m/s^2) and kg/(m^2*Pa). </span>
<span class="linenos">3143</span><span class="w">    </span><span class="c">!         Therefore, the input value in ug/kg has to be multiplied by 1E-9/g</span>
<span class="linenos">3144</span><span class="w">    </span><span class="c">!         (g=RG below).</span>
<span class="linenos">3145</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3146</span><span class="w">    </span><span class="c">!         For integral products in other units, additional conversion </span>
<span class="linenos">3147</span><span class="w">    </span><span class="c">!         factors are also to be applied.</span>
<span class="linenos">3148</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3149</span><span class="w">    </span><span class="c">!      D. List should be revised following changes to the &#39;tableburp&#39; file.</span>
<span class="linenos">3150</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3151</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3152</span><span class="w">    </span><span class="c">!      E. Coefficients related to unit conversion</span>
<span class="linenos">3153</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3154</span><span class="w">    </span><span class="c">!         rho_stp=1.293                     Air density at STP (1.293 kg/m^3)</span>
<span class="linenos">3155</span><span class="w">    </span><span class="c">!         RG=9.807 (=g)                     Acceleration due to gravity (m/s^2)</span>
<span class="linenos">3156</span><span class="w">    </span><span class="c">!         MPC_AVOGADRO_R8 = Na              Avogadro&#39;s number. 6.023E23 molecules/mole</span>
<span class="linenos">3157</span><span class="w">    </span><span class="c">!         MPC_MOLAR_MASS_DRY_AIR_R8 (m_air) Dry air molecular mass. 28.9644 g/mole</span>
<span class="linenos">3158</span><span class="w">    </span><span class="c">!         MPC_RGAS_IDEAL_R8 = R             Ideal gas constant. 8.341 J/mole/K  (J=kg m^2/s^2)</span>
<span class="linenos">3159</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3160</span><span class="w">    </span><span class="c">!                                             PV = nRT (n=number of moles)</span>
<span class="linenos">3161</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3162</span><span class="w">    </span><span class="c">!         MPC_RGAS_DRY_AIR_R8  = Rd         Dry air constant. 287.1 J/kg/K  (J=kg m^2/s^2)</span>
<span class="linenos">3163</span><span class="w">    </span><span class="c">!                                           = MPC_RGAS_IDEAL_R8 * 1000 g/km / MPC_MOLAR_MASS_DRY_AIR_R8</span>
<span class="linenos">3164</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3165</span><span class="w">    </span><span class="c">!                                             P=rho*Rd*T = [n*m_air*0.001 kg/g]*Rd*T</span>
<span class="linenos">3166</span><span class="w">    </span><span class="c">!                                                        = n*[m_air*0.001*Rd]*T</span>
<span class="linenos">3167</span><span class="w">    </span><span class="c">!                                                        = nRT</span>
<span class="linenos">3168</span><span class="w">    </span><span class="c">! Further changes required for generalization </span>
<span class="linenos">3169</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3170</span><span class="w">    </span><span class="c">!  1) Conversion for surface emissions not included as yet (if any is</span>
<span class="linenos">3171</span><span class="w">    </span><span class="c">!     needed)</span>
<span class="linenos">3172</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3173</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">3174</span>
<span class="linenos">3175</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">3176</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">model_col</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"> </span><span class="c">! Model-space profile to have its units changed</span>
<span class="linenos">3177</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ppb_opt</span><span class="p">,</span><span class="w"> </span><span class="n">incr_opt</span><span class="w"></span>
<span class="linenos">3178</span><span class="w">    </span>
<span class="linenos">3179</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">3180</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">zcoef</span><span class="w"></span>
<span class="linenos">3181</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">exp_P</span><span class="p">,</span><span class="n">exp_T</span><span class="w"></span>
<span class="linenos">3182</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ppb_out</span><span class="p">,</span><span class="w"> </span><span class="n">incr_out</span><span class="w"></span>
<span class="linenos">3183</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">rho_stp</span><span class="o">=</span><span class="mf">1.293</span><span class="w">  </span><span class="c">! kg/m^3</span>
<span class="linenos">3184</span><span class="w">    </span>
<span class="linenos">3185</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"></span>
<span class="linenos">3186</span><span class="w">    </span>
<span class="linenos">3187</span><span class="w">    </span><span class="c">! No conversion necessary for these BUFR numbers</span>
<span class="linenos">3188</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="w"> </span><span class="n">BUFR_UNIT_OptDepth</span><span class="p">,</span><span class="n">BUFR_UNIT_OptDepth2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3189</span><span class="w">             </span><span class="n">BUFR_UNIT_OptDepth3</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_MR_NVaerosol</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_NETT</span><span class="w"> </span><span class="o">/</span><span class="p">)</span><span class="w">  </span><span class="p">))</span><span class="w"> </span><span class="k">return</span>
<span class="linenos">3190</span><span class="k">    </span>
<span class="linenos">3191</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">ppb_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3192</span><span class="k">      </span><span class="n">ppb_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ppb_opt</span><span class="w"></span>
<span class="linenos">3193</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">3194</span><span class="k">      </span><span class="n">ppb_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3195</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">3196</span><span class="k">      </span>
<span class="linenos">3197</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">incr_opt</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3198</span><span class="k">      </span><span class="n">incr_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incr_opt</span><span class="w"></span>
<span class="linenos">3199</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">3200</span><span class="k">      </span><span class="n">incr_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3201</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">3202</span><span class="k">    </span>
<span class="linenos">3203</span><span class="k">    </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.</span><span class="w"></span>
<span class="linenos">3204</span><span class="w">    </span><span class="n">exp_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="c">! exponent of multiplicative factor obsoper%tt</span>
<span class="linenos">3205</span><span class="w">    </span><span class="n">exp_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="c">! exponent of multiplicative factor obsoper%pp</span>
<span class="linenos">3206</span><span class="w">    </span>
<span class="linenos">3207</span><span class="w">    </span><span class="c">! Convert to ug/kg if not already in those units</span>
<span class="linenos">3208</span>
<span class="linenos">3209</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;AF&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;AC&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3210</span>
<span class="linenos">3211</span><span class="w">      </span><span class="c">! PM2.5 or PM10</span>
<span class="linenos">3212</span><span class="w">       </span>
<span class="linenos">3213</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="w"> </span><span class="n">BUFR_UNIT_VMR</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_VMR2</span><span class="p">,</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3214</span><span class="w">              </span><span class="n">BUFR_UNIT_MolePerMole</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_MolePerMole2</span><span class="p">,</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3215</span><span class="w">              </span><span class="n">BUFR_UNIT_NumberDensity</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_MolarDensity</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span>
<span class="linenos">3216</span><span class="w">              </span><span class="n">BUFR_UNIT_PartPress</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_PartPress2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3217</span><span class="w">              </span><span class="n">BUFR_UNIT_DU</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_DU2</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_DU3</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_DU4</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3218</span><span class="w">              </span><span class="n">BUFR_UNIT_IntegND</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_IntegND2</span><span class="w"> </span><span class="o">/</span><span class="p">)</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3219</span><span class="k">		    </span>
<span class="linenos">3220</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;oopc_convertUnits: BUFR # &quot;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">))</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="s2">&quot; is not valid for PM&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">3221</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">3222</span><span class="w">        </span>
<span class="linenos">3223</span><span class="w">      </span><span class="c">! Conversion from ug/m^3 to ug/kg  (scaling by Rd*T/P)</span>
<span class="linenos">3224</span><span class="w">      </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MPC_RGAS_DRY_AIR_R8</span><span class="w"></span>
<span class="linenos">3225</span><span class="w">      </span><span class="n">exp_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_T</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="c">! multiply by T</span>
<span class="linenos">3226</span><span class="w">      </span><span class="n">exp_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_P</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c">! divide by P</span>
<span class="linenos">3227</span><span class="w">   </span>
<span class="linenos">3228</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;HU&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3229</span><span class="k">       </span>
<span class="linenos">3230</span><span class="k">      if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">incr_out</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3231</span><span class="w">        </span><span class="c">! Converts specific humidity (q) to mass mixing ratio mmr = q/(1-q)</span>
<span class="linenos">3232</span><span class="w">        </span><span class="n">model_col</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">model_col</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0d0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">model_col</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3233</span><span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="linenos">3234</span><span class="w">        </span><span class="c">! For conversion of q increment (dq) to mass mixing ratio increment (dmmr)</span>
<span class="linenos">3235</span><span class="w">        </span><span class="c">! dmmr = dq/(1-q)^2         </span>
<span class="linenos">3236</span><span class="w">        </span><span class="n">model_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_col</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0d0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">3237</span><span class="w">      </span><span class="k">end if</span><span class="w">  </span>
<span class="linenos">3238</span><span class="w">      </span><span class="c">! Conversion factor for kg/kg to ug/kg</span>
<span class="linenos">3239</span><span class="w">      </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d9</span><span class="w">      </span>
<span class="linenos">3240</span><span class="w">        </span>
<span class="linenos">3241</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">3242</span><span class="w">  </span>
<span class="linenos">3243</span><span class="w">    </span><span class="c">! Convert from ug/kg to desired unit if ppb_out = .false.</span>
<span class="linenos">3244</span>
<span class="linenos">3245</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">ppb_out</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3246</span><span class="k">      select case</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3247</span><span class="w">       </span>
<span class="linenos">3248</span><span class="w">      </span><span class="c">! The first four cases below are for integral observations which</span>
<span class="linenos">3249</span><span class="w">      </span><span class="c">! require a conversion, in this routine, from ug/kg to the units of </span>
<span class="linenos">3250</span><span class="w">      </span><span class="c">! the integrand values for integrals in pressure (Pascal). Comment C above.</span>
<span class="linenos">3251</span><span class="w">      </span><span class="c">! Note: 1 ug/kg = 1 ppb = 1E9 mmr (mass mixing ratio)</span>
<span class="linenos">3252</span><span class="w">      </span>
<span class="linenos">3253</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_IntegDens</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_IntegDens2</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_IntegDens3</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3254</span><span class="w">       </span>
<span class="linenos">3255</span><span class="w">        </span><span class="c">! For conversion from ug/kg to integrand values in kg/(m^2*Pa) </span>
<span class="linenos">3256</span><span class="w">        </span><span class="c">! Note: 1 kg/(m^2**Pa) = = 1 mmr / RG = 1E-9 ug/kg / RG </span>
<span class="linenos">3257</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3258</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-9</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ec_rg</span><span class="w"></span>
<span class="linenos">3259</span><span class="w">         </span>
<span class="linenos">3260</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_IntegMolarDens</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3261</span><span class="w">       </span>
<span class="linenos">3262</span><span class="w">        </span><span class="c">! For conversion from ug/kg to integrand values in moles/(m^2*Pa)</span>
<span class="linenos">3263</span><span class="w">        </span><span class="c">! Note: 1 moles/(m^2*Pa) = 1E-9 ug/kg / [RG * (1E-3 kg/g * m_gas)]</span>
<span class="linenos">3264</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3265</span><span class="w">        </span><span class="c">! To convert from kg/m^2 for the gas to moles/m^2, one must </span>
<span class="linenos">3266</span><span class="w">        </span><span class="c">! divide by the molar mass of the gas in kg/mole.</span>
<span class="linenos">3267</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3268</span><span class="w">        </span><span class="c">! Note: One u or Da (unified atomic mass unit or dalton) is numerically equivalent to 1 g/mole.</span>
<span class="linenos">3269</span><span class="w">        </span><span class="c">! So 1 kg is equivalent to (1E3/(atomic mass)) moles</span>
<span class="linenos">3270</span><span class="w">         </span>
<span class="linenos">3271</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-6</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">ec_rg</span><span class="o">*</span><span class="n">vnl_varMassFromVarNum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3272</span><span class="w">         </span>
<span class="linenos">3273</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_IntegND</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_IntegND2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3274</span><span class="w">         </span>
<span class="linenos">3275</span><span class="w">        </span><span class="c">! For conversion from ug/kg to integrand values in molecules/(m^2*Pa)</span>
<span class="linenos">3276</span><span class="w">        </span><span class="c">! Note: 1 molecule/(m^2*Pa) = 1E-9 ug/kg * Na / [RG * (1E-3 kg/g * m_gas)]</span>
<span class="linenos">3277</span><span class="w">        </span><span class="c">! </span>
<span class="linenos">3278</span><span class="w">        </span><span class="c">! To convert from kg/m^2 for the gas to molecules/m^2, one must </span>
<span class="linenos">3279</span><span class="w">        </span><span class="c">! divide by the gas molar mass (kg/mole) and multiply by the Avogrado number          </span>
<span class="linenos">3280</span>
<span class="linenos">3281</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MPC_AVOGADRO_R8</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3282</span><span class="w">                </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">ec_rg</span><span class="o">*</span><span class="n">vnl_varMassFromVarNum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3283</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_DU</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_DU2</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_DU3</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_DU4</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3284</span><span class="w">      </span>
<span class="linenos">3285</span><span class="w">        </span><span class="c">! For conversion from ug/kg to integrand values in DU/Pa</span>
<span class="linenos">3286</span><span class="w">        </span><span class="c">! Note: 1 DU/Pa =  1E-9 ug/kg / [RG * m_gas * rho_stp/m_air * 1E-5 m] </span>
<span class="linenos">3287</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3288</span><span class="w">        </span><span class="c">! 1 DU = 0.01 mm of gas at STP = 1E-5 m of gas at STP</span>
<span class="linenos">3289</span><span class="w">        </span><span class="c">!      = integral of gas number density at STP over 1E-5 m.</span>
<span class="linenos">3290</span><span class="w">        </span><span class="c">!      = Na*P/(RT) * 1E-5   at STP  (Na=Avogadro&#39;s number)</span>
<span class="linenos">3291</span><span class="w">        </span><span class="c">!      = Na*(molar density) * 1E-5   at STP</span>
<span class="linenos">3292</span><span class="w">        </span><span class="c">!      = Na*rho(STP)/(molar mass) * 1E-5 m</span>
<span class="linenos">3293</span><span class="w">        </span><span class="c">!      = integral of air number density at STP over 1E-5 m.</span>
<span class="linenos">3294</span><span class="w">        </span><span class="c">!      = Na*rho(air,STP)/m_air * 1.E-5 m</span>
<span class="linenos">3295</span><span class="w">        </span><span class="c">!               </span>
<span class="linenos">3296</span><span class="w">        </span><span class="c">! Hence 1 DU equivalent to Na*rho_stp/m_air * 1E-5 m (= 2.69E20 molecules/m^2)</span>
<span class="linenos">3297</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3298</span><span class="w">        </span><span class="c">! To convert from kg/m^2 for the gas to molecules/m^2, one must </span>
<span class="linenos">3299</span><span class="w">        </span><span class="c">! divide by the gas molar mass (kg/mole) and multiply by the Avogrado number </span>
<span class="linenos">3300</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3301</span><span class="w">        </span><span class="c">! To convert from molecules/m^2 to DU, one must divide by 2.69E20 or (Na*rho_stp/m_air * 1E-5).</span>
<span class="linenos">3302</span><span class="w">        </span><span class="c">! So for conversion from kg/m^2 to DU, must divide by (m_gas*rho_stp/m_air * 1E-5)       </span>
<span class="linenos">3303</span><span class="w">        </span>
<span class="linenos">3304</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MPC_MOLAR_MASS_DRY_AIR_R8</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3305</span><span class="w">                </span><span class="o">/</span><span class="p">(</span><span class="n">vnl_varMassFromVarNum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">)</span><span class="o">*</span><span class="n">ec_rg</span><span class="o">*</span><span class="n">rho_stp</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3306</span><span class="w">        </span>
<span class="linenos">3307</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_Density</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_Density2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3308</span><span class="w">           </span><span class="n">BUFR_UNIT_AirDensity</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_PMDensity</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3309</span>
<span class="linenos">3310</span><span class="w">        </span><span class="c">! For conversion from ug/kg to kg/m^3</span>
<span class="linenos">3311</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3312</span><span class="w">        </span><span class="c">! rho(gas) = mass mixing ratio * rho(air) = mass mixing ratio * P/Rd/T</span>
<span class="linenos">3313</span><span class="w">          </span>
<span class="linenos">3314</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-9</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">MPC_RGAS_DRY_AIR_R8</span><span class="w"></span>
<span class="linenos">3315</span><span class="w">        </span><span class="n">exp_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_T</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c">! divide by T</span>
<span class="linenos">3316</span><span class="w">        </span><span class="n">exp_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_P</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="c">! multiply by P</span>
<span class="linenos">3317</span><span class="w">          </span>
<span class="linenos">3318</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_MMR</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_MMR2</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3319</span>
<span class="linenos">3320</span><span class="w">        </span><span class="c">! For conversion from ug/kg to kg/kg</span>
<span class="linenos">3321</span><span class="w">     </span>
<span class="linenos">3322</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-9</span><span class="w"> </span>
<span class="linenos">3323</span><span class="w">     </span>
<span class="linenos">3324</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_PartPress</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_PartPress2</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3325</span><span class="w">     </span>
<span class="linenos">3326</span><span class="w">        </span><span class="c">! For conversion from ug/kg to partial pressure (PA)</span>
<span class="linenos">3327</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3328</span><span class="w">        </span><span class="c">! parial pressure = P * vmr</span>
<span class="linenos">3329</span><span class="w">        </span><span class="c">!                 = P * m_air/m_gas * mass mixing ratio</span>
<span class="linenos">3330</span><span class="w">         </span>
<span class="linenos">3331</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MPC_MOLAR_MASS_DRY_AIR_R8</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3332</span><span class="w">                </span><span class="o">/</span><span class="n">vnl_varMassFromVarNum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3333</span><span class="w">        </span><span class="n">exp_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_P</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="c">! multiply by P</span>
<span class="linenos">3334</span>
<span class="linenos">3335</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_NumberDensity</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3336</span><span class="w">          </span>
<span class="linenos">3337</span><span class="w">        </span><span class="c">! For conversion from ug/kg to molecules/m^3</span>
<span class="linenos">3338</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3339</span><span class="w">        </span><span class="c">! Number density of gas = Na*rho(gas)/m_gas = Na*rho(air) * mass mixing ratio /m_gas</span>
<span class="linenos">3340</span><span class="w">        </span><span class="c">!                       = Na * P/Rd/T * mass mixing ratio /m_gas</span>
<span class="linenos">3341</span><span class="w">        </span>
<span class="linenos">3342</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-6</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MPC_AVOGADRO_R8</span><span class="o">/</span><span class="n">MPC_RGAS_DRY_AIR_R8</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3343</span><span class="w">                </span><span class="o">/</span><span class="n">vnl_varMassFromVarNum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3344</span><span class="w">        </span><span class="n">exp_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_T</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c">! divide by T</span>
<span class="linenos">3345</span><span class="w">        </span><span class="n">exp_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_P</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="c">! multiply by P</span>
<span class="linenos">3346</span>
<span class="linenos">3347</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_MolarDensity</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3348</span><span class="w">          </span>
<span class="linenos">3349</span><span class="w">        </span><span class="c">! For conversion from ug/kg to moles/m^3</span>
<span class="linenos">3350</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3351</span><span class="w">        </span><span class="c">! Mole density of gas = rho(gas)/m_gas = rho(air) * mass mixing ratio /m_gas</span>
<span class="linenos">3352</span><span class="w">        </span><span class="c">!                       = P/Rd/T * mass mixing ratio /m_gas</span>
<span class="linenos">3353</span>
<span class="linenos">3354</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-6</span><span class="w"> </span><span class="o">/</span><span class="n">MPC_RGAS_DRY_AIR_R8</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3355</span><span class="w">                </span><span class="o">/</span><span class="n">vnl_varMassFromVarNum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3356</span><span class="w">        </span><span class="n">exp_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_T</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c">! divide by T</span>
<span class="linenos">3357</span><span class="w">        </span><span class="n">exp_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exp_P</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="c">! multiply by P</span>
<span class="linenos">3358</span>
<span class="linenos">3359</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_VMR</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_VMR2</span><span class="p">,</span><span class="w"> </span><span class="n">BUFR_UNIT_MolePerMole</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3360</span><span class="w">           </span><span class="n">BUFR_UNIT_MolePerMole2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3361</span><span class="w">          </span>
<span class="linenos">3362</span><span class="w">        </span><span class="c">! For conversion from ug/kg to vmr (or moles/mole)</span>
<span class="linenos">3363</span><span class="w">          </span>
<span class="linenos">3364</span><span class="w">        </span><span class="n">zcoef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zcoef</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0d-9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MPC_MOLAR_MASS_DRY_AIR_R8</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3365</span><span class="w">                </span><span class="o">/</span><span class="n">vnl_varMassFromVarNum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3366</span>
<span class="linenos">3367</span><span class="w">      </span><span class="k">case </span><span class="n">default</span><span class="w"> </span>
<span class="linenos">3368</span><span class="w">        </span>
<span class="linenos">3369</span><span class="w">        </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_convertUnits: Unknown obs units &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3370</span><span class="w">	               </span><span class="s1">&#39;for varno = &#39;</span><span class="w"> </span><span class="o">//</span><span class="w">  </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varno</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">3371</span><span class="w">         </span>
<span class="linenos">3372</span><span class="w">      </span><span class="k">end select</span>
<span class="linenos">3373</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">3374</span><span class="w">  </span>
<span class="linenos">3375</span><span class="w">    </span><span class="c">! Apply constant scaling</span>
<span class="linenos">3376</span><span class="w">    </span><span class="n">model_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">zcoef</span><span class="w"></span>
<span class="linenos">3377</span><span class="w">    </span>
<span class="linenos">3378</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exp_T</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3379</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3380</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;oopc_convertUnits: &quot;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3381</span><span class="w">                       </span><span class="s2">&quot;Missing valid temperature for conversion.&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3382</span><span class="w">      </span><span class="k">end if	  </span>
<span class="linenos">3383</span><span class="k">      </span><span class="n">model_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">tt</span><span class="o">**</span><span class="n">exp_T</span><span class="w"></span>
<span class="linenos">3384</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">3385</span><span class="k">    </span>
<span class="linenos">3386</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">exp_P</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">model_col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model_col</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="o">**</span><span class="n">exp_P</span><span class="w"></span>
<span class="linenos">3387</span><span class="w">    </span>
<span class="linenos">3388</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_convertUnits</span><span class="w"></span>
<span class="linenos">3389</span>
<span class="linenos">3390</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3391</span><span class="w">  </span><span class="c">! oopc_required_field</span>
<span class="linenos">3392</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3393</span><span class="w">  </span><span class="k">function </span><span class="n">oopc_required_field</span><span class="p">(</span><span class="n">varName</span><span class="p">,</span><span class="n">varno</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">needed</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3394</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3395</span><span class="w">    </span><span class="c">!:Purpose: To determine whether the specifed field name is required</span>
<span class="linenos">3396</span><span class="w">    </span><span class="c">!          somewhere in the observation operators for a particular</span>
<span class="linenos">3397</span><span class="w">    </span><span class="c">!          observation type.</span>
<span class="linenos">3398</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3399</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">3400</span><span class="k">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">needed</span><span class="w"></span>
<span class="linenos">3401</span>
<span class="linenos">3402</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">3403</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varName</span><span class="w"> </span><span class="c">! Name of field</span>
<span class="linenos">3404</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w">          </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varno</span><span class="w">   </span><span class="c">! BUFR descriptor element</span>
<span class="linenos">3405</span>
<span class="linenos">3406</span><span class="w">    </span><span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">varName</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3407</span><span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="s1">&#39;TT&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3408</span><span class="w"> </span>
<span class="linenos">3409</span><span class="w">      </span><span class="k">select case</span><span class="w"> </span><span class="p">(</span><span class="n">varno</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3410</span><span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">BUFR_UNIT_Density</span><span class="p">,</span><span class="n">BUFR_UNIT_Density2</span><span class="p">,</span><span class="n">BUFR_UNIT_AirDensity</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3411</span><span class="w">           </span><span class="n">BUFR_UNIT_PMDensity</span><span class="p">,</span><span class="n">BUFR_UNIT_NumberDensity</span><span class="p">,</span><span class="n">BUFR_UNIT_MolarDensity</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3412</span><span class="w">        </span><span class="n">needed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3413</span><span class="w">      </span><span class="k">case </span><span class="n">default</span><span class="w"></span>
<span class="linenos">3414</span><span class="w">        </span><span class="n">needed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3415</span><span class="w">      </span><span class="k">end select</span>
<span class="linenos">3416</span><span class="k">         </span>
<span class="linenos">3417</span><span class="k">    case </span><span class="n">default</span><span class="w"></span>
<span class="linenos">3418</span><span class="w">      </span><span class="n">needed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3419</span><span class="w">    </span><span class="k">end select</span>
<span class="linenos">3420</span>
<span class="linenos">3421</span><span class="k">  end function </span><span class="n">oopc_required_field</span><span class="w"></span>
<span class="linenos">3422</span>
<span class="linenos">3423</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3424</span><span class="w">  </span><span class="c">! oopc_vertObsLayersWgts</span>
<span class="linenos">3425</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3426</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_vertObsLayersWgts</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span><span class="n">ixtr</span><span class="p">,</span><span class="n">success</span><span class="p">,</span><span class="n">kmode</span><span class="p">,</span><span class="n">skipType</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3427</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3428</span><span class="w">    </span><span class="c">!:Purpose: To calculate integration (or averaging) weights &quot;wgts&quot; required for vertical </span>
<span class="linenos">3429</span><span class="w">    </span><span class="c">!          integration (or averaging) for the full vertical range or a set of target layers. </span>
<span class="linenos">3430</span><span class="w">    </span><span class="c">!          Given the calculated weights and a user input array vector X, the integral </span>
<span class="linenos">3431</span><span class="w">    </span><span class="c">!          (or average) for a given layer i would be given by sum(wgts(i,:)*X(:))</span>
<span class="linenos">3432</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3433</span><span class="w">    </span><span class="c">!:Arguments:</span>
<span class="linenos">3434</span><span class="w">    </span><span class="c">!     :operator:    Operator type: &#39;integ&#39; or &#39;avg&#39;</span>
<span class="linenos">3435</span><span class="w">    </span><span class="c">!     :ixtr:        Flag indicating if obs outside model vertical range: 0 for no.</span>
<span class="linenos">3436</span><span class="w">    </span><span class="c">!     :successs:    Success of integration (or averaging)</span>
<span class="linenos">3437</span><span class="w">    </span><span class="c">!     :kmode:       Observation model stage used to allow option of tropo</span>
<span class="linenos">3438</span><span class="w">    </span><span class="c">!                   increment determination from total (or avg) column data when</span>
<span class="linenos">3439</span><span class="w">    </span><span class="c">!                   obsoper%columnBound &gt; obsoper%vlayertop for</span>
<span class="linenos">3440</span><span class="w">    </span><span class="c">!                   nobslev=1. For kmode=3, calc only for region between</span>
<span class="linenos">3441</span><span class="w">    </span><span class="c">!                   obsoper%columnBound and surface. For kmode=2, split</span>
<span class="linenos">3442</span><span class="w">    </span><span class="c">!                   calc for model top to obsoper%columnBound and </span>
<span class="linenos">3443</span><span class="w">    </span><span class="c">!                   obsoper%columnBound and surface.</span>
<span class="linenos">3444</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3445</span><span class="w">    </span><span class="c">!     :skipType:    Skipping processing of specific target layers depending on case:</span>
<span class="linenos">3446</span><span class="w">    </span><span class="c">!                   &#39;default&#39; - skipping application via input success_opt only</span>
<span class="linenos">3447</span><span class="w">    </span><span class="c">!                   &#39;doAll&amp;noExtrap&#39; - application of both success_opt and outbound_opt</span>
<span class="linenos">3448</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3449</span><span class="w">    </span>
<span class="linenos">3450</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">3451</span>
<span class="linenos">3452</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">3453</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ixtr</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="c">! Flag indicating if obs outside model vertical range: 0 for no.</span>
<span class="linenos">3454</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="w"> </span><span class="c">! success of integration (or averaging)</span>
<span class="linenos">3455</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="c">! Mode of observation operator </span>
<span class="linenos">3456</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">operator</span><span class="w"> </span><span class="c">! Operator type: &#39;integ&#39; or &#39;avg&#39;</span>
<span class="linenos">3457</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skipType</span><span class="w"> </span><span class="c">! Skipping processing of specific target layers depending on case</span>
<span class="linenos">3458</span>
<span class="linenos">3459</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">3460</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">tropo_mode</span><span class="w"></span>
<span class="linenos">3461</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vlayertop_ref</span><span class="p">,</span><span class="n">vlayerbottom_ref</span><span class="p">,</span><span class="n">modlevindexBot_ref</span><span class="p">,</span><span class="n">checkID</span><span class="w"></span>
<span class="linenos">3462</span><span class="w">    </span>
<span class="linenos">3463</span><span class="w">    </span><span class="c">! Conduct initial setup for vertical integration (or avegaging) components</span>
<span class="linenos">3464</span>
<span class="linenos">3465</span><span class="w">    </span><span class="k">call </span><span class="n">ppo_vertLayersSetup</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3466</span>
<span class="linenos">3467</span><span class="w">    </span><span class="c">! Ensure that each layer is within model vertical range.</span>
<span class="linenos">3468</span><span class="w">    </span>
<span class="linenos">3469</span><span class="w">    </span><span class="k">do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos">3470</span><span class="w">    </span>
<span class="linenos">3471</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3472</span><span class="k">        </span><span class="n">success</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">)</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3473</span><span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;oopc_vertObsLayersWgts: WARNING. &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3474</span><span class="w">	          </span><span class="s1">&#39;Layer top/bot value problem.&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3475</span><span class="w">                   </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3476</span><span class="w">		   </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3477</span><span class="w">                   </span><span class="s1">&#39;. Entire profile skipped over.&#39;</span><span class="w"></span>
<span class="linenos">3478</span><span class="w">        </span><span class="k">return</span>
<span class="linenos">3479</span><span class="k">      else if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.01</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w">  </span>
<span class="linenos">3480</span><span class="w">               </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">*</span><span class="mf">0.99</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3481</span>
<span class="linenos">3482</span><span class="k">        </span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3483</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.01</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3484</span><span class="k">           </span><span class="n">ixtr</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3485</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">3486</span><span class="k">           </span><span class="n">ixtr</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">3487</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">3488</span><span class="k">        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;oopc_vertObsLayersWgts: WARNING. Layer top/bot value problem.&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3489</span><span class="w">             </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3490</span><span class="w">        </span><span class="k">cycle</span>
<span class="linenos">3491</span><span class="k">      end if</span>
<span class="linenos">3492</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3493</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">*</span><span class="mf">0.999</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3494</span><span class="k">	   </span>
<span class="linenos">3495</span><span class="k">	 </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">*</span><span class="mf">0.999</span><span class="w"></span>
<span class="linenos">3496</span>
<span class="linenos">3497</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">3498</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.001</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3499</span><span class="k">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.001</span><span class="w"></span>
<span class="linenos">3500</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">3501</span><span class="k">      </span>
<span class="linenos">3502</span><span class="k">    end do</span>
<span class="linenos">3503</span>
<span class="linenos">3504</span><span class="k">    </span><span class="n">tropo_mode</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3505</span><span class="w">    </span>
<span class="linenos">3506</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;integ&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3507</span><span class="w">        </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">*</span><span class="mf">0.99</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3508</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3509</span><span class="w">       </span>
<span class="linenos">3510</span><span class="w">      </span><span class="c">! Check if constituent id is recognized (function will abort if not recognized)</span>
<span class="linenos">3511</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3512</span><span class="k">        </span><span class="n">checkID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vnl_varMassFromVarnum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3513</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">3514</span><span class="k">       </span>
<span class="linenos">3515</span><span class="k">      </span><span class="n">vlayerbottom_ref</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3516</span>
<span class="linenos">3517</span><span class="w">      </span><span class="c">! Check for special treatment if tropo_mode&gt;=1, kmode=2,3, and nobslev=1 for</span>
<span class="linenos">3518</span><span class="w">      </span><span class="c">! column observations (obsoper%vco=4)  that extend to the surface.</span>
<span class="linenos">3519</span>
<span class="linenos">3520</span><span class="w">      </span><span class="n">tropo_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_tropo_mode</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3521</span><span class="w">       </span>
<span class="linenos">3522</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tropo_mode</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3523</span><span class="k">          </span>
<span class="linenos">3524</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">iavgkern</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3525</span><span class="k">          call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;oopc_vertObsLayersWgts: Use of averaging &#39; // &amp; </span>
<span class="linenos">3526</span><span class="s2">	       &#39;kernels not possible with reduced range of increment profile.&quot;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3527</span><span class="w">	</span><span class="k">end if</span>
<span class="linenos">3528</span><span class="k">          </span>
<span class="linenos">3529</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">tropo_mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3530</span><span class="w">             </span>
<span class="linenos">3531</span><span class="w">          </span><span class="c">! When kmode=2, split calc in two. This is done due to difference in </span>
<span class="linenos">3532</span><span class="w">          </span><span class="c">! calc at the interface region when producing zh and zhp. The tangent linear</span>
<span class="linenos">3533</span><span class="w">          </span><span class="c">! model in the lower region for kmode=2 must be consistent with </span>
<span class="linenos">3534</span><span class="w">          </span><span class="c">! that associated with kmode=3.</span>
<span class="linenos">3535</span><span class="w">             </span>
<span class="linenos">3536</span><span class="w">          </span><span class="c">! Start with bottom region in order to use correct zhp with oopc_genOper</span>
<span class="linenos">3537</span><span class="w">          </span><span class="c">! when use of this operator is requested.</span>
<span class="linenos">3538</span><span class="w">           </span>
<span class="linenos">3539</span><span class="w">          </span><span class="n">vlayertop_ref</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3540</span><span class="w">             </span>
<span class="linenos">3541</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"></span>
<span class="linenos">3542</span><span class="w">             </span>
<span class="linenos">3543</span><span class="w">          </span><span class="k">call </span><span class="n">ppo_vertIntegWgts</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3544</span><span class="w">	       </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3545</span><span class="w">               </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">,</span><span class="n">wgts_opt</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3546</span><span class="w">               </span><span class="n">skipType_opt</span><span class="o">=</span><span class="n">skipType</span><span class="p">,</span><span class="n">outbound_opt</span><span class="o">=</span><span class="n">ixtr</span><span class="p">,</span><span class="n">success_opt</span><span class="o">=</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3547</span><span class="w">	       	 </span>
<span class="linenos">3548</span><span class="w">          </span><span class="c">! Apply generalized innovation operator if requested             </span>
<span class="linenos">3549</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">oopc_genoper</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3550</span><span class="w">            </span>
<span class="linenos">3551</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">applyGenOper</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">3552</span><span class="w">             </span>
<span class="linenos">3553</span><span class="w">          </span><span class="n">modlevindexBot_ref</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3554</span><span class="w">             </span>
<span class="linenos">3555</span><span class="w">          </span><span class="c">! Reset top and bottom values for integration (or averaging) of the remaining region.</span>
<span class="linenos">3556</span><span class="w">          </span><span class="c">! The second integration (or averaging) provides the change in upper level contributions to the</span>
<span class="linenos">3557</span><span class="w">          </span><span class="c">! total column (or average) from the assimilation of other observations.</span>
<span class="linenos">3558</span><span class="w">             </span>
<span class="linenos">3559</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">vlayertop_ref</span><span class="w"></span>
<span class="linenos">3560</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"></span>
<span class="linenos">3561</span><span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="linenos">3562</span><span class="w">          </span><span class="c">! Reset top new value. Restricts adjoint/tangent linear calcs to this reduced region.            </span>
<span class="linenos">3563</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"></span>
<span class="linenos">3564</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">3565</span><span class="k">          </span>
<span class="linenos">3566</span><span class="k">      end if</span>
<span class="linenos">3567</span><span class="k">    else</span>
<span class="linenos">3568</span><span class="k">      </span><span class="n">vlayerbottom_ref</span><span class="o">=</span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos">3569</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">3570</span><span class="w">    </span>
<span class="linenos">3571</span><span class="w">    </span><span class="c">! Calculate vertical integration (or averaging) components for specified obs layer(s).</span>
<span class="linenos">3572</span>
<span class="linenos">3573</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">operator</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;integ&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then </span>
<span class="linenos">3574</span><span class="k">           </span>
<span class="linenos">3575</span><span class="k">      call </span><span class="n">ppo_vertIntegWgts</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3576</span><span class="w">           </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3577</span><span class="w">	   </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">,</span><span class="n">wgts_opt</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3578</span><span class="w">           </span><span class="n">skipType_opt</span><span class="o">=</span><span class="n">skipType</span><span class="p">,</span><span class="n">outbound_opt</span><span class="o">=</span><span class="n">ixtr</span><span class="p">,</span><span class="n">success_opt</span><span class="o">=</span><span class="n">success</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3579</span><span class="w">	   </span><span class="n">dealloc_opt</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">3580</span><span class="w">			      </span>
<span class="linenos">3581</span><span class="w">      </span><span class="c">! If tropo_mode=1, reset original vertical range </span>
<span class="linenos">3582</span><span class="w">      </span><span class="c">! for the tangent linear operator </span>
<span class="linenos">3583</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3584</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vco</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3585</span><span class="k">	</span>
<span class="linenos">3586</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">tropo_mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3587</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">columnBound</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3588</span><span class="w">          </span><span class="n">vlayerbottom_ref</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">pp</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">*</span><span class="mf">0.99</span><span class="p">)</span><span class="w"> </span><span class="k">then    </span>
<span class="linenos">3589</span><span class="k">          </span>
<span class="linenos">3590</span><span class="k">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">vlayerbottom_ref</span><span class="w"></span>
<span class="linenos">3591</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">modlevindexBot_ref</span><span class="w"></span>
<span class="linenos">3592</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">3593</span><span class="k">      end if</span>
<span class="linenos">3594</span><span class="k">    else</span>
<span class="linenos">3595</span><span class="k">    </span>
<span class="linenos">3596</span><span class="k">      call </span><span class="n">ppo_vertAvgWgts</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayertop</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">vlayerbottom</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3597</span><span class="w">           </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3598</span><span class="w">	   </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">,</span><span class="n">wgts_opt</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3599</span><span class="w">           </span><span class="n">skipType_opt</span><span class="o">=</span><span class="n">skipType</span><span class="p">,</span><span class="n">outbound_opt</span><span class="o">=</span><span class="n">ixtr</span><span class="p">,</span><span class="n">success_opt</span><span class="o">=</span><span class="n">success</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3600</span><span class="w">	   </span><span class="n">dealloc_opt</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span><span class="w"></span>
<span class="linenos">3601</span><span class="w">			   </span>
<span class="linenos">3602</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">3603</span><span class="k">        </span>
<span class="linenos">3604</span><span class="k">  end subroutine </span><span class="n">oopc_vertObsLayersWgts</span><span class="w"></span>
<span class="linenos">3605</span>
<span class="linenos">3606</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3607</span><span class="w">  </span><span class="c">! oopc_genOper</span>
<span class="linenos">3608</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3609</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_genOper</span><span class="p">(</span><span class="n">kmode</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3610</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3611</span><span class="w">    </span><span class="c">!:Purpose: Set generalized innovation operator for integral or layer avg</span>
<span class="linenos">3612</span><span class="w">    </span><span class="c">!          obs. Relevant only for incremental fields. This version is</span>
<span class="linenos">3613</span><span class="w">    </span><span class="c">!          intended to vertically distribute (approximately) the obs increments</span>
<span class="linenos">3614</span><span class="w">    </span><span class="c">!          proportionally to the (a) background state or (b) the differences</span>
<span class="linenos">3615</span><span class="w">    </span><span class="c">!          between a reference/climatological state and the background state.</span>
<span class="linenos">3616</span><span class="w">    </span><span class="c">!          Option (b) is recommended for a spinup period when the shape of the</span>
<span class="linenos">3617</span><span class="w">    </span><span class="c">!          background state is not physically representative. This is to force</span>
<span class="linenos">3618</span><span class="w">    </span><span class="c">!          the analysis shape toward the reference/climatology shape in the absence</span>
<span class="linenos">3619</span><span class="w">    </span><span class="c">!          of local profiles observations.</span>
<span class="linenos">3620</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3621</span><span class="w">    </span><span class="c">!:Input:</span>
<span class="linenos">3622</span><span class="w">    </span><span class="c">!       :kmode:              index indicating if the operator is to be applied             </span>
<span class="linenos">3623</span><span class="w">    </span><span class="c">!       :obsoper%zh,zhp:     see routine ppo_vertIntegSetup</span>
<span class="linenos">3624</span><span class="w">    </span><span class="c">!       :oopc_genOperConstraintType: index specifying the reference state</span>
<span class="linenos">3625</span><span class="w">    </span><span class="c">!       :oopc_genOperhCorrlenExpnt:  Exponent for horiz. correl. length weighting</span>
<span class="linenos">3626</span><span class="w">    </span><span class="c">!       :oopc_genOperOmaStatsFactor: Additional OmAStats normalization factor</span>
<span class="linenos">3627</span><span class="w">    </span><span class="c">!       :bgStats:            structure containing the background stats data</span>
<span class="linenos">3628</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3629</span><span class="w">    </span><span class="c">!:Output:</span>
<span class="linenos">3630</span><span class="w">    </span><span class="c">!       :obsoper%zh(obsoper%nmodlev):     a*w: Final innovation model array</span>
<span class="linenos">3631</span><span class="w">    </span><span class="c">!                                         (other than conversion constants)</span>
<span class="linenos">3632</span><span class="w">    </span><span class="c">!       :obsoper%zhp(obsoper%nmodlev):    w (see comments section)</span>
<span class="linenos">3633</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3634</span><span class="w">    </span><span class="c">! Comments:</span>
<span class="linenos">3635</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3636</span><span class="w">    </span><span class="c">!      (1) This routine prepares an alternative innovation operator g,</span>
<span class="linenos">3637</span><span class="w">    </span><span class="c">!          called the generalized innovation operator, to take the place of</span>
<span class="linenos">3638</span><span class="w">    </span><span class="c">!          the innovation (TLM) operator h (row of zh). The operator g is</span>
<span class="linenos">3639</span><span class="w">    </span><span class="c">!          specified as:</span>
<span class="linenos">3640</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3641</span><span class="w">    </span><span class="c">!             g = a*w</span>
<span class="linenos">3642</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3643</span><span class="w">    </span><span class="c">!          where the innovation weight operator &#39;w&#39; can be set as, </span>
<span class="linenos">3644</span><span class="w">    </span><span class="c">!          for the 1D case,</span>
<span class="linenos">3645</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3646</span><span class="w">    </span><span class="c">!             w = P[ (h&#39;x)^T ] *  B^{-1}     </span>
<span class="linenos">3647</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3648</span><span class="w">    </span><span class="c">!          with  h&#39; is the part of h which excludes resolution dependence</span>
<span class="linenos">3649</span><span class="w">    </span><span class="c">!          (only/mostly contains the physics part of h; zhp),</span>
<span class="linenos">3650</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3651</span><span class="w">    </span><span class="c">!            - x is the state profile rval</span>
<span class="linenos">3652</span><span class="w">    </span><span class="c">!            - P is a window cutoff operator (sets small values to zero)</span>
<span class="linenos">3653</span><span class="w">    </span><span class="c">!            - B is the original/initial total &quot;vertical&quot; covariance matrix</span>
<span class="linenos">3654</span><span class="w">    </span><span class="c">!              (2D)</span>
<span class="linenos">3655</span><span class="w">    </span><span class="c">!          </span>
<span class="linenos">3656</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3657</span><span class="w">    </span><span class="c">!          and &#39;a&#39; is a proportionality constant ensuring that the</span>
<span class="linenos">3658</span><span class="w">    </span><span class="c">!          innovation increment remains unchanged for the 1D case in the</span>
<span class="linenos">3659</span><span class="w">    </span><span class="c">!          absence of other obs., i.e.,</span>
<span class="linenos">3660</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3661</span><span class="w">    </span><span class="c">!                  a^2 = (h*B*h^T)(w*B*w^T)^{-1},</span>
<span class="linenos">3662</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3663</span><span class="w">    </span><span class="c">!          Application of the state profile x (rval) is to make the</span>
<span class="linenos">3664</span><span class="w">    </span><span class="c">!          increment profile be more proportional to the state profile.</span>
<span class="linenos">3665</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3666</span><span class="w">    </span><span class="c">!          The presence of B^{-1} is to negate the weight re-distribution</span>
<span class="linenos">3667</span><span class="w">    </span><span class="c">!          from the later application of B in grad(Jo). Its specification</span>
<span class="linenos">3668</span><span class="w">    </span><span class="c">!          is approximate to reduce the effect of numerical error in the </span>
<span class="linenos">3669</span><span class="w">    </span><span class="c">!          generating the inverse of B.</span>
<span class="linenos">3670</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3671</span><span class="w">    </span><span class="c">!          A scaling by the 1/bgStats%hcorrlen^q profile is addded to </span>
<span class="linenos">3672</span><span class="w">    </span><span class="c">!          partially mitigate effect of the variation in the vertical </span>
<span class="linenos">3673</span><span class="w">    </span><span class="c">!          of the influence of neighbouring obs via background horizontal </span>
<span class="linenos">3674</span><span class="w">    </span><span class="c">!          error correlations. </span>
<span class="linenos">3675</span><span class="w">    </span><span class="c">!   </span>
<span class="linenos">3676</span><span class="w">    </span><span class="c">!          The specification of the q value is to roughly give (a) a more </span>
<span class="linenos">3677</span><span class="w">    </span><span class="c">!          constant-like increment in the absence of the trial profile form </span>
<span class="linenos">3678</span><span class="w">    </span><span class="c">!          constraint and (b), in the presence of the form constraint, a </span>
<span class="linenos">3679</span><span class="w">    </span><span class="c">!          better match of the max increment level to the max concentration</span>
<span class="linenos">3680</span><span class="w">    </span><span class="c">!          level. </span>
<span class="linenos">3681</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3682</span><span class="w">    </span><span class="c">!          As the horizontal density of obs is somewhat variable</span>
<span class="linenos">3683</span><span class="w">    </span><span class="c">!          and not known locally, the specified q value is not optimal for each</span>
<span class="linenos">3684</span><span class="w">    </span><span class="c">!          individual case but better than not applying any related mitigation.</span>
<span class="linenos">3685</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3686</span><span class="w">    </span><span class="c">!      (2) The matrix B is the total error covariance matrix (in physical space)</span>
<span class="linenos">3687</span><span class="w">    </span><span class="c">!          with the related error correlation matrix</span>
<span class="linenos">3688</span><span class="w">    </span><span class="c">!          *corvert* and std dev provided from *bCovarSetupChem_mod.ftn90*.</span>
<span class="linenos">3689</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">3690</span><span class="w">    </span><span class="c">!      (3) NOTE: Cases with ensemble-based and or lam-based background</span>
<span class="linenos">3691</span><span class="w">    </span><span class="c">!          covariances are not taken into account in this version.</span>
<span class="linenos">3692</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3693</span><span class="w">    </span>
<span class="linenos">3694</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">3695</span>
<span class="linenos">3696</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">3697</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">kmode</span><span class="w"> </span><span class="c">! Index specifying if content to be applied (i.e. if kmode&gt;1)</span>
<span class="linenos">3698</span>
<span class="linenos">3699</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">3700</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pwin</span><span class="o">=</span><span class="mf">0.01</span><span class="w"></span>
<span class="linenos">3701</span><span class="w">    </span><span class="kt">integer</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">modlevIndex</span><span class="p">,</span><span class="n">irmse</span><span class="p">,</span><span class="n">varIndex</span><span class="w"></span>
<span class="linenos">3702</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">zwbw</span><span class="p">,</span><span class="n">zhbh</span><span class="p">,</span><span class="n">za</span><span class="p">,</span><span class="n">work</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">),</span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3703</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">threshold</span><span class="o">=</span><span class="mf">1.D-20</span><span class="w"></span>
<span class="linenos">3704</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">zmin</span><span class="p">,</span><span class="n">rvalw</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">),</span><span class="n">rvalr</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3705</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">rvalc</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">),</span><span class="n">rmse</span><span class="w"></span>
<span class="linenos">3706</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">code</span><span class="w"></span>
<span class="linenos">3707</span><span class="w">   </span>
<span class="linenos">3708</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kmode</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"></span>
<span class="linenos">3709</span>
<span class="linenos">3710</span><span class="w">    </span><span class="c">! Retrieve from stored background error std dev [elemements (:,1-2)] at obs location [and inverses at elements (:,3-4)]    </span>
<span class="linenos">3711</span><span class="w">    </span><span class="n">fdeStddev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bcsc_retrieveBgStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">obs_index</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3712</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3713</span><span class="w">      </span><span class="c">! To mitigate combined effects of approximations in expressions below and </span>
<span class="linenos">3714</span><span class="w">      </span><span class="c">! the forced strong reduction of fdeStddev(:,1) in the top level(s) of the</span>
<span class="linenos">3715</span><span class="w">      </span><span class="c">! model. Bkgd ozone error std dev was set to near zero at the lid. The</span>
<span class="linenos">3716</span><span class="w">      </span><span class="c">! absence of a resettting such as below would otherwise</span>
<span class="linenos">3717</span><span class="w">      </span><span class="c">! lead to oscillatory numerical error effects in the first few levels.</span>
<span class="linenos">3718</span><span class="w">      </span><span class="c">! This change will still force a near-zero (small) increment at the lid.</span>
<span class="linenos">3719</span><span class="w">      </span><span class="n">fdeStddev</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdeStddev</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3720</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">3721</span><span class="w">    </span>
<span class="linenos">3722</span><span class="w">    </span><span class="c">! Identify variable position index in background error correlation matrices</span>
<span class="linenos">3723</span><span class="w">   </span>
<span class="linenos">3724</span><span class="w">    </span><span class="n">varIndex</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3725</span><span class="w">    </span><span class="k">do while</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">bgStats</span><span class="p">%</span><span class="n">varNameList</span><span class="p">(</span><span class="n">varIndex</span><span class="p">))</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3726</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">bgStats</span><span class="p">%</span><span class="n">varNameList</span><span class="p">(</span><span class="n">varIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">3727</span><span class="k">      </span><span class="n">varIndex</span><span class="o">=</span><span class="n">varIndex</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3728</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">3729</span>
<span class="linenos">3730</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">bgStats</span><span class="p">%</span><span class="n">varNameList</span><span class="p">(</span><span class="n">varIndex</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3731</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_genOper: Background stats not found for &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3732</span><span class="w">                     </span><span class="nb">trim</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">varName</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">3733</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">3734</span><span class="w">    </span>
<span class="linenos">3735</span><span class="w">    </span><span class="c">! Initialize reference mass (mixing ratio) weighting profile as profile from trial field</span>
<span class="linenos">3736</span><span class="w">     </span>
<span class="linenos">3737</span><span class="w">    </span><span class="n">rvalr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3738</span><span class="w">    </span>
<span class="linenos">3739</span><span class="w">    </span><span class="c">! Check on rvalr</span>
<span class="linenos">3740</span><span class="w">            </span>
<span class="linenos">3741</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalr</span><span class="p">(:))</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">threshold</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3742</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="k">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalr</span><span class="p">(:))</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">threshold</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3743</span><span class="k">        </span><span class="n">rvalr</span><span class="p">(:)</span><span class="o">=</span><span class="mf">1.0</span><span class="w"> </span>
<span class="linenos">3744</span><span class="w">      </span><span class="k">else  </span>
<span class="linenos">3745</span><span class="k">        </span><span class="n">zmin</span><span class="o">=</span><span class="nb">minval</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalr</span><span class="p">(:)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3746</span><span class="w">             </span><span class="n">mask</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalr</span><span class="p">(:))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">threshold</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3747</span><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalr</span><span class="p">(:))</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">threshold</span><span class="p">)</span><span class="w"> </span><span class="n">rvalr</span><span class="p">(:)</span><span class="o">=</span><span class="n">zmin</span><span class="w">  </span>
<span class="linenos">3748</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">3749</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">3750</span><span class="w">    </span>
<span class="linenos">3751</span><span class="w">    </span><span class="c">! Loop over obs elements</span>
<span class="linenos">3752</span><span class="w">    </span>
<span class="linenos">3753</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="s1">&#39;(I22)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">obs_index</span><span class="w"></span>
<span class="linenos">3754</span>
<span class="linenos">3755</span><span class="w">    </span><span class="k">do </span><span class="n">obslevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"></span>
<span class="linenos">3756</span><span class="w">       </span>
<span class="linenos">3757</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">obsoper</span><span class="p">%</span><span class="n">success</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span><span class="w">   </span>
<span class="linenos">3758</span><span class="w">       </span>
<span class="linenos">3759</span><span class="w">      </span><span class="c">! Set reference mass (mixing ratio) weighting profile</span>
<span class="linenos">3760</span><span class="w">       </span>
<span class="linenos">3761</span><span class="w">      </span><span class="n">rvalw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="n">rvalr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3762</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">oopc_genOperConstraintType</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">constituentId</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Diff&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3763</span>
<span class="linenos">3764</span><span class="w">        </span><span class="c">! Set reference mass weighting profile according to the difference between </span>
<span class="linenos">3765</span><span class="w">        </span><span class="c">! an external reference (such as a climatology) and trial field profiles.</span>
<span class="linenos">3766</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3767</span><span class="w">        </span><span class="c">! This is a mechanism to force the solution profile shape somewhat towards that </span>
<span class="linenos">3768</span><span class="w">        </span><span class="c">! of the external reference when the reliability of the vertical structure of the </span>
<span class="linenos">3769</span><span class="w">        </span><span class="c">! trial field is not high.</span>
<span class="linenos">3770</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3771</span><span class="w">        </span><span class="c">! This can be used at the beginning of long assimilation periods if the initial</span>
<span class="linenos">3772</span><span class="w">        </span><span class="c">! trial field is not as realistic as may be desired or somewhat mitigate</span>
<span class="linenos">3773</span><span class="w">        </span><span class="c">! gradual biasing of vertical structures that might otherwise occur from assimilation </span>
<span class="linenos">3774</span><span class="w">        </span><span class="c">! of integrated quantities (when there is insufficient data from other observation types).</span>
<span class="linenos">3775</span><span class="w">        </span><span class="c">!</span>
<span class="linenos">3776</span><span class="w">        </span><span class="c">! The larger the rms difference of xc (external reference) with xb (trial field profile), </span>
<span class="linenos">3777</span><span class="w">        </span><span class="c">! the greater is the influence of this difference in the weighting. If there is </span>
<span class="linenos">3778</span><span class="w">        </span><span class="c">! little difference, then either xb or xc can be directly used as the weighting </span>
<span class="linenos">3779</span><span class="w">        </span><span class="c">! profile; xb is used below.</span>
<span class="linenos">3780</span><span class="w">        </span>
<span class="linenos">3781</span><span class="w">        </span><span class="n">rmse</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">3782</span><span class="w">        </span><span class="n">irmse</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3783</span><span class="w">        </span><span class="n">rvalc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_getProfile</span><span class="p">(</span><span class="n">oopc_bgRef</span><span class="p">,</span><span class="n">code</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3784</span><span class="w">            </span>
<span class="linenos">3785</span><span class="w">        </span><span class="n">zmin</span><span class="o">=</span><span class="n">pwin</span><span class="o">*</span><span class="nb">maxval</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">3786</span><span class="w">        </span><span class="k">do </span><span class="n">modlevIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="w"></span>
<span class="linenos">3787</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">modlevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">zmin</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3788</span><span class="k">            </span><span class="n">irmse</span><span class="o">=</span><span class="n">irmse</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">3789</span><span class="w">            </span><span class="n">rmse</span><span class="o">=</span><span class="n">rmse</span><span class="o">+</span><span class="p">((</span><span class="n">rvalc</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">)</span><span class="o">-</span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">))</span><span class="o">*</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3790</span><span class="w">	         </span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="w"></span>
<span class="linenos">3791</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">3792</span><span class="k">        end do</span>
<span class="linenos">3793</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">irmse</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">rmse</span><span class="o">=</span><span class="n">rmse</span><span class="o">*</span><span class="mf">2.0d0</span><span class="o">/</span><span class="n">irmse</span><span class="w"></span>
<span class="linenos">3794</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rmse</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1.0d0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3795</span><span class="k">          </span><span class="n">rvalw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="n">rvalc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3796</span><span class="w">        </span><span class="k">else </span>
<span class="linenos">3797</span><span class="k">          </span><span class="n">rvalw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="n">rvalc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">-</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3798</span><span class="w">                                  </span><span class="n">obsoper</span><span class="p">%</span><span class="n">trial</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3799</span><span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.01d0</span><span class="o">*</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3800</span><span class="w">	         </span><span class="n">rvalc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w"> </span>
<span class="linenos">3801</span><span class="w">            </span><span class="n">rvalw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="nb">sign</span><span class="p">(</span><span class="mf">0.01d0</span><span class="o">*</span><span class="n">rvalc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3802</span><span class="w">                                   </span><span class="n">rvalw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3803</span><span class="w">	  </span><span class="k">end where</span>
<span class="linenos">3804</span><span class="k">        end if</span>
<span class="linenos">3805</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="k">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalw</span><span class="p">(:))</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">threshold</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3806</span><span class="k">          </span><span class="n">rvalw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="n">rvalc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3807</span><span class="w">        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalw</span><span class="p">(:))</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">threshold</span><span class="p">))</span><span class="w"> </span><span class="k">then </span>
<span class="linenos">3808</span><span class="k">          </span><span class="n">zmin</span><span class="o">=</span><span class="nb">minval</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalw</span><span class="p">(:)),</span><span class="n">mask</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalw</span><span class="p">(:))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">threshold</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3809</span><span class="w">          </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rvalw</span><span class="p">(:))</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">threshold</span><span class="p">)</span><span class="w"> </span><span class="n">rvalw</span><span class="p">(:)</span><span class="o">=</span><span class="w"> </span><span class="n">zmin</span><span class="w"></span>
<span class="linenos">3810</span><span class="w">	</span><span class="k">end if  </span>
<span class="linenos">3811</span><span class="k">      end if</span><span class="w"></span>
<span class="linenos">3812</span>
<span class="linenos">3813</span><span class="w">      </span><span class="c">! Begin preparation of the new innovation operator w (=new zhp)</span>
<span class="linenos">3814</span><span class="w">       </span>
<span class="linenos">3815</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nobslev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3816</span><span class="w">          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">3817</span><span class="w">          </span>
<span class="linenos">3818</span><span class="w">        </span><span class="c">! Treat as total column obs. Here, zhp would otherwise be approx. equal</span>
<span class="linenos">3819</span><span class="w">        </span><span class="c">! to 1 except for the near-end points of the model vertical domain,</span>
<span class="linenos">3820</span><span class="w">        </span><span class="c">! the latter due to the discretized domain. Not using zhp avoids this</span>
<span class="linenos">3821</span><span class="w">        </span><span class="c">! discretization issue from weakly affecting results at the boundaries.</span>
<span class="linenos">3822</span>
<span class="linenos">3823</span><span class="w">	</span><span class="n">work</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0</span><span class="w"></span>
<span class="linenos">3824</span>
<span class="linenos">3825</span><span class="w">      </span><span class="k">else</span><span class="w"> </span>
<span class="linenos">3826</span>
<span class="linenos">3827</span><span class="w">        </span><span class="c">! Account for localized obs function (e.g. partial columns, Jacobians. For Jacobians,</span>
<span class="linenos">3828</span><span class="w">        </span><span class="c">! zhp must also be independent of the model layer thicknesses.)</span>
<span class="linenos">3829</span><span class="w">	</span>
<span class="linenos">3830</span><span class="w">	</span><span class="c">! Apply cutoff       </span>
<span class="linenos">3831</span><span class="w">        </span><span class="n">zmin</span><span class="o">=</span><span class="n">pwin</span><span class="o">*</span><span class="nb">maxval</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)))</span><span class="w">					     </span>
<span class="linenos">3832</span><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">zmin</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3833</span><span class="w">          </span><span class="n">work</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"> </span>
<span class="linenos">3834</span><span class="w">        </span><span class="n">elsewhere</span><span class="w"></span>
<span class="linenos">3835</span><span class="w">          </span><span class="n">work</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3836</span><span class="w">	</span><span class="k">endwhere </span>
<span class="linenos">3837</span><span class="k">      end if</span><span class="w"></span>
<span class="linenos">3838</span>
<span class="linenos">3839</span><span class="w">      </span><span class="c">! Application of 1D space vertical covariance inverse B^{-1} for partially</span>
<span class="linenos">3840</span><span class="w">      </span><span class="c">! mitigate the weight impact of the later application of B in finalizing </span>
<span class="linenos">3841</span><span class="w">      </span><span class="c">! grad(Jo). Note: fdeStddev(:,2)=1.0/fdeStddev(:,1)</span>
<span class="linenos">3842</span>
<span class="linenos">3843</span><span class="w">      </span><span class="c">! Also impose </span>
<span class="linenos">3844</span><span class="w">      </span><span class="c">! - approximate mitigation of horizontal correlation effect</span>
<span class="linenos">3845</span><span class="w">      </span><span class="c">! - shape forcing profile via rvalw   </span>
<span class="linenos">3846</span>
<span class="linenos">3847</span><span class="w">      </span><span class="n">work</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="n">work</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">*</span><span class="n">rvalw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3848</span><span class="w">        </span><span class="o">*</span><span class="n">fdeStddev</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3849</span><span class="w">	</span>
<span class="linenos">3850</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,:)</span><span class="o">=</span><span class="mf">0.0D0</span><span class="w"></span>
<span class="linenos">3851</span><span class="w">      </span><span class="c">!$OMP PARALLEL DO PRIVATE(modlevIndex)       </span>
<span class="linenos">3852</span><span class="w">      </span><span class="k">do </span><span class="n">modlevIndex</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3853</span><span class="w">                     </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3854</span><span class="w">        </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">modlevIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3855</span><span class="w">	     </span><span class="o">/</span><span class="n">bgStats</span><span class="p">%</span><span class="n">hcorrlen</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">,</span><span class="n">varIndex</span><span class="p">)</span><span class="o">**</span><span class="n">oopc_genOperHCorrlenExpnt</span><span class="p">(</span><span class="n">varIndex</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3856</span><span class="w">	     </span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">work</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="w">                                  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3857</span><span class="w">	         </span><span class="o">*</span><span class="n">bgStats</span><span class="p">%</span><span class="n">corverti</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">modlevIndex</span><span class="p">,</span><span class="n">varIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">3858</span><span class="w">      </span><span class="k">end do</span><span class="w"></span>
<span class="linenos">3859</span><span class="w">      </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3860</span>
<span class="linenos">3861</span><span class="w">      </span><span class="c">! Determine proportionality factor &#39;a&#39; = (h*B*h^T)(w*B*w^T)^{-1}</span>
<span class="linenos">3862</span><span class="w">       </span>
<span class="linenos">3863</span><span class="w">      </span><span class="c">! First determine/estimate w*B*w^T (zwbw)</span>
<span class="linenos">3864</span><span class="w">       </span>
<span class="linenos">3865</span><span class="w">      </span><span class="c">!$OMP PARALLEL DO PRIVATE(modlevIndex)       </span>
<span class="linenos">3866</span><span class="w">      </span><span class="k">do </span><span class="n">modlevIndex</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3867</span><span class="w">                     </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3868</span><span class="w">	 </span>
<span class="linenos">3869</span><span class="w">        </span><span class="n">work</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3870</span><span class="w">	  </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3871</span><span class="w">           </span><span class="o">*</span><span class="n">bgStats</span><span class="p">%</span><span class="n">corvert</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3872</span><span class="w">	     </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="n">varIndex</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3873</span><span class="w">           </span><span class="o">*</span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3874</span><span class="w">	     </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3875</span><span class="w">      </span><span class="k">end do</span><span class="w"></span>
<span class="linenos">3876</span><span class="w">      </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3877</span><span class="w">       </span>
<span class="linenos">3878</span><span class="w">      </span><span class="n">zwbw</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3879</span><span class="w">                           </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3880</span><span class="w">               </span><span class="o">*</span><span class="n">work</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3881</span><span class="w">	             </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">3882</span><span class="w">       </span>
<span class="linenos">3883</span><span class="w">      </span><span class="c">! Determine/estimate h*B*h^T (zhbh)</span>
<span class="linenos">3884</span>
<span class="linenos">3885</span><span class="w">      </span><span class="c">!$OMP PARALLEL DO PRIVATE(modlevIndex)       </span>
<span class="linenos">3886</span><span class="w">      </span><span class="k">do </span><span class="n">modlevIndex</span><span class="o">=</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3887</span><span class="w">                     </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3888</span><span class="w">	 </span>
<span class="linenos">3889</span><span class="w">        </span><span class="n">work</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">)</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3890</span><span class="w">	  </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3891</span><span class="w">            </span><span class="o">*</span><span class="n">bgStats</span><span class="p">%</span><span class="n">corvert</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3892</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="n">varIndex</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3893</span><span class="w">            </span><span class="o">*</span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3894</span><span class="w">	      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">fdeStddev</span><span class="p">(</span><span class="n">modlevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3895</span><span class="w">      </span><span class="k">end do</span><span class="w"></span>
<span class="linenos">3896</span><span class="w">      </span><span class="c">!$OMP END PARALLEL DO</span>
<span class="linenos">3897</span><span class="w">       </span>
<span class="linenos">3898</span><span class="w">      </span><span class="n">zhbh</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3899</span><span class="w">                          </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3900</span><span class="w">               </span><span class="o">*</span><span class="n">work</span><span class="p">(</span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexTop</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">):</span><span class="w">          </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3901</span><span class="w">	             </span><span class="n">obsoper</span><span class="p">%</span><span class="n">modlevindexBot</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">3902</span>
<span class="linenos">3903</span><span class="w">      </span><span class="c">! Set proportionality factor &#39;a&#39;</span>
<span class="linenos">3904</span>
<span class="linenos">3905</span><span class="w">      </span><span class="n">za</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">zhbh</span><span class="o">/</span><span class="n">zwbw</span><span class="p">)</span><span class="o">*</span><span class="n">oopc_genOperOmAStatsFactor</span><span class="p">(</span><span class="n">varIndex</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3906</span><span class="w">         </span>
<span class="linenos">3907</span><span class="w">      </span><span class="c">! Set final innovation operator</span>
<span class="linenos">3908</span><span class="w">      </span>
<span class="linenos">3909</span><span class="w">      </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zh</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3910</span><span class="w">                                 </span><span class="n">obsoper</span><span class="p">%</span><span class="n">zhp</span><span class="p">(</span><span class="n">obslevIndex</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">obsoper</span><span class="p">%</span><span class="n">nmodlev</span><span class="p">)</span><span class="o">*</span><span class="n">za</span><span class="w"></span>
<span class="linenos">3911</span><span class="w">         </span>
<span class="linenos">3912</span><span class="w">    </span><span class="k">end do</span>
<span class="linenos">3913</span>
<span class="linenos">3914</span><span class="k">  end subroutine </span><span class="n">oopc_genOper</span><span class="w"></span>
<span class="linenos">3915</span>
<span class="linenos">3916</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3917</span><span class="w">  </span><span class="c">! oopc_getColBoundary</span>
<span class="linenos">3918</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3919</span><span class="w">  </span><span class="k">function </span><span class="n">oopc_getColBoundary</span><span class="p">(</span><span class="n">iconstituentId</span><span class="p">,</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">pressmod</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">hu_opt</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3920</span><span class="w">                               </span><span class="n">uu_opt</span><span class="p">,</span><span class="n">vv_opt</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">boundPress</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3921</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3922</span><span class="w">    </span><span class="c">!:Purpose: To determine and to store the boundary (e.g. tropopause or PBL)</span>
<span class="linenos">3923</span><span class="w">    </span><span class="c">!          pressure levels if needed by the observation operators.    </span>
<span class="linenos">3924</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">3925</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">boundPress</span><span class="w"> </span><span class="c">! pressure level of boundary to be imposed</span>
<span class="linenos">3926</span>
<span class="linenos">3927</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">3928</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iconstituentId</span><span class="w">  </span><span class="c">! BUFR code element of Table 08046 identifying the constituent</span>
<span class="linenos">3929</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nmodlev</span><span class="w">          </span><span class="c">! number of model levels for variables other than uu and vv</span>
<span class="linenos">3930</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pressmod</span><span class="p">(</span><span class="n">nmodlev</span><span class="p">)</span><span class="c">! model pressure array</span>
<span class="linenos">3931</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tt</span><span class="p">(</span><span class="n">nmodlev</span><span class="p">)</span><span class="w">      </span><span class="c">! model temperature (Kelvin)</span>
<span class="linenos">3932</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">height</span><span class="p">(</span><span class="n">nmodlev</span><span class="p">)</span><span class="w">  </span><span class="c">! height (meters)</span>
<span class="linenos">3933</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hu_opt</span><span class="p">(</span><span class="n">nmodlev</span><span class="p">)</span><span class="w"> </span><span class="c">! specific humidity</span>
<span class="linenos">3934</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uu_opt</span><span class="p">(:)</span><span class="w"> </span><span class="c">! model zonal wind component(m/s)</span>
<span class="linenos">3935</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vv_opt</span><span class="p">(:)</span><span class="w"> </span><span class="c">! model meridional wind component (m/s)</span>
<span class="linenos">3936</span><span class="w">   </span>
<span class="linenos">3937</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">3938</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tropo_bound</span><span class="w"></span>
<span class="linenos">3939</span><span class="w">    </span>
<span class="linenos">3940</span><span class="w">    </span><span class="n">boundPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.0d0</span><span class="w"></span>
<span class="linenos">3941</span><span class="w">    </span>
<span class="linenos">3942</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_tropo_mode</span><span class="p">(</span><span class="n">iconstituentId</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="linenos">3943</span><span class="k">   </span>
<span class="linenos">3944</span><span class="k">    </span><span class="n">tropo_bound</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_tropo_bound</span><span class="p">(</span><span class="n">iconstituentId</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3945</span><span class="w">    </span>
<span class="linenos">3946</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tropo_bound</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3947</span><span class="k">      if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="k">all</span><span class="p">(</span><span class="n">tt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="k">all</span><span class="p">(</span><span class="n">height</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3948</span><span class="k">    </span>
<span class="linenos">3949</span><span class="k">        select case</span><span class="p">(</span><span class="n">tropo_bound</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3950</span><span class="w">        </span><span class="k">case</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3951</span><span class="w">    </span>
<span class="linenos">3952</span><span class="w">          </span><span class="c">! Get tropopause pressure level</span>
<span class="linenos">3953</span><span class="w">      </span>
<span class="linenos">3954</span><span class="w">          </span><span class="n">boundPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phf_get_tropopause</span><span class="p">(</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">pressmod</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">hu_opt</span><span class="o">=</span><span class="n">hu_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3955</span><span class="w">    </span>
<span class="linenos">3956</span><span class="w">        </span><span class="k">case</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3957</span><span class="w"> </span>
<span class="linenos">3958</span><span class="w">          </span><span class="c">! Get PBL pressure level</span>
<span class="linenos">3959</span><span class="w">      </span>
<span class="linenos">3960</span><span class="w">          </span><span class="n">boundPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phf_get_pbl</span><span class="p">(</span><span class="n">nmodlev</span><span class="p">,</span><span class="n">pressmod</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">hu_opt</span><span class="o">=</span><span class="n">hu_opt</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3961</span><span class="w">	               </span><span class="n">uu_opt</span><span class="o">=</span><span class="n">uu_opt</span><span class="p">,</span><span class="n">vv_opt</span><span class="o">=</span><span class="n">vv_opt</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">3962</span><span class="w">      </span>
<span class="linenos">3963</span><span class="w">        </span><span class="k">case </span><span class="n">default</span><span class="w"></span>
<span class="linenos">3964</span><span class="w">           </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;oopc_getColBoundary: Unrecognized value for tropo_bound of &quot;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">3965</span><span class="w">                          </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">tropo_bound</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">3966</span><span class="w">        </span><span class="k">end select</span>
<span class="linenos">3967</span><span class="k">                                     </span>
<span class="linenos">3968</span><span class="k">      end if     </span>
<span class="linenos">3969</span><span class="k">    end if</span><span class="w"></span>
<span class="linenos">3970</span><span class="w">      </span>
<span class="linenos">3971</span><span class="w">    </span><span class="c">! Use tropo_column_top value if tropo_bound=0 or model derived boundary was unsuccessful</span>
<span class="linenos">3972</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">boundPress</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="n">boundPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_tropo_column_top</span><span class="p">(</span><span class="n">iconstituentId</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3973</span><span class="w">      </span>
<span class="linenos">3974</span><span class="w">  </span><span class="k">end function </span><span class="n">oopc_getColBoundary</span><span class="w"></span>
<span class="linenos">3975</span><span class="w">       </span>
<span class="linenos">3976</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3977</span><span class="w">  </span><span class="c">! oopc_addColBoundary</span>
<span class="linenos">3978</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">3979</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_addColBoundary</span><span class="p">(</span><span class="n">headerIndex</span><span class="p">,</span><span class="n">boundPress</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3980</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3981</span><span class="w">    </span><span class="c">!:Purpose: To add column boundary data to oopc_columnBoundary which can be</span>
<span class="linenos">3982</span><span class="w">    </span><span class="c">!          retrieved later using a header index.</span>
<span class="linenos">3983</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">3984</span><span class="w">    </span><span class="k">implicit none</span><span class="w"> </span>
<span class="linenos">3985</span>
<span class="linenos">3986</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">3987</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">headerIndex</span><span class="w"> </span><span class="c">! Header index</span>
<span class="linenos">3988</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">boundPress</span><span class="w">  </span><span class="c">! Pressure boundary</span>
<span class="linenos">3989</span><span class="w">     </span>
<span class="linenos">3990</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">oopc_columnBoundary</span><span class="p">%</span><span class="n">data1d</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3991</span><span class="k">      call </span><span class="n">oss_obsdata_alloc</span><span class="p">(</span><span class="n">oopc_columnBoundary</span><span class="p">,</span><span class="n">oopc_obsdata_maxsize</span><span class="p">,</span><span class="w"> </span><span class="n">dim1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">3992</span><span class="w">      </span><span class="n">oopc_columnBoundary</span><span class="p">%</span><span class="n">nrep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">3993</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">3994</span>
<span class="linenos">3995</span><span class="w">    </span><span class="c">! In this case nrep will count the number of filled reps in the data arrays</span>
<span class="linenos">3996</span><span class="w">    </span><span class="n">oopc_columnBoundary</span><span class="p">%</span><span class="n">nrep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oopc_columnBoundary</span><span class="p">%</span><span class="n">nrep</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span>
<span class="linenos">3997</span>
<span class="linenos">3998</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oopc_columnBoundary</span><span class="p">%</span><span class="n">nrep</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">oopc_obsdata_maxsize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">3999</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_addColBoundary: Reach max size of array &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4000</span><span class="w">	             </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">oopc_obsdata_maxsize</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">4001</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4002</span><span class="w">  </span>
<span class="linenos">4003</span><span class="w">    </span><span class="c">! Use the header number as the unique code for this obs data</span>
<span class="linenos">4004</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="n">oopc_columnBoundary</span><span class="p">%</span><span class="n">code</span><span class="p">(</span><span class="n">oopc_columnBoundary</span><span class="p">%</span><span class="n">nrep</span><span class="p">),</span><span class="s1">&#39;(I22)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">headerIndex</span><span class="w"></span>
<span class="linenos">4005</span>
<span class="linenos">4006</span><span class="w">    </span><span class="n">oopc_columnBoundary</span><span class="p">%</span><span class="n">data1d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">oopc_columnBoundary</span><span class="p">%</span><span class="n">nrep</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boundPress</span><span class="w"></span>
<span class="linenos">4007</span>
<span class="linenos">4008</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_addColBoundary</span><span class="w"></span>
<span class="linenos">4009</span>
<span class="linenos">4010</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4011</span><span class="w">  </span><span class="c">! oopc_retrieveColBoundary</span>
<span class="linenos">4012</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4013</span><span class="w">  </span><span class="k">function </span><span class="n">oopc_retrieveColBoundary</span><span class="p">(</span><span class="n">headerIndex</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">boundPress</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4014</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4015</span><span class="w">    </span><span class="c">!:Purpose: To retrieve previously saved column boundary data in</span>
<span class="linenos">4016</span><span class="w">    </span><span class="c">!          oopc_columnBoundary from the header index.</span>
<span class="linenos">4017</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4018</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos">4019</span><span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">boundPress</span><span class="w"></span>
<span class="linenos">4020</span>
<span class="linenos">4021</span><span class="w">    </span><span class="c">! Arguments:</span>
<span class="linenos">4022</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">headerIndex</span><span class="w"></span>
<span class="linenos">4023</span>
<span class="linenos">4024</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">4025</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">code</span><span class="w"></span>
<span class="linenos">4026</span>
<span class="linenos">4027</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="s1">&#39;(I22)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">headerIndex</span><span class="w"></span>
<span class="linenos">4028</span><span class="w">    </span>
<span class="linenos">4029</span><span class="w">    </span><span class="n">boundPress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oss_obsdata_get_element</span><span class="p">(</span><span class="n">oopc_columnBoundary</span><span class="p">,</span><span class="n">code</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4030</span>
<span class="linenos">4031</span><span class="w">  </span><span class="k">end function </span><span class="n">oopc_retrieveColBoundary</span><span class="w"></span>
<span class="linenos">4032</span>
<span class="linenos">4033</span><span class="w">  </span><span class="c">!==========================================================================</span>
<span class="linenos">4034</span><span class="w">  </span><span class="c">!-------- Stand-alone routines to read and extract climatology fields -----</span>
<span class="linenos">4035</span>
<span class="linenos">4036</span><span class="w">  </span><span class="c">! Could be placed in a category 4 module.</span>
<span class="linenos">4037</span><span class="w">  </span><span class="c">! public :: oopc_readFields, oopc_addToProfileSet, oopc_getProfile</span>
<span class="linenos">4038</span>
<span class="linenos">4039</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4040</span><span class="w">  </span><span class="c">! oopc_readFields</span>
<span class="linenos">4041</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4042</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_readFields</span><span class="p">(</span><span class="n">climatFields</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">variable</span><span class="p">,</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4043</span><span class="w">                             </span><span class="n">maxNumFields</span><span class="p">,</span><span class="n">maxNumTypes</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4044</span><span class="w">                             </span><span class="n">fieldRequired</span><span class="p">,</span><span class="n">success</span><span class="p">,</span><span class="n">filetype_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4045</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4046</span><span class="w">    </span><span class="c">!:Purpose:  To read climatrology (reference) fields as directed by input</span>
<span class="linenos">4047</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4048</span><span class="w">    </span><span class="c">! Comments:</span>
<span class="linenos">4049</span><span class="w">    </span><span class="c">!      - Fields are provided in RPN/fst files </span>
<span class="linenos">4050</span><span class="w">    </span><span class="c">!      - Reference fields can be in a separate RPN file with name provided</span>
<span class="linenos">4051</span><span class="w">    </span><span class="c">!        within &#39;filename&#39; if filetype=&#39;TXT&#39; or provided as &#39;filename&#39; if it</span>
<span class="linenos">4052</span><span class="w">    </span><span class="c">!        refers to an RPN standaard file.</span>
<span class="linenos">4053</span><span class="w">    </span><span class="c">!      - Fields assumed to be of the same units as those of the</span>
<span class="linenos">4054</span><span class="w">    </span><span class="c">!        corresponding input trial fields</span>
<span class="linenos">4055</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4056</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">4057</span>
<span class="linenos">4058</span><span class="w">    </span><span class="c">! Arguments:    </span>
<span class="linenos">4059</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oopc_field</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">climatFields</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">maxNumFields</span><span class="p">,</span><span class="n">maxNumTypes</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4060</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filename</span><span class="w"></span>
<span class="linenos">4061</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="kd">::</span><span class="w"> </span><span class="n">maxNumFields</span><span class="p">,</span><span class="n">maxNumTypes</span><span class="w"></span>
<span class="linenos">4062</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="w"></span>
<span class="linenos">4063</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">variable</span><span class="w"></span>
<span class="linenos">4064</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fieldRequired</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">maxNumFields</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">4065</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filetype_opt</span><span class="w"></span>
<span class="linenos">4066</span>
<span class="linenos">4067</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">4068</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filetype</span><span class="w"></span>
<span class="linenos">4069</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fname</span><span class="w"></span>
<span class="linenos">4070</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varName</span><span class="w"></span>
<span class="linenos">4071</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">etiket</span><span class="w"></span>
<span class="linenos">4072</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varIndex</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">nd</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">numvar</span><span class="p">,</span><span class="n">ijour</span><span class="p">,</span><span class="n">imonth</span><span class="p">,</span><span class="n">iday</span><span class="p">,</span><span class="nb">itime</span><span class="p">,</span><span class="n">latIndex</span><span class="w"></span>
<span class="linenos">4073</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">day</span><span class="w"></span>
<span class="linenos">4074</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">datestamp</span><span class="w"></span>
<span class="linenos">4075</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">external</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">newdate</span><span class="w"></span>
<span class="linenos">4076</span><span class="w">   </span>
<span class="linenos">4077</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">external</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fnom</span><span class="p">,</span><span class="w"> </span><span class="n">fclos</span><span class="w"></span>
<span class="linenos">4078</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ierr</span><span class="p">,</span><span class="w"> </span><span class="n">nulun</span><span class="p">,</span><span class="w"> </span><span class="n">ios</span><span class="w"></span>
<span class="linenos">4079</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fileExists</span><span class="w"></span>
<span class="linenos">4080</span><span class="w">    </span>
<span class="linenos">4081</span><span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">timeInterp</span><span class="w"></span>
<span class="linenos">4082</span><span class="w">    </span>
<span class="linenos">4083</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ni</span><span class="p">,</span><span class="w"> </span><span class="n">nj</span><span class="p">,</span><span class="w"> </span><span class="n">nkeys</span><span class="p">,</span><span class="w"> </span><span class="nb">kind</span>
<span class="linenos">4084</span><span class="nb">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">array1</span><span class="p">(:,:,:),</span><span class="n">array2</span><span class="p">(:,:,:),</span><span class="n">lvls</span><span class="p">(:),</span><span class="n">xlat</span><span class="p">(:),</span><span class="n">xlong</span><span class="p">(:)</span><span class="w"> </span>
<span class="linenos">4085</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pressclim</span><span class="p">(:),</span><span class="n">ozoneclim</span><span class="p">(:,:)</span><span class="w"></span>
<span class="linenos">4086</span><span class="w">    </span>
<span class="linenos">4087</span><span class="w">    </span><span class="kt">character</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos">4088</span>
<span class="linenos">4089</span><span class="w">    </span><span class="c">! Initialize dimensions to zero</span>
<span class="linenos">4090</span><span class="w">    </span>
<span class="linenos">4091</span><span class="w">    </span><span class="n">climatFields</span><span class="p">(:,:)%</span><span class="n">nlon</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">4092</span><span class="w">    </span><span class="n">climatFields</span><span class="p">(:,:)%</span><span class="n">nlat</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">4093</span><span class="w">    </span><span class="n">climatFields</span><span class="p">(:,:)%</span><span class="n">nlev</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4094</span><span class="w"> </span>
<span class="linenos">4095</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;CH&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4096</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">all</span><span class="p">(</span><span class="n">fieldRequired</span><span class="p">(:)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Trial&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">4097</span><span class="w">        </span><span class="c">! Not needed</span>
<span class="linenos">4098</span><span class="w">        </span><span class="n">success</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">4099</span><span class="w">	</span><span class="k">return</span>
<span class="linenos">4100</span><span class="k">      end if</span>
<span class="linenos">4101</span><span class="k">    end if</span>
<span class="linenos">4102</span><span class="k">   </span>
<span class="linenos">4103</span><span class="k">    inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">exist</span><span class="o">=</span><span class="n">fileExists</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4104</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">fileExists</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4105</span><span class="k">      write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">  </span><span class="s1">&#39;----------------------------------------------------&#39;</span><span class="w"></span>
<span class="linenos">4106</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">  </span><span class="s1">&#39;oopc_readFields: COULD NOT FIND file &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4107</span><span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">  </span><span class="s1">&#39;----------------------------------------------------&#39;</span><span class="w"></span>
<span class="linenos">4108</span><span class="w">      </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">4109</span><span class="w">      </span><span class="k">return</span>
<span class="linenos">4110</span><span class="k">    else</span>
<span class="linenos">4111</span><span class="k">      </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">4112</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4113</span>
<span class="linenos">4114</span><span class="w">    </span><span class="c">! Check for file names containing climatological fields or input directives</span>
<span class="linenos">4115</span>
<span class="linenos">4116</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">present</span><span class="p">(</span><span class="n">filetype_opt</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4117</span><span class="k">      </span><span class="n">filetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">fileType_opt</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">4118</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">4119</span><span class="k">      </span><span class="n">filetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;RPN&#39;</span><span class="w">      </span>
<span class="linenos">4120</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">4121</span><span class="k">    </span>
<span class="linenos">4122</span><span class="k">    </span><span class="n">nulun</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">4123</span><span class="w">    </span><span class="n">ierr</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">4124</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">filetype</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;TXT&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4125</span><span class="k">      </span><span class="n">ierr</span><span class="o">=</span><span class="n">fnom</span><span class="p">(</span><span class="n">nulun</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="s1">&#39;SEQ&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4126</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4127</span><span class="k">        open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">nulun</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;OLD&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4128</span><span class="w">        </span><span class="n">ios</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">4129</span><span class="w">        </span>
<span class="linenos">4130</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;CH&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span>
<span class="linenos">4131</span><span class="w">        </span>
<span class="linenos">4132</span><span class="w">          </span><span class="c">! CH variable kind (for constituent fields)</span>
<span class="linenos">4133</span><span class="w">          </span>
<span class="linenos">4134</span><span class="w">          </span><span class="k">read</span><span class="p">(</span><span class="n">nulun</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos">4135</span><span class="w">          </span><span class="k">do while</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nb">adjustl</span><span class="p">(</span><span class="n">ligne</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">14</span><span class="p">)))</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;SECTION IV:&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">4136</span><span class="w">            </span><span class="k">read</span><span class="p">(</span><span class="n">nulun</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">ligne</span><span class="w"></span>
<span class="linenos">4137</span><span class="w">          </span><span class="k">end do</span><span class="w">    </span>
<span class="linenos">4138</span><span class="w">          </span>
<span class="linenos">4139</span><span class="w">          </span><span class="c">! Read number of constituents with associated input file(s)</span>
<span class="linenos">4140</span><span class="w">   </span>
<span class="linenos">4141</span><span class="w">          </span><span class="k">read</span><span class="p">(</span><span class="n">nulun</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">numvar</span><span class="w"></span>
<span class="linenos">4142</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">numvar</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="linenos">4143</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">4144</span><span class="k">          </span><span class="n">numvar</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4145</span><span class="w">          </span><span class="n">nd</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4146</span><span class="w">          </span><span class="k">call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readFields: Variable kind or name &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4147</span><span class="w">	                 </span><span class="nb">trim</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="s1">&#39; not taken into account&#39;</span><span class="p">)</span><span class="w">  </span>
<span class="linenos">4148</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">4149</span><span class="k">      end if</span>
<span class="linenos">4150</span><span class="k">    else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">filetype</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;RPN&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4151</span><span class="k">      </span><span class="n">numvar</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4152</span><span class="w">      </span><span class="n">nd</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4153</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">filetype</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;RPN&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4154</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readFields: File type &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">filetype</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4155</span><span class="w">                     </span><span class="s1">&#39; not recognized&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">4156</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">4157</span>
<span class="linenos">4158</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4159</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readFields: COULD NOT OPEN file &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4160</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4161</span><span class="w">       </span>
<span class="linenos">4162</span><span class="w">    </span><span class="c">! Initialization</span>
<span class="linenos">4163</span>
<span class="linenos">4164</span><span class="w">    </span><span class="n">timeInterp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">4165</span><span class="w">    </span><span class="n">datestamp</span><span class="o">=</span><span class="n">tim_getDateStamp</span><span class="p">()</span><span class="w"></span>
<span class="linenos">4166</span><span class="w">    </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newdate</span><span class="p">(</span><span class="n">datestamp</span><span class="p">,</span><span class="n">ijour</span><span class="p">,</span><span class="nb">itime</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4167</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ierr</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4168</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readFields: Invalid datestamp &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4169</span><span class="w">                     </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">datestamp</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">4170</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">4171</span><span class="k">    </span><span class="n">imonth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(</span><span class="n">ijour</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4172</span><span class="w">    </span><span class="n">iday</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(</span><span class="n">ijour</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4173</span><span class="w">    </span><span class="n">day</span><span class="o">=</span><span class="n">iday</span><span class="o">+</span><span class="nb">itime</span><span class="o">*</span><span class="mf">1.0D-8</span><span class="w"></span>
<span class="linenos">4174</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">day</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="mf">5.</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4175</span><span class="k">      </span><span class="n">day</span><span class="o">=</span><span class="n">day</span><span class="o">-</span><span class="mi">1</span><span class="mf">5.0</span><span class="w"></span>
<span class="linenos">4176</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">4177</span><span class="k">      </span><span class="n">day</span><span class="o">=</span><span class="n">day</span><span class="o">+</span><span class="mi">1</span><span class="mf">5.0</span><span class="w"></span>
<span class="linenos">4178</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4179</span><span class="w">    </span>
<span class="linenos">4180</span><span class="w">    </span><span class="c">! Get needed fields for each file/varIndex</span>
<span class="linenos">4181</span>
<span class="linenos">4182</span><span class="w">    </span><span class="k">do </span><span class="n">varIndex</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numvar</span><span class="w"></span>
<span class="linenos">4183</span>
<span class="linenos">4184</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;CH&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span>
<span class="linenos">4185</span><span class="w">       </span>
<span class="linenos">4186</span><span class="w">        </span><span class="c">! Read id,nd</span>
<span class="linenos">4187</span><span class="w">        </span><span class="c">! id: constituent identifier code; (0 for ozone, ...)</span>
<span class="linenos">4188</span><span class="w">        </span><span class="c">! nd: number of sets; 1 or 2 (nd=2 required when different profile </span>
<span class="linenos">4189</span><span class="w">        </span><span class="c">!       sets need to be merged according to the tropopause height </span>
<span class="linenos">4190</span><span class="w">	</span><span class="c">!       when the first set referring to strato files and teh second </span>
<span class="linenos">4191</span><span class="w">	</span><span class="c">!       to tropo fields)</span>
<span class="linenos">4192</span><span class="w">       </span>
<span class="linenos">4193</span><span class="w">        </span><span class="k">read</span><span class="p">(</span><span class="n">nulun</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4194</span><span class="w">        </span><span class="k">read</span><span class="p">(</span><span class="n">nulun</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">nd</span><span class="w">   </span>
<span class="linenos">4195</span><span class="w">        </span><span class="n">varName</span><span class="o">=</span><span class="n">vnl_varnameFromVarnum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">id</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4196</span>
<span class="linenos">4197</span><span class="w">        </span><span class="k">read</span><span class="p">(</span><span class="n">nulun</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">fname</span><span class="w"></span>
<span class="linenos">4198</span><span class="w">        </span><span class="k">inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span><span class="n">exist</span><span class="o">=</span><span class="n">fileExists</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4199</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">fileExists</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4200</span><span class="k">          call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readFields: Did not find file &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4201</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">4202</span><span class="k">      else</span>
<span class="linenos">4203</span><span class="k">        </span><span class="n">id</span><span class="o">=</span><span class="n">varIndex</span><span class="w"></span>
<span class="linenos">4204</span><span class="w">        </span><span class="c">! Currently assumes nunmar = 1 and fname = filename. Could be extended</span>
<span class="linenos">4205</span><span class="w">        </span><span class="n">fname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filename</span><span class="w"></span>
<span class="linenos">4206</span><span class="w">        </span><span class="n">varname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4207</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">4208</span><span class="k">              </span>
<span class="linenos">4209</span><span class="k">      do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nd</span><span class="w"></span>
<span class="linenos">4210</span><span class="w">       </span>
<span class="linenos">4211</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w">  </span><span class="s1">&#39;ozoneclim98&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4212</span><span class="k">          </span><span class="n">timeInterp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span><span class="w"></span>
<span class="linenos">4213</span><span class="w">          </span><span class="k">call </span><span class="n">ozo_read_Climatology</span><span class="p">(</span><span class="n">datestamp</span><span class="p">,</span><span class="n">nlat_opt</span><span class="o">=</span><span class="n">nj</span><span class="p">,</span><span class="n">nlev_opt</span><span class="o">=</span><span class="n">nkeys</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4214</span><span class="w">	                            </span><span class="n">press_opt</span><span class="o">=</span><span class="n">pressclim</span><span class="p">,</span><span class="n">ozone_opt</span><span class="o">=</span><span class="n">ozoneclim</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">4215</span><span class="w">          </span><span class="n">id</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">4216</span><span class="w">          </span><span class="n">ni</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4217</span><span class="w">          </span><span class="k">allocate</span><span class="p">(</span><span class="n">array1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nj</span><span class="p">,</span><span class="n">nkeys</span><span class="p">),</span><span class="n">lvls</span><span class="p">(</span><span class="n">nkeys</span><span class="p">),</span><span class="n">xlat</span><span class="p">(</span><span class="n">nj</span><span class="p">),</span><span class="n">xlong</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4218</span><span class="w">          </span><span class="c">! Convert from ppmv to microgram/kg</span>
<span class="linenos">4219</span><span class="w">          </span><span class="n">array1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nj</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nkeys</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">ozoneclim</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nj</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nkeys</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4220</span><span class="w">	         </span><span class="n">MPC_MOLAR_MASS_O3_R8</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0d-3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">MPC_MOLAR_MASS_DRY_AIR_R8</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4221</span><span class="w">          </span><span class="n">lvls</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nkeys</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pressclim</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nkeys</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4222</span><span class="w">	  </span><span class="k">deallocate</span><span class="p">(</span><span class="n">ozoneclim</span><span class="p">,</span><span class="n">pressclim</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4223</span><span class="w">          </span><span class="nb">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="linenos">4224</span><span class="w">          </span><span class="n">xlong</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">4225</span><span class="w">          </span><span class="k">do </span><span class="n">latIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nj</span><span class="w"></span>
<span class="linenos">4226</span><span class="w">            </span><span class="n">xlat</span><span class="p">(</span><span class="n">latIndex</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">latIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0d0</span><span class="o">/</span><span class="p">(</span><span class="n">nj</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">9</span><span class="mf">0.0d0</span><span class="w"></span>
<span class="linenos">4227</span><span class="w">          </span><span class="k">end do</span>
<span class="linenos">4228</span><span class="k">          </span><span class="n">etiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;            &#39;</span><span class="w">       </span>
<span class="linenos">4229</span><span class="w">        </span><span class="k">else   </span>
<span class="linenos">4230</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">nd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4231</span><span class="k">            read</span><span class="p">(</span><span class="n">nulun</span><span class="p">,</span><span class="o">*</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">,</span><span class="n">err</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">etiket</span><span class="w">    </span>
<span class="linenos">4232</span><span class="w">          </span><span class="k">else</span>
<span class="linenos">4233</span><span class="k">            </span><span class="n">etiket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;            &#39;</span><span class="w">       </span>
<span class="linenos">4234</span><span class="w">          </span><span class="k">end if                   </span>
<span class="linenos">4235</span><span class="k">          call </span><span class="n">utl_readFstField</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span><span class="n">varName</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">imonth</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">etiket</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4236</span><span class="w">	       </span><span class="n">ni</span><span class="p">,</span><span class="n">nj</span><span class="p">,</span><span class="n">nkeys</span><span class="p">,</span><span class="n">array1</span><span class="p">,</span><span class="n">xlat_opt</span><span class="o">=</span><span class="n">xlat</span><span class="p">,</span><span class="n">xlong_opt</span><span class="o">=</span><span class="n">xlong</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4237</span><span class="w">               </span><span class="n">lvls_opt</span><span class="o">=</span><span class="n">lvls</span><span class="p">,</span><span class="n">kind_opt</span><span class="o">=</span><span class="nb">kind</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4238</span><span class="w">        </span><span class="k">end if      </span>
<span class="linenos">4239</span>
<span class="linenos">4240</span><span class="k">        </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">nlon</span><span class="o">=</span><span class="n">ni</span><span class="w"></span>
<span class="linenos">4241</span><span class="w">        </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">nlat</span><span class="o">=</span><span class="n">nj</span><span class="w"></span>
<span class="linenos">4242</span><span class="w">        </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">nlev</span><span class="o">=</span><span class="n">nkeys</span><span class="w"></span>
<span class="linenos">4243</span><span class="w">        </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">ivkind</span><span class="o">=</span><span class="nb">kind   </span>
<span class="linenos">4244</span><span class="nb">                         </span>
<span class="linenos">4245</span><span class="nb">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">field</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span><span class="n">nj</span><span class="p">,</span><span class="n">nkeys</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4246</span><span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">vlev</span><span class="p">(</span><span class="n">nkeys</span><span class="p">),</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">lon</span><span class="p">(</span><span class="n">ni</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4247</span><span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">lat</span><span class="p">(</span><span class="n">nj</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4248</span><span class="w">              </span>
<span class="linenos">4249</span><span class="w">        </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">lat</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nj</span><span class="p">)</span><span class="o">=</span><span class="n">xlat</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nj</span><span class="p">)</span><span class="o">*</span><span class="n">MPC_RADIANS_PER_DEGREE_R8</span><span class="w"></span>
<span class="linenos">4250</span><span class="w">        </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">lon</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ni</span><span class="p">)</span><span class="o">=</span><span class="n">xlong</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ni</span><span class="p">)</span><span class="o">*</span><span class="n">MPC_RADIANS_PER_DEGREE_R8</span><span class="w"></span>
<span class="linenos">4251</span><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">lon</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ni</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">4252</span><span class="w">	  </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">lon</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ni</span><span class="p">)</span><span class="o">=</span><span class="mf">2.0</span><span class="o">*</span><span class="n">MPC_PI_R8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">lon</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ni</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4253</span><span class="w">	</span><span class="k">end where</span>
<span class="linenos">4254</span><span class="k">        </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">vlev</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nkeys</span><span class="p">)</span><span class="o">=</span><span class="n">lvls</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nkeys</span><span class="p">)</span><span class="w">              </span>
<span class="linenos">4255</span>
<span class="linenos">4256</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">timeInterp</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4257</span>
<span class="linenos">4258</span><span class="k">          </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">field</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array1</span><span class="p">(:,:,:)</span><span class="w"></span>
<span class="linenos">4259</span>
<span class="linenos">4260</span><span class="w">        </span><span class="k">else</span><span class="w"></span>
<span class="linenos">4261</span>
<span class="linenos">4262</span><span class="w">          </span><span class="c">! Following for interpolation as a function of days from mid-months.</span>
<span class="linenos">4263</span><span class="w">             </span>
<span class="linenos">4264</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iday</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4265</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">imonth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4266</span><span class="k">              call </span><span class="n">utl_readFstField</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span><span class="n">varName</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">etiket</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4267</span><span class="w">                   </span><span class="n">ni</span><span class="p">,</span><span class="n">nj</span><span class="p">,</span><span class="n">nkeys</span><span class="p">,</span><span class="n">array2</span><span class="p">,</span><span class="n">lvls_opt</span><span class="o">=</span><span class="n">lvls</span><span class="p">,</span><span class="n">kind_opt</span><span class="o">=</span><span class="nb">kind</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4268</span><span class="w">            </span><span class="k">else</span>
<span class="linenos">4269</span><span class="k">              call </span><span class="n">utl_readFstField</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span><span class="n">varName</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">imonth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4270</span><span class="w">	           </span><span class="n">etiket</span><span class="p">,</span><span class="n">ni</span><span class="p">,</span><span class="n">nj</span><span class="p">,</span><span class="n">nkeys</span><span class="p">,</span><span class="n">array2</span><span class="p">,</span><span class="n">lvls_opt</span><span class="o">=</span><span class="n">lvls</span><span class="p">,</span><span class="n">kind_opt</span><span class="o">=</span><span class="nb">kind</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4271</span><span class="w">            </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4272</span><span class="w">          </span>
<span class="linenos">4273</span><span class="w">            </span><span class="c">! Linearly interpolate in time </span>
<span class="linenos">4274</span><span class="w">	    </span><span class="c">! (approximately - assumes 30 day months)</span>
<span class="linenos">4275</span>
<span class="linenos">4276</span><span class="w">            </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">field</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">array1</span><span class="p">(:,:,:)</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="mf">0.0</span><span class="o">-</span><span class="n">day</span><span class="p">)</span><span class="o">+</span><span class="n">array2</span><span class="p">(:,:,:)</span><span class="o">*</span><span class="n">day</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="mf">0.0</span><span class="w"></span>
<span class="linenos">4277</span><span class="w">             </span>
<span class="linenos">4278</span><span class="w">          </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">iday</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4279</span><span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">imonth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4280</span><span class="k">              call </span><span class="n">utl_readFstField</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span><span class="n">varName</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">etiket</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4281</span><span class="w">                   </span><span class="n">ni</span><span class="p">,</span><span class="n">nj</span><span class="p">,</span><span class="n">nkeys</span><span class="p">,</span><span class="n">array2</span><span class="p">,</span><span class="n">lvls_opt</span><span class="o">=</span><span class="n">lvls</span><span class="p">,</span><span class="n">kind_opt</span><span class="o">=</span><span class="nb">kind</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4282</span><span class="w">            </span><span class="k">else</span>
<span class="linenos">4283</span><span class="k">              call </span><span class="n">utl_readFstField</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span><span class="n">varName</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">imonth</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4284</span><span class="w">                   </span><span class="n">etiket</span><span class="p">,</span><span class="n">ni</span><span class="p">,</span><span class="n">nj</span><span class="p">,</span><span class="n">nkeys</span><span class="p">,</span><span class="n">array2</span><span class="p">,</span><span class="n">lvls_opt</span><span class="o">=</span><span class="n">lvls</span><span class="p">,</span><span class="n">kind_opt</span><span class="o">=</span><span class="nb">kind</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4285</span><span class="w">            </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4286</span>
<span class="linenos">4287</span><span class="w">            </span><span class="c">! Linearly interpolate in time </span>
<span class="linenos">4288</span><span class="w">            </span><span class="c">! (approximately - assumes 30 day months)</span>
<span class="linenos">4289</span>
<span class="linenos">4290</span><span class="w">            </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">j</span><span class="p">)%</span><span class="n">field</span><span class="p">(:,:,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">array2</span><span class="p">(:,:,:)</span><span class="o">*</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4291</span><span class="w">		                             </span><span class="p">(</span><span class="mi">3</span><span class="mf">0.0</span><span class="o">-</span><span class="n">day</span><span class="p">)</span><span class="o">+</span><span class="n">array1</span><span class="p">(:,:,:)</span><span class="o">*</span><span class="n">day</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="mf">0.0</span><span class="w">             </span>
<span class="linenos">4292</span><span class="w">          </span><span class="k">end if          </span>
<span class="linenos">4293</span><span class="k">        end if</span>
<span class="linenos">4294</span><span class="k"> </span>
<span class="linenos">4295</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">array1</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">array1</span><span class="p">,</span><span class="n">lvls</span><span class="p">,</span><span class="n">xlat</span><span class="p">,</span><span class="n">xlong</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4296</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">array2</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">array2</span><span class="p">)</span><span class="w">   </span>
<span class="linenos">4297</span><span class="w">                 </span>
<span class="linenos">4298</span><span class="w">      </span><span class="k">end do</span>
<span class="linenos">4299</span><span class="k">    end do </span>
<span class="linenos">4300</span><span class="k">     </span>
<span class="linenos">4301</span><span class="k"> </span><span class="mi">10</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ios</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4302</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readFields: READING PROBLEM.&#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4303</span><span class="w">                     </span><span class="s1">&#39; File read error message number: &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">ios</span><span class="p">)))</span><span class="w"> </span>
<span class="linenos">4304</span><span class="w">    </span><span class="k">end if   </span>
<span class="linenos">4305</span><span class="k">    close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">nulun</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4306</span><span class="w">    </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fclos</span><span class="p">(</span><span class="n">nulun</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4307</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="n">fieldRequired</span><span class="p">(:)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Diff&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;CH&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4308</span><span class="k">      do </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">maxNumFields</span><span class="w"></span>
<span class="linenos">4309</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">climatFields</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlon</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">fieldRequired</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Diff&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4310</span><span class="k">          call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readFields: READING PROBLEM. Did not&#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4311</span><span class="w">	                 </span><span class="s1">&#39; find SECTION IV required for constituent ID &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4312</span><span class="w">			 </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">4313</span><span class="w">	</span><span class="k">end if</span>
<span class="linenos">4314</span><span class="k">      end do</span>
<span class="linenos">4315</span><span class="k">    end if </span>
<span class="linenos">4316</span><span class="k">	</span>
<span class="linenos">4317</span><span class="k">    return    </span>
<span class="linenos">4318</span>
<span class="linenos">4319</span><span class="k"> </span><span class="mi">11</span><span class="w"> </span><span class="k">close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">nulun</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4320</span><span class="w">    </span><span class="n">ierr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fclos</span><span class="p">(</span><span class="n">nulun</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4321</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="n">fieldRequired</span><span class="p">(:)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;Diff&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;CH&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4322</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_readFields: READING PROBLEM. Did not find &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4323</span><span class="w">                      </span><span class="s1">&#39;SECTION IV.&#39;</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">4324</span><span class="w">    </span><span class="k">end if </span>
<span class="linenos">4325</span><span class="k">	     </span>
<span class="linenos">4326</span><span class="k">  end subroutine </span><span class="n">oopc_readFields</span><span class="w"></span>
<span class="linenos">4327</span>
<span class="linenos">4328</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4329</span><span class="w">  </span><span class="c">! oopc_addToProfileSet</span>
<span class="linenos">4330</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4331</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_addToProfileSet</span><span class="p">(</span><span class="n">climatFields</span><span class="p">,</span><span class="n">climatProfileSet</span><span class="p">,</span><span class="n">maxNumFields</span><span class="p">,</span><span class="n">maxNumTypes</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4332</span><span class="w">                                  </span><span class="n">numModelLevs</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="n">modelHeightLevs</span><span class="p">,</span><span class="n">obsLat</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4333</span><span class="w">                                  </span><span class="n">obsLong</span><span class="p">,</span><span class="n">obsIndex</span><span class="p">,</span><span class="n">maxsize</span><span class="p">,</span><span class="n">varKind_opt</span><span class="p">,</span><span class="n">varNumber_opt</span><span class="p">,</span><span class="n">tt_opt</span><span class="p">,</span><span class="n">hu_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4334</span><span class="w">    </span>
<span class="linenos">4335</span><span class="w">    </span><span class="c">!:Purpose: To determine and to store a profile at obs location as part of a cumulative</span>
<span class="linenos">4336</span><span class="w">    </span><span class="c">!          profile set for a specific variable</span>
<span class="linenos">4337</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4338</span><span class="w">    </span><span class="c">!:Input:</span>
<span class="linenos">4339</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4340</span><span class="w">    </span><span class="c">!    :climatFields:           Input fields from which interpolations are done</span>
<span class="linenos">4341</span><span class="w">    </span><span class="c">!    :climatProfileSet:       Input profile set</span>
<span class="linenos">4342</span><span class="w">    </span><span class="c">!    :maxNumFields:           Size of first dimension for climatFields</span>
<span class="linenos">4343</span><span class="w">    </span><span class="c">!    :maxNumTypes:            Size of second dimension for climatFields</span>
<span class="linenos">4344</span><span class="w">    </span><span class="c">!    :numModelLevs:           Number of model levels</span>
<span class="linenos">4345</span><span class="w">    </span><span class="c">!    :modelPressLevs          Model pressure array (Pa)</span>
<span class="linenos">4346</span><span class="w">    </span><span class="c">!    :modelHeightLevs:        Model height (m)</span>
<span class="linenos">4347</span><span class="w">    </span><span class="c">!    :obsLat:                 Latitude (rad)</span>
<span class="linenos">4348</span><span class="w">    </span><span class="c">!    :obsLong:                Longitude (rad)</span>
<span class="linenos">4349</span><span class="w">    </span><span class="c">!    :obsIndex:               Unique measurement identifier    </span>
<span class="linenos">4350</span><span class="w">    </span><span class="c">!    :varKind_opt:            variable kind (currently only relevant for &#39;CH&#39;)</span>
<span class="linenos">4351</span><span class="w">    </span><span class="c">!    :varNumber_opt:          Constituent id</span>
<span class="linenos">4352</span><span class="w">    </span><span class="c">!    :tt_opt:                 Model temperature (Kelvin)</span>
<span class="linenos">4353</span><span class="w">    </span><span class="c">!    :hu_opt:                 Specific humidity </span>
<span class="linenos">4354</span><span class="w">    </span><span class="c">!    :maxsize:                Max number of obs for which climatProfileSet will be used</span>
<span class="linenos">4355</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4356</span><span class="w">    </span><span class="c">!:Output:</span>
<span class="linenos">4357</span><span class="w">    </span><span class="c">! </span>
<span class="linenos">4358</span><span class="w">    </span><span class="c">!    :climatProfileSet:       Updated profile set (with one profile added for (obs_long,obs_lat))</span>
<span class="linenos">4359</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4360</span><span class="w">    </span><span class="c">!:Comments:</span>
<span class="linenos">4361</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4362</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">4363</span>
<span class="linenos">4364</span><span class="w">    </span><span class="c">! Arguments</span>
<span class="linenos">4365</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oopc_field</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">climatFields</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">maxNumFields</span><span class="p">,</span><span class="n">maxNumTypes</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4366</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oss_obsdata</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">climatProfileSet</span><span class="w"></span>
<span class="linenos">4367</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="kd">::</span><span class="w"> </span><span class="n">maxNumFields</span><span class="p">,</span><span class="n">maxNumTypes</span><span class="w"></span>
<span class="linenos">4368</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obsIndex</span><span class="p">,</span><span class="n">numModelLevs</span><span class="p">,</span><span class="n">maxsize</span><span class="w"></span>
<span class="linenos">4369</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">modelPressLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">),</span><span class="n">modelHeightLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4370</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">obsLat</span><span class="p">,</span><span class="n">obsLong</span><span class="w"></span>
<span class="linenos">4371</span><span class="w">    </span>
<span class="linenos">4372</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varNumber_opt</span><span class="w"></span>
<span class="linenos">4373</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tt_opt</span><span class="p">(:),</span><span class="n">hu_opt</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">4374</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">varKind_opt</span><span class="w"></span>
<span class="linenos">4375</span><span class="w">    </span>
<span class="linenos">4376</span><span class="w">    </span><span class="c">! Locals</span>
<span class="linenos">4377</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">level</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">id</span><span class="w"></span>
<span class="linenos">4378</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tropo_press</span><span class="p">,</span><span class="w"> </span><span class="n">refprof</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">),</span><span class="n">refprof2</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">),</span><span class="n">dt</span><span class="w"></span>
<span class="linenos">4379</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">4380</span><span class="w">    </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">4381</span>
<span class="linenos">4382</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">present</span><span class="p">(</span><span class="n">varNumber_opt</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4383</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">varNumber_opt</span><span class="w">  </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="linenos">4384</span><span class="k">      </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">varNumber_opt</span><span class="w"></span>
<span class="linenos">4385</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">4386</span><span class="k">      </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">4387</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">4388</span>
<span class="linenos">4389</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">present</span><span class="p">(</span><span class="n">varKind_opt</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">4390</span><span class="w">      </span><span class="c">! Not currently used</span>
<span class="linenos">4391</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">4392</span><span class="k">    </span>
<span class="linenos">4393</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"></span>
<span class="linenos">4394</span><span class="w">    </span>
<span class="linenos">4395</span><span class="w">    </span><span class="c">! Set vertical levels of reference.</span>
<span class="linenos">4396</span><span class="w">    </span><span class="c">! Convert to pressure coordinate if needed.</span>
<span class="linenos">4397</span><span class="w">    </span>
<span class="linenos">4398</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4399</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4400</span><span class="w">    </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">vlev</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4401</span>
<span class="linenos">4402</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">success</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4403</span><span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">success</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4404</span><span class="w">    </span><span class="n">success</span><span class="p">(:)</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">4405</span><span class="w">    </span>
<span class="linenos">4406</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">ivkind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4407</span><span class="k">      </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">=</span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span><span class="w"> </span><span class="c">! Conversion from hPa to Pa.</span>
<span class="linenos">4408</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">ivkind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4409</span><span class="k">      where</span><span class="w"> </span><span class="p">(</span><span class="n">pressrefin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">modelHeightLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4410</span><span class="w">        </span><span class="n">pressrefin</span><span class="o">=</span><span class="n">modelHeightLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4411</span><span class="w">      </span><span class="k">end where</span>
<span class="linenos">4412</span><span class="k">      </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phf_convert_z_to_pressure</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">,</span><span class="n">modelHeightLevs</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4413</span><span class="w">                      </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlev</span><span class="p">,</span><span class="n">numModelLevs</span><span class="p">,</span><span class="n">obsLat</span><span class="p">,</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4414</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">ivkind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4415</span><span class="k">      </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">=</span><span class="n">pressrefin</span><span class="p">(:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">modelHeightLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4416</span><span class="w">      </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phf_convert_z_to_pressure</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">,</span><span class="n">modelHeightLevs</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4417</span><span class="w">                      </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlev</span><span class="p">,</span><span class="n">numModelLevs</span><span class="p">,</span><span class="n">obsLat</span><span class="p">,</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4418</span><span class="w">    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">ivkind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4419</span><span class="k">      </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">=</span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">*</span><span class="n">modelPressLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Convert from sigma to Pa   </span>
<span class="linenos">4420</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">4421</span><span class="k">       call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_addToProfileSet: Cannot handle vertical coordinate of kind &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">ivkind</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">4422</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4423</span><span class="w">    </span>
<span class="linenos">4424</span><span class="w">    </span><span class="c">! Interpolate to obs lat/long (or lat) location and model level</span>
<span class="linenos">4425</span>
<span class="linenos">4426</span><span class="w">    </span><span class="k">call </span><span class="n">oopc_column_hbilin</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">field</span><span class="p">,</span><span class="n">pressrefin</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4427</span><span class="w">                  </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlon</span><span class="p">,</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlat</span><span class="p">,</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">nlev</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4428</span><span class="w">                  </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">lon</span><span class="p">,</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">)%</span><span class="n">lat</span><span class="p">,</span><span class="n">obsLong</span><span class="p">,</span><span class="n">obsLat</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4429</span><span class="w">                  </span><span class="n">refprof</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4430</span>
<span class="linenos">4431</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlon</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4432</span><span class="w">        </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlev</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4433</span><span class="k">        </span>
<span class="linenos">4434</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="nb">present</span><span class="p">(</span><span class="n">tt_opt</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4435</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_addToProfileSet: Missing TT for determining &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4436</span><span class="w">	               </span><span class="s1">&#39;tropopause pressure&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4437</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">4438</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">any</span><span class="p">(</span><span class="n">tt_opt</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0d0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4439</span><span class="k">        call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_addToProfileSet: Invalid TT for determining &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4440</span><span class="w">	               </span><span class="s1">&#39;tropopause pressure&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4441</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4442</span><span class="w">        </span>
<span class="linenos">4443</span><span class="w">      </span><span class="c">! Get second reference field (for troposphere)</span>
<span class="linenos">4444</span><span class="w">        </span>
<span class="linenos">4445</span><span class="w">      </span><span class="n">tropo_press</span><span class="o">=-</span><span class="mf">1.0</span><span class="w"></span>
<span class="linenos">4446</span><span class="w">        </span>
<span class="linenos">4447</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">present</span><span class="p">(</span><span class="n">hu_opt</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4448</span><span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="k">all</span><span class="p">(</span><span class="n">hu_opt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0D0</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4449</span><span class="k">          </span><span class="n">tropo_press</span><span class="o">=</span><span class="n">phf_get_tropopause</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4450</span><span class="w">	              </span><span class="n">tt_opt</span><span class="p">,</span><span class="n">modelHeightLevs</span><span class="p">,</span><span class="n">hu_opt</span><span class="o">=</span><span class="n">hu_opt</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4451</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">4452</span><span class="k">          </span><span class="n">tropo_press</span><span class="o">=</span><span class="n">phf_get_tropopause</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4453</span><span class="w">	              </span><span class="n">tt_opt</span><span class="p">,</span><span class="n">modelHeightLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4454</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">4455</span><span class="k">      else</span>
<span class="linenos">4456</span><span class="k">        </span><span class="n">tropo_press</span><span class="o">=</span><span class="n">phf_get_tropopause</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="n">tt_opt</span><span class="p">,</span><span class="n">modelHeightLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4457</span><span class="w">      </span><span class="k">end if</span>
<span class="linenos">4458</span><span class="k">	</span>
<span class="linenos">4459</span><span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">tropo_press</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">4460</span><span class="w">          </span>
<span class="linenos">4461</span><span class="w">        </span><span class="c">! Set vertical levels of reference.</span>
<span class="linenos">4462</span><span class="w">        </span><span class="c">! Convert to pressure coordinate if needed</span>
<span class="linenos">4463</span><span class="w"> </span>
<span class="linenos">4464</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4465</span><span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlev</span><span class="p">))</span><span class="w">    </span>
<span class="linenos">4466</span><span class="w">        </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">=</span><span class="w"> </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">vlev</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlev</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4467</span>
<span class="linenos">4468</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">success</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4469</span><span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">success</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4470</span><span class="w">        </span><span class="n">success</span><span class="p">(:)</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span><span class="w"></span>
<span class="linenos">4471</span>
<span class="linenos">4472</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">ivkind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4473</span><span class="k">          </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">=</span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span><span class="w"> </span><span class="c">! Conversion from hPa to Pa.</span>
<span class="linenos">4474</span><span class="w">        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">ivkind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4475</span><span class="k">          where</span><span class="w"> </span><span class="p">(</span><span class="n">pressrefin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">modelHeightLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">))</span><span class="w"> </span>
<span class="linenos">4476</span><span class="w">	    </span><span class="n">pressrefin</span><span class="o">=</span><span class="n">modelHeightLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4477</span><span class="w">	  </span><span class="k">end where </span>
<span class="linenos">4478</span><span class="k">          </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phf_convert_z_to_pressure</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4479</span><span class="w">	                  </span><span class="n">modelHeightLevs</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4480</span><span class="w">                          </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlev</span><span class="p">,</span><span class="n">numModelLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4481</span><span class="w">	                  </span><span class="n">obsLat</span><span class="p">,</span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4482</span><span class="w">        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">ivkind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4483</span><span class="k">          </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">=</span><span class="n">pressrefin</span><span class="p">(:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">modelHeightLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4484</span><span class="w">          </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phf_convert_z_to_pressure</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4485</span><span class="w">	                   </span><span class="n">modelHeightLevs</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4486</span><span class="w">                           </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlev</span><span class="p">,</span><span class="n">numModelLevs</span><span class="p">,</span><span class="n">obsLat</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4487</span><span class="w">	                   </span><span class="n">success</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4488</span><span class="w">        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">ivkind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4489</span><span class="k">          </span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">=</span><span class="n">pressrefin</span><span class="p">(:)</span><span class="o">*</span><span class="n">modelPressLevs</span><span class="p">(</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"> </span><span class="c">! Convert from sigma to Pa   </span>
<span class="linenos">4490</span><span class="w">        </span><span class="k">else</span>
<span class="linenos">4491</span><span class="k">          call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_addToProfileSet: Cannot handle vertical &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4492</span><span class="w">	      </span><span class="s1">&#39;coordinate of kind &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">ivkind</span><span class="p">)))</span><span class="w"></span>
<span class="linenos">4493</span><span class="w">        </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4494</span><span class="w">            </span>
<span class="linenos">4495</span><span class="w">        </span><span class="c">! Interpolate to obs lat/long (or lat) and model levels</span>
<span class="linenos">4496</span><span class="w">            </span>
<span class="linenos">4497</span><span class="w">        </span><span class="k">call </span><span class="n">oopc_column_hbilin</span><span class="p">(</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">field</span><span class="p">,</span><span class="n">pressrefin</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4498</span><span class="w">             </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlon</span><span class="p">,</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlat</span><span class="p">,</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">nlev</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4499</span><span class="w">             </span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">lon</span><span class="p">,</span><span class="n">climatFields</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">)%</span><span class="n">lat</span><span class="p">,</span><span class="n">obsLong</span><span class="p">,</span><span class="n">obsLat</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4500</span><span class="w">             </span><span class="n">refprof2</span><span class="p">,</span><span class="n">modelPressLevs</span><span class="p">,</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4501</span><span class="w">    </span>
<span class="linenos">4502</span><span class="w">      </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4503</span>
<span class="linenos">4504</span><span class="w">       </span><span class="c">! Combine with upper level profile</span>
<span class="linenos">4505</span><span class="w">       </span>
<span class="linenos">4506</span><span class="w">       </span><span class="k">do </span><span class="n">level</span><span class="o">=</span><span class="n">numModelLevs</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4507</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">modelPressLevs</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tropo_press</span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">4508</span><span class="k">         </span><span class="n">refprof</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="n">refprof2</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w">            </span>
<span class="linenos">4509</span><span class="w">       </span><span class="k">end do</span>
<span class="linenos">4510</span><span class="k">       </span><span class="n">start</span><span class="o">=</span><span class="n">level</span><span class="w"></span>
<span class="linenos">4511</span><span class="w">            </span>
<span class="linenos">4512</span><span class="w">       </span><span class="c">! Apply linear combination of four levels just above the tropopause</span>
<span class="linenos">4513</span><span class="w">        </span>
<span class="linenos">4514</span><span class="w">       </span><span class="k">do </span><span class="n">level</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">start</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4515</span><span class="w">         </span><span class="n">dt</span><span class="o">=</span><span class="p">(</span><span class="n">start</span><span class="o">+</span><span class="mf">1.0</span><span class="o">-</span><span class="n">level</span><span class="p">)</span><span class="o">/</span><span class="mf">5.0</span><span class="w"></span>
<span class="linenos">4516</span><span class="w">         </span><span class="n">refprof</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="o">=</span><span class="n">dt</span><span class="o">*</span><span class="n">refprof2</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">dt</span><span class="p">)</span><span class="o">*</span><span class="n">refprof</span><span class="p">(</span><span class="n">level</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4517</span><span class="w">      </span><span class="k">end do</span>
<span class="linenos">4518</span><span class="k">                    </span>
<span class="linenos">4519</span><span class="k">    end if </span>
<span class="linenos">4520</span>
<span class="linenos">4521</span><span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">pressrefin</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4522</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">success</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">success</span><span class="p">)</span><span class="w"> </span>
<span class="linenos">4523</span>
<span class="linenos">4524</span><span class="w">    </span><span class="c">! ------- Save in climatProfileSet ---------</span>
<span class="linenos">4525</span><span class="w">       </span>
<span class="linenos">4526</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">data1d</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4527</span><span class="k">      call </span><span class="n">oss_obsdata_alloc</span><span class="p">(</span><span class="n">climatProfileSet</span><span class="p">,</span><span class="w"> </span><span class="n">maxsize</span><span class="p">,</span><span class="w"> </span><span class="n">dim1</span><span class="o">=</span><span class="n">numModelLevs</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4528</span><span class="w">      </span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">nrep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="linenos">4529</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4530</span>
<span class="linenos">4531</span><span class="w">    </span><span class="c">! Here, nrep will count the number of filled elements in the data arrays</span>
<span class="linenos">4532</span><span class="w">    </span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">nrep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">nrep</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span>
<span class="linenos">4533</span>
<span class="linenos">4534</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">nrep</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxsize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4535</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s1">&#39;oopc_addToProfilesSet: Reach max size of array &#39;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4536</span><span class="w">	             </span><span class="nb">trim</span><span class="p">(</span><span class="n">utl_str</span><span class="p">(</span><span class="n">maxsize</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="linenos">4537</span><span class="w">    </span><span class="k">end if</span><span class="w"></span>
<span class="linenos">4538</span><span class="w">    </span>
<span class="linenos">4539</span><span class="w">    </span><span class="c">! obsIndex serves as the unique locator code </span>
<span class="linenos">4540</span><span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">code</span><span class="p">(</span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">nrep</span><span class="p">),</span><span class="s1">&#39;(I22)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">obsIndex</span><span class="w"></span>
<span class="linenos">4541</span><span class="w">    </span>
<span class="linenos">4542</span><span class="w">    </span><span class="c">! Save profile in climatProfileSet</span>
<span class="linenos">4543</span><span class="w">    </span>
<span class="linenos">4544</span><span class="w">    </span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">data1d</span><span class="p">(:,</span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">nrep</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">refprof</span><span class="p">(:)</span><span class="w"></span>
<span class="linenos">4545</span>
<span class="linenos">4546</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_addToProfileSet</span><span class="w"></span>
<span class="linenos">4547</span><span class="w">  </span>
<span class="linenos">4548</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4549</span><span class="w">  </span><span class="c">! oopc_getProfile</span>
<span class="linenos">4550</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4551</span><span class="w">  </span><span class="k">function </span><span class="n">oopc_getProfile</span><span class="p">(</span><span class="n">climatProfileSet</span><span class="p">,</span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4552</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4553</span><span class="w">    </span><span class="c">!:Purpose: To extract and provide profile from climatProfileSet according to </span>
<span class="linenos">4554</span><span class="w">    </span><span class="c">!          code value.     </span>
<span class="linenos">4555</span><span class="w">    </span><span class="c">!  </span>
<span class="linenos">4556</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">4557</span><span class="w">  </span>
<span class="linenos">4558</span><span class="w">    </span><span class="c">! Arguments</span>
<span class="linenos">4559</span><span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">struct_oss_obsdata</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">climatProfileSet</span><span class="w">  </span><span class="c">! Profile set</span>
<span class="linenos">4560</span><span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">code</span><span class="w">      </span><span class="c">! unique obs identifying code    </span>
<span class="linenos">4561</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">profile</span><span class="p">(</span><span class="n">climatProfileSet</span><span class="p">%</span><span class="n">dim1</span><span class="p">)</span><span class="w"> </span><span class="c">! retrieved array from obsdata%data1d of dimension obsdata%dim1</span>
<span class="linenos">4562</span>
<span class="linenos">4563</span><span class="w">    </span><span class="c">! Locals:</span>
<span class="linenos">4564</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="c">! search success (0 = found; 1 = no data; 2 = not found)</span>
<span class="linenos">4565</span>
<span class="linenos">4566</span><span class="w">    </span><span class="n">profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oss_obsdata_get_array1d</span><span class="p">(</span><span class="n">climatProfileSet</span><span class="p">,</span><span class="n">code</span><span class="p">,</span><span class="n">status</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4567</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4568</span><span class="k">      call </span><span class="n">utl_abort</span><span class="p">(</span><span class="s2">&quot;oopc_getProfile: Code not found - &quot;</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">code</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4569</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">4570</span><span class="k">    </span>
<span class="linenos">4571</span><span class="k">  end function </span><span class="n">oopc_getProfile</span><span class="w"></span>
<span class="linenos">4572</span>
<span class="linenos">4573</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4574</span><span class="w">  </span><span class="c">! oopc_column_hbilin</span>
<span class="linenos">4575</span><span class="w">  </span><span class="c">!--------------------------------------------------------------------------</span>
<span class="linenos">4576</span><span class="w">  </span><span class="k">subroutine </span><span class="n">oopc_column_hbilin</span><span class="p">(</span><span class="n">field</span><span class="p">,</span><span class="n">vlev</span><span class="p">,</span><span class="n">nlong</span><span class="p">,</span><span class="n">nlat</span><span class="p">,</span><span class="n">nlev</span><span class="p">,</span><span class="n">xlong</span><span class="p">,</span><span class="n">xlat</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4577</span><span class="w">                               </span><span class="n">plong</span><span class="p">,</span><span class="n">plat</span><span class="p">,</span><span class="n">vprof</span><span class="p">,</span><span class="n">vlevout</span><span class="p">,</span><span class="n">nlevout</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4578</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4579</span><span class="w">    </span><span class="c">!:Purpose: Horizontal bilinear interpolation from a 3D field to a profile at (plong,plat).</span>
<span class="linenos">4580</span><span class="w">    </span><span class="c">!           Assumes vertical interpolation not needed or already done.</span>
<span class="linenos">4581</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4582</span><span class="w">    </span><span class="c">!           This version can be used with fields that are not part of the background state,</span>
<span class="linenos">4583</span><span class="w">    </span><span class="c">!           such as climatologies.</span>
<span class="linenos">4584</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4585</span><span class="w">    </span><span class="c">!           This version does not depend in column_data and gridstatevector modules.</span>
<span class="linenos">4586</span><span class="w">    </span><span class="c">!</span>
<span class="linenos">4587</span><span class="w">    </span><span class="k">implicit none</span><span class="w"></span>
<span class="linenos">4588</span>
<span class="linenos">4589</span><span class="w">    </span><span class="c">! arguments:</span>
<span class="linenos">4590</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nlong</span><span class="w">            </span><span class="c">! number or longitudes</span>
<span class="linenos">4591</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nlat</span><span class="w">             </span><span class="c">! number or latitudes</span>
<span class="linenos">4592</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nlev</span><span class="w">             </span><span class="c">! number of vertical levels</span>
<span class="linenos">4593</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">nlevout</span><span class="w">          </span><span class="c">! number of target vertical levels</span>
<span class="linenos">4594</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">nlong</span><span class="p">,</span><span class="n">nlat</span><span class="p">,</span><span class="n">nlev</span><span class="p">)</span><span class="w"> </span><span class="c">! 3D field</span>
<span class="linenos">4595</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vlev</span><span class="p">(</span><span class="n">nlev</span><span class="p">)</span><span class="w">       </span><span class="c">! vertical levels of input field (in pressure)</span>
<span class="linenos">4596</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">xlong</span><span class="p">(</span><span class="n">nlong</span><span class="p">)</span><span class="w">     </span><span class="c">! longitudes (radians)</span>
<span class="linenos">4597</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">xlat</span><span class="p">(</span><span class="n">nlat</span><span class="p">)</span><span class="w">       </span><span class="c">! latitudes (radians)</span>
<span class="linenos">4598</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">plong</span><span class="w">            </span><span class="c">! target longitude (radians)</span>
<span class="linenos">4599</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">plat</span><span class="w">             </span><span class="c">! target latitude (radian)</span>
<span class="linenos">4600</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vlevout</span><span class="p">(</span><span class="n">nlevout</span><span class="p">)</span><span class="w"> </span><span class="c">! target vertical levels (in pressure)</span>
<span class="linenos">4601</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vprof</span><span class="p">(</span><span class="n">nlevout</span><span class="p">)</span><span class="w">  </span><span class="c">! profile at (plong,plat)</span>
<span class="linenos">4602</span><span class="w">    </span>
<span class="linenos">4603</span><span class="w">    </span><span class="c">! locals:</span>
<span class="linenos">4604</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lnvlev</span><span class="p">(</span><span class="n">nlev</span><span class="p">),</span><span class="n">lnvlevout</span><span class="p">(</span><span class="n">nlevout</span><span class="p">),</span><span class="n">plong2</span><span class="w"></span>
<span class="linenos">4605</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ilev</span><span class="p">,</span><span class="n">lonIndex</span><span class="p">,</span><span class="n">latIndex</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="w"></span>
<span class="linenos">4606</span>
<span class="linenos">4607</span><span class="w">    </span><span class="kt">real</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">DLDX</span><span class="p">,</span><span class="w"> </span><span class="n">DLDY</span><span class="p">,</span><span class="w"> </span><span class="n">DLDP</span><span class="p">,</span><span class="w"> </span><span class="n">DLW1</span><span class="p">,</span><span class="w"> </span><span class="n">DLW2</span><span class="p">,</span><span class="w"> </span><span class="n">DLW3</span><span class="p">,</span><span class="w"> </span><span class="n">DLW4</span><span class="w"></span>
<span class="linenos">4608</span>
<span class="linenos">4609</span><span class="w">    </span><span class="k">call </span><span class="n">utl_tmg_start</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="s1">&#39;--StateToColumn&#39;</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4610</span>
<span class="linenos">4611</span><span class="w">    </span><span class="c">! Find near lat/long grid points</span>
<span class="linenos">4612</span>
<span class="linenos">4613</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">nlong</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4614</span><span class="k">      </span><span class="n">plong2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plong</span><span class="w"></span>
<span class="linenos">4615</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">plong2</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="n">plong2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.D0</span><span class="o">*</span><span class="n">MPC_PI_R8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">plong2</span><span class="w"></span>
<span class="linenos">4616</span><span class="w">      </span><span class="k">do </span><span class="n">lonIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">nlong</span><span class="w"></span>
<span class="linenos">4617</span><span class="w">        </span><span class="k">if</span><span class="w">  </span><span class="p">(</span><span class="n">xlong</span><span class="p">(</span><span class="n">lonIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">xlong</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4618</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">plong2</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">xlong</span><span class="p">(</span><span class="n">lonIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">plong2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">xlong</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">4619</span><span class="k">        else</span><span class="w"> </span>
<span class="linenos">4620</span><span class="w">          </span><span class="c">! Assumes this is a transition between 360 to 0 (if it exists). Skip over.</span>
<span class="linenos">4621</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">4622</span><span class="k">      end do</span>
<span class="linenos">4623</span><span class="k">      </span><span class="n">lonIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lonIndex</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4624</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">4625</span><span class="k">      </span><span class="n">lonIndex</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<span class="linenos">4626</span><span class="w">    </span><span class="k">end if</span>
<span class="linenos">4627</span>
<span class="linenos">4628</span><span class="k">    do </span><span class="n">latIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">nlat</span><span class="w"></span>
<span class="linenos">4629</span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">plat</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">xlat</span><span class="p">(</span><span class="n">latIndex</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="linenos">4630</span><span class="k">    end do</span>
<span class="linenos">4631</span><span class="k">    </span><span class="n">latIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latIndex</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4632</span>
<span class="linenos">4633</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">lonIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="linenos">4634</span><span class="w">    </span>
<span class="linenos">4635</span><span class="w">      </span><span class="c">! Set lat interpolation weights</span>
<span class="linenos">4636</span>
<span class="linenos">4637</span><span class="w">      </span><span class="n">DLDY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">plat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xlat</span><span class="p">(</span><span class="n">latIndex</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">xlat</span><span class="p">(</span><span class="n">latIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">xlat</span><span class="p">(</span><span class="n">latIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4638</span>
<span class="linenos">4639</span><span class="w">      </span><span class="n">DLW1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.d0</span><span class="o">-</span><span class="n">DLDY</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4640</span><span class="w">      </span><span class="n">DLW2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DLDY</span><span class="w"></span>
<span class="linenos">4641</span>
<span class="linenos">4642</span><span class="w">      </span><span class="c">! Set vertical interpolation weights (assumes pressure vertical coordinate)</span>
<span class="linenos">4643</span>
<span class="linenos">4644</span><span class="w">      </span><span class="n">lnvlevout</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">vlevout</span><span class="p">(:))</span><span class="w">    </span>
<span class="linenos">4645</span><span class="w">      </span><span class="n">lnvlev</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">vlev</span><span class="p">(:))</span><span class="w">    </span>
<span class="linenos">4646</span>
<span class="linenos">4647</span><span class="w">      </span><span class="n">ilev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4648</span><span class="w">      </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevout</span><span class="w"></span>
<span class="linenos">4649</span><span class="w">        </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilev</span><span class="p">,</span><span class="w"> </span><span class="n">nlev</span><span class="w">          </span>
<span class="linenos">4650</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lnvlevout</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lnvlev</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span><span class="w"> </span><span class="c">! assumes lnvlevout and lnvlev increase with index</span>
<span class="linenos">4651</span><span class="w">        </span><span class="k">end do</span>
<span class="linenos">4652</span><span class="k">        </span><span class="n">ilev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4653</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ilev</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4654</span><span class="k">          </span><span class="n">ilev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4655</span><span class="w">        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">ilev</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nlev</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4656</span><span class="k">          </span><span class="n">ilev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4657</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">4658</span>
<span class="linenos">4659</span><span class="k">        </span><span class="n">DLDP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lnvlev</span><span class="p">(</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">lnvlevout</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">lnvlev</span><span class="p">(</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">lnvlev</span><span class="p">(</span><span class="n">ilev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4660</span><span class="w">          </span>
<span class="linenos">4661</span><span class="w">        </span><span class="n">vprof</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DLDP</span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">DLW1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">,</span><span class="n">latIndex</span><span class="p">,</span><span class="n">ilev</span><span class="p">)</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4662</span><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">DLW2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">,</span><span class="n">latIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ilev</span><span class="p">))</span><span class="w">   </span><span class="p">&amp;</span><span class="w"> </span>
<span class="linenos">4663</span><span class="w">          </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">1.d0</span><span class="o">-</span><span class="n">DLDP</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">DLW1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">,</span><span class="n">latIndex</span><span class="p">,</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4664</span><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">DLW2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">,</span><span class="n">latIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w">  </span>
<span class="linenos">4665</span><span class="w">      </span><span class="k">end do</span>
<span class="linenos">4666</span><span class="k">      </span>
<span class="linenos">4667</span><span class="k">    else</span><span class="w"></span>
<span class="linenos">4668</span><span class="w">    </span>
<span class="linenos">4669</span><span class="w">      </span><span class="c">! Set lat/long interpolation weights</span>
<span class="linenos">4670</span>
<span class="linenos">4671</span><span class="w">      </span><span class="n">DLDX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">plong</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xlong</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">xlong</span><span class="p">(</span><span class="n">lonIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">xlong</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4672</span><span class="w">      </span><span class="n">DLDY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">plat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">xlat</span><span class="p">(</span><span class="n">latIndex</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">xlat</span><span class="p">(</span><span class="n">latIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">xlat</span><span class="p">(</span><span class="n">latIndex</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4673</span>
<span class="linenos">4674</span><span class="w">      </span><span class="n">DLW1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.d0</span><span class="o">-</span><span class="n">DLDX</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.d0</span><span class="o">-</span><span class="n">DLDY</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4675</span><span class="w">      </span><span class="n">DLW2</span><span class="w"> </span><span class="o">=</span><span class="w">       </span><span class="n">DLDX</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.d0</span><span class="o">-</span><span class="n">DLDY</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4676</span><span class="w">      </span><span class="n">DLW3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.d0</span><span class="o">-</span><span class="n">DLDX</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w">       </span><span class="n">DLDY</span><span class="w"></span>
<span class="linenos">4677</span><span class="w">      </span><span class="n">DLW4</span><span class="w"> </span><span class="o">=</span><span class="w">       </span><span class="n">DLDX</span><span class="w">  </span><span class="o">*</span><span class="w">       </span><span class="n">DLDY</span><span class="w"></span>
<span class="linenos">4678</span>
<span class="linenos">4679</span><span class="w">      </span><span class="c">! Set vertical interpolation weights (assumes pressure vertical coordinate)</span>
<span class="linenos">4680</span>
<span class="linenos">4681</span><span class="w">      </span><span class="n">lnvlevout</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">vlevout</span><span class="p">(:))</span><span class="w">    </span>
<span class="linenos">4682</span><span class="w">      </span><span class="n">lnvlev</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">log</span><span class="p">(</span><span class="n">vlev</span><span class="p">(:))</span><span class="w">    </span>
<span class="linenos">4683</span>
<span class="linenos">4684</span><span class="w">      </span><span class="n">ilev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4685</span><span class="w">      </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nlevout</span><span class="w"></span>
<span class="linenos">4686</span><span class="w">        </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ilev</span><span class="p">,</span><span class="w"> </span><span class="n">nlev</span><span class="w">          </span>
<span class="linenos">4687</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lnvlevout</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lnvlev</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span><span class="w"> </span><span class="c">! assumes lnvlevout and lnvlev increase with index</span>
<span class="linenos">4688</span><span class="w">        </span><span class="k">end do</span>
<span class="linenos">4689</span><span class="k">        </span><span class="n">ilev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4690</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ilev</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4691</span><span class="k">          </span><span class="n">ilev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4692</span><span class="w">        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">ilev</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">nlev</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">4693</span><span class="k">          </span><span class="n">ilev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlev</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="linenos">4694</span><span class="w">        </span><span class="k">end if</span>
<span class="linenos">4695</span>
<span class="linenos">4696</span><span class="k">        </span><span class="n">DLDP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">lnvlev</span><span class="p">(</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">lnvlevout</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">lnvlev</span><span class="p">(</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">lnvlev</span><span class="p">(</span><span class="n">ilev</span><span class="p">))</span><span class="w"></span>
<span class="linenos">4697</span><span class="w">          </span>
<span class="linenos">4698</span><span class="w">        </span><span class="n">vprof</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DLDP</span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">DLW1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">,</span><span class="n">latIndex</span><span class="p">,</span><span class="n">ilev</span><span class="p">)</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4699</span><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">DLW2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">latIndex</span><span class="p">,</span><span class="n">ilev</span><span class="p">)</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4700</span><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">DLW3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">,</span><span class="n">latIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ilev</span><span class="p">)</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4701</span><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">DLW4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">latIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ilev</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4702</span><span class="w">          </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">1.d0</span><span class="o">-</span><span class="n">DLDP</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">DLW1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">,</span><span class="n">latIndex</span><span class="p">,</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4703</span><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">DLW2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">latIndex</span><span class="p">,</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4704</span><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">DLW3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="p">,</span><span class="n">latIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<span class="linenos">4705</span><span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">DLW4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">field</span><span class="p">(</span><span class="n">lonIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">latIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ilev</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w">                               </span>
<span class="linenos">4706</span><span class="w">      </span><span class="k">end do</span>
<span class="linenos">4707</span><span class="k">    end if</span>
<span class="linenos">4708</span>
<span class="linenos">4709</span><span class="k">    call </span><span class="n">utl_tmg_stop</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"></span>
<span class="linenos">4710</span>
<span class="linenos">4711</span><span class="w">  </span><span class="k">end subroutine </span><span class="n">oopc_column_hbilin</span><span class="w"></span>
<span class="linenos">4712</span>
<span class="linenos">4713</span><span class="k">end module </span><span class="n">obsOperatorsChem_mod</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</section>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li><a href="../index.html">MIDAS  documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2018, ECCC.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>